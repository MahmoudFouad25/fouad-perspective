<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>عرض الدورة - منظور الفؤاد</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            /* ألوان الأشواق التسعة من الهوية */
            --longing-1: #E11D48; /* أحمر قرمزي - الارتقاء المحكم */
            --longing-2: #EC4899; /* وردي - الانسجام المؤثر */
            --longing-3: #F97316; /* برتقالي - التميز الساطع */
            --longing-4: #9333EA; /* بنفسجي - الانتماء الأصيل */
            --longing-5: #22C55E; /* أخضر - الاكتفاء الواثق */
            --longing-6: #3B82F6; /* أزرق سماوي - الأمان المطمئن */
            --longing-7: #FBBF24; /* ذهبي - الانطلاق المبهج */
            --longing-8: #7F1D1D; /* أحمر غامق - الاقتدار الحازم */
            --longing-9: #14B8A6; /* فيروزي - السلام المتصالح */
            
            /* الألوان الأساسية من الهوية */
            --gold-primary: #FFD700;
            --gold-light: #FFF3CD;
            --gold-glow: rgba(255, 215, 0, 0.3);
            --sun-orange: #FFA500;
            --sun-red: #FF6347;
            
            --dark-bg: #0A1628;
            --dark-lighter: #1E3A5F;
            --dark-overlay: rgba(10, 22, 40, 0.95);
            
            --white: #FFFFFF;
            --gray-light: #F8F9FA;
            --gray-medium: #6C757D;
            
            --border: rgba(255, 215, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--dark-bg);
            color: var(--white);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* الخلفية الكونية */
        .cosmic-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(ellipse at center top, var(--dark-lighter) 0%, var(--dark-bg) 50%);
        }

        .islamic-pattern {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .golden-rays {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 800px;
            height: 600px;
            background: radial-gradient(ellipse at center, var(--gold-glow) 0%, transparent 70%);
            animation: glow 4s ease-in-out infinite alternate;
        }

        @keyframes glow {
            0% { opacity: 0.3; }
            100% { opacity: 0.6; }
        }

        /* Loading Screen - نفس القلب من master.html */
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loader-content {
            text-align: center;
        }

        .fouad-logo-loader {
            width: 200px;
            height: 200px;
            margin: 0 auto 2rem;
            position: relative;
        }

        /* القلب الزجاجي المتحرك */
        .glass-heart-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 90px;
            animation: mainHeartPulse 3s ease-in-out infinite;
        }

        @keyframes mainHeartPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        .liquid-animation {
            animation: fillHeartSlow 6s ease-in-out infinite;
        }

        @keyframes fillHeartSlow {
            0%, 100% { y: 90px; }
            50% { y: 20px; }
        }

        .loader-text {
            color: var(--gold-light);
            font-size: 1.2rem;
            margin-top: 2rem;
        }

        /* Header */
        .header {
            background: rgba(10, 22, 40, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            color: var(--gold-primary);
            font-weight: 700;
            font-size: 1.2rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--sun-orange) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            color: var(--gold-light);
            padding: 0.8rem 1.5rem;
            border-radius: 30px;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: inherit;
        }

        .back-btn:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--gold-primary);
            transform: translateY(-2px);
        }

        /* Hero Section */
        .hero-section {
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.3) 0%, rgba(10, 22, 40, 0.6) 100%);
            padding: 3rem 0;
            position: relative;
            overflow: hidden;
        }

        .hero-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            position: relative;
            z-index: 1;
        }

        .course-header {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 3rem;
            align-items: start;
        }

        .course-info h1 {
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--sun-orange) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .course-subtitle {
            font-size: 1.3rem;
            color: var(--gold-light);
            opacity: 0.9;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .course-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
        }

        .meta-item i {
            color: var(--gold-primary);
            width: 20px;
        }

        /* Stats Card */
        .course-stats-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 20px;
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        .course-stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
                var(--longing-1) 0%, 
                var(--longing-2) 11%, 
                var(--longing-3) 22%, 
                var(--longing-4) 33%, 
                var(--longing-5) 44%, 
                var(--longing-6) 55%, 
                var(--longing-7) 66%, 
                var(--longing-8) 77%, 
                var(--longing-9) 88%, 
                var(--longing-1) 100%
            );
            background-size: 200% 100%;
            animation: rainbowSlide 8s linear infinite;
        }

        @keyframes rainbowSlide {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 0%; }
        }

        .stats-title {
            font-size: 1.2rem;
            color: var(--gold-primary);
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .stat-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.6);
        }

        .stat-value {
            color: var(--gold-primary);
            font-weight: 600;
        }

        /* Progress Section */
        .progress-section {
            background: rgba(255, 255, 255, 0.02);
            padding: 2rem 0;
            border-bottom: 1px solid var(--border);
        }

        .progress-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-title {
            font-size: 1.5rem;
            color: var(--gold-light);
            font-weight: 600;
        }

        .progress-percentage {
            font-size: 2rem;
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--sun-orange) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 1rem;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold-primary) 0%, var(--sun-orange) 50%, var(--sun-red) 100%);
            border-radius: 6px;
            transition: width 1s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .progress-detail {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: var(--transition);
        }

        .progress-detail:hover {
            transform: translateY(-5px);
            border-color: var(--gold-primary);
        }

        .progress-detail-value {
            font-size: 1.5rem;
            color: var(--gold-primary);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .progress-detail-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem 2rem;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 3rem;
        }

        .content-area {
            min-height: 500px;
        }

        .section {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .section:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(255, 215, 0, 0.1);
        }

        .section-title {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            font-weight: 600;
        }

        .section-title i {
            color: var(--gold-primary);
            font-size: 1.3rem;
        }

        .description-content {
            line-height: 1.8;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
        }

        /* Objectives Grid */
        .objectives-grid {
            display: grid;
            gap: 1rem;
        }

        .objective-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05) 0%, transparent 100%);
            border-radius: 12px;
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .objective-item:hover {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, transparent 100%);
            transform: translateX(10px);
            border-color: var(--gold-primary);
        }

        .objective-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--sun-orange) 100%);
            color: var(--dark-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .objective-text {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
        }

        /* Modules Section */
        .modules-container {
            display: grid;
            gap: 1.5rem;
        }

        .module-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            transition: var(--transition);
        }

        .module-item:hover {
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.1);
        }

        .module-header {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 165, 0, 0.05) 100%);
            padding: 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .module-header:hover {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 165, 0, 0.08) 100%);
        }

        .module-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .module-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--sun-orange) 100%);
            color: var(--dark-bg);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .module-details h3 {
            color: var(--gold-primary);
            margin-bottom: 0.3rem;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .module-meta {
            display: flex;
            gap: 1rem;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .module-meta span {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .module-toggle {
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .module-toggle i {
            color: var(--gold-primary);
            transition: var(--transition);
        }

        .module-item.expanded .module-toggle {
            background: var(--gold-primary);
        }

        .module-item.expanded .module-toggle i {
            color: var(--dark-bg);
            transform: rotate(180deg);
        }

        .module-lessons {
            display: none;
            padding: 1rem;
        }

        .module-item.expanded .module-lessons {
            display: block;
        }

        .lesson-item {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 1rem;
            overflow: hidden;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .lesson-item:last-child {
            margin-bottom: 0;
        }

        .lesson-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--gray-medium);
            transition: var(--transition);
        }

        .lesson-item.completed::before {
            background: var(--longing-5);
        }

        .lesson-item.current::before {
            background: var(--gold-primary);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .lesson-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2);
            border-color: var(--gold-primary);
        }

        .lesson-header {
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lesson-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .lesson-number {
            width: 40px;
            height: 40px;
            background: rgba(255, 215, 0, 0.1);
            color: var(--gold-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid var(--gold-primary);
        }

        .lesson-item.completed .lesson-number {
            background: var(--longing-5);
            color: white;
            border-color: var(--longing-5);
        }

        .lesson-details h4 {
            color: var(--white);
            margin-bottom: 0.3rem;
            font-weight: 600;
        }

        .lesson-meta {
            display: flex;
            gap: 1rem;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .lesson-meta i {
            color: var(--gold-primary);
        }

        .lesson-actions {
            display: flex;
            gap: 0.5rem;
        }

        .lesson-btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-play {
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--sun-orange) 100%);
            color: var(--dark-bg);
        }

        .btn-play:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
        }

        .btn-completed {
            background: var(--longing-5);
            color: white;
        }

        .btn-lock {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
        }

        /* Sidebar */
        .sidebar {
            display: grid;
            gap: 1.5rem;
            height: fit-content;
        }

        .sidebar-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            transition: var(--transition);
        }

        .sidebar-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(255, 215, 0, 0.1);
        }

        .card-title {
            font-size: 1.3rem;
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .action-btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: var(--transition);
            font-family: inherit;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--sun-orange) 100%);
            color: var(--dark-bg);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(255, 215, 0, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--gold-light);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--gold-primary);
        }

        /* Instructor Card */
        .instructor-card {
            text-align: center;
        }

        .instructor-avatar {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--sun-orange) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: var(--dark-bg);
            margin: 0 auto 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .instructor-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .instructor-name {
            font-size: 1.2rem;
            color: var(--gold-primary);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .instructor-bio {
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.6;
            font-size: 0.95rem;
        }

        /* Lesson Modal */
        .lesson-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 22, 40, 0.95);
            backdrop-filter: blur(10px);
            display: none;
            z-index: 10000;
            overflow-y: auto;
        }

        .lesson-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lesson-player {
            background: var(--dark-lighter);
            border: 1px solid var(--border);
            border-radius: 20px;
            max-width: 1000px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .lesson-header-modal {
            background: rgba(10, 22, 40, 0.95);
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .lesson-title-modal {
            color: var(--gold-primary);
            font-size: 1.3rem;
            font-weight: 600;
        }

        .close-lesson {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: var(--gold-light);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-lesson:hover {
            background: rgba(255, 215, 0, 0.1);
            color: var(--gold-primary);
        }

        .lesson-content {
            padding: 2rem;
            min-height: 400px;
            position: relative;
        }

        /* Loading State */
        .content-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .content-loading .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border);
            border-top: 3px solid var(--gold-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Video Container */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            margin-bottom: 2rem;
            background: var(--dark-bg);
            border-radius: 12px;
            overflow: hidden;
        }

        .video-container iframe,
        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Text Content */
        .text-content {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.8;
            font-size: 1.1rem;
        }

        /* Quiz Styles */
        .quiz-container {
            padding: 2rem;
        }

        .quiz-question {
            background: rgba(255, 255, 255, 0.03);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .quiz-question:hover {
            border-color: var(--gold-primary);
            transform: translateY(-2px);
        }

        .quiz-options label {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .quiz-options label:hover {
            background: rgba(255, 215, 0, 0.05);
            border-color: var(--gold-primary);
        }

        .quiz-options input[type="radio"] {
            margin-left: 0.75rem;
            accent-color: var(--gold-primary);
        }

        /* File Content */
        .file-content {
            padding: 2rem;
            text-align: center;
        }

        .file-preview {
            background: rgba(255, 255, 255, 0.03);
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 3rem;
            margin-bottom: 2rem;
        }

        .file-icon {
            font-size: 5rem;
            color: var(--gold-primary);
            margin-bottom: 1rem;
        }

        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--sun-orange) 100%);
            color: var(--dark-bg);
            padding: 1rem 2rem;
            border-radius: 30px;
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.3);
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(255, 215, 0, 0.4);
        }

        /* Discussion Content */
        .discussion-container {
            padding: 2rem;
        }

        .discussion-prompt {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05) 0%, transparent 100%);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        .discussion-prompt h4 {
            color: var(--gold-primary);
            margin-bottom: 1rem;
        }

        .discussion-form textarea {
            width: 100%;
            min-height: 150px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            color: var(--white);
            resize: vertical;
            margin-bottom: 1rem;
            font-family: inherit;
        }

        .discussion-form textarea:focus {
            outline: none;
            border-color: var(--gold-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        /* Lesson Actions Modal */
        .lesson-actions-modal {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }

        .navigation-buttons {
            display: flex;
            gap: 1rem;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.05);
            color: var(--gold-light);
            border: 1px solid var(--border);
            padding: 0.8rem 1.5rem;
            border-radius: 30px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-btn:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--gold-primary);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .complete-lesson-btn {
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--sun-orange) 100%);
            color: var(--dark-bg);
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 30px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.3);
        }

        .complete-lesson-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(255, 215, 0, 0.4);
        }

        /* Progress Indicator in Lesson */
        .lesson-progress-indicator {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(10, 22, 40, 0.9);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            color: var(--gold-primary);
            font-size: 0.9rem;
            z-index: 10;
            border: 1px solid var(--border);
        }

        /* Error State */
        .error-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
            padding: 2rem;
        }

        .error-state i {
            font-size: 5rem;
            color: var(--longing-1);
            margin-bottom: 2rem;
        }

        .error-state h2 {
            font-size: 2rem;
            color: var(--gold-primary);
            margin-bottom: 1rem;
        }

        .error-state p {
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 2rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
            color: var(--gold-primary);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .course-header {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .main-content {
                grid-template-columns: 1fr;
                gap: 2rem;
            }
        }

        @media (max-width: 768px) {
            .hero-content,
            .progress-container,
            .main-content {
                padding: 0 1rem;
            }

            .course-info h1 {
                font-size: 2rem;
            }

            .course-meta {
                flex-direction: column;
                gap: 1rem;
            }

            .progress-details {
                grid-template-columns: 1fr 1fr;
            }

            .lesson-player {
                width: 95%;
                max-height: 95vh;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gold-primary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--sun-orange);
        }

        /* SweetAlert2 Custom Theme */
        .swal2-popup {
            background: var(--dark-lighter) !important;
            color: var(--white) !important;
            border: 1px solid var(--border) !important;
        }

        .swal2-title {
            color: var(--gold-primary) !important;
        }

        .swal2-content {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        .swal2-confirm {
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--sun-orange) 100%) !important;
            color: var(--dark-bg) !important;
            border: none !important;
            border-radius: 30px !important;
            padding: 0.8rem 2rem !important;
            font-weight: 600 !important;
        }

        .swal2-cancel {
            background: rgba(255, 255, 255, 0.05) !important;
            color: var(--gold-light) !important;
            border: 1px solid var(--border) !important;
            border-radius: 30px !important;
            padding: 0.8rem 2rem !important;
        }
    </style>
</head>
<body>
    <!-- الخلفية الكونية -->
    <div class="cosmic-bg">
        <div class="islamic-pattern"></div>
        <div class="golden-rays"></div>
    </div>

    <!-- Page Loader مع القلب من master.html -->
    <div id="pageLoader" class="page-loader">
        <div class="loader-content">
            <div class="fouad-logo-loader">
                <svg width="200" height="200" viewBox="0 0 200 200" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                    <defs>
                        <!-- تدرج زجاجي -->
                        <linearGradient id="glassGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:rgba(255,255,255,0.6);stop-opacity:1" />
                            <stop offset="50%" style="stop-color:rgba(255,255,255,0.2);stop-opacity:1" />
                            <stop offset="100%" style="stop-color:rgba(255,255,255,0.1);stop-opacity:1" />
                        </linearGradient>
                        
                        <!-- تدرج السائل -->
                        <radialGradient id="liquidGradient" cx="50%" cy="50%">
                            <stop offset="0%" style="stop-color:#FFD700;stop-opacity:0.9" />
                            <stop offset="50%" style="stop-color:#FFA500;stop-opacity:0.8" />
                            <stop offset="100%" style="stop-color:#FF6347;stop-opacity:0.7" />
                            <animate attributeName="stop-color" 
                                values="#FFD700;#FFA500;#FF6347;#FFA500;#FFD700" 
                                dur="8s" 
                                repeatCount="indefinite" />
                        </radialGradient>
                        
                        <!-- ماسك للسائل -->
                        <mask id="heartMask">
                            <path d="M100,40 C100,20 80,0 60,0 C40,0 20,20 20,40 C20,60 100,140 100,140 C100,140 180,60 180,40 C180,20 160,0 140,0 C120,0 100,20 100,40 Z" 
                                  fill="white"/>
                        </mask>
                        
                        <!-- فلتر التوهج -->
                        <filter id="glowFilter">
                            <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    
                    <!-- القلب الزجاجي الرئيسي -->
                    <g class="glass-heart-container">
                        <!-- خلفية القلب الزجاجي -->
                        <path d="M100,40 C100,20 80,0 60,0 C40,0 20,20 20,40 C20,60 100,140 100,140 C100,140 180,60 180,40 C180,20 160,0 140,0 C120,0 100,20 100,40 Z" 
                              fill="none" 
                              stroke="rgba(255,215,0,0.3)" 
                              stroke-width="2"
                              filter="url(#glowFilter)"/>
                        
                        <!-- السائل المتحرك -->
                        <rect x="0" y="180" width="200" height="180" 
                              fill="url(#liquidGradient)" 
                              mask="url(#heartMask)"
                              class="liquid-animation">
                        </rect>
                        
                        <!-- تأثير زجاجي -->
                        <path d="M100,40 C100,20 80,0 60,0 C40,0 20,20 20,40 C20,60 100,140 100,140 C100,140 180,60 180,40 C180,20 160,0 140,0 C120,0 100,20 100,40 Z" 
                              fill="url(#glassGradient)" 
                              opacity="0.3"/>
                        
                        <!-- لمعة زجاجية -->
                        <ellipse cx="70" cy="50" rx="24" ry="16" 
                                 fill="rgba(255,255,255,0.4)" 
                                 transform="rotate(-20 70 50)"/>
                    </g>
                </svg>
            </div>
            <div class="loader-text">جاري تحميل رحلتك التحويلية...</div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="./dashboard.html" class="logo">
                <div class="logo-icon">❤️</div>
                <span>منظور الفؤاد</span>
            </a>
            
            <a href="./dashboard.html" class="back-btn">
                <i class="fas fa-arrow-right"></i>
                العودة للوحة التحكم
            </a>
        </div>
    </header>

    <!-- Error State (Hidden by default) -->
    <div id="errorState" class="error-state" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <h2>خطأ في تحميل الدورة</h2>
        <p id="errorMessage">حدث خطأ أثناء تحميل بيانات الدورة</p>
        <a href="./dashboard.html" class="action-btn btn-primary">
            <i class="fas fa-home"></i>
            العودة للصفحة الرئيسية
        </a>
    </div>

    <!-- Main Content (Hidden while loading) -->
    <div id="mainContent" style="display: none;">
        <!-- Hero Section -->
        <section class="hero-section">
            <div class="hero-content">
                <div class="course-header">
                    <div class="course-info">
                        <h1 id="courseTitle">جاري تحميل الدورة...</h1>
                        <p id="courseSubtitle" class="course-subtitle">جاري تحميل الوصف...</p>
                        
                        <div class="course-meta">
                            <div class="meta-item">
                                <i class="fas fa-user"></i>
                                <span id="instructorName">المدرب</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-calendar"></i>
                                <span id="courseDate">تاريخ البدء</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-clock"></i>
                                <span id="courseDuration">المدة</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-users"></i>
                                <span id="enrollmentCount">المنتسبين</span>
                            </div>
                        </div>
                    </div>

                    <div class="course-stats-card">
                        <h3 class="stats-title">إحصائياتك الشخصية</h3>
                        <div class="stat-item">
                            <span class="stat-label">نسبة الإنجاز</span>
                            <span id="userProgress" class="stat-value">0%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">الدروس المكتملة</span>
                            <span id="completedLessons" class="stat-value">0 / 0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">الوقت المقضي</span>
                            <span id="timeSpent" class="stat-value">0 دقيقة</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">آخر نشاط</span>
                            <span id="lastActivity" class="stat-value">اليوم</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Progress Section -->
        <section class="progress-section">
            <div class="progress-container">
                <div class="progress-header">
                    <h2 class="progress-title">تقدمك في الدورة</h2>
                    <span id="overallProgress" class="progress-percentage">0%</span>
                </div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
                <div class="progress-details">
                    <div class="progress-detail">
                        <div id="totalLessons" class="progress-detail-value">0</div>
                        <div class="progress-detail-label">إجمالي الدروس</div>
                    </div>
                    <div class="progress-detail">
                        <div id="finishedLessons" class="progress-detail-value">0</div>
                        <div class="progress-detail-label">الدروس المنجزة</div>
                    </div>
                    <div class="progress-detail">
                        <div id="remainingLessons" class="progress-detail-value">0</div>
                        <div class="progress-detail-label">الدروس المتبقية</div>
                    </div>
                    <div class="progress-detail">
                        <div id="estimatedTime" class="progress-detail-value">0</div>
                        <div class="progress-detail-label">الوقت المقدر للإنهاء</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-area">
                <!-- Course Description -->
                <section class="section">
                    <h2 class="section-title">
                        <i class="fas fa-info-circle"></i>
                        نظرة عامة على الدورة
                    </h2>
                    <div id="courseDescription" class="description-content">
                        جاري تحميل وصف الدورة...
                    </div>
                </section>

                <!-- Learning Objectives -->
                <section class="section">
                    <h2 class="section-title">
                        <i class="fas fa-bullseye"></i>
                        ما ستتعلمه في هذه الدورة
                    </h2>
                    <div id="courseObjectives" class="objectives-grid">
                        <!-- سيتم تحميل الأهداف هنا -->
                    </div>
                </section>

                <!-- Course Content -->
                <section class="section">
                    <h2 class="section-title">
                        <i class="fas fa-play-circle"></i>
                        محتوى الدورة التدريبية
                    </h2>
                    <div id="courseLessons" class="modules-container">
                        <!-- سيتم تحميل الوحدات والدروس هنا -->
                    </div>
                </section>
            </div>

            <!-- Sidebar -->
            <aside class="sidebar">
                <!-- Quick Actions -->
                <div class="sidebar-card">
                    <h3 class="card-title">إجراءات سريعة</h3>
                    <button id="continueBtn" class="action-btn btn-primary">
                        <i class="fas fa-play"></i>
                        متابعة التعلم
                    </button>
                    <button id="restartBtn" class="action-btn btn-secondary">
                        <i class="fas fa-redo"></i>
                        إعادة بدء الدورة
                    </button>
                </div>

                <!-- Instructor Info -->
                <div class="sidebar-card instructor-card">
                    <h3 class="card-title">المدرب</h3>
                    <div id="instructorAvatar" class="instructor-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div id="instructorNameSidebar" class="instructor-name">اسم المدرب</div>
                    <div id="instructorBio" class="instructor-bio">
                        معلومات المدرب...
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- Lesson Player Modal -->
    <div id="lessonModal" class="lesson-modal">
        <div class="lesson-player">
            <div class="lesson-header-modal">
                <h3 id="lessonTitleModal" class="lesson-title-modal">عنوان الدرس</h3>
                <button id="closeLessonBtn" class="close-lesson">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="lesson-content">
                <!-- Progress Indicator -->
                <div class="lesson-progress-indicator" id="lessonProgressIndicator" style="display: none;">
                    <span id="lessonProgressText">الدرس 1 من 10</span>
                </div>

                <!-- Video Content -->
                <div id="videoContent" class="video-container" style="display: none;">
                    <!-- سيتم إدراج الفيديو هنا -->
                </div>
                
                <!-- Text Content -->
                <div id="textContent" class="text-content" style="display: none;">
                    <!-- سيتم إدراج النص هنا -->
                </div>
                
                <!-- Quiz Content -->
                <div id="quizContent" class="quiz-content" style="display: none;">
                    <!-- سيتم إدراج الاختبار هنا -->
                </div>
                
                <!-- File/Resource Content -->
                <div id="fileContent" class="file-content" style="display: none;">
                    <!-- سيتم إدراج الملفات هنا -->
                </div>
                
                <!-- Discussion Content -->
                <div id="discussionContent" class="discussion-content" style="display: none;">
                    <!-- سيتم إدراج النقاش هنا -->
                </div>
                
                <div class="lesson-actions-modal">
                    <div class="navigation-buttons">
                        <button id="prevLessonBtn" class="nav-btn">
                            <i class="fas fa-arrow-right"></i>
                            الدرس السابق
                        </button>
                        <button id="nextLessonBtn" class="nav-btn">
                            الدرس التالي
                            <i class="fas fa-arrow-left"></i>
                        </button>
                    </div>
                    
                    <button id="completeLessonBtn" class="complete-lesson-btn">
                        <i class="fas fa-check"></i>
                        إكمال الدرس
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHg0VrivE3C9A7jvzRu7lQgudLvcD_Fxk",
            authDomain: "fouad-perspective.firebaseapp.com",
            projectId: "fouad-perspective",
            storageBucket: "fouad-perspective.appspot.com",
            messagingSenderId: "564654107574",
            appId: "1:564654107574:web:baebb660288b22f16213e6"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let userData = null;
        let courseData = null;
        let userProgress = null;
        let courseId = null;
        let userId = null;
        let currentLessonIndex = null;
        let allLessons = [];
        let allModules = [];
        let financialRecord = null;
        let progressTimer = null;

        // Get Course ID from URL
        function getCourseIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

       // Initialize App
window.addEventListener('DOMContentLoaded', function() {
    // جلب البيانات من localStorage
    userId = localStorage.getItem('userId');
    courseId = getCourseIdFromURL();
    
    console.log('معرف المستخدم من localStorage:', userId);
    console.log('معرف الدورة من URL:', courseId);
    
    // التحقق من وجود معرف الدورة
    if (!courseId) {
        showError('معرف الدورة غير صحيح');
        return;
    }
    
    // التحقق من وجود معرف المستخدم
    if (!userId) {
        console.log('لا يوجد userId في localStorage');
        // نتحقق من Firebase Auth قبل إعادة التوجيه
        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = './login.html';
            } else {
                // المستخدم موجود في Firebase لكن مش في localStorage
                // نحاول نجيب userId من Firebase
                userId = user.uid;
                localStorage.setItem('userId', userId);
                initializeData();
            }
        });
        return;
    }
    
    // المستخدم موجود في localStorage، نبدأ التحميل
    initializeData();
});

// دالة منفصلة لتحميل البيانات
async function initializeData() {
    try {
        await loadAllData();
    } catch (error) {
        console.error('خطأ في تحميل البيانات:', error);
        
        // لو حصل خطأ، نتأكد من حالة المصادقة
        const user = auth.currentUser;
        if (!user) {
            // ممكن يكون انتهت الجلسة
            localStorage.removeItem('userId');
            window.location.href = './login.html';
        } else {
            showError(error.message);
        }
    }
}

       // Load All Required Data
       async function loadAllData() {
           try {
               console.log('📋 تحميل بيانات الدورة:', courseId);
               console.log('👤 معرف المستخدم:', userId);

               // تحميل بيانات المستخدم
               const userDoc = await db.collection('users').doc(userId).get();
               if (!userDoc.exists) {
                   throw new Error('بيانات المستخدم غير موجودة');
               }
               userData = { id: userDoc.id, ...userDoc.data() };

               // تحميل السجل المالي
               const financialDoc = await db.collection('users')
                   .doc(userId)
                   .collection('financialRecords')
                   .doc(courseId)
                   .get();

               if (!financialDoc.exists) {
                   throw new Error('هذه الدورة غير مخصصة لك');
               }
               financialRecord = financialDoc.data();

               // تحميل بيانات الدورة
               const courseDoc = await db.collection('courses').doc(courseId).get();
               if (!courseDoc.exists) {
                   throw new Error('الدورة غير موجودة');
               }
               courseData = { id: courseDoc.id, ...courseDoc.data() };

               // تحميل تقدم المستخدم
               userProgress = userData.progress?.[courseId] || {
                   percentage: 0,
                   completedLessons: [],
                   timeSpent: 0,
                   lastActivity: new Date(),
                   lastViewedLesson: null
               };

               // عرض البيانات
               displayCourseData();
               displayUserProgress();
               setupEventListeners();
               setupLessonPlayerListeners();
               updateContinueButton();
               startProgressTracking();
               
               // إخفاء الloader وإظهار المحتوى
               hideLoader();
               document.getElementById('mainContent').style.display = 'block';

           } catch (error) {
               console.error('خطأ في تحميل البيانات:', error);
               showError(error.message);
           }
       }

       // Display Course Data
       function displayCourseData() {
           document.getElementById('courseTitle').textContent = courseData.title || 'دورة بدون عنوان';
           document.getElementById('courseSubtitle').textContent = courseData.subtitle || '';
           document.title = `${courseData.title} - منظور الفؤاد`;

           const instructorName = courseData.instructorName || 'غير محدد';
           document.getElementById('instructorName').textContent = instructorName;
           document.getElementById('instructorNameSidebar').textContent = instructorName;
           document.getElementById('instructorBio').textContent = courseData.instructorBio || 'لا توجد معلومات متاحة';
           
           // عرض صورة المدرب
           const avatar = document.getElementById('instructorAvatar');
           const instructorImage = courseData.instructorImageUrl || courseData.instructorImage;
           if (instructorImage) {
               avatar.innerHTML = `<img src="${instructorImage}" alt="${instructorName}" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas fa-user\\'></i>'">`;
           } else if (instructorName !== 'غير محدد') {
               avatar.textContent = instructorName.charAt(0).toUpperCase();
           }

           // التاريخ الهجري والميلادي
           const createdDate = courseData.createdAt ? new Date(courseData.createdAt.seconds * 1000) : new Date();
           const hijriDate = getHijriDate(createdDate);
           const miladiDate = createdDate.toLocaleDateString('ar-SA', { calendar: 'gregory' });
           document.getElementById('courseDate').textContent = `${hijriDate} هـ - ${miladiDate} م`;
           
           // حساب المدة الإجمالية
           const totalDuration = courseData.totalDuration || 0;
           const hours = Math.floor(totalDuration / 60);
           const minutes = totalDuration % 60;
           const durationText = hours > 0 ? `${hours} ساعة ${minutes} دقيقة` : `${minutes} دقيقة`;
           document.getElementById('courseDuration').textContent = durationText;
           
           document.getElementById('enrollmentCount').textContent = `${courseData.enrollments || 0} منتسب`;

           const descriptionElement = document.getElementById('courseDescription');
           if (courseData.detailedDescription) {
               descriptionElement.innerHTML = courseData.detailedDescription;
           } else if (courseData.description) {
               descriptionElement.textContent = courseData.description;
           } else {
               descriptionElement.innerHTML = '<p style="color: rgba(255, 255, 255, 0.6);">لم يتم إضافة وصف لهذه الدورة بعد.</p>';
           }

           displayObjectives();
           displayModulesAndLessons();
       }

       // Get Hijri Date
       function getHijriDate(date) {
           // تحويل بسيط للتاريخ الهجري
           const hijriDate = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {
               day: 'numeric',
               month: 'numeric',
               year: 'numeric'
           }).format(date);
           return hijriDate;
       }

       // Display Learning Objectives
       function displayObjectives() {
           const container = document.getElementById('courseObjectives');
           const objectives = courseData.objectives || [];

           if (objectives.length === 0) {
               container.innerHTML = `
                   <div class="empty-state">
                       <i class="fas fa-bullseye"></i>
                       <p>لم يتم تحديد أهداف تعليمية لهذه الدورة</p>
                   </div>
               `;
               return;
           }

           container.innerHTML = objectives.map((objective, index) => `
               <div class="objective-item">
                   <div class="objective-icon">${index + 1}</div>
                   <div class="objective-text">${objective}</div>
               </div>
           `).join('');
       }

       // Display Modules and Lessons
       function displayModulesAndLessons() {
           const container = document.getElementById('courseLessons');
           
           allLessons = [];
           allModules = [];
           
           if (courseData.modules && courseData.modules.length > 0) {
               allModules = courseData.modules;
               
               container.innerHTML = courseData.modules.map((module, moduleIndex) => {
                   let moduleLessons = [];
                   if (module.lessons && module.lessons.length > 0) {
                       module.lessons.forEach((lesson, lessonIndex) => {
                           const globalIndex = allLessons.length;
                           allLessons.push({
                               ...lesson,
                               moduleName: module.title,
                               moduleIndex: moduleIndex,
                               lessonIndex: lessonIndex,
                               globalIndex: globalIndex
                           });
                           moduleLessons.push({
                               ...lesson,
                               globalIndex: globalIndex
                           });
                       });
                   }

                   const completedInModule = moduleLessons.filter(lesson => 
                       userProgress.completedLessons?.includes(lesson.globalIndex)
                   ).length;

                   const moduleIcon = module.icon || '📚';
                   const moduleDuration = moduleLessons.reduce((sum, lesson) => 
                       sum + (parseInt(lesson.duration) || 0), 0
                   );

                   return `
                       <div class="module-item" data-module="${moduleIndex}">
                           <div class="module-header" onclick="toggleModule(${moduleIndex})">
                               <div class="module-info">
                                   <div class="module-icon">${moduleIcon}</div>
                                   <div class="module-details">
                                       <h3>${module.title}</h3>
                                       <div class="module-meta">
                                           <span><i class="fas fa-book"></i> ${moduleLessons.length} دروس</span>
                                           <span><i class="fas fa-clock"></i> ${moduleDuration} دقيقة</span>
                                           <span><i class="fas fa-check-circle"></i> ${completedInModule} مكتمل</span>
                                       </div>
                                   </div>
                               </div>
                               <div class="module-toggle">
                                   <i class="fas fa-chevron-down"></i>
                               </div>
                           </div>
                           <div class="module-lessons">
                               ${renderModuleLessons(moduleLessons)}
                           </div>
                       </div>
                   `;
               }).join('');
           } else {
               container.innerHTML = `
                   <div class="empty-state">
                       <i class="fas fa-book-open"></i>
                       <h4>محتوى الدورة قيد الإعداد</h4>
                       <p>سيتم إضافة الدروس قريباً</p>
                   </div>
               `;
           }

           document.getElementById('totalLessons').textContent = allLessons.length;
       }

       // Render Module Lessons
       function renderModuleLessons(lessons) {
           const completedLessons = userProgress.completedLessons || [];
           
           return lessons.map((lesson) => {
               const index = lesson.globalIndex;
               const isCompleted = completedLessons.includes(index);
               const isNext = !isCompleted && (index === 0 || completedLessons.includes(index - 1));
               const isLocked = !isCompleted && !isNext;
               
               let itemClass = 'lesson-item';
               if (isCompleted) itemClass += ' completed';
               else if (isNext) itemClass += ' current';

               let buttonText, buttonClass, buttonIcon;
               if (isCompleted) {
                   buttonText = 'مكتمل';
                   buttonClass = 'lesson-btn btn-completed';
                   buttonIcon = 'fa-check';
               } else if (isNext) {
                   buttonText = 'بدء الدرس';
                   buttonClass = 'lesson-btn btn-play';
                   buttonIcon = 'fa-play';
               } else {
                   buttonText = 'مقفل';
                   buttonClass = 'lesson-btn btn-lock';
                   buttonIcon = 'fa-lock';
               }

               return `
                   <div class="${itemClass}" onclick="${!isLocked ? `startLesson(${index})` : ''}">
                       <div class="lesson-header">
                           <div class="lesson-info">
                               <div class="lesson-number">
                                   ${isCompleted ? '<i class="fas fa-check"></i>' : index + 1}
                               </div>
                               <div class="lesson-details">
                                   <h4>${lesson.title || `الدرس ${index + 1}`}</h4>
                                   <div class="lesson-meta">
                                       <span><i class="fas fa-clock"></i> ${lesson.duration || '5'} دقيقة</span>
                                       ${lesson.type ? `<span><i class="fas ${getTypeIcon(lesson.type)}"></i> ${getTypeLabel(lesson.type)}</span>` : ''}
                                   </div>
                               </div>
                           </div>
                           <div class="lesson-actions">
                               <button class="${buttonClass}" ${isLocked ? 'disabled' : ''}>
                                   <i class="fas ${buttonIcon}"></i>
                                   ${buttonText}
                               </button>
                           </div>
                       </div>
                   </div>
               `;
           }).join('');
       }

       // Toggle Module
       function toggleModule(moduleIndex) {
           const moduleItem = document.querySelector(`[data-module="${moduleIndex}"]`);
           moduleItem.classList.toggle('expanded');
       }

       // Helper functions for lesson types
       function getTypeIcon(type) {
           const icons = {
               'video': 'fa-video',
               'text': 'fa-file-alt',
               'quiz': 'fa-question-circle',
               'assignment': 'fa-tasks',
               'resource': 'fa-download',
               'live': 'fa-broadcast-tower',
               'library-content': 'fa-book',
               'file': 'fa-file-download'
           };
           return icons[type] || 'fa-play-circle';
       }

       function getTypeLabel(type) {
           const labels = {
               'video': 'فيديو',
               'text': 'نص',
               'quiz': 'اختبار',
               'assignment': 'مهمة',
               'resource': 'مورد',
               'live': 'جلسة حية',
               'library-content': 'محتوى',
               'file': 'ملف'
           };
           return labels[type] || 'درس';
       }

       // Display User Progress
       function displayUserProgress() {
           const percentage = Math.round(userProgress.percentage || 0);
           const completedCount = (userProgress.completedLessons || []).length;
           const totalLessons = allLessons.length;
           const timeSpent = userProgress.timeSpent || 0;

           document.getElementById('userProgress').textContent = `${percentage}%`;
           document.getElementById('overallProgress').textContent = `${percentage}%`;
           document.getElementById('progressFill').style.width = `${percentage}%`;

           document.getElementById('completedLessons').textContent = `${completedCount} / ${totalLessons}`;
           document.getElementById('finishedLessons').textContent = completedCount;
           document.getElementById('remainingLessons').textContent = totalLessons - completedCount;

           // حساب الوقت المقضي
           const spentHours = Math.floor(timeSpent / 60);
           const spentMinutes = timeSpent % 60;
           const timeText = spentHours > 0 ? `${spentHours} ساعة ${spentMinutes} دقيقة` : `${spentMinutes} دقيقة`;
           document.getElementById('timeSpent').textContent = timeText;
           
           // حساب الوقت المتبقي بناءً على المدة الإجمالية للدورة
           const totalCourseDuration = courseData.totalDuration || 0;
           const remainingTime = Math.max(0, totalCourseDuration - timeSpent);
           const remainingHours = Math.floor(remainingTime / 60);
           const remainingMinutes = remainingTime % 60;
           const remainingText = remainingHours > 0 ? `${remainingHours} ساعة ${remainingMinutes} دقيقة` : `${remainingMinutes} دقيقة`;
           document.getElementById('estimatedTime').textContent = remainingText;

           const lastActivity = userProgress.lastActivity ? 
               new Date(userProgress.lastActivity.seconds * 1000).toLocaleDateString('ar-SA') : 
               'لم يتم التحديد';
           document.getElementById('lastActivity').textContent = lastActivity;
       }

       // Start Lesson
       async function startLesson(lessonIndex) {
           const lesson = allLessons[lessonIndex];
           if (!lesson) return;

           currentLessonIndex = lessonIndex;
           
           // حفظ آخر درس تم عرضه
           await saveLastViewedLesson(lessonIndex);
           
           document.getElementById('lessonTitleModal').textContent = lesson.title || `الدرس ${lessonIndex + 1}`;
           
           // عرض مؤشر التقدم
           const progressIndicator = document.getElementById('lessonProgressIndicator');
           const progressText = document.getElementById('lessonProgressText');
           progressIndicator.style.display = 'block';
           progressText.textContent = `الدرس ${lessonIndex + 1} من ${allLessons.length}`;
           
           // إخفاء جميع أنواع المحتوى
           hideAllContent();
           showContentLoading();
           
           // إذا كان المحتوى من المكتبة
           if (lesson.type === 'library-content' && lesson.libraryContentId) {
               await displayLibraryContent(lesson);
           } else {
               // المحتوى العادي
               switch(lesson.type) {
                   case 'video':
                       displayVideoContent(lesson);
                       break;
                   case 'text':
                       displayTextContent(lesson);
                       break;
                   case 'file':
                       displayFileContent(lesson);
                       break;
                   default:
                       displayTextContent(lesson);
               }
           }
           
           hideContentLoading();
           updateNavigationButtons();
           
           document.getElementById('lessonModal').classList.add('active');
           document.body.style.overflow = 'hidden';
       }

       // Display Library Content
       async function displayLibraryContent(lesson) {
           try {
               // جلب بيانات المحتوى من المكتبة
               const contentDoc = await db.collection('courseContentLibrary')
                   .doc(lesson.libraryContentId)
                   .get();
               
               if (!contentDoc.exists) {
                   showContentError('المحتوى غير موجود في المكتبة');
                   return;
               }
               
               const contentData = contentDoc.data();
               
               // عرض المحتوى حسب نوعه
               switch(contentData.type) {
                   case 'educational-video':
                       displayLibraryVideo(contentData);
                       break;
                   case 'quiz':
                       displayLibraryQuiz(contentData);
                       break;
                   case 'assignment':
                       displayLibraryAssignment(contentData);
                       break;
                   case 'discussion':
                       displayLibraryDiscussion(contentData);
                       break;
                   case 'presentation':
                       displayLibraryPresentation(contentData);
                       break;
                   default:
                       displayGenericContent(contentData);
               }
               
           } catch (error) {
               console.error('خطأ في تحميل المحتوى:', error);
               showContentError('حدث خطأ في تحميل المحتوى');
           }
       }

       // Display Library Video
       function displayLibraryVideo(contentData) {
           const container = document.getElementById('videoContent');
           container.style.display = 'block';
           
           if (contentData.videoData && contentData.videoData.url) {
               const videoHtml = createVideoEmbed(contentData.videoData.url);
               container.innerHTML = videoHtml;
               
               // إضافة الملاحظات إذا وجدت
               if (contentData.videoData.notes) {
                   container.innerHTML += `
                       <div style="margin-top: 1rem; padding: 1rem; background: rgba(255, 255, 255, 0.03); border-radius: 8px; border: 1px solid var(--border);">
                           <h4 style="color: var(--gold-primary); margin-bottom: 0.5rem;">
                               <i class="fas fa-sticky-note"></i> ملاحظات
                           </h4>
                           <p style="line-height: 1.6; color: rgba(255, 255, 255, 0.8);">${contentData.videoData.notes}</p>
                       </div>
                   `;
               }
           } else {
               showContentError('رابط الفيديو غير متوفر');
           }
       }

       // Display Library Quiz
       function displayLibraryQuiz(contentData) {
           const container = document.getElementById('quizContent');
           container.style.display = 'block';
           
           if (contentData.quizData && contentData.quizData.questions) {
               let quizHtml = `
                   <div class="quiz-container">
                       <h3 style="color: var(--gold-primary); margin-bottom: 1.5rem;">
                           <i class="fas fa-question-circle"></i> ${contentData.name}
                       </h3>
                       <p style="margin-bottom: 2rem; color: rgba(255, 255, 255, 0.8);">${contentData.description || ''}</p>
                       <div class="quiz-questions">
               `;
               
               contentData.quizData.questions.forEach((question, index) => {
                   quizHtml += `
                       <div class="quiz-question">
                           <h4 style="margin-bottom: 1rem; color: var(--gold-light);">السؤال ${index + 1}: ${question.text}</h4>
                           <div class="quiz-options">
                   `;
                   
                   question.options.forEach((option, optIndex) => {
                       quizHtml += `
                           <label>
                               <input type="radio" name="question-${index}" value="${optIndex}">
                               ${option}
                           </label>
                       `;
                   });
                   
                   quizHtml += `
                           </div>
                       </div>
                   `;
               });
               
               quizHtml += `
                       </div>
                       <button class="action-btn btn-primary" onclick="submitQuiz()" style="margin-top: 2rem;">
                           <i class="fas fa-check"></i> إرسال الإجابات
                       </button>
                   </div>
               `;
               
               container.innerHTML = quizHtml;
           } else {
               showContentError('محتوى الاختبار غير متوفر');
           }
       }

       // Display Video Content
       function displayVideoContent(lesson) {
           const container = document.getElementById('videoContent');
           container.style.display = 'block';
           
           if (lesson.videoUrl) {
               const videoHtml = createVideoEmbed(lesson.videoUrl);
               container.innerHTML = videoHtml;
           } else {
               container.innerHTML = `
                   <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: var(--dark-bg);">
                       <div style="text-align: center; color: rgba(255, 255, 255, 0.6);">
                           <i class="fas fa-video" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                           <p>رابط الفيديو غير متوفر</p>
                       </div>
                   </div>
               `;
           }
       }

       // Display Text Content
       function displayTextContent(lesson) {
           const container = document.getElementById('textContent');
           container.style.display = 'block';
           
           if (lesson.content) {
               container.innerHTML = lesson.content;
           } else {
               container.innerHTML = `
                   <div style="text-align: center; padding: 3rem; color: rgba(255, 255, 255, 0.6);">
                       <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                       <p>محتوى الدرس غير متوفر حالياً</p>
                   </div>
               `;
           }
       }

       // Display File Content
       function displayFileContent(lesson) {
           const container = document.getElementById('fileContent');
           container.style.display = 'block';
           
           if (lesson.fileUrl) {
               const fileName = lesson.fileName || 'ملف الدرس';
               const fileExtension = lesson.fileUrl.split('.').pop().toLowerCase();
               const fileIcon = getFileIcon(fileExtension);
               
               container.innerHTML = `
                   <div class="file-preview">
                       <i class="fas ${fileIcon} file-icon"></i>
                       <h3 style="color: var(--gold-light); margin-bottom: 1rem;">${fileName}</h3>
                       <p style="color: rgba(255, 255, 255, 0.6); margin-bottom: 2rem;">
                           ${lesson.description || 'ملف للتحميل'}
                       </p>
                       <a href="${lesson.fileUrl}" class="download-btn" download>
                           <i class="fas fa-download"></i>
                           تحميل الملف
                       </a>
                   </div>
               `;
           } else {
               showContentError('رابط الملف غير متوفر');
           }
       }

       // Display Generic Content
       function displayGenericContent(contentData) {
           const container = document.getElementById('textContent');
           container.style.display = 'block';
           
           container.innerHTML = `
               <div style="padding: 2rem;">
                   <h3 style="color: var(--gold-primary); margin-bottom: 1.5rem;">
                       <i class="fas fa-book"></i> ${contentData.name}
                   </h3>
                   <p style="color: rgba(255, 255, 255, 0.8); line-height: 1.8;">
                       ${contentData.description || 'محتوى الدرس'}
                   </p>
               </div>
           `;
       }

       // Helper Functions
       function hideAllContent() {
           const containers = ['videoContent', 'textContent', 'quizContent', 'fileContent', 'discussionContent'];
           containers.forEach(id => {
               const element = document.getElementById(id);
               if (element) element.style.display = 'none';
           });
       }

       function showContentLoading() {
           const loadingHtml = `
               <div class="content-loading">
                   <div class="spinner"></div>
                   <p style="color: rgba(255, 255, 255, 0.6);">جاري تحميل المحتوى...</p>
               </div>
           `;
           
           document.querySelector('.lesson-content').insertAdjacentHTML('afterbegin', loadingHtml);
       }

       function hideContentLoading() {
           const loader = document.querySelector('.content-loading');
           if (loader) {
               loader.remove();
           }
       }

       function showContentError(message) {
           const container = document.getElementById('textContent');
           container.style.display = 'block';
           container.innerHTML = `
               <div style="text-align: center; padding: 3rem; color: rgba(255, 255, 255, 0.6);">
                   <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem; color: var(--longing-3);"></i>
                   <p>${message}</p>
               </div>
           `;
       }

       function getFileIcon(extension) {
           const icons = {
               'pdf': 'fa-file-pdf',
               'doc': 'fa-file-word',
               'docx': 'fa-file-word',
               'xls': 'fa-file-excel',
               'xlsx': 'fa-file-excel',
               'ppt': 'fa-file-powerpoint',
               'pptx': 'fa-file-powerpoint',
               'zip': 'fa-file-archive',
               'rar': 'fa-file-archive',
               'jpg': 'fa-file-image',
               'png': 'fa-file-image',
               'mp3': 'fa-file-audio',
               'mp4': 'fa-file-video'
           };
           return icons[extension] || 'fa-file';
       }

       // Create Video Embed
       function createVideoEmbed(url) {
           if (url.includes('youtube.com') || url.includes('youtu.be')) {
               const videoId = extractYouTubeId(url);
               return `<iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>`;
           } else if (url.includes('vimeo.com')) {
               const videoId = url.split('/').pop();
               return `<iframe src="https://player.vimeo.com/video/${videoId}" allowfullscreen></iframe>`;
           } else {
               return `<video controls style="width: 100%; height: 100%;"><source src="${url}" type="video/mp4">متصفحك لا يدعم تشغيل الفيديو</video>`;
           }
       }

       // Extract YouTube ID
       function extractYouTubeId(url) {
           const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
           const match = url.match(regex);
           return match ? match[1] : '';
       }

       // Update Navigation Buttons
       function updateNavigationButtons() {
           const prevBtn = document.getElementById('prevLessonBtn');
           const nextBtn = document.getElementById('nextLessonBtn');
           const completeBtn = document.getElementById('completeLessonBtn');
           
           prevBtn.disabled = currentLessonIndex === 0;
           nextBtn.disabled = currentLessonIndex === allLessons.length - 1;
           
           const completedLessons = userProgress.completedLessons || [];
           const isCompleted = completedLessons.includes(currentLessonIndex);
           
           if (isCompleted) {
               completeBtn.innerHTML = '<i class="fas fa-check"></i> مكتمل';
               completeBtn.style.background = 'linear-gradient(135deg, var(--longing-5) 0%, #059669 100%)';
           } else {
               completeBtn.innerHTML = '<i class="fas fa-check"></i> إكمال الدرس';
               completeBtn.style.background = 'linear-gradient(135deg, var(--gold-primary) 0%, var(--sun-orange) 100%)';
           }
       }

       // Update Continue Button
       function updateContinueButton() {
           const continueBtn = document.getElementById('continueBtn');
           const lastViewed = userProgress.lastViewedLesson;
           const completedLessons = userProgress.completedLessons || [];
           
           if (lastViewed !== undefined && lastViewed !== null && lastViewed < allLessons.length) {
               continueBtn.innerHTML = '<i class="fas fa-play"></i> متابعة من آخر درس';
               continueBtn.onclick = () => startLesson(lastViewed);
           } else {
               const nextLesson = completedLessons.length;
               if (nextLesson < allLessons.length) {
                   continueBtn.innerHTML = '<i class="fas fa-play"></i> بدء الدرس التالي';
                   continueBtn.onclick = () => startLesson(nextLesson);
               } else {
                   continueBtn.innerHTML = '<i class="fas fa-check"></i> الدورة مكتملة';
                   continueBtn.disabled = true;
               }
           }
       }

       // Save Last Viewed Lesson
       async function saveLastViewedLesson(lessonIndex) {
           try {
               await db.collection('users').doc(userId).update({
                   [`progress.${courseId}.lastViewedLesson`]: lessonIndex,
                   [`progress.${courseId}.lastActivity`]: firebase.firestore.FieldValue.serverTimestamp()
               });
               userProgress.lastViewedLesson = lessonIndex;
           } catch (error) {
               console.error('خطأ في حفظ آخر درس:', error);
           }
       }

       // Progress Tracking
       function startProgressTracking() {
           progressTimer = setInterval(() => {
               if (currentLessonIndex !== null) {
                   updateTimeSpent();
               }
           }, 30000); // كل 30 ثانية
       }

       function stopProgressTracking() {
           if (progressTimer) {
               clearInterval(progressTimer);
               progressTimer = null;
           }
       }

       async function updateTimeSpent() {
           try {
               const newTimeSpent = (userProgress.timeSpent || 0) + 0.5; // نصف دقيقة
               await db.collection('users').doc(userId).update({
                   [`progress.${courseId}.timeSpent`]: newTimeSpent
               });
               userProgress.timeSpent = newTimeSpent;
           } catch (error) {
               console.error('خطأ في تحديث الوقت:', error);
           }
       }

       // Close Lesson Player
       function closeLessonPlayer() {
           document.getElementById('lessonModal').classList.remove('active');
           document.body.style.overflow = 'auto';
           currentLessonIndex = null;
       }

       // Mark Lesson as Completed
       async function markLessonCompleted(lessonIndex) {
           try {
               const completedLessons = userProgress.completedLessons || [];
               
               if (!completedLessons.includes(lessonIndex)) {
                   completedLessons.push(lessonIndex);
                   
                   const totalLessons = allLessons.length;
                   const newPercentage = totalLessons > 0 ? (completedLessons.length / totalLessons) * 100 : 0;
                   
                   const updatedProgress = {
                       ...userProgress,
                       completedLessons,
                       percentage: newPercentage,
                       lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
                       timeSpent: (userProgress.timeSpent || 0) + 10 // إضافة 10 دقائق
                   };

                   await db.collection('users').doc(userId).update({
                       [`progress.${courseId}`]: updatedProgress
                   });

                   userProgress = updatedProgress;
                   
                   displayUserProgress();
                   displayModulesAndLessons();
                   updateNavigationButtons();
                   updateContinueButton();
                   
                   // Check milestones
                   checkMilestones(newPercentage);

                   Swal.fire({
                       icon: 'success',
                       title: 'أحسنت!',
                       text: 'تم إكمال الدرس بنجاح',
                       confirmButtonColor: 'var(--gold-primary)',
                       timer: 2000,
                       timerProgressBar: true
                   });
               }

           } catch (error) {
               console.error('خطأ في حفظ التقدم:', error);
               Swal.fire({
                   icon: 'error',
                   title: 'خطأ',
                   text: 'فشل في حفظ التقدم',
                   confirmButtonColor: 'var(--gold-primary)'
               });
           }
       }

       // Check Milestones
       function checkMilestones(newPercentage) {
           const milestones = [25, 50, 75, 100];
           const oldPercentage = userProgress.percentage || 0;
           
           milestones.forEach(milestone => {
               if (oldPercentage < milestone && newPercentage >= milestone) {
                   showMilestoneNotification(milestone);
               }
           });
       }

       function showMilestoneNotification(percentage) {
           let message, icon;
           
           switch(percentage) {
               case 25:
                   message = 'رائع! أكملت ربع الدورة';
                   icon = '🎯';
                   break;
               case 50:
                   message = 'ممتاز! أنت في منتصف الطريق';
                   icon = '🌟';
                   break;
               case 75:
                   message = 'أحسنت! اقتربت من النهاية';
                   icon = '🚀';
                   break;
               case 100:
                   message = 'تهانينا! أكملت الدورة بنجاح';
                   icon = '🎉';
                   break;
           }
           
           Swal.fire({
               icon: 'success',
               title: icon + ' ' + message,
               text: `لقد أكملت ${percentage}% من الدورة`,
               confirmButtonColor: 'var(--gold-primary)',
               timer: 5000,
               timerProgressBar: true
           });
       }

       // Submit Quiz
       function submitQuiz() {
           Swal.fire({
               icon: 'info',
               title: 'تم إرسال الإجابات',
               text: 'سيتم مراجعة إجاباتك وإعلامك بالنتيجة',
               confirmButtonColor: 'var(--gold-primary)'
           });
       }

       // Setup Event Listeners
       function setupEventListeners() {
           document.getElementById('continueBtn').addEventListener('click', () => {
               // سيتم تحديث هذا الزر ديناميكياً
           });

           document.getElementById('restartBtn').addEventListener('click', () => {
               Swal.fire({
                   title: 'إعادة بدء الدورة',
                   text: 'هل أنت متأكد؟ سيتم حذف جميع التقدم المحرز',
                   icon: 'warning',
                   showCancelButton: true,
                   confirmButtonText: 'نعم، إعادة البدء',
                   cancelButtonText: 'إلغاء',
                   confirmButtonColor: 'var(--longing-1)',
                   cancelButtonColor: 'var(--gray-medium)'
               }).then((result) => {
                   if (result.isConfirmed) {
                       restartCourse();
                   }
               });
           });
       }

       // Setup Lesson Player Event Listeners
       function setupLessonPlayerListeners() {
           document.getElementById('closeLessonBtn').addEventListener('click', closeLessonPlayer);
           
           document.getElementById('lessonModal').addEventListener('click', function(e) {
               if (e.target === this) {
                   closeLessonPlayer();
               }
           });
           
           document.getElementById('prevLessonBtn').addEventListener('click', () => {
               if (currentLessonIndex > 0) {
                   startLesson(currentLessonIndex - 1);
               }
           });
           
           document.getElementById('nextLessonBtn').addEventListener('click', () => {
               if (currentLessonIndex < allLessons.length - 1) {
                   startLesson(currentLessonIndex + 1);
               }
           });
           
           document.getElementById('completeLessonBtn').addEventListener('click', () => {
               if (currentLessonIndex !== null) {
                   markLessonCompleted(currentLessonIndex);
               }
           });
           
           // Keyboard shortcuts
           document.addEventListener('keydown', function(e) {
               if (document.getElementById('lessonModal').classList.contains('active')) {
                   switch(e.key) {
                       case 'Escape':
                           closeLessonPlayer();
                           break;
                       case 'ArrowRight':
                           if (currentLessonIndex > 0) {
                               startLesson(currentLessonIndex - 1);
                           }
                           break;
                       case 'ArrowLeft':
                           if (currentLessonIndex < allLessons.length - 1) {
                               startLesson(currentLessonIndex + 1);
                           }
                           break;
                       case ' ': // Space bar
                           e.preventDefault();
                           const video = document.querySelector('#videoContent video');
                           if (video) {
                               if (video.paused) {
                                   video.play();
                               } else {
                                   video.pause();
                               }
                           }
                           break;
                   }
               }
           });
       }

       // Restart Course
       async function restartCourse() {
           try {
               const resetProgress = {
                   percentage: 0,
                   completedLessons: [],
                   timeSpent: 0,
                   lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
                   lastViewedLesson: null
               };

               await db.collection('users').doc(userId).update({
                   [`progress.${courseId}`]: resetProgress
               });

               userProgress = resetProgress;
               displayUserProgress();
               displayModulesAndLessons();
               updateContinueButton();

               Swal.fire({
                   icon: 'success',
                   title: 'تم!',
                   text: 'تم إعادة تعيين تقدم الدورة',
                   confirmButtonColor: 'var(--gold-primary)'
               });

           } catch (error) {
               console.error('خطأ في إعادة التعيين:', error);
           }
       }

       // Show Error
       function showError(message) {
           hideLoader();
           document.getElementById('errorMessage').textContent = message;
           document.getElementById('errorState').style.display = 'flex';
           document.getElementById('mainContent').style.display = 'none';
       }

       // Hide Loader
       function hideLoader() {
           const loader = document.getElementById('pageLoader');
           loader.style.opacity = '0';
           setTimeout(() => {
               loader.style.display = 'none';
           }, 500);
       }

       // Error Handling
       window.addEventListener('error', function(e) {
           console.error('خطأ في الصفحة:', e.error);
       });

       window.addEventListener('unhandledrejection', function(e) {
           console.error('خطأ غير معالج:', e.reason);
       });

       // Clean up on page unload
       window.addEventListener('beforeunload', function() {
           stopProgressTracking();
       });
   </script>
</body>
</html>
