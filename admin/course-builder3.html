<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منشئ الدورات الاحترافي المحسن - منظور الفؤاد</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 for better modals -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Sortable JS for drag & drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #f4c430;
            --primary-dark: #e6b429;
            --primary-light: #f7d060;
            --secondary: #2196f3;
            --secondary-dark: #1976d2;
            --success: #4caf50;
            --success-light: #81c784;
            --danger: #ff4444;
            --danger-light: #ff7979;
            --warning: #ff9800;
            --warning-light: #ffb74d;
            --info: #17a2b8;
            --info-light: #4fc3f7;
            --dark: #1a1a1a;
            --darker: #0f0f0f;
            --light: #2a2a2a;
            --lighter: #3a3a3a;
            --text: #e0e0e0;
            --text-muted: #999;
            --text-light: #b0b0b0;
            --border: rgba(255, 255, 255, 0.1);
            --border-light: rgba(255, 255, 255, 0.05);
            --border-dark: rgba(255, 255, 255, 0.2);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            --shadow-light: 0 5px 15px rgba(0, 0, 0, 0.3);
            --shadow-heavy: 0 20px 60px rgba(0, 0, 0, 0.7);
            --radius: 12px;
            --radius-small: 8px;
            --radius-large: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.2s ease;
            --transition-slow: all 0.5s ease;
            
            /* Enhanced Gradients */
            --gradient-primary: linear-gradient(135deg, var(--primary), var(--primary-dark));
            --gradient-secondary: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            --gradient-success: linear-gradient(135deg, var(--success), #2e7d32);
            --gradient-danger: linear-gradient(135deg, var(--danger), #d32f2f);
            --gradient-dark: linear-gradient(135deg, var(--light), var(--lighter));
            --gradient-overlay: linear-gradient(135deg, rgba(244, 196, 48, 0.1), rgba(244, 196, 48, 0.05));
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Kufi Arabic', sans-serif;
            background: var(--darker);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
            font-size: 14px;
            line-height: 1.6;
        }

        /* Enhanced Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--lighter);
            border-radius: 4px;
            transition: var(--transition);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        ::-webkit-scrollbar-corner {
            background: var(--dark);
        }

        /* Main Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Enhanced Header */
        .app-header {
            height: 80px;
            background: var(--dark);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 2rem;
            gap: 2rem;
            flex-shrink: 0;
            position: relative;
            z-index: 100;
        }

        .app-header::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0.8;
        }

        .header-back {
            width: 45px;
            height: 45px;
            background: var(--lighter);
            border: none;
            border-radius: 12px;
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .header-back::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            transition: var(--transition);
            z-index: -1;
        }

        .header-back:hover::before {
            left: 0;
        }

        .header-back:hover {
            color: var(--dark);
            transform: translateX(3px);
            box-shadow: var(--shadow-light);
        }

        .header-title {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .course-title-edit {
            background: transparent;
            border: 2px solid transparent;
            color: var(--primary);
            font-size: 1.4rem;
            font-weight: 600;
            padding: 0.7rem 1.2rem;
            border-radius: 10px;
            min-width: 350px;
            transition: var(--transition);
            font-family: inherit;
        }

        .course-title-edit:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(244, 196, 48, 0.1);
            box-shadow: 0 0 0 3px rgba(244, 196, 48, 0.2);
        }

        .course-title-edit::placeholder {
            color: var(--text-muted);
        }

        .save-indicator {
            display: flex;
            align-items: center;
            gap: 0.7rem;
            font-size: 0.9rem;
            color: var(--text-muted);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: var(--transition);
        }

        .save-indicator.saving {
            color: var(--warning);
            background: rgba(255, 152, 0, 0.1);
        }

        .save-indicator.saved {
            color: var(--success);
            background: rgba(76, 175, 80, 0.1);
        }

        .save-indicator.error {
            color: var(--danger);
            background: rgba(255, 68, 68, 0.1);
        }

        .save-indicator i {
            font-size: 1rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Enhanced Buttons */
        .btn {
            padding: 0.8rem 1.8rem;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            font-family: inherit;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: var(--transition);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-secondary {
            background: var(--lighter);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: var(--dark);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(244, 196, 48, 0.4);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 68, 68, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Main Content */
        .app-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Enhanced Steps Navigation */
        .steps-nav {
            width: 280px;
            background: var(--dark);
            border-left: 1px solid var(--border);
            padding: 2rem 1.5rem;
            overflow-y: auto;
            flex-shrink: 0;
            position: relative;
        }

        .steps-nav::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 3px;
            background: var(--gradient-primary);
            opacity: 0.3;
        }

        .steps-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
        }

        .steps-title::after {
            content: '';
            position: absolute;
            bottom: -0.5rem;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: var(--gradient-primary);
            border-radius: 2px;
        }

        .step-item {
            display: flex;
            align-items: center;
            gap: 1.2rem;
            padding: 1.2rem;
            margin-bottom: 0.8rem;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            border: 1px solid transparent;
        }

        .step-item::before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: transparent;
            border-radius: 2px;
            transition: var(--transition);
        }

        .step-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--border);
            transform: translateX(-5px);
        }

        .step-item.active {
            background: var(--gradient-overlay);
            border-color: var(--primary);
        }

        .step-item.active::before {
            background: var(--gradient-primary);
        }

        .step-item.completed .step-number {
            background: var(--gradient-success);
            color: white;
        }

        .step-item.completed .step-number i {
            display: block;
        }

        .step-item.completed .step-number span {
            display: none;
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: var(--lighter);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.95rem;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .step-number i {
            display: none;
            font-size: 1rem;
        }

        .step-content {
            flex: 1;
        }

        .step-name {
            font-weight: 600;
            margin-bottom: 0.3rem;
            font-size: 0.95rem;
        }

        .step-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        /* Main Panel */
        .main-panel {
            flex: 1;
            padding: 2.5rem;
            overflow-y: auto;
            background: var(--darker);
            position: relative;
        }

        .main-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(244, 196, 48, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(33, 150, 243, 0.03) 0%, transparent 50%);
            pointer-events: none;
        }

        .panel-container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Enhanced Step Panels */
        .step-panel {
            display: none;
            animation: fadeInUp 0.4s ease-out;
        }

        .step-panel.active {
            display: block;
        }

        /* Progress Container */
        .progress-container {
            margin-bottom: 3rem;
            background: var(--dark);
            padding: 2rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .progress-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            opacity: 0.6;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .progress-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
        }

        .progress-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .progress-bar {
            height: 12px;
            background: var(--lighter);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 1rem;
            position: relative;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 25%, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.1) 50%, transparent 50%, transparent 75%, rgba(255, 255, 255, 0.1) 75%);
            background-size: 20px 20px;
            animation: progressStripes 1s linear infinite;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            width: 0%;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 8px;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3));
            border-radius: 0 6px 6px 0;
        }

        .progress-text {
            text-align: center;
            font-size: 0.95rem;
            color: var(--text);
            font-weight: 500;
        }

        /* Panel Header */
        .panel-header {
            margin-bottom: 3rem;
            text-align: center;
            position: relative;
        }

        .panel-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.8rem;
            position: relative;
        }

        .panel-title::after {
            content: '';
            position: absolute;
            bottom: -0.5rem;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: var(--gradient-primary);
            border-radius: 2px;
        }

        .panel-subtitle {
            color: var(--text-light);
            font-size: 1.1rem;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Enhanced Form Elements */
        .form-section {
            background: var(--dark);
            padding: 2.5rem;
            border-radius: var(--radius);
            margin-bottom: 2rem;
            border: 1px solid var(--border);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .form-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: var(--transition);
        }

        .form-section:hover {
            border-color: rgba(244, 196, 48, 0.3);
            box-shadow: var(--shadow-light);
        }

        .form-section:hover::before {
            opacity: 0.6;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .section-icon {
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark);
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .section-info {
            flex: 1;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.3rem;
        }

        .section-description {
            color: var(--text-muted);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 2rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 0.8rem;
            font-weight: 600;
            color: var(--text);
            font-size: 0.95rem;
            position: relative;
        }

        .form-label.required::after {
            content: '*';
            color: var(--danger);
            margin-left: 0.3rem;
        }

        .form-hint {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            line-height: 1.4;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-hint i {
            color: var(--info);
        }

        .form-control {
            width: 100%;
            padding: 1.2rem 1.5rem;
            background: var(--lighter);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 1rem;
            transition: var(--transition);
            font-family: inherit;
            position: relative;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(244, 196, 48, 0.05);
            box-shadow: 0 0 0 3px rgba(244, 196, 48, 0.1);
            transform: translateY(-1px);
        }

        .form-control::placeholder {
            color: var(--text-muted);
        }

        .form-control:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        textarea.form-control {
            min-height: 140px;
            resize: vertical;
            line-height: 1.6;
        }

        select.form-control {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: left 1rem center;
            background-repeat: no-repeat;
            background-size: 1rem;
            padding-left: 3rem;
        }

        /* Enhanced Rich Text Editor */
        .editor-container {
            background: var(--lighter);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid var(--border);
            transition: var(--transition);
        }

        .editor-container:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(244, 196, 48, 0.1);
        }

        .ql-toolbar {
            background: var(--light) !important;
            border: none !important;
            border-bottom: 1px solid var(--border) !important;
            padding: 1rem !important;
        }

        .ql-container {
            border: none !important;
            font-family: inherit;
            font-size: 1rem;
            color: var(--text);
        }

        .ql-editor {
            min-height: 220px;
            padding: 2rem;
            line-height: 1.7;
        }

        .ql-editor.ql-blank::before {
            color: var(--text-muted);
            font-style: normal;
        }

        /* Enhanced Image Upload */
        .image-upload {
            border: 3px dashed var(--border);
            border-radius: var(--radius);
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(244, 196, 48, 0.02);
            position: relative;
            overflow: hidden;
        }

        .image-upload::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(transparent, var(--primary), transparent);
            opacity: 0;
            transition: var(--transition);
            animation: rotate 3s linear infinite;
        }

        .image-upload:hover::before {
            opacity: 0.1;
        }

        .image-upload:hover {
            border-color: var(--primary);
            background: rgba(244, 196, 48, 0.05);
            transform: translateY(-2px);
        }

        .image-upload.has-image {
            padding: 0;
            height: 280px;
            border-style: solid;
        }

        .image-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: calc(var(--radius) - 3px);
        }

        .upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition);
            backdrop-filter: blur(5px);
        }

        .image-upload:hover .upload-overlay {
            opacity: 1;
        }

        .upload-content {
            position: relative;
            z-index: 2;
        }

        .upload-icon {
            font-size: 3.5rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
            display: block;
        }

        .upload-text {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        /* Course/Instructor Placeholder Images */
        .course-placeholder-image {
            width: 100%;
            height: 280px;
            background: var(--gradient-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--dark);
            border-radius: calc(var(--radius) - 3px);
            position: relative;
            overflow: hidden;
        }

        .course-placeholder-image::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.1), transparent 60%),
                radial-gradient(circle at 70% 70%, rgba(255, 255, 255, 0.05), transparent 60%);
        }

        .course-placeholder-image i {
            font-size: 4rem;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .course-placeholder-image span {
            font-size: 1.2rem;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .instructor-placeholder-image {
            width: 100%;
            height: 100%;
            background: var(--gradient-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
        }

        .instructor-placeholder-image::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 40% 40%, rgba(255, 255, 255, 0.1), transparent 70%);
        }

        .instructor-placeholder-image i {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }

        .instructor-placeholder-image span {
            font-size: 1rem;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        /* Enhanced Navigation Buttons */
        .step-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        @keyframes progressStripes {
            0% { background-position: 0 0; }
            100% { background-position: 20px 0; }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .panel-container {
                max-width: 100%;
            }
            
            .main-panel {
                padding: 2rem;
            }
        }

        @media (max-width: 1024px) {
            .steps-nav {
                position: fixed;
                right: -280px;
                top: 80px;
                bottom: 0;
                z-index: 1000;
                transition: right 0.3s ease;
                box-shadow: var(--shadow);
            }

            .steps-nav.active {
                right: 0;
            }

            .main-panel {
                padding: 1.5rem;
            }

            .form-section {
                padding: 2rem;
            }
        }

        @media (max-width: 768px) {
            .app-header {
                padding: 0 1rem;
                height: 70px;
            }

            .course-title-edit {
                min-width: 200px;
                font-size: 1.2rem;
            }

            .header-actions {
                gap: 0.5rem;
            }

            .btn {
                padding: 0.7rem 1.2rem;
                font-size: 0.9rem;
            }

            .panel-title {
                font-size: 1.8rem;
            }

            .form-section {
                padding: 1.5rem;
            }

            .main-panel {
                padding: 1rem;
            }

            .section-header {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
        }

        @media (max-width: 480px) {
            .progress-stats {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .step-navigation {
                flex-direction: column;
                gap: 1rem;
            }
            
            .header-title {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        /* Print Styles */
        @media print {
            .app-header,
            .steps-nav,
            .step-navigation {
                display: none;
            }
            
            .main-panel {
                padding: 0;
            }
            
            .step-panel {
                display: block !important;
                page-break-after: always;
            }
        }

        /* Dark Mode Enhancements */
        @media (prefers-color-scheme: dark) {
            .form-control {
                color-scheme: dark;
            }
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            :root {
                --border: rgba(255, 255, 255, 0.3);
                --text-muted: #ccc;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Enhanced Header -->
        <header class="app-header">
            <button class="header-back" onclick="goBack()" title="العودة للوحة التحكم">
                <i class="fas fa-arrow-right"></i>
            </button>
            
            <div class="header-title">
                <input type="text" 
                       class="course-title-edit" 
                       id="courseTitle"
                       placeholder="اسم الدورة..." 
                       value="دورة جديدة">
                
                <div class="save-indicator" id="saveIndicator">
                    <i class="fas fa-check-circle"></i>
                    <span>تم الحفظ</span>
                </div>
            </div>
            
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="previewCourse()" title="معاينة الدورة">
                    <i class="fas fa-eye"></i>
                    <span>معاينة</span>
                </button>
                
                <button class="btn btn-secondary" onclick="saveDraft()" title="حفظ كمسودة">
                    <i class="fas fa-save"></i>
                    <span>حفظ</span>
                </button>
                
                <button class="btn btn-primary" onclick="publishCourse()" title="نشر الدورة">
                    <i class="fas fa-rocket"></i>
                    <span>نشر الدورة</span>
                </button>
            </div>
        </header>

        <div class="app-content">
            <!-- Enhanced Steps Navigation -->
            <nav class="steps-nav" id="stepsNav">
                <h3 class="steps-title">خطوات إنشاء الدورة</h3>
                
                <div class="step-item active" onclick="showStep(1)" data-step="1">
                    <div class="step-number">
                        <span>1</span>
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="step-content">
                        <div class="step-name">المعلومات الأساسية</div>
                        <div class="step-desc">العنوان والوصف والمدرب</div>
                    </div>
                </div>
                
                <div class="step-item" onclick="showStep(2)" data-step="2">
                    <div class="step-number">
                        <span>2</span>
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="step-content">
                        <div class="step-name">التسعير والدفع</div>
                        <div class="step-desc">السعر وطرق الدفع اليدوية</div>
                    </div>
                </div>
                
                <div class="step-item" onclick="showStep(3)" data-step="3">
                    <div class="step-number">
                        <span>3</span>
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="step-content">
                        <div class="step-name">بناء المنهج</div>
                        <div class="step-desc">الوحدات والدروس والمحتوى</div>
                    </div>
                </div>
                
                <div class="step-item" onclick="showStep(4)" data-step="4">
                    <div class="step-number">
                        <span>4</span>
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="step-content">
                        <div class="step-name">إعدادات الطلاب</div>
                        <div class="step-desc">الشهادات والتقدم والواتساب</div>
                    </div>
                </div>
                
                <div class="step-item" onclick="showStep(5)" data-step="5">
                    <div class="step-number">
                        <span>5</span>
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="step-content">
                        <div class="step-name">النشر والتسويق</div>
                        <div class="step-desc">صفحة الهبوط والمحتوى المتدرج</div>
                    </div>
                </div>

                <!-- Mobile Menu Toggle -->
                <button class="mobile-menu-toggle" onclick="toggleStepsNav()" id="mobileMenuToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </nav>

            <!-- Main Panel -->
            <main class="main-panel">
                <div class="panel-container">
                    <!-- Enhanced Progress Container -->
                    <div class="progress-container">
                        <div class="progress-header">
                            <div class="progress-title">تقدم إعداد الدورة</div>
                            <div class="progress-stats">
                                <span><i class="fas fa-tasks"></i> <span id="completedSteps">1</span> من 5 خطوات</span>
                                <span><i class="fas fa-clock"></i> آخر حفظ: <span id="lastSaved">الآن</span></span>
                                <span><i class="fas fa-users"></i> <span id="enrolledCount">0</span> طالب مسجل</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressBar" style="width: 20%;"></div>
                        </div>
                        <div class="progress-text">اكتمل <span id="progressPercent">20</span>% من إعداد الدورة</div>
                    </div>

                    <!-- Step 1: Enhanced Basic Info -->
                    <div class="step-panel active" id="step1">
                        <div class="panel-header">
                            <h1 class="panel-title">المعلومات الأساسية للدورة</h1>
                            <p class="panel-subtitle">أضف المعلومات الأساسية التي ستظهر للطلاب وتساعدهم في اتخاذ قرار الالتحاق بالدورة</p>
                        </div>

                        <!-- Course Basic Information -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">معلومات الدورة الأساسية</h3>
                                    <p class="section-description">البيانات الرئيسية التي تعرّف دورتك وتجذب الطلاب المناسبين</p>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required">عنوان الدورة</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="courseTitleMain" 
                                       placeholder="مثال: رحلة اكتشاف الذات بمنظور الفؤاد"
                                       maxlength="100">
                                <div class="form-hint">
                                    <i class="fas fa-lightbulb"></i>
                                    اختر عنواناً جذاباً وواضحاً يعبر عن محتوى الدورة (100 حرف كحد أقصى)
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">العنوان الفرعي</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="courseSubtitle" 
                                       placeholder="مثال: رحلة تحولية لفهم النفس واكتشاف الهدف"
                                       maxlength="150">
                                <div class="form-hint">
                                    <i class="fas fa-info-circle"></i>
                                    عنوان توضيحي يظهر تحت العنوان الرئيسي (150 حرف كحد أقصى)
                                </div>
                            </div>

                            <!-- Enhanced URL Slug Section -->
                            <div class="form-group">
                                <label class="form-label">رابط الدورة (URL)</label>
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.8rem; padding: 1rem; background: var(--lighter); border-radius: 8px;">
                                    <span style="color: var(--text-muted); font-size: 0.9rem; font-family: monospace;">
                                        mahmoudfouad25.github.io/fouad-perspective/courses/
                                    </span>
                                    <span id="slugPreview" style="color: var(--primary); font-weight: 600; font-family: monospace;">
                                        course-url-here
                                    </span>
                                </div>
                                <input type="text" 
                                       class="form-control" 
                                       id="courseSlug" 
                                       placeholder="اتركه فارغاً وسيتم إنشاؤه تلقائياً من العنوان"
                                       style="direction: ltr; font-family: monospace;"
                                       pattern="[a-z0-9-]+"
                                       oninput="updateSlugPreview(this.value)">
                                <div class="form-hint">
                                    <i class="fas fa-link"></i>
                                    يُقبل فقط: أحرف إنجليزية صغيرة، أرقام، وعلامة - (مثال: journey-of-self-discovery)
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required">الوصف المختصر</label>
                                <textarea class="form-control" 
                                          id="courseDescription" 
                                          rows="3" 
                                          placeholder="وصف موجز للدورة يظهر في نتائج البحث والكروت التعريفية..."
                                          maxlength="300"></textarea>
                                <div class="form-hint">
                                    <i class="fas fa-search"></i>
                                    <span id="descriptionCount">0</span>/300 حرف - هذا الوصف يظهر في محركات البحث
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required">الوصف التفصيلي</label>
                                <div class="editor-container">
                                    <div id="descriptionEditor"></div>
                                </div>
                                <div class="form-hint">
                                    <i class="fas fa-edit"></i>
                                    اشرح بالتفصيل ما ستقدمه في الدورة، الفوائد، والمهارات التي سيكتسبها الطلاب
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">صورة الدورة</label>
                                <div class="image-upload" id="courseImageUpload" onclick="uploadCourseImage()">
                                    <div class="upload-content">
                                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                        <div class="upload-text">اسحب الصورة هنا أو انقر للاختيار</div>
                                        <div class="form-hint">1920x1080 بكسل - JPG أو PNG - 5MB كحد أقصى</div>
                                    </div>
                                    <div class="upload-overlay">
                                        <button class="btn btn-primary">تغيير الصورة</button>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">فيديو تعريفي (اختياري)</label>
                                <input type="url" 
                                       class="form-control" 
                                       id="courseIntroVideo" 
                                       placeholder="رابط YouTube أو Vimeo أو رابط مباشر للفيديو"
                                       style="direction: ltr;">
                                <div class="form-hint">
                                    <i class="fas fa-video"></i>
                                    فيديو قصير (2-5 دقائق) يعرّف بالدورة ويشجع الطلاب على التسجيل
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Instructor Information -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-user-tie"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">معلومات المدرب</h3>
                                    <p class="section-description">بيانات المدرب التي تبني الثقة وتعرّف بخبراته ومؤهلاته</p>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label required">اسم المدرب</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="instructorName" 
                                       placeholder="الاسم الكامل للمدرب"
                                       maxlength="50">
                                <div class="form-hint">
                                    <i class="fas fa-user"></i>
                                    الاسم الذي سيظهر للطلاب في جميع أنحاء الدورة
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">نبذة عن المدرب</label>
                                <textarea class="form-control" 
                                          id="instructorBio" 
                                          rows="4" 
                                          placeholder="خبرة المدرب ومؤهلاته وإنجازاته والمجالات التي يتخصص فيها..."
                                          maxlength="500"></textarea>
                                <div class="form-hint">
                                    <i class="fas fa-award"></i>
                                    <span id="bioCount">0</span>/500 حرف - نبذة مختصرة تعرّف بالمدرب وخبراته
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">صورة المدرب</label>
                                <div class="image-upload" 
                                     id="instructorImageUpload" 
                                     onclick="uploadInstructorImage()" 
                                     style="max-width: 300px; margin: 0 auto;">
                                    <div class="upload-content">
                                        <i class="fas fa-user-circle upload-icon"></i>
                                        <div class="upload-text">اسحب الصورة هنا أو انقر للاختيار</div>
                                        <div class="form-hint">صورة مربعة - 500x500 بكسل - JPG أو PNG</div>
                                    </div>
                                    <div class="upload-overlay">
                                        <button class="btn btn-primary">تغيير الصورة</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Social Media Links -->
                            <div class="form-group">
                                <label class="form-label">روابط التواصل الاجتماعي (اختياري)</label>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                    <div>
                                        <input type="url" 
                                               class="form-control" 
                                               id="instructorLinkedIn" 
                                               placeholder="https://linkedin.com/in/username"
                                               style="direction: ltr;">
                                        <div class="form-hint">
                                            <i class="fab fa-linkedin"></i> LinkedIn
                                        </div>
                                    </div>
                                    <div>
                                        <input type="url" 
                                               class="form-control" 
                                               id="instructorTwitter" 
                                               placeholder="https://twitter.com/username"
                                               style="direction: ltr;">
                                        <div class="form-hint">
                                            <i class="fab fa-twitter"></i> Twitter
                                        </div>
                                    </div>
                                    <div>
                                        <input type="url" 
                                               class="form-control" 
                                               id="instructorWebsite" 
                                               placeholder="https://yourwebsite.com"
                                               style="direction: ltr;">
                                        <div class="form-hint">
                                            <i class="fas fa-globe"></i> الموقع الشخصي
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Learning Objectives -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-bullseye"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">الأهداف التعليمية</h3>
                                    <p class="section-description">ما الذي سيتعلمه الطلاب ويكونوا قادرين على فعله بعد إتمام الدورة؟</p>
                                </div>
                            </div>
                            
                            <div class="objectives-list" id="learningObjectives">
                                <div class="objective-item">
                                    <div class="objective-number">1</div>
                                    <input type="text" 
                                           class="form-control objective-input" 
                                           placeholder="سيتمكن الطالب من..."
                                           maxlength="150">
                                    <i class="fas fa-times objective-remove" onclick="removeObjective(this)" title="حذف هذا الهدف"></i>
                                </div>
                            </div>
                            
                            <button class="btn btn-secondary" onclick="addObjective()">
                                <i class="fas fa-plus"></i> إضافة هدف تعليمي
                            </button>
                            
                            <div class="form-hint" style="margin-top: 1rem;">
                                <i class="fas fa-info-circle"></i>
                                أضف 3-8 أهداف واضحة ومحددة. استخدم كلمات مثل "سيتمكن من"، "سيتعلم"، "سيطبق"
                            </div>
                        </div>

                        <!-- Course Category and Tags -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-tags"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">التصنيف والكلمات المفتاحية</h3>
                                    <p class="section-description">ساعد الطلاب في العثور على دورتك من خلال التصنيفات والكلمات المناسبة</p>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">فئة الدورة</label>
                                <select class="form-control" id="courseCategory">
                                    <option value="">اختر الفئة المناسبة</option>
                                    <option value="personal-development">التطوير الشخصي</option>
                                    <option value="business">الأعمال وريادة الأعمال</option>
                                    <option value="technology">التكنولوجيا والبرمجة</option>
                                    <option value="design">التصميم والإبداع</option>
                                    <option value="marketing">التسويق والمبيعات</option>
                                    <option value="health">الصحة واللياقة</option>
                                    <option value="language">اللغات</option>
                                    <option value="skills">المهارات الحياتية</option>
                                    <option value="religion">الدين والروحانيات</option>
                                    <option value="other">أخرى</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">المستوى المطلوب</label>
                                <select class="form-control" id="courseLevel">
                                    <option value="beginner">مبتدئ</option>
                                    <option value="intermediate">متوسط</option>
                                    <option value="advanced">متقدم</option>
                                    <option value="all-levels">جميع المستويات</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">الكلمات المفتاحية</label>
                                <div class="tags-container" id="tagsContainer" onclick="focusTagInput()">
                                    <input type="text" 
                                           class="tag-input" 
                                           id="tagInput"
                                           placeholder="أضف كلمة مفتاحية واضغط Enter..."
                                           onkeypress="handleTagInput(event)">
                                </div>
                                <div class="form-hint">
                                    <i class="fas fa-hashtag"></i>
                                    أضف كلمات مفتاحية تساعد في البحث (3-10 كلمات). اضغط Enter أو الفاصلة لإضافة كلمة
                                </div>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <div></div>
                            <button class="btn btn-primary" onclick="saveAndNext(1)">
                                حفظ والمتابعة <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>
<!-- Step 2: Enhanced Pricing & Payment -->
                    <div class="step-panel" id="step2">
                        <div class="panel-header">
                            <h1 class="panel-title">التسعير وطرق الدفع</h1>
                            <p class="panel-subtitle">حدد سعر دورتك وطرق الدفع المتاحة للطلاب في مصر والوطن العربي</p>
                        </div>

                        <!-- Pricing Strategy Selection -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">استراتيجية التسعير</h3>
                                    <p class="section-description">اختر كيف تريد تسعير دورتك وإتاحتها للطلاب</p>
                                </div>
                            </div>
                            
                            <div class="pricing-options">
                                <div class="price-option active" onclick="selectPriceType('free')" data-type="free">
                                    <div class="price-option-icon">
                                        <i class="fas fa-gift"></i>
                                    </div>
                                    <div class="price-option-content">
                                        <div class="price-option-name">مجانية تماماً</div>
                                        <div class="price-option-desc">متاحة للجميع بدون أي تكلفة</div>
                                        <ul class="price-option-features">
                                            <li><i class="fas fa-check"></i> وصول غير محدود</li>
                                            <li><i class="fas fa-check"></i> بناء قاعدة جماهيرية</li>
                                            <li><i class="fas fa-check"></i> زيادة الشهرة والانتشار</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="price-option" onclick="selectPriceType('paid')" data-type="paid">
                                    <div class="price-option-icon">
                                        <i class="fas fa-money-bill-wave"></i>
                                    </div>
                                    <div class="price-option-content">
                                        <div class="price-option-name">مدفوعة</div>
                                        <div class="price-option-desc">بسعر محدد ودفع يدوي</div>
                                        <ul class="price-option-features">
                                            <li><i class="fas fa-check"></i> دخل مباشر من الدورة</li>
                                            <li><i class="fas fa-check"></i> طلاب أكثر جدية</li>
                                            <li><i class="fas fa-check"></i> خصومات وعروض</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="price-option" onclick="selectPriceType('donation')" data-type="donation">
                                    <div class="price-option-icon">
                                        <i class="fas fa-heart"></i>
                                    </div>
                                    <div class="price-option-content">
                                        <div class="price-option-name">بالتبرع</div>
                                        <div class="price-option-desc">الطلاب يدفعون ما يستطيعون</div>
                                        <ul class="price-option-features">
                                            <li><i class="fas fa-check"></i> مرونة في الدفع</li>
                                            <li><i class="fas fa-check"></i> إتاحة أوسع</li>
                                            <li><i class="fas fa-check"></i> عمل خيري</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pricing Details -->
                        <div class="form-section" id="pricingDetailsSection" style="display: none;">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-calculator"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">تفاصيل التسعير</h3>
                                    <p class="section-description">حدد الأسعار والعروض الخاصة بدورتك</p>
                                </div>
                            </div>

                            <div class="pricing-grid">
                                <div class="pricing-form">
                                    <div class="form-group">
                                        <label class="form-label required">العملة</label>
                                        <select class="form-control" id="courseCurrency" onchange="updateCurrencySymbol()">
                                            <option value="EGP" data-symbol="ج.م">جنيه مصري (EGP)</option>
                                            <option value="SAR" data-symbol="ر.س">ريال سعودي (SAR)</option>
                                            <option value="AED" data-symbol="د.إ">درهم إماراتي (AED)</option>
                                            <option value="USD" data-symbol="$">دولار أمريكي (USD)</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label required">السعر الأساسي</label>
                                        <div class="currency-input">
                                            <div class="currency-symbol" id="currencySymbol">ج.م</div>
                                            <input type="number" 
                                                   id="coursePrice" 
                                                   placeholder="0.00" 
                                                   step="0.01" 
                                                   min="0"
                                                   oninput="updatePricePreview()">
                                        </div>
                                        <div class="form-hint">
                                            <i class="fas fa-info-circle"></i>
                                            السعر الأساسي للدورة قبل أي خصومات
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">سعر العرض (اختياري)</label>
                                        <div class="currency-input">
                                            <div class="currency-symbol">ج.م</div>
                                            <input type="number" 
                                                   id="courseSalePrice" 
                                                   placeholder="0.00" 
                                                   step="0.01" 
                                                   min="0"
                                                   oninput="updatePricePreview()">
                                        </div>
                                        <div class="form-hint">
                                            <i class="fas fa-percent"></i>
                                            السعر بعد الخصم - اتركه فارغاً إذا لم يكن هناك عرض
                                        </div>
                                    </div>

                                    <!-- Donation Range (for donation type) -->
                                    <div class="form-group" id="donationRange" style="display: none;">
                                        <label class="form-label">نطاق التبرع المقترح</label>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                            <div>
                                                <div class="currency-input">
                                                    <div class="currency-symbol">ج.م</div>
                                                    <input type="number" 
                                                           id="donationMin" 
                                                           placeholder="الحد الأدنى" 
                                                           step="0.01" 
                                                           min="0">
                                                </div>
                                            </div>
                                            <div>
                                                <div class="currency-input">
                                                    <div class="currency-symbol">ج.م</div>
                                                    <input type="number" 
                                                           id="donationMax" 
                                                           placeholder="الحد الأقصى" 
                                                           step="0.01" 
                                                           min="0">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-hint">
                                            <i class="fas fa-heart"></i>
                                            نطاق مقترح للتبرع - الطلاب يمكنهم دفع أي مبلغ ضمن هذا النطاق
                                        </div>
                                    </div>
                                </div>

                                <!-- Price Preview Card -->
                                <div class="price-preview-card">
                                    <div class="preview-header">
                                        <h3>معاينة السعر</h3>
                                        <span class="preview-badge" id="previewBadge">مجاني</span>
                                    </div>
                                    <div class="preview-price-container">
                                        <div class="preview-price" id="previewPrice">مجاني</div>
                                        <div class="preview-currency" id="previewCurrency"></div>
                                        <div class="preview-original" id="previewOriginal" style="display: none;"></div>
                                        <div class="preview-discount" id="previewDiscount" style="display: none;"></div>
                                    </div>
                                    <div class="preview-details">
                                        <div class="preview-item">
                                            <span>النوع:</span>
                                            <span id="previewType">دورة مجانية</span>
                                        </div>
                                        <div class="preview-item">
                                            <span>الوصول:</span>
                                            <span id="previewAccess">فوري</span>
                                        </div>
                                        <div class="preview-item" id="savingsItem" style="display: none;">
                                            <span>الوفر:</span>
                                            <span id="previewSavings" style="color: var(--success);"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Manual Payment Methods -->
                        <div class="form-section" id="paymentMethodsSection" style="display: none;">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-credit-card"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">طرق الدفع المتاحة</h3>
                                    <p class="section-description">اختر طرق الدفع التي تقبلها من الطلاب (دفع يدوي)</p>
                                </div>
                            </div>

                            <div class="payment-methods-grid">
                                <div class="payment-method" onclick="togglePaymentMethod('instapay')">
                                    <div class="payment-method-header">
                                        <div class="payment-method-icon">
                                            <i class="fas fa-mobile-alt"></i>
                                        </div>
                                        <div class="payment-method-info">
                                            <h4>انستاباي</h4>
                                            <p>الدفع السريع عبر الهاتف</p>
                                        </div>
                                        <div class="payment-method-toggle">
                                            <input type="checkbox" id="instapay" checked>
                                            <label for="instapay"></label>
                                        </div>
                                    </div>
                                    <div class="payment-method-details">
                                        <input type="text" 
                                               class="form-control" 
                                               id="instapayNumber" 
                                               placeholder="رقم انستاباي الخاص بك"
                                               style="direction: ltr;">
                                    </div>
                                </div>

                                <div class="payment-method" onclick="togglePaymentMethod('vodafone')">
                                    <div class="payment-method-header">
                                        <div class="payment-method-icon">
                                            <i class="fas fa-sim-card"></i>
                                        </div>
                                        <div class="payment-method-info">
                                            <h4>فودافون كاش</h4>
                                            <p>المحفظة الرقمية</p>
                                        </div>
                                        <div class="payment-method-toggle">
                                            <input type="checkbox" id="vodafone" checked>
                                            <label for="vodafone"></label>
                                        </div>
                                    </div>
                                    <div class="payment-method-details">
                                        <input type="text" 
                                               class="form-control" 
                                               id="vodafoneNumber" 
                                               placeholder="رقم فودافون كاش الخاص بك"
                                               style="direction: ltr;">
                                    </div>
                                </div>

                                <div class="payment-method" onclick="togglePaymentMethod('bank')">
                                    <div class="payment-method-header">
                                        <div class="payment-method-icon">
                                            <i class="fas fa-university"></i>
                                        </div>
                                        <div class="payment-method-info">
                                            <h4>حساب بنكي</h4>
                                            <p>تحويل بنكي مباشر</p>
                                        </div>
                                        <div class="payment-method-toggle">
                                            <input type="checkbox" id="bank">
                                            <label for="bank"></label>
                                        </div>
                                    </div>
                                    <div class="payment-method-details">
                                        <div style="display: grid; gap: 1rem;">
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="bankName" 
                                                   placeholder="اسم البنك">
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="accountNumber" 
                                                   placeholder="رقم الحساب"
                                                   style="direction: ltr;">
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="accountName" 
                                                   placeholder="اسم صاحب الحساب">
                                        </div>
                                    </div>
                                </div>

                                <div class="payment-method" onclick="togglePaymentMethod('western')">
                                    <div class="payment-method-header">
                                        <div class="payment-method-icon">
                                            <i class="fas fa-globe"></i>
                                        </div>
                                        <div class="payment-method-info">
                                            <h4>ويسترن يونيون</h4>
                                            <p>تحويل دولي</p>
                                        </div>
                                        <div class="payment-method-toggle">
                                            <input type="checkbox" id="western">
                                            <label for="western"></label>
                                        </div>
                                    </div>
                                    <div class="payment-method-details">
                                        <div style="display: grid; gap: 1rem;">
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="westernName" 
                                                   placeholder="الاسم الكامل للاستقبال">
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="westernCountry" 
                                                   placeholder="الدولة">
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="westernCity" 
                                                   placeholder="المدينة">
                                        </div>
                                    </div>
                                </div>

                                <div class="payment-method" onclick="togglePaymentMethod('paylink')">
                                    <div class="payment-method-header">
                                        <div class="payment-method-icon">
                                            <i class="fas fa-link"></i>
                                        </div>
                                        <div class="payment-method-info">
                                            <h4>رابط دفع</h4>
                                            <p>رابط دفع إلكتروني (نادراً)</p>
                                        </div>
                                        <div class="payment-method-toggle">
                                            <input type="checkbox" id="paylink">
                                            <label for="paylink"></label>
                                        </div>
                                    </div>
                                    <div class="payment-method-details">
                                        <input type="url" 
                                               class="form-control" 
                                               id="paylinkUrl" 
                                               placeholder="رابط منصة الدفع الإلكتروني"
                                               style="direction: ltr;">
                                    </div>
                                </div>
                            </div>

                            <div class="form-hint" style="margin-top: 1.5rem;">
                                <i class="fas fa-info-circle"></i>
                                سيتم عرض طرق الدفع المفعلة للطلاب عند التسجيل، وسيقومون بالدفع ثم إرسال إشعار عبر الواتساب
                            </div>
                        </div>

                        <!-- Discount Coupons -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-ticket-alt"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">كوبونات الخصم</h3>
                                    <p class="section-description">أنشئ كوبونات خصم لجذب المزيد من الطلاب أو تشجيع التسجيل المبكر</p>
                                </div>
                            </div>
                            
                            <div class="coupon-list" id="couponList">
                                <!-- Coupons will be added here dynamically -->
                            </div>
                            
                            <button class="btn btn-secondary" onclick="addCoupon()">
                                <i class="fas fa-plus"></i> إنشاء كوبون خصم
                            </button>
                        </div>

                        <!-- Access Settings -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-users-cog"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">إعدادات الوصول</h3>
                                    <p class="section-description">تحكم في من يمكنه الالتحاق بالدورة ومتى</p>
                                </div>
                            </div>
                            
                            <div class="access-settings-grid">
                                <div class="form-group">
                                    <label class="form-label">الحد الأقصى للطلاب</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="maxStudents" 
                                           placeholder="غير محدود" 
                                           min="1">
                                    <div class="form-hint">
                                        <i class="fas fa-users"></i>
                                        اتركه فارغاً لعدد غير محدود من الطلاب
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">تاريخ بداية التسجيل</label>
                                    <input type="date" 
                                           class="form-control" 
                                           id="enrollmentStartDate">
                                    <div class="form-hint">
                                        <i class="fas fa-calendar-plus"></i>
                                        متى يمكن للطلاب البدء في التسجيل
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">تاريخ انتهاء التسجيل</label>
                                    <input type="date" 
                                           class="form-control" 
                                           id="enrollmentEndDate">
                                    <div class="form-hint">
                                        <i class="fas fa-calendar-times"></i>
                                        آخر موعد للتسجيل - اتركه فارغاً للتسجيل المفتوح
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">تاريخ بداية الدورة</label>
                                    <input type="date" 
                                           class="form-control" 
                                           id="courseStartDate">
                                    <div class="form-hint">
                                        <i class="fas fa-play-circle"></i>
                                        متى تبدأ الدورة فعلياً للطلاب
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">مدة الوصول للدورة</label>
                                    <select class="form-control" id="accessDuration">
                                        <option value="lifetime">وصول دائم (مدى الحياة)</option>
                                        <option value="1year">سنة واحدة</option>
                                        <option value="6months">6 أشهر</option>
                                        <option value="3months">3 أشهر</option>
                                        <option value="1month">شهر واحد</option>
                                        <option value="custom">مدة مخصصة</option>
                                    </select>
                                </div>

                                <div class="form-group" id="customDurationGroup" style="display: none;">
                                    <label class="form-label">المدة المخصصة (بالأيام)</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="customDuration" 
                                           placeholder="عدد الأيام" 
                                           min="1">
                                </div>
                            </div>

                            <!-- Access Requirements -->
                            <div class="access-requirements">
                                <h4 style="margin: 2rem 0 1rem 0; color: var(--primary);">متطلبات الالتحاق</h4>
                                
                                <div class="toggle-group">
                                    <div class="toggle-info">
                                        <div class="toggle-title">مراجعة يدوية للطلبات</div>
                                        <div class="toggle-description">يتطلب موافقتك قبل قبول الطالب في الدورة</div>
                                    </div>
                                    <div class="toggle-switch" onclick="toggleSwitch(this)" data-field="requireApproval">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>

                                <div class="toggle-group">
                                    <div class="toggle-info">
                                        <div class="toggle-title">استمارة تقديم إضافية</div>
                                        <div class="toggle-description">الطلاب يملأون استمارة قبل التسجيل</div>
                                    </div>
                                    <div class="toggle-switch" onclick="toggleSwitch(this)" data-field="requireApplication">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- WhatsApp Integration -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fab fa-whatsapp"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">إعدادات الواتساب</h3>
                                    <p class="section-description">ربط الدورة بالواتساب لاستقبال إشعارات الدفع والتواصل مع الطلاب</p>
                                </div>
                            </div>

                            <div class="whatsapp-settings">
                                <div class="form-group">
                                    <label class="form-label required">رقم الواتساب لاستقبال الإشعارات</label>
                                    <input type="tel" 
                                           class="form-control" 
                                           id="whatsappNumber" 
                                           placeholder="+201234567890"
                                           style="direction: ltr;">
                                    <div class="form-hint">
                                        <i class="fab fa-whatsapp"></i>
                                        رقم الواتساب الذي سيستقبل إشعارات الدفع وطلبات التسجيل
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">رابط مجموعة الواتساب (اختياري)</label>
                                    <input type="url" 
                                           class="form-control" 
                                           id="whatsappGroupLink" 
                                           placeholder="https://chat.whatsapp.com/..."
                                           style="direction: ltr;">
                                    <div class="form-hint">
                                        <i class="fas fa-users"></i>
                                        رابط مجموعة الواتساب الخاصة بطلاب الدورة
                                    </div>
                                </div>

                                <div class="toggle-group">
                                    <div class="toggle-info">
                                        <div class="toggle-title">إرسال رسالة ترحيب تلقائية</div>
                                        <div class="toggle-description">إرسال رسالة ترحيب للطلاب عند التسجيل</div>
                                    </div>
                                    <div class="toggle-switch active" onclick="toggleSwitch(this)" data-field="autoWelcomeMessage">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>

                                <div class="form-group" id="welcomeMessageGroup">
                                    <label class="form-label">نص رسالة الترحيب</label>
                                    <textarea class="form-control" 
                                              id="welcomeMessage" 
                                              rows="4" 
                                              placeholder="مرحباً {student_name}! أهلاً بك في دورة {course_name}..."
                                              maxlength="500">مرحباً {student_name}! 🎉

أهلاً وسهلاً بك في دورة "{course_name}"

تم تأكيد تسجيلك بنجاح. ستحصل على رابط الوصول للدورة قريباً.

إذا كان لديك أي استفسار، لا تتردد في التواصل معنا.

مع أطيب التحيات ❤️</textarea>
                                    <div class="form-hint">
                                        <i class="fas fa-magic"></i>
                                        <span id="welcomeMessageCount">0</span>/500 حرف. استخدم {student_name} و {course_name} كمتغيرات
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <button class="btn btn-secondary" onclick="showStep(1)">
                                <i class="fas fa-arrow-right"></i> السابق
                            </button>
                            <button class="btn btn-primary" onclick="saveAndNext(2)">
                                حفظ والمتابعة <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>
<!-- Step 3: Enhanced Curriculum Builder -->
                    <div class="step-panel" id="step3">
                        <div class="panel-header">
                            <h1 class="panel-title">بناء منهج الدورة</h1>
                            <p class="panel-subtitle">قسّم المحتوى إلى وحدات ودروس منظمة مع إمكانية التحكم في التدرج والإطلاق المتسلسل</p>
                        </div>

                        <!-- Curriculum Overview -->
                        <div class="curriculum-overview">
                            <div class="overview-stats">
                                <div class="stat-card">
                                    <div class="stat-icon">
                                        <i class="fas fa-folder"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div class="stat-value" id="modulesCount">0</div>
                                        <div class="stat-label">وحدات</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">
                                        <i class="fas fa-play-circle"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div class="stat-value" id="lessonsCount">0</div>
                                        <div class="stat-label">دروس</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div class="stat-value" id="totalDuration">0</div>
                                        <div class="stat-label">دقيقة</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">
                                        <i class="fas fa-trophy"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div class="stat-value" id="certificateModules">0</div>
                                        <div class="stat-label">وحدة للشهادة</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Content Release Strategy -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-strategy"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">استراتيجية إطلاق المحتوى</h3>
                                    <p class="section-description">حدد كيف ومتى سيتم إطلاق محتوى الدورة للطلاب</p>
                                </div>
                            </div>

                            <div class="release-strategy-grid">
                                <div class="strategy-card selected" onclick="selectReleaseStrategy(this, 'all')" data-strategy="all">
                                    <div class="strategy-icon">
                                        <i class="fas fa-unlock"></i>
                                    </div>
                                    <h4>وصول كامل فوري</h4>
                                    <p>كل المحتوى متاح للطلاب فور التسجيل</p>
                                    <ul>
                                        <li>حرية كاملة للطالب</li>
                                        <li>تعلم بالسرعة المناسبة</li>
                                        <li>مناسب للطلاب المتقدمين</li>
                                    </ul>
                                </div>

                                <div class="strategy-card" onclick="selectReleaseStrategy(this, 'sequential')" data-strategy="sequential">
                                    <div class="strategy-icon">
                                        <i class="fas fa-list-ol"></i>
                                    </div>
                                    <h4>تسلسلي بناءً على التقدم</h4>
                                    <p>فتح الوحدات عند إكمال السابقة</p>
                                    <ul>
                                        <li>ضمان التعلم المتدرج</li>
                                        <li>تحفيز الإكمال</li>
                                        <li>تنظيم رحلة التعلم</li>
                                    </ul>
                                </div>

                                <div class="strategy-card" onclick="selectReleaseStrategy(this, 'scheduled')" data-strategy="scheduled">
                                    <div class="strategy-icon">
                                        <i class="fas fa-calendar-alt"></i>
                                    </div>
                                    <h4>جدولة زمنية</h4>
                                    <p>إطلاق المحتوى في مواعيد محددة</p>
                                    <ul>
                                        <li>تعلم جماعي منظم</li>
                                        <li>مواعيد ثابتة</li>
                                        <li>زيادة التفاعل</li>
                                    </ul>
                                </div>

                                <div class="strategy-card" onclick="selectReleaseStrategy(this, 'hybrid')" data-strategy="hybrid">
                                    <div class="strategy-icon">
                                        <i class="fas fa-cogs"></i>
                                    </div>
                                    <h4>مختلط (متقدم)</h4>
                                    <p>دمج الجدولة مع شروط التقدم</p>
                                    <ul>
                                        <li>مرونة عالية</li>
                                        <li>تحكم متقدم</li>
                                        <li>تخصيص لكل وحدة</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Release Settings -->
                            <div class="release-settings" id="releaseSettings" style="display: none;">
                                <h4 style="margin: 2rem 0 1rem 0; color: var(--primary);">إعدادات الإطلاق</h4>
                                
                                <div class="settings-grid">
                                    <div class="form-group" id="completionThresholdGroup" style="display: none;">
                                        <label class="form-label">نسبة الإكمال المطلوبة</label>
                                        <div class="slider-container">
                                            <input type="range" 
                                                   class="form-range" 
                                                   id="completionThreshold" 
                                                   min="50" 
                                                   max="100" 
                                                   value="80"
                                                   oninput="updateSliderValue(this, 'thresholdValue')">
                                            <div class="slider-value">
                                                <span id="thresholdValue">80</span>%
                                            </div>
                                        </div>
                                        <div class="form-hint">
                                            <i class="fas fa-percentage"></i>
                                            النسبة المطلوبة لإكمال الوحدة قبل فتح التالية
                                        </div>
                                    </div>

                                    <div class="form-group" id="releaseIntervalGroup" style="display: none;">
                                        <label class="form-label">فترة الإطلاق</label>
                                        <select class="form-control" id="releaseInterval">
                                            <option value="daily">يومياً</option>
                                            <option value="weekly" selected>أسبوعياً</option>
                                            <option value="biweekly">كل أسبوعين</option>
                                            <option value="monthly">شهرياً</option>
                                            <option value="custom">مخصص</option>
                                        </select>
                                    </div>

                                    <div class="form-group" id="customIntervalGroup" style="display: none;">
                                        <label class="form-label">الفترة المخصصة (بالأيام)</label>
                                        <input type="number" 
                                               class="form-control" 
                                               id="customInterval" 
                                               min="1" 
                                               placeholder="عدد الأيام">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Curriculum Builder -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-sitemap"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">هيكل المنهج</h3>
                                    <p class="section-description">قم ببناء وتنظيم محتوى دورتك في وحدات ودروس</p>
                                </div>
                            </div>

                            <div class="curriculum-builder">
                                <!-- Curriculum Toolbar -->
                                <div class="curriculum-toolbar">
                                    <div class="toolbar-section">
                                        <button class="btn btn-primary" onclick="addModule()">
                                            <i class="fas fa-folder-plus"></i>
                                            إضافة وحدة
                                        </button>
                                        <button class="btn btn-secondary" onclick="importContent()">
                                            <i class="fas fa-file-import"></i>
                                            استيراد محتوى
                                        </button>
                                    </div>
                                    <div class="toolbar-section">
                                        <div class="view-toggle">
                                            <button class="view-btn active" onclick="switchView('detailed')" data-view="detailed">
                                                <i class="fas fa-list"></i>
                                                مفصل
                                            </button>
                                            <button class="view-btn" onclick="switchView('compact')" data-view="compact">
                                                <i class="fas fa-th-list"></i>
                                                مضغوط
                                            </button>
                                        </div>
                                        <div class="bulk-actions" id="bulkActions" style="display: none;">
                                            <span class="bulk-count">0 محدد</span>
                                            <button class="icon-btn" onclick="bulkAction('move')" title="نقل">
                                                <i class="fas fa-arrows-alt"></i>
                                            </button>
                                            <button class="icon-btn" onclick="bulkAction('duplicate')" title="نسخ">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <button class="icon-btn danger" onclick="bulkAction('delete')" title="حذف">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Modules List -->
                                <div class="modules-list" id="modulesList">
                                    <!-- Modules will be rendered here -->
                                </div>

                                <!-- Empty State -->
                                <div class="empty-state" id="emptyState">
                                    <div class="empty-icon">
                                        <i class="fas fa-graduation-cap"></i>
                                    </div>
                                    <h3>ابدأ ببناء منهج دورتك</h3>
                                    <p>قم بإضافة الوحدة الأولى لتنظيم محتوى دورتك</p>
                                    <button class="btn btn-primary" onclick="addModule()">
                                        <i class="fas fa-plus"></i>
                                        إضافة الوحدة الأولى
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Content Templates -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-templates"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">قوالب المحتوى الجاهزة</h3>
                                    <p class="section-description">استخدم قوالب جاهزة لإنشاء محتوى احترافي بسرعة</p>
                                </div>
                            </div>

                            <div class="content-templates">
                                <div class="template-card" onclick="useTemplate('introduction')">
                                    <div class="template-icon">
                                        <i class="fas fa-handshake"></i>
                                    </div>
                                    <h4>وحدة ترحيبية</h4>
                                    <p>مقدمة للدورة والترحيب بالطلاب</p>
                                    <div class="template-content">
                                        • مرحباً بك في الدورة<br>
                                        • نظرة عامة على المحتوى<br>
                                        • كيفية تحقيق أقصى استفادة
                                    </div>
                                </div>

                                <div class="template-card" onclick="useTemplate('theory-practice')">
                                    <div class="template-icon">
                                        <i class="fas fa-balance-scale"></i>
                                    </div>
                                    <h4>نظري + تطبيقي</h4>
                                    <p>وحدة متوازنة بين النظرية والتطبيق</p>
                                    <div class="template-content">
                                        • محاضرة نظرية<br>
                                        • أمثلة عملية<br>
                                        • تمارين تطبيقية<br>
                                        • اختبار تقييمي
                                    </div>
                                </div>

                                <div class="template-card" onclick="useTemplate('case-study')">
                                    <div class="template-icon">
                                        <i class="fas fa-search"></i>
                                    </div>
                                    <h4>دراسة حالة</h4>
                                    <p>تحليل حالة عملية مفصلة</p>
                                    <div class="template-content">
                                        • عرض الحالة<br>
                                        • تحليل المشكلة<br>
                                        • الحلول المقترحة<br>
                                        • النتائج والدروس
                                    </div>
                                </div>

                                <div class="template-card" onclick="useTemplate('workshop')">
                                    <div class="template-icon">
                                        <i class="fas fa-tools"></i>
                                    </div>
                                    <h4>ورشة عمل</h4>
                                    <p>ورشة تفاعلية مع مشاريع عملية</p>
                                    <div class="template-content">
                                        • شرح الأدوات<br>
                                        • مشروع عملي<br>
                                        • متابعة التقدم<br>
                                        • عرض النتائج
                                    </div>
                                </div>

                                <div class="template-card" onclick="useTemplate('assessment')">
                                    <div class="template-icon">
                                        <i class="fas fa-clipboard-check"></i>
                                    </div>
                                    <h4>وحدة تقييم</h4>
                                    <p>اختبارات ومهام تقييمية شاملة</p>
                                    <div class="template-content">
                                        • مراجعة عامة<br>
                                        • اختبار نهائي<br>
                                        • مشروع تطبيقي<br>
                                        • تقييم الأداء
                                    </div>
                                </div>

                                <div class="template-card" onclick="useTemplate('conclusion')">
                                    <div class="template-icon">
                                        <i class="fas fa-flag-checkered"></i>
                                    </div>
                                    <h4>وحدة ختامية</h4>
                                    <p>خلاصة الدورة والخطوات التالية</p>
                                    <div class="template-content">
                                        • ملخص المحتوى<br>
                                        • الإنجازات المحققة<br>
                                        • الخطوات التالية<br>
                                        • مصادر إضافية
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Prerequisites and Requirements -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-list-check"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">المتطلبات والمؤهلات</h3>
                                    <p class="section-description">حدد ما يحتاجه الطلاب قبل البدء في الدورة</p>
                                </div>
                            </div>

                            <div class="requirements-grid">
                                <div class="requirement-section">
                                    <h4>المتطلبات المسبقة</h4>
                                    <div class="requirements-list" id="prerequisitesList">
                                        <div class="requirement-item">
                                            <input type="text" 
                                                   class="form-control requirement-input" 
                                                   placeholder="مثال: معرفة أساسية بالحاسوب">
                                            <button class="icon-btn danger" onclick="removeRequirement(this)">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <button class="btn btn-secondary btn-sm" onclick="addRequirement('prerequisites')">
                                        <i class="fas fa-plus"></i>
                                        إضافة متطلب
                                    </button>
                                </div>

                                <div class="requirement-section">
                                    <h4>الأدوات المطلوبة</h4>
                                    <div class="requirements-list" id="toolsList">
                                        <div class="requirement-item">
                                            <input type="text" 
                                                   class="form-control requirement-input" 
                                                   placeholder="مثال: حاسوب أو هاتف ذكي">
                                            <button class="icon-btn danger" onclick="removeRequirement(this)">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <button class="btn btn-secondary btn-sm" onclick="addRequirement('tools')">
                                        <i class="fas fa-plus"></i>
                                        إضافة أداة
                                    </button>
                                </div>

                                <div class="requirement-section">
                                    <h4>المواد التكميلية</h4>
                                    <div class="requirements-list" id="materialsList">
                                        <div class="requirement-item">
                                            <input type="text" 
                                                   class="form-control requirement-input" 
                                                   placeholder="مثال: دفتر ملاحظات">
                                            <button class="icon-btn danger" onclick="removeRequirement(this)">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <button class="btn btn-secondary btn-sm" onclick="addRequirement('materials')">
                                        <i class="fas fa-plus"></i>
                                        إضافة مادة
                                    </button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">مستوى الصعوبة الإجمالي</label>
                                <div class="difficulty-selector">
                                    <div class="difficulty-option active" onclick="selectDifficulty(this, 'beginner')" data-level="beginner">
                                        <div class="difficulty-icon">
                                            <i class="fas fa-seedling"></i>
                                        </div>
                                        <div class="difficulty-info">
                                            <h5>مبتدئ</h5>
                                            <p>لا يتطلب خبرة مسبقة</p>
                                        </div>
                                    </div>
                                    <div class="difficulty-option" onclick="selectDifficulty(this, 'intermediate')" data-level="intermediate">
                                        <div class="difficulty-icon">
                                            <i class="fas fa-chart-line"></i>
                                        </div>
                                        <div class="difficulty-info">
                                            <h5>متوسط</h5>
                                            <p>يتطلب معرفة أساسية</p>
                                        </div>
                                    </div>
                                    <div class="difficulty-option" onclick="selectDifficulty(this, 'advanced')" data-level="advanced">
                                        <div class="difficulty-icon">
                                            <i class="fas fa-rocket"></i>
                                        </div>
                                        <div class="difficulty-info">
                                            <h5>متقدم</h5>
                                            <p>للخبراء والمتخصصين</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <button class="btn btn-secondary" onclick="showStep(2)">
                                <i class="fas fa-arrow-right"></i> السابق
                            </button>
                            <button class="btn btn-primary" onclick="saveAndNext(3)">
                                حفظ والمتابعة <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>

                    <!-- CSS for Enhanced Curriculum -->
                    <style>
                        /* Curriculum Overview */
                        .curriculum-overview {
                            margin-bottom: 2rem;
                        }

                        .overview-stats {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 1.5rem;
                            margin-bottom: 2rem;
                        }

                        .stat-card {
                            background: var(--gradient-dark);
                            padding: 2rem;
                            border-radius: var(--radius);
                            border: 1px solid var(--border);
                            display: flex;
                            align-items: center;
                            gap: 1.5rem;
                            transition: var(--transition);
                        }

                        .stat-card:hover {
                            border-color: var(--primary);
                            transform: translateY(-2px);
                        }

                        .stat-icon {
                            width: 60px;
                            height: 60px;
                            background: rgba(244, 196, 48, 0.1);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: var(--primary);
                            font-size: 1.5rem;
                        }

                        .stat-value {
                            font-size: 2rem;
                            font-weight: 700;
                            color: var(--primary);
                            margin-bottom: 0.3rem;
                        }

                        .stat-label {
                            color: var(--text-muted);
                            font-size: 0.9rem;
                        }

                        /* Release Strategy */
                        .release-strategy-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                            gap: 1.5rem;
                            margin-bottom: 2rem;
                        }

                        .strategy-card {
                            background: var(--lighter);
                            padding: 2rem;
                            border-radius: var(--radius);
                            border: 2px solid var(--border);
                            cursor: pointer;
                            transition: var(--transition);
                            text-align: center;
                        }

                        .strategy-card:hover {
                            border-color: var(--primary);
                            transform: translateY(-2px);
                        }

                        .strategy-card.selected {
                            border-color: var(--primary);
                            background: var(--gradient-overlay);
                        }

                        .strategy-icon {
                            width: 60px;
                            height: 60px;
                            background: rgba(244, 196, 48, 0.1);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: var(--primary);
                            font-size: 1.5rem;
                            margin: 0 auto 1rem;
                        }

                        .strategy-card h4 {
                            font-size: 1.2rem;
                            margin-bottom: 0.8rem;
                            color: var(--text);
                        }

                        .strategy-card p {
                            color: var(--text-muted);
                            margin-bottom: 1rem;
                            line-height: 1.5;
                        }

                        .strategy-card ul {
                            list-style: none;
                            padding: 0;
                            text-align: right;
                        }

                        .strategy-card ul li {
                            color: var(--text-muted);
                            font-size: 0.9rem;
                            margin-bottom: 0.5rem;
                            padding-right: 1rem;
                            position: relative;
                        }

                        .strategy-card ul li::before {
                            content: '✓';
                            position: absolute;
                            right: 0;
                            color: var(--success);
                            font-weight: bold;
                        }

                        /* Curriculum Builder */
                        .curriculum-builder {
                            background: var(--lighter);
                            border-radius: var(--radius);
                            padding: 2rem;
                            border: 1px solid var(--border);
                        }

                        .curriculum-toolbar {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 2rem;
                            padding-bottom: 1rem;
                            border-bottom: 1px solid var(--border);
                        }

                        .toolbar-section {
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                        }

                        .view-toggle {
                            display: flex;
                            background: var(--dark);
                            border-radius: 8px;
                            overflow: hidden;
                        }

                        .view-btn {
                            padding: 0.7rem 1rem;
                            background: transparent;
                            border: none;
                            color: var(--text-muted);
                            cursor: pointer;
                            transition: var(--transition);
                            font-family: inherit;
                        }

                        .view-btn.active {
                            background: var(--primary);
                            color: var(--dark);
                        }

                        .bulk-actions {
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                            padding: 0.5rem 1rem;
                            background: rgba(244, 196, 48, 0.1);
                            border-radius: 8px;
                            border: 1px solid var(--primary);
                        }

                        .bulk-count {
                            font-size: 0.9rem;
                            color: var(--primary);
                            font-weight: 600;
                        }

                        /* Empty State */
                        .empty-state {
                            text-align: center;
                            padding: 4rem 2rem;
                            color: var(--text-muted);
                        }

                        .empty-icon {
                            font-size: 4rem;
                            color: var(--lighter);
                            margin-bottom: 2rem;
                        }

                        .empty-state h3 {
                            color: var(--text);
                            margin-bottom: 1rem;
                        }

                        .empty-state p {
                            margin-bottom: 2rem;
                            line-height: 1.6;
                        }

                        /* Content Templates */
                        .content-templates {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                            gap: 1.5rem;
                        }

                        .template-card {
                            background: var(--lighter);
                            padding: 2rem;
                            border-radius: var(--radius);
                            border: 1px solid var(--border);
                            cursor: pointer;
                            transition: var(--transition);
                            text-align: center;
                        }

                        .template-card:hover {
                            border-color: var(--primary);
                            transform: translateY(-2px);
                            box-shadow: var(--shadow-light);
                        }

                        .template-icon {
                            width: 60px;
                            height: 60px;
                            background: rgba(244, 196, 48, 0.1);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: var(--primary);
                            font-size: 1.5rem;
                            margin: 0 auto 1rem;
                        }

                        .template-card h4 {
                            margin-bottom: 0.8rem;
                            color: var(--text);
                        }

                        .template-card p {
                            color: var(--text-muted);
                            margin-bottom: 1rem;
                            line-height: 1.5;
                        }

                        .template-content {
                            background: var(--dark);
                            padding: 1rem;
                            border-radius: 8px;
                            font-size: 0.85rem;
                            color: var(--text-muted);
                            line-height: 1.6;
                            text-align: right;
                        }

                        /* Requirements Grid */
                        .requirements-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                            gap: 2rem;
                            margin-bottom: 2rem;
                        }

                        .requirement-section h4 {
                            color: var(--primary);
                            margin-bottom: 1rem;
                            font-size: 1.1rem;
                        }

                        .requirements-list {
                            margin-bottom: 1rem;
                        }

                        .requirement-item {
                            display: flex;
                            gap: 0.5rem;
                            margin-bottom: 0.8rem;
                        }

                        .requirement-input {
                            flex: 1;
                        }

                        /* Difficulty Selector */
                        .difficulty-selector {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 1rem;
                        }

                        .difficulty-option {
                            background: var(--lighter);
                            padding: 1.5rem;
                            border-radius: var(--radius);
                            border: 2px solid var(--border);
                            cursor: pointer;
                            transition: var(--transition);
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                        }

                        .difficulty-option:hover {
                            border-color: var(--primary);
                        }

                        .difficulty-option.active {
                            border-color: var(--primary);
                            background: var(--gradient-overlay);
                        }

                        .difficulty-icon {
                            width: 50px;
                            height: 50px;
                            background: rgba(244, 196, 48, 0.1);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: var(--primary);
                            font-size: 1.2rem;
                        }

                        .difficulty-info h5 {
                            margin-bottom: 0.3rem;
                            color: var(--text);
                        }

                        .difficulty-info p {
                            color: var(--text-muted);
                            font-size: 0.9rem;
                            margin: 0;
                        }

                        /* Slider Styling */
                        .slider-container {
                            position: relative;
                            margin: 1rem 0;
                        }

                        .form-range {
                            width: 100%;
                            height: 8px;
                            background: var(--lighter);
                            border-radius: 4px;
                            outline: none;
                            -webkit-appearance: none;
                        }

                        .form-range::-webkit-slider-thumb {
                            appearance: none;
                            width: 20px;
                            height: 20px;
                            background: var(--primary);
                            border-radius: 50%;
                            cursor: pointer;
                        }

                        .form-range::-moz-range-thumb {
                            width: 20px;
                            height: 20px;
                            background: var(--primary);
                            border-radius: 50%;
                            cursor: pointer;
                            border: none;
                        }

                        .slider-value {
                            text-align: center;
                            margin-top: 0.5rem;
                            font-weight: 600;
                            color: var(--primary);
                        }

                        /* Tags Container */
                        .tags-container {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 0.5rem;
                            min-height: 50px;
                            padding: 0.8rem;
                            background: var(--lighter);
                            border: 2px solid var(--border);
                            border-radius: 10px;
                            cursor: text;
                            transition: var(--transition);
                        }

                        .tags-container:focus-within {
                            border-color: var(--primary);
                            box-shadow: 0 0 0 3px rgba(244, 196, 48, 0.1);
                        }

                        .tag {
                            background: var(--primary);
                            color: var(--dark);
                            padding: 0.4rem 0.8rem;
                            border-radius: 20px;
                            font-size: 0.85rem;
                            font-weight: 500;
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                            animation: fadeIn 0.2s ease-out;
                        }

                        .tag-remove {
                            cursor: pointer;
                            font-size: 0.8rem;
                            opacity: 0.8;
                            width: 16px;
                            height: 16px;
                            background: rgba(0, 0, 0, 0.2);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: var(--transition);
                        }

                        .tag-remove:hover {
                            opacity: 1;
                            background: rgba(0, 0, 0, 0.3);
                        }

                        .tag-input {
                            flex: 1;
                            min-width: 120px;
                            border: none;
                            background: transparent;
                            color: var(--text);
                            font-family: inherit;
                            padding: 0.4rem;
                            outline: none;
                        }

                        .tag-input::placeholder {
                            color: var(--text-muted);
                        }

                        /* Responsive adjustments */
                        @media (max-width: 768px) {
                            .curriculum-toolbar {
                                flex-direction: column;
                                gap: 1rem;
                            }
                            
                            .overview-stats {
                                grid-template-columns: repeat(2, 1fr);
                            }
                            
                            .release-strategy-grid {
                                grid-template-columns: 1fr;
                            }
                            
                            .requirements-grid {
                                grid-template-columns: 1fr;
                            }
                        }
                    </style>
<!-- Step 4: Enhanced Student Settings & Experience -->
                    <div class="step-panel" id="step4">
                        <div class="panel-header">
                            <h1 class="panel-title">إعدادات تجربة الطالب</h1>
                            <p class="panel-subtitle">صمم تجربة تعليمية متكاملة تشمل الشهادات، التقدم، التفاعل، والدعم عبر الواتساب</p>
                        </div>

                        <!-- Student Journey Overview -->
                        <div class="student-journey-overview">
                            <div class="journey-steps">
                                <div class="journey-step">
                                    <div class="step-icon">
                                        <i class="fas fa-user-plus"></i>
                                    </div>
                                    <h4>التسجيل</h4>
                                    <p>دفع وتأكيد عبر الواتساب</p>
                                </div>
                                <div class="journey-arrow">
                                    <i class="fas fa-arrow-left"></i>
                                </div>
                                <div class="journey-step">
                                    <div class="step-icon">
                                        <i class="fas fa-door-open"></i>
                                    </div>
                                    <h4>الدخول</h4>
                                    <p>استقبال رابط الوصول</p>
                                </div>
                                <div class="journey-arrow">
                                    <i class="fas fa-arrow-left"></i>
                                </div>
                                <div class="journey-step">
                                    <div class="step-icon">
                                        <i class="fas fa-play"></i>
                                    </div>
                                    <h4>التعلم</h4>
                                    <p>تتبع التقدم والتفاعل</p>
                                </div>
                                <div class="journey-arrow">
                                    <i class="fas fa-arrow-left"></i>
                                </div>
                                <div class="journey-step">
                                    <div class="step-icon">
                                        <i class="fas fa-certificate"></i>
                                    </div>
                                    <h4>الإنجاز</h4>
                                    <p>الحصول على الشهادة</p>
                                </div>
                            </div>
                        </div>

                        <!-- Certificates Management -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-award"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">إدارة الشهادات</h3>
                                    <p class="section-description">صمم شهادات الإكمال وحدد متطلبات الحصول عليها</p>
                                </div>
                            </div>

                            <div class="certificates-grid">
                                <div class="certificate-settings">
                                    <div class="toggle-group">
                                        <div class="toggle-info">
                                            <div class="toggle-title">منح شهادة عند إتمام الدورة</div>
                                            <div class="toggle-description">الطلاب يحصلون على شهادة رسمية عند الإكمال</div>
                                        </div>
                                        <div class="toggle-switch active" onclick="toggleSwitch(this)" data-field="certificateEnabled">
                                            <div class="toggle-slider"></div>
                                        </div>
                                    </div>

                                    <div class="form-group" id="certificateDetailsGroup">
                                        <label class="form-label">نسبة الإكمال المطلوبة للشهادة</label>
                                        <div class="slider-container">
                                            <input type="range" 
                                                   class="form-range" 
                                                   id="certificateThreshold" 
                                                   min="50" 
                                                   max="100" 
                                                   value="80"
                                                   oninput="updateSliderValue(this, 'certificateThresholdValue')">
                                            <div class="slider-value">
                                                <span id="certificateThresholdValue">80</span>%
                                            </div>
                                        </div>
                                        <div class="form-hint">
                                            <i class="fas fa-percentage"></i>
                                            النسبة المئوية المطلوبة من إجمالي الدورة للحصول على الشهادة
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">نص الشهادة</label>
                                        <textarea class="form-control" 
                                                  id="certificateText" 
                                                  rows="4" 
                                                  placeholder="نص يظهر على الشهادة..."
                                                  maxlength="300">يُشهد بأن الطالب/ة {student_name} قد أكمل/ت بنجاح دورة "{course_name}" من منظور الفؤاد بتاريخ {completion_date}

نتقدم بأسمى آيات التهنئة والتبريك لهذا الإنجاز الرائع</textarea>
                                        <div class="form-hint">
                                            <i class="fas fa-magic"></i>
                                            <span id="certificateTextCount">0</span>/300 حرف. استخدم {student_name}، {course_name}، {completion_date} كمتغيرات
                                        </div>
                                    </div>

                                    <div class="certificate-requirements">
                                        <h4>متطلبات إضافية للشهادة</h4>
                                        <div class="requirements-checklist">
                                            <div class="requirement-option">
                                                <input type="checkbox" id="requireQuizzes" class="requirement-checkbox">
                                                <label for="requireQuizzes">اجتياز جميع الاختبارات</label>
                                            </div>
                                            <div class="requirement-option">
                                                <input type="checkbox" id="requireAssignments" class="requirement-checkbox">
                                                <label for="requireAssignments">تسليم جميع المهام</label>
                                            </div>
                                            <div class="requirement-option">
                                                <input type="checkbox" id="requireParticipation" class="requirement-checkbox">
                                                <label for="requireParticipation">المشاركة في المناقشات</label>
                                            </div>
                                            <div class="requirement-option">
                                                <input type="checkbox" id="requireFinalProject" class="requirement-checkbox">
                                                <label for="requireFinalProject">تقديم مشروع نهائي</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Certificate Preview -->
                                <div class="certificate-preview">
                                    <div class="certificate-card">
                                        <div class="certificate-header">
                                            <div class="certificate-logo">
                                                <i class="fas fa-award"></i>
                                            </div>
                                            <h3>شهادة إتمام</h3>
                                            <div class="certificate-subtitle">منظور الفؤاد</div>
                                        </div>
                                        <div class="certificate-body">
                                            <div class="certificate-text-preview" id="certificateTextPreview">
                                                يُشهد بأن الطالب/ة <strong>أحمد محمد</strong> قد أكمل/ت بنجاح دورة "<strong>رحلة اكتشاف الذات</strong>" من منظور الفؤاد بتاريخ <strong>25 ديسمبر 2024</strong>
                                            </div>
                                        </div>
                                        <div class="certificate-footer">
                                            <div class="certificate-signature">
                                                <div class="signature-line"></div>
                                                <div class="signature-name">المدرب</div>
                                            </div>
                                            <div class="certificate-seal">
                                                <i class="fas fa-certificate"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn btn-secondary btn-sm" onclick="customizeCertificate()">
                                        <i class="fas fa-palette"></i>
                                        تخصيص التصميم
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Tracking Settings -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">تتبع التقدم والإنجاز</h3>
                                    <p class="section-description">حدد كيف يتم قياس وعرض تقدم الطلاب في الدورة</p>
                                </div>
                            </div>

                            <div class="progress-settings-grid">
                                <div class="progress-method-section">
                                    <h4>طريقة قياس التقدم</h4>
                                    <div class="progress-methods">
                                        <div class="method-option active" onclick="selectProgressMethod(this, 'lessons')" data-method="lessons">
                                            <div class="method-icon">
                                                <i class="fas fa-list-check"></i>
                                            </div>
                                            <div class="method-info">
                                                <h5>بناءً على الدروس</h5>
                                                <p>نسبة الدروس المكتملة</p>
                                            </div>
                                        </div>
                                        <div class="method-option" onclick="selectProgressMethod(this, 'time')" data-method="time">
                                            <div class="method-icon">
                                                <i class="fas fa-clock"></i>
                                            </div>
                                            <div class="method-info">
                                                <h5>بناءً على الوقت</h5>
                                                <p>وقت المشاهدة الفعلي</p>
                                            </div>
                                        </div>
                                        <div class="method-option" onclick="selectProgressMethod(this, 'activities')" data-method="activities">
                                            <div class="method-icon">
                                                <i class="fas fa-tasks"></i>
                                            </div>
                                            <div class="method-info">
                                                <h5>بناءً على الأنشطة</h5>
                                                <p>الاختبارات والمهام</p>
                                            </div>
                                        </div>
                                        <div class="method-option" onclick="selectProgressMethod(this, 'hybrid')" data-method="hybrid">
                                            <div class="method-icon">
                                                <i class="fas fa-balance-scale"></i>
                                            </div>
                                            <div class="method-info">
                                                <h5>مختلط</h5>
                                                <p>دمج عدة عوامل</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="progress-display-section">
                                    <h4>عرض التقدم</h4>
                                    <div class="display-options">
                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">شريط التقدم العام</div>
                                                <div class="toggle-description">عرض نسبة الإكمال الإجمالية</div>
                                            </div>
                                            <div class="toggle-switch active" onclick="toggleSwitch(this)" data-field="showOverallProgress">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>

                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">تقدم كل وحدة</div>
                                                <div class="toggle-description">عرض تقدم كل وحدة منفصلة</div>
                                            </div>
                                            <div class="toggle-switch active" onclick="toggleSwitch(this)" data-field="showModuleProgress">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>

                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">إحصائيات التعلم</div>
                                                <div class="toggle-description">وقت التعلم والدروس المكتملة</div>
                                            </div>
                                            <div class="toggle-switch" onclick="toggleSwitch(this)" data-field="showLearningStats">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>

                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">شارات الإنجاز</div>
                                                <div class="toggle-description">شارات عند الوصول لمراحل معينة</div>
                                            </div>
                                            <div class="toggle-switch" onclick="toggleSwitch(this)" data-field="showAchievementBadges">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Video Tracking Settings -->
                            <div class="video-tracking-settings">
                                <h4>إعدادات تتبع الفيديو</h4>
                                <div class="tracking-options">
                                    <div class="form-group">
                                        <label class="form-label">الحد الأدنى لمشاهدة الفيديو</label>
                                        <div class="slider-container">
                                            <input type="range" 
                                                   class="form-range" 
                                                   id="videoWatchThreshold" 
                                                   min="50" 
                                                   max="100" 
                                                   value="85"
                                                   oninput="updateSliderValue(this, 'videoThresholdValue')">
                                            <div class="slider-value">
                                                <span id="videoThresholdValue">85</span>%
                                            </div>
                                        </div>
                                        <div class="form-hint">
                                            <i class="fas fa-play"></i>
                                            النسبة المطلوبة من مشاهدة الفيديو لاعتباره مكتملاً
                                        </div>
                                    </div>

                                    <div class="toggle-group">
                                        <div class="toggle-info">
                                            <div class="toggle-title">منع تخطي الفيديوهات</div>
                                            <div class="toggle-description">إجبار الطلاب على مشاهدة الفيديو كاملاً</div>
                                        </div>
                                        <div class="toggle-switch" onclick="toggleSwitch(this)" data-field="preventVideoSkipping">
                                            <div class="toggle-slider"></div>
                                        </div>
                                    </div>

                                    <div class="toggle-group">
                                        <div class="toggle-info">
                                            <div class="toggle-title">تتبع وقت المشاهدة</div>
                                            <div class="toggle-description">حفظ الوقت الذي قضاه الطالب في المشاهدة</div>
                                        </div>
                                        <div class="toggle-switch active" onclick="toggleSwitch(this)" data-field="trackWatchTime">
                                            <div class="toggle-slider"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Student Interaction & Communication -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-comments"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">التفاعل والتواصل</h3>
                                    <p class="section-description">إعدادات التفاعل بين الطلاب والمدرب، والمناقشات والدعم</p>
                                </div>
                            </div>

                            <div class="interaction-settings">
                                <!-- WhatsApp Integration -->
                                <div class="whatsapp-integration">
                                    <h4>تكامل الواتساب</h4>
                                    <div class="whatsapp-features">
                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">مجموعة واتساب للطلاب</div>
                                                <div class="toggle-description">ربط الطلاب بمجموعة واتساب خاصة بالدورة</div>
                                            </div>
                                            <div class="toggle-switch active" onclick="toggleSwitch(this)" data-field="enableWhatsAppGroup">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>

                                        <div class="form-group" id="whatsappGroupSettings">
                                            <label class="form-label">رابط مجموعة الواتساب</label>
                                            <input type="url" 
                                                   class="form-control" 
                                                   id="whatsappGroupLink" 
                                                   placeholder="https://chat.whatsapp.com/..."
                                                   style="direction: ltr;">
                                            <div class="form-hint">
                                                <i class="fab fa-whatsapp"></i>
                                                رابط المجموعة الخاصة بطلاب الدورة للنقاش والدعم
                                            </div>
                                        </div>

                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">إشعارات التقدم</div>
                                                <div class="toggle-description">إرسال إشعارات واتساب عند إكمال وحدات</div>
                                            </div>
                                            <div class="toggle-switch" onclick="toggleSwitch(this)" data-field="progressNotifications">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>

                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">تذكيرات المتابعة</div>
                                                <div class="toggle-description">تذكير الطلاب غير النشطين بالعودة للدورة</div>
                                            </div>
                                            <div class="toggle-switch" onclick="toggleSwitch(this)" data-field="inactivityReminders">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>

                                        <div class="form-group" id="reminderSettings" style="display: none;">
                                            <label class="form-label">فترة التذكير (بالأيام)</label>
                                            <select class="form-control" id="reminderInterval">
                                                <option value="3">بعد 3 أيام</option>
                                                <option value="7" selected>بعد أسبوع</option>
                                                <option value="14">بعد أسبوعين</option>
                                                <option value="30">بعد شهر</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Q&A and Support -->
                                <div class="qa-support-settings">
                                    <h4>الأسئلة والدعم</h4>
                                    <div class="support-options">
                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">قسم الأسئلة والأجوبة</div>
                                                <div class="toggle-description">إتاحة قسم للطلاب لطرح الأسئلة</div>
                                            </div>
                                            <div class="toggle-switch active" onclick="toggleSwitch(this)" data-field="enableQA">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>

                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">تقييم المحتوى</div>
                                                <div class="toggle-description">السماح للطلاب بتقييم الدروس</div>
                                            </div>
                                            <div class="toggle-switch" onclick="toggleSwitch(this)" data-field="enableRatings">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>

                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">ملاحظات الطلاب</div>
                                                <div class="toggle-description">إتاحة كتابة ملاحظات شخصية</div>
                                            </div>
                                            <div class="toggle-switch active" onclick="toggleSwitch(this)" data-field="enableNotes">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">طريقة التواصل المفضلة للدعم</label>
                                            <select class="form-control" id="supportMethod">
                                                <option value="whatsapp">الواتساب</option>
                                                <option value="email">البريد الإلكتروني</option>
                                                <option value="form">نموذج اتصال</option>
                                                <option value="phone">مكالمة هاتفية</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Student Access Control -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">التحكم في الوصول</h3>
                                    <p class="section-description">إعدادات الأمان والتحكم في كيفية وصول الطلاب للمحتوى</p>
                                </div>
                            </div>

                            <div class="access-control-settings">
                                <div class="access-method">
                                    <h4>طريقة الوصول للمحتوى</h4>
                                    <div class="access-options">
                                        <div class="access-option active" onclick="selectAccessMethod(this, 'sequential')" data-method="sequential">
                                            <div class="access-icon">
                                                <i class="fas fa-list-ol"></i>
                                            </div>
                                            <h5>تسلسلي</h5>
                                            <p>يجب إكمال الدروس بالترتيب</p>
                                        </div>
                                        <div class="access-option" onclick="selectAccessMethod(this, 'free')" data-method="free">
                                            <div class="access-icon">
                                                <i class="fas fa-random"></i>
                                            </div>
                                            <h5>حر</h5>
                                            <p>يمكن الوصول لأي درس</p>
                                        </div>
                                        <div class="access-option" onclick="selectAccessMethod(this, 'timed')" data-method="timed">
                                            <div class="access-icon">
                                                <i class="fas fa-clock"></i>
                                            </div>
                                            <h5>زمني</h5>
                                            <p>فتح المحتوى في أوقات محددة</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="security-settings">
                                    <h4>إعدادات الأمان</h4>
                                    <div class="security-options">
                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">منع التحميل</div>
                                                <div class="toggle-description">منع تحميل الفيديوهات والملفات</div>
                                            </div>
                                            <div class="toggle-switch active" onclick="toggleSwitch(this)" data-field="preventDownload">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>

                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">حماية من النسخ</div>
                                                <div class="toggle-description">منع نسخ النصوص والمحتوى</div>
                                            </div>
                                            <div class="toggle-switch" onclick="toggleSwitch(this)" data-field="preventCopy">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>

                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">تتبع النشاط</div>
                                                <div class="toggle-description">تسجيل أنشطة الطلاب وأوقات الدخول</div>
                                            </div>
                                            <div class="toggle-switch active" onclick="toggleSwitch(this)" data-field="trackActivity">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">حد الأجهزة المسموحة</label>
                                            <select class="form-control" id="deviceLimit">
                                                <option value="1">جهاز واحد</option>
                                                <option value="2" selected>جهازين</option>
                                                <option value="3">3 أجهزة</option>
                                                <option value="unlimited">غير محدود</option>
                                            </select>
                                            <div class="form-hint">
                                                <i class="fas fa-devices"></i>
                                                عدد الأجهزة التي يمكن للطالب الواحد الدخول منها
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gamification and Motivation -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-gamepad"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">التحفيز والمكافآت</h3>
                                    <p class="section-description">عناصر التلعيب والتحفيز لزيادة إقبال الطلاب وإكمال الدورة</p>
                                </div>
                            </div>

                            <div class="gamification-settings">
                                <div class="achievements-section">
                                    <h4>شارات الإنجاز</h4>
                                    <div class="achievements-grid">
                                        <div class="achievement-item">
                                            <div class="achievement-icon">
                                                <i class="fas fa-play"></i>
                                            </div>
                                            <div class="achievement-info">
                                                <h5>البداية القوية</h5>
                                                <p>إكمال أول درس</p>
                                                <div class="achievement-toggle">
                                                    <input type="checkbox" id="firstLessonBadge" checked>
                                                    <label for="firstLessonBadge"></label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="achievement-item">
                                            <div class="achievement-icon">
                                                <i class="fas fa-fire"></i>
                                            </div>
                                            <div class="achievement-info">
                                                <h5>المثابر</h5>
                                                <p>7 أيام متتالية من التعلم</p>
                                                <div class="achievement-toggle">
                                                    <input type="checkbox" id="streakBadge" checked>
                                                    <label for="streakBadge"></label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="achievement-item">
                                            <div class="achievement-icon">
                                                <i class="fas fa-clock"></i>
                                            </div>
                                            <div class="achievement-info">
                                                <h5>سريع التعلم</h5>
                                                <p>إكمال وحدة في أقل من يوم</p>
                                                <div class="achievement-toggle">
                                                    <input type="checkbox" id="fastLearnerBadge">
                                                    <label for="fastLearnerBadge"></label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="achievement-item">
                                            <div class="achievement-icon">
                                                <i class="fas fa-star"></i>
                                            </div>
                                            <div class="achievement-info">
                                                <h5>المتفوق</h5>
                                                <p>الحصول على درجة 100% في اختبار</p>
                                                <div class="achievement-toggle">
                                                    <input type="checkbox" id="perfectScoreBadge" checked>
                                                    <label for="perfectScoreBadge"></label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="achievement-item">
                                            <div class="achievement-icon">
                                                <i class="fas fa-trophy"></i>
                                            </div>
                                            <div class="achievement-info">
                                                <h5>المنجز</h5>
                                                <p>إكمال الدورة بالكامل</p>
                                                <div class="achievement-toggle">
                                                    <input type="checkbox" id="completionBadge" checked>
                                                    <label for="completionBadge"></label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="achievement-item">
                                            <div class="achievement-icon">
                                                <i class="fas fa-users"></i>
                                            </div>
                                            <div class="achievement-info">
                                                <h5>الاجتماعي</h5>
                                                <p>المشاركة في 5 نقاشات</p>
                                                <div class="achievement-toggle">
                                                    <input type="checkbox" id="socialBadge">
                                                    <label for="socialBadge"></label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="motivation-features">
                                    <h4>ميزات التحفيز الإضافية</h4>
                                    <div class="motivation-options">
                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">نظام النقاط</div>
                                                <div class="toggle-description">منح نقاط للطلاب عند إكمال الأنشطة</div>
                                            </div>
                                            <div class="toggle-switch" onclick="toggleSwitch(this)" data-field="enablePoints">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>

                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">لوحة المتصدرين</div>
                                                <div class="toggle-description">عرض ترتيب الطلاب حسب التقدم</div>
                                            </div>
                                            <div class="toggle-switch" onclick="toggleSwitch(this)" data-field="enableLeaderboard">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>

                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">رسائل تشجيعية</div>
                                                <div class="toggle-description">عرض رسائل تشجيع عند الإنجازات</div>
                                            </div>
                                            <div class="toggle-switch active" onclick="toggleSwitch(this)" data-field="enableEncouragement">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>

                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">تحديات أسبوعية</div>
                                                <div class="toggle-description">إنشاء تحديات للطلاب كل أسبوع</div>
                                            </div>
                                            <div class="toggle-switch" onclick="toggleSwitch(this)" data-field="enableChallenges">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <button class="btn btn-secondary" onclick="showStep(3)">
                                <i class="fas fa-arrow-right"></i> السابق
                            </button>
                            <button class="btn btn-primary" onclick="saveAndNext(4)">
                                حفظ والمتابعة <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Enhanced CSS for Step 4 -->
                    <style>
                        /* Student Journey Overview */
                        .student-journey-overview {
                            margin-bottom: 3rem;
                            background: var(--gradient-dark);
                            padding: 2rem;
                            border-radius: var(--radius);
                            border: 1px solid var(--border);
                        }

                        .journey-steps {
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            gap: 1rem;
                            flex-wrap: wrap;
                        }

                        .journey-step {
                            text-align: center;
                            flex: 1;
                            min-width: 150px;
                        }

                        .journey-step .step-icon {
                            width: 60px;
                            height: 60px;
                            background: var(--gradient-primary);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: var(--dark);
                            font-size: 1.5rem;
                            margin: 0 auto 1rem;
                        }

                        .journey-step h4 {
                            margin-bottom: 0.5rem;
                            color: var(--text);
                        }

                        .journey-step p {
                            color: var(--text-muted);
                            font-size: 0.9rem;
                        }

                        .journey-arrow {
                            color: var(--primary);
                            font-size: 1.5rem;
                            flex-shrink: 0;
                        }

                        /* Certificates */
                        .certificates-grid {
                            display: grid;
                            grid-template-columns: 2fr 1fr;
                            gap: 3rem;
                            align-items: start;
                        }

                        .certificate-preview {
                            position: sticky;
                            top: 2rem;
                        }

                        .certificate-card {
                            background: var(--gradient-primary);
                            color: var(--dark);
                            padding: 3rem 2rem;
                            border-radius: var(--radius);
                            text-align: center;
                            margin-bottom: 1rem;
                            box-shadow: var(--shadow);
                            position: relative;
                            overflow: hidden;
                        }

                        .certificate-card::before {
                            content: '';
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: 
                                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.1), transparent 40%),
                                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.05), transparent 40%);
                            pointer-events: none;
                        }

                        .certificate-header {
                            margin-bottom: 2rem;
                            position: relative;
                            z-index: 1;
                        }

                        .certificate-logo {
                            width: 80px;
                            height: 80px;
                            background: rgba(0, 0, 0, 0.1);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 2rem;
                            margin: 0 auto 1rem;
                        }

                        .certificate-header h3 {
                            font-size: 1.8rem;
                            margin-bottom: 0.5rem;
                        }

                        .certificate-subtitle {
                            font-size: 1.1rem;
                            opacity: 0.8;
                        }

                        .certificate-body {
                            margin: 2rem 0;
                            padding: 2rem;
                            background: rgba(255, 255, 255, 0.1);
                            border-radius: 10px;
                            position: relative;
                            z-index: 1;
                        }

                        .certificate-text-preview {
                            line-height: 1.8;
                            font-size: 1rem;
                        }

                        .certificate-footer {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-top: 2rem;
                            position: relative;
                            z-index: 1;
                        }

                        .certificate-signature {
                            text-align: center;
                        }

                        .signature-line {
                            width: 120px;
                            height: 2px;
                            background: var(--dark);
                            margin-bottom: 0.5rem;
                        }

                        .signature-name {
                            font-size: 0.9rem;
                            opacity: 0.8;
                        }

                        .certificate-seal {
                            font-size: 3rem;
                            opacity: 0.3;
                        }

                        .certificate-requirements {
                            margin-top: 2rem;
                        }

                        .certificate-requirements h4 {
                            color: var(--primary);
                            margin-bottom: 1rem;
                        }

                        .requirements-checklist {
                            display: grid;
                            gap: 0.8rem;
                        }

                        .requirement-option {
                            display: flex;
                            align-items: center;
                            gap: 0.8rem;
                            padding: 0.8rem;
                            background: var(--dark);
                            border-radius: 8px;
                            border: 1px solid var(--border);
                        }

                        .requirement-checkbox {
                            width: 18px;
                            height: 18px;
                            accent-color: var(--primary);
                        }

                        /* Progress Settings */
                        .progress-settings-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 3rem;
                            margin-bottom: 2rem;
                        }

                        .progress-method-section h4,
                        .progress-display-section h4 {
                            color: var(--primary);
                            margin-bottom: 1.5rem;
                        }

                        .progress-methods {
                            display: grid;
                            gap: 1rem;
                        }

                        .method-option {
                            background: var(--lighter);
                            padding: 1.5rem;
                            border-radius: var(--radius);
                            border: 2px solid var(--border);
                            cursor: pointer;
                            transition: var(--transition);
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                        }

                        .method-option:hover {
                            border-color: var(--primary);
                        }

                        .method-option.active {
                            border-color: var(--primary);
                            background: var(--gradient-overlay);
                        }

                        .method-icon {
                            width: 50px;
                            height: 50px;
                            background: rgba(244, 196, 48, 0.1);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: var(--primary);
                            font-size: 1.2rem;
                            flex-shrink: 0;
                        }

                        .method-info h5 {
                            margin-bottom: 0.3rem;
                            color: var(--text);
                        }

                        .method-info p {
                            color: var(--text-muted);
                            font-size: 0.9rem;
                            margin: 0;
                        }

                        .display-options {
                            display: grid;
                            gap: 1rem;
                        }

                        .video-tracking-settings {
                            margin-top: 2rem;
                            padding-top: 2rem;
                            border-top: 1px solid var(--border);
                        }

                        .video-tracking-settings h4 {
                            color: var(--primary);
                            margin-bottom: 1.5rem;
                        }

                        .tracking-options {
                            display: grid;
                            gap: 1.5rem;
                        }

                        /* Interaction Settings */
                        .interaction-settings {
                            display: grid;
                            gap: 3rem;
                        }

                        .whatsapp-integration,
                        .qa-support-settings {
                            background: var(--light);
                            padding: 2rem;
                            border-radius: var(--radius);
                            border: 1px solid var(--border);
                        }

                        .whatsapp-integration h4,
                        .qa-support-settings h4 {
                            color: var(--primary);
                            margin-bottom: 1.5rem;
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                        }

                        .whatsapp-integration h4::before {
                            content: '';
                            width: 4px;
                            height: 20px;
                            background: var(--primary);
                            border-radius: 2px;
                        }

                        .whatsapp-features,
                        .support-options {
                            display: grid;
                            gap: 1.5rem;
                        }

                        /* Access Control */
                        .access-control-settings {
                            display: grid;
                            gap: 3rem;
                        }

                        .access-method h4,
                        .security-settings h4 {
                            color: var(--primary);
                            margin-bottom: 1.5rem;
                        }

                        .access-options {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 1rem;
                        }

                        .access-option {
                            background: var(--lighter);
                            padding: 2rem 1.5rem;
                            border-radius: var(--radius);
                            border: 2px solid var(--border);
                            cursor: pointer;
                            transition: var(--transition);
                            text-align: center;
                        }

                        .access-option:hover {
                            border-color: var(--primary);
                        }

                        .access-option.active {
                            border-color: var(--primary);
                            background: var(--gradient-overlay);
                        }

                        .access-icon {
                            width: 50px;
                            height: 50px;
                            background: rgba(244, 196, 48, 0.1);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: var(--primary);
                            font-size: 1.2rem;
                            margin: 0 auto 1rem;
                        }

                        .access-option h5 {
                            margin-bottom: 0.5rem;
                            color: var(--text);
                        }

                        .access-option p {
                            color: var(--text-muted);
                            font-size: 0.9rem;
                            margin: 0;
                        }

                        .security-options {
                            display: grid;
                            gap: 1.5rem;
                        }

                        /* Gamification */
                        .gamification-settings {
                            display: grid;
                            gap: 3rem;
                        }

                        .achievements-section h4,
                        .motivation-features h4 {
                            color: var(--primary);
                            margin-bottom: 1.5rem;
                        }

                        .achievements-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                            gap: 1.5rem;
                        }

                        .achievement-item {
                            background: var(--lighter);
                            padding: 1.5rem;
                            border-radius: var(--radius);
                            border: 1px solid var(--border);
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                            transition: var(--transition);
                        }

                        .achievement-item:hover {
                            border-color: var(--primary);
                        }

                        .achievement-icon {
                            width: 50px;
                            height: 50px;
                            background: var(--gradient-primary);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: var(--dark);
                            font-size: 1.2rem;
                            flex-shrink: 0;
                        }

                        .achievement-info {
                            flex: 1;
                        }

                        .achievement-info h5 {
                            margin-bottom: 0.3rem;
                            color: var(--text);
                        }

                        .achievement-info p {
                            color: var(--text-muted);
                            font-size: 0.9rem;
                            margin: 0;
                        }

                        .achievement-toggle {
                            flex-shrink: 0;
                        }

                        .achievement-toggle input[type="checkbox"] {
                            width: 18px;
                            height: 18px;
                            accent-color: var(--primary);
                        }

                        .motivation-options {
                            display: grid;
                            gap: 1.5rem;
                        }

                        /* Responsive Design */
                        @media (max-width: 1024px) {
                            .certificates-grid {
                                grid-template-columns: 1fr;
                            }
                            
                            .progress-settings-grid {
                                grid-template-columns: 1fr;
                            }
                            
                            .certificate-preview {
                                position: static;
                            }
                        }

                        @media (max-width: 768px) {
                            .journey-steps {
                                flex-direction: column;
                            }
                            
                            .journey-arrow {
                                transform: rotate(90deg);
                            }
                            
                            .achievements-grid {
                                grid-template-columns: 1fr;
                            }
                            
                            .access-options {
                                grid-template-columns: 1fr;
                            }
                        }
                    </style>
<!-- Step 5: Publishing & Advanced Settings -->
                    <div class="step-panel" id="step5">
                        <div class="panel-header">
                            <h1 class="panel-title">النشر والإعدادات المتقدمة</h1>
                            <p class="panel-subtitle">أعد دورتك للنشر مع تحسين محركات البحث والإعدادات المتقدمة للمحتوى المتدرج</p>
                        </div>

                        <!-- Publishing Readiness Check -->
                        <div class="publishing-readiness">
                            <div class="readiness-header">
                                <h3>فحص جاهزية النشر</h3>
                                <div class="overall-score">
                                    <div class="score-circle">
                                        <div class="score-value" id="overallScore">85</div>
                                        <div class="score-label">%</div>
                                    </div>
                                    <div class="score-status" id="scoreStatus">جاهز للنشر</div>
                                </div>
                            </div>
                            
                            <div class="readiness-checklist">
                                <div class="checklist-category">
                                    <h4>المحتوى الأساسي</h4>
                                    <div class="checklist-items">
                                        <div class="checklist-item completed">
                                            <i class="fas fa-check-circle"></i>
                                            <span>عنوان الدورة</span>
                                            <div class="item-status">مكتمل</div>
                                        </div>
                                        <div class="checklist-item completed">
                                            <i class="fas fa-check-circle"></i>
                                            <span>وصف تفصيلي</span>
                                            <div class="item-status">مكتمل</div>
                                        </div>
                                        <div class="checklist-item warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <span>صورة الدورة</span>
                                            <div class="item-status">مفقودة</div>
                                        </div>
                                        <div class="checklist-item completed">
                                            <i class="fas fa-check-circle"></i>
                                            <span>معلومات المدرب</span>
                                            <div class="item-status">مكتمل</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="checklist-category">
                                    <h4>المنهج والمحتوى</h4>
                                    <div class="checklist-items">
                                        <div class="checklist-item completed">
                                            <i class="fas fa-check-circle"></i>
                                            <span>3 وحدات على الأقل</span>
                                            <div class="item-status">5 وحدات</div>
                                        </div>
                                        <div class="checklist-item completed">
                                            <i class="fas fa-check-circle"></i>
                                            <span>15 درس على الأقل</span>
                                            <div class="item-status">18 درس</div>
                                        </div>
                                        <div class="checklist-item warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <span>ساعة محتوى على الأقل</span>
                                            <div class="item-status">45 دقيقة</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="checklist-category">
                                    <h4>الإعدادات</h4>
                                    <div class="checklist-items">
                                        <div class="checklist-item completed">
                                            <i class="fas fa-check-circle"></i>
                                            <span>التسعير</span>
                                            <div class="item-status">محدد</div>
                                        </div>
                                        <div class="checklist-item completed">
                                            <i class="fas fa-check-circle"></i>
                                            <span>إعدادات الطلاب</span>
                                            <div class="item-status">مكتمل</div>
                                        </div>
                                        <div class="checklist-item error">
                                            <i class="fas fa-times-circle"></i>
                                            <span>رقم الواتساب</span>
                                            <div class="item-status">مطلوب</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SEO Optimization -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-search"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">تحسين محركات البحث (SEO)</h3>
                                    <p class="section-description">حسّن ظهور دورتك في نتائج البحث وزد من وصولها للجمهور المستهدف</p>
                                </div>
                            </div>

                            <div class="seo-optimization">
                                <div class="seo-form">
                                    <div class="form-group">
                                        <label class="form-label">عنوان SEO (العنوان في محركات البحث)</label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="seoTitle" 
                                               placeholder="سيتم استخدام عنوان الدورة إذا ترك فارغاً"
                                               maxlength="60">
                                        <div class="form-hint">
                                            <i class="fas fa-info-circle"></i>
                                            <span id="seoTitleCount">0</span>/60 حرف - العنوان الذي يظهر في نتائج البحث
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">وصف SEO</label>
                                        <textarea class="form-control" 
                                                  id="seoDescription" 
                                                  rows="3" 
                                                  placeholder="سيتم استخدام الوصف المختصر إذا ترك فارغاً"
                                                  maxlength="160"></textarea>
                                        <div class="form-hint">
                                            <i class="fas fa-info-circle"></i>
                                            <span id="seoDescCount">0</span>/160 حرف - الوصف الذي يظهر تحت العنوان في البحث
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">الكلمات المفتاحية للبحث</label>
                                        <div class="seo-tags-container" id="seoTagsContainer" onclick="focusSeoTagInput()">
                                            <input type="text" 
                                                   class="seo-tag-input" 
                                                   id="seoTagInput"
                                                   placeholder="أضف كلمة مفتاحية واضغط Enter..."
                                                   onkeypress="handleSeoTagInput(event)">
                                        </div>
                                        <div class="form-hint">
                                            <i class="fas fa-hashtag"></i>
                                            أضف 5-10 كلمات مفتاحية تصف محتوى دورتك وتساعد في البحث
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">فئة المحتوى</label>
                                        <select class="form-control" id="contentCategory">
                                            <option value="">اختر الفئة الأنسب</option>
                                            <option value="personal-development">التطوير الشخصي وتطوير الذات</option>
                                            <option value="business-entrepreneurship">الأعمال وريادة الأعمال</option>
                                            <option value="technology-programming">التكنولوجيا والبرمجة</option>
                                            <option value="design-creativity">التصميم والإبداع</option>
                                            <option value="marketing-sales">التسويق والمبيعات</option>
                                            <option value="health-wellness">الصحة واللياقة البدنية</option>
                                            <option value="education-teaching">التعليم والتدريس</option>
                                            <option value="finance-investment">المالية والاستثمار</option>
                                            <option value="languages">تعلم اللغات</option>
                                            <option value="religion-spirituality">الدين والروحانيات</option>
                                            <option value="arts-crafts">الفنون والحرف اليدوية</option>
                                            <option value="lifestyle">نمط الحياة والهوايات</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- SEO Preview -->
                                <div class="seo-preview">
                                    <h4>معاينة نتيجة البحث</h4>
                                    <div class="search-result-preview">
                                        <div class="result-url">mahmoudfouad25.github.io/fouad-perspective/courses/...</div>
                                        <div class="result-title" id="previewSeoTitle">رحلة اكتشاف الذات بمنظور الفؤاد</div>
                                        <div class="result-description" id="previewSeoDesc">دورة تحولية تساعدك على فهم ذاتك الحقيقية واكتشاف هدفك في الحياة من خلال منهج علمي ومُجرب يجمع بين علم النفس والتطوير الشخصي</div>
                                    </div>
                                    
                                    <div class="seo-score">
                                        <div class="score-item">
                                            <span class="score-label">طول العنوان:</span>
                                            <span class="score-value good" id="titleLengthScore">مناسب</span>
                                        </div>
                                        <div class="score-item">
                                            <span class="score-label">طول الوصف:</span>
                                            <span class="score-value good" id="descLengthScore">مناسب</span>
                                        </div>
                                        <div class="score-item">
                                            <span class="score-label">الكلمات المفتاحية:</span>
                                            <span class="score-value warning" id="keywordsScore">قليلة</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Drip Content Management -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-hourglass-half"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">إدارة المحتوى المتدرج</h3>
                                    <p class="section-description">تحكم في توقيت وشروط إطلاق محتوى الدورة للطلاب</p>
                                </div>
                            </div>

                            <div class="drip-content-settings">
                                <!-- Drip Strategy -->
                                <div class="drip-strategy">
                                    <h4>استراتيجية الإطلاق المتدرج</h4>
                                    <div class="strategy-options">
                                        <div class="strategy-option active" onclick="selectDripStrategy(this, 'none')" data-strategy="none">
                                            <div class="strategy-icon">
                                                <i class="fas fa-unlock-alt"></i>
                                            </div>
                                            <div class="strategy-info">
                                                <h5>بدون تدرج</h5>
                                                <p>كل المحتوى متاح فوراً</p>
                                            </div>
                                        </div>

                                        <div class="strategy-option" onclick="selectDripStrategy(this, 'schedule')" data-strategy="schedule">
                                            <div class="strategy-icon">
                                                <i class="fas fa-calendar-week"></i>
                                            </div>
                                            <div class="strategy-info">
                                                <h5>جدولة زمنية</h5>
                                                <p>إطلاق المحتوى في مواعيد محددة</p>
                                            </div>
                                        </div>

                                        <div class="strategy-option" onclick="selectDripStrategy(this, 'progress')" data-strategy="progress">
                                            <div class="strategy-icon">
                                                <i class="fas fa-chart-line"></i>
                                            </div>
                                            <div class="strategy-info">
                                                <h5>بناءً على التقدم</h5>
                                                <p>فتح المحتوى عند إكمال السابق</p>
                                            </div>
                                        </div>

                                        <div class="strategy-option" onclick="selectDripStrategy(this, 'hybrid')" data-strategy="hybrid">
                                            <div class="strategy-icon">
                                                <i class="fas fa-cogs"></i>
                                            </div>
                                            <div class="strategy-info">
                                                <h5>مختلط</h5>
                                                <p>دمج الجدولة مع شروط التقدم</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Drip Settings -->
                                <div class="drip-settings" id="dripSettings" style="display: none;">
                                    <h4>إعدادات الإطلاق المتدرج</h4>
                                    
                                    <div class="drip-settings-grid">
                                        <div class="setting-group" id="scheduleSettings" style="display: none;">
                                            <label class="form-label">فترة الإطلاق</label>
                                            <select class="form-control" id="releaseInterval">
                                                <option value="daily">يومياً</option>
                                                <option value="weekly" selected>أسبوعياً</option>
                                                <option value="biweekly">كل أسبوعين</option>
                                                <option value="monthly">شهرياً</option>
                                                <option value="custom">فترة مخصصة</option>
                                            </select>
                                        </div>

                                        <div class="setting-group" id="progressSettings" style="display: none;">
                                            <label class="form-label">نسبة الإكمال المطلوبة</label>
                                            <div class="slider-container">
                                                <input type="range" 
                                                       class="form-range" 
                                                       id="progressThreshold" 
                                                       min="50" 
                                                       max="100" 
                                                       value="80"
                                                       oninput="updateSliderValue(this, 'progressThresholdValue')">
                                                <div class="slider-value">
                                                    <span id="progressThresholdValue">80</span>%
                                                </div>
                                            </div>
                                        </div>

                                        <div class="setting-group" id="customIntervalSettings" style="display: none;">
                                            <label class="form-label">الفترة المخصصة (بالأيام)</label>
                                            <input type="number" 
                                                   class="form-control" 
                                                   id="customDripInterval" 
                                                   min="1" 
                                                   placeholder="عدد الأيام">
                                        </div>
                                    </div>

                                    <div class="drip-notifications">
                                        <h5>إشعارات الإطلاق</h5>
                                        <div class="notification-options">
                                            <div class="toggle-group">
                                                <div class="toggle-info">
                                                    <div class="toggle-title">إشعار واتساب عند إطلاق محتوى جديد</div>
                                                    <div class="toggle-description">إرسال رسالة للطالب عند توفر محتوى جديد</div>
                                                </div>
                                                <div class="toggle-switch active" onclick="toggleSwitch(this)" data-field="dripNotifications">
                                                    <div class="toggle-slider"></div>
                                                </div>
                                            </div>

                                            <div class="form-group" id="dripNotificationMessage">
                                                <label class="form-label">نص الإشعار</label>
                                                <textarea class="form-control" 
                                                          id="dripMessageTemplate" 
                                                          rows="3" 
                                                          placeholder="نص الرسالة..."
                                                          maxlength="300">🎉 محتوى جديد متاح الآن!

مرحباً {student_name}،

تم إطلاق محتوى جديد في دورة "{course_name}".

يمكنك الآن الوصول إلى: {new_content}

استمتع بالتعلم! 📚</textarea>
                                                <div class="form-hint">
                                                    <i class="fas fa-magic"></i>
                                                    <span id="dripMessageCount">0</span>/300 حرف. استخدم {student_name}، {course_name}، {new_content}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Content Timeline Preview -->
                                <div class="content-timeline" id="contentTimeline" style="display: none;">
                                    <h4>جدولة المحتوى</h4>
                                    <div class="timeline-container">
                                        <div class="timeline-item">
                                            <div class="timeline-marker">
                                                <i class="fas fa-play"></i>
                                            </div>
                                            <div class="timeline-content">
                                                <h5>الوحدة الأولى: مقدمة</h5>
                                                <p>متاحة فوراً عند التسجيل</p>
                                                <div class="timeline-meta">
                                                    <span><i class="fas fa-video"></i> 3 فيديوهات</span>
                                                    <span><i class="fas fa-clock"></i> 25 دقيقة</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="timeline-item">
                                            <div class="timeline-marker">
                                                <i class="fas fa-clock"></i>
                                            </div>
                                            <div class="timeline-content">
                                                <h5>الوحدة الثانية: اكتشاف القيم</h5>
                                                <p>تفتح بعد 7 أيام من التسجيل</p>
                                                <div class="timeline-meta">
                                                    <span><i class="fas fa-video"></i> 5 فيديوهات</span>
                                                    <span><i class="fas fa-clock"></i> 42 دقيقة</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="timeline-item">
                                            <div class="timeline-marker">
                                                <i class="fas fa-chart-line"></i>
                                            </div>
                                            <div class="timeline-content">
                                                <h5>الوحدة الثالثة: تحديد الأهداف</h5>
                                                <p>تفتح عند إكمال 80% من الوحدة السابقة</p>
                                                <div class="timeline-meta">
                                                    <span><i class="fas fa-video"></i> 4 فيديوهات</span>
                                                    <span><i class="fas fa-tasks"></i> 2 مهام</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Social Media Integration -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-share-alt"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">التكامل مع وسائل التواصل</h3>
                                    <p class="section-description">إعدادات المشاركة والتسويق عبر وسائل التواصل الاجتماعي</p>
                                </div>
                            </div>

                            <div class="social-integration">
                                <div class="sharing-settings">
                                    <h4>إعدادات المشاركة</h4>
                                    <div class="sharing-options">
                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">السماح بمشاركة الدورة</div>
                                                <div class="toggle-description">يمكن للطلاب مشاركة رابط الدورة</div>
                                            </div>
                                            <div class="toggle-switch active" onclick="toggleSwitch(this)" data-field="allowSharing">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>

                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">إظهار في الفهرس العام</div>
                                                <div class="toggle-description">الدورة تظهر في صفحة الدورات العامة</div>
                                            </div>
                                            <div class="toggle-switch active" onclick="toggleSwitch(this)" data-field="isPublic">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>

                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">مشاركة التقدم</div>
                                                <div class="toggle-description">السماح للطلاب بمشاركة إنجازاتهم</div>
                                            </div>
                                            <div class="toggle-switch" onclick="toggleSwitch(this)" data-field="allowProgressSharing">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="social-templates">
                                    <h4>قوالب المشاركة</h4>
                                    <div class="template-options">
                                        <div class="template-item">
                                            <h5>مشاركة الدورة</h5>
                                            <textarea class="form-control" 
                                                      id="shareTemplate" 
                                                      rows="3" 
                                                      placeholder="النص الذي يظهر عند مشاركة الدورة..."
                                                      maxlength="280">🌟 أنضم الآن إلى دورة "{course_name}" 

رحلة تعلم مذهلة مع {instructor_name}

{course_url}

#التطوير_الشخصي #منظور_الفؤاد</textarea>
                                            <div class="form-hint">
                                                <span id="shareTemplateCount">0</span>/280 حرف للتوافق مع تويتر
                                            </div>
                                        </div>

                                        <div class="template-item">
                                            <h5>مشاركة الإنجاز</h5>
                                            <textarea class="form-control" 
                                                      id="achievementTemplate" 
                                                      rows="3" 
                                                      placeholder="النص عند مشاركة إتمام الدورة..."
                                                      maxlength="280">🎉 أكملت للتو دورة "{course_name}"!

رحلة تعلم رائعة حققت فيها:
✅ فهم أعمق للذات
✅ وضوح في الأهداف  
✅ خطة عمل واضحة

شكراً {instructor_name} على هذه التجربة المميزة! 🙏

#إنجاز #التطوير_الشخصي</textarea>
                                            <div class="form-hint">
                                                <span id="achievementTemplateCount">0</span>/280 حرف
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Course Settings -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-cogs"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">الإعدادات المتقدمة</h3>
                                    <p class="section-description">إعدادات تقنية متقدمة لتخصيص تجربة الدورة</p>
                                </div>
                            </div>

                            <div class="advanced-settings">
                                <div class="technical-settings">
                                    <h4>الإعدادات التقنية</h4>
                                    <div class="technical-options">
                                        <div class="form-group">
                                            <label class="form-label">كود CSS مخصص</label>
                                            <textarea class="form-control code-editor" 
                                                      id="customCSS" 
                                                      rows="6" 
                                                      placeholder="/* أضف CSS مخصص لتخصيص مظهر صفحة الدورة */
.course-header {
    background: linear-gradient(135deg, #f4c430, #e6b429);
}

.lesson-card {
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}"
                                                      style="font-family: 'Courier New', monospace; direction: ltr;"></textarea>
                                            <div class="form-hint">
                                                <i class="fas fa-code"></i>
                                                CSS لتخصيص مظهر صفحة الدورة (للمطورين)
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">JavaScript مخصص</label>
                                            <textarea class="form-control code-editor" 
                                                      id="customJS" 
                                                      rows="4" 
                                                      placeholder="// أضف JavaScript مخصص (اختياري)
// تأكد من أن الكود آمن ولا يؤثر على وظائف الموقع

// مثال: تتبع إضافي للتقدم
function trackCustomProgress(lessonId) {
    console.log('Custom tracking for lesson:', lessonId);
}"
                                                      style="font-family: 'Courier New', monospace; direction: ltr;"></textarea>
                                            <div class="form-hint">
                                                <i class="fas fa-warning"></i>
                                                كود JavaScript إضافي - استخدم بحذر (للمطورين المتقدمين)
                                            </div>
                                        </div>

                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">وضع التطوير</div>
                                                <div class="toggle-description">إظهار معلومات إضافية للاختبار والتطوير</div>
                                            </div>
                                            <div class="toggle-switch" onclick="toggleSwitch(this)" data-field="devMode">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>

                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">تسجيل الأنشطة المفصل</div>
                                                <div class="toggle-description">حفظ تفاصيل أكثر عن أنشطة الطلاب</div>
                                            </div>
                                            <div class="toggle-switch" onclick="toggleSwitch(this)" data-field="detailedLogging">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="backup-settings">
                                    <h4>النسخ الاحتياطي والتصدير</h4>
                                    <div class="backup-options">
                                        <div class="toggle-group">
                                            <div class="toggle-info">
                                                <div class="toggle-title">نسخ احتياطي تلقائي</div>
                                                <div class="toggle-description">حفظ نسخة احتياطية من بيانات الدورة يومياً</div>
                                            </div>
                                            <div class="toggle-switch active" onclick="toggleSwitch(this)" data-field="autoBackup">
                                                <div class="toggle-slider"></div>
                                            </div>
                                        </div>

                                        <div class="backup-actions">
                                            <button class="btn btn-secondary" onclick="exportCourseData()">
                                                <i class="fas fa-download"></i>
                                                تصدير بيانات الدورة
                                            </button>
                                            <button class="btn btn-secondary" onclick="importCourseData()">
                                                <i class="fas fa-upload"></i>
                                                استيراد بيانات
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Final Publishing Section -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-rocket"></i>
                                </div>
                                <div class="section-info">
                                    <h3 class="section-title">النشر النهائي</h3>
                                    <p class="section-description">راجع جميع الإعدادات وانشر دورتك للطلاب</p>
                                </div>
                            </div>

                            <div class="final-publishing">
                                <div class="publishing-summary">
                                    <div class="summary-grid">
                                        <div class="summary-item">
                                            <div class="summary-icon">
                                                <i class="fas fa-graduation-cap"></i>
                                            </div>
                                            <div class="summary-info">
                                                <h5>المحتوى</h5>
                                                <p><span id="summaryModules">5</span> وحدات، <span id="summaryLessons">18</span> درس</p>
                                            </div>
                                        </div>

                                        <div class="summary-item">
                                            <div class="summary-icon">
                                                <i class="fas fa-clock"></i>
                                            </div>
                                            <div class="summary-info">
                                                <h5>المدة</h5>
                                                <p><span id="summaryDuration">2.5</span> ساعة تعليمية</p>
                                            </div>
                                        </div>

                                        <div class="summary-item">
                                            <div class="summary-icon">
                                                <i class="fas fa-money-bill-wave"></i>
                                            </div>
                                            <div class="summary-info">
                                                <h5>التسعير</h5>
                                                <p><span id="summaryPrice">299 ج.م</span></p>
                                            </div>
                                        </div>

                                        <div class="summary-item">
                                            <div class="summary-icon">
                                                <i class="fas fa-users"></i>
                                            </div>
                                            <div class="summary-info">
                                                <h5>الوصول</h5>
                                                <p><span id="summaryAccess">تسلسلي</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="publishing-actions">
                                    <div class="action-cards">
                                        <div class="action-card draft">
                                            <div class="card-icon">
                                                <i class="fas fa-save"></i>
                                            </div>
                                            <div class="card-content">
                                                <h5>حفظ كمسودة</h5>
                                                <p>احفظ التقدم وعُد لاحقاً للإكمال</p>
                                                <button class="btn btn-secondary" onclick="saveDraft()">
                                                    حفظ المسودة
                                                </button>
                                            </div>
                                        </div>

                                        <div class="action-card preview">
                                            <div class="card-icon">
                                                <i class="fas fa-eye"></i>
                                            </div>
                                            <div class="card-content">
                                                <h5>معاينة الدورة</h5>
                                                <p>راجع شكل الدورة كما سيراها الطلاب</p>
                                                <button class="btn btn-secondary" onclick="previewCourse()">
                                                    معاينة
                                                </button>
                                            </div>
                                        </div>

                                        <div class="action-card publish">
                                            <div class="card-icon">
                                                <i class="fas fa-rocket"></i>
                                            </div>
                                            <div class="card-content">
                                                <h5>نشر الدورة</h5>
                                                <p>اجعل دورتك متاحة للطلاب</p>
                                                <button class="btn btn-primary btn-lg" onclick="publishCourse()">
                                                    <i class="fas fa-rocket"></i>
                                                    نشر الآن
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="publishing-agreement">
                                        <div class="agreement-checkbox">
                                            <input type="checkbox" id="publishingAgreement">
                                            <label for="publishingAgreement">
                                                أؤكد أن جميع المعلومات صحيحة وأن المحتوى جاهز للنشر
                                            </label>
                                        </div>
                                        <div class="form-hint">
                                            <i class="fas fa-info-circle"></i>
                                            بعد النشر، سيتمكن الطلاب من رؤية دورتك والتسجيل فيها
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <button class="btn btn-secondary" onclick="showStep(4)">
                                <i class="fas fa-arrow-right"></i> السابق
                            </button>
                            <button class="btn btn-success btn-lg" onclick="finalizeAndPublish()" id="finalPublishBtn" disabled>
                                <i class="fas fa-check-circle"></i>
                                إنهاء ونشر الدورة
                            </button>
                        </div>
                    </div>

                    <!-- Enhanced CSS for Step 5 -->
                    <style>
                        /* Publishing Readiness */
                        .publishing-readiness {
                            background: var(--gradient-dark);
                            padding: 2rem;
                            border-radius: var(--radius);
                            border: 1px solid var(--border);
                            margin-bottom: 3rem;
                        }

                        .readiness-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 2rem;
                        }

                        .readiness-header h3 {
                            color: var(--primary);
                            font-size: 1.4rem;
                        }

                        .overall-score {
                            text-align: center;
                        }

                        .score-circle {
                            width: 80px;
                            height: 80px;
                            background: conic-gradient(var(--primary) 85%, var(--lighter) 85%);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-bottom: 0.5rem;
                            position: relative;
                        }

                        .score-circle::before {
                            content: '';
                            position: absolute;
                            inset: 8px;
                            background: var(--dark);
                            border-radius: 50%;
                        }

                        .score-value {
                            font-size: 1.8rem;
                            font-weight: 700;
                            color: var(--primary);
                            z-index: 1;
                        }

                        .score-label {
                            font-size: 0.9rem;
                            color: var(--text-muted);
                            z-index: 1;
                        }

                        .score-status {
                            font-size: 0.9rem;
                            color: var(--success);
                            font-weight: 600;
                        }

                        .readiness-checklist {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                            gap: 2rem;
                        }

                        .checklist-category h4 {
                            color: var(--text);
                            margin-bottom: 1rem;
                            font-size: 1.1rem;
                        }

                        .checklist-items {
                            display: grid;
                            gap: 0.8rem;
                        }

                        .checklist-item {
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                            padding: 0.8rem;
                            background: var(--lighter);
                            border-radius: 8px;
                            border: 1px solid var(--border);
                        }

                        .checklist-item i {
                            font-size: 1.2rem;
                            flex-shrink: 0;
                        }

                        .checklist-item.completed i {
                            color: var(--success);
                        }

                        .checklist-item.warning i {
                            color: var(--warning);
                        }

                        .checklist-item.error i {
                            color: var(--danger);
                        }

                        .checklist-item span {
                            flex: 1;
                            color: var(--text);
                        }

                        .item-status {
                            font-size: 0.8rem;
                            color: var(--text-muted);
                        }

                        /* SEO Optimization */
                        .seo-optimization {
                            display: grid;
                            grid-template-columns: 2fr 1fr;
                            gap: 3rem;
                            align-items: start;
                        }

                        .seo-preview {
                            position: sticky;
                            top: 2rem;
                        }

                        .seo-preview h4 {
                            color: var(--primary);
                            margin-bottom: 1.5rem;
                        }

                        .search-result-preview {
                            background: var(--lighter);
                            padding: 1.5rem;
                            border-radius: var(--radius);
                            border: 1px solid var(--border);
                            margin-bottom: 1.5rem;
                        }

                        .result-url {
                            color: var(--success);
                            font-size: 0.85rem;
                            margin-bottom: 0.3rem;
                        }

                        .result-title {
                            color: var(--secondary);
                            font-size: 1.1rem;
                            font-weight: 600;
                            margin-bottom: 0.5rem;
                            line-height: 1.3;
                        }

                        .result-description {
                            color: var(--text-muted);
                            font-size: 0.9rem;
                            line-height: 1.4;
                        }

                        .seo-score {
                            background: var(--dark);
                            padding: 1rem;
                            border-radius: 8px;
                            border: 1px solid var(--border);
                        }

                        .score-item {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 0.8rem;
                        }

                        .score-item:last-child {
                            margin-bottom: 0;
                        }

                        .score-label {
                            color: var(--text-muted);
                            font-size: 0.9rem;
                        }

                        .score-value {
                            font-size: 0.9rem;
                            font-weight: 600;
                        }

                        .score-value.good {
                            color: var(--success);
                        }

                        .score-value.warning {
                            color: var(--warning);
                        }

                        .score-value.error {
                            color: var(--danger);
                        }

                        .seo-tags-container {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 0.5rem;
                            min-height: 50px;
                            padding: 0.8rem;
                            background: var(--lighter);
                            border: 2px solid var(--border);
                            border-radius: 10px;
                            cursor: text;
                            transition: var(--transition);
                        }

                        .seo-tags-container:focus-within {
                            border-color: var(--primary);
                            box-shadow: 0 0 0 3px rgba(244, 196, 48, 0.1);
                        }

                        .seo-tag-input {
                            flex: 1;
                            min-width: 120px;
                            border: none;
                            background: transparent;
                            color: var(--text);
                            font-family: inherit;
                            padding: 0.4rem;
                            outline: none;
                        }

                        /* Drip Content */
                        .drip-content-settings {
                            display: grid;
                            gap: 3rem;
                        }

                        .drip-strategy h4 {
                            color: var(--primary);
                            margin-bottom: 1.5rem;
                        }

                        .strategy-options {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                            gap: 1.5rem;
                        }

                        .strategy-option {
                            background: var(--lighter);
                            padding: 2rem;
                            border-radius: var(--radius);
                            border: 2px solid var(--border);
                            cursor: pointer;
                            transition: var(--transition);
                            text-align: center;
                        }

                        .strategy-option:hover {
                            border-color: var(--primary);
                        }

                        .strategy-option.active {
                            border-color: var(--primary);
                            background: var(--gradient-overlay);
                        }

                        .strategy-option .strategy-icon {
                            width: 60px;
                            height: 60px;
                            background: rgba(244, 196, 48, 0.1);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: var(--primary);
                            font-size: 1.5rem;
                            margin: 0 auto 1rem;
                        }

                        .strategy-info h5 {
                            margin-bottom: 0.5rem;
                            color: var(--text);
                        }

                        .strategy-info p {
                            color: var(--text-muted);
                            font-size: 0.9rem;
                            margin: 0;
                        }

                        .drip-settings {
                            background: var(--light);
                            padding: 2rem;
                            border-radius: var(--radius);
                            border: 1px solid var(--border);
                        }

                        .drip-settings h4 {
                            color: var(--primary);
                            margin-bottom: 1.5rem;
                        }

                        .drip-settings-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                            gap: 1.5rem;
                            margin-bottom: 2rem;
                        }

                        .setting-group {
                            display: flex;
                            flex-direction: column;
                            gap: 0.5rem;
                        }

                        .drip-notifications h5 {
                            color: var(--text);
                            margin-bottom: 1rem;
                        }

                        .notification-options {
                            display: grid;
                            gap: 1.5rem;
                        }

                        /* Content Timeline */
                        .content-timeline {
                            background: var(--light);
                            padding: 2rem;
                            border-radius: var(--radius);
                            border: 1px solid var(--border);
                        }

                        .content-timeline h4 {
                            color: var(--primary);
                            margin-bottom: 1.5rem;
                        }

                        .timeline-container {
                            position: relative;
                            padding-left: 3rem;
                        }

                        .timeline-container::before {
                            content: '';
                            position: absolute;
                            left: 1rem;
                            top: 0;
                            bottom: 0;
                            width: 2px;
                            background: var(--primary);
                            border-radius: 1px;
                        }

                        .timeline-item {
                            position: relative;
                            margin-bottom: 2rem;
                        }

                        .timeline-item:last-child {
                            margin-bottom: 0;
                        }

                        .timeline-marker {
                            position: absolute;
                            left: -3rem;
                            top: 0.5rem;
                            width: 2rem;
                            height: 2rem;
                            background: var(--primary);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: var(--dark);
                            font-size: 0.8rem;
                        }

                        .timeline-content {
                            background: var(--lighter);
                            padding: 1.5rem;
                            border-radius: 10px;
                            border: 1px solid var(--border);
                        }

                        .timeline-content h5 {
                            margin-bottom: 0.5rem;
                            color: var(--text);
                        }

                        .timeline-content p {
                            color: var(--text-muted);
                            margin-bottom: 1rem;
                        }

                        .timeline-meta {
                            display: flex;
                            gap: 1rem;
                            font-size: 0.85rem;
                            color: var(--text-muted);
                        }

                        /* Social Integration */
                        .social-integration {
                            display: grid;
                            gap: 3rem;
                        }

                        .sharing-settings h4,
                        .social-templates h4 {
                            color: var(--primary);
                            margin-bottom: 1.5rem;
                        }

                        .sharing-options {
                            display: grid;
                            gap: 1.5rem;
                        }

                        .template-options {
                            display: grid;
                            gap: 1.5rem;
                        }

                        .template-item {
                            background: var(--lighter);
                            padding: 1.5rem;
                            border-radius: var(--radius);
                            border: 1px solid var(--border);
                        }

                        .template-item h5 {
                            color: var(--text);
                            margin-bottom: 1rem;
                        }

                        /* Advanced Settings */
                        .advanced-settings {
                            display: grid;
                            gap: 3rem;
                        }

                        .technical-settings h4,
                        .backup-settings h4 {
                            color: var(--primary);
                            margin-bottom: 1.5rem;
                        }

                        .technical-options,
                        .backup-options {
                            display: grid;
                            gap: 1.5rem;
                        }

                        .code-editor {
                            background: var(--darker) !important;
                            border: 1px solid var(--border) !important;
                            color: #50fa7b !important;
                            font-family: 'Courier New', monospace !important;
                            font-size: 0.9rem !important;
                        }

                        .backup-actions {
                            display: flex;
                            gap: 1rem;
                            margin-top: 1rem;
                        }

                        /* Final Publishing */
                        .final-publishing {
                            display: grid;
                            gap: 3rem;
                        }

                        .publishing-summary {
                            background: var(--gradient-dark);
                            padding: 2rem;
                            border-radius: var(--radius);
                            border: 1px solid var(--border);
                        }

                        .summary-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 1.5rem;
                        }

                        .summary-item {
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                            padding: 1rem;
                            background: var(--lighter);
                            border-radius: 10px;
                            border: 1px solid var(--border);
                        }

                        .summary-icon {
                            width: 50px;
                            height: 50px;
                            background: var(--gradient-primary);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: var(--dark);
                            font-size: 1.2rem;
                        }

                        .summary-info h5 {
                            margin-bottom: 0.3rem;
                            color: var(--text);
                        }

                        .summary-info p {
                            color: var(--text-muted);
                            font-size: 0.9rem;
                            margin: 0;
                        }

                        .action-cards {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                            gap: 2rem;
                            margin-bottom: 2rem;
                        }

                        .action-card {
                            background: var(--lighter);
                            padding: 2rem;
                            border-radius: var(--radius);
                            border: 1px solid var(--border);
                            text-align: center;
                            transition: var(--transition);
                        }

                        .action-card:hover {
                            border-color: var(--primary);
                            transform: translateY(-2px);
                        }

                        .action-card .card-icon {
                            width: 60px;
                            height: 60px;
                            background: rgba(244, 196, 48, 0.1);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: var(--primary);
                            font-size: 1.5rem;
                            margin: 0 auto 1rem;
                        }

                        .action-card.publish .card-icon {
                            background: var(--gradient-primary);
                            color: var(--dark);
                        }

                        .action-card h5 {
                            margin-bottom: 0.8rem;
                            color: var(--text);
                        }

                        .action-card p {
                            color: var(--text-muted);
                            margin-bottom: 1.5rem;
                            line-height: 1.4;
                        }

                        .btn-lg {
                            padding: 1rem 2rem;
                            font-size: 1.1rem;
                        }

                        .publishing-agreement {
                            text-align: center;
                            padding: 2rem;
                            background: var(--light);
                            border-radius: var(--radius);
                            border: 1px solid var(--border);
                        }

                        .agreement-checkbox {
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 0.8rem;
                            margin-bottom: 1rem;
                        }

                        .agreement-checkbox input[type="checkbox"] {
                            width: 20px;
                            height: 20px;
                            accent-color: var(--primary);
                        }

                        .agreement-checkbox label {
                            color: var(--text);
                            font-weight: 500;
                            cursor: pointer;
                        }

                        /* Responsive */
                        @media (max-width: 1024px) {
                            .seo-optimization {
                                grid-template-columns: 1fr;
                            }
                            
                            .seo-preview {
                                position: static;
                            }
                        }

                        @media (max-width: 768px) {
                            .readiness-checklist {
                                grid-template-columns: 1fr;
                            }
                            
                            .strategy-options {
                                grid-template-columns: 1fr;
                            }
                            
                            .summary-grid {
                                grid-template-columns: repeat(2, 1fr);
                            }
                            
                            .action-cards {
                                grid-template-columns: 1fr;
                            }
                        }
                    </style>
<!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="../js/firebase-config.js"></script>
    
    <script>
        // Global Variables - متاحة في كل مكان
        let courseData = {
            id: null,
            title: 'دورة جديدة',
            subtitle: '',
            description: '',
            detailedDescription: '',
            objectives: [],
            thumbnail: null,
            thumbnailUrl: null,
            introVideo: '',
            instructorName: '',
            instructorBio: '',
            instructorImage: null,
            instructorLinkedIn: '',
            instructorTwitter: '',
            instructorWebsite: '',
            category: '',
            level: 'beginner',
            keywords: [],
            priceType: 'free',
            price: 0,
            salePrice: null,
            currency: 'EGP',
            donationMin: null,
            donationMax: null,
            coupons: [],
            paymentMethods: {
                instapay: { enabled: true, number: '' },
                vodafone: { enabled: true, number: '' },
                bank: { enabled: false, name: '', accountNumber: '', accountName: '' },
                western: { enabled: false, name: '', country: '', city: '' },
                paylink: { enabled: false, url: '' }
            },
            maxStudents: null,
            enrollmentStartDate: null,
            enrollmentEndDate: null,
            courseStartDate: null,
            accessDuration: 'lifetime',
            customDuration: null,
            requireApproval: false,
            requireApplication: false,
            whatsappNumber: '',
            whatsappGroupLink: '',
            autoWelcomeMessage: true,
            welcomeMessage: '',
            modules: [],
            releaseStrategy: 'all',
            completionThreshold: 80,
            releaseInterval: 'weekly',
            customInterval: null,
            prerequisites: [],
            tools: [],
            materials: [],
            difficulty: 'beginner',
            certificate: true,
            certificateThreshold: 80,
            certificateText: '',
            certificateRequirements: {
                requireQuizzes: false,
                requireAssignments: false,
                requireParticipation: false,
                requireFinalProject: false
            },
            progressMethod: 'lessons',
            showOverallProgress: true,
            showModuleProgress: true,
            showLearningStats: false,
            showAchievementBadges: false,
            videoWatchThreshold: 85,
            preventVideoSkipping: false,
            trackWatchTime: true,
            enableWhatsAppGroup: true,
            progressNotifications: false,
            inactivityReminders: false,
            reminderInterval: 7,
            enableQA: true,
            enableRatings: false,
            enableNotes: true,
            supportMethod: 'whatsapp',
            accessType: 'sequential',
            preventDownload: true,
            preventCopy: false,
            trackActivity: true,
            deviceLimit: 2,
            achievements: {
                firstLessonBadge: true,
                streakBadge: true,
                fastLearnerBadge: false,
                perfectScoreBadge: true,
                completionBadge: true,
                socialBadge: false
            },
            enablePoints: false,
            enableLeaderboard: false,
            enableEncouragement: true,
            enableChallenges: false,
            seoTitle: '',
            seoDescription: '',
            seoKeywords: [],
            contentCategory: '',
            dripStrategy: 'none',
            dripSettings: {
                releaseInterval: 'weekly',
                progressThreshold: 80,
                customInterval: null,
                notifications: true,
                messageTemplate: ''
            },
            allowSharing: true,
            isPublic: true,
            allowProgressSharing: false,
            shareTemplate: '',
            achievementTemplate: '',
            customCSS: '',
            customJS: '',
            devMode: false,
            detailedLogging: false,
            autoBackup: true,
            status: 'draft',
            progress: 20,
            slug: '',
            createdAt: null,
            updatedAt: null
        };

        let currentStep = 1;
        let quillEditor = null;
        let autoSaveTimeout = null;
        let lastSaved = new Date();

        // حماية الصفحة
        window.addEventListener('load', function() {
            if (window.firebaseAuth && window.firebaseAuth.protectAdminPage) {
                window.firebaseAuth.protectAdminPage();
            }
        });

        // تهيئة الصفحة عند التحميل
        document.addEventListener('DOMContentLoaded', function() {
            initializeEditor();
            loadCourseData();
            setupEventListeners();
            updateProgress();
            initializeSortable();
            updateLastSavedTime();
            setInterval(updateLastSavedTime, 60000); // تحديث كل دقيقة
        });

        // ========================================
        // TEXT EDITORS AND UI INITIALIZATION
        // ========================================

        // Initialize Quill Editor
        function initializeEditor() {
            const editorElement = document.getElementById('descriptionEditor');
            if (editorElement && typeof Quill !== 'undefined') {
                try {
                    editorElement.innerHTML = '';
                    
                    quillEditor = new Quill('#descriptionEditor', {
                        theme: 'snow',
                        placeholder: 'اكتب وصفاً تفصيلياً للدورة...',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                [{ 'align': [] }],
                                ['link'],
                                ['clean']
                            ]
                        }
                    });
                    
                    quillEditor.on('text-change', function(delta, oldDelta, source) {
                        if (source === 'user') {
                            courseData.detailedDescription = quillEditor.root.innerHTML;
                            autoSave();
                        }
                    });
                } catch (error) {
                    console.error('Error initializing Quill editor:', error);
                }
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // العنوان الرئيسي - مع تأجيل خاص
            const courseTitleInput = document.getElementById('courseTitle');
            const courseTitleMainInput = document.getElementById('courseTitleMain');
            
            if (courseTitleInput) {
                courseTitleInput.addEventListener('input', function(e) {
                    courseData.title = e.target.value;
                    if (courseTitleMainInput) {
                        courseTitleMainInput.value = e.target.value;
                    }
                    updateSlugPreview('');
                    autoSaveTitle();
                });
            }
            
            if (courseTitleMainInput) {
                courseTitleMainInput.addEventListener('input', function(e) {
                    courseData.title = e.target.value;
                    if (courseTitleInput) {
                        courseTitleInput.value = e.target.value;
                    }
                    updateSlugPreview('');
                    autoSaveTitle();
                });
            }

            // خانة الـ slug
            const slugInput = document.getElementById('courseSlug');
            if (slugInput) {
                slugInput.addEventListener('input', function(e) {
                    this.value = this.value.toLowerCase().replace(/[^a-z0-9-]/g, '');
                    courseData.slug = this.value;
                    updateSlugPreview(this.value);
                    autoSave();
                });
            }

            // باقي الحقول
            setupFormFieldListeners();
            setupToggleListeners();
            setupSpecialListeners();
        }

        function setupFormFieldListeners() {
            const fields = {
                'courseSubtitle': 'subtitle',
                'courseDescription': 'description',
                'courseIntroVideo': 'introVideo',
                'instructorName': 'instructorName',
                'instructorBio': 'instructorBio',
                'instructorLinkedIn': 'instructorLinkedIn',
                'instructorTwitter': 'instructorTwitter',
                'instructorWebsite': 'instructorWebsite',
                'courseCategory': 'category',
                'courseLevel': 'level',
                'coursePrice': 'price',
                'courseSalePrice': 'salePrice',
                'courseCurrency': 'currency',
                'donationMin': 'donationMin',
                'donationMax': 'donationMax',
                'maxStudents': 'maxStudents',
                'enrollmentStartDate': 'enrollmentStartDate',
                'enrollmentEndDate': 'enrollmentEndDate',
                'courseStartDate': 'courseStartDate',
                'accessDuration': 'accessDuration',
                'customDuration': 'customDuration',
                'whatsappNumber': 'whatsappNumber',
                'whatsappGroupLink': 'whatsappGroupLink',
                'welcomeMessage': 'welcomeMessage',
                'certificateThreshold': 'certificateThreshold',
                'certificateText': 'certificateText',
                'videoWatchThreshold': 'videoWatchThreshold',
                'reminderInterval': 'reminderInterval',
                'supportMethod': 'supportMethod',
                'deviceLimit': 'deviceLimit',
                'seoTitle': 'seoTitle',
                'seoDescription': 'seoDescription',
                'contentCategory': 'contentCategory',
                'releaseInterval': 'releaseInterval',
                'customDripInterval': 'customInterval',
                'progressThreshold': 'progressThreshold',
                'dripMessageTemplate': 'dripSettings.messageTemplate',
                'shareTemplate': 'shareTemplate',
                'achievementTemplate': 'achievementTemplate',
                'customCSS': 'customCSS',
                'customJS': 'customJS'
            };

            Object.keys(fields).forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener(element.type === 'checkbox' ? 'change' : 'input', function(e) {
                        let value = e.target.value;
                        
                        if (fieldId === 'coursePrice' || fieldId === 'courseSalePrice' || fieldId === 'donationMin' || fieldId === 'donationMax') {
                            value = parseFloat(value) || 0;
                        } else if (fieldId === 'maxStudents' || fieldId === 'certificateThreshold' || fieldId === 'videoWatchThreshold' || fieldId === 'reminderInterval' || fieldId === 'customDuration' || fieldId === 'customDripInterval' || fieldId === 'progressThreshold') {
                            value = parseInt(value) || null;
                        }
                        
                        // Handle nested properties
                        const fieldPath = fields[fieldId];
                        if (fieldPath.includes('.')) {
                            const parts = fieldPath.split('.');
                            let obj = courseData;
                            for (let i = 0; i < parts.length - 1; i++) {
                                if (!obj[parts[i]]) obj[parts[i]] = {};
                                obj = obj[parts[i]];
                            }
                            obj[parts[parts.length - 1]] = value;
                        } else {
                            courseData[fieldPath] = value;
                        }
                        
                        // Special handlers
                        if (fieldId === 'courseCurrency') {
                            updateCurrencySymbol();
                        }
                        if (fieldId === 'coursePrice' || fieldId === 'courseSalePrice') {
                            updatePricePreview();
                        }
                        if (fieldId === 'seoTitle' || fieldId === 'seoDescription') {
                            updateSEOPreview();
                        }
                        
                        autoSave();
                    });
                }
            });
        }

        function setupToggleListeners() {
            const toggles = document.querySelectorAll('.toggle-switch');
            toggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const field = this.dataset.field;
                    if (field) {
                        const isActive = this.classList.contains('active');
                        if (field.includes('.')) {
                            const parts = field.split('.');
                            let obj = courseData;
                            for (let i = 0; i < parts.length - 1; i++) {
                                if (!obj[parts[i]]) obj[parts[i]] = {};
                                obj = obj[parts[i]];
                            }
                            obj[parts[parts.length - 1]] = !isActive;
                        } else {
                            courseData[field] = !isActive;
                        }
                        autoSave();
                    }
                });
            });
        }

        function setupSpecialListeners() {
            // Character counters
            setupCharacterCounters();
            
            // Tag inputs
            setupTagInputs();
            
            // Objective inputs
            document.querySelectorAll('.objective-input').forEach(input => {
                input.addEventListener('input', updateObjectives);
            });

            // Requirement inputs
            document.querySelectorAll('.requirement-input').forEach(input => {
                input.addEventListener('input', updateRequirements);
            });

            // Achievement checkboxes
            document.querySelectorAll('.achievement-toggle input').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const achievementKey = this.id;
                    courseData.achievements[achievementKey] = this.checked;
                    autoSave();
                });
            });

            // Certificate requirements
            document.querySelectorAll('.requirement-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const requirementKey = this.id;
                    courseData.certificateRequirements[requirementKey] = this.checked;
                    autoSave();
                });
            });

            // Publishing agreement
            const publishingAgreement = document.getElementById('publishingAgreement');
            if (publishingAgreement) {
                publishingAgreement.addEventListener('change', function() {
                    const finalPublishBtn = document.getElementById('finalPublishBtn');
                    if (finalPublishBtn) {
                        finalPublishBtn.disabled = !this.checked;
                    }
                });
            }
        }

        function setupCharacterCounters() {
            const counters = [
                { input: 'courseDescription', counter: 'descriptionCount', max: 300 },
                { input: 'instructorBio', counter: 'bioCount', max: 500 },
                { input: 'certificateText', counter: 'certificateTextCount', max: 300 },
                { input: 'welcomeMessage', counter: 'welcomeMessageCount', max: 500 },
                { input: 'seoTitle', counter: 'seoTitleCount', max: 60 },
                { input: 'seoDescription', counter: 'seoDescCount', max: 160 },
                { input: 'dripMessageTemplate', counter: 'dripMessageCount', max: 300 },
                { input: 'shareTemplate', counter: 'shareTemplateCount', max: 280 },
                { input: 'achievementTemplate', counter: 'achievementTemplateCount', max: 280 }
            ];

            counters.forEach(({ input, counter, max }) => {
                const inputElement = document.getElementById(input);
                const counterElement = document.getElementById(counter);
                
                if (inputElement && counterElement) {
                    inputElement.addEventListener('input', function() {
                        const length = this.value.length;
                        counterElement.textContent = length;
                        
                        // Color coding
                        if (length > max * 0.9) {
                            counterElement.style.color = 'var(--danger)';
                        } else if (length > max * 0.7) {
                            counterElement.style.color = 'var(--warning)';
                        } else {
                            counterElement.style.color = 'var(--text-muted)';
                        }
                    });
                }
            });
        }

        function setupTagInputs() {
            // Keywords tags
            const keywordInput = document.getElementById('tagInput');
            if (keywordInput) {
                keywordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' || e.key === ',') {
                        e.preventDefault();
                        const value = this.value.trim();
                        if (value && !courseData.keywords.includes(value)) {
                            courseData.keywords.push(value);
                            addTagToContainer('tagsContainer', value, 'keywords');
                            this.value = '';
                            autoSave();
                        }
                    }
                });
            }

            // SEO keywords tags
            const seoTagInput = document.getElementById('seoTagInput');
            if (seoTagInput) {
                seoTagInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' || e.key === ',') {
                        e.preventDefault();
                        const value = this.value.trim();
                        if (value && !courseData.seoKeywords.includes(value)) {
                            courseData.seoKeywords.push(value);
                            addTagToContainer('seoTagsContainer', value, 'seoKeywords');
                            this.value = '';
                            updateSEOPreview();
                            autoSave();
                        }
                    }
                });
            }
        }

        // ========================================
        // NAVIGATION AND STEP MANAGEMENT
        // ========================================

        // دوال التنقل بين الخطوات
        function showStep(stepNumber) {
            // تحديث القائمة الجانبية
            document.querySelectorAll('.step-item').forEach(item => {
                item.classList.remove('active');
                const itemStep = parseInt(item.dataset.step);
                if (itemStep === stepNumber) {
                    item.classList.add('active');
                }
                if (itemStep < stepNumber) {
                    item.classList.add('completed');
                } else {
                    item.classList.remove('completed');
                }
            });
            
            // إظهار الخطوة المطلوبة
            document.querySelectorAll('.step-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            const targetPanel = document.getElementById(`step${stepNumber}`);
            if (targetPanel) {
                targetPanel.classList.add('active');
            }
            
            currentStep = stepNumber;
            
            // التمرير لأعلى
            const mainPanel = document.querySelector('.main-panel');
            if (mainPanel) {
                mainPanel.scrollTop = 0;
            }

            // تحديث العرض حسب الخطوة
            updateStepSpecificUI(stepNumber);
        }

        function updateStepSpecificUI(stepNumber) {
            switch(stepNumber) {
                case 2:
                    updatePriceTypeVisibility();
                    break;
                case 3:
                    updateCurriculumStats();
                    updateReleaseStrategyUI();
                    break;
                case 4:
                    updateCertificatePreview();
                    break;
                case 5:
                    updatePublishingReadiness();
                    updateSEOPreview();
                    break;
            }
        }

        function saveAndNext(currentStepNum) {
            // Validate current step
            if (!validateStep(currentStepNum)) {
                return;
            }

            saveCourseData().then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'تم الحفظ',
                    text: 'تم حفظ البيانات بنجاح',
                    timer: 1500,
                    showConfirmButton: false
                });
                
                if (currentStepNum < 5) {
                    showStep(currentStepNum + 1);
                }
                
                updateProgress();
            }).catch(error => {
                console.error('Error saving:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'حدث خطأ في حفظ البيانات'
                });
            });
        }

        function validateStep(stepNumber) {
            const validations = {
                1: () => {
                    if (!courseData.title || courseData.title === 'دورة جديدة') {
                        showValidationError('يرجى إدخال عنوان للدورة');
                        return false;
                    }
                    if (!courseData.description) {
                        showValidationError('يرجى إدخال وصف مختصر للدورة');
                        return false;
                    }
                    if (!courseData.instructorName) {
                        showValidationError('يرجى إدخال اسم المدرب');
                        return false;
                    }
                    return true;
                },
                2: () => {
                    if (courseData.priceType === 'paid' && (!courseData.price || courseData.price <= 0)) {
                        showValidationError('يرجى تحديد سعر للدورة');
                        return false;
                    }
                    if (!courseData.whatsappNumber) {
                        showValidationError('يرجى إدخال رقم الواتساب لاستقبال الإشعارات');
                        return false;
                    }
                    return true;
                },
                3: () => {
                    if (!courseData.modules || courseData.modules.length === 0) {
                        showValidationError('يرجى إضافة وحدة واحدة على الأقل للدورة');
                        return false;
                    }
                    return true;
                },
                4: () => {
                    return true; // Student settings are mostly optional
                },
                5: () => {
                    return true; // Publishing settings are optional
                }
            };

            return validations[stepNumber] ? validations[stepNumber]() : true;
        }

        function showValidationError(message) {
            Swal.fire({
                icon: 'warning',
                title: 'يرجى المراجعة',
                text: message,
                confirmButtonColor: 'var(--primary)'
            });
        }

        // ========================================
        // AUTO SAVE FUNCTIONALITY
        // ========================================

        // Auto Save - نسخة محدثة مع تأجيل أكبر
        function autoSave() {
            clearTimeout(autoSaveTimeout);
            
            const saveIndicator = document.getElementById('saveIndicator');
            if (saveIndicator) {
                saveIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>جاري الحفظ...</span>';
                saveIndicator.classList.add('saving');
                saveIndicator.classList.remove('saved');
            }
            
            autoSaveTimeout = setTimeout(() => {
                saveCourseData().then(() => {
                    if (saveIndicator) {
                        saveIndicator.innerHTML = '<i class="fas fa-check-circle"></i> <span>تم الحفظ</span>';
                        saveIndicator.classList.remove('saving');
                        saveIndicator.classList.add('saved');
                        
                        setTimeout(() => {
                            saveIndicator.classList.remove('saved');
                        }, 3000);
                    }
                    lastSaved = new Date();
                    updateLastSavedTime();
                }).catch(error => {
                    console.error('Auto save error:', error);
                    if (saveIndicator) {
                        saveIndicator.innerHTML = '<i class="fas fa-exclamation-circle"></i> <span>خطأ في الحفظ</span>';
                        saveIndicator.classList.remove('saving');
                        saveIndicator.classList.add('error');
                    }
                });
            }, 3000);
        }

        // Auto save للعنوان مع تأجيل أكبر
        function autoSaveTitle() {
            clearTimeout(autoSaveTimeout);
            
            const saveIndicator = document.getElementById('saveIndicator');
            if (saveIndicator) {
                saveIndicator.innerHTML = '<i class="fas fa-clock"></i> <span>في انتظار الحفظ...</span>';
                saveIndicator.classList.add('saving');
                saveIndicator.classList.remove('saved');
            }
            
            autoSaveTimeout = setTimeout(() => {
                saveCourseData().then(() => {
                    if (saveIndicator) {
                        saveIndicator.innerHTML = '<i class="fas fa-check-circle"></i> <span>تم الحفظ</span>';
                        saveIndicator.classList.remove('saving');
                        saveIndicator.classList.add('saved');
                        
                        setTimeout(() => {
                            saveIndicator.classList.remove('saved');
                        }, 3000);
                    }
                    lastSaved = new Date();
                    updateLastSavedTime();
                }).catch(error => {
                    console.error('Auto save error:', error);
                    if (saveIndicator) {
                        saveIndicator.innerHTML = '<i class="fas fa-exclamation-circle"></i> <span>خطأ في الحفظ</span>';
                        saveIndicator.classList.remove('saving');
                        saveIndicator.classList.add('error');
                    }
                });
            }, 5000);
        }

        function updateLastSavedTime() {
            const lastSavedElement = document.getElementById('lastSaved');
            if (lastSavedElement && lastSaved) {
                const now = new Date();
                const diffMinutes = Math.floor((now - lastSaved) / 60000);
                
                let timeText;
                if (diffMinutes === 0) {
                    timeText = 'الآن';
                } else if (diffMinutes === 1) {
                    timeText = 'منذ دقيقة';
                } else if (diffMinutes < 60) {
                    timeText = `منذ ${diffMinutes} دقيقة`;
                } else {
                    const diffHours = Math.floor(diffMinutes / 60);
                    if (diffHours === 1) {
                        timeText = 'منذ ساعة';
                    } else {
                        timeText = `منذ ${diffHours} ساعة`;
                    }
                }
                
                lastSavedElement.textContent = timeText;
            }
        }

        // ========================================
        // FIREBASE INTEGRATION
        // ========================================

        // Save to Firestore
        async function saveCourseData() {
            if (!firebase.firestore) {
                console.error('Firestore not initialized');
                return Promise.reject('Firestore not initialized');
            }
            
            try {
                let finalSlug = courseData.slug;
                
                const slugInput = document.getElementById('courseSlug');
                if (slugInput && slugInput.value.trim()) {
                    finalSlug = slugInput.value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '');
                }
                
                if (!finalSlug && courseData.title && courseData.title !== 'دورة جديدة') {
                    finalSlug = window.firebaseDB.courses.createSlug(courseData.title);
                }
                
                if (!finalSlug) {
                    const now = new Date();
                    finalSlug = `course-${now.getTime()}`;
                }
                
                const dataToSave = {
                    ...courseData,
                    slug: finalSlug,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // إزالة القيم undefined
                Object.keys(dataToSave).forEach(key => {
                    if (dataToSave[key] === undefined) {
                        delete dataToSave[key];
                    }
                });
                
                if (courseData.id) {
                    await window.firebaseDB.courses.updateCourse(courseData.id, dataToSave);
                } else {
                    const newId = await window.firebaseDB.courses.createCourse(dataToSave);
                    courseData.id = newId;
                    courseData.slug = newId;
                    
                    const newUrl = `${window.location.pathname}?id=${newId}`;
                    window.history.replaceState({}, '', newUrl);
                    
                    const slugPreview = document.getElementById('slugPreview');
                    if (slugPreview) {
                        slugPreview.textContent = newId;
                    }
                    
                    if (slugInput) {
                        slugInput.value = newId;
                    }
                }
                
                return Promise.resolve();
            } catch (error) {
                console.error('Error saving course:', error);
                return Promise.reject(error);
            }
        }

        // Load Course Data
        async function loadCourseData() {
            const urlParams = new URLSearchParams(window.location.search);
            const courseId = urlParams.get('id');
            
            if (courseId && firebase.firestore) {
                try {
                    const course = await window.firebaseDB.courses.getCourse(courseId);
                    
                    if (course) {
                        courseData = { ...courseData, ...course };
                        updateUIWithCourseData();
                        updateProgress();
                    }
                } catch (error) {
                    console.error('Error loading course:', error);
                }
            }
        }

        // Update UI with course data
        function updateUIWithCourseData() {
            // Basic info
            if (courseData.title) {
                const titleInputs = ['courseTitle', 'courseTitleMain'];
                titleInputs.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.value = courseData.title;
                });
            }

            // Fill all form fields
            const fields = [
                'subtitle', 'description', 'introVideo', 'instructorName', 'instructorBio',
                'instructorLinkedIn', 'instructorTwitter', 'instructorWebsite', 'category', 'level',
                'price', 'salePrice', 'currency', 'maxStudents', 'whatsappNumber', 'whatsappGroupLink',
                'welcomeMessage', 'certificateThreshold', 'certificateText', 'seoTitle', 'seoDescription'
            ];

            fields.forEach(field => {
                const element = document.getElementById(`course${field.charAt(0).toUpperCase() + field.slice(1)}`) || 
                               document.getElementById(field) ||
                               document.getElementById(`instructor${field.charAt(0).toUpperCase() + field.slice(1)}`);
                if (element && courseData[field]) {
                    element.value = courseData[field];
                }
            });

            // Rich text editor
            if (courseData.detailedDescription && quillEditor) {
                quillEditor.root.innerHTML = courseData.detailedDescription;
            }

            // Images
            if (courseData.thumbnailUrl) {
                displayCourseImage(courseData.thumbnailUrl);
            }
            if (courseData.instructorImage) {
                displayInstructorImage(courseData.instructorImage);
            }

            // Tags
            if (courseData.keywords && courseData.keywords.length) {
                loadTags('tagsContainer', courseData.keywords, 'keywords');
            }
            if (courseData.seoKeywords && courseData.seoKeywords.length) {
                loadTags('seoTagsContainer', courseData.seoKeywords, 'seoKeywords');
            }

            // Pricing
            if (courseData.priceType) {
                selectPriceType(courseData.priceType);
            }

            // Objectives
            if (courseData.objectives && courseData.objectives.length) {
                loadObjectives();
            }

            // Modules
            if (courseData.modules && courseData.modules.length) {
                courseData.modules.forEach(module => {
                    renderModule(module);
                });
            }

            // Update all UI elements
            updateAllToggles();
            updateCharacterCounters();
        }

        function updateAllToggles() {
            const toggleMappings = {
                'certificateEnabled': 'certificate',
                'allowComments': 'allowComments',
                'hasForum': 'hasForum',
                'allowSharing': 'allowSharing',
                'isPublic': 'isPublic',
                'enableWhatsAppGroup': 'enableWhatsAppGroup',
                'autoWelcomeMessage': 'autoWelcomeMessage'
            };

            Object.keys(toggleMappings).forEach(toggleId => {
                const toggle = document.querySelector(`[data-field="${toggleMappings[toggleId]}"]`);
                if (toggle) {
                    if (courseData[toggleMappings[toggleId]]) {
                        toggle.classList.add('active');
                    } else {
                        toggle.classList.remove('active');
                    }
                }
            });
        }

        // ========================================
        // UI UPDATE FUNCTIONS
        // ========================================

        // دالة تحديث معاينة الرابط
        function updateSlugPreview(value) {
            const preview = document.getElementById('slugPreview');
            if (!preview) return;
            
            if (value) {
                preview.textContent = value.toLowerCase().replace(/[^a-z0-9-]/g, '');
            } else {
                const title = document.getElementById('courseTitleMain')?.value || courseData.title;
                if (title && title !== 'دورة جديدة') {
                    preview.textContent = generateSlug(title);
                } else {
                    preview.textContent = 'course-url-here';
                }
            }
        }

        function generateSlug(title) {
            const arabicToEnglish = {
                'ا': 'a', 'أ': 'a', 'إ': 'i', 'آ': 'aa', 'ء': 'a',
                'ب': 'b', 'ت': 't', 'ث': 'th', 'ج': 'j', 'ح': 'h',
                'خ': 'kh', 'د': 'd', 'ذ': 'dh', 'ر': 'r', 'ز': 'z',
                'س': 's', 'ش': 'sh', 'ص': 's', 'ض': 'd', 'ط': 't',
                'ظ': 'dh', 'ع': 'a', 'غ': 'gh', 'ف': 'f', 'ق': 'q',
                'ك': 'k', 'ل': 'l', 'م': 'm', 'ن': 'n', 'ه': 'h',
                'و': 'w', 'ي': 'y', 'ة': 'h', 'ى': 'a',
                ' ': '-'
            };
            
            let slug = title.toLowerCase();
            
            for (let [arabic, english] of Object.entries(arabicToEnglish)) {
                slug = slug.replace(new RegExp(arabic, 'g'), english);
            }
            
            slug = slug
                .replace(/[^\w\-]+/g, '')
                .replace(/\-\-+/g, '-')
                .replace(/^-+/, '')
                .replace(/-+$/, '');
            
            if (slug.length > 50) {
                slug = slug.substring(0, 50);
                slug = slug.substring(0, slug.lastIndexOf('-'));
            }
            
            return slug || 'untitled-course';
        }

        // Progress Update
        function updateProgress() {
            let completedSteps = 0;
            const totalSteps = 20;
            
            // Basic info (4 steps)
            if (courseData.title && courseData.title !== 'دورة جديدة') completedSteps++;
            if (courseData.description) completedSteps++;
            if (courseData.detailedDescription) completedSteps++;
            if (courseData.objectives && courseData.objectives.length > 0) completedSteps++;
            
            // Pricing (3 steps)
            if (courseData.priceType) completedSteps++;
            if (courseData.priceType === 'free' || courseData.price > 0) completedSteps++;
            if (courseData.whatsappNumber) completedSteps++;
            
            // Curriculum (8 steps)
            if (courseData.modules && courseData.modules.length > 0) completedSteps += 2;
            if (courseData.modules && courseData.modules.length >= 3) completedSteps += 2;
            
            let totalLessons = 0;
            if (courseData.modules) {
                courseData.modules.forEach(module => {
                    if (module.lessons) {
                        totalLessons += module.lessons.length;
                    }
                });
            }
            
            if (totalLessons > 0) completedSteps += 2;
            if (totalLessons >= 5) completedSteps += 2;
            
            // Student settings (3 steps)
            if (courseData.certificate !== undefined) completedSteps++;
            if (courseData.certificateThreshold) completedSteps++;
            if (courseData.accessType) completedSteps++;
            
            // Publishing (2 steps)
            if (courseData.seoTitle || courseData.title) completedSteps++;
            if ((courseData.seoKeywords && courseData.seoKeywords.length > 0) || courseData.seoDescription) completedSteps++;
            
            const progress = Math.round((completedSteps / totalSteps) * 100);
            courseData.progress = progress;
            
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const completedStepsEl = document.getElementById('completedSteps');
            
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }
            if (progressPercent) {
                progressPercent.textContent = progress;
            }
            if (completedStepsEl) {
                const currentStepProgress = Math.ceil((progress / 100) * 5);
                completedStepsEl.textContent = currentStepProgress;
            }
        }

        // ========================================
        // PRICING FUNCTIONS
        // ========================================

        function selectPriceType(type) {
            document.querySelectorAll('.price-option').forEach(option => {
                option.classList.remove('active');
            });
            
            const selectedOption = document.querySelector(`[data-type="${type}"]`);
            if (selectedOption) {
                selectedOption.classList.add('active');
            }
            
            courseData.priceType = type;
            updatePriceTypeVisibility();
            updatePricePreview();
            autoSave();
        }

        function updatePriceTypeVisibility() {
            const pricingDetailsSection = document.getElementById('pricingDetailsSection');
            const paymentMethodsSection = document.getElementById('paymentMethodsSection');
            const donationRange = document.getElementById('donationRange');
            
            if (courseData.priceType === 'free') {
                if (pricingDetailsSection) pricingDetailsSection.style.display = 'none';
                if (paymentMethodsSection) paymentMethodsSection.style.display = 'none';
            } else {
                if (pricingDetailsSection) pricingDetailsSection.style.display = 'block';
                if (paymentMethodsSection) paymentMethodsSection.style.display = 'block';
            }

            if (donationRange) {
                donationRange.style.display = courseData.priceType === 'donation' ? 'block' : 'none';
            }
        }

        function updateCurrencySymbol() {
            const currencySelect = document.getElementById('courseCurrency');
            const symbols = document.querySelectorAll('.currency-symbol');
            
            if (currencySelect) {
                const selectedOption = currencySelect.options[currencySelect.selectedIndex];
                const symbol = selectedOption.dataset.symbol || 'ج.م';
                
                symbols.forEach(symbolEl => {
                    symbolEl.textContent = symbol;
                });
            }
        }

        function updatePricePreview() {
            const previewPrice = document.getElementById('previewPrice');
            const previewCurrency = document.getElementById('previewCurrency');
            const previewBadge = document.getElementById('previewBadge');
            const previewType = document.getElementById('previewType');
            const previewOriginal = document.getElementById('previewOriginal');
            const previewDiscount = document.getElementById('previewDiscount');
            const savingsItem = document.getElementById('savingsItem');
            const previewSavings = document.getElementById('previewSavings');
            
            if (!previewPrice) return;

            const currencySymbol = document.querySelector('.currency-symbol')?.textContent || 'ج.م';
            
            if (courseData.priceType === 'free') {
                previewPrice.textContent = 'مجاني';
                if (previewCurrency) previewCurrency.textContent = '';
                if (previewBadge) previewBadge.textContent = 'مجاني';
                if (previewType) previewType.textContent = 'دورة مجانية';
                if (previewOriginal) previewOriginal.style.display = 'none';
                if (previewDiscount) previewDiscount.style.display = 'none';
                if (savingsItem) savingsItem.style.display = 'none';
            } else {
                const basePrice = parseFloat(courseData.price) || 0;
                const salePrice = parseFloat(courseData.salePrice) || 0;
                const finalPrice = salePrice > 0 ? salePrice : basePrice;
                
                previewPrice.textContent = finalPrice.toFixed(0);
                if (previewCurrency) previewCurrency.textContent = currencySymbol;
                
                if (salePrice > 0) {
                    if (previewBadge) previewBadge.textContent = 'عرض خاص';
                    if (previewOriginal) {
                        previewOriginal.textContent = `${basePrice.toFixed(0)} ${currencySymbol}`;
                        previewOriginal.style.display = 'block';
                    }
                    const savings = basePrice - salePrice;
                    const savingsPercent = Math.round((savings / basePrice) * 100);
                    if (previewSavings) {
                        previewSavings.textContent = `${savings.toFixed(0)} ${currencySymbol} (${savingsPercent}%)`;
                    }
                    if (savingsItem) savingsItem.style.display = 'block';
                } else {
                    if (previewBadge) previewBadge.textContent = 'مدفوع';
                    if (previewOriginal) previewOriginal.style.display = 'none';
                    if (savingsItem) savingsItem.style.display = 'none';
                }
                
                if (previewType) {
                    previewType.textContent = courseData.priceType === 'donation' ? 'تبرع اختياري' : 'دورة مدفوعة';
                }
            }
        }

        // ========================================
        // PAYMENT METHODS
        // ========================================

        function togglePaymentMethod(method) {
            const checkbox = document.getElementById(method);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                if (!courseData.paymentMethods[method]) {
                    courseData.paymentMethods[method] = { enabled: false };
                }
                courseData.paymentMethods[method].enabled = checkbox.checked;
                autoSave();
            }
        }

        // ========================================
        // COUPONS MANAGEMENT
        // ========================================

        function addCoupon() {
            Swal.fire({
                title: 'إضافة كوبون خصم',
                html: `
                    <div style="text-align: right;">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem;">كود الكوبون</label>
                            <input id="couponCode" class="swal2-input" placeholder="مثال: SAVE20" style="direction: ltr;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem;">نوع الخصم</label>
                            <select id="couponType" class="swal2-select">
                                <option value="percentage">نسبة مئوية (%)</option>
                                <option value="fixed">مبلغ ثابت</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem;">قيمة الخصم</label>
                            <input id="couponValue" type="number" class="swal2-input" placeholder="20" min="1">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem;">تاريخ الانتهاء</label>
                            <input id="couponExpiry" type="date" class="swal2-input">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem;">حد الاستخدام</label>
                            <input id="couponLimit" type="number" class="swal2-input" placeholder="100" min="1">
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'إضافة',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: 'var(--primary)',
                preConfirm: () => {
                    const code = document.getElementById('couponCode').value;
                    const type = document.getElementById('couponType').value;
                    const value = document.getElementById('couponValue').value;
                    const expiry = document.getElementById('couponExpiry').value;
                    const limit = document.getElementById('couponLimit').value;
                    
                    if (!code || !value) {
                        Swal.showValidationMessage('يرجى إدخال الكود وقيمة الخصم');
                        return false;
                    }
                    
                    return {
                        code: code.toUpperCase(),
                        type: type,
                        value: parseInt(value),
                        expiry: expiry || null,
                        limit: limit ? parseInt(limit) : null,
                        used: 0
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    if (!courseData.coupons) {
                        courseData.coupons = [];
                    }
                    courseData.coupons.push(result.value);
                    renderCoupons();
                    autoSave();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'تم إضافة الكوبون',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        }

        function renderCoupons() {
            const couponList = document.getElementById('couponList');
            if (!couponList || !courseData.coupons) return;
            
            couponList.innerHTML = courseData.coupons.map((coupon, index) => `
                <div class="coupon-item">
                    <div class="coupon-info">
                        <div class="coupon-code">${coupon.code}</div>
                        <div class="coupon-details">
                            ${coupon.type === 'percentage' ? `${coupon.value}% خصم` : `${coupon.value} ${document.querySelector('.currency-symbol')?.textContent || 'ج.م'} خصم`}
                            ${coupon.expiry ? ` • صالح حتى ${new Date(coupon.expiry).toLocaleDateString('ar-SA')}` : ''}
                            ${coupon.limit ? ` • حد الاستخدام: ${coupon.limit}` : ''}
                        </div>
                    </div>
                    <div class="coupon-stats">
                        <div class="coupon-usage">${coupon.used || 0}</div>
                        <div class="coupon-label">استخدام</div>
                    </div>
                    <div class="coupon-actions">
                        <button class="icon-btn" onclick="editCoupon(${index})" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="icon-btn" onclick="copyCoupon('${coupon.code}')" title="نسخ الكود">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="icon-btn danger" onclick="removeCoupon(${index})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function removeCoupon(index) {
            Swal.fire({
                title: 'حذف الكوبون',
                text: 'هل أنت متأكد من حذف هذا الكوبون؟',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'حذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: 'var(--danger)'
            }).then((result) => {
                if (result.isConfirmed) {
                    courseData.coupons.splice(index, 1);
                    renderCoupons();
                    autoSave();
                }
            });
        }

        function copyCoupon(code) {
            navigator.clipboard.writeText(code).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'تم النسخ',
                    text: `تم نسخ كود الكوبون: ${code}`,
                    timer: 1500,
                    showConfirmButton: false
                });
            }).catch(() => {
                Swal.fire({
                    icon: 'info',
                    title: 'كود الكوبون',
                    text: code,
                    confirmButtonText: 'موافق'
                });
            });
        }

        // ========================================
        // OBJECTIVES MANAGEMENT
        // ========================================

        function addObjective() {
            const container = document.getElementById('learningObjectives');
            const count = container.children.length + 1;
            
            const newObjective = document.createElement('div');
            newObjective.className = 'objective-item';
            newObjective.innerHTML = `
                <div class="objective-number">${count}</div>
                <input type="text" class="form-control objective-input" placeholder="سيتمكن الطالب من..." maxlength="150">
                <i class="fas fa-times objective-remove" onclick="removeObjective(this)" title="حذف هذا الهدف"></i>
            `;
            
            container.appendChild(newObjective);
            
            newObjective.querySelector('.objective-input').addEventListener('input', updateObjectives);
        }

        function removeObjective(element) {
            element.parentElement.remove();
            updateObjectiveNumbers();
            updateObjectives();
        }

        function updateObjectiveNumbers() {
            const items = document.querySelectorAll('.objective-item');
            items.forEach((item, index) => {
                item.querySelector('.objective-number').textContent = index + 1;
            });
        }

        function updateObjectives() {
            const objectives = [];
            document.querySelectorAll('.objective-input').forEach(input => {
                if (input.value.trim()) {
                    objectives.push(input.value.trim());
                }
            });
            courseData.objectives = objectives;
            autoSave();
        }

        function loadObjectives() {
            const container = document.getElementById('learningObjectives');
            if (!container) return;
            
            container.innerHTML = '';
            
            courseData.objectives.forEach((objective, index) => {
                const item = document.createElement('div');
                item.className = 'objective-item';
                item.innerHTML = `
                    <div class="objective-number">${index + 1}</div>
                    <input type="text" class="form-control objective-input" value="${objective}" maxlength="150">
                    <i class="fas fa-times objective-remove" onclick="removeObjective(this)" title="حذف هذا الهدف"></i>
                `;
                container.appendChild(item);
                
                item.querySelector('.objective-input').addEventListener('input', updateObjectives);
            });
        }

        // ========================================
        // TAGS MANAGEMENT
        // ========================================

        function focusTagInput() {
            document.querySelector('.tag-input')?.focus();
        }

        function focusSeoTagInput() {
            document.querySelector('.seo-tag-input')?.focus();
        }

        function handleTagInput(event) {
            if (event.key === 'Enter' || event.key === ',') {
                event.preventDefault();
                const input = event.target;
                const value = input.value.trim();
                
                if (value && !courseData.keywords.includes(value)) {
                    courseData.keywords.push(value);
                    addTagToContainer('tagsContainer', value, 'keywords');
                    input.value = '';
                    autoSave();
                }
            }
        }

        function handleSeoTagInput(event) {
            if (event.key === 'Enter' || event.key === ',') {
                event.preventDefault();
                const input = event.target;
                const value = input.value.trim();
                
                if (value && !courseData.seoKeywords.includes(value)) {
                    courseData.seoKeywords.push(value);
                    addTagToContainer('seoTagsContainer', value, 'seoKeywords');
                    input.value = '';
                    updateSEOPreview();
                    autoSave();
                }
            }
        }

        function addTagToContainer(containerId, text, arrayName) {
            const container = document.getElementById(containerId);
            const input = container.querySelector('input');
            
            const tag = document.createElement('div');
            tag.className = 'tag';
            tag.innerHTML = `
                ${text}
                <span class="tag-remove" onclick="removeTag(this, '${arrayName}', '${text}')">×</span>
            `;
            
            container.insertBefore(tag, input);
        }

        function removeTag(element, arrayName, text) {
            const index = courseData[arrayName].indexOf(text);
            if (index > -1) {
                courseData[arrayName].splice(index, 1);
                element.parentElement.remove();
                
                if (arrayName === 'seoKeywords') {
                    updateSEOPreview();
                }
                
                autoSave();
            }
        }

        function loadTags(containerId, tags, arrayName) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Clear existing tags but keep input
            const input = container.querySelector('input');
            container.innerHTML = '';
            
            tags.forEach(tag => {
                addTagToContainer(containerId, tag, arrayName);
            });
            
            // Re-add input
            if (input) {
                container.appendChild(input);
            }
        }

        // ========================================
        // IMAGE UPLOAD FUNCTIONS
        // ========================================

        function uploadCourseImage() {
            Swal.fire({
                title: 'رفع صورة الدورة',
                html: `
                    <div style="text-align: center;">
                        <p style="margin-bottom: 1rem;">اختر طريقة رفع الصورة:</p>
                        <button class="btn btn-primary" onclick="selectImageFile('course'); Swal.close();" style="margin: 0.5rem;">
                            <i class="fas fa-upload"></i> رفع من جهازك
                        </button>
                        <br>
                        <button class="btn btn-secondary" onclick="enterImageUrl('course'); Swal.close();" style="margin: 0.5rem;">
                            <i class="fas fa-link"></i> إدخال رابط
                        </button>
                    </div>
                `,
                showConfirmButton: false,
                showCancelButton: true,
                cancelButtonText: 'إلغاء'
            });
        }

        function uploadInstructorImage() {
            Swal.fire({
                title: 'رفع صورة المدرب',
                html: `
                    <div style="text-align: center;">
                        <p style="margin-bottom: 1rem;">اختر طريقة رفع الصورة:</p>
                        <button class="btn btn-primary" onclick="selectImageFile('instructor'); Swal.close();" style="margin: 0.5rem;">
                            <i class="fas fa-upload"></i> رفع من جهازك
                        </button>
                        <br>
                        <button class="btn btn-secondary" onclick="enterImageUrl('instructor'); Swal.close();" style="margin: 0.5rem;">
                            <i class="fas fa-link"></i> إدخال رابط
                        </button>
                    </div>
                `,
                showConfirmButton: false,
                showCancelButton: true,
                cancelButtonText: 'إلغاء'
            });
        }

        function selectImageFile(type) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                handleImageFile(e.target.files[0], type);
            };
            input.click();
        }

        function handleImageFile(file, type) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (type === 'course') {
                    displayCourseImage(e.target.result);
                } else {
                    displayInstructorImage(e.target.result);
                }
                
                Swal.fire({
                    title: 'حفظ الصورة',
                    html: `
                        <div style="text-align: right;">
                            <p style="margin-bottom: 1rem;">لحفظ الصورة، ارفعها على GitHub في:</p>
                            <code style="background: #f0f0f0; padding: 0.5rem; display: block; margin: 1rem 0; direction: ltr; color: #333;">
                                media/${type === 'course' ? 'courses' : 'instructors'}/${file.name}
                            </code>
                            <p style="color: #666;">ثم اضغط تم بعد رفعها</p>
                        </div>
                    `,
                    confirmButtonText: 'تم الرفع',
                    confirmButtonColor: 'var(--primary)',
                    showCancelButton: true,
                    cancelButtonText: 'إلغاء'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const baseUrl = 'https://mahmoudfouad25.github.io/fouad-perspective/media/';
                        const folder = type === 'course' ? 'courses/' : 'instructors/';
                        const imageUrl = baseUrl + folder + file.name;
                        
                        if (type === 'course') {
                            courseData.thumbnail = file.name;
                            courseData.thumbnailUrl = imageUrl;
                        } else {
                            courseData.instructorImage = imageUrl;
                        }
                        
                        autoSave();
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'تم الحفظ',
                            text: 'تم حفظ رابط الصورة بنجاح',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                });
            };
            reader.readAsDataURL(file);
        }

        function enterImageUrl(type) {
            Swal.fire({
                title: 'إدخال رابط الصورة',
                input: 'url',
                inputPlaceholder: 'https://example.com/image.jpg',
                showCancelButton: true,
                confirmButtonText: 'حفظ',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: 'var(--primary)',
                inputValidator: (value) => {
                    if (!value) {
                        return 'يرجى إدخال رابط صحيح';
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    if (type === 'course') {
                        courseData.thumbnailUrl = result.value;
                        displayCourseImage(result.value);
                    } else {
                        courseData.instructorImage = result.value;
                        displayInstructorImage(result.value);
                    }
                    autoSave();
                }
            });
        }

        function displayCourseImage(url) {
            const uploadDiv = document.getElementById('courseImageUpload');
            if (!uploadDiv) return;
            
            uploadDiv.classList.add('has-image');
            
            const imageContent = url ? 
                `<img src="${url}" alt="Course thumbnail" onerror="this.parentElement.innerHTML='<div class=\\'course-placeholder-image\\'><i class=\\'fas fa-graduation-cap\\'></i><span>صورة الدورة</span></div>'">` :
                `<div class="course-placeholder-image">
                    <i class="fas fa-graduation-cap"></i>
                    <span>صورة الدورة</span>
                </div>`;
            
            uploadDiv.innerHTML = `
                ${imageContent}
                <div class="upload-overlay">
                    <button class="btn btn-primary" onclick="uploadCourseImage(); event.stopPropagation();">تغيير الصورة</button>
                </div>
            `;
        }

        function displayInstructorImage(url) {
            const uploadDiv = document.getElementById('instructorImageUpload');
            if (!uploadDiv) return;
            
            uploadDiv.classList.add('has-image');
            
            const imageContent = url ? 
                `<img src="${url}" alt="Instructor" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<div class=\\'instructor-placeholder-image\\'><i class=\\'fas fa-user-tie\\'></i><span>صورة المدرب</span></div>'">` :
                `<div class="instructor-placeholder-image">
                    <i class="fas fa-user-tie"></i>
                    <span>صورة المدرب</span>
                </div>`;
            
            uploadDiv.innerHTML = `
                ${imageContent}
                <div class="upload-overlay">
                    <button class="btn btn-primary" onclick="uploadInstructorImage(); event.stopPropagation();">تغيير الصورة</button>
                </div>
            `;
        }

        // ========================================
        // CURRICULUM MANAGEMENT
        // ========================================

        function addModule() {
            const moduleId = Date.now();
            const moduleNumber = courseData.modules.length + 1;
            
            const module = {
                id: moduleId,
                title: `الوحدة ${moduleNumber}`,
                description: '',
                lessons: [],
                expanded: true,
                order: moduleNumber,
                duration: 0,
                releaseCondition: 'immediate',
                releaseDate: null,
                requiredCompletion: 0
            };
            
            courseData.modules.push(module);
            renderModule(module);
            updateCurriculumStats();
            autoSave();
        }

        function renderModule(module) {
            const modulesList = document.getElementById('modulesList');
            if (!modulesList) return;

            // إخفاء الـ empty state
            const emptyState = document.getElementById('emptyState');
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            const moduleElement = document.createElement('div');
            moduleElement.className = 'module-item' + (module.expanded ? ' expanded' : '');
            moduleElement.dataset.moduleId = module.id;
            
            moduleElement.innerHTML = `
                <div class="module-header">
                    <input type="checkbox" class="module-checkbox" onchange="updateBulkActions()">
                    <i class="fas fa-grip-vertical drag-handle"></i>
                    <div class="module-info">
                        <div class="module-number">${courseData.modules.indexOf(module) + 1}</div>
                        <input type="text" 
                               class="module-title-input" 
                               value="${module.title}" 
                               onchange="updateModuleTitle(${module.id}, this.value)"
                               placeholder="اسم الوحدة">
                    </div>
                    <div class="module-meta">
                        <span><i class="fas fa-video"></i> ${module.lessons.length} دروس</span>
                        <span><i class="fas fa-clock"></i> ${calculateModuleDuration(module)} دقيقة</span>
                    </div>
                    <div class="module-actions">
                        <button class="icon-btn" onclick="toggleModule(${module.id})" title="إظهار/إخفاء">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <button class="icon-btn" onclick="editModule(${module.id})" title="إعدادات">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="icon-btn danger" onclick="deleteModule(${module.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="module-content">
                    <div class="lessons-container">
                        <div class="lessons-header">
                            <h4 class="lessons-title">محتوى الوحدة</h4>
                        </div>
                        <div class="lessons-list" id="lessons-${module.id}">
                            ${module.lessons.map(lesson => renderLessonHTML(lesson, module.id)).join('')}
                        </div>
                    </div>
                    <div class="add-content-section">
                        <button class="add-content-btn" onclick="showContentTypes(${module.id})">
                            <i class="fas fa-plus"></i>
                            إضافة محتوى جديد
                        </button>
                        <div class="content-type-grid" id="content-types-${module.id}">
                            <div class="content-type-option" onclick="addLesson(${module.id}, 'video')">
                                <div class="content-type-icon">
                                    <i class="fas fa-video"></i>
                                </div>
                                <div class="content-type-name">فيديو</div>
                            </div>
                            <div class="content-type-option" onclick="addLesson(${module.id}, 'text')">
                                <div class="content-type-icon">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="content-type-name">نص</div>
                            </div>
                            <div class="content-type-option" onclick="addLesson(${module.id}, 'quiz')">
                                <div class="content-type-icon">
                                    <i class="fas fa-question-circle"></i>
                                </div>
                                <div class="content-type-name">اختبار</div>
                            </div>
                            <div class="content-type-option" onclick="addLesson(${module.id}, 'assignment')">
                                <div class="content-type-icon">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                <div class="content-type-name">مهمة</div>
                            </div>
                            <div class="content-type-option" onclick="addLesson(${module.id}, 'resource')">
                                <div class="content-type-icon">
                                    <i class="fas fa-download"></i>
                                </div>
                                <div class="content-type-name">مورد</div>
                            </div>
                            <div class="content-type-option" onclick="addLesson(${module.id}, 'live')">
                                <div class="content-type-icon">
                                    <i class="fas fa-broadcast-tower"></i>
                                </div>
                                <div class="content-type-name">جلسة حية</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modulesList.appendChild(moduleElement);
        }

        function renderLessonHTML(lesson, moduleId) {
            const icons = {
                video: 'fas fa-video',
                text: 'fas fa-file-alt',
                quiz: 'fas fa-question-circle',
                assignment: 'fas fa-tasks',
                resource: 'fas fa-download',
                live: 'fas fa-broadcast-tower'
            };

            const statusColors = {
                published: 'published',
                draft: 'draft',
                scheduled: 'scheduled'
            };

            return `
                <div class="lesson-item" data-lesson-id="${lesson.id}">
                    <input type="checkbox" class="lesson-checkbox" onchange="updateBulkActions()">
                    <div class="lesson-type-icon">
                        <i class="${icons[lesson.type] || 'fas fa-file'}"></i>
                    </div>
                    <div class="lesson-info">
                        <div class="lesson-title">${lesson.title}</div>
                        <div class="lesson-meta">
                            <span><i class="fas fa-clock"></i> ${lesson.duration || 0} دقيقة</span>
                            <span class="lesson-status">
                                <span class="status-dot ${statusColors[lesson.status] || 'draft'}"></span>
                                ${getStatusText(lesson.status)}
                            </span>
                            ${lesson.views ? `<span><i class="fas fa-eye"></i> ${lesson.views} مشاهدة</span>` : ''}
                        </div>
                    </div>
                    <div class="lesson-actions">
                        <button class="icon-btn" onclick="previewLesson(${moduleId}, ${lesson.id})" title="معاينة">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="icon-btn" onclick="editLesson(${moduleId}, ${lesson.id})" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="icon-btn" onclick="lessonSettings(${moduleId}, ${lesson.id})" title="إعدادات">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="icon-btn danger" onclick="deleteLesson(${moduleId}, ${lesson.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function getStatusText(status) {
            const statusTexts = {
                published: 'منشور',
                draft: 'مسودة',
                scheduled: 'مجدول'
            };
            return statusTexts[status] || 'مسودة';
        }

        function calculateModuleDuration(module) {
            if (!module.lessons) return 0;
            return module.lessons.reduce((total, lesson) => total + (lesson.duration || 0), 0);
        }

        function updateModuleTitle(moduleId, newTitle) {
            const module = courseData.modules.find(m => m.id === moduleId);
            if (module) {
                module.title = newTitle;
                autoSave();
            }
        }

        function toggleModule(moduleId) {
            const moduleElement = document.querySelector(`[data-module-id="${moduleId}"]`);
            if (moduleElement) {
                moduleElement.classList.toggle('expanded');
                
                const module = courseData.modules.find(m => m.id === moduleId);
                if (module) {
                    module.expanded = moduleElement.classList.contains('expanded');
                    autoSave();
                }
                
                const chevron = moduleElement.querySelector('.fa-chevron-down');
                if (chevron) {
                    chevron.style.transform = moduleElement.classList.contains('expanded') ? 
                        'rotate(180deg)' : 'rotate(0deg)';
                }
            }
        }

        function deleteModule(moduleId) {
            Swal.fire({
                title: 'حذف الوحدة',
                text: 'هل أنت متأكد من حذف هذه الوحدة وجميع دروسها؟',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'حذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: 'var(--danger)'
            }).then((result) => {
                if (result.isConfirmed) {
                    const index = courseData.modules.findIndex(m => m.id === moduleId);
                    if (index > -1) {
                        courseData.modules.splice(index, 1);
                        
                        const moduleElement = document.querySelector(`[data-module-id="${moduleId}"]`);
                        if (moduleElement) {
                            moduleElement.remove();
                        }
                        
                        updateModuleNumbers();
                        updateCurriculumStats();
                        
                        // إظهار empty state إذا لم تعد هناك وحدات
                        if (courseData.modules.length === 0) {
                            const emptyState = document.getElementById('emptyState');
                            if (emptyState) {
                                emptyState.style.display = 'block';
                            }
                        }
                        
                        autoSave();
                    }
                }
            });
        }

        function updateModuleNumbers() {
            const moduleElements = document.querySelectorAll('.module-item');
            moduleElements.forEach((element, index) => {
                const numberEl = element.querySelector('.module-number');
                if (numberEl) {
                    numberEl.textContent = index + 1;
                }
            });
        }

        function showContentTypes(moduleId) {
            const grid = document.getElementById(`content-types-${moduleId}`);
            const button = event.target;
            
            if (grid.classList.contains('show')) {
                grid.classList.remove('show');
                button.innerHTML = '<i class="fas fa-plus"></i> إضافة محتوى جديد';
            } else {
                // إخفاء كل الـ grids الأخرى
                document.querySelectorAll('.content-type-grid').forEach(g => {
                    g.classList.remove('show');
                });
                
                grid.classList.add('show');
                button.innerHTML = '<i class="fas fa-times"></i> إلغاء';
            }
        }

        function addLesson(moduleId, type) {
            Swal.fire({
                title: 'إضافة درس جديد',
                html: `
                    <div style="text-align: right;">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem;">عنوان الدرس</label>
                            <input id="lessonTitle" class="swal2-input" placeholder="أدخل عنوان الدرس" style="text-align: right;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem;">مدة الدرس (بالدقائق)</label>
                            <input id="lessonDuration" type="number" class="swal2-input" placeholder="5" min="1">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem;">وصف مختصر</label>
                            <textarea id="lessonDescription" class="swal2-textarea" placeholder="وصف الدرس..." style="text-align: right;"></textarea>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'إضافة الدرس',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: 'var(--primary)',
                preConfirm: () => {
                    const title = document.getElementById('lessonTitle').value;
                    const duration = document.getElementById('lessonDuration').value;
                    const description = document.getElementById('lessonDescription').value;
                    
                    if (!title) {
                        Swal.showValidationMessage('يرجى إدخال عنوان الدرس');
                        return false;
                    }
                    
                    return { title, duration: parseInt(duration) || 0, description, type };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const module = courseData.modules.find(m => m.id === moduleId);
                    if (module) {
                        const lesson = {
                            id: Date.now(),
                            title: result.value.title,
                            description: result.value.description,
                            type: result.value.type,
                            duration: result.value.duration,
                            status: 'draft',
                            content: '',
                            order: module.lessons.length + 1
                        };
                        
                        module.lessons.push(lesson);
                        
                        // إعادة رندر الوحدة
                        const moduleElement = document.querySelector(`[data-module-id="${moduleId}"]`);
                        if (moduleElement) {
                            const lessonsContainer = moduleElement.querySelector(`#lessons-${moduleId}`);
                            if (lessonsContainer) {
                                lessonsContainer.innerHTML += renderLessonHTML(lesson, moduleId);
                            }
                            
                            // تحديث معلومات الوحدة
                            const metaElement = moduleElement.querySelector('.module-meta');
                            if (metaElement) {
                                metaElement.innerHTML = `
                                    <span><i class="fas fa-video"></i> ${module.lessons.length} دروس</span>
                                    <span><i class="fas fa-clock"></i> ${calculateModuleDuration(module)} دقيقة</span>
                                `;
                            }
                        }
                        
                        updateCurriculumStats();
                        autoSave();
                        
                        // إخفاء الـ content types
                        const grid = document.getElementById(`content-types-${moduleId}`);
                        if (grid) {
                            grid.classList.remove('show');
                        }
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'تم إضافة الدرس',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                }
            });
        }

        function updateCurriculumStats() {
            const modulesCount = document.getElementById('modulesCount');
            const lessonsCount = document.getElementById('lessonsCount');
            const totalDuration = document.getElementById('totalDuration');
            const certificateModules = document.getElementById('certificateModules');
            
            if (modulesCount) {
                modulesCount.textContent = courseData.modules.length;
            }
            
            let lessons = 0;
            let duration = 0;
            let certModules = 0;
            
            courseData.modules.forEach(module => {
                lessons += module.lessons ? module.lessons.length : 0;
                duration += calculateModuleDuration(module);
                if (module.required) certModules++;
            });
            
            if (lessonsCount) {
                lessonsCount.textContent = lessons;
            }
            if (totalDuration) {
                totalDuration.textContent = duration;
            }
            if (certificateModules) {
                certificateModules.textContent = certModules;
            }
        }

        // ========================================
        // RELEASE STRATEGY FUNCTIONS
        // ========================================

        function selectReleaseStrategy(element, strategy) {
            document.querySelectorAll('.strategy-card').forEach(card => {
                card.classList.remove('selected');
            });
            element.classList.add('selected');
            
            courseData.releaseStrategy = strategy;
            updateReleaseStrategyUI();
            autoSave();
        }

        function updateReleaseStrategyUI() {
            const releaseSettings = document.getElementById('releaseSettings');
            const completionGroup = document.getElementById('completionThresholdGroup');
            const intervalGroup = document.getElementById('releaseIntervalGroup');
            const customGroup = document.getElementById('customIntervalGroup');
            
            if (courseData.releaseStrategy === 'all') {
                if (releaseSettings) releaseSettings.style.display = 'none';
            } else {
                if (releaseSettings) releaseSettings.style.display = 'block';
                
                if (courseData.releaseStrategy === 'sequential' || courseData.releaseStrategy === 'hybrid') {
                    if (completionGroup) completionGroup.style.display = 'block';
                } else {
                    if (completionGroup) completionGroup.style.display = 'none';
                }
                
                if (courseData.releaseStrategy === 'scheduled' || courseData.releaseStrategy === 'hybrid') {
                    if (intervalGroup) intervalGroup.style.display = 'block';
                    
                    const intervalSelect = document.getElementById('releaseInterval');
                    if (intervalSelect && intervalSelect.value === 'custom') {
                        if (customGroup) customGroup.style.display = 'block';
                    } else {
                        if (customGroup) customGroup.style.display = 'none';
                    }
                } else {
                    if (intervalGroup) intervalGroup.style.display = 'none';
                    if (customGroup) customGroup.style.display = 'none';
                }
            }
        }

        // ========================================
        // STEP 4 FUNCTIONS
        // ========================================

        function updateCertificatePreview() {
            const certificateTextPreview = document.getElementById('certificateTextPreview');
            const certificateTextInput = document.getElementById('certificateText');
            
            if (certificateTextPreview && certificateTextInput) {
                let text = certificateTextInput.value || 'يُشهد بأن الطالب/ة {student_name} قد أكمل/ت بنجاح دورة "{course_name}" من منظور الفؤاد بتاريخ {completion_date}';
                
                // استبدال المتغيرات
                text = text
                    .replace('{student_name}', '<strong>أحمد محمد</strong>')
                    .replace('{course_name}', `<strong>${courseData.title}</strong>`)
                    .replace('{completion_date}', '<strong>25 ديسمبر 2024</strong>');
                
                certificateTextPreview.innerHTML = text;
            }
        }

        function selectProgressMethod(element, method) {
            document.querySelectorAll('.method-option').forEach(option => {
                option.classList.remove('active');
            });
            element.classList.add('active');
            
            courseData.progressMethod = method;
            autoSave();
        }

        function selectAccessMethod(element, method) {
            document.querySelectorAll('.access-option').forEach(option => {
                option.classList.remove('active');
            });
            element.classList.add('active');
            
            courseData.accessType = method;
            autoSave();
        }

        function selectDifficulty(element, level) {
            document.querySelectorAll('.difficulty-option').forEach(option => {
                option.classList.remove('active');
            });
            element.classList.add('active');
            
            courseData.difficulty = level;
            autoSave();
        }

        // ========================================
        // STEP 5 FUNCTIONS
        // ========================================

        function updatePublishingReadiness() {
            const scoreElement = document.getElementById('overallScore');
            const statusElement = document.getElementById('scoreStatus');
            
            let score = 0;
            const totalItems = 10;
            
            // فحص العناصر المطلوبة
            const checks = [
                courseData.title && courseData.title !== 'دورة جديدة',
                courseData.description,
                courseData.thumbnailUrl,
                courseData.instructorName,
                courseData.modules && courseData.modules.length >= 3,
                courseData.modules && getTotalLessons() >= 15,
                getTotalDuration() >= 60,
                courseData.priceType,
                courseData.certificate !== undefined,
                courseData.whatsappNumber
            ];
            
            score = checks.filter(check => check).length;
            const percentage = Math.round((score / totalItems) * 100);
            
            if (scoreElement) {
                scoreElement.textContent = percentage;
            }
            
            if (statusElement) {
                if (percentage >= 90) {
                    statusElement.textContent = 'جاهز للنشر';
                    statusElement.style.color = 'var(--success)';
                } else if (percentage >= 70) {
                    statusElement.textContent = 'يحتاج مراجعة';
                    statusElement.style.color = 'var(--warning)';
                } else {
                    statusElement.textContent = 'غير مكتمل';
                    statusElement.style.color = 'var(--danger)';
                }
            }
        }

        function getTotalLessons() {
            let total = 0;
            if (courseData.modules) {
                courseData.modules.forEach(module => {
                    if (module.lessons) {
                        total += module.lessons.length;
                    }
                });
            }
            return total;
        }

        function getTotalDuration() {
            let total = 0;
            if (courseData.modules) {
                courseData.modules.forEach(module => {
                    total += calculateModuleDuration(module);
                });
            }
            return total;
        }

        function updateSEOPreview() {
            const previewTitle = document.getElementById('previewSeoTitle');
            const previewDesc = document.getElementById('previewSeoDesc');
            const titleLengthScore = document.getElementById('titleLengthScore');
            const descLengthScore = document.getElementById('descLengthScore');
            const keywordsScore = document.getElementById('keywordsScore');
            
            // عنوان SEO
            const seoTitle = courseData.seoTitle || courseData.title;
            if (previewTitle) {
                previewTitle.textContent = seoTitle;
            }
            
            // وصف SEO
            const seoDesc = courseData.seoDescription || courseData.description;
            if (previewDesc) {
                previewDesc.textContent = seoDesc;
            }
            
            // تقييم طول العنوان
            if (titleLengthScore) {
                const titleLength = seoTitle ? seoTitle.length : 0;
                if (titleLength >= 30 && titleLength <= 60) {
                    titleLengthScore.textContent = 'مناسب';
                    titleLengthScore.className = 'score-value good';
                } else if (titleLength > 60) {
                    titleLengthScore.textContent = 'طويل';
                    titleLengthScore.className = 'score-value warning';
                } else {
                    titleLengthScore.textContent = 'قصير';
                    titleLengthScore.className = 'score-value error';
                }
            }
            
            // تقييم طول الوصف
            if (descLengthScore) {
                const descLength = seoDesc ? seoDesc.length : 0;
                if (descLength >= 120 && descLength <= 160) {
                    descLengthScore.textContent = 'مناسب';
                    descLengthScore.className = 'score-value good';
                } else if (descLength > 160) {
                    descLengthScore.textContent = 'طويل';
                    descLengthScore.className = 'score-value warning';
                } else {
                    descLengthScore.textContent = 'قصير';
                    descLengthScore.className = 'score-value error';
                }
            }
            
            // تقييم الكلمات المفتاحية
            if (keywordsScore) {
                const keywordsCount = courseData.seoKeywords ? courseData.seoKeywords.length : 0;
                if (keywordsCount >= 5 && keywordsCount <= 10) {
                    keywordsScore.textContent = 'مناسب';
                    keywordsScore.className = 'score-value good';
                } else if (keywordsCount > 10) {
                    keywordsScore.textContent = 'كثيرة';
                    keywordsScore.className = 'score-value warning';
                } else {
                    keywordsScore.textContent = 'قليلة';
                    keywordsScore.className = 'score-value error';
                }
            }
        }

        function selectDripStrategy(element, strategy) {
            document.querySelectorAll('.strategy-option').forEach(option => {
                option.classList.remove('active');
            });
            element.classList.add('active');
            
            courseData.dripStrategy = strategy;
            updateDripSettingsUI();
            autoSave();
        }

        function updateDripSettingsUI() {
            const dripSettings = document.getElementById('dripSettings');
            const scheduleSettings = document.getElementById('scheduleSettings');
            const progressSettings = document.getElementById('progressSettings');
            const customIntervalSettings = document.getElementById('customIntervalSettings');
            const contentTimeline = document.getElementById('contentTimeline');
            
            if (courseData.dripStrategy === 'none') {
                if (dripSettings) dripSettings.style.display = 'none';
                if (contentTimeline) contentTimeline.style.display = 'none';
            } else {
                if (dripSettings) dripSettings.style.display = 'block';
                if (contentTimeline) contentTimeline.style.display = 'block';
                
                // إظهار الإعدادات المناسبة
                if (scheduleSettings) {
                    scheduleSettings.style.display = 
                        (courseData.dripStrategy === 'schedule' || courseData.dripStrategy === 'hybrid') ? 'block' : 'none';
                }
                
                if (progressSettings) {
                    progressSettings.style.display = 
                        (courseData.dripStrategy === 'progress' || courseData.dripStrategy === 'hybrid') ? 'block' : 'none';
                }
                
                // فحص الفترة المخصصة
                const intervalSelect = document.getElementById('releaseInterval');
                if (customIntervalSettings) {
                    customIntervalSettings.style.display = 
                        (intervalSelect && intervalSelect.value === 'custom') ? 'block' : 'none';
                }
            }
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        function updateSliderValue(slider, targetId) {
            const target = document.getElementById(targetId);
            if (target) {
                target.textContent = slider.value;
            }
        }

        function toggleSwitch(element) {
            element.classList.toggle('active');
        }

        function updateBulkActions() {
            const selected = document.querySelectorAll('.module-checkbox:checked, .lesson-checkbox:checked');
            const bulkActions = document.getElementById('bulkActions');
            
            if (bulkActions) {
                if (selected.length > 0) {
                    bulkActions.style.display = 'flex';
                    const countEl = bulkActions.querySelector('.bulk-count');
                    if (countEl) {
                        countEl.textContent = `${selected.length} محدد`;
                    }
                } else {
                    bulkActions.style.display = 'none';
                }
            }
        }

        // Initialize Sortable
        function initializeSortable() {
            const modulesList = document.getElementById('modulesList');
            if (modulesList && typeof Sortable !== 'undefined') {
                new Sortable(modulesList, {
                    handle: '.drag-handle',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: function() {
                        updateModuleNumbers();
                        updateModuleOrder();
                        autoSave();
                    }
                });
            }
        }

        function updateModuleOrder() {
            const moduleElements = document.querySelectorAll('.module-item');
            moduleElements.forEach((element, index) => {
                const moduleId = parseInt(element.dataset.moduleId);
                const module = courseData.modules.find(m => m.id === moduleId);
                if (module) {
                    module.order = index + 1;
                }
            });
        }

        // ========================================
        // MAIN ACTION FUNCTIONS
        // ========================================

        function saveDraft() {
            saveCourseData().then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'تم حفظ المسودة',
                    text: 'تم حفظ جميع التغييرات بنجاح',
                    timer: 2000,
                    showConfirmButton: false
                });
            }).catch(error => {
                console.error('Error saving draft:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'حدث خطأ في حفظ المسودة'
                });
            });
        }

        function previewCourse() {
            if (!courseData.id) {
                Swal.fire({
                    icon: 'warning',
                    title: 'احفظ الدورة أولاً',
                    text: 'يجب حفظ الدورة قبل المعاينة'
                });
                return;
            }
            
            const previewUrl = `../course-preview.html?id=${courseData.id}`;
            window.open(previewUrl, '_blank');
        }

        function goBack() {
            if (confirm('هل تريد العودة للوحة التحكم؟ سيتم حفظ التغييرات تلقائياً.')) {
                saveCourseData().then(() => {
                    window.location.href = '../dashboard.html';
                }).catch(() => {
                    window.location.href = '../dashboard.html';
                });
            }
        }

        // تحديث دالة النشر
        function publishCourse() {
            if (courseData.progress < 60) {
                Swal.fire({
                    icon: 'warning',
                    title: 'الدورة غير مكتملة',
                    text: 'يجب إكمال 60% على الأقل من محتوى الدورة قبل النشر',
                    confirmButtonColor: 'var(--primary)'
                });
                return;
            }
            
            Swal.fire({
                title: 'نشر الدورة',
                text: 'هل أنت متأكد من نشر الدورة؟ سيتمكن الطلاب من الوصول إليها',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'نشر الآن',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: 'var(--primary)'
            }).then((result) => {
                if (result.isConfirmed) {
                    courseData.status = 'published';
                    courseData.publishedAt = new Date().toISOString();
                    
                    saveCourseData().then(() => {
                        if (window.firebaseDB && window.firebaseDB.courses) {
                            window.firebaseDB.courses.publishCourse(courseData.id).then(() => {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'تم النشر بنجاح!',
                                    text: 'دورتك متاحة الآن للطلاب',
                                    confirmButtonColor: 'var(--primary)'
                                }).then(() => {
                                    window.location.href = './courses.html';
                                });
                            }).catch(error => {
                                console.error('Publish error:', error);
                                Swal.fire({
                                    icon: 'success',
                                    title: 'تم النشر بنجاح!',
                                    text: 'دورتك متاحة الآن للطلاب',
                                    confirmButtonColor: 'var(--primary)'
                                });
                            });
                        } else {
                            Swal.fire({
                                icon: 'success',
                                title: 'تم النشر بنجاح!',
                                text: 'دورتك متاحة الآن للطلاب',
                                confirmButtonColor: 'var(--primary)'
                            });
                        }
                    });
                }
            });
        }

        function finalizeAndPublish() {
            if (!document.getElementById('publishingAgreement').checked) {
                Swal.fire({
                    icon: 'warning',
                    title: 'يرجى الموافقة',
                    text: 'يجب الموافقة على أن المعلومات صحيحة قبل النشر',
                    confirmButtonColor: 'var(--primary)'
                });
                return;
            }
            
            publishCourse();
        }

        // Save Draft
        function saveDraft() {
            courseData.status = 'draft';
            saveCourseData().then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'تم الحفظ',
                    text: 'تم حفظ الدورة كمسودة',
                    timer: 1500,
                    showConfirmButton: false
                });
            });
        }

        // Preview Course
        function previewCourse() {
            if (!courseData.id) {
                Swal.fire({
                    icon: 'warning',
                    title: 'احفظ الدورة أولاً',
                    text: 'يجب حفظ الدورة قبل المعاينة',
                    confirmButtonColor: 'var(--primary)'
                });
                return;
            }
            
            const previewUrl = `../course-preview.html?id=${courseData.id}`;
            window.open(previewUrl, '_blank');
        }

        // Go Back
        function goBack() {
            Swal.fire({
                title: 'هل تريد المغادرة؟',
                text: 'سيتم حفظ جميع التغييرات تلقائياً',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'مغادرة',
                cancelButtonText: 'البقاء',
                confirmButtonColor: 'var(--primary)'
            }).then((result) => {
                if (result.isConfirmed) {
                    saveCourseData().then(() => {
                        window.location.href = './dashboard.html';
                    }).catch(() => {
                        window.location.href = './dashboard.html';
                    });
                }
            });
        }

        // ========================================
        // MODULE MANAGEMENT FUNCTIONS
        // ========================================

        function addModule() {
            const moduleId = Date.now();
            const moduleNumber = courseData.modules.length + 1;
            
            const module = {
                id: moduleId,
                title: `الوحدة ${moduleNumber}`,
                description: '',
                lessons: [],
                expanded: true,
                order: moduleNumber,
                duration: 0,
                releaseCondition: 'immediate',
                releaseDate: null,
                requiredCompletion: 0
            };
            
            courseData.modules.push(module);
            renderModule(module);
            updateCurriculumStats();
            autoSave();
        }

        function renderModule(module) {
            const modulesList = document.getElementById('modulesList');
            if (!modulesList) return;

            // إخفاء الـ empty state
            const emptyState = document.getElementById('emptyState');
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            const moduleElement = document.createElement('div');
            moduleElement.className = 'module-item' + (module.expanded ? ' expanded' : '');
            moduleElement.dataset.moduleId = module.id;
            
            moduleElement.innerHTML = `
                <div class="module-header">
                    <input type="checkbox" class="module-checkbox" onchange="updateBulkActions()">
                    <i class="fas fa-grip-vertical drag-handle"></i>
                    <div class="module-info">
                        <div class="module-number">${courseData.modules.indexOf(module) + 1}</div>
                        <input type="text" 
                               class="module-title-input" 
                               value="${module.title}" 
                               onchange="updateModuleTitle(${module.id}, this.value)"
                               placeholder="اسم الوحدة">
                    </div>
                    <div class="module-meta">
                        <span><i class="fas fa-video"></i> ${module.lessons.length} دروس</span>
                        <span><i class="fas fa-clock"></i> ${calculateModuleDuration(module)} دقيقة</span>
                    </div>
                    <div class="module-actions">
                        <button class="icon-btn" onclick="toggleModule(${module.id})" title="إظهار/إخفاء">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <button class="icon-btn" onclick="editModule(${module.id})" title="إعدادات">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="icon-btn danger" onclick="deleteModule(${module.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="module-content">
                    <div class="lessons-container">
                        <div class="lessons-header">
                            <h4 class="lessons-title">محتوى الوحدة</h4>
                        </div>
                        <div class="lessons-list" id="lessons-${module.id}">
                            ${module.lessons.map(lesson => renderLessonHTML(lesson, module.id)).join('')}
                        </div>
                    </div>
                    <div class="add-content-section">
                        <button class="add-content-btn" onclick="showContentTypes(${module.id})">
                            <i class="fas fa-plus"></i>
                            إضافة محتوى جديد
                        </button>
                        <div class="content-type-grid" id="content-types-${module.id}">
                            <div class="content-type-option" onclick="addLesson(${module.id}, 'video')">
                                <div class="content-type-icon">
                                    <i class="fas fa-video"></i>
                                </div>
                                <div class="content-type-name">فيديو</div>
                            </div>
                            <div class="content-type-option" onclick="addLesson(${module.id}, 'text')">
                                <div class="content-type-icon">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="content-type-name">نص</div>
                            </div>
                            <div class="content-type-option" onclick="addLesson(${module.id}, 'quiz')">
                                <div class="content-type-icon">
                                    <i class="fas fa-question-circle"></i>
                                </div>
                                <div class="content-type-name">اختبار</div>
                            </div>
                            <div class="content-type-option" onclick="addLesson(${module.id}, 'assignment')">
                                <div class="content-type-icon">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                <div class="content-type-name">مهمة</div>
                            </div>
                            <div class="content-type-option" onclick="addLesson(${module.id}, 'resource')">
                                <div class="content-type-icon">
                                    <i class="fas fa-download"></i>
                                </div>
                                <div class="content-type-name">مورد</div>
                            </div>
                            <div class="content-type-option" onclick="addLesson(${module.id}, 'live')">
                                <div class="content-type-icon">
                                    <i class="fas fa-broadcast-tower"></i>
                                </div>
                                <div class="content-type-name">جلسة حية</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modulesList.appendChild(moduleElement);
        }

        function renderLessonHTML(lesson, moduleId) {
            const icons = {
                video: 'fas fa-video',
                text: 'fas fa-file-alt',
                quiz: 'fas fa-question-circle',
                assignment: 'fas fa-tasks',
                resource: 'fas fa-download',
                live: 'fas fa-broadcast-tower'
            };

            const statusColors = {
                published: 'published',
                draft: 'draft',
                scheduled: 'scheduled'
            };

            return `
                <div class="lesson-item" data-lesson-id="${lesson.id}">
                    <input type="checkbox" class="lesson-checkbox" onchange="updateBulkActions()">
                    <div class="lesson-type-icon">
                        <i class="${icons[lesson.type] || 'fas fa-file'}"></i>
                    </div>
                    <div class="lesson-info">
                        <div class="lesson-title">${lesson.title}</div>
                        <div class="lesson-meta">
                            <span><i class="fas fa-clock"></i> ${lesson.duration || 0} دقيقة</span>
                            <span class="lesson-status">
                                <span class="status-dot ${statusColors[lesson.status] || 'draft'}"></span>
                                ${getStatusText(lesson.status)}
                            </span>
                            ${lesson.views ? `<span><i class="fas fa-eye"></i> ${lesson.views} مشاهدة</span>` : ''}
                        </div>
                    </div>
                    <div class="lesson-actions">
                        <button class="icon-btn" onclick="previewLesson(${moduleId}, ${lesson.id})" title="معاينة">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="icon-btn" onclick="editLesson(${moduleId}, ${lesson.id})" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="icon-btn" onclick="lessonSettings(${moduleId}, ${lesson.id})" title="إعدادات">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="icon-btn danger" onclick="deleteLesson(${moduleId}, ${lesson.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function getStatusText(status) {
            const statusTexts = {
                published: 'منشور',
                draft: 'مسودة',
                scheduled: 'مجدول'
            };
            return statusTexts[status] || 'مسودة';
        }

        function calculateModuleDuration(module) {
            if (!module.lessons) return 0;
            return module.lessons.reduce((total, lesson) => total + (lesson.duration || 0), 0);
        }

        function updateModuleTitle(moduleId, newTitle) {
            const module = courseData.modules.find(m => m.id === moduleId);
            if (module) {
                module.title = newTitle;
                autoSave();
            }
        }

        function toggleModule(moduleId) {
            const moduleElement = document.querySelector(`[data-module-id="${moduleId}"]`);
            if (moduleElement) {
                moduleElement.classList.toggle('expanded');
                
                const module = courseData.modules.find(m => m.id === moduleId);
                if (module) {
                    module.expanded = moduleElement.classList.contains('expanded');
                    autoSave();
                }
                
                const chevron = moduleElement.querySelector('.fa-chevron-down');
                if (chevron) {
                    chevron.style.transform = moduleElement.classList.contains('expanded') ? 
                        'rotate(180deg)' : 'rotate(0deg)';
                }
            }
        }

        function deleteModule(moduleId) {
            Swal.fire({
                title: 'حذف الوحدة',
                text: 'هل أنت متأكد من حذف هذه الوحدة وجميع دروسها؟',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'حذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: 'var(--danger)'
            }).then((result) => {
                if (result.isConfirmed) {
                    const index = courseData.modules.findIndex(m => m.id === moduleId);
                    if (index > -1) {
                        courseData.modules.splice(index, 1);
                        
                        const moduleElement = document.querySelector(`[data-module-id="${moduleId}"]`);
                        if (moduleElement) {
                            moduleElement.remove();
                        }
                        
                        updateModuleNumbers();
                        updateCurriculumStats();
                        
                        // إظهار empty state إذا لم تعد هناك وحدات
                        if (courseData.modules.length === 0) {
                            const emptyState = document.getElementById('emptyState');
                            if (emptyState) {
                                emptyState.style.display = 'block';
                            }
                        }
                        
                        autoSave();
                    }
                }
            });
        }

        function updateModuleNumbers() {
            const moduleElements = document.querySelectorAll('.module-item');
            moduleElements.forEach((element, index) => {
                const numberEl = element.querySelector('.module-number');
                if (numberEl) {
                    numberEl.textContent = index + 1;
                }
            });
        }

        function showContentTypes(moduleId) {
            const grid = document.getElementById(`content-types-${moduleId}`);
            const button = event.target;
            
            if (grid.classList.contains('show')) {
                grid.classList.remove('show');
                button.innerHTML = '<i class="fas fa-plus"></i> إضافة محتوى جديد';
            } else {
                // إخفاء كل الـ grids الأخرى
                document.querySelectorAll('.content-type-grid').forEach(g => {
                    g.classList.remove('show');
                });
                
                grid.classList.add('show');
                button.innerHTML = '<i class="fas fa-times"></i> إلغاء';
            }
        }

        function addLesson(moduleId, type) {
            Swal.fire({
                title: 'إضافة درس جديد',
                html: `
                    <div style="text-align: right;">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem;">عنوان الدرس</label>
                            <input id="lessonTitle" class="swal2-input" placeholder="أدخل عنوان الدرس" style="text-align: right;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem;">مدة الدرس (بالدقائق)</label>
                            <input id="lessonDuration" type="number" class="swal2-input" placeholder="5" min="1">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem;">وصف مختصر</label>
                            <textarea id="lessonDescription" class="swal2-textarea" placeholder="وصف الدرس..." style="text-align: right;"></textarea>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'إضافة الدرس',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: 'var(--primary)',
                preConfirm: () => {
                    const title = document.getElementById('lessonTitle').value;
                    const duration = document.getElementById('lessonDuration').value;
                    const description = document.getElementById('lessonDescription').value;
                    
                    if (!title) {
                        Swal.showValidationMessage('يرجى إدخال عنوان الدرس');
                        return false;
                    }
                    
                    return { title, duration: parseInt(duration) || 0, description, type };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const module = courseData.modules.find(m => m.id === moduleId);
                    if (module) {
                        const lesson = {
                            id: Date.now(),
                            title: result.value.title,
                            description: result.value.description,
                            type: result.value.type,
                            duration: result.value.duration,
                            status: 'draft',
                            content: '',
                            order: module.lessons.length + 1
                        };
                        
                        module.lessons.push(lesson);
                        
                        // إعادة رندر الوحدة
                        const moduleElement = document.querySelector(`[data-module-id="${moduleId}"]`);
                        if (moduleElement) {
                            const lessonsContainer = moduleElement.querySelector(`#lessons-${moduleId}`);
                            if (lessonsContainer) {
                                lessonsContainer.innerHTML += renderLessonHTML(lesson, moduleId);
                            }
                            
                            // تحديث معلومات الوحدة
                            const metaElement = moduleElement.querySelector('.module-meta');
                            if (metaElement) {
                                metaElement.innerHTML = `
                                    <span><i class="fas fa-video"></i> ${module.lessons.length} دروس</span>
                                    <span><i class="fas fa-clock"></i> ${calculateModuleDuration(module)} دقيقة</span>
                                `;
                            }
                        }
                        
                        updateCurriculumStats();
                        autoSave();
                        
                        // إخفاء الـ content types
                        const grid = document.getElementById(`content-types-${moduleId}`);
                        if (grid) {
                            grid.classList.remove('show');
                        }
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'تم إضافة الدرس',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                }
            });
        }

        function updateCurriculumStats() {
            const modulesCount = document.getElementById('modulesCount');
            const lessonsCount = document.getElementById('lessonsCount');
            const totalDuration = document.getElementById('totalDuration');
            const certificateModules = document.getElementById('certificateModules');
            
            if (modulesCount) {
                modulesCount.textContent = courseData.modules.length;
            }
            
            let lessons = 0;
            let duration = 0;
            let certModules = 0;
            
            courseData.modules.forEach(module => {
                lessons += module.lessons ? module.lessons.length : 0;
                duration += calculateModuleDuration(module);
                if (module.required) certModules++;
            });
            
            if (lessonsCount) {
                lessonsCount.textContent = lessons;
            }
            if (totalDuration) {
                totalDuration.textContent = duration;
            }
            if (certificateModules) {
                certificateModules.textContent = certModules;
            }
        }

        // Initialize Sortable
        function initializeSortable() {
            setTimeout(() => {
                const modulesList = document.getElementById('modulesList');
                if (modulesList && typeof Sortable !== 'undefined') {
                    try {
                        new Sortable(modulesList, {
                            animation: 150,
                            handle: '.drag-handle',
                            ghostClass: 'dragging',
                            onEnd: function() {
                                updateModulesOrder();
                                autoSave();
                            }
                        });
                    } catch (error) {
                        console.warn('Sortable initialization warning:', error);
                    }
                }
            }, 1000);
        }

        function updateModulesOrder() {
            const moduleElements = document.querySelectorAll('.module-item');
            const newOrder = [];
            
            moduleElements.forEach((element, index) => {
                const moduleId = parseInt(element.dataset.moduleId);
                const module = courseData.modules.find(m => m.id === moduleId);
                if (module) {
                    newOrder.push(module);
                }
            });
            
            courseData.modules = newOrder;
            updateModuleNumbers();
        }

        // ========================================
        // UTILITY AND HELPER FUNCTIONS
        // ========================================

        function updateBulkActions() {
            const selected = document.querySelectorAll('.module-checkbox:checked, .lesson-checkbox:checked');
            const bulkActions = document.getElementById('bulkActions');
            
            if (bulkActions) {
                if (selected.length > 0) {
                    bulkActions.style.display = 'flex';
                    const countEl = bulkActions.querySelector('.bulk-count');
                    if (countEl) {
                        countEl.textContent = `${selected.length} محدد`;
                    }
                } else {
                    bulkActions.style.display = 'none';
                }
            }
        }

        function updateSliderValue(slider, targetId) {
            const target = document.getElementById(targetId);
            if (target) {
                target.textContent = slider.value;
            }
        }

        function toggleSwitch(element) {
            element.classList.toggle('active');
        }

        // Toggle Steps Navigation for mobile
        function toggleStepsNav() {
            const stepsNav = document.getElementById('stepsNav');
            if (stepsNav) {
                stepsNav.classList.toggle('active');
            }
        }

        // Template Functions
        function useTemplate(templateType) {
            const templates = {
                introduction: {
                    title: 'وحدة ترحيبية',
                    lessons: [
                        { title: 'مرحباً بك في الدورة', type: 'video', duration: 8 },
                        { title: 'نظرة عامة على المحتوى', type: 'text', duration: 5 },
                        { title: 'كيفية تحقيق أقصى استفادة', type: 'video', duration: 12 }
                    ]
                },
                'theory-practice': {
                    title: 'وحدة نظري + تطبيقي',
                    lessons: [
                        { title: 'محاضرة نظرية', type: 'video', duration: 25 },
                        { title: 'أمثلة عملية', type: 'text', duration: 15 },
                        { title: 'تمارين تطبيقية', type: 'assignment', duration: 30 },
                        { title: 'اختبار تقييمي', type: 'quiz', duration: 20 }
                    ]
                },
                'case-study': {
                    title: 'دراسة حالة',
                    lessons: [
                        { title: 'عرض الحالة', type: 'video', duration: 15 },
                        { title: 'تحليل المشكلة', type: 'text', duration: 20 },
                        { title: 'الحلول المقترحة', type: 'video', duration: 18 },
                        { title: 'النتائج والدروس', type: 'text', duration: 12 }
                    ]
                },
                workshop: {
                    title: 'ورشة عمل',
                    lessons: [
                        { title: 'شرح الأدوات', type: 'video', duration: 20 },
                        { title: 'مشروع عملي', type: 'assignment', duration: 45 },
                        { title: 'متابعة التقدم', type: 'live', duration: 30 },
                        { title: 'عرض النتائج', type: 'video', duration: 15 }
                    ]
                },
                assessment: {
                    title: 'وحدة تقييم',
                    lessons: [
                        { title: 'مراجعة عامة', type: 'text', duration: 15 },
                        { title: 'اختبار نهائي', type: 'quiz', duration: 40 },
                        { title: 'مشروع تطبيقي', type: 'assignment', duration: 60 },
                        { title: 'تقييم الأداء', type: 'text', duration: 10 }
                    ]
                },
                conclusion: {
                    title: 'وحدة ختامية',
                    lessons: [
                        { title: 'ملخص المحتوى', type: 'video', duration: 20 },
                        { title: 'الإنجازات المحققة', type: 'text', duration: 10 },
                        { title: 'الخطوات التالية', type: 'video', duration: 15 },
                        { title: 'مصادر إضافية', type: 'resource', duration: 5 }
                    ]
                }
            };

            const template = templates[templateType];
            if (template) {
                const moduleId = Date.now();
                const module = {
                    id: moduleId,
                    title: template.title,
                    description: '',
                    lessons: template.lessons.map((lesson, index) => ({
                        id: Date.now() + index,
                        ...lesson,
                        status: 'draft',
                        content: '',
                        order: index + 1
                    })),
                    expanded: true,
                    order: courseData.modules.length + 1,
                    duration: template.lessons.reduce((sum, lesson) => sum + lesson.duration, 0)
                };
                
                courseData.modules.push(module);
                renderModule(module);
                updateCurriculumStats();
                autoSave();
                
                Swal.fire({
                    icon: 'success',
                    title: 'تم إضافة القالب',
                    text: `تم إضافة ${template.title} بنجاح`,
                    timer: 1500,
                    showConfirmButton: false
                });
            }
        }

        function addRequirement(type) {
            const containers = {
                prerequisites: document.getElementById('prerequisitesList'),
                tools: document.getElementById('toolsList'),
                materials: document.getElementById('materialsList')
            };
            
            const container = containers[type];
            if (container) {
                const requirementItem = document.createElement('div');
                requirementItem.className = 'requirement-item';
                requirementItem.innerHTML = `
                    <input type="text" 
                           class="form-control requirement-input" 
                           placeholder="أدخل ${type === 'prerequisites' ? 'متطلب' : type === 'tools' ? 'أداة' : 'مادة'}">
                    <button class="icon-btn danger" onclick="removeRequirement(this)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(requirementItem);
                
                // Add event listener
                const input = requirementItem.querySelector('.requirement-input');
                input.addEventListener('input', updateRequirements);
            }
        }

        function removeRequirement(element) {
            element.parentElement.remove();
            updateRequirements();
        }

        function updateRequirements() {
            const types = ['prerequisites', 'tools', 'materials'];
            
            types.forEach(type => {
                const container = document.getElementById(`${type}List`);
                if (container) {
                    const inputs = container.querySelectorAll('.requirement-input');
                    const values = [];
                    inputs.forEach(input => {
                        if (input.value.trim()) {
                            values.push(input.value.trim());
                        }
                    });
                    courseData[type] = values;
                }
            });
            
            autoSave();
        }

        // Export and Import Functions
        function exportCourseData() {
            const dataStr = JSON.stringify(courseData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `course-${courseData.slug || 'data'}-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function importCourseData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            // Merge imported data with current courseData
                            Object.assign(courseData, importedData);
                            updateUIWithCourseData();
                            autoSave();
                            
                            Swal.fire({
                                icon: 'success',
                                title: 'تم الاستيراد',
                                text: 'تم استيراد بيانات الدورة بنجاح',
                                confirmButtonColor: 'var(--primary)'
                            });
                        } catch (error) {
                            Swal.fire({
                                icon: 'error',
                                title: 'خطأ في الاستيراد',
                                text: 'ملف JSON غير صالح',
                                confirmButtonColor: 'var(--primary)'
                            });
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Lesson Management Functions
        function editLesson(moduleId, lessonId) {
            const module = courseData.modules.find(m => m.id === moduleId);
            if (!module) return;
            
            const lesson = module.lessons.find(l => l.id === lessonId);
            if (!lesson) return;
            
            Swal.fire({
                title: 'تعديل الدرس',
                html: `
                    <div style="text-align: right;">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem;">عنوان الدرس</label>
                            <input id="editLessonTitle" class="swal2-input" value="${lesson.title}" style="text-align: right;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem;">مدة الدرس (بالدقائق)</label>
                            <input id="editLessonDuration" type="number" class="swal2-input" value="${lesson.duration || 0}" min="1">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem;">وصف الدرس</label>
                            <textarea id="editLessonDescription" class="swal2-textarea" style="text-align: right;">${lesson.description || ''}</textarea>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'حفظ التغييرات',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: 'var(--primary)',
                preConfirm: () => {
                    const title = document.getElementById('editLessonTitle').value;
                    const duration = document.getElementById('editLessonDuration').value;
                    const description = document.getElementById('editLessonDescription').value;
                    
                    if (!title) {
                        Swal.showValidationMessage('يرجى إدخال عنوان الدرس');
                        return false;
                    }
                    
                    return { title, duration: parseInt(duration) || 0, description };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    lesson.title = result.value.title;
                    lesson.duration = result.value.duration;
                    lesson.description = result.value.description;
                    
                    // Re-render the module
                    const moduleElement = document.querySelector(`[data-module-id="${moduleId}"]`);
                    if (moduleElement) {
                        const lessonsContainer = moduleElement.querySelector(`#lessons-${moduleId}`);
                        if (lessonsContainer) {
                            lessonsContainer.innerHTML = module.lessons.map(l => renderLessonHTML(l, moduleId)).join('');
                        }
                        
                        // Update module meta
                        const metaElement = moduleElement.querySelector('.module-meta');
                        if (metaElement) {
                            metaElement.innerHTML = `
                                <span><i class="fas fa-video"></i> ${module.lessons.length} دروس</span>
                                <span><i class="fas fa-clock"></i> ${calculateModuleDuration(module)} دقيقة</span>
                            `;
                        }
                    }
                    
                    updateCurriculumStats();
                    autoSave();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'تم التحديث',
                        text: 'تم تحديث الدرس بنجاح',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        }

        function deleteLesson(moduleId, lessonId) {
            const module = courseData.modules.find(m => m.id === moduleId);
            if (!module) return;
            
            Swal.fire({
                title: 'حذف الدرس',
                text: 'هل أنت متأكد من حذف هذا الدرس؟',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'حذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: 'var(--danger)'
            }).then((result) => {
                if (result.isConfirmed) {
                    const lessonIndex = module.lessons.findIndex(l => l.id === lessonId);
                    if (lessonIndex > -1) {
                        module.lessons.splice(lessonIndex, 1);
                        
                        // Re-render the module
                        const moduleElement = document.querySelector(`[data-module-id="${moduleId}"]`);
                        if (moduleElement) {
                            const lessonsContainer = moduleElement.querySelector(`#lessons-${moduleId}`);
                            if (lessonsContainer) {
                                lessonsContainer.innerHTML = module.lessons.map(l => renderLessonHTML(l, moduleId)).join('');
                            }
                            
                            // Update module meta
                            const metaElement = moduleElement.querySelector('.module-meta');
                            if (metaElement) {
                                metaElement.innerHTML = `
                                    <span><i class="fas fa-video"></i> ${module.lessons.length} دروس</span>
                                    <span><i class="fas fa-clock"></i> ${calculateModuleDuration(module)} دقيقة</span>
                                `;
                            }
                        }
                        
                        updateCurriculumStats();
                        autoSave();
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'تم الحذف',
                            text: 'تم حذف الدرس بنجاح',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                }
            });
        }

        function previewLesson(moduleId, lessonId) {
            Swal.fire({
                icon: 'info',
                title: 'معاينة الدرس',
                text: 'ميزة المعاينة ستكون متاحة قريباً',
                confirmButtonColor: 'var(--primary)'
            });
        }

        function lessonSettings(moduleId, lessonId) {
            Swal.fire({
                icon: 'info',
                title: 'إعدادات الدرس',
                text: 'إعدادات الدرس المتقدمة ستكون متاحة قريباً',
                confirmButtonColor: 'var(--primary)'
            });
        }

        function editModule(moduleId) {
            Swal.fire({
                icon: 'info',
                title: 'إعدادات الوحدة',
                text: 'إعدادات الوحدة المتقدمة ستكون متاحة قريباً',
                confirmButtonColor: 'var(--primary)'
            });
        }

        // ========================================
        // GLOBAL FUNCTION ASSIGNMENTS
        // ========================================

        // تأكد من أن جميع الدوال متاحة globally
        window.showStep = showStep;
        window.saveAndNext = saveAndNext;
        window.goBack = goBack;
        window.previewCourse = previewCourse;
        window.publishCourse = publishCourse;
        window.finalizeAndPublish = finalizeAndPublish;
        window.saveDraft = saveDraft;
        window.saveCourseData = saveCourseData;
        window.updateProgress = updateProgress;
        window.selectPriceType = selectPriceType;
        window.addCoupon = addCoupon;
        window.removeCoupon = removeCoupon;
        window.selectAccessType = selectAccessType;
        window.addModule = addModule;
        window.renderModule = renderModule;
        window.showContentTypes = showContentTypes;
        window.addLesson = addLesson;
        window.editLesson = editLesson;
        window.deleteLesson = deleteLesson;
        window.previewLesson = previewLesson;
        window.lessonSettings = lessonSettings;
        window.editModule = editModule;
        window.updateModuleTitle = updateModuleTitle;
        window.toggleModule = toggleModule;
        window.deleteModule = deleteModule;
        window.addObjective = addObjective;
        window.removeObjective = removeObjective;
        window.uploadCourseImage = uploadCourseImage;
        window.uploadInstructorImage = uploadInstructorImage;
        window.selectImageFile = selectImageFile;
        window.enterImageUrl = enterImageUrl;
        window.updateObjectives = updateObjectives;
        window.renderCoupons = renderCoupons;
        window.renderLessonHTML = renderLessonHTML;
        window.getLessonTypeLabel = getLessonTypeLabel;
        window.showLessonEditor = showLessonEditor;
        window.displayCourseImage = displayCourseImage;
        window.displayInstructorImage = displayInstructorImage;
        window.handleImageFile = handleImageFile;
        window.toggleSwitch = toggleSwitch;
        window.updateSliderValue = updateSliderValue;
        window.toggleStepsNav = toggleStepsNav;
        window.useTemplate = useTemplate;
        window.addRequirement = addRequirement;
        window.removeRequirement = removeRequirement;
        window.exportCourseData = exportCourseData;
        window.importCourseData = importCourseData;
        window.selectReleaseStrategy = selectReleaseStrategy;
        window.selectProgressMethod = selectProgressMethod;
        window.selectAccessMethod = selectAccessMethod;
        window.selectDifficulty = selectDifficulty;
        window.updatePublishingReadiness = updatePublishingReadiness;
        window.updateSEOPreview = updateSEOPreview;
        window.selectDripStrategy = selectDripStrategy;
        window.customizeCertificate = customizeCertificate;
        window.updateCertificatePreview = updateCertificatePreview;
        
    </script>
</body>
</html>
