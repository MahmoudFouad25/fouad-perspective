function saveDraft() {
            // حفظ البيانات في localStorage
            const draft = {
                userData: userData,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('userDraft', JSON.stringify(draft));
            
            showSuccess('تم حفظ المسودة');
        }

        // تحميل المسودة إن وجدت
        function loadDraft() {
            const draftStr = localStorage.getItem('userDraft');
            if (draftStr) {
                try {
                    const draft = JSON.parse(draftStr);
                    const draftDate = new Date(draft.timestamp);
                    const now = new Date();
                    const hoursDiff = (now - draftDate) / (1000 * 60 * 60);
                    
                    // إذا كانت المسودة أقل من 24 ساعة
                    if (hoursDiff < 24) {
                        Swal.fire({
                            title: 'يوجد مسودة محفوظة',
                            text: `آخر حفظ: ${draftDate.toLocaleString('ar-SA')}`,
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonText: 'استعادة',
                            cancelButtonText: 'تجاهل',
                            confirmButtonColor: '#f4c430'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                restoreDraft(draft.userData);
                            } else {
                                localStorage.removeItem('userDraft');
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading draft:', error);
                }
            }
        }

        function restoreDraft(draftData) {
            userData = { ...userData, ...draftData };
            
            // ملء النموذج
            document.getElementById('fullName').value = draftData.name || '';
            document.getElementById('email').value = draftData.email || '';
            document.getElementById('countryCode').value = draftData.countryCode || '+20';
            document.getElementById('whatsapp').value = draftData.whatsapp ? draftData.whatsapp.replace(draftData.countryCode, '') : '';
            document.getElementById('occupation').value = draftData.occupation || '';
            document.getElementById('maritalStatus').value = draftData.maritalStatus || '';
            document.getElementById('birthDate').value = draftData.birthDate || '';
            document.getElementById('userNotes').value = draftData.userNotes || '';
            document.getElementById('password').value = draftData.password || '';
            document.getElementById('isActive').checked = draftData.isActive !== false;
            
            // الصورة
            if (draftData.avatarUrl) {
                displayAvatar(draftData.avatarUrl);
            }
            
            showSuccess('تم استعادة المسودة');
        }

        // دالة إرسال واتساب (للاستخدام لاحقاً في صفحة أخرى)
        function prepareWhatsAppMessage(user) {
            const message = `
مرحباً ${user.name} 👋

تم إنشاء حسابك في منظور الفؤاد بنجاح!

📧 البريد الإلكتروني: ${user.email}
🔑 كلمة المرور: ${user.credentials.password}

🔗 رابط الدخول:
https://mahmoudfouad25.github.io/fouad-perspective/login

✨ الدورات المخصصة لك:
${user.enrollments && user.enrollments.length > 0 ? 
    user.enrollments.map(e => `• ${e.courseName}`).join('\n') : 
    '• لم يتم تخصيص دورات بعد'
}

للدعم والمساعدة، تواصل معنا على هذا الرقم.

مع تحيات فريق منظور الفؤاد 🌟
            `.trim();
            
            return message;
        }

        // رسائل النظام
        function showSuccess(message) {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
            
            Toast.fire({
                icon: 'success',
                title: message
            });
        }

        function showError(message) {
            Swal.fire({
                icon: 'error',
                title: 'خطأ',
                text: message,
                confirmButtonColor: '#f4c430'
            });
        }

        function goBack() {
            if (userData.name || userData.email || userData.password) {
                Swal.fire({
                    title: 'هل تريد المغادرة؟',
                    text: 'سيتم فقدان البيانات غير المحفوظة',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'مغادرة',
                    cancelButtonText: 'البقاء',
                    confirmButtonColor: '#f4c430'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = './users.html';
                    }
                });
            } else {
                window.location.href = './users.html';
            }
        }

        // اختصارات لوحة المفاتيح
        document.addEventListener('keydown', function(e) {
            // Ctrl + S للحفظ كمسودة
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveDraft();
            }
            
            // Enter للانتقال للقسم التالي
            if (e.key === 'Enter' && !e.shiftKey && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                if (currentSection !== 'summary' && currentSection !== 'success') {
                    nextSection();
                }
            }
        });

        // التحقق من التغييرات قبل مغادرة الصفحة
        window.addEventListener('beforeunload', function(e) {
            if (userData.name || userData.email || userData.password) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // تحميل المسودة عند بدء الصفحة (فقط في وضع الإنشاء)
        if (!isEditMode) {
            setTimeout(loadDraft, 500);
        }

        // تنظيف عند النجاح
        function cleanupAfterSuccess() {
            // حذف المسودة
            localStorage.removeItem('userDraft');
            
            // إزالة مستمع التغييرات
            window.removeEventListener('beforeunload', function() {});
        }

        // إضافة تأثيرات بصرية للحقول
        document.querySelectorAll('.form-control').forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.classList.add('focused');
            });
            
            input.addEventListener('blur', function() {
                this.parentElement.classList.remove('focused');
                
                // حفظ تلقائي عند مغادرة الحقل
                if (this.value) {
                    saveDraft();
                }
            });
        });

        // معالج خاص لحقل الواتساب
        document.getElementById('whatsapp').addEventListener('input', function(e) {
            // السماح بالأرقام فقط
            let value = e.target.value.replace(/\D/g, '');
            e.target.value = value;
            
            // تحديث البيانات
            userData.whatsapp = userData.countryCode + value;
        });

        // تهيئة الصفحة بالكامل
        function initializePage() {
            // تعيين التاريخ الحالي كحد أقصى لتاريخ الميلاد
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('birthDate').max = today;
            
            // تركيز على أول حقل
            setTimeout(() => {
                document.getElementById('fullName').focus();
            }, 300);
            
            // إظهار مؤشر الحفظ
            setInterval(() => {
                if (userData.name || userData.email) {
                    const indicator = document.getElementById('saveIndicator');
                    indicator.style.display = 'flex';
                    setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 2000);
                }
            }, 60000); // كل دقيقة
        }

        // استدعاء التهيئة
        initializePage();
    </script>
</body>
</html>
