function saveDraft() {
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage
            const draft = {
                userData: userData,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('userDraft', JSON.stringify(draft));
            
            showSuccess('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©');
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
        function loadDraft() {
            const draftStr = localStorage.getItem('userDraft');
            if (draftStr) {
                try {
                    const draft = JSON.parse(draftStr);
                    const draftDate = new Date(draft.timestamp);
                    const now = new Date();
                    const hoursDiff = (now - draftDate) / (1000 * 60 * 60);
                    
                    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø£Ù‚Ù„ Ù…Ù† 24 Ø³Ø§Ø¹Ø©
                    if (hoursDiff < 24) {
                        Swal.fire({
                            title: 'ÙŠÙˆØ¬Ø¯ Ù…Ø³ÙˆØ¯Ø© Ù…Ø­ÙÙˆØ¸Ø©',
                            text: `Ø¢Ø®Ø± Ø­ÙØ¸: ${draftDate.toLocaleString('ar-SA')}`,
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonText: 'Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
                            cancelButtonText: 'ØªØ¬Ø§Ù‡Ù„',
                            confirmButtonColor: '#f4c430'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                restoreDraft(draft.userData);
                            } else {
                                localStorage.removeItem('userDraft');
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading draft:', error);
                }
            }
        }

        function restoreDraft(draftData) {
            userData = { ...userData, ...draftData };
            
            // Ù…Ù„Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            document.getElementById('fullName').value = draftData.name || '';
            document.getElementById('email').value = draftData.email || '';
            document.getElementById('countryCode').value = draftData.countryCode || '+20';
            document.getElementById('whatsapp').value = draftData.whatsapp ? draftData.whatsapp.replace(draftData.countryCode, '') : '';
            document.getElementById('occupation').value = draftData.occupation || '';
            document.getElementById('maritalStatus').value = draftData.maritalStatus || '';
            document.getElementById('birthDate').value = draftData.birthDate || '';
            document.getElementById('userNotes').value = draftData.userNotes || '';
            document.getElementById('password').value = draftData.password || '';
            document.getElementById('isActive').checked = draftData.isActive !== false;
            
            // Ø§Ù„ØµÙˆØ±Ø©
            if (draftData.avatarUrl) {
                displayAvatar(draftData.avatarUrl);
            }
            
            showSuccess('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ÙˆØ¯Ø©');
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹ ÙÙŠ ØµÙØ­Ø© Ø£Ø®Ø±Ù‰)
        function prepareWhatsAppMessage(user) {
            const message = `
Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user.name} ğŸ‘‹

ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ Ù…Ù†Ø¸ÙˆØ± Ø§Ù„ÙØ¤Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!

ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ${user.email}
ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: ${user.credentials.password}

ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø®ÙˆÙ„:
https://mahmoudfouad25.github.io/fouad-perspective/login

âœ¨ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ùƒ:
${user.enrollments && user.enrollments.length > 0 ? 
    user.enrollments.map(e => `â€¢ ${e.courseName}`).join('\n') : 
    'â€¢ Ù„Ù… ÙŠØªÙ… ØªØ®ØµÙŠØµ Ø¯ÙˆØ±Ø§Øª Ø¨Ø¹Ø¯'
}

Ù„Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©ØŒ ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù….

Ù…Ø¹ ØªØ­ÙŠØ§Øª ÙØ±ÙŠÙ‚ Ù…Ù†Ø¸ÙˆØ± Ø§Ù„ÙØ¤Ø§Ø¯ ğŸŒŸ
            `.trim();
            
            return message;
        }

        // Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…
        function showSuccess(message) {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
            
            Toast.fire({
                icon: 'success',
                title: message
            });
        }

        function showError(message) {
            Swal.fire({
                icon: 'error',
                title: 'Ø®Ø·Ø£',
                text: message,
                confirmButtonColor: '#f4c430'
            });
        }

        function goBack() {
            if (userData.name || userData.email || userData.password) {
                Swal.fire({
                    title: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ',
                    text: 'Ø³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ù…ØºØ§Ø¯Ø±Ø©',
                    cancelButtonText: 'Ø§Ù„Ø¨Ù‚Ø§Ø¡',
                    confirmButtonColor: '#f4c430'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = './users.html';
                    }
                });
            } else {
                window.location.href = './users.html';
            }
        }

        // Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        document.addEventListener('keydown', function(e) {
            // Ctrl + S Ù„Ù„Ø­ÙØ¸ ÙƒÙ…Ø³ÙˆØ¯Ø©
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveDraft();
            }
            
            // Enter Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù‚Ø³Ù… Ø§Ù„ØªØ§Ù„ÙŠ
            if (e.key === 'Enter' && !e.shiftKey && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                if (currentSection !== 'summary' && currentSection !== 'success') {
                    nextSection();
                }
            }
        });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù‚Ø¨Ù„ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', function(e) {
            if (userData.name || userData.email || userData.password) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø© (ÙÙ‚Ø· ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡)
        if (!isEditMode) {
            setTimeout(loadDraft, 500);
        }

        // ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
        function cleanupAfterSuccess() {
            // Ø­Ø°Ù Ø§Ù„Ù…Ø³ÙˆØ¯Ø©
            localStorage.removeItem('userDraft');
            
            // Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            window.removeEventListener('beforeunload', function() {});
        }

        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ© Ù„Ù„Ø­Ù‚ÙˆÙ„
        document.querySelectorAll('.form-control').forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.classList.add('focused');
            });
            
            input.addEventListener('blur', function() {
                this.parentElement.classList.remove('focused');
                
                // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø­Ù‚Ù„
                if (this.value) {
                    saveDraft();
                }
            });
        });

        // Ù…Ø¹Ø§Ù„Ø¬ Ø®Ø§Øµ Ù„Ø­Ù‚Ù„ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
        document.getElementById('whatsapp').addEventListener('input', function(e) {
            // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
            let value = e.target.value.replace(/\D/g, '');
            e.target.value = value;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            userData.whatsapp = userData.countryCode + value;
        });

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        function initializePage() {
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('birthDate').max = today;
            
            // ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø£ÙˆÙ„ Ø­Ù‚Ù„
            setTimeout(() => {
                document.getElementById('fullName').focus();
            }, 300);
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„Ø­ÙØ¸
            setInterval(() => {
                if (userData.name || userData.email) {
                    const indicator = document.getElementById('saveIndicator');
                    indicator.style.display = 'flex';
                    setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 2000);
                }
            }, 60000); // ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
        }

        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
        initializePage();
    </script>
</body>
</html>
