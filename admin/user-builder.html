<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="إنشاء وإدارة المستخدمين - منظور الفؤاد">
    <meta name="keywords" content="إدارة المستخدمين, منظور الفؤاد, لوحة التحكم">
    <meta name="author" content="منظور الفؤاد">
    
    <title>إنشاء مستخدم جديد - منظور الفؤاد</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/MahmoudFouad25/fouad-perspective/main/media/images/favicon.png">
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts - Noto Kufi Arabic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 للتنبيهات الجميلة -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Sortable.js للسحب والإفلات -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <!-- Chart.js للرسوم البيانية -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom CSS -->
    <style>
/* ==================== متغيرات CSS الأساسية ==================== */
        :root {
            /* الألوان الأساسية */
            --primary: #f4c430;
            --primary-dark: #e6b429;
            --primary-light: #ffd54f;
            --primary-rgb: 244, 196, 48;
            
            --secondary: #2196f3;
            --secondary-dark: #1976d2;
            --secondary-light: #64b5f6;
            --secondary-rgb: 33, 150, 243;
            
            /* ألوان الحالات */
            --success: #4caf50;
            --success-dark: #388e3c;
            --success-light: #81c784;
            --success-rgb: 76, 175, 80;
            
            --danger: #f44336;
            --danger-dark: #d32f2f;
            --danger-light: #ef5350;
            --danger-rgb: 244, 67, 54;
            
            --warning: #ff9800;
            --warning-dark: #f57c00;
            --warning-light: #ffb74d;
            --warning-rgb: 255, 152, 0;
            
            --info: #00bcd4;
            --info-dark: #0097a7;
            --info-light: #4dd0e1;
            --info-rgb: 0, 188, 212;
            
            /* ألوان الخلفيات */
            --dark: #1a1a1a;
            --darker: #0f0f0f;
            --light: #2a2a2a;
            --lighter: #3a3a3a;
            --lightest: #4a4a4a;
            
            /* ألوان النصوص */
            --text: #e0e0e0;
            --text-muted: #999;
            --text-light: #bbb;
            --text-dark: #666;
            
            /* ألوان إضافية */
            --border: rgba(255, 255, 255, 0.1);
            --border-light: rgba(255, 255, 255, 0.2);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            --shadow-sm: 0 2px 10px rgba(0, 0, 0, 0.3);
            
            /* القياسات */
            --radius: 12px;
            --radius-sm: 8px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            
            /* الحركات */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s ease-in-out;
            --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* أحجام الخطوط */
            --font-xs: 0.75rem;
            --font-sm: 0.875rem;
            --font-base: 1rem;
            --font-lg: 1.125rem;
            --font-xl: 1.25rem;
            --font-2xl: 1.5rem;
            --font-3xl: 1.875rem;
            --font-4xl: 2.25rem;
            
            /* المسافات */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            --spacing-3xl: 4rem;
            
            /* Z-Index */
            --z-dropdown: 1000;
            --z-sticky: 1020;
            --z-fixed: 1030;
            --z-modal-backdrop: 1040;
            --z-modal: 1050;
            --z-popover: 1060;
            --z-tooltip: 1070;
        }
        
        /* ==================== الأنماط العامة ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Kufi Arabic', sans-serif;
            background: var(--darker);
            color: var(--text);
            line-height: 1.6;
            font-size: var(--font-base);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        /* تحسين مظهر التحديد */
        ::selection {
            background: var(--primary);
            color: var(--dark);
        }
        
        /* Scrollbar مخصص */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--dark);
            border-radius: var(--radius-sm);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--lighter);
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        /* Firefox Scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--lighter) var(--dark);
        }
        
        /* ==================== أنماط العناصر الأساسية ==================== */
        
        /* الروابط */
        a {
            color: var(--primary);
            text-decoration: none;
            transition: var(--transition);
        }
        
        a:hover {
            color: var(--primary-light);
        }
        
        /* العناوين */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            line-height: 1.3;
            margin-bottom: var(--spacing-md);
        }
        
        h1 { font-size: var(--font-4xl); }
        h2 { font-size: var(--font-3xl); }
        h3 { font-size: var(--font-2xl); }
        h4 { font-size: var(--font-xl); }
        h5 { font-size: var(--font-lg); }
        h6 { font-size: var(--font-base); }
        
        /* الفقرات */
        p {
            margin-bottom: var(--spacing-md);
        }
        
        /* القوائم */
        ul, ol {
            margin-bottom: var(--spacing-md);
            padding-right: var(--spacing-xl);
        }
        
        /* التركيز على العناصر */
        :focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        /* إخفاء outline للماوس، إظهاره للكيبورد */
        :focus:not(:focus-visible) {
            outline: none;
        }
        
        /* ==================== فئات المساعدة ==================== */
        
        /* إخفاء العناصر */
        .hidden { display: none !important; }
        .invisible { visibility: hidden !important; }
        
        /* المحاذاة */
        .text-center { text-align: center !important; }
        .text-right { text-align: right !important; }
        .text-left { text-align: left !important; }
        
        /* الألوان */
        .text-primary { color: var(--primary) !important; }
        .text-secondary { color: var(--secondary) !important; }
        .text-success { color: var(--success) !important; }
        .text-danger { color: var(--danger) !important; }
        .text-warning { color: var(--warning) !important; }
        .text-info { color: var(--info) !important; }
        .text-muted { color: var(--text-muted) !important; }
        
        /* الخلفيات */
        .bg-primary { background-color: var(--primary) !important; }
        .bg-secondary { background-color: var(--secondary) !important; }
        .bg-success { background-color: var(--success) !important; }
        .bg-danger { background-color: var(--danger) !important; }
        .bg-warning { background-color: var(--warning) !important; }
        .bg-info { background-color: var(--info) !important; }
        .bg-dark { background-color: var(--dark) !important; }
        .bg-light { background-color: var(--light) !important; }
        
        /* المسافات */
        .mt-0 { margin-top: 0 !important; }
        .mt-1 { margin-top: var(--spacing-xs) !important; }
        .mt-2 { margin-top: var(--spacing-sm) !important; }
        .mt-3 { margin-top: var(--spacing-md) !important; }
        .mt-4 { margin-top: var(--spacing-lg) !important; }
        .mt-5 { margin-top: var(--spacing-xl) !important; }
        
        .mb-0 { margin-bottom: 0 !important; }
        .mb-1 { margin-bottom: var(--spacing-xs) !important; }
        .mb-2 { margin-bottom: var(--spacing-sm) !important; }
        .mb-3 { margin-bottom: var(--spacing-md) !important; }
        .mb-4 { margin-bottom: var(--spacing-lg) !important; }
        .mb-5 { margin-bottom: var(--spacing-xl) !important; }
        
        .p-0 { padding: 0 !important; }
        .p-1 { padding: var(--spacing-xs) !important; }
        .p-2 { padding: var(--spacing-sm) !important; }
        .p-3 { padding: var(--spacing-md) !important; }
        .p-4 { padding: var(--spacing-lg) !important; }
        .p-5 { padding: var(--spacing-xl) !important; }
        
        /* الظلال */
        .shadow { box-shadow: var(--shadow) !important; }
        .shadow-sm { box-shadow: var(--shadow-sm) !important; }
        .shadow-none { box-shadow: none !important; }
        
        /* الحدود */
        .border { border: 1px solid var(--border) !important; }
        .border-0 { border: 0 !important; }
        .rounded { border-radius: var(--radius) !important; }
        .rounded-sm { border-radius: var(--radius-sm) !important; }
        .rounded-lg { border-radius: var(--radius-lg) !important; }
        .rounded-xl { border-radius: var(--radius-xl) !important; }
        .rounded-circle { border-radius: 50% !important; }
        
        /* Flexbox */
        .d-flex { display: flex !important; }
        .flex-column { flex-direction: column !important; }
        .flex-row { flex-direction: row !important; }
        .justify-content-center { justify-content: center !important; }
        .justify-content-between { justify-content: space-between !important; }
        .justify-content-around { justify-content: space-around !important; }
        .align-items-center { align-items: center !important; }
        .align-items-start { align-items: flex-start !important; }
        .align-items-end { align-items: flex-end !important; }
        .flex-wrap { flex-wrap: wrap !important; }
        .flex-1 { flex: 1 !important; }
        .gap-1 { gap: var(--spacing-xs) !important; }
        .gap-2 { gap: var(--spacing-sm) !important; }
        .gap-3 { gap: var(--spacing-md) !important; }
        .gap-4 { gap: var(--spacing-lg) !important; }
        .gap-5 { gap: var(--spacing-xl) !important; }
        
        /* Grid */
        .d-grid { display: grid !important; }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr) !important; }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr) !important; }
        .grid-cols-4 { grid-template-columns: repeat(4, 1fr) !important; }
        
        /* العرض */
        .w-100 { width: 100% !important; }
        .w-auto { width: auto !important; }
        .h-100 { height: 100% !important; }
        .h-auto { height: auto !important; }
        
        /* الموضع */
        .position-relative { position: relative !important; }
        .position-absolute { position: absolute !important; }
        .position-fixed { position: fixed !important; }
        .position-sticky { position: sticky !important; }
        
        /* ==================== Animations ==================== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .animate-fadeIn { animation: fadeIn 0.3s ease-in-out; }
        .animate-slideIn { animation: slideIn 0.3s ease-in-out; }
        .animate-pulse { animation: pulse 2s infinite; }
        .animate-spin { animation: spin 1s linear infinite; }
/* ==================== Loading Overlay ==================== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            margin: 0 auto var(--spacing-lg);
            position: relative;
        }

        .spinner-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 3px solid transparent;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
        }

        .spinner-ring:nth-child(2) {
            width: 60px;
            height: 60px;
            top: 10px;
            left: 10px;
            border-top-color: var(--secondary);
            animation-duration: 1s;
        }

        .spinner-ring:nth-child(3) {
            width: 40px;
            height: 40px;
            top: 20px;
            left: 20px;
            border-top-color: var(--success);
            animation-duration: 0.5s;
        }

        .loading-text {
            color: var(--primary);
            margin-bottom: var(--spacing-sm);
        }

        .loading-subtext {
            color: var(--text-muted);
            font-size: var(--font-sm);
        }

        /* ==================== Auto Save Indicator ==================== */
        .auto-save-indicator {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--success);
            color: white;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow);
            transition: var(--transition);
            z-index: var(--z-fixed);
        }

        .auto-save-indicator.show {
            transform: translateX(-50%) translateY(0);
        }

        /* ==================== Header ==================== */
        .main-header {
            background: var(--dark);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
            box-shadow: var(--shadow-sm);
        }

        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md) var(--spacing-xl);
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-left,
        .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .menu-toggle {
            background: none;
            border: none;
            color: var(--text);
            font-size: var(--font-xl);
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .menu-toggle:hover {
            background: var(--lighter);
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .header-logo img {
            height: 40px;
            width: auto;
        }

        .logo-text {
            font-size: var(--font-xl);
            font-weight: 600;
            color: var(--primary);
        }

        /* ==================== Breadcrumb ==================== */
        .breadcrumb {
            flex: 1;
        }

        .breadcrumb-list {
            display: flex;
            align-items: center;
            list-style: none;
            padding: 0;
            margin: 0;
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
        }

        .breadcrumb-item a {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            color: var(--text-muted);
            transition: var(--transition);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
        }

        .breadcrumb-item a:hover {
            color: var(--primary);
            background: rgba(var(--primary-rgb), 0.1);
        }

        .breadcrumb-item.active {
            color: var(--text);
            font-weight: 500;
        }

        .breadcrumb-separator {
            color: var(--text-dark);
            margin: 0 var(--spacing-xs);
            font-size: var(--font-sm);
        }

        /* ==================== Header Icons ==================== */
        .icon-btn {
            background: none;
            border: none;
            color: var(--text);
            font-size: var(--font-lg);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .icon-btn:hover {
            background: var(--lighter);
            color: var(--primary);
        }

        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--danger);
            color: white;
            font-size: var(--font-xs);
            padding: 2px 6px;
            border-radius: var(--radius-xl);
            font-weight: 600;
        }

        /* ==================== User Menu ==================== */
        .user-menu-toggle {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: var(--lighter);
            border: none;
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: var(--transition);
        }

        .user-menu-toggle:hover {
            background: rgba(var(--primary-rgb), 0.1);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-name {
            color: var(--text);
            font-weight: 500;
        }

        /* ==================== Main Container ==================== */
        .main-container {
            display: flex;
            min-height: calc(100vh - 65px);
        }

        /* ==================== Sidebar ==================== */
        .sidebar {
            width: 260px;
            background: var(--dark);
            border-left: 1px solid var(--border);
            overflow-y: auto;
            transition: var(--transition);
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .nav-list {
            list-style: none;
            padding: var(--spacing-md) 0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md) var(--spacing-lg);
            color: var(--text-light);
            transition: var(--transition);
            position: relative;
        }

        .nav-link:hover {
            background: var(--lighter);
            color: var(--primary);
        }

        .nav-item.active .nav-link {
            background: rgba(var(--primary-rgb), 0.1);
            color: var(--primary);
        }

        .nav-item.active .nav-link::before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary);
        }

        .sidebar.collapsed .nav-link span {
            display: none;
        }

        /* ==================== Main Content ==================== */
        .main-content {
            flex: 1;
            background: var(--darker);
            overflow-y: auto;
            padding: var(--spacing-xl);
        }

        /* ==================== Page Header ==================== */
        .page-header {
            background: var(--dark);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-sm);
        }

        .page-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-lg);
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            color: var(--primary);
            margin-bottom: var(--spacing-sm);
        }

        .page-subtitle {
            color: var(--text-muted);
            margin: 0;
        }

        .page-header-right {
            display: flex;
            gap: var(--spacing-md);
        }

        /* ==================== Progress Bar ==================== */
        .progress-container {
            background: var(--dark);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }

        .progress-bar {
            height: 8px;
            background: var(--lighter);
            border-radius: var(--radius-xl);
            overflow: hidden;
            margin-bottom: var(--spacing-xl);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            transition: width 0.5s ease;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
        }

        .progress-step {
            text-align: center;
            position: relative;
            flex: 1;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            background: var(--lighter);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--spacing-sm);
            font-weight: 600;
            transition: var(--transition);
        }

        .progress-step.active .step-circle {
            background: var(--primary);
            color: var(--dark);
        }

        .progress-step.completed .step-circle {
            background: var(--success);
            color: white;
        }

        .step-label {
            font-size: var(--font-sm);
            color: var(--text-muted);
        }

        .progress-step.active .step-label {
            color: var(--primary);
            font-weight: 500;
        }

        /* ==================== Tabs ==================== */
        .tabs-container {
            background: var(--dark);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-sm);
        }

        .tabs-nav {
            background: var(--lighter);
            padding: var(--spacing-sm);
        }

        .tabs-list {
            display: flex;
            list-style: none;
            gap: var(--spacing-sm);
            margin: 0;
            padding: 0;
        }

        .tab-link {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: var(--font-base);
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            white-space: nowrap;
        }

        .tab-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
        }

        .tab-link.active {
            background: var(--dark);
            color: var(--primary);
        }

        .tab-panels {
            padding: var(--spacing-xl);
            min-height: 400px;
        }

        /* ==================== Panel Styles ==================== */
        .tab-panel {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-panel.active {
            display: block;
        }

        .panel-header {
            margin-bottom: var(--spacing-2xl);
            padding-bottom: var(--spacing-lg);
            border-bottom: 1px solid var(--border);
        }

        .panel-title {
            color: var(--primary);
            font-size: var(--font-2xl);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .panel-description {
            color: var(--text-muted);
            font-size: var(--font-base);
            margin: 0;
        }

        /* ==================== Form Actions ==================== */
        .form-actions {
            background: var(--dark);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--spacing-lg);
            position: sticky;
            bottom: var(--spacing-xl);
            box-shadow: var(--shadow);
        }

        .actions-left,
        .actions-right {
            display: flex;
            gap: var(--spacing-md);
        }

        /* ==================== Buttons ==================== */
        .btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-sm);
            font-size: var(--font-base);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-family: inherit;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--dark);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(var(--primary-rgb), 0.4);
        }

        .btn-secondary {
            background: var(--lighter);
            color: var(--text);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--lightest);
        }

        .btn-outline {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        .btn-outline:hover:not(:disabled) {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(var(--primary-rgb), 0.1);
        }

        .btn-sm {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: var(--font-sm);
        }
/* ==================== Form Grid ==================== */
        .form-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: var(--spacing-2xl);
        }

        .form-section {
            background: var(--lighter);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
        }

        .section-title {
            font-size: var(--font-lg);
            color: var(--text);
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        /* ==================== Avatar Section ==================== */
        .avatar-section {
            text-align: center;
        }

        .avatar-upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .avatar-preview {
            width: 180px;
            height: 180px;
            position: relative;
            border-radius: 50%;
            overflow: hidden;
            background: var(--dark);
            border: 4px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
        }

        .avatar-preview:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: var(--text-dark);
        }

        .avatar-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
            padding: var(--spacing-lg) var(--spacing-md) var(--spacing-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
            color: white;
            opacity: 0;
            transition: var(--transition);
        }

        .avatar-preview:hover .avatar-overlay {
            opacity: 1;
        }

        .avatar-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .avatar-info {
            text-align: center;
        }

        .avatar-info p {
            margin: var(--spacing-xs) 0;
        }
        /* ==================== زرار البيانات ==================== */
        .whatsapp-actions {
    background: var(--lighter);
    padding: var(--spacing-lg);
    border-radius: var(--radius-lg);
}

.whatsapp-actions h4 {
    color: var(--text);
    font-size: var(--font-lg);
    margin-bottom: var(--spacing-md);
}

.whatsapp-actions .form-actions {
    margin-top: var(--spacing-md);
}

.btn-success {
    background: #25d366;
    color: white;
}

.btn-success:hover {
    background: #128c7e;
}
        /* ==================== GitHub Upload Note ==================== */
        .github-upload-note {
            background: rgba(var(--info-rgb), 0.1);
            border: 1px solid var(--info);
            border-radius: var(--radius-sm);
            padding: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        .note-header {
            font-weight: 600;
            color: var(--info);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .note-content {
            font-size: var(--font-sm);
        }

        .note-content code {
            background: var(--dark);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-family: monospace;
            display: block;
            margin: var(--spacing-sm) 0;
        }

        /* ==================== Form Elements ==================== */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            font-weight: 500;
            color: var(--text);
        }

        .form-label.required::after {
            content: '*';
            color: var(--danger);
            margin-right: var(--spacing-xs);
        }

        .form-control {
            width: 100%;
            padding: var(--spacing-md);
            background: var(--dark);
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: var(--font-base);
            font-family: inherit;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(var(--primary-rgb), 0.05);
        }

        .form-control:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .form-control.error {
            border-color: var(--danger);
        }

        .form-control.success {
            border-color: var(--success);
        }

        /* ==================== Input Groups ==================== */
        .input-group {
            display: flex;
            align-items: stretch;
        }

        .input-group .form-control {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            border-left: none;
        }

        .input-addon {
            padding: var(--spacing-md);
            background: var(--lightest);
            border: 2px solid var(--border);
            border-right: none;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .input-addon:first-child {
            border-top-right-radius: var(--radius-sm);
            border-bottom-right-radius: var(--radius-sm);
        }

        .input-addon:last-child {
            border-top-left-radius: var(--radius-sm);
            border-bottom-left-radius: var(--radius-sm);
            border-right: 2px solid var(--border);
            border-left: none;
        }

        .input-addon:hover {
            background: var(--primary);
            color: var(--dark);
            border-color: var(--primary);
        }

        .input-addon.btn-primary {
            background: var(--primary);
            color: var(--dark);
            border-color: var(--primary);
        }

        /* ==================== Phone Input ==================== */
        .phone-input-group {
            display: flex;
            gap: var(--spacing-sm);
        }

        .country-code {
            width: 140px;
            padding: var(--spacing-md);
            background: var(--dark);
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: var(--font-base);
            cursor: pointer;
        }

        /* ==================== Password Strength ==================== */
        .password-strength {
            margin-top: var(--spacing-sm);
        }

        .strength-bar {
            height: 6px;
            background: var(--dark);
            border-radius: var(--radius-sm);
            overflow: hidden;
            margin-bottom: var(--spacing-xs);
        }

        .strength-fill {
            height: 100%;
            width: 0;
            transition: width 0.3s ease, background 0.3s ease;
        }

        .strength-fill.weak {
            width: 25%;
            background: var(--danger);
        }

        .strength-fill.fair {
            width: 50%;
            background: var(--warning);
        }

        .strength-fill.good {
            width: 75%;
            background: var(--info);
        }

        .strength-fill.strong {
            width: 100%;
            background: var(--success);
        }

        .strength-text {
            font-size: var(--font-sm);
            color: var(--text-muted);
        }

        /* ==================== Password Criteria ==================== */
        .password-criteria {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--dark);
            border-radius: var(--radius-sm);
            font-size: var(--font-sm);
        }

        .criteria-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            color: var(--text-muted);
        }

        .criteria-item i {
            color: var(--danger);
            transition: var(--transition);
        }

        .criteria-item.valid i {
            color: var(--success);
        }

        /* ==================== Radio Groups ==================== */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .radio-item {
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: var(--dark);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .radio-item:hover {
            background: rgba(var(--primary-rgb), 0.05);
            border: 1px solid var(--primary);
        }

        .radio-item input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .radio-mark {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 50%;
            position: relative;
            transition: var(--transition);
            flex-shrink: 0;
            margin-top: 2px;
        }

        .radio-mark::after {
            content: '';
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: var(--transition);
        }

        .radio-item input[type="radio"]:checked ~ .radio-mark {
            border-color: var(--primary);
        }

        .radio-item input[type="radio"]:checked ~ .radio-mark::after {
            transform: translate(-50%, -50%) scale(1);
        }

        .radio-item small {
            display: block;
            margin-top: var(--spacing-xs);
        }

        /* ==================== Form Feedback ==================== */
        .form-hint {
            font-size: var(--font-sm);
            color: var(--text-muted);
            margin-top: var(--spacing-xs);
        }

        .form-feedback {
            font-size: var(--font-sm);
            margin-top: var(--spacing-xs);
            display: none;
        }

        .form-feedback.show {
            display: block;
        }

        .form-feedback.error {
            color: var(--danger);
        }

        .form-feedback.success {
            color: var(--success);
        }

        /* تنسيق معرف المستخدم */
        .slug-preview {
            background: var(--dark);
            padding: var(--spacing-md);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-md);
        }

        .slug-display {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--primary);
            font-family: monospace;
            padding: var(--spacing-sm);
            background: rgba(var(--primary-rgb), 0.1);
            border-radius: var(--radius-sm);
            margin-top: var(--spacing-sm);
            text-align: center;
        }
        
        .slug-input {
            font-family: monospace;
            text-align: center;
            font-size: var(--font-lg);
            font-weight: 600;
            background: rgba(var(--primary-rgb), 0.1);
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .slug-input:focus {
            background: rgba(var(--primary-rgb), 0.2);
        }

        #generateSlugSection {
            background: rgba(var(--primary-rgb), 0.05);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            border: 2px dashed var(--primary);
            margin-top: var(--spacing-lg);
        }

        #generateSlugSection .btn {
            width: 100%;
        }

        /* Alert Styles */
        .alert {
            padding: var(--spacing-md);
            border-radius: var(--radius-sm);
            margin: var(--spacing-md) 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .alert-success {
            background: rgba(var(--success-rgb), 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .alert i {
            font-size: var(--font-lg);
        }
/* ==================== Role Selection ==================== */
        .role-selection-section {
            margin-bottom: var(--spacing-2xl);
        }

        .roles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
            margin-top: var(--spacing-lg);
        }

        .role-card {
            position: relative;
            transition: var(--transition);
        }

        .role-card input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .role-card label {
            display: flex;
            flex-direction: column;
            padding: var(--spacing-lg);
            background: var(--lighter);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition);
            height: 100%;
        }

        .role-card:hover label {
            border-color: var(--primary);
            background: rgba(var(--primary-rgb), 0.05);
        }

        .role-card input[type="radio"]:checked + label {
            border-color: var(--primary);
            background: rgba(var(--primary-rgb), 0.1);
            box-shadow: 0 0 0 4px rgba(var(--primary-rgb), 0.2);
        }

        .role-icon {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: var(--spacing-md);
        }

        .role-name {
            font-size: var(--font-xl);
            margin-bottom: var(--spacing-sm);
            color: var(--text);
        }

        .role-description {
            font-size: var(--font-sm);
            color: var(--text-muted);
            margin: 0;
            flex: 1;
        }

        .role-badge {
            margin-top: var(--spacing-md);
        }

        .badge {
            display: inline-block;
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: var(--font-xs);
            font-weight: 600;
            border-radius: var(--radius-sm);
            text-transform: uppercase;
        }

        .badge-info {
            background: rgba(var(--info-rgb), 0.2);
            color: var(--info);
        }

        .badge-warning {
            background: rgba(var(--warning-rgb), 0.2);
            color: var(--warning);
        }

        .badge-primary {
            background: rgba(var(--primary-rgb), 0.2);
            color: var(--primary);
        }

        .badge-success {
            background: rgba(var(--success-rgb), 0.2);
            color: var(--success);
        }

        /* ==================== Permissions Section ==================== */
        .permissions-section {
            background: var(--lighter);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            margin-bottom: var(--spacing-2xl);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .section-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        /* ==================== Permission Categories ==================== */
        .permissions-categories {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .permission-category {
            background: var(--dark);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md) var(--spacing-lg);
            cursor: pointer;
            user-select: none;
            transition: var(--transition);
        }

        .category-header:hover {
            background: rgba(var(--primary-rgb), 0.05);
        }

        .category-toggle {
            transition: var(--transition);
        }

        .category-header.collapsed .category-toggle {
            transform: rotate(-90deg);
        }

        .category-count {
            margin-right: auto;
            font-size: var(--font-sm);
            color: var(--text-muted);
            background: var(--lighter);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
        }

        .category-permissions {
            padding: var(--spacing-md);
            border-top: 1px solid var(--border);
            display: grid;
            gap: var(--spacing-sm);
        }

        .category-header.collapsed + .category-permissions {
            display: none;
        }

        /* ==================== Permission Items ==================== */
        .permission-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--lighter);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .permission-item:hover {
            background: rgba(var(--primary-rgb), 0.05);
        }

        .permission-item input[type="checkbox"] {
            position: absolute;
            opacity: 0;
        }

        .permission-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            position: relative;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .permission-checkbox::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            color: white;
            font-size: 12px;
            transition: var(--transition);
        }

        .permission-item input[type="checkbox"]:checked ~ .permission-checkbox {
            background: var(--primary);
            border-color: var(--primary);
        }

        .permission-item input[type="checkbox"]:checked ~ .permission-checkbox::after {
            transform: translate(-50%, -50%) scale(1);
        }

        .permission-info {
            flex: 1;
        }

        .permission-name {
            display: block;
            font-weight: 500;
            color: var(--text);
            margin-bottom: var(--spacing-xs);
        }

        .permission-desc {
            display: block;
            font-size: var(--font-sm);
            color: var(--text-muted);
        }

        /* ==================== Custom Role Section ==================== */
        .custom-role-section {
            background: var(--lighter);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            margin-bottom: var(--spacing-2xl);
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .toggle-switch input[type="checkbox"] {
            width: 50px;
            height: 26px;
            appearance: none;
            background: var(--dark);
            border-radius: 26px;
            position: relative;
            cursor: pointer;
            transition: var(--transition);
        }

        .toggle-switch input[type="checkbox"]::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: var(--text-muted);
            border-radius: 50%;
            top: 2px;
            right: 26px;
            transition: var(--transition);
        }

        .toggle-switch input[type="checkbox"]:checked {
            background: var(--primary);
        }

        .toggle-switch input[type="checkbox"]:checked::after {
            right: 2px;
            background: white;
        }

        .custom-role-builder {
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--border);
        }

        /* ==================== Color Picker ==================== */
        .color-picker {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        input[type="color"] {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
        }

        .color-presets {
            display: flex;
            gap: var(--spacing-sm);
        }

        .color-preset {
            width: 30px;
            height: 30px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .color-preset:hover {
            transform: scale(1.1);
            border-color: var(--text);
        }

        /* ==================== Role Preview ==================== */
        .role-preview {
            background: var(--lighter);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
        }

        .preview-card {
            background: var(--dark);
            border-radius: var(--radius-sm);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-lg);
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-lg);
            border-bottom: 1px solid var(--border);
        }

        .preview-role {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: var(--font-xl);
            font-weight: 600;
            color: var(--primary);
        }

        .preview-stats {
            display: flex;
            gap: var(--spacing-lg);
        }

        .stat {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: var(--font-sm);
        }

        .preview-summary ul {
            list-style: none;
            padding: 0;
            margin: var(--spacing-md) 0 0 0;
        }

        .preview-summary li {
            padding: var(--spacing-sm) 0;
            padding-right: var(--spacing-lg);
            position: relative;
        }

        .preview-summary li::before {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 0;
            color: var(--success);
        }

        /* ==================== Search & Filter Section ==================== */
        .search-filter-section {
            display: flex;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            position: relative;
            min-width: 300px;
        }

        .search-icon {
            position: absolute;
            right: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        .search-input {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-3xl);
            background: var(--lighter);
            border: 2px solid var(--border);
            border-radius: var(--radius-xl);
            color: var(--text);
            font-size: var(--font-base);
            transition: var(--transition);
        }

        .search-input:focus {
            border-color: var(--primary);
            background: rgba(var(--primary-rgb), 0.05);
        }

        .search-clear {
            position: absolute;
            left: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .search-clear:hover {
            background: var(--dark);
            color: var(--text);
        }

        /* ==================== Filter Buttons ==================== */
        .filter-buttons {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .filter-btn {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--lighter);
            border: 2px solid var(--border);
            border-radius: var(--radius-xl);
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--text);
        }

        .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--dark);
        }

        .filter-count {
            background: var(--dark);
            color: var(--text);
            padding: 2px 8px;
            border-radius: var(--radius-xl);
            font-size: var(--font-sm);
            font-weight: 600;
        }

        .filter-btn.active .filter-count {
            background: var(--dark);
            color: var(--primary);
        }

        /* ==================== Assignment Container ==================== */
        .course-assignment-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            min-height: 600px;
        }

        .assignment-column {
            background: var(--lighter);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .column-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .column-title {
            font-size: var(--font-lg);
            color: var(--text);
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .column-actions,
        .column-stats {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .sort-select {
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--dark);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: var(--font-sm);
            cursor: pointer;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: var(--font-sm);
            color: var(--text-muted);
        }

        /* ==================== Items Container ==================== */
        .items-container {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-lg);
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            align-content: start;
        }

        .assigned-items {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            grid-template-columns: 1fr;
        }

        /* ==================== Loading & Empty States ==================== */
        .loading-state,
        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: var(--spacing-3xl);
            color: var(--text-muted);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            margin: 0 auto var(--spacing-lg);
            animation: spin 1s linear infinite;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }

        .empty-state p {
            font-size: var(--font-lg);
            margin-bottom: var(--spacing-sm);
        }

        .empty-state span {
            font-size: var(--font-sm);
        }

        /* ==================== Course Item ==================== */
        .course-item {
            background: var(--dark);
            border-radius: var(--radius-lg);
            overflow: hidden;
            cursor: move;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
        }

        .course-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        .course-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(0, 0, 0, 0.2);
        }

        .item-type-badge {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: var(--font-sm);
            color: var(--text-muted);
        }

        .item-type-badge.path {
            color: var(--secondary);
        }

        .item-action-btn {
            background: var(--primary);
            border: none;
            color: var(--dark);
            width: 28px;
            height: 28px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .item-action-btn:hover {
            transform: scale(1.1);
        }

        .item-action-btn.remove-btn {
            background: var(--danger);
            color: white;
        }

        .item-thumbnail {
            position: relative;
            height: 140px;
            overflow: hidden;
            background: var(--lighter);
        }

        .item-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .item-price {
            position: absolute;
            top: var(--spacing-sm);
            left: var(--spacing-sm);
            background: var(--primary);
            color: var(--dark);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: var(--font-sm);
        }

        .item-content {
            padding: var(--spacing-md);
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .item-title {
            font-size: var(--font-base);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--text);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .item-instructor {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: var(--font-sm);
            color: var(--text-muted);
            margin-bottom: var(--spacing-md);
        }

        .item-meta {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
            padding-top: var(--spacing-sm);
            border-top: 1px solid var(--border);
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: var(--font-sm);
            color: var(--text-muted);
        }

        /* ==================== Drag & Drop Area ==================== */
        .drag-drop-area {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drop-zone {
            padding: var(--spacing-xl);
            border: 3px dashed var(--border);
            border-radius: var(--radius-lg);
            text-align: center;
            color: var(--text-muted);
            transition: var(--transition);
        }

        .drop-zone i {
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
            display: block;
        }

        .drop-zone p {
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
        }

        .drop-zone span {
            font-size: var(--font-sm);
        }

        .drop-zone.drag-over {
            border-color: var(--primary);
            background: rgba(var(--primary-rgb), 0.1);
            color: var(--primary);
        }

        /* ==================== Assigned Item ==================== */
        .assigned-item {
            background: var(--dark);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .assigned-item:hover {
            border-color: var(--primary);
        }

        .assigned-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--spacing-lg);
        }

        .assigned-item-info {
            display: flex;
            gap: var(--spacing-md);
            align-items: start;
        }

        .item-type-icon {
            width: 40px;
            height: 40px;
            background: var(--lighter);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: var(--font-lg);
            flex-shrink: 0;
        }

        .assigned-item-title {
            font-size: var(--font-base);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
            color: var(--text);
        }

        .assigned-item-type {
            font-size: var(--font-sm);
            color: var(--text-muted);
            margin: 0;
        }

        .remove-btn {
            background: var(--danger);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .remove-btn:hover {
            background: var(--danger-dark);
            transform: scale(1.1);
        }

        /* ==================== Assigned Item Settings ==================== */
        .assigned-item-settings {
            display: grid;
            gap: var(--spacing-md);
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .setting-label {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: var(--font-sm);
            font-weight: 500;
            color: var(--text);
        }

        .date-inputs {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .date-input {
            flex: 1;
            padding: var(--spacing-sm);
            background: var(--lighter);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: var(--font-sm);
        }

        .date-separator {
            color: var(--text-muted);
            font-size: var(--font-sm);
        }

        .setting-select {
            padding: var(--spacing-sm);
            background: var(--lighter);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: var(--font-sm);
            cursor: pointer;
        }

        .price-input-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .price-input {
            flex: 1;
            padding: var(--spacing-sm);
            background: var(--lighter);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: var(--font-sm);
        }

        .currency-select {
            padding: var(--spacing-sm);
            background: var(--lighter);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: var(--font-sm);
            cursor: pointer;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        .setting-textarea {
            padding: var(--spacing-sm);
            background: var(--lighter);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: var(--font-sm);
            font-family: inherit;
            resize: vertical;
        }

        /* ==================== Bulk Actions ==================== */
        .bulk-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg);
            background: var(--lighter);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
        }

        .bulk-actions-left,
        .bulk-actions-right {
            display: flex;
            gap: var(--spacing-md);
        }

        /* ==================== Modal ==================== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: var(--z-modal);
            animation: fadeIn 0.3s ease;
        }

        .modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--dark);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: var(--font-xl);
            color: var(--primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: var(--font-xl);
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--lighter);
            color: var(--text);
        }

        .modal-body {
            padding: var(--spacing-lg);
            overflow-y: auto;
            flex: 1;
        }

        .modal-description {
            color: var(--text-muted);
            margin-bottom: var(--spacing-lg);
        }

        .modal-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
        }

        /* ==================== Bulk Settings Form ==================== */
        .duration-input {
            display: flex;
            gap: var(--spacing-sm);
        }

        .duration-input input {
            flex: 1;
        }

        .discount-input {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .discount-symbol {
            font-size: var(--font-lg);
            color: var(--text-muted);
        }
/* ==================== Info Sections ==================== */
        .info-section {
            background: var(--lighter);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            margin-bottom: var(--spacing-xl);
            overflow: hidden;
        }

        .section-toggle {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: var(--font-lg);
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .section-toggle:hover {
            background: var(--lighter);
            color: var(--primary);
        }

        .section-toggle i {
            transition: var(--transition);
        }

        .section-content {
            padding: var(--spacing-lg);
        }

        .section-content.collapsed {
            display: none;
        }

        .section-header.collapsed .section-toggle i {
            transform: rotate(180deg);
        }

        /* ==================== Form Grids ==================== */
        .form-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-lg);
        }

        .form-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-lg);
        }

        /* ==================== Tags Input ==================== */
        .tags-input {
            background: var(--dark);
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
            min-height: 120px;
            position: relative;
        }

        .tag-input {
            background: none;
            border: none;
            color: var(--text);
            font-size: var(--font-base);
            width: 100%;
            padding: var(--spacing-sm);
        }

        .tag-input:focus {
            outline: none;
        }

        .tags-list {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .tag-item {
            background: var(--primary);
            color: var(--dark);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-xl);
            font-size: var(--font-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            animation: fadeIn 0.3s ease;
        }

        .tag-item button {
            background: none;
            border: none;
            color: var(--dark);
            cursor: pointer;
            padding: 0;
            margin-right: var(--spacing-xs);
            font-size: var(--font-sm);
        }

        .tag-item button:hover {
            color: var(--danger);
        }

        /* ==================== Notification Preferences ==================== */
        .notification-preferences {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-xl);
        }

        .notification-group {
            background: var(--dark);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
        }

        .notification-title {
            font-size: var(--font-lg);
            margin-bottom: var(--spacing-lg);
            color: var(--text);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .notification-options {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        /* ==================== Switch Item ==================== */
        .switch-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            cursor: pointer;
            user-select: none;
        }

        .switch-item input[type="checkbox"] {
            position: absolute;
            opacity: 0;
        }

        .switch-slider {
            width: 44px;
            height: 24px;
            background: var(--lighter);
            border-radius: 24px;
            position: relative;
            transition: var(--transition);
        }

        .switch-slider::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: var(--text-muted);
            border-radius: 50%;
            top: 3px;
            right: 23px;
            transition: var(--transition);
        }

        .switch-item input[type="checkbox"]:checked ~ .switch-slider {
            background: var(--primary);
        }

        .switch-item input[type="checkbox"]:checked ~ .switch-slider::after {
            right: 3px;
            background: white;
        }

        .switch-label {
            color: var(--text);
            font-size: var(--font-base);
        }

        /* ==================== Custom Fields ==================== */
        .custom-fields-container {
            display: grid;
            gap: var(--spacing-md);
        }

        .custom-field-item {
            background: var(--dark);
            padding: var(--spacing-md);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            animation: slideIn 0.3s ease;
        }

        .custom-field-icon {
            width: 40px;
            height: 40px;
            background: var(--lighter);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            flex-shrink: 0;
        }

        .custom-field-content {
            flex: 1;
        }

        .custom-field-label {
            font-weight: 500;
            color: var(--text);
            margin-bottom: var(--spacing-xs);
        }

        .custom-field-type {
            font-size: var(--font-sm);
            color: var(--text-muted);
        }

        .custom-field-remove {
            background: var(--danger);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .custom-field-remove:hover {
            background: var(--danger-dark);
            transform: scale(1.1);
        }

        .empty-custom-fields {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--text-muted);
        }

        .empty-custom-fields i {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }

        .empty-custom-fields p {
            font-size: var(--font-lg);
            margin-bottom: var(--spacing-sm);
        }

        /* ==================== Admin Notes Editor ==================== */
        .admin-notes-editor {
            background: var(--dark);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .editor-toolbar {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm);
            background: var(--lighter);
            border-bottom: 1px solid var(--border);
        }

        .editor-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .editor-btn:hover {
            background: var(--dark);
            color: var(--primary);
        }

        .editor-btn.active {
            background: var(--primary);
            color: var(--dark);
        }

        .editor-separator {
            width: 1px;
            height: 20px;
            background: var(--border);
            margin: 0 var(--spacing-xs);
        }

        .editor-content {
            padding: var(--spacing-lg);
            min-height: 150px;
            max-height: 300px;
            overflow-y: auto;
            color: var(--text);
            line-height: 1.6;
        }

        .editor-content:focus {
            outline: none;
        }

        .editor-content[contenteditable="true"]:empty::before {
            content: attr(placeholder);
            color: var(--text-muted);
            pointer-events: none;
        }

        .notes-metadata {
            display: flex;
            justify-content: space-between;
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--border);
            font-size: var(--font-sm);
            color: var(--text-muted);
        }

        .metadata-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        /* ==================== Activity Timeline ==================== */
        .activity-timeline {
            position: relative;
            padding-right: var(--spacing-xl);
        }

        .activity-timeline::before {
            content: '';
            position: absolute;
            right: 16px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }

        .timeline-item {
            position: relative;
            margin-bottom: var(--spacing-xl);
            animation: slideIn 0.3s ease;
        }

        .timeline-icon {
            position: absolute;
            right: 0;
            width: 32px;
            height: 32px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: 3px solid var(--lighter);
        }

        .timeline-content {
            background: var(--dark);
            padding: var(--spacing-md);
            border-radius: var(--radius-sm);
            margin-right: var(--spacing-3xl);
            border: 1px solid var(--border);
        }

        .timeline-title {
            font-size: var(--font-base);
            font-weight: 600;
            color: var(--text);
            margin-bottom: var(--spacing-xs);
        }

        .timeline-description {
            font-size: var(--font-sm);
            color: var(--text-muted);
            margin-bottom: var(--spacing-sm);
        }

        .timeline-date {
            font-size: var(--font-xs);
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        /* ==================== Financial Tab Styles ==================== */
        .financial-summary {
            background: var(--lighter);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-xl);
            border: 1px solid var(--border);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
            margin-top: var(--spacing-lg);
        }

        .summary-card {
            background: var(--dark);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            transition: var(--transition);
        }

        .summary-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .summary-icon {
            width: 50px;
            height: 50px;
            background: rgba(var(--primary-rgb), 0.1);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: var(--font-xl);
        }

        .summary-content h4 {
            font-size: var(--font-sm);
            color: var(--text-muted);
            margin-bottom: var(--spacing-xs);
        }

        .summary-content .amount {
            font-size: var(--font-xl);
            font-weight: 700;
            color: var(--text);
        }

        /* ==================== Transaction Form ==================== */
        .add-transaction-section {
            background: var(--lighter);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-xl);
            border: 1px solid var(--border);
        }

        .transaction-form {
            margin-top: var(--spacing-lg);
        }

        .col-md-3 {
            grid-column: span 3;
        }

        .col-md-4 {
            grid-column: span 4;
        }

        .col-md-6 {
            grid-column: span 6;
        }

        .input-group-append {
            display: flex;
        }

        .input-group-text {
            padding: var(--spacing-md);
            background: var(--lightest);
            border: 2px solid var(--border);
            border-right: none;
            color: var(--text);
            display: flex;
            align-items: center;
            border-top-right-radius: var(--radius-sm);
            border-bottom-right-radius: var(--radius-sm);
        }

        .installment-details {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-lg);
            margin-top: var(--spacing-md);
        }

        .installment-details.show {
            display: grid;
        }

        /* ==================== Transactions History ==================== */
        .transactions-history {
            background: var(--lighter);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-xl);
            border: 1px solid var(--border);
        }

        .filters-row {
            display: flex;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }

        .filter-group label {
            font-size: var(--font-sm);
            color: var(--text-muted);
            margin-bottom: var(--spacing-xs);
        }

        .form-control-sm {
            padding: var(--spacing-sm);
            font-size: var(--font-sm);
        }

        .table-responsive {
            overflow-x: auto;
            margin-top: var(--spacing-lg);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--dark);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .table th,
        .table td {
            padding: var(--spacing-md);
            text-align: right;
            border-bottom: 1px solid var(--border);
        }

        .table th {
            background: var(--lighter);
            font-weight: 600;
            color: var(--text);
            font-size: var(--font-sm);
        }

        .table td {
            color: var(--text-light);
        }

        .table-hover tbody tr:hover {
            background: rgba(var(--primary-rgb), 0.05);
        }

        /* Transaction Status Badges */
        .transaction-type {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: var(--font-sm);
            font-weight: 500;
        }

        .transaction-type.payment {
            background: rgba(var(--success-rgb), 0.2);
            color: var(--success);
        }

        .transaction-type.grant {
            background: rgba(var(--info-rgb), 0.2);
            color: var(--info);
        }

        .transaction-type.gift {
            background: rgba(var(--warning-rgb), 0.2);
            color: var(--warning);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: var(--font-sm);
            font-weight: 500;
        }

        .status-badge.completed {
            background: rgba(var(--success-rgb), 0.2);
            color: var(--success);
        }

        .status-badge.pending {
            background: rgba(var(--warning-rgb), 0.2);
            color: var(--warning);
        }

        .status-badge.failed {
            background: rgba(var(--danger-rgb), 0.2);
            color: var(--danger);
        }

        .action-buttons {
            display: flex;
            gap: var(--spacing-xs);
        }

        .btn-outline-primary {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-outline-primary:hover {
            background: var(--primary);
            color: var(--dark);
        }

        .btn-outline-danger {
            background: transparent;
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .btn-outline-danger:hover {
            background: var(--danger);
            color: white;
        }

        /* ==================== Upcoming Payments ==================== */
        .upcoming-payments {
            background: var(--lighter);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            margin-bottom: var(--spacing-xl);
        }

        .upcoming-payment-item {
            background: var(--dark);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-md);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .upcoming-payment-item:hover {
            border-color: var(--primary);
        }

        .upcoming-payment-item.overdue {
            border-color: var(--danger);
            background: rgba(var(--danger-rgb), 0.05);
        }

        .payment-info h5 {
            margin: 0 0 var(--spacing-xs) 0;
            color: var(--text);
        }

        .payment-info p {
            margin: 0;
            font-size: var(--font-sm);
            color: var(--text-muted);
        }

        .payment-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--spacing-md);
        }

        .payment-amount {
            font-size: var(--font-xl);
            font-weight: 700;
            color: var(--primary);
        }

        .payment-date {
            font-size: var(--font-sm);
            color: var(--text-muted);
        }

        .payment-date.overdue {
            color: var(--danger);
        }

        .payment-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        /* ==================== Investment Statement Section ==================== */
        .investment-statements {
            background: var(--lighter);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
        }

        .statement-selector {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        .statement-select {
            padding: var(--spacing-md);
            background: var(--dark);
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: var(--font-base);
            cursor: pointer;
        }

        .statement-preview {
            background: var(--dark);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            border: 1px solid var(--border);
        }

        .statement-header {
            border-bottom: 1px solid var(--border);
            padding-bottom: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .statement-title {
            font-size: var(--font-2xl);
            color: var(--primary);
            margin-bottom: var(--spacing-sm);
        }

        .statement-meta {
            display: flex;
            gap: var(--spacing-xl);
            font-size: var(--font-sm);
            color: var(--text-muted);
        }

        .statement-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: var(--font-sm);
            color: var(--text-muted);
            margin-bottom: var(--spacing-xs);
        }

        .summary-value {
            font-size: var(--font-xl);
            font-weight: 700;
            color: var(--text);
        }

        .statement-chart {
            height: 300px;
            margin-bottom: var(--spacing-xl);
        }

        .statement-table {
            width: 100%;
            margin-bottom: var(--spacing-xl);
        }

        .statement-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: center;
        }

        .btn-whatsapp {
            background: #25d366;
            color: white;
        }

        .btn-whatsapp:hover {
            background: #128c7e;
        }

        /* ==================== Empty States ==================== */
        .text-center {
            text-align: center !important;
        }

        .py-4 {
            padding: var(--spacing-2xl) 0;
        }

        .fa-3x {
            font-size: 3rem;
        }

        /* ==================== New Financial Elements ==================== */
        .transaction-status-select {
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--dark);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: var(--font-sm);
            cursor: pointer;
            width: 100%;
        }

        .transaction-reference {
            font-family: monospace;
            font-size: var(--font-sm);
            color: var(--primary);
            background: rgba(var(--primary-rgb), 0.1);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
        }

        .due-date-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: var(--font-sm);
        }

        .due-date-badge.overdue {
            background: rgba(var(--danger-rgb), 0.2);
            color: var(--danger);
        }

        .due-date-badge.upcoming {
            background: rgba(var(--warning-rgb), 0.2);
            color: var(--warning);
        }

        .due-date-badge.future {
            background: rgba(var(--info-rgb), 0.2);
            color: var(--info);
        }

        /* ==================== Transaction Edit Modal ==================== */
        .transaction-edit-modal .modal-content {
            max-width: 700px;
        }

        .transaction-edit-form {
            display: grid;
            gap: var(--spacing-lg);
        }

        .transaction-edit-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-lg);
        }

        /* ==================== Responsive Design ==================== */
        @media (max-width: 1200px) {
            .header-center {
                display: none;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .avatar-section {
                order: -1;
            }

            .course-assignment-container {
                grid-template-columns: 1fr;
                gap: var(--spacing-lg);
            }

            .drag-drop-area {
                display: none;
            }
        }

        @media (max-width: 992px) {
            .form-grid-3 {
                grid-template-columns: 1fr;
            }

            .form-grid-2 {
                grid-template-columns: 1fr;
            }

            .notification-preferences {
                grid-template-columns: 1fr;
            }

            .roles-grid {
                grid-template-columns: 1fr;
            }

            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -260px;
                height: 100%;
                z-index: var(--z-modal-backdrop);
            }

            .sidebar.active {
                left: 0;
            }

            .main-content {
                padding: var(--spacing-md);
            }

            .page-header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .tabs-list {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .progress-steps {
                display: none;
            }

            .form-actions {
                flex-direction: column;
                gap: var(--spacing-md);
                bottom: 0;
                left: 0;
                right: 0;
                border-radius: 0;
                border-top: 1px solid var(--border);
            }

            .actions-left,
            .actions-right {
                width: 100%;
                justify-content: center;
            }

            .section-header {
                flex-wrap: wrap;
                gap: var(--spacing-md);
            }

            .section-actions {
                width: 100%;
            }

            .section-actions .btn {
                flex: 1;
            }

            .preview-header {
                flex-direction: column;
                gap: var(--spacing-md);
            }

            .preview-stats {
                width: 100%;
                justify-content: space-around;
            }

            .notes-metadata {
                flex-direction: column;
                gap: var(--spacing-sm);
            }

            .editor-toolbar {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .search-filter-section {
                flex-direction: column;
            }

            .search-box {
                min-width: 100%;
            }

            .filter-buttons {
                justify-content: center;
            }

            .items-container {
                grid-template-columns: 1fr;
            }

            .bulk-actions {
                flex-direction: column;
                gap: var(--spacing-md);
            }

            .bulk-actions-left,
            .bulk-actions-right {
                width: 100%;
                justify-content: center;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .password-criteria {
                grid-template-columns: 1fr;
            }

            .phone-input-group {
                flex-direction: column;
            }

            .country-code {
                width: 100%;
            }

            .filters-row {
                flex-direction: column;
            }

            .filter-group {
                min-width: 100%;
            }

            .table-responsive {
                font-size: var(--font-sm);
            }

            .table th,
            .table td {
                padding: var(--spacing-sm);
            }

            .col-md-3,
            .col-md-4,
            .col-md-6 {
                grid-column: span 12;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }

            .installment-details {
                grid-template-columns: 1fr;
            }

            .statement-summary {
                grid-template-columns: repeat(2, 1fr);
            }

            .statement-actions {
                flex-direction: column;
            }

            .statement-actions .btn {
                width: 100%;
            }
        }

        @media (max-width: 576px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .password-criteria {
                grid-template-columns: 1fr;
            }

            .phone-input-group {
                flex-direction: column;
            }

            .country-code {
                width: 100%;
            }
        }
    </style>
<!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
</head>
<body>
<!-- ==================== Loading Overlay ==================== -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <h3 class="loading-text">جاري التحميل...</h3>
            <p class="loading-subtext">يرجى الانتظار</p>
        </div>
    </div>

    <!-- ==================== Auto Save Indicator ==================== -->
    <div class="auto-save-indicator" id="autoSaveIndicator">
        <i class="fas fa-check-circle"></i>
        <span>تم الحفظ تلقائياً</span>
    </div>

    <!-- ==================== Header ==================== -->
    <header class="main-header">
        <div class="header-container">
            <!-- القسم الأيسر -->
            <div class="header-left">
                <button class="menu-toggle" id="menuToggle" aria-label="فتح القائمة">
                    <i class="fas fa-bars"></i>
                </button>
                <a href="/admin/dashboard.html" class="header-logo">
                    <img src="https://raw.githubusercontent.com/MahmoudFouad25/fouad-perspective/main/media/images/logo.png" alt="منظور الفؤاد">
                    <span class="logo-text">منظور الفؤاد</span>
                </a>
            </div>

            <!-- القسم الأوسط -->
            <div class="header-center">
                <nav class="breadcrumb" aria-label="التنقل">
                    <ol class="breadcrumb-list">
                        <li class="breadcrumb-item">
                            <a href="/admin/dashboard.html">
                                <i class="fas fa-home"></i>
                                الرئيسية
                            </a>
                        </li>
                        <li class="breadcrumb-separator">
                            <i class="fas fa-chevron-left"></i>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="/admin/users.html">
                                <i class="fas fa-users"></i>
                                المستخدمون
                            </a>
                        </li>
                        <li class="breadcrumb-separator">
                            <i class="fas fa-chevron-left"></i>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">
                            <i class="fas fa-user-plus"></i>
                            <span id="pageMode">إنشاء مستخدم جديد</span>
                        </li>
                    </ol>
                </nav>
            </div>

            <!-- القسم الأيمن -->
            <div class="header-right">
                <button class="icon-btn" id="themeToggle" aria-label="تبديل الوضع">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="icon-btn" id="notificationBtn" aria-label="الإشعارات">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </button>
                <div class="user-menu">
                    <button class="user-menu-toggle" id="userMenuToggle">
                        <img src="https://raw.githubusercontent.com/MahmoudFouad25/fouad-perspective/main/media/avatars/admin.jpg" alt="Admin" class="user-avatar">
                        <span class="user-name">الأدمن</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- ==================== Main Container ==================== -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="/admin/dashboard.html" class="nav-link">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>لوحة التحكم</span>
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a href="/admin/users.html" class="nav-link">
                            <i class="fas fa-users"></i>
                            <span>المستخدمون</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/courses.html" class="nav-link">
                            <i class="fas fa-graduation-cap"></i>
                            <span>الدورات</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/groups.html" class="nav-link">
                            <i class="fas fa-users-cog"></i>
                            <span>المجموعات</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/reports.html" class="nav-link">
                            <i class="fas fa-chart-bar"></i>
                            <span>التقارير</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/settings.html" class="nav-link">
                            <i class="fas fa-cog"></i>
                            <span>الإعدادات</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-header-content">
                    <div class="page-header-left">
                        <h1 class="page-title">
                            <i class="fas fa-user-plus"></i>
                            <span id="pageTitleText">إنشاء مستخدم جديد</span>
                        </h1>
                        <p class="page-subtitle">أضف مستخدم جديد للمنصة وحدد صلاحياته والدورات المتاحة له</p>
                    </div>
                    <div class="page-header-right">
                        <button class="btn btn-secondary" onclick="window.history.back()">
                            <i class="fas fa-arrow-right"></i>
                            رجوع
                        </button>
                        <button class="btn btn-primary" id="quickSaveBtn">
                            <i class="fas fa-save"></i>
                            حفظ سريع
                        </button>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 20%"></div>
                </div>
                <div class="progress-steps">
                    <div class="progress-step active" data-step="1">
                        <div class="step-circle">1</div>
                        <span class="step-label">البيانات الأساسية</span>
                    </div>
                    <div class="progress-step" data-step="2">
                        <div class="step-circle">2</div>
                        <span class="step-label">الأدوار والصلاحيات</span>
                    </div>
                    <div class="progress-step" data-step="3">
                        <div class="step-circle">3</div>
                        <span class="step-label">الدورات والمسارات</span>
                    </div>
                    <div class="progress-step" data-step="4">
                        <div class="step-circle">4</div>
                        <span class="step-label">معلومات إضافية</span>
                    </div>
                    <div class="progress-step" data-step="5">
                        <div class="step-circle">5</div>
                        <span class="step-label">المعاملات المالية</span>
                    </div>
                </div>
            </div>

            <!-- Tabs Container -->
            <div class="tabs-container">
                <!-- Tab Navigation -->
                <nav class="tabs-nav">
                    <ul class="tabs-list" role="tablist">
                        <li class="tab-item" role="presentation">
                            <button class="tab-link active" id="basicTab" data-tab="basic" role="tab" aria-selected="true" aria-controls="basicPanel">
                                <i class="fas fa-user"></i>
                                <span>البيانات الأساسية</span>
                            </button>
                        </li>
                        <li class="tab-item" role="presentation">
                            <button class="tab-link" id="rolesTab" data-tab="roles" role="tab" aria-selected="false" aria-controls="rolesPanel">
                                <i class="fas fa-user-shield"></i>
                                <span>الأدوار والصلاحيات</span>
                            </button>
                        </li>
                        <li class="tab-item" role="presentation">
                            <button class="tab-link" id="coursesTab" data-tab="courses" role="tab" aria-selected="false" aria-controls="coursesPanel">
                                <i class="fas fa-book"></i>
                                <span>الدورات والمسارات</span>
                            </button>
                        </li>
                        <li class="tab-item" role="presentation">
                            <button class="tab-link" id="advancedTab" data-tab="advanced" role="tab" aria-selected="false" aria-controls="advancedPanel">
                                <i class="fas fa-cogs"></i>
                                <span>معلومات إضافية</span>
                            </button>
                        </li>
                        <li class="tab-item" role="presentation">
                            <button class="tab-link" id="financialTab" data-tab="financial" role="tab" aria-selected="false" aria-controls="financialPanel">
                                <i class="fas fa-wallet"></i>
                                <span>المعاملات المالية</span>
                            </button>
                        </li>
                    </ul>
                </nav>

                <!-- Tab Panels Container -->
                <div class="tab-panels">
<!-- ==================== Basic Info Tab Panel ==================== -->
                    <div class="tab-panel active" id="basicPanel" role="tabpanel" aria-labelledby="basicTab">
                        <div class="panel-header">
                            <h2 class="panel-title">
                                <i class="fas fa-user-circle"></i>
                                المعلومات الأساسية
                            </h2>
                            <p class="panel-description">أدخل البيانات الأساسية للمستخدم الجديد</p>
                        </div>

                        <div class="panel-content">
                            <div class="form-grid">
                                <!-- القسم الأيسر - الصورة الشخصية -->
                                <div class="form-section avatar-section">
                                    <h3 class="section-title">
                                        <i class="fas fa-camera"></i>
                                        الصورة الشخصية
                                    </h3>
                                    
                                    <div class="avatar-upload-container">
                                        <div class="avatar-preview" id="avatarPreview">
                                            <img src="" alt="Avatar" id="avatarImg" style="display: none;">
                                            <div class="avatar-placeholder" id="avatarPlaceholder">
                                                <i class="fas fa-user"></i>
                                            </div>
                                            <div class="avatar-overlay">
                                                <i class="fas fa-camera"></i>
                                                <span>تغيير الصورة</span>
                                            </div>
                                        </div>
                                        
                                        <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                                        
                                        <div class="avatar-actions">
                                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('avatarInput').click()">
                                                <i class="fas fa-upload"></i>
                                                رفع صورة
                                            </button>
                                            <button type="button" class="btn btn-outline" id="removeAvatarBtn" style="display: none;" onclick="removeAvatar()">
                                                <i class="fas fa-trash"></i>
                                                حذف
                                            </button>
                                        </div>
                                        
                                        <div class="avatar-info">
                                            <p class="text-muted text-sm">
                                                <i class="fas fa-info-circle"></i>
                                                الصور المسموحة: JPG, PNG, GIF
                                            </p>
                                            <p class="text-muted text-sm">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                الحد الأقصى: 5 ميجابايت
                                            </p>
                                        </div>
                                    </div>

                                    <!-- داخل avatar-section، بعد avatar-upload-container -->
<div class="whatsapp-actions" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
    <h4 style="margin-bottom: 10px;">
        <i class="fab fa-whatsapp"></i>
        إرسال البيانات للعميل
    </h4>
    
    <div class="form-group">
        <label class="form-label">نوع الرسالة:</label>
        <select class="form-control" id="messageTemplate" onchange="updateMessagePreview()">
            <option value="welcome">رسالة ترحيب مع البيانات</option>
            <option value="credentials">بيانات الدخول فقط</option>
            <option value="reset">استعادة بيانات الدخول</option>
            <option value="custom">رسالة مخصصة</option>
        </select>
    </div>
    
    <div class="form-group">
        <label class="form-label">معاينة الرسالة:</label>
        <textarea class="form-control" id="messagePreview" rows="6" style="font-family: monospace; font-size: 12px;"></textarea>
    </div>
    
    <div class="form-actions" style="display: flex; gap: 10px;">
        <button class="btn btn-success" onclick="sendWhatsAppMessage()">
            <i class="fab fa-whatsapp"></i>
            إرسال عبر WhatsApp
        </button>
        <button class="btn btn-secondary" onclick="copyMessage()">
            <i class="fas fa-copy"></i>
            نسخ الرسالة
        </button>
    </div>
</div>

                                    <!-- GitHub Upload Instructions -->
                                    <div class="github-upload-note" id="githubUploadNote" style="display: none;">
                                        <div class="note-header">
                                            <i class="fas fa-github"></i>
                                            تعليمات رفع الصورة
                                        </div>
                                        <div class="note-content">
                                            <p>قم برفع الصورة إلى المسار التالي في GitHub:</p>
                                            <code id="githubPath">/media/avatars/</code>
                                            <button class="btn btn-sm btn-primary" onclick="copyGithubPath()">
                                                <i class="fas fa-copy"></i>
                                                نسخ المسار
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- القسم الأيمن - البيانات الأساسية -->
                                <div class="form-section">
                                    <h3 class="section-title">
                                        <i class="fas fa-id-card"></i>
                                        بيانات الحساب
                                    </h3>

                                    <!-- الاسم الكامل -->
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label required" for="firstName">
                                                <i class="fas fa-user"></i>
                                                الاسم الأول
                                            </label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="firstName" 
                                                   placeholder="أدخل الاسم الأول"
                                                   required
                                                   autocomplete="given-name">
                                            <div class="form-feedback" id="firstNameFeedback"></div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label required" for="lastName">
                                                <i class="fas fa-user"></i>
                                                اسم العائلة
                                            </label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="lastName" 
                                                   placeholder="أدخل اسم العائلة"
                                                   required
                                                   autocomplete="family-name">
                                            <div class="form-feedback" id="lastNameFeedback"></div>
                                        </div>
                                    </div>

                                    <!-- زر إنشاء معرف المستخدم -->
                                    <div class="form-group" id="generateSlugSection" style="display: none;">
                                        <div class="slug-preview">
                                            <label class="form-label">
                                                <i class="fas fa-fingerprint"></i>
                                                معرف المستخدم المقترح
                                            </label>
                                            <input type="text" class="form-control slug-input" id="slugPreview" value="">
                                        </div>
                                        <button type="button" class="btn btn-primary" onclick="generateUserSlug()">
                                            <i class="fas fa-check"></i>
                                            استخدم هذا المعرف وابدأ التسجيل
                                        </button>
                                        <div class="form-hint">بعد الضغط لن يمكن تغيير المعرف</div>
                                    </div>

                                    <!-- البريد الإلكتروني -->
                                    <div class="form-group">
                                        <label class="form-label required" for="email">
                                            <i class="fas fa-envelope"></i>
                                            البريد الإلكتروني
                                        </label>
                                        <div class="input-group">
                                            <input type="email" 
                                                   class="form-control" 
                                                   id="email" 
                                                   placeholder="example@domain.com"
                                                   required
                                                   autocomplete="email">
                                            <button type="button" class="input-addon" id="checkEmailBtn">
                                                <i class="fas fa-check-circle"></i>
                                                تحقق
                                            </button>
                                        </div>
                                        <div class="form-hint">سيستخدم هذا البريد لتسجيل الدخول</div>
                                        <div class="form-feedback" id="emailFeedback"></div>
                                    </div>

                                    <!-- كلمة المرور -->
                                    <div class="form-group" id="passwordGroup">
                                        <label class="form-label required" for="password">
                                            <i class="fas fa-lock"></i>
                                            كلمة المرور
                                        </label>
                                        <div class="input-group">
                                            <input type="password" 
                                                   class="form-control" 
                                                   id="password" 
                                                   placeholder="أدخل كلمة مرور قوية"
                                                   required
                                                   autocomplete="new-password">
                                            <button type="button" class="input-addon" onclick="togglePassword()">
                                                <i class="fas fa-eye" id="passwordToggleIcon"></i>
                                            </button>
                                            <button type="button" class="input-addon btn-primary" onclick="generatePassword()">
                                                <i class="fas fa-key"></i>
                                                توليد
                                            </button>
                                        </div>
                                        
                                        <!-- مؤشر قوة كلمة المرور -->
                                        <div class="password-strength" id="passwordStrength">
                                            <div class="strength-bar">
                                                <div class="strength-fill" id="strengthFill"></div>
                                            </div>
                                            <div class="strength-text" id="strengthText">أدخل كلمة المرور</div>
                                        </div>
                                        
                                        <!-- معايير كلمة المرور -->
                                        <div class="password-criteria">
                                            <div class="criteria-item" id="lengthCriteria">
                                                <i class="fas fa-times-circle"></i>
                                                <span>8 أحرف على الأقل</span>
                                            </div>
                                            <div class="criteria-item" id="uppercaseCriteria">
                                                <i class="fas fa-times-circle"></i>
                                                <span>حرف كبير واحد على الأقل</span>
                                            </div>
                                            <div class="criteria-item" id="lowercaseCriteria">
                                                <i class="fas fa-times-circle"></i>
                                                <span>حرف صغير واحد على الأقل</span>
                                            </div>
                                            <div class="criteria-item" id="numberCriteria">
                                                <i class="fas fa-times-circle"></i>
                                                <span>رقم واحد على الأقل</span>
                                            </div>
                                            <div class="criteria-item" id="specialCriteria">
                                                <i class="fas fa-times-circle"></i>
                                                <span>رمز خاص واحد على الأقل (!@#$%^&*)</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- تأكيد كلمة المرور -->
                                    <div class="form-group" id="confirmPasswordGroup">
                                        <label class="form-label required" for="confirmPassword">
                                            <i class="fas fa-lock"></i>
                                            تأكيد كلمة المرور
                                        </label>
                                        <input type="password" 
                                               class="form-control" 
                                               id="confirmPassword" 
                                               placeholder="أعد إدخال كلمة المرور"
                                               required
                                               autocomplete="new-password">
                                        <div class="form-feedback" id="confirmPasswordFeedback"></div>
                                    </div>

                                    <!-- رقم الهاتف/WhatsApp -->
                                    <div class="form-group">
                                        <label class="form-label required" for="whatsapp">
                                            <i class="fab fa-whatsapp"></i>
                                            رقم WhatsApp
                                        </label>
                                        <div class="phone-input-group">
                                            <select class="country-code" id="countryCode">
                                                <option value="+20" data-flag="🇪🇬">+20 (مصر)</option>
                                                <option value="+966" data-flag="🇸🇦">+966 (السعودية)</option>
                                                <option value="+971" data-flag="🇦🇪">+971 (الإمارات)</option>
                                                <option value="+965" data-flag="🇰🇼">+965 (الكويت)</option>
                                                <option value="+974" data-flag="🇶🇦">+974 (قطر)</option>
                                                <option value="+968" data-flag="🇴🇲">+968 (عمان)</option>
                                                <option value="+973" data-flag="🇧🇭">+973 (البحرين)</option>
                                                <option value="+962" data-flag="🇯🇴">+962 (الأردن)</option>
                                                <option value="+961" data-flag="🇱🇧">+961 (لبنان)</option>
                                                <option value="+970" data-flag="🇵🇸">+970 (فلسطين)</option>
                                                <option value="+963" data-flag="🇸🇾">+963 (سوريا)</option>
                                                <option value="+964" data-flag="🇮🇶">+964 (العراق)</option>
                                                <option value="+212" data-flag="🇲🇦">+212 (المغرب)</option>
                                                <option value="+213" data-flag="🇩🇿">+213 (الجزائر)</option>
                                                <option value="+216" data-flag="🇹🇳">+216 (تونس)</option>
                                                <option value="+218" data-flag="🇱🇾">+218 (ليبيا)</option>
                                                <option value="+249" data-flag="🇸🇩">+249 (السودان)</option>
                                            </select>
                                            <input type="tel" 
                                                   class="form-control" 
                                                   id="phoneNumber" 
                                                   placeholder="123456789"
                                                   pattern="[0-9]*"
                                                   required>
                                        </div>
                                        <div class="form-hint">سيستخدم للتواصل وإرسال الإشعارات</div>
                                        <div class="form-feedback" id="phoneFeedback"></div>
                                    </div>

                                    <!-- حالة الحساب -->
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="fas fa-toggle-on"></i>
                                            حالة الحساب
                                        </label>
                                        <div class="radio-group">
                                            <label class="radio-item">
                                                <input type="radio" name="accountStatus" value="active" checked>
                                                <span class="radio-mark"></span>
                                                <span>نشط</span>
                                                <small class="text-muted">يمكن للمستخدم الدخول فوراً</small>
                                            </label>
                                            <label class="radio-item">
                                                <input type="radio" name="accountStatus" value="pending">
                                                <span class="radio-mark"></span>
                                                <span>معلق</span>
                                                <small class="text-muted">يحتاج موافقة قبل الدخول</small>
                                            </label>
                                            <label class="radio-item">
                                                <input type="radio" name="accountStatus" value="inactive">
                                                <span class="radio-mark"></span>
                                                <span>غير نشط</span>
                                                <small class="text-muted">لا يمكن الدخول حالياً</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
<!-- ==================== Roles & Permissions Tab Panel ==================== -->
                    <div class="tab-panel" id="rolesPanel" role="tabpanel" aria-labelledby="rolesTab">
                        <div class="panel-header">
                            <h2 class="panel-title">
                                <i class="fas fa-user-shield"></i>
                                الأدوار والصلاحيات
                            </h2>
                            <p class="panel-description">حدد دور المستخدم وصلاحياته في المنصة</p>
                        </div>

                        <div class="panel-content">
                            <!-- Role Selection -->
                            <div class="role-selection-section">
                                <h3 class="section-title">
                                    <i class="fas fa-crown"></i>
                                    اختر الدور الأساسي
                                </h3>
                                
                                <div class="roles-grid">
                                    <!-- طالب -->
                                    <div class="role-card" data-role="student">
                                        <input type="radio" name="primaryRole" id="roleStudent" value="student" checked>
                                        <label for="roleStudent">
                                            <div class="role-icon">
                                                <i class="fas fa-user-graduate"></i>
                                            </div>
                                            <div class="role-info">
                                                <h4 class="role-name">طالب</h4>
                                                <p class="role-description">الوصول للدورات المسجل بها والمحتوى التعليمي</p>
                                            </div>
                                            <div class="role-badge">
                                                <span class="badge badge-info">افتراضي</span>
                                            </div>
                                        </label>
                                    </div>

                                    <!-- مدرب مساعد -->
                                    <div class="role-card" data-role="assistant">
                                        <input type="radio" name="primaryRole" id="roleAssistant" value="assistant">
                                        <label for="roleAssistant">
                                            <div class="role-icon">
                                                <i class="fas fa-chalkboard-teacher"></i>
                                            </div>
                                            <div class="role-info">
                                                <h4 class="role-name">مدرب مساعد</h4>
                                                <p class="role-description">مساعدة في إدارة الدورات والرد على الاستفسارات</p>
                                            </div>
                                            <div class="role-badge">
                                                <span class="badge badge-warning">متقدم</span>
                                            </div>
                                        </label>
                                    </div>

                                    <!-- مشرف مجموعة -->
                                    <div class="role-card" data-role="group-leader">
                                        <input type="radio" name="primaryRole" id="roleGroupLeader" value="group-leader">
                                        <label for="roleGroupLeader">
                                            <div class="role-icon">
                                                <i class="fas fa-users-cog"></i>
                                            </div>
                                            <div class="role-info">
                                                <h4 class="role-name">مشرف مجموعة</h4>
                                                <p class="role-description">إدارة مجموعة من الطلاب ومتابعة تقدمهم</p>
                                            </div>
                                            <div class="role-badge">
                                                <span class="badge badge-primary">إداري</span>
                                            </div>
                                        </label>
                                    </div>

                                    <!-- محلل بيانات -->
                                    <div class="role-card" data-role="analyst">
                                        <input type="radio" name="primaryRole" id="roleAnalyst" value="analyst">
                                        <label for="roleAnalyst">
                                            <div class="role-icon">
                                                <i class="fas fa-chart-line"></i>
                                            </div>
                                            <div class="role-info">
                                                <h4 class="role-name">محلل بيانات</h4>
                                                <p class="role-description">عرض التقارير والإحصائيات دون صلاحيات التعديل</p>
                                            </div>
                                            <div class="role-badge">
                                                <span class="badge badge-success">تحليلي</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Permissions Matrix -->
                            <div class="permissions-section">
                                <div class="section-header">
                                    <h3 class="section-title">
                                        <i class="fas fa-key"></i>
                                        الصلاحيات التفصيلية
                                    </h3>
                                    <div class="section-actions">
                                        <button class="btn btn-sm btn-outline" onclick="selectAllPermissions()">
                                            <i class="fas fa-check-square"></i>
                                            تحديد الكل
                                        </button>
                                        <button class="btn btn-sm btn-outline" onclick="deselectAllPermissions()">
                                            <i class="fas fa-square"></i>
                                            إلغاء الكل
                                        </button>
                                    </div>
                                </div>

                                <div class="permissions-categories">
                                    <!-- صلاحيات المحتوى التعليمي -->
                                    <div class="permission-category">
                                        <div class="category-header" onclick="toggleCategory('content')">
                                            <i class="fas fa-chevron-down category-toggle"></i>
                                            <i class="fas fa-book"></i>
                                            <span>المحتوى التعليمي</span>
                                            <span class="category-count" id="contentCount">0/5</span>
                                        </div>
                                        <div class="category-permissions" id="contentPermissions">
                                            <label class="permission-item">
                                                <input type="checkbox" name="permissions" value="view_courses" checked>
                                                <span class="permission-checkbox"></span>
                                                <div class="permission-info">
                                                    <span class="permission-name">عرض الدورات</span>
                                                    <small class="permission-desc">الوصول للدورات المسجل بها</small>
                                                </div>
                                            </label>
                                            <label class="permission-item">
                                                <input type="checkbox" name="permissions" value="download_materials">
                                                <span class="permission-checkbox"></span>
                                                <div class="permission-info">
                                                    <span class="permission-name">تحميل المواد</span>
                                                    <small class="permission-desc">تحميل ملفات PDF والمرفقات</small>
                                                </div>
                                            </label>
                                            <label class="permission-item">
                                                <input type="checkbox" name="permissions" value="submit_assignments">
                                                <span class="permission-checkbox"></span>
                                                <div class="permission-info">
                                                    <span class="permission-name">تسليم الواجبات</span>
                                                    <small class="permission-desc">رفع وتسليم الواجبات والمشاريع</small>
                                                </div>
                                            </label>
                                            <label class="permission-item">
                                                <input type="checkbox" name="permissions" value="take_quizzes">
                                                <span class="permission-checkbox"></span>
                                                <div class="permission-info">
                                                    <span class="permission-name">أداء الاختبارات</span>
                                                    <small class="permission-desc">الدخول للاختبارات والتقييمات</small>
                                                </div>
                                            </label>
                                            <label class="permission-item">
                                                <input type="checkbox" name="permissions" value="view_certificates">
                                                <span class="permission-checkbox"></span>
                                                <div class="permission-info">
                                                    <span class="permission-name">الشهادات</span>
                                                    <small class="permission-desc">عرض وتحميل الشهادات</small>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- صلاحيات التواصل -->
                                    <div class="permission-category">
                                        <div class="category-header" onclick="toggleCategory('communication')">
                                            <i class="fas fa-chevron-down category-toggle"></i>
                                            <i class="fas fa-comments"></i>
                                            <span>التواصل والمناقشات</span>
                                            <span class="category-count" id="communicationCount">0/4</span>
                                        </div>
                                        <div class="category-permissions" id="communicationPermissions">
                                            <label class="permission-item">
                                                <input type="checkbox" name="permissions" value="post_discussions">
                                                <span class="permission-checkbox"></span>
                                                <div class="permission-info">
                                                    <span class="permission-name">كتابة المناقشات</span>
                                                    <small class="permission-desc">إنشاء مواضيع جديدة في المنتدى</small>
                                                </div>
                                            </label>
                                            <label class="permission-item">
                                                <input type="checkbox" name="permissions" value="comment_discussions">
                                                <span class="permission-checkbox"></span>
                                                <div class="permission-info">
                                                    <span class="permission-name">التعليق</span>
                                                    <small class="permission-desc">الرد على المناقشات والتعليقات</small>
                                                </div>
                                            </label>
                                            <label class="permission-item">
                                                <input type="checkbox" name="permissions" value="send_messages">
                                                <span class="permission-checkbox"></span>
                                                <div class="permission-info">
                                                    <span class="permission-name">الرسائل الخاصة</span>
                                                    <small class="permission-desc">إرسال رسائل للمدربين والطلاب</small>
                                                </div>
                                            </label>
                                            <label class="permission-item">
                                                <input type="checkbox" name="permissions" value="rate_courses">
                                                <span class="permission-checkbox"></span>
                                                <div class="permission-info">
                                                    <span class="permission-name">تقييم الدورات</span>
                                                    <small class="permission-desc">إضافة تقييمات ومراجعات</small>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- صلاحيات إدارية -->
                                    <div class="permission-category">
                                        <div class="category-header" onclick="toggleCategory('admin')">
                                            <i class="fas fa-chevron-down category-toggle"></i>
                                            <i class="fas fa-cogs"></i>
                                            <span>الصلاحيات الإدارية</span>
                                            <span class="category-count" id="adminCount">0/6</span>
                                        </div>
                                        <div class="category-permissions" id="adminPermissions">
                                            <label class="permission-item">
                                                <input type="checkbox" name="permissions" value="manage_users">
                                                <span class="permission-checkbox"></span>
                                                <div class="permission-info">
                                                    <span class="permission-name">إدارة المستخدمين</span>
                                                    <small class="permission-desc">إضافة وتعديل بيانات المستخدمين</small>
                                                </div>
                                            </label>
                                            <label class="permission-item">
                                                <input type="checkbox" name="permissions" value="manage_groups">
                                                <span class="permission-checkbox"></span>
                                                <div class="permission-info">
                                                    <span class="permission-name">إدارة المجموعات</span>
                                                    <small class="permission-desc">إنشاء وإدارة المجموعات التعليمية</small>
                                                </div>
                                            </label>
                                            <label class="permission-item">
                                                <input type="checkbox" name="permissions" value="view_reports">
                                                <span class="permission-checkbox"></span>
                                                <div class="permission-info">
                                                    <span class="permission-name">عرض التقارير</span>
                                                    <small class="permission-desc">الوصول لتقارير الأداء والإحصائيات</small>
                                                </div>
                                            </label>
                                            <label class="permission-item">
                                                <input type="checkbox" name="permissions" value="export_data">
                                                <span class="permission-checkbox"></span>
                                                <div class="permission-info">
                                                    <span class="permission-name">تصدير البيانات</span>
                                                    <small class="permission-desc">تصدير التقارير والبيانات</small>
                                                </div>
                                            </label>
                                            <label class="permission-item">
                                                <input type="checkbox" name="permissions" value="send_notifications">
                                                <span class="permission-checkbox"></span>
                                                <div class="permission-info">
                                                    <span class="permission-name">إرسال الإشعارات</span>
                                                    <small class="permission-desc">إرسال إشعارات للمستخدمين</small>
                                                </div>
                                            </label>
                                            <label class="permission-item">
                                                <input type="checkbox" name="permissions" value="manage_content">
                                                <span class="permission-checkbox"></span>
                                                <div class="permission-info">
                                                    <span class="permission-name">إدارة المحتوى</span>
                                                    <small class="permission-desc">تعديل محتوى الدورات</small>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- صلاحيات التحليلات -->
                                    <div class="permission-category">
                                        <div class="category-header" onclick="toggleCategory('analytics')">
                                            <i class="fas fa-chevron-down category-toggle"></i>
                                            <i class="fas fa-chart-bar"></i>
                                            <span>التحليلات والتقارير</span>
                                            <span class="category-count" id="analyticsCount">0/4</span>
                                        </div>
                                        <div class="category-permissions" id="analyticsPermissions">
                                            <label class="permission-item">
                                                <input type="checkbox" name="permissions" value="view_analytics">
                                                <span class="permission-checkbox"></span>
                                                <div class="permission-info">
                                                    <span class="permission-name">لوحة التحليلات</span>
                                                    <small class="permission-desc">عرض لوحة التحليلات العامة</small>
                                                </div>
                                            </label>
                                            <label class="permission-item">
                                                <input type="checkbox" name="permissions" value="view_progress_reports">
                                                <span class="permission-checkbox"></span>
                                                <div class="permission-info">
                                                    <span class="permission-name">تقارير التقدم</span>
                                                    <small class="permission-desc">متابعة تقدم الطلاب</small>
                                                </div>
                                            </label>
                                            <label class="permission-item">
                                                <input type="checkbox" name="permissions" value="view_financial_reports">
                                                <span class="permission-checkbox"></span>
                                                <div class="permission-info">
                                                    <span class="permission-name">التقارير المالية</span>
                                                    <small class="permission-desc">عرض الإيرادات والمدفوعات</small>
                                                </div>
                                            </label>
                                            <label class="permission-item">
                                                <input type="checkbox" name="permissions" value="create_custom_reports">
                                                <span class="permission-checkbox"></span>
                                                <div class="permission-info">
                                                    <span class="permission-name">تقارير مخصصة</span>
                                                    <small class="permission-desc">إنشاء تقارير مخصصة</small>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Custom Role Builder -->
                            <div class="custom-role-section">
                                <div class="section-header">
                                    <h3 class="section-title">
                                        <i class="fas fa-magic"></i>
                                        دور مخصص
                                    </h3>
                                    <div class="toggle-switch">
                                        <input type="checkbox" id="enableCustomRole">
                                        <label for="enableCustomRole">تفعيل دور مخصص</label>
                                    </div>
                                </div>

                                <div class="custom-role-builder" id="customRoleBuilder" style="display: none;">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label" for="customRoleName">
                                                <i class="fas fa-tag"></i>
                                                اسم الدور
                                            </label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="customRoleName" 
                                                   placeholder="مثال: منسق الدورات">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="customRoleColor">
                                                <i class="fas fa-palette"></i>
                                                لون الدور
                                            </label>
                                            <div class="color-picker">
                                                <input type="color" id="customRoleColor" value="#f4c430">
                                                <div class="color-presets">
                                                    <button type="button" class="color-preset" style="background: #f4c430" data-color="#f4c430"></button>
                                                    <button type="button" class="color-preset" style="background: #2196f3" data-color="#2196f3"></button>
                                                    <button type="button" class="color-preset" style="background: #4caf50" data-color="#4caf50"></button>
                                                    <button type="button" class="color-preset" style="background: #ff9800" data-color="#ff9800"></button>
                                                    <button type="button" class="color-preset" style="background: #9c27b0" data-color="#9c27b0"></button>
                                                    <button type="button" class="color-preset" style="background: #f44336" data-color="#f44336"></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="customRoleDescription">
                                            <i class="fas fa-align-left"></i>
                                            وصف الدور
                                        </label>
                                        <textarea class="form-control" 
                                                  id="customRoleDescription" 
                                                  rows="3" 
                                                  placeholder="اكتب وصف مختصر لهذا الدور ومسؤولياته..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Role Preview -->
                            <div class="role-preview">
                                <h3 class="section-title">
                                    <i class="fas fa-eye"></i>
                                    معاينة الصلاحيات
                                </h3>
                                <div class="preview-card">
                                    <div class="preview-header">
                                        <div class="preview-role">
                                            <i class="fas fa-user-graduate"></i>
                                            <span id="previewRoleName">طالب</span>
                                        </div>
                                        <div class="preview-stats">
                                            <span class="stat">
                                                <i class="fas fa-check-circle text-success"></i>
                                                <span id="activePermissionsCount">1</span> صلاحية نشطة
                                            </span>
                                            <span class="stat">
                                                <i class="fas fa-times-circle text-danger"></i>
                                                <span id="inactivePermissionsCount">18</span> صلاحية معطلة
                                            </span>
                                        </div>
                                    </div>
                                    <div class="preview-summary" id="previewSummary">
                                        <p>هذا المستخدم سيتمكن من:</p>
                                        <ul id="permissionsSummary">
                                            <li>عرض الدورات المسجل بها</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
<!-- ==================== Courses & Paths Tab Panel ==================== -->
                    <div class="tab-panel" id="coursesPanel" role="tabpanel" aria-labelledby="coursesTab">
                        <div class="panel-header">
                            <h2 class="panel-title">
                                <i class="fas fa-book"></i>
                                الدورات والمسارات
                            </h2>
                            <p class="panel-description">حدد الدورات والمسارات التعليمية المتاحة للمستخدم</p>
                        </div>

                        <div class="panel-content">
                            <!-- Search and Filter Section -->
                            <div class="search-filter-section">
                                <div class="search-box">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" 
                                           class="search-input" 
                                           id="courseSearchInput" 
                                           placeholder="ابحث عن دورة أو مسار...">
                                    <button class="search-clear" id="clearSearch" style="display: none;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                
                                <div class="filter-buttons">
                                    <button class="filter-btn active" data-filter="all">
                                        <i class="fas fa-th"></i>
                                        الكل
                                        <span class="filter-count" id="allCount">0</span>
                                    </button>
                                    <button class="filter-btn" data-filter="courses">
                                        <i class="fas fa-graduation-cap"></i>
                                        الدورات
                                        <span class="filter-count" id="coursesCount">0</span>
                                    </button>
                                    <button class="filter-btn" data-filter="paths">
                                        <i class="fas fa-route"></i>
                                        المسارات
                                        <span class="filter-count" id="pathsCount">0</span>
                                    </button>
                                    <button class="filter-btn" data-filter="selected">
                                        <i class="fas fa-check-circle"></i>
                                        المحددة
                                        <span class="filter-count" id="selectedCount">0</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Course Assignment Container -->
                            <div class="course-assignment-container">
                                <!-- Available Courses/Paths -->
                                <div class="assignment-column">
                                    <div class="column-header">
                                        <h3 class="column-title">
                                            <i class="fas fa-list"></i>
                                            الدورات والمسارات المتاحة
                                        </h3>
                                        <div class="column-actions">
                                            <select class="sort-select" id="sortSelect">
                                                <option value="name">الترتيب حسب الاسم</option>
                                                <option value="date">الترتيب حسب التاريخ</option>
                                                <option value="price">الترتيب حسب السعر</option>
                                                <option value="students">الترتيب حسب عدد الطلاب</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="items-container" id="availableItems">
                                        <!-- Loading State -->
                                        <div class="loading-state">
                                            <div class="spinner"></div>
                                            <p>جاري تحميل الدورات والمسارات...</p>
                                        </div>
                                        
                                        <!-- سيتم ملء العناصر بواسطة JavaScript -->
                                    </div>
                                </div>

                                <!-- Drag & Drop Area -->
                                <div class="drag-drop-area">
                                    <div class="drop-zone" id="dropZone">
                                        <i class="fas fa-hand-point-left"></i>
                                        <p>اسحب الدورات هنا</p>
                                        <span>أو انقر على الدورة لإضافتها</span>
                                    </div>
                                </div>

                                <!-- Assigned Courses/Paths -->
                                <div class="assignment-column">
                                    <div class="column-header">
                                        <h3 class="column-title">
                                            <i class="fas fa-user-check"></i>
                                            الدورات والمسارات المخصصة
                                        </h3>
                                        <div class="column-stats">
                                            <span class="stat-item">
                                                <i class="fas fa-book-open"></i>
                                                <span id="assignedCoursesCount">0</span> دورة
                                            </span>
                                            <span class="stat-item">
                                                <i class="fas fa-layer-group"></i>
                                                <span id="assignedPathsCount">0</span> مسار
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="items-container assigned-items" id="assignedItems">
                                        <div class="empty-state">
                                            <i class="fas fa-inbox"></i>
                                            <p>لم يتم تخصيص أي دورات بعد</p>
                                            <span>اختر من القائمة المجاورة</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Bulk Actions -->
                            <div class="bulk-actions">
                                <div class="bulk-actions-left">
                                    <button class="btn btn-outline" onclick="assignAllVisible()">
                                        <i class="fas fa-plus-circle"></i>
                                        إضافة جميع المرئية
                                    </button>
                                    <button class="btn btn-outline" onclick="removeAllAssigned()">
                                        <i class="fas fa-minus-circle"></i>
                                        إزالة الكل
                                    </button>
                                </div>
                                <div class="bulk-actions-right">
                                    <button class="btn btn-secondary" onclick="applyBulkSettings()">
                                        <i class="fas fa-cog"></i>
                                        إعدادات جماعية
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
<!-- ==================== Advanced Info Tab Panel ==================== -->
                    <div class="tab-panel" id="advancedPanel" role="tabpanel" aria-labelledby="advancedTab">
                        <div class="panel-header">
                            <h2 class="panel-title">
                                <i class="fas fa-cogs"></i>
                                المعلومات المتقدمة
                            </h2>
                            <p class="panel-description">أضف معلومات إضافية وحقول مخصصة للمستخدم</p>
                        </div>

                        <div class="panel-content">
                            <!-- Personal Information Section -->
                            <div class="info-section">
                                <div class="section-header">
                                    <h3 class="section-title">
                                        <i class="fas fa-user-circle"></i>
                                        المعلومات الشخصية
                                    </h3>
                                    <button class="section-toggle" onclick="toggleSection('personal')">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                </div>
                                
                                <div class="section-content" id="personalContent">
                                    <div class="form-grid-3">
                                        <div class="form-group">
                                            <label class="form-label" for="birthDate">
                                                <i class="fas fa-birthday-cake"></i>
                                                تاريخ الميلاد
                                            </label>
                                            <input type="date" class="form-control" id="birthDate">
                                            <div class="form-hint">سيستخدم لإرسال التهنئة</div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" for="gender">
                                                <i class="fas fa-venus-mars"></i>
                                                الجنس
                                            </label>
                                            <select class="form-control" id="gender">
                                                <option value="">-- اختر --</option>
                                                <option value="male">ذكر</option>
                                                <option value="female">أنثى</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" for="nationality">
                                                <i class="fas fa-flag"></i>
                                                الجنسية
                                            </label>
                                            <select class="form-control" id="nationality">
                                                <option value="">-- اختر --</option>
                                                <option value="EG">مصري</option>
                                                <option value="SA">سعودي</option>
                                                <option value="AE">إماراتي</option>
                                                <option value="KW">كويتي</option>
                                                <option value="QA">قطري</option>
                                                <option value="OM">عماني</option>
                                                <option value="BH">بحريني</option>
                                                <option value="JO">أردني</option>
                                                <option value="LB">لبناني</option>
                                                <option value="PS">فلسطيني</option>
                                                <option value="SY">سوري</option>
                                                <option value="IQ">عراقي</option>
                                                <option value="MA">مغربي</option>
                                                <option value="DZ">جزائري</option>
                                                <option value="TN">تونسي</option>
                                                <option value="LY">ليبي</option>
                                                <option value="SD">سوداني</option>
                                                <option value="YE">يمني</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Contact Information Section -->
                            <div class="info-section">
                                <div class="section-header">
                                    <h3 class="section-title">
                                        <i class="fas fa-address-card"></i>
                                        معلومات التواصل
                                    </h3>
                                    <button class="section-toggle" onclick="toggleSection('contact')">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                </div>
                                
                                <div class="section-content" id="contactContent">
                                    <div class="form-grid-2">
                                        <div class="form-group">
                                            <label class="form-label" for="country">
                                                <i class="fas fa-globe"></i>
                                                الدولة
                                            </label>
                                            <select class="form-control" id="country">
                                                <option value="">-- اختر الدولة --</option>
                                                <!-- سيتم ملؤها بواسطة JavaScript -->
                                            </select>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" for="city">
                                                <i class="fas fa-city"></i>
                                                المدينة
                                            </label>
                                            <input type="text" class="form-control" id="city" placeholder="أدخل المدينة">
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" for="timezone">
                                                <i class="fas fa-clock"></i>
                                                المنطقة الزمنية
                                            </label>
                                            <select class="form-control" id="timezone">
                                                <option value="">-- اختر المنطقة الزمنية --</option>
                                                <option value="Africa/Cairo">توقيت القاهرة (GMT+2)</option>
                                                <option value="Asia/Riyadh">توقيت الرياض (GMT+3)</option>
                                                <option value="Asia/Dubai">توقيت دبي (GMT+4)</option>
                                                <option value="Asia/Kuwait">توقيت الكويت (GMT+3)</option>
                                                <option value="Asia/Qatar">توقيت الدوحة (GMT+3)</option>
                                                <option value="Asia/Muscat">توقيت مسقط (GMT+4)</option>
                                                <option value="Asia/Bahrain">توقيت المنامة (GMT+3)</option>
                                                <option value="Asia/Amman">توقيت عمّان (GMT+2)</option>
                                                <option value="Asia/Beirut">توقيت بيروت (GMT+2)</option>
                                                <option value="Asia/Jerusalem">توقيت القدس (GMT+2)</option>
                                                <option value="Asia/Damascus">توقيت دمشق (GMT+2)</option>
                                                <option value="Asia/Baghdad">توقيت بغداد (GMT+3)</option>
                                                <option value="Africa/Casablanca">توقيت الدار البيضاء (GMT+1)</option>
                                                <option value="Africa/Algiers">توقيت الجزائر (GMT+1)</option>
                                                <option value="Africa/Tunis">توقيت تونس (GMT+1)</option>
                                                <option value="Africa/Tripoli">توقيت طرابلس (GMT+2)</option>
                                                <option value="Africa/Khartoum">توقيت الخرطوم (GMT+2)</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" for="language">
                                                <i class="fas fa-language"></i>
                                                اللغة المفضلة
                                            </label>
                                            <select class="form-control" id="language">
                                                <option value="ar">العربية</option>
                                                <option value="en">English</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label" for="address">
                                            <i class="fas fa-map-marker-alt"></i>
                                            العنوان التفصيلي
                                        </label>
                                        <textarea class="form-control" id="address" rows="2" placeholder="أدخل العنوان الكامل..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Professional Information Section -->
                            <div class="info-section">
                                <div class="section-header">
                                    <h3 class="section-title">
                                        <i class="fas fa-briefcase"></i>
                                        المعلومات المهنية
                                    </h3>
                                    <button class="section-toggle" onclick="toggleSection('professional')">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                </div>
                                
                                <div class="section-content" id="professionalContent">
                                    <div class="form-grid-2">
                                        <div class="form-group">
                                            <label class="form-label" for="occupation">
                                                <i class="fas fa-user-tie"></i>
                                                المهنة/الوظيفة
                                            </label>
                                            <input type="text" class="form-control" id="occupation" placeholder="مثال: مدير تسويق">
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" for="company">
                                                <i class="fas fa-building"></i>
                                                الشركة/المؤسسة
                                            </label>
                                            <input type="text" class="form-control" id="company" placeholder="اسم الشركة">
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" for="education">
                                                <i class="fas fa-graduation-cap"></i>
                                                المستوى التعليمي
                                            </label>
                                            <select class="form-control" id="education">
                                                <option value="">-- اختر --</option>
                                                <option value="high-school">ثانوية عامة</option>
                                                <option value="diploma">دبلوم</option>
                                                <option value="bachelor">بكالوريوس</option>
                                                <option value="master">ماجستير</option>
                                                <option value="phd">دكتوراه</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" for="experience">
                                                <i class="fas fa-award"></i>
                                                سنوات الخبرة
                                            </label>
                                            <select class="form-control" id="experience">
                                                <option value="">-- اختر --</option>
                                                <option value="0-1">أقل من سنة</option>
                                                <option value="1-3">1-3 سنوات</option>
                                                <option value="3-5">3-5 سنوات</option>
                                                <option value="5-10">5-10 سنوات</option>
                                                <option value="10+">أكثر من 10 سنوات</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label" for="interests">
                                            <i class="fas fa-heart"></i>
                                            الاهتمامات
                                        </label>
                                        <div class="tags-input" id="interestsContainer">
                                            <input type="text" 
                                                   class="tag-input" 
                                                   id="interestsInput" 
                                                   placeholder="اكتب اهتمام واضغط Enter">
                                            <div class="tags-list" id="interestsTags"></div>
                                        </div>
                                        <div class="form-hint">مثال: التسويق الرقمي، التطوير الشخصي، ريادة الأعمال</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Notification Preferences Section -->
                            <div class="info-section">
                                <div class="section-header">
                                    <h3 class="section-title">
                                        <i class="fas fa-bell"></i>
                                        تفضيلات الإشعارات
                                    </h3>
                                    <button class="section-toggle" onclick="toggleSection('notifications')">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                </div>
                                
                                <div class="section-content" id="notificationsContent">
                                    <div class="notification-preferences">
                                        <div class="notification-group">
                                            <h4 class="notification-title">
                                                <i class="fas fa-envelope"></i>
                                                البريد الإلكتروني
                                            </h4>
                                            <div class="notification-options">
                                                <label class="switch-item">
                                                    <input type="checkbox" id="emailNewCourse" checked>
                                                    <span class="switch-slider"></span>
                                                    <span class="switch-label">دورات جديدة</span>
                                                </label>
                                                <label class="switch-item">
                                                    <input type="checkbox" id="emailReminders" checked>
                                                    <span class="switch-slider"></span>
                                                    <span class="switch-label">تذكيرات الدروس</span>
                                                </label>
                                                <label class="switch-item">
                                                    <input type="checkbox" id="emailPromotions">
                                                    <span class="switch-slider"></span>
                                                    <span class="switch-label">العروض والخصومات</span>
                                                </label>
                                                <label class="switch-item">
                                                    <input type="checkbox" id="emailNewsletter">
                                                    <span class="switch-slider"></span>
                                                    <span class="switch-label">النشرة الإخبارية</span>
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="notification-group">
                                            <h4 class="notification-title">
                                                <i class="fab fa-whatsapp"></i>
                                                WhatsApp
                                            </h4>
                                            <div class="notification-options">
                                                <label class="switch-item">
                                                    <input type="checkbox" id="whatsappReminders" checked>
                                                    <span class="switch-slider"></span>
                                                    <span class="switch-label">تذكيرات مهمة</span>
                                                </label>
                                                <label class="switch-item">
                                                    <input type="checkbox" id="whatsappSupport" checked>
                                                    <span class="switch-slider"></span>
                                                    <span class="switch-label">رسائل الدعم</span>
                                                </label>
                                                <label class="switch-item">
                                                    <input type="checkbox" id="whatsappProgress">
                                                    <span class="switch-slider"></span>
                                                    <span class="switch-label">تقارير التقدم</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Custom Fields Section -->
                            <div class="info-section">
                                <div class="section-header">
                                    <h3 class="section-title">
                                        <i class="fas fa-plus-circle"></i>
                                        الحقول المخصصة
                                    </h3>
                                    <button class="btn btn-sm btn-primary" onclick="addCustomField()">
                                        <i class="fas fa-plus"></i>
                                        إضافة حقل
                                    </button>
                                </div>
                                
                                <div class="section-content">
                                    <div class="custom-fields-container" id="customFieldsContainer">
                                        <!-- سيتم إضافة الحقول المخصصة هنا -->
                                    </div>
                                    
                                    <div class="empty-custom-fields" id="emptyCustomFields">
                                        <i class="fas fa-folder-open"></i>
                                        <p>لا توجد حقول مخصصة</p>
                                        <span>انقر على "إضافة حقل" لإنشاء حقل جديد</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Admin Notes Section -->
                            <div class="info-section">
                                <div class="section-header">
                                    <h3 class="section-title">
                                        <i class="fas fa-sticky-note"></i>
                                        ملاحظات الإدارة
                                    </h3>
                                    <button class="section-toggle" onclick="toggleSection('adminNotes')">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                </div>
                                
                                <div class="section-content" id="adminNotesContent">
                                    <div class="admin-notes-editor">
                                        <div class="editor-toolbar">
                                            <button class="editor-btn" onclick="formatText('bold')">
                                                <i class="fas fa-bold"></i>
                                            </button>
                                            <button class="editor-btn" onclick="formatText('italic')">
                                                <i class="fas fa-italic"></i>
                                            </button>
                                            <button class="editor-btn" onclick="formatText('underline')">
                                                <i class="fas fa-underline"></i>
                                            </button>
                                            <div class="editor-separator"></div>
                                            <button class="editor-btn" onclick="formatText('insertUnorderedList')">
                                                <i class="fas fa-list-ul"></i>
                                            </button>
                                            <button class="editor-btn" onclick="formatText('insertOrderedList')">
                                                <i class="fas fa-list-ol"></i>
                                            </button>
                                            <div class="editor-separator"></div>
                                            <button class="editor-btn" onclick="insertLink()">
                                                <i class="fas fa-link"></i>
                                            </button>
                                            <button class="editor-btn" onclick="insertHighlight()">
                                                <i class="fas fa-highlighter"></i>
                                            </button>
                                        </div>
                                        <div class="editor-content" id="adminNotesEditor" contenteditable="true" placeholder="اكتب ملاحظاتك هنا..."></div>
                                    </div>
                                    
                                    <div class="notes-metadata">
                                        <div class="metadata-item">
                                            <i class="fas fa-user"></i>
                                            <span>آخر تعديل بواسطة: <strong id="lastEditedBy">-</strong></span>
                                        </div>
                                        <div class="metadata-item">
                                            <i class="fas fa-calendar-alt"></i>
                                            <span>تاريخ آخر تعديل: <strong id="lastEditedDate">-</strong></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Activity Timeline Section -->
                            <div class="info-section">
                                <div class="section-header">
                                    <h3 class="section-title">
                                        <i class="fas fa-history"></i>
                                        سجل النشاطات
                                    </h3>
                                    <button class="section-toggle" onclick="toggleSection('activity')">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                </div>
                                
                                <div class="section-content" id="activityContent">
                                    <div class="activity-timeline">
                                        <div class="timeline-item">
                                            <div class="timeline-icon" style="background: var(--success);">
                                                <i class="fas fa-user-plus"></i>
                                            </div>
                                            <div class="timeline-content">
                                                <h5 class="timeline-title">إنشاء الحساب</h5>
                                                <p class="timeline-description">تم إنشاء حساب المستخدم</p>
                                                <span class="timeline-date">
                                                    <i class="fas fa-clock"></i>
                                                    الآن
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-outline w-100 mt-3" onclick="loadMoreActivity()">
                                        <i class="fas fa-sync"></i>
                                        تحميل المزيد
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
<!-- ==================== Financial Tab Panel ==================== -->
                    <div class="tab-panel" id="financialPanel" role="tabpanel" aria-labelledby="financialTab">
                        <!-- القسم الأول: ملخص الحساب -->
                        <div class="financial-summary">
                            <h3 class="section-title">
                                <i class="fas fa-chart-line"></i>
                                ملخص الحساب المالي
                            </h3>
                            
                            <div class="summary-cards">
                                <div class="summary-card">
                                    <div class="summary-icon">
                                        <i class="fas fa-coins"></i>
                                    </div>
                                    <div class="summary-content">
                                        <h4>إجمالي المدفوعات</h4>
                                        <p class="amount" id="totalPaid">0 جنيه</p>
                                    </div>
                                </div>
                                
                                <div class="summary-card">
                                    <div class="summary-icon">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div class="summary-content">
                                        <h4>المستحقات</h4>
                                        <p class="amount" id="totalPending">0 جنيه</p>
                                    </div>
                                </div>
                                
                                <div class="summary-card">
                                    <div class="summary-icon">
                                        <i class="fas fa-gift"></i>
                                    </div>
                                    <div class="summary-content">
                                        <h4>المنح والخصومات</h4>
                                        <p class="amount" id="totalGrants">0 جنيه</p>
                                    </div>
                                </div>
                                
                                <div class="summary-card">
                                    <div class="summary-icon">
                                        <i class="fas fa-star"></i>
                                    </div>
                                    <div class="summary-content">
                                        <h4>نقاط الولاء</h4>
                                        <p class="amount" id="loyaltyPoints">0 نقطة</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- القسم الثاني: إضافة معاملة جديدة -->
                        <div class="add-transaction-section">
                            <h3 class="section-title">
                                <i class="fas fa-plus-circle"></i>
                                إضافة معاملة مالية جديدة
                            </h3>
                            
                            <form id="transactionForm" class="transaction-form">
                                <div class="form-row">
                                    <div class="form-group col-md-4">
                                        <label>نوع المعاملة</label>
                                        <select class="form-control" id="transactionType" onchange="updateTransactionForm()">
                                            <option value="payment">دفعة مالية</option>
                                            <option value="grant">منحة دراسية</option>
                                            <option value="gift">هدية/مكافأة</option>
                                            <option value="compensation">تعويض</option>
                                            <option value="refund">استرجاع</option>
                                            <option value="group-offer">عرض ضمن مجموعة</option>
                                            <option value="recommendation">توصية خاصة</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group col-md-4">
                                        <label>المبلغ</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="transactionAmount" 
                                                   placeholder="0" min="0" step="0.01">
                                            <div class="input-group-append">
                                                <span class="input-group-text">جنيه</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group col-md-4">
                                        <label>تاريخ المعاملة</label>
                                        <input type="datetime-local" class="form-control" id="transactionDate">
                                    </div>
                                </div>

                                <div class="form-row" id="paymentDetailsRow">
                                    <div class="form-group col-md-4">
                                        <label>طريقة الدفع</label>
                                        <select class="form-control" id="paymentMethod">
                                            <option value="">اختر طريقة الدفع</option>
                                            <option value="vodafone">فودافون كاش</option>
                                            <option value="instapay">InstaPay</option>
                                            <option value="bank">تحويل بنكي</option>
                                            <option value="western">ويسترن يونيون</option>
                                            <option value="cash">نقدي</option>
                                            <option value="other">أخرى</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group col-md-4">
                                        <label>رقم المعاملة/المرجع</label>
                                        <input type="text" class="form-control" id="transactionReference" 
                                               placeholder="رقم الإيصال أو المرجع" readonly>
                                        <div class="form-hint">سيتم توليده تلقائياً</div>
                                    </div>
                                    
                                    <div class="form-group col-md-4">
                                        <label>حالة المعاملة</label>
                                        <select class="form-control" id="transactionStatus">
                                            <option value="completed">مكتملة</option>
                                            <option value="pending">معلقة</option>
                                            <option value="failed">فشلت</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label>مرتبطة بـ</label>
                                        <select class="form-control" id="relatedType" onchange="updateRelatedOptions()">
                                            <option value="">غير مرتبطة</option>
                                            <option value="course">دورة تدريبية</option>
                                            <option value="path">مسار تدريبي</option>
                                            <option value="subscription">اشتراك</option>
                                            <option value="other">أخرى</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group col-md-6" id="relatedItemGroup" style="display: none;">
                                        <label>اختر العنصر</label>
                                        <select class="form-control" id="relatedItem">
                                            <option value="">اختر...</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-row" id="installmentRow" style="display: none;">
                                    <div class="form-group col-md-3">
                                        <label>نوع الدفع</label>
                                        <select class="form-control" id="paymentPlanType" onchange="toggleInstallmentDetails()">
                                            <option value="full">دفعة واحدة</option>
                                            <option value="installment">أقساط</option>
                                        </select>
                                    </div>
                                    
                                    <div class="installment-details" style="display: none;">
                                        <div class="form-group col-md-3">
                                            <label>عدد الأقساط</label>
                                            <input type="number" class="form-control" id="totalInstallments" 
                                                   min="2" max="12" placeholder="2">
                                        </div>
                                        
                                        <div class="form-group col-md-3">
                                            <label>رقم القسط الحالي</label>
                                            <input type="number" class="form-control" id="currentInstallment" 
                                                   min="1" placeholder="1">
                                        </div>
                                        
                                        <div class="form-group col-md-3">
                                            <label>تكرار الأقساط</label>
                                            <select class="form-control" id="installmentFrequency">
                                                <option value="monthly">شهري</option>
                                                <option value="weekly">أسبوعي</option>
                                                <option value="custom">مخصص</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>ملاحظات</label>
                                    <textarea class="form-control" id="transactionNotes" rows="2" 
                              placeholder="أي ملاحظات إضافية..."></textarea>
                                </div>

                                <div class="form-actions">
                                    <button type="button" class="btn btn-primary" onclick="addTransaction()">
                                        <i class="fas fa-plus"></i> إضافة المعاملة
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="resetTransactionForm()">
                                        <i class="fas fa-undo"></i> إعادة تعيين
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- القسم الثالث: سجل المعاملات -->
                        <div class="transactions-history">
                            <h3 class="section-title">
                                <i class="fas fa-history"></i>
                                سجل المعاملات المالية
                            </h3>
                            
                            <div class="filters-row">
                                <div class="filter-group">
                                    <label>نوع المعاملة:</label>
                                    <select class="form-control form-control-sm" id="filterType">
                                        <option value="">الكل</option>
                                        <option value="payment">دفعات</option>
                                        <option value="grant">منح</option>
                                        <option value="gift">هدايا</option>
                                        <option value="compensation">تعويضات</option>
                                        <option value="refund">مسترجعات</option>
                                        <option value="group-offer">عروض مجموعة</option>
                                        <option value="recommendation">توصيات</option>
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label>الحالة:</label>
                                    <select class="form-control form-control-sm" id="filterStatus">
                                        <option value="">الكل</option>
                                        <option value="completed">مكتملة</option>
                                        <option value="pending">معلقة</option>
                                        <option value="failed">فاشلة</option>
                                        <option value="overdue">متأخرة</option>
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label>الفترة:</label>
                                    <select class="form-control form-control-sm" id="filterPeriod">
                                        <option value="">كل الأوقات</option>
                                        <option value="today">اليوم</option>
                                        <option value="week">هذا الأسبوع</option>
                                        <option value="month">هذا الشهر</option>
                                        <option value="year">هذه السنة</option>
                                    </select>
                                </div>

                                <div class="filter-group">
                                    <label>الدورة:</label>
                                    <select class="form-control form-control-sm" id="filterCourse">
                                        <option value="">كل الدورات</option>
                                        <!-- سيتم ملؤها ديناميكياً -->
                                    </select>
                                </div>

                                <div class="filter-group">
                                    <label>المسار:</label>
                                    <select class="form-control form-control-sm" id="filterPath">
                                        <option value="">كل المسارات</option>
                                        <!-- سيتم ملؤها ديناميكياً -->
                                    </select>
                                </div>

                                <div class="filter-group">
                                    <label>الاستحقاق:</label>
                                    <select class="form-control form-control-sm" id="filterDueDate">
                                        <option value="">الكل</option>
                                        <option value="overdue">متأخرة</option>
                                        <option value="this-month">هذا الشهر</option>
                                        <option value="next-month">الشهر القادم</option>
                                        <option value="future">مستقبلية</option>
                                    </select>
                                </div>
                                
                                <button class="btn btn-sm btn-primary" onclick="applyFilters()">
                                    <i class="fas fa-filter"></i> تطبيق
                                </button>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>تاريخ الإنشاء</th>
                                            <th>تاريخ الاستحقاق</th>
                                            <th>آخر تحديث</th>
                                            <th>النوع</th>
                                            <th>المبلغ</th>
                                            <th>طريقة الدفع</th>
                                            <th>المرجع</th>
                                            <th>مرتبط بـ</th>
                                            <th>الحالة</th>
                                            <th>إجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactionsTableBody">
                                        <!-- سيتم ملؤها بواسطة JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div id="noTransactions" class="text-center text-muted py-4" style="display: none;">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <p>لا توجد معاملات مالية حتى الآن</p>
                            </div>
                        </div>

                        <!-- القسم الرابع: الأقساط المستقبلية المطورة -->
                        <div class="upcoming-payments">
                            <h3 class="section-title">
                                <i class="fas fa-calendar-check"></i>
                                الأقساط المستقبلية
                            </h3>
                            
                            <div id="upcomingPaymentsList">
                                <!-- سيتم ملؤها بواسطة JavaScript -->
                            </div>
                            
                            <div id="noUpcomingPayments" class="text-center text-muted py-4">
                                <i class="fas fa-calendar-times fa-3x mb-3"></i>
                                <p>لا توجد أقساط مستقبلية</p>
                            </div>
                        </div>

                        <!-- القسم الخامس: بيان الاستثمار الجديد -->
                        <div class="investment-statements">
                            <h3 class="section-title">
                                <i class="fas fa-file-invoice-dollar"></i>
                                بيان الاستثمار
                            </h3>

                            <div class="statement-selector">
                                <select class="statement-select" id="statementSelect" onchange="loadInvestmentStatement()">
                                    <option value="">اختر دورة أو مسار لعرض البيان</option>
                                    <!-- سيتم ملؤها ديناميكياً -->
                                </select>
                                <button class="btn btn-primary" onclick="sendWhatsAppStatement()" id="sendStatementBtn" disabled>
                                    <i class="fab fa-whatsapp"></i>
                                    إرسال بيان WhatsApp
                                </button>
                            </div>

                            <div class="statement-preview" id="statementPreview" style="display: none;">
                                <div class="statement-header">
                                    <h4 class="statement-title" id="statementTitle">-</h4>
                                    <div class="statement-meta">
                                        <span><i class="fas fa-calendar"></i> تاريخ البدء: <span id="statementStartDate">-</span></span>
                                        <span><i class="fas fa-clock"></i> آخر تحديث: <span id="statementLastUpdate">-</span></span>
                                    </div>
                                </div>

                                <div class="statement-summary">
                                    <div class="summary-item">
                                        <div class="summary-label">القيمة الأصلية</div>
                                        <div class="summary-value" id="statementOriginalPrice">0 جنيه</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="summary-label">الخصم</div>
                                        <div class="summary-value text-success" id="statementDiscount">0 جنيه</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="summary-label">الإجمالي</div>
                                        <div class="summary-value text-primary" id="statementTotal">0 جنيه</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="summary-label">المدفوع</div>
                                        <div class="summary-value text-success" id="statementPaid">0 جنيه</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="summary-label">المتبقي</div>
                                        <div class="summary-value text-warning" id="statementRemaining">0 جنيه</div>
                                    </div>
                                </div>

                                <div class="statement-chart">
                                    <canvas id="statementChart"></canvas>
                                </div>

                                <div class="statement-table">
                                    <h5>تفاصيل الدفعات</h5>
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>رقم القسط</th>
                                                <th>التاريخ</th>
                                                <th>المبلغ</th>
                                                <th>الحالة</th>
                                                <th>تاريخ الدفع</th>
                                            </tr>
                                        </thead>
                                        <tbody id="statementDetailsBody">
                                            <!-- سيتم ملؤها ديناميكياً -->
                                        </tbody>
                                    </table>
                                </div>

                                <div class="statement-actions">
                                    <button class="btn btn-outline" onclick="printStatement()">
                                        <i class="fas fa-print"></i>
                                        طباعة البيان
                                    </button>
                                    <button class="btn btn-outline" onclick="downloadStatement()">
                                        <i class="fas fa-download"></i>
                                        تحميل PDF
                                    </button>
                                    <button class="btn btn-whatsapp" onclick="sendWhatsAppStatement()">
                                        <i class="fab fa-whatsapp"></i>
                                        إرسال عبر WhatsApp
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

</div>
                <!-- نهاية Tab Panels Container -->
            </div>
            <!-- نهاية Tabs Container -->

            <!-- Form Actions -->
            <div class="form-actions">
                <div class="actions-left">
                    <button class="btn btn-outline" id="cancelBtn">
                        <i class="fas fa-times"></i>
                        إلغاء
                    </button>
                    <button class="btn btn-outline" id="resetBtn">
                        <i class="fas fa-redo"></i>
                        إعادة تعيين
                    </button>
                </div>
                <div class="actions-right">
                    <button class="btn btn-secondary" id="saveDraftBtn">
                        <i class="fas fa-file-alt"></i>
                        حفظ كمسودة
                    </button>
                    <button class="btn btn-primary" id="saveBtn">
                        <i class="fas fa-check"></i>
                        <span id="saveBtnText">إنشاء المستخدم</span>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- ==================== Course Item Template (يستخدم في JavaScript) ==================== -->
    <template id="courseItemTemplate">
        <div class="course-item" draggable="true">
            <div class="item-header">
                <div class="item-type-badge">
                    <i class="fas fa-graduation-cap"></i>
                    <span>دورة</span>
                </div>
                <button class="item-action-btn add-btn">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            
            <div class="item-thumbnail">
                <img src="" alt="">
                <div class="item-price">
                    <span class="price-value">0</span>
                    <span class="price-currency">ريال</span>
                </div>
            </div>
            
            <div class="item-content">
                <h4 class="item-title"></h4>
                <p class="item-instructor">
                    <i class="fas fa-user-tie"></i>
                    <span></span>
                </p>
                <div class="item-meta">
                    <span class="meta-item">
                        <i class="fas fa-clock"></i>
                        <span class="duration"></span>
                    </span>
                    <span class="meta-item">
                        <i class="fas fa-users"></i>
                        <span class="students-count"></span>
                    </span>
                </div>
            </div>
        </div>
    </template>

    <!-- ==================== Assigned Item Template ==================== -->
    <template id="assignedItemTemplate">
        <div class="assigned-item">
            <div class="assigned-item-header">
                <div class="assigned-item-info">
                    <div class="item-type-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div>
                        <h4 class="assigned-item-title"></h4>
                        <p class="assigned-item-type"></p>
                    </div>
                </div>
                <button class="remove-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="assigned-item-settings">
                <!-- تواريخ الوصول -->
                <div class="setting-group">
                    <label class="setting-label">
                        <i class="fas fa-calendar-alt"></i>
                        فترة الوصول
                    </label>
                    <div class="date-inputs">
                        <input type="date" class="date-input start-date" placeholder="تاريخ البداية">
                        <span class="date-separator">إلى</span>
                        <input type="date" class="date-input end-date" placeholder="تاريخ النهاية">
                    </div>
                </div>
                
                <!-- نوع الوصول -->
                <div class="setting-group">
                    <label class="setting-label">
                        <i class="fas fa-key"></i>
                        نوع الوصول
                    </label>
                    <select class="setting-select access-type">
                        <option value="full">وصول كامل</option>
                        <option value="limited">وصول محدود</option>
                        <option value="preview">معاينة فقط</option>
                    </select>
                </div>
                
                <!-- السعر المخصص -->
                <div class="setting-group">
                    <label class="setting-label">
                        <i class="fas fa-tag"></i>
                        السعر المخصص
                    </label>
                    <div class="price-input-group">
                        <input type="number" class="price-input" placeholder="0" min="0">
                        <select class="currency-select">
                            <option value="SAR">ريال سعودي</option>
                            <option value="EGP">جنيه مصري</option>
                            <option value="USD">دولار أمريكي</option>
                        </select>
                        <label class="checkbox-label">
                            <input type="checkbox" class="free-checkbox">
                            <span>مجاني</span>
                        </label>
                    </div>
                </div>
                
                <!-- ملاحظات -->
                <div class="setting-group">
                    <label class="setting-label">
                        <i class="fas fa-sticky-note"></i>
                        ملاحظات
                    </label>
                    <textarea class="setting-textarea" rows="2" placeholder="ملاحظات خاصة بهذا التخصيص..."></textarea>
                </div>
            </div>
        </div>
    </template>

    <!-- ==================== Bulk Settings Modal ==================== -->
    <div class="modal" id="bulkSettingsModal" style="display: none;">
        <div class="modal-backdrop" onclick="closeBulkSettings()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-cogs"></i>
                    إعدادات جماعية
                </h3>
                <button class="modal-close" onclick="closeBulkSettings()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <p class="modal-description">ستطبق هذه الإعدادات على جميع الدورات والمسارات المخصصة</p>
                
                <div class="bulk-settings-form">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-calendar-alt"></i>
                            فترة الوصول الافتراضية
                        </label>
                        <div class="duration-input">
                            <input type="number" id="bulkDuration" value="90" min="1">
                            <select id="bulkDurationUnit">
                                <option value="days">يوم</option>
                                <option value="weeks">أسبوع</option>
                                <option value="months" selected>شهر</option>
                                <option value="years">سنة</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-key"></i>
                            نوع الوصول
                        </label>
                        <select class="form-control" id="bulkAccessType">
                            <option value="full">وصول كامل</option>
                            <option value="limited">وصول محدود</option>
                            <option value="preview">معاينة فقط</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-percent"></i>
                            نسبة الخصم
                        </label>
                        <div class="discount-input">
                            <input type="number" id="bulkDiscount" placeholder="0" min="0" max="100">
                            <span class="discount-symbol">%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeBulkSettings()">
                    إلغاء
                </button>
                <button class="btn btn-primary" onclick="applyBulkSettingsConfirm()">
                    <i class="fas fa-check"></i>
                    تطبيق على الكل
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== Custom Field Modal ==================== -->
    <div class="modal" id="customFieldModal" style="display: none;">
        <div class="modal-backdrop" onclick="closeCustomFieldModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-plus-circle"></i>
                    إضافة حقل مخصص
                </h3>
                <button class="modal-close" onclick="closeCustomFieldModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label required" for="fieldLabel">
                        <i class="fas fa-tag"></i>
                        اسم الحقل
                    </label>
                    <input type="text" class="form-control" id="fieldLabel" placeholder="مثال: رقم الهوية">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="fieldType">
                        <i class="fas fa-list"></i>
                        نوع الحقل
                    </label>
                    <select class="form-control" id="fieldType">
                        <option value="text">نص</option>
                        <option value="number">رقم</option>
                        <option value="email">بريد إلكتروني</option>
                        <option value="date">تاريخ</option>
                        <option value="select">قائمة منسدلة</option>
                        <option value="textarea">نص طويل</option>
                        <option value="checkbox">مربع اختيار</option>
                    </select>
                </div>
                
                <div class="form-group" id="fieldOptionsGroup" style="display: none;">
                    <label class="form-label" for="fieldOptions">
                        <i class="fas fa-list-ul"></i>
                        خيارات القائمة
                    </label>
                    <textarea class="form-control" id="fieldOptions" rows="4" placeholder="خيار 1&#10;خيار 2&#10;خيار 3"></textarea>
                    <div class="form-hint">اكتب كل خيار في سطر منفصل</div>
                </div>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="fieldRequired">
                        <span>حقل مطلوب</span>
                    </label>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeCustomFieldModal()">
                    إلغاء
                </button>
                <button class="btn btn-primary" onclick="saveCustomField()">
                    <i class="fas fa-check"></i>
                    إضافة الحقل
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== Transaction Edit Modal (جديد) ==================== -->
    <div class="modal transaction-edit-modal" id="transactionEditModal" style="display: none;">
        <div class="modal-backdrop" onclick="closeTransactionEditModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-edit"></i>
                    تعديل المعاملة
                </h3>
                <button class="modal-close" onclick="closeTransactionEditModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="transactionEditForm" class="transaction-edit-form">
                    <input type="hidden" id="editTransactionId">
                    
                    <div class="transaction-edit-grid">
                        <div class="form-group">
                            <label class="form-label">نوع المعاملة</label>
                            <select class="form-control" id="editTransactionType">
                                <option value="payment">دفعة مالية</option>
                                <option value="grant">منحة دراسية</option>
                                <option value="gift">هدية/مكافأة</option>
                                <option value="compensation">تعويض</option>
                                <option value="refund">استرجاع</option>
                                <option value="group-offer">عرض ضمن مجموعة</option>
                                <option value="recommendation">توصية خاصة</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">المبلغ</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="editTransactionAmount" 
                                       placeholder="0" min="0" step="0.01">
                                <div class="input-group-append">
                                    <span class="input-group-text">جنيه</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">تاريخ المعاملة</label>
                            <input type="datetime-local" class="form-control" id="editTransactionDate">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">تاريخ الاستحقاق</label>
                            <input type="date" class="form-control" id="editDueDate">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">طريقة الدفع</label>
                            <select class="form-control" id="editPaymentMethod">
                                <option value="">اختر طريقة الدفع</option>
                                <option value="vodafone">فودافون كاش</option>
                                <option value="instapay">InstaPay</option>
                                <option value="bank">تحويل بنكي</option>
                                <option value="western">ويسترن يونيون</option>
                                <option value="cash">نقدي</option>
                                <option value="other">أخرى</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">حالة المعاملة</label>
                            <select class="form-control" id="editTransactionStatus">
                                <option value="completed">مكتملة</option>
                                <option value="pending">معلقة</option>
                                <option value="failed">فشلت</option>
                                <option value="overdue">متأخرة</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">المرجع</label>
                        <input type="text" class="form-control" id="editTransactionReference" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ملاحظات</label>
                        <textarea class="form-control" id="editTransactionNotes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeTransactionEditModal()">
                    إلغاء
                </button>
                <button class="btn btn-primary" onclick="updateTransaction()">
                    <i class="fas fa-save"></i>
                    حفظ التعديلات
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== حاوية للنوافذ المخصصة الأخرى ==================== -->
    <div id="customModalsContainer"></div>

    <!-- ==================== إغلاق أزرار التحكم بالنوافذ ==================== -->
    <script>
        // دوال إغلاق النوافذ المنبثقة
        function closeBulkSettings() {
            document.getElementById('bulkSettingsModal').style.display = 'none';
        }
        
        function closeCustomFieldModal() {
            document.getElementById('customFieldModal').style.display = 'none';
            document.getElementById('fieldLabel').value = '';
            document.getElementById('fieldType').value = 'text';
            document.getElementById('fieldOptions').value = '';
            document.getElementById('fieldRequired').checked = false;
            document.getElementById('fieldOptionsGroup').style.display = 'none';
        }
        
        function closeTransactionEditModal() {
            document.getElementById('transactionEditModal').style.display = 'none';
            document.getElementById('transactionEditForm').reset();
        }
        
        // توقف أحداث نقر الخلفية عن إغلاق النموذج عند النقر على المحتوى
        document.querySelectorAll('.modal-content').forEach(content => {
    content.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        });
    </script>
<!-- ==================== Firebase Configuration & Main Script ==================== -->
    <script src="../js/firebase-config.js"></script>
    <script>
        // ==================== Global Variables ====================
        let currentUser = null;
        let editMode = false;
        let currentUserId = null;
        let autoSaveTimer = null;
        let formData = {
            basic: {},
            roles: {},
            courses: [],
            advanced: {},
            financial: {
                transactions: [],
                wallet: {
                    balance: {
                        total: 0,
                        paid: 0,
                        pending: 0,
                        grants: 0,
                        points: 0
                    },
                    upcomingPayments: []
                }
            }
        };
        let customFields = [];
        let availableCourses = [];
        let availablePaths = [];
        
        // متغيرات المعاملات المالية
        let userTransactions = [];
        let userWallet = {
            balance: {
                total: 0,
                paid: 0,
                pending: 0,
                grants: 0,
                points: 0
            },
            upcomingPayments: []
        };

        // ==================== Structure للمعاملات الجديد ====================
        const TransactionStructure = {
            // بنية المعاملة الواحدة
            createTransaction: function(data) {
                return {
                    id: data.id || 'temp_' + Date.now(),
                    userId: data.userId || currentUserId,
                    type: data.type, // payment, grant, gift, compensation, refund, group-offer, recommendation
                    amount: data.amount || 0,
                    currency: data.currency || 'EGP',
                    
                    // التواريخ
                    createdAt: data.createdAt || new Date().toISOString(),
                    dueDate: data.dueDate || null,
                    lastUpdated: data.lastUpdated || new Date().toISOString(),
                    paidDate: data.paidDate || null,
                    
                    // معلومات الدفع
                    paymentMethod: data.paymentMethod || null,
                    reference: data.reference || this.generateReference(data),
                    status: data.status || 'pending', // completed, pending, failed, overdue
                    
                    // الربط
                    relatedTo: data.relatedTo || null, // {type: 'course/path', id: '', title: ''}
                    
                    // تفاصيل الأقساط
                    installmentInfo: data.installmentInfo || null, // {number: 1, total: 4, frequency: 'monthly'}
                    
                    // معلومات إضافية
                    notes: data.notes || '',
                    discount: data.discount || 0,
                    originalAmount: data.originalAmount || data.amount,
                    
                    // البيانات الإدارية
                    createdBy: data.createdBy || currentUser?.email || 'system',
                    lastUpdatedBy: data.lastUpdatedBy || currentUser?.email || 'system'
                };
            },
            
            // توليد المرجع التلقائي
            generateReference: function(data) {
                const userId = data.userId || currentUserId || 'guest';
                const courseCode = data.relatedTo ? this.getCourseCode(data.relatedTo.title) : 'GEN';
                const installmentNumber = data.installmentInfo ? String(data.installmentInfo.number).padStart(2, '0') : '00';
                const timestamp = Date.now().toString().slice(-4);
                
                return `${userId}-${courseCode}-${installmentNumber}-${timestamp}`;
            },
            
            // استخراج كود الدورة
            getCourseCode: function(title) {
                if (!title) return 'GEN';
                
                // إزالة الكلمات الشائعة
                const commonWords = ['دورة', 'مسار', 'في', 'على', 'مع', 'من', 'إلى'];
                let words = title.split(' ').filter(word => !commonWords.includes(word));
                
                // أخذ أول حرفين من أول كلمتين
                let code = '';
                for (let i = 0; i < Math.min(2, words.length); i++) {
                    code += words[i].substring(0, 2).toUpperCase();
                }
                
                return code || 'CRS';
            }
        };

        // ==================== Structure للدورات في Firebase ====================
        const CourseFinancialStructure = {
            // إنشاء سجل مالي لدورة
            createCourseFinancialRecord: function(courseId, courseData, paymentOptions) {
                return {
                    courseId: courseId,
                    courseType: courseData.type, // course or path
                    courseTitle: courseData.title,
                    userId: currentUserId,
                    
                    // معلومات السعر
                    pricing: {
                        originalPrice: courseData.price || 0,
                        discount: paymentOptions.discount || 0,
                        discountAmount: (courseData.price * paymentOptions.discount / 100) || 0,
                        finalPrice: paymentOptions.finalPrice || courseData.price,
                        currency: 'EGP'
                    },
                    
                    // خطة الدفع
                   paymentPlan: {
    type: paymentOptions.paymentType,
    totalInstallments: paymentOptions.installmentCount || 1,
    installmentFrequency: paymentOptions.frequency || 'monthly',
    firstPaymentAmount: paymentOptions.firstPayment || paymentOptions?.finalPrice || courseData.price || 0
},
                    
                    // المعاملات
                    transactions: [], // سيتم ملؤها بالمعاملات
                    
                    // الملخص
                    summary: {
    totalAmount: paymentOptions?.finalPrice || courseData.price || 0,
    paidAmount: 0,
    pendingAmount: paymentOptions?.finalPrice || courseData.price || 0,
    remainingAmount: paymentOptions?.finalPrice || courseData.price || 0,
    completedInstallments: 0,
    status: 'active'
},
                   
                    // التواريخ
                    enrollmentDate: new Date().toISOString(),
                    lastPaymentDate: null,
                    nextPaymentDate: null,
                    completionDate: null,
                    
                    // البيانات الإدارية
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser?.email || 'system'
                };
            }
        };

        // ==================== Cache للبيانات ====================
        const DataCache = {
            courses: new Map(),
            transactions: new Map(),
            filterPreferences: {},
            
            // حفظ في الكاش
            set: function(type, key, value) {
                if (type === 'courses') {
                    this.courses.set(key, value);
                } else if (type === 'transactions') {
                    this.transactions.set(key, value);
                }
                
                // حفظ في localStorage أيضاً
                try {
                    localStorage.setItem(`cache_${type}_${key}`, JSON.stringify(value));
                } catch (e) {
                    console.warn('خطأ في حفظ الكاش:', e);
                }
            },
            
            // جلب من الكاش
            get: function(type, key) {
                let value = null;
                
                if (type === 'courses') {
                    value = this.courses.get(key);
                } else if (type === 'transactions') {
                    value = this.transactions.get(key);
                }
                
                // إذا لم يكن موجود في الذاكرة، جرب localStorage
                if (!value) {
                    try {
                        const stored = localStorage.getItem(`cache_${type}_${key}`);
                        if (stored) {
                            value = JSON.parse(stored);
                            this.set(type, key, value); // احفظه في الذاكرة
                        }
                    } catch (e) {
                        console.warn('خطأ في قراءة الكاش:', e);
                    }
                }
                
                return value;
            },
            
            // مسح الكاش
            clear: function(type) {
                if (type === 'courses') {
                    this.courses.clear();
                } else if (type === 'transactions') {
                    this.transactions.clear();
                } else {
                    this.courses.clear();
                    this.transactions.clear();
                }
                
                // مسح من localStorage
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith(`cache_${type || ''}`)) {
                        localStorage.removeItem(key);
                    }
                });
            }
        };

        // ==================== قوالب رسائل WhatsApp ====================
        const WhatsAppTemplates = {
            // قالب بيان الاستثمار
            investmentStatement: function(data) {
                return `🎓 *بيان استثمارك في ${data.courseTitle}*

💰 *التفاصيل المالية:*
- القيمة الأصلية: ${data.originalPrice} جنيه
${data.discount > 0 ? `• الخصم: ${data.discount}% (${data.discountAmount} جنيه)` : ''}
- الإجمالي: ${data.totalAmount} جنيه

✅ *المدفوع:* ${data.paidAmount} جنيه
⏳ *المتبقي:* ${data.remainingAmount} جنيه

${data.installments ? `📅 *الأقساط القادمة:*
${data.installments.map(inst => `• ${inst.date}: ${inst.amount} جنيه`).join('\n')}` : ''}

📊 *نسبة الإنجاز:* ${data.progressPercentage}%

${data.notes ? `📝 *ملاحظات:* ${data.notes}` : ''}

_تم إنشاء هذا البيان بتاريخ ${new Date().toLocaleDateString('ar-EG')}_

مع تحيات فريق منظور الفؤاد 💛`;
            },
            
            // قالب تذكير بالقسط
            installmentReminder: function(data) {
                return `تذكير بموعد القسط 📅

مرحباً ${data.userName} 👋

نود تذكيرك بموعد دفع القسط القادم:
- الدورة: ${data.courseTitle}
- المبلغ: ${data.amount} جنيه
- التاريخ: ${data.dueDate}

يمكنك الدفع عبر:
${data.paymentMethods.map(method => `• ${method}`).join('\n')}

للاستفسار تواصل معنا على هذا الرقم

شكراً لثقتك بنا 🙏`;
            },
            
            // قالب تأكيد الدفع
            paymentConfirmation: function(data) {
                return `✅ تم استلام دفعتك بنجاح!

- المبلغ: ${data.amount} جنيه
- الدورة: ${data.courseTitle}
- رقم المرجع: ${data.reference}
- التاريخ: ${data.date}

${data.remainingAmount > 0 ? `💰 المتبقي: ${data.remainingAmount} جنيه` : '🎉 تم سداد كامل المبلغ!'}

شكراً لك وبالتوفيق في رحلتك التعليمية 🚀`;
            }
        };

        // ==================== Permissions Functions ====================
function updatePermissionsForRole(role) {
    // إعادة تعيين جميع الصلاحيات
    document.querySelectorAll('input[name="permissions"]').forEach(cb => {
        cb.checked = false;
    });
    
    // تحديد الصلاحيات حسب الدور
    const rolePermissions = {
        student: ['view_courses', 'download_materials', 'submit_assignments', 'take_quizzes', 'view_certificates'],
        assistant: ['view_courses', 'download_materials', 'submit_assignments', 'take_quizzes', 'view_certificates', 
                    'post_discussions', 'comment_discussions', 'send_messages', 'rate_courses'],
        'group-leader': ['view_courses', 'download_materials', 'submit_assignments', 'take_quizzes', 'view_certificates',
                         'post_discussions', 'comment_discussions', 'send_messages', 'rate_courses',
                         'manage_groups', 'view_reports', 'send_notifications'],
        analyst: ['view_courses', 'view_reports', 'view_analytics', 'view_progress_reports', 
                  'view_financial_reports', 'export_data']
    };
    
    const permissions = rolePermissions[role] || [];
    permissions.forEach(permission => {
        const checkbox = document.querySelector(`input[name="permissions"][value="${permission}"]`);
        if (checkbox) checkbox.checked = true;
    });
    
    updatePermissionsCounts();
    updatePermissionsPreview();
}

function updatePermissionsCounts() {
    const categories = ['content', 'communication', 'admin', 'analytics'];
    
    categories.forEach(category => {
        const categoryDiv = document.getElementById(category + 'Permissions');
        const countSpan = document.getElementById(category + 'Count');
        
        if (categoryDiv && countSpan) {
            const total = categoryDiv.querySelectorAll('input[type="checkbox"]').length;
            const checked = categoryDiv.querySelectorAll('input[type="checkbox"]:checked').length;
            countSpan.textContent = `${checked}/${total}`;
        }
    });
    
    updatePermissionsPreview();
}

function updatePermissionsPreview() {
    const checkedPermissions = document.querySelectorAll('input[name="permissions"]:checked');
    const activeCount = checkedPermissions.length;
    const totalCount = document.querySelectorAll('input[name="permissions"]').length;
    const inactiveCount = totalCount - activeCount;
    
    document.getElementById('activePermissionsCount').textContent = activeCount;
    document.getElementById('inactivePermissionsCount').textContent = inactiveCount;
    
    // تحديث قائمة الصلاحيات
    const permissionsList = document.getElementById('permissionsSummary');
    permissionsList.innerHTML = '';
    
    const permissionsText = {
        view_courses: 'عرض الدورات المسجل بها',
        download_materials: 'تحميل المواد التعليمية',
        submit_assignments: 'تسليم الواجبات والمشاريع',
        take_quizzes: 'أداء الاختبارات والتقييمات',
        view_certificates: 'عرض وتحميل الشهادات',
        post_discussions: 'كتابة مواضيع جديدة في المنتدى',
        comment_discussions: 'التعليق على المناقشات',
        send_messages: 'إرسال رسائل خاصة',
        rate_courses: 'تقييم الدورات',
        manage_users: 'إدارة المستخدمين',
        manage_groups: 'إدارة المجموعات التعليمية',
        view_reports: 'عرض التقارير',
        export_data: 'تصدير البيانات',
        send_notifications: 'إرسال الإشعارات',
        manage_content: 'إدارة المحتوى',
        view_analytics: 'عرض لوحة التحليلات',
        view_progress_reports: 'عرض تقارير التقدم',
        view_financial_reports: 'عرض التقارير المالية',
        create_custom_reports: 'إنشاء تقارير مخصصة'
    };
    
    checkedPermissions.forEach(checkbox => {
        const li = document.createElement('li');
        li.textContent = permissionsText[checkbox.value] || checkbox.value;
        permissionsList.appendChild(li);
    });
    
    if (activeCount === 0) {
        const li = document.createElement('li');
        li.textContent = 'لا توجد صلاحيات محددة';
        permissionsList.appendChild(li);
    }
}

function toggleCategory(category) {
    const header = event.currentTarget;
    const permissions = document.getElementById(category + 'Permissions');
    
    header.classList.toggle('collapsed');
    permissions.style.display = header.classList.contains('collapsed') ? 'none' : 'grid';
}

function selectAllPermissions() {
    document.querySelectorAll('input[name="permissions"]').forEach(cb => {
        cb.checked = true;
    });
    updatePermissionsCounts();
}

function deselectAllPermissions() {
    document.querySelectorAll('input[name="permissions"]').forEach(cb => {
        cb.checked = false;
    });
    updatePermissionsCounts();
}
        // ==================== Courses Assignment Functions ====================
let draggedItem = null;

function filterCourses(searchTerm = '') {
    const items = document.querySelectorAll('.course-item');
    const clearBtn = document.getElementById('clearSearch');
    
    clearBtn.style.display = searchTerm ? 'block' : 'none';
    
    items.forEach(item => {
        const title = item.querySelector('.item-title').textContent.toLowerCase();
        const instructor = item.querySelector('.item-instructor span').textContent.toLowerCase();
        const match = title.includes(searchTerm.toLowerCase()) || 
                     instructor.includes(searchTerm.toLowerCase());
        
        item.style.display = match ? 'block' : 'none';
    });
    
    updateCounts();
}

function filterByType(type) {
    const items = document.querySelectorAll('.course-item');
    
    items.forEach(item => {
        const itemType = item.getAttribute('data-type');
        const isAssigned = formData.courses.some(c => c.id === item.getAttribute('data-id'));
        
        let show = false;
        if (type === 'all') {
            show = true;
        } else if (type === 'courses') {
            show = itemType === 'course';
        } else if (type === 'paths') {
            show = itemType === 'path';
        } else if (type === 'selected') {
            show = isAssigned;
        }
        
        item.style.display = show ? 'block' : 'none';
    });
}

function sortCourses(sortBy) {
    const container = document.getElementById('availableItems');
    const items = Array.from(container.querySelectorAll('.course-item'));
    
    items.sort((a, b) => {
        switch(sortBy) {
            case 'name':
                const titleA = a.querySelector('.item-title').textContent;
                const titleB = b.querySelector('.item-title').textContent;
                return titleA.localeCompare(titleB, 'ar');
            case 'date':
                // يمكن إضافة تاريخ الإنشاء لاحقاً
                return 0;
            case 'price':
                const priceA = parseFloat(a.querySelector('.price-value').textContent);
                const priceB = parseFloat(b.querySelector('.price-value').textContent);
                return priceB - priceA;
            case 'students':
                const studentsA = parseInt(a.querySelector('.students-count').textContent);
                const studentsB = parseInt(b.querySelector('.students-count').textContent);
                return studentsB - studentsA;
            default:
                return 0;
        }
    });
    
    container.innerHTML = '';
    items.forEach(item => container.appendChild(item));
}

function assignCourse(course, settings = {}) {
    // التحقق من عدم وجود الدورة مسبقاً
    if (formData.courses.some(c => c.id === course.id)) {
        showWarning('هذه الدورة/المسار مضاف بالفعل');
        return;
    }
    
    const courseData = {
        id: course.id,
        type: course.type,
        title: course.title,
        price: course.price || 0,
        startDate: settings.startDate || new Date().toISOString().split('T')[0],
        endDate: settings.endDate || null,
        accessType: settings.accessType || 'full',
        customPrice: settings.customPrice || course.price || 0,
        currency: settings.currency || 'EGP',
        isFree: settings.isFree || false,
        notes: settings.notes || ''
    };
    
    formData.courses.push(courseData);
    renderAssignedCourses();
    updateCounts();
    
    // **الجزء المهم: إذا كانت دورة مدفوعة، اعرض خيارات الدفع**
    if (courseData.price > 0 && !courseData.isFree) {
        // تأخير بسيط عشان الـ UI يتحدث الأول
        setTimeout(() => {
            showPaymentOptionsDialog(course);
        }, 300);
    }
}

async function assignCourseFromButton(courseId) {
    const course = [...availableCourses, ...availablePaths].find(c => c.id === courseId);
    if (course) {
        await assignCourse(course); // 🔥 إضافة await
    }
}

function removeAssignedCourse(courseId) {
    formData.courses = formData.courses.filter(c => c.id !== courseId);
    
    // حذف المعاملات المرتبطة
    userTransactions = userTransactions.filter(t => 
        !t.relatedTo || t.relatedTo.id !== courseId
    );
    
    renderAssignedCourses();
    updateCounts();
    updateFinancialSummary();
}

function renderAssignedCourses() {
    const container = document.getElementById('assignedItems');
    if (!container) return;
    
    if (formData.courses.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>لم يتم تخصيص أي دورات بعد</p>
                <span>اختر من القائمة المجاورة</span>
            </div>
        `;
        return;
    }
    
    container.innerHTML = formData.courses.map(course => `
        <div class="assigned-item" data-id="${course.id}">
            <div class="assigned-item-header">
                <div class="assigned-item-info">
                    <div class="item-type-icon">
                        <i class="fas fa-${course.type === 'course' ? 'graduation-cap' : 'route'}"></i>
                    </div>
                    <div>
                        <h4 class="assigned-item-title">${course.title}</h4>
                        <p class="assigned-item-type">${course.type === 'course' ? 'دورة تدريبية' : 'مسار تدريبي'}</p>
                    </div>
                </div>
                <button class="remove-btn" onclick="removeAssignedCourse('${course.id}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="assigned-item-settings">
                <!-- تواريخ الوصول -->
                <div class="setting-group">
                    <label class="setting-label">
                        <i class="fas fa-calendar-alt"></i>
                        فترة الوصول
                    </label>
                    <div class="date-inputs">
                        <input type="date" class="date-input start-date" 
                               value="${course.startDate}"
                               onchange="updateCourseSettings('${course.id}', 'startDate', this.value)">
                        <span class="date-separator">إلى</span>
                        <input type="date" class="date-input end-date" 
                               value="${course.endDate || ''}"
                               onchange="updateCourseSettings('${course.id}', 'endDate', this.value)">
                    </div>
                </div>
                
                <!-- نوع الوصول -->
                <div class="setting-group">
                    <label class="setting-label">
                        <i class="fas fa-key"></i>
                        نوع الوصول
                    </label>
                    <select class="setting-select access-type" 
                            onchange="updateCourseSettings('${course.id}', 'accessType', this.value)">
                        <option value="full" ${course.accessType === 'full' ? 'selected' : ''}>وصول كامل</option>
                        <option value="limited" ${course.accessType === 'limited' ? 'selected' : ''}>وصول محدود</option>
                        <option value="preview" ${course.accessType === 'preview' ? 'selected' : ''}>معاينة فقط</option>
                    </select>
                </div>
                
                <!-- السعر المخصص -->
                <div class="setting-group">
                    <label class="setting-label">
                        <i class="fas fa-tag"></i>
                        السعر المخصص
                    </label>
                    <div class="price-input-group">
                        <input type="number" class="price-input" 
                               value="${course.customPrice}"
                               placeholder="0" min="0"
                               onchange="updateCourseSettings('${course.id}', 'customPrice', this.value)"
                               ${course.isFree ? 'disabled' : ''}>
                        <select class="currency-select"
                                onchange="updateCourseSettings('${course.id}', 'currency', this.value)"
                                ${course.isFree ? 'disabled' : ''}>
                            <option value="EGP" ${course.currency === 'EGP' ? 'selected' : ''}>جنيه مصري</option>
                            <option value="SAR" ${course.currency === 'SAR' ? 'selected' : ''}>ريال سعودي</option>
                            <option value="USD" ${course.currency === 'USD' ? 'selected' : ''}>دولار أمريكي</option>
                        </select>
                        <label class="checkbox-label">
                            <input type="checkbox" class="free-checkbox" 
                                   ${course.isFree ? 'checked' : ''}
                                   onchange="toggleCourseFree('${course.id}', this.checked)">
                            <span>مجاني</span>
                        </label>
                    </div>
                </div>
                
                <!-- ملاحظات -->
                <div class="setting-group">
                    <label class="setting-label">
                        <i class="fas fa-sticky-note"></i>
                        ملاحظات
                    </label>
                    <textarea class="setting-textarea" rows="2" 
                              placeholder="ملاحظات خاصة بهذا التخصيص..."
                              onchange="updateCourseSettings('${course.id}', 'notes', this.value)">${course.notes}</textarea>
                </div>
            </div>
        </div>
    `).join('');
}

function updateCourseSettings(courseId, field, value) {
    const course = formData.courses.find(c => c.id === courseId);
    if (course) {
        course[field] = value;
        // إذا تغير السعر، قد نحتاج لتحديث المعاملات
        if (field === 'customPrice' || field === 'isFree') {
            updateCourseTransactions(courseId);
        }
    }
}

function toggleCourseFree(courseId, isFree) {
    const course = formData.courses.find(c => c.id === courseId);
    if (course) {
        course.isFree = isFree;
        // تعطيل/تفعيل حقول السعر
        const container = document.querySelector(`[data-id="${courseId}"]`);
        if (container) {
            const priceInput = container.querySelector('.price-input');
            const currencySelect = container.querySelector('.currency-select');
            priceInput.disabled = isFree;
            currencySelect.disabled = isFree;
            if (isFree) {
                priceInput.value = 0;
            }
        }
        updateCourseTransactions(courseId);
    }
}

function updateCourseTransactions(courseId) {
    // تحديث المعاملات المرتبطة بالدورة
    const course = formData.courses.find(c => c.id === courseId);
    if (!course) return;
    
    // يمكن إضافة منطق لتحديث المعاملات هنا
    console.log('تحديث معاملات الدورة:', courseId);
}

function assignAllVisible() {
    const visibleItems = document.querySelectorAll('.course-item[style="display: block;"]');
    visibleItems.forEach(item => {
        const courseId = item.getAttribute('data-id');
        const course = [...availableCourses, ...availablePaths].find(c => c.id === courseId);
        if (course && !formData.courses.some(c => c.id === courseId)) {
            assignCourse(course);
        }
    });
}

function removeAllAssigned() {
    if (formData.courses.length === 0) return;
    
    Swal.fire({
        title: 'هل أنت متأكد؟',
        text: 'سيتم إزالة جميع الدورات والمسارات المخصصة',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'نعم، إزالة الكل',
        cancelButtonText: 'إلغاء',
        confirmButtonColor: '#dc3545'
    }).then((result) => {
        if (result.isConfirmed) {
            formData.courses = [];
            renderAssignedCourses();
            updateCounts();
            showSuccess('تم إزالة جميع الدورات والمسارات');
        }
    });
}

function applyBulkSettings() {
    document.getElementById('bulkSettingsModal').style.display = 'block';
}

function applyBulkSettingsConfirm() {
    const duration = document.getElementById('bulkDuration').value;
    const durationUnit = document.getElementById('bulkDurationUnit').value;
    const accessType = document.getElementById('bulkAccessType').value;
    const discount = parseFloat(document.getElementById('bulkDiscount').value) || 0;
    
    formData.courses.forEach(course => {
        course.accessType = accessType;
        if (discount > 0) {
            course.customPrice = course.price * (1 - discount / 100);
        }
        // يمكن إضافة منطق لحساب تاريخ الانتهاء بناءً على المدة
    });
    
    renderAssignedCourses();
    closeBulkSettings();
    showSuccess('تم تطبيق الإعدادات على جميع الدورات');
}
        // ==================== Custom Fields Functions ====================
function addCustomField() {
    document.getElementById('customFieldModal').style.display = 'block';
}

function saveCustomField() {
    const label = document.getElementById('fieldLabel').value.trim();
    const type = document.getElementById('fieldType').value;
    const required = document.getElementById('fieldRequired').checked;
    
    if (!label) {
        showError('يجب إدخال اسم الحقل');
        return;
    }
    
    const field = {
        id: 'custom_' + Date.now(),
        label: label,
        type: type,
        required: required,
        value: null
    };
    
    if (type === 'select') {
        const options = document.getElementById('fieldOptions').value
            .split('\n')
            .filter(opt => opt.trim())
            .map(opt => opt.trim());
        
        if (options.length === 0) {
            showError('يجب إدخال خيار واحد على الأقل');
            return;
        }
        
        field.options = options;
    }
    
    customFields.push(field);
    addCustomFieldToForm(field);
    closeCustomFieldModal();
    showSuccess('تم إضافة الحقل بنجاح');
}

function addCustomFieldToForm(field) {
    const container = document.getElementById('customFieldsContainer');
    const emptyState = document.getElementById('emptyCustomFields');
    
    if (emptyState) {
        emptyState.style.display = 'none';
    }
    
    const fieldElement = document.createElement('div');
    fieldElement.className = 'custom-field-item';
    fieldElement.setAttribute('data-field-id', field.id);
    
    let inputHtml = '';
    switch (field.type) {
        case 'text':
            inputHtml = `<input type="text" class="form-control" id="${field.id}" ${field.required ? 'required' : ''}>`;
            break;
        case 'number':
            inputHtml = `<input type="number" class="form-control" id="${field.id}" ${field.required ? 'required' : ''}>`;
            break;
        case 'email':
            inputHtml = `<input type="email" class="form-control" id="${field.id}" ${field.required ? 'required' : ''}>`;
            break;
        case 'date':
            inputHtml = `<input type="date" class="form-control" id="${field.id}" ${field.required ? 'required' : ''}>`;
            break;
        case 'select':
            inputHtml = `
                <select class="form-control" id="${field.id}" ${field.required ? 'required' : ''}>
                    <option value="">-- اختر --</option>
                    ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                </select>
            `;
            break;
        case 'textarea':
            inputHtml = `<textarea class="form-control" id="${field.id}" rows="3" ${field.required ? 'required' : ''}></textarea>`;
            break;
        case 'checkbox':
            inputHtml = `
                <label class="checkbox-label">
                    <input type="checkbox" id="${field.id}">
                    <span>${field.label}</span>
                </label>
            `;
            break;
    }
    
    fieldElement.innerHTML = `
        <div class="form-group">
            ${field.type !== 'checkbox' ? `
                <label class="form-label${field.required ? ' required' : ''}" for="${field.id}">
                    <i class="fas fa-edit"></i>
                    ${field.label}
                </label>
            ` : ''}
            ${inputHtml}
        </div>
        <button class="custom-field-remove" onclick="removeCustomField('${field.id}')">
            <i class="fas fa-trash"></i>
        </button>
    `;
    
    container.appendChild(fieldElement);
}

function removeCustomField(fieldId) {
    customFields = customFields.filter(f => f.id !== fieldId);
    const element = document.querySelector(`[data-field-id="${fieldId}"]`);
    if (element) {
        element.remove();
    }
    
    if (customFields.length === 0) {
        document.getElementById('emptyCustomFields').style.display = 'block';
    }
}
        // ==================== Interests Functions ====================
function addInterestTag(interest) {
    if (!formData.advanced.interests) {
        formData.advanced.interests = [];
    }
    
    if (formData.advanced.interests.includes(interest)) {
        return;
    }
    
    formData.advanced.interests.push(interest);
    
    const tagElement = document.createElement('div');
    tagElement.className = 'tag-item';
    tagElement.innerHTML = `
        <button onclick="removeInterestTag('${interest}')">
            <i class="fas fa-times"></i>
        </button>
        ${interest}
    `;
    
    document.getElementById('interestsTags').appendChild(tagElement);
}

function removeInterestTag(interest) {
    formData.advanced.interests = formData.advanced.interests.filter(i => i !== interest);
    
    // إزالة العنصر من العرض
    const tags = document.querySelectorAll('.tag-item');
    tags.forEach(tag => {
        if (tag.textContent.includes(interest)) {
            tag.remove();
        }
    });
}
        // ==================== Text Editor Functions ====================
function formatText(command) {
    document.execCommand(command, false, null);
}

function insertLink() {
    const url = prompt('أدخل رابط URL:');
    if (url) {
        document.execCommand('createLink', false, url);
    }
}

function insertHighlight() {
    const selection = window.getSelection();
    if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const span = document.createElement('span');
        span.style.backgroundColor = '#ffeb3b';
        span.style.color = '#000';
        range.surroundContents(span);
    }
}

// ==================== Activity Timeline ====================
function loadMoreActivity() {
    showWarning('خاصية تحميل المزيد من النشاطات قيد التطوير');
}
        

        // ==================== Page Initialization ====================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // التحقق من المصادقة
                await checkAuth();
                
                // التحقق من وضع التحرير
                checkEditMode();
                
                // تهيئة الصفحة
                await initializePage();
                
                // إعداد المستمعين
                setupEventListeners();
                
                // تحميل البيانات
                await loadInitialData();
                
                // إخفاء شاشة التحميل
                hideLoading();
                
            } catch (error) {
                console.error('خطأ في تهيئة الصفحة:', error);
                showError('حدث خطأ في تحميل الصفحة');
            }
        });
// ==================== Authentication Functions ====================
        async function checkAuth() {
            return new Promise((resolve, reject) => {
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        currentUser = user;
                        // التحقق من صلاحيات الأدمن
                        if (user.email === 'admin@fouad-academy.com') {
                            resolve();
                        } else {
                            window.location.href = '/fouad-perspective/admin/login.html';
                            reject('ليس لديك صلاحيات الوصول');
                        }
                    } else {
                        window.location.href = '/fouad-perspective/admin/login.html';
                        reject('يجب تسجيل الدخول');
                    }
                });
            });
        }

        // ==================== Edit Mode Functions ====================
        function checkEditMode() {
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('id');
    
    if (userId) {
        editMode = true;
        currentUserId = userId;
        updatePageForEditMode();
    } else {
        // في وضع الإنشاء، إظهار قسم توليد المعرف
        setupNameListeners();
    }
}

// إضافة دالة جديدة
function setupNameListeners() {
    const firstNameInput = document.getElementById('firstName');
    const lastNameInput = document.getElementById('lastName');
    const generateSection = document.getElementById('generateSlugSection');
    
    function checkNames() {
        const firstName = firstNameInput.value.trim();
        const lastName = lastNameInput.value.trim();
        
        if (firstName && lastName) {
            generateSection.style.display = 'block';
            const suggestedSlug = generateSlugFromName(firstName, lastName);
            document.getElementById('slugPreview').value = suggestedSlug;
        } else {
            generateSection.style.display = 'none';
        }
    }
    
    firstNameInput.addEventListener('input', checkNames);
    lastNameInput.addEventListener('input', checkNames);
}

function generateSlugFromName(firstName, lastName) {
    const timestamp = Date.now().toString().slice(-4);
    const cleanFirst = firstName.toLowerCase().replace(/[^a-z0-9]/g, '');
    const cleanLast = lastName.toLowerCase().replace(/[^a-z0-9]/g, '');
    return `${cleanFirst}-${cleanLast}-${timestamp}`;
}

function generateUserSlug() {
    const slug = document.getElementById('slugPreview').value;
    
    if (!slug) {
        showError('يجب إدخال معرف صحيح');
        return;
    }
    
    // تعيين المعرف
    currentUserId = slug;
    
    // تغيير الصفحة لوضع الإنشاء الفعلي
    editMode = false; // مهم!
    
    // إخفاء قسم التوليد
    document.getElementById('generateSlugSection').style.display = 'none';
    
    // الاحتفاظ بنص الزر كما هو
    document.getElementById('saveBtnText').textContent = 'إنشاء المستخدم';
    document.getElementById('saveBtn').innerHTML = '<i class="fas fa-check"></i> إنشاء المستخدم';
    
    // تفعيل الحقول
    document.getElementById('email').removeAttribute('disabled');
    document.getElementById('password').removeAttribute('disabled');
    document.getElementById('confirmPassword').removeAttribute('disabled');
    document.getElementById('phoneNumber').removeAttribute('disabled');
    
    showSuccess('تم تعيين معرف المستخدم - يمكنك الآن إكمال البيانات');
}
        // ==================== Page Initialization ====================
async function initializePage() {
    // تهيئة المحرر النصي للملاحظات
    initializeNotesEditor();
    
    // تهيئة اختيار الدول
    await loadCountries();
    
    // تهيئة التبويبات
    initializeTabs();
    
    // تهيئة السحب والإفلات
    initializeDragAndDrop();
}

// ==================== Initialize Notes Editor ====================
function initializeNotesEditor() {
    // يمكن استخدام Quill أو أي محرر آخر
    console.log('تهيئة محرر الملاحظات');
}

// ==================== Load Countries ====================
async function loadCountries() {
    const countrySelect = document.getElementById('country');
    if (!countrySelect) return;
    
    // قائمة الدول العربية
    const countries = [
        { code: 'EG', name: 'مصر' },
        { code: 'SA', name: 'السعودية' },
        { code: 'AE', name: 'الإمارات' },
        { code: 'KW', name: 'الكويت' },
        { code: 'QA', name: 'قطر' },
        { code: 'OM', name: 'عمان' },
        { code: 'BH', name: 'البحرين' },
        { code: 'JO', name: 'الأردن' },
        { code: 'LB', name: 'لبنان' },
        { code: 'PS', name: 'فلسطين' },
        { code: 'SY', name: 'سوريا' },
        { code: 'IQ', name: 'العراق' },
        { code: 'MA', name: 'المغرب' },
        { code: 'DZ', name: 'الجزائر' },
        { code: 'TN', name: 'تونس' },
        { code: 'LY', name: 'ليبيا' },
        { code: 'SD', name: 'السودان' },
        { code: 'YE', name: 'اليمن' }
    ];
    
    countries.forEach(country => {
        const option = document.createElement('option');
        option.value = country.code;
        option.textContent = country.name;
        countrySelect.appendChild(option);
    });
}


// ==================== Initialize Drag and Drop ====================
function initializeDragAndDrop() {
    console.log('تهيئة السحب والإفلات');
    // سيتم إضافة الكود لاحقاً عند الحاجة
}

        function updatePageForEditMode() {
            // تحديث العنوان
            document.getElementById('pageMode').textContent = 'تعديل بيانات المستخدم';
            document.getElementById('pageTitleText').textContent = 'تعديل بيانات المستخدم';
            document.getElementById('saveBtnText').textContent = 'حفظ التعديلات';
            
            // تحديث الأزرار
            document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save"></i> حفظ التعديلات';
            document.getElementById('saveDraftBtn').style.display = 'none';
            
            // إخفاء حقول كلمة المرور
            document.getElementById('passwordGroup').style.display = 'none';
            document.getElementById('confirmPasswordGroup').style.display = 'none';
        }

    

        // ==================== Load Initial Data ====================
        async function loadInitialData() {
            try {
                showLoading('جاري تحميل البيانات...');
                
                // تحميل الدورات والمسارات المتاحة
                await loadAvailableContent();
                
                // إذا كان في وضع التعديل، تحميل بيانات المستخدم
                if (editMode && currentUserId) {
                    await loadUserData(currentUserId);
                }

            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                showError('حدث خطأ في تحميل البيانات');
            }
        }

        // ==================== Load User Data for Edit ====================
        async function loadUserData(userId) {
            try {
                // محاولة جلب البيانات من مجموعة users
                let userData = null;
                const userDoc = await db.collection('users').doc(userId).get();
                
                if (userDoc.exists) {
                    userData = { id: userDoc.id, ...userDoc.data() };
                } else {
                    // البحث بالبريد الإلكتروني
                    const usersQuery = await db.collection('users').where('email', '==', userId).limit(1).get();
                    if (!usersQuery.empty) {
                        userData = { id: usersQuery.docs[0].id, ...usersQuery.docs[0].data() };
                        currentUserId = usersQuery.docs[0].id;
                    }
                }
                
                if (!userData) {
                    throw new Error('المستخدم غير موجود');
                }
                
                // ملء البيانات في النموذج
                fillFormWithUserData(userData);
                
                // تحميل المعاملات المالية من الهيكل الجديد
                await loadUserFinancialData();
                
            } catch (error) {
                console.error('خطأ في تحميل بيانات المستخدم:', error);
                showError('حدث خطأ في تحميل بيانات المستخدم');
                setTimeout(() => {
                    window.location.href = '/admin/users.html';
                }, 2000);
            }
        }

        // ==================== Fill Form with User Data ====================
        function fillFormWithUserData(userData) {
            // البيانات الأساسية
            if (userData.name) {
                const nameParts = userData.name.split(' ');
                document.getElementById('firstName').value = nameParts[0] || '';
                document.getElementById('lastName').value = nameParts.slice(1).join(' ') || '';
            }
            document.getElementById('email').value = userData.email || '';
            
            // رقم WhatsApp
            if (userData.whatsapp || userData.phone) {
                const phoneNumber = userData.whatsapp || userData.phone;
                const phoneMatch = phoneNumber.match(/^(\+\d{1,4})?(\d+)$/);
                if (phoneMatch) {
                    if (phoneMatch[1]) {
                        document.getElementById('countryCode').value = phoneMatch[1];
                    }
                    document.getElementById('phoneNumber').value = phoneMatch[2] || '';
                }
            }
            
            // حالة الحساب
            const accountStatus = userData.isActive === false ? 'inactive' : 
                                 userData.status === 'pending' ? 'pending' : 'active';
            document.querySelector(`input[name="accountStatus"][value="${accountStatus}"]`).checked = true;
            
            // الصورة الشخصية
            if (userData.avatar) {
                displayAvatar(userData.avatar);
            }
            
            // الدور الأساسي والصلاحيات
            if (userData.role) {
                document.querySelector(`input[name="primaryRole"][value="${userData.role}"]`).checked = true;
                updatePermissionsForRole(userData.role);
            }
            
            if (userData.permissions) {
                userData.permissions.forEach(permission => {
                    const checkbox = document.querySelector(`input[name="permissions"][value="${permission}"]`);
                    if (checkbox) checkbox.checked = true;
                });
                updatePermissionsCounts();
            }
            
            // الدورات المخصصة
            if (userData.enrollments) {
                userData.enrollments.forEach(enrollment => {
                    const course = availableCourses.find(c => c.id === enrollment.id) || 
                                  availablePaths.find(p => p.id === enrollment.id);
                    if (course) {
                        assignCourse(course, enrollment);
                    }
                });
            }
            
            // المعلومات المتقدمة
            fillAdvancedInfo(userData);
            
            // تحديث العرض
            renderAssignedCourses();
            updateCounts();
            
            // إخفاء زر إنشاء المعرف في وضع التعديل
            document.getElementById('generateSlugSection').style.display = 'none';
        }

        // ==================== Fill Advanced Information ====================
        function fillAdvancedInfo(userData) {
            // المعلومات الشخصية
            if (userData.birthDate) document.getElementById('birthDate').value = userData.birthDate;
            if (userData.gender) document.getElementById('gender').value = userData.gender;
            if (userData.nationality) document.getElementById('nationality').value = userData.nationality;
            
            // معلومات التواصل
            if (userData.country) document.getElementById('country').value = userData.country;
            if (userData.city) document.getElementById('city').value = userData.city;
            if (userData.timezone) document.getElementById('timezone').value = userData.timezone;
            if (userData.language) document.getElementById('language').value = userData.language;
            if (userData.address) document.getElementById('address').value = userData.address;
            
            // المعلومات المهنية
            if (userData.occupation) document.getElementById('occupation').value = userData.occupation;
            if (userData.company) document.getElementById('company').value = userData.company;
            if (userData.education) document.getElementById('education').value = userData.education;
            if (userData.experience) document.getElementById('experience').value = userData.experience;
            
            // الاهتمامات
            if (userData.interests && Array.isArray(userData.interests)) {
                userData.interests.forEach(interest => addInterestTag(interest));
            }
            
            // تفضيلات الإشعارات
            if (userData.notifications) {
                Object.keys(userData.notifications).forEach(key => {
                    const checkbox = document.getElementById(key);
                    if (checkbox) checkbox.checked = userData.notifications[key];
                });
            }
            
            // الحقول المخصصة
            if (userData.customFields && Array.isArray(userData.customFields)) {
                userData.customFields.forEach(field => addCustomFieldToForm(field));
            }
            
            // ملاحظات الإدارة
            if (userData.adminNotes) {
                document.getElementById('adminNotesEditor').innerHTML = userData.adminNotes;
            }
            
            // معلومات آخر تعديل
            if (userData.lastUpdated) {
                document.getElementById('lastEditedBy').textContent = userData.lastUpdatedBy || 'النظام';
                document.getElementById('lastEditedDate').textContent = formatDate(userData.lastUpdated.toDate());
            }
        }

        // ==================== Tab Navigation ====================
        function initializeTabs() {
            const tabLinks = document.querySelectorAll('.tab-link');
            const tabPanels = document.querySelectorAll('.tab-panel');
            
            tabLinks.forEach(link => {
                link.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // تحديث التبويبات النشطة
                    tabLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    // تحديث المحتوى
                    tabPanels.forEach(panel => panel.classList.remove('active'));
                    document.getElementById(targetTab + 'Panel').classList.add('active');
                    
                    // تحديث شريط التقدم
                    updateProgressBar(targetTab);
                    
                    // حفظ تلقائي عند تغيير التبويب
                    autoSave();
                });
            });
        }

        // ==================== Progress Bar ====================
        function updateProgressBar(currentTab) {
            const tabs = ['basic', 'roles', 'courses', 'advanced', 'financial'];
            const currentIndex = tabs.indexOf(currentTab);
            const progress = ((currentIndex + 1) / tabs.length) * 100;
            
            document.getElementById('progressFill').style.width = progress + '%';
            
            // تحديث حالة الخطوات
            const steps = document.querySelectorAll('.progress-step');
            steps.forEach((step, index) => {
                if (index <= currentIndex) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
                
                if (index < currentIndex) {
                    step.classList.add('completed');
                } else {
                    step.classList.remove('completed');
                }
            });
        }

        // ==================== Form Validation ====================
        function validateBasicInfo() {
            let isValid = true;
            
            // التحقق من الاسم الأول
            const firstName = document.getElementById('firstName').value.trim();
            if (!firstName) {
                showFieldError('firstName', 'الاسم الأول مطلوب');
                isValid = false;
            } else {
                clearFieldError('firstName');
            }
            
            // التحقق من اسم العائلة
            const lastName = document.getElementById('lastName').value.trim();
            if (!lastName) {
                showFieldError('lastName', 'اسم العائلة مطلوب');
                isValid = false;
            } else {
                clearFieldError('lastName');
            }
            
            // التحقق من البريد الإلكتروني
            const email = document.getElementById('email').value.trim();
            if (!email || !isValidEmail(email)) {
                showFieldError('email', 'البريد الإلكتروني غير صحيح');
                isValid = false;
            } else {
                clearFieldError('email');
            }
            
            // التحقق من كلمة المرور (في وضع الإنشاء فقط)
            if (!editMode) {
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (!password || password.length < 8) {
                    showFieldError('password', 'كلمة المرور يجب أن تكون 8 أحرف على الأقل');
                    isValid = false;
                } else {
                    clearFieldError('password');
                }
                
                if (password !== confirmPassword) {
                    showFieldError('confirmPassword', 'كلمات المرور غير متطابقة');
                    isValid = false;
                } else {
                    clearFieldError('confirmPassword');
                }
            }
            
            // التحقق من رقم WhatsApp
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            if (!phoneNumber || !isValidPhone(phoneNumber)) {
                showFieldError('phoneNumber', 'رقم الهاتف غير صحيح');
                isValid = false;
            } else {
                clearFieldError('phoneNumber');
            }
            
            return isValid;
        }

        // ==================== Helper Functions ====================
        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function isValidPhone(phone) {
            return /^\d{6,15}$/.test(phone);
        }

        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const feedback = document.getElementById(fieldId + 'Feedback');
            
            field.classList.add('error');
            if (feedback) {
                feedback.textContent = message;
                feedback.classList.add('show', 'error');
            }
        }

        function clearFieldError(fieldId) {
            const field = document.getElementById(fieldId);
            const feedback = document.getElementById(fieldId + 'Feedback');
            
            field.classList.remove('error');
            if (feedback) {
                feedback.classList.remove('show', 'error');
            }
        }

        // ==================== Password Functions ====================
        function generatePassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let password = '';
            
            // ضمان تضمين حرف كبير وصغير ورقم ورمز خاص
            password += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'[Math.floor(Math.random() * 26)];
            password += 'abcdefghijklmnopqrstuvwxyz'[Math.floor(Math.random() * 26)];
            password += '0123456789'[Math.floor(Math.random() * 10)];
            password += '!@#$%^&*'[Math.floor(Math.random() * 8)];
            
            // ملء باقي الأحرف
            for (let i = 4; i < 12; i++) {
                password += chars[Math.floor(Math.random() * chars.length)];
            }
            
            // خلط الأحرف
            password = password.split('').sort(() => Math.random() - 0.5).join('');
            
            // وضع كلمة المرور في الحقل
            document.getElementById('password').value = password;
            document.getElementById('password').type = 'text';
            
            // تحديث مؤشر القوة
            checkPasswordStrength(password);
            
            // نسخ كلمة المرور
            navigator.clipboard.writeText(password).then(() => {
                showSuccess('تم توليد ونسخ كلمة المرور');
            });
        }

        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('passwordToggleIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        // ==================== Password Strength Checker ====================
        document.getElementById('password')?.addEventListener('input', function() {
            checkPasswordStrength(this.value);
        });

        function checkPasswordStrength(password) {
            let strength = 0;
            const criteria = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /[0-9]/.test(password),
                special: /[!@#$%^&*]/.test(password)
            };
            
            // تحديث معايير كلمة المرور
            Object.keys(criteria).forEach(key => {
                const element = document.getElementById(key + 'Criteria');
                if (element) {
                    if (criteria[key]) {
                        element.classList.add('valid');
                        element.querySelector('i').classList.remove('fa-times-circle');
                        element.querySelector('i').classList.add('fa-check-circle');
                        strength++;
                    } else {
                        element.classList.remove('valid');
                        element.querySelector('i').classList.remove('fa-check-circle');
                        element.querySelector('i').classList.add('fa-times-circle');
                    }
                }
            });
            
            // تحديث مؤشر القوة
            const strengthFill = document.getElementById('strengthFill');
            const strengthText = document.getElementById('strengthText');
            
            strengthFill.className = 'strength-fill';
            
            if (strength === 0) {
                strengthText.textContent = 'أدخل كلمة المرور';
            } else if (strength <= 2) {
                strengthFill.classList.add('weak');
                strengthText.textContent = 'ضعيفة';
            } else if (strength === 3) {
                strengthFill.classList.add('fair');
                strengthText.textContent = 'متوسطة';
            } else if (strength === 4) {
                strengthFill.classList.add('good');
                strengthText.textContent = 'جيدة';
            } else {
                strengthFill.classList.add('strong');
                strengthText.textContent = 'قوية جداً';
            }
        }

        // ==================== Avatar Functions ====================
        function displayAvatar(src) {
            const avatarImg = document.getElementById('avatarImg');
            const avatarPlaceholder = document.getElementById('avatarPlaceholder');
            const removeBtn = document.getElementById('removeAvatarBtn');
            
            avatarImg.src = src;
            avatarImg.style.display = 'block';
            avatarPlaceholder.style.display = 'none';
            removeBtn.style.display = 'inline-flex';
        }

        function removeAvatar() {
            const avatarImg = document.getElementById('avatarImg');
            const avatarPlaceholder = document.getElementById('avatarPlaceholder');
            const removeBtn = document.getElementById('removeAvatarBtn');
            const avatarInput = document.getElementById('avatarInput');
            
            avatarImg.src = '';
            avatarImg.style.display = 'none';
            avatarPlaceholder.style.display = 'flex';
            removeBtn.style.display = 'none';
            avatarInput.value = '';
            
            // حذف من البيانات المحفوظة
            if (formData.basic) {
                delete formData.basic.avatar;
            }
        }

        // ==================== Loading Functions ====================
        function showLoading(message = 'جاري التحميل...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = overlay.querySelector('.loading-text');
            
            loadingText.textContent = message;
            overlay.classList.add('active');
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('active');
        }

        // ==================== Notification Functions ====================
        function showSuccess(message) {
            Swal.fire({
                icon: 'success',
                title: 'نجح',
                text: message,
                timer: 2000,
                showConfirmButton: false,
                toast: true,
                position: 'top-end'
            });
        }

        function showError(message) {
            Swal.fire({
                icon: 'error',
                title: 'خطأ',
                text: message,
                confirmButtonColor: 'var(--primary)',
                confirmButtonText: 'موافق'
            });
        }

        function showWarning(message) {
            Swal.fire({
                icon: 'warning',
                title: 'تنبيه',
                text: message,
                confirmButtonColor: 'var(--primary)',
                confirmButtonText: 'موافق'
            });
        }

        // ==================== Utility Functions ====================
        function formatDate(date) {
            if (!date) return '-';
            
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            
            return new Intl.DateTimeFormat('ar-SA', options).format(date);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
// ==================== Load User Financial Data (الهيكل الجديد) ====================
        async function loadUserFinancialData() {
            try {
                console.log('📊 جاري تحميل البيانات المالية من الهيكل الجديد...');
                
                if (!currentUserId) {
                    console.log('مستخدم جديد - لا توجد بيانات مالية سابقة');
                    updateFinancialSummary();
                    updateTransactionsDisplay();
                    updateUpcomingPaymentsDisplay();
                    return;
                }
                
                // جلب السجلات المالية للدورات
                const financialRecords = await db.collection('users').doc(currentUserId)
                    .collection('financialRecords')
                    .get();
                
                userTransactions = [];
                const courseFinancialData = new Map();
                
                // معالجة كل سجل مالي
                for (const doc of financialRecords.docs) {
                    const record = { id: doc.id, ...doc.data() };
                    courseFinancialData.set(record.courseId, record);
                    
                    // استخراج المعاملات من السجل
                    if (record.transactions && Array.isArray(record.transactions)) {
                        userTransactions.push(...record.transactions);
                    }
                }
                
                // ترتيب المعاملات حسب التاريخ
                userTransactions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                console.log(`✅ تم تحميل ${userTransactions.length} معاملة من ${courseFinancialData.size} دورة`);
                
                // حفظ في الكاش
                DataCache.set('transactions', currentUserId, userTransactions);
                
                // تحديث العرض
                updateFinancialSummary();
                updateTransactionsDisplay();
                updateUpcomingPaymentsDisplay();
                await loadCoursesForFilters();
                
            } catch (error) {
                console.error('خطأ في تحميل البيانات المالية:', error);
                showError('حدث خطأ في تحميل البيانات المالية');
            }
        }

      // ==================== دالة showPaymentOptionsDialog المطورة ====================
async function showPaymentOptionsDialog(course) {
    const { value: paymentOptions } = await Swal.fire({
        title: 'إعداد طريقة الدفع',
        html: `
            <div style="text-align: right; direction: rtl;">
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #333;">${course.title}</h4>
                    <p style="margin: 0; font-size: 20px; font-weight: bold;">
                        السعر الأصلي: <span style="color: #f4c430;">${course.price} جنيه</span>
                    </p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                        <i class="fas fa-credit-card"></i> نوع المعاملة:
                    </label>
                    <select id="swal-payment-type" class="swal2-input" style="width: 100%; padding: 10px;">
                        <option value="payment">💰 دفعة مالية</option>
                        <option value="grant">🎓 منحة دراسية</option>
                        <option value="gift">🎁 هدية/مكافأة</option>
                        <option value="group-offer">👥 عرض ضمن مجموعة</option>
                        <option value="recommendation">⭐ توصية خاصة</option>
                        <option value="none">🆓 مجاني بالكامل</option>
                    </select>
                </div>

                <div id="swal-payment-plan-section" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                        <i class="fas fa-calendar-alt"></i> خطة الدفع:
                    </label>
                    <select id="swal-payment-plan" class="swal2-input" style="width: 100%; padding: 10px;">
                        <option value="full">دفعة واحدة كاملة</option>
                        <option value="installments">تقسيط على دفعات</option>
                        <option value="partial">دفعة جزئية</option>
                    </select>
                </div>
                
                <!-- قسم الأقساط -->
                <div id="swal-installment-details" style="display:none; background: #e8f4f8; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h5 style="margin: 0 0 15px 0; color: #2196f3;">
                        <i class="fas fa-calendar-alt"></i> تفاصيل الأقساط
                    </h5>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">عدد الأقساط:</label>
                        <input type="number" id="swal-installment-count" class="swal2-input" 
                               value="3" min="2" max="12" style="width: 100%;"
                               onchange="updateInstallmentPreview()">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">
                            قيمة الدفعة الأولى (اختياري):
                        </label>
                        <input type="number" id="swal-first-payment" class="swal2-input" 
                               placeholder="اتركه فارغ للتقسيم المتساوي" style="width: 100%;"
                               onchange="updateInstallmentPreview()">
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">
                            حالة القسط الأول:
                        </label>
                        <select id="swal-first-status" class="swal2-input" style="width: 100%;">
                            <option value="pending">معلق (لم يدفع بعد)</option>
                            <option value="completed">مكتمل (تم الدفع)</option>
                        </select>
                    </div>
                    
                    <div id="installment-preview" style="background: white; padding: 15px; border-radius: 5px; margin-top: 15px;">
                        <!-- سيتم ملؤه بواسطة JavaScript -->
                    </div>
                </div>
                
                <!-- قسم الدفعة الجزئية -->
                <div id="swal-partial-details" style="display:none; background: #fff3cd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h5 style="margin: 0 0 15px 0; color: #856404;">
                        <i class="fas fa-hand-holding-usd"></i> الدفعة الجزئية
                    </h5>
                    <div>
                        <label style="display: block; margin-bottom: 5px;">المبلغ المدفوع:</label>
                        <input type="number" id="swal-partial-amount" class="swal2-input" 
                               placeholder="أدخل المبلغ" style="width: 100%;"
                               onchange="updatePartialPreview()">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px;">حالة الدفعة:</label>
                        <select id="swal-partial-status" class="swal2-input" style="width: 100%;">
                            <option value="pending">معلقة</option>
                            <option value="completed">مكتملة</option>
                        </select>
                    </div>
                    <div id="partial-preview" style="margin-top: 10px; color: #856404;">
                        <!-- سيتم ملؤه بواسطة JavaScript -->
                    </div>
                </div>

                <!-- قسم طريقة الدفع -->
                <div id="swal-payment-method-section" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                        <i class="fas fa-money-bill"></i> طريقة الدفع:
                    </label>
                    <select id="swal-payment-method" class="swal2-input" style="width: 100%; padding: 10px;">
                        <option value="">اختر طريقة الدفع</option>
                        <option value="vodafone">📱 فودافون كاش</option>
                        <option value="instapay">💳 InstaPay</option>
                        <option value="bank">🏦 تحويل بنكي</option>
                        <option value="western">💸 ويسترن يونيون</option>
                        <option value="cash">💵 نقدي</option>
                        <option value="other">📝 أخرى</option>
                    </select>
                </div>
                
                <!-- قسم الخصم -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                        <i class="fas fa-percentage"></i> نسبة الخصم:
                    </label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="range" id="swal-discount-range" min="0" max="100" value="0" 
                               style="flex: 1;" oninput="updateDiscountValue(this.value)">
                        <input type="number" id="swal-discount" class="swal2-input" 
                               placeholder="0" min="0" max="100" value="0" 
                               style="width: 80px;" oninput="updateDiscountRange(this.value)">
                        <span>%</span>
                    </div>
                </div>
                
                <!-- معاينة السعر النهائي -->
                <div style="background: #d4edda; padding: 20px; border-radius: 8px; text-align: center;">
                    <h4 style="margin: 0 0 10px 0; color: #155724;">السعر النهائي</h4>
                    <p style="margin: 0; font-size: 32px; font-weight: bold; color: #155724;">
                        <span id="swal-final-price">${course.price}</span> جنيه
                    </p>
                    <p id="swal-discount-amount" style="margin: 5px 0 0 0; color: #721c24; display: none;">
                        (خصم: <span></span> جنيه)
                    </p>
                </div>
            </div>
        `,
        confirmButtonText: '✅ تأكيد وإنشاء المعاملات',
        cancelButtonText: '❌ إلغاء',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        width: '700px',
        didOpen: () => {
            // جلب العناصر
            const paymentType = document.getElementById('swal-payment-type');
            const paymentPlan = document.getElementById('swal-payment-plan');
            const installmentDetails = document.getElementById('swal-installment-details');
            const partialDetails = document.getElementById('swal-partial-details');
            const paymentPlanSection = document.getElementById('swal-payment-plan-section');
            const paymentMethodSection = document.getElementById('swal-payment-method-section');
            
            // دالة محلية لتحديث السعر
            window.updatePricePreview = function() {
                const discount = parseFloat(document.getElementById('swal-discount').value) || 0;
                const originalPrice = course.price;
                const discountAmount = originalPrice * (discount / 100);
                const finalPrice = originalPrice - discountAmount;
                
                document.getElementById('swal-final-price').textContent = finalPrice.toFixed(2);
                
                const discountDisplay = document.getElementById('swal-discount-amount');
                if (discount > 0) {
                    discountDisplay.style.display = 'block';
                    discountDisplay.querySelector('span').textContent = discountAmount.toFixed(2);
                } else {
                    discountDisplay.style.display = 'none';
                }
                
                // تحديث معاينة الأقساط إذا كانت مفتوحة
                if (installmentDetails.style.display !== 'none') {
                    updateInstallmentPreview();
                }
            };
            
            // دالة تحديث معاينة الأقساط
            window.updateInstallmentPreview = function() {
                const count = parseInt(document.getElementById('swal-installment-count').value) || 3;
                const firstPayment = parseFloat(document.getElementById('swal-first-payment').value) || 0;
                const discount = parseFloat(document.getElementById('swal-discount').value) || 0;
                const finalPrice = course.price * (1 - discount / 100);
                
                let html = '<h6 style="margin: 0 0 10px 0;">توزيع الأقساط:</h6>';
                
                if (firstPayment > 0) {
                    const remaining = finalPrice - firstPayment;
                    const regularPayment = remaining / (count - 1);
                    
                    html += `
                        <div style="margin-bottom: 5px;">
                            <strong>القسط الأول:</strong> ${firstPayment.toFixed(2)} جنيه
                        </div>
                        <div>
                            <strong>باقي الأقساط (${count - 1}):</strong> ${regularPayment.toFixed(2)} جنيه لكل قسط
                        </div>
                    `;
                } else {
                    const payment = finalPrice / count;
                    html += `
                        <div>
                            <strong>كل قسط:</strong> ${payment.toFixed(2)} جنيه
                        </div>
                    `;
                }
                
                document.getElementById('installment-preview').innerHTML = html;
            };
            
            // دالة تحديث معاينة الدفعة الجزئية
            window.updatePartialPreview = function() {
                const partialAmount = parseFloat(document.getElementById('swal-partial-amount').value) || 0;
                const discount = parseFloat(document.getElementById('swal-discount').value) || 0;
                const finalPrice = course.price * (1 - discount / 100);
                const remaining = finalPrice - partialAmount;
                
                let html = '';
                if (partialAmount > 0) {
                    html = `
                        <strong>المبلغ المتبقي:</strong> ${remaining.toFixed(2)} جنيه
                        ${remaining < 0 ? '<br><span style="color: red;">⚠️ المبلغ المدفوع أكبر من السعر!</span>' : ''}
                    `;
                }
                
                document.getElementById('partial-preview').innerHTML = html;
            };
            
            // دالة تحديث قيمة الخصم
            window.updateDiscountValue = function(value) {
                document.getElementById('swal-discount').value = value;
                updatePricePreview();
            };
            
            window.updateDiscountRange = function(value) {
                document.getElementById('swal-discount-range').value = value;
                updatePricePreview();
            };
            
            // تحديث النموذج حسب نوع المعاملة
            paymentType.addEventListener('change', (e) => {
                const type = e.target.value;
                
                if (type === 'grant' || type === 'gift' || type === 'none') {
                    // إخفاء خطة الدفع وطريقة الدفع للمنح والهدايا
                    paymentPlanSection.style.display = 'none';
                    paymentMethodSection.style.display = 'none';
                    installmentDetails.style.display = 'none';
                    partialDetails.style.display = 'none';
                    
                    // تعيين خصم 100% للمنح
                    if (type === 'grant' || type === 'none') {
                        document.getElementById('swal-discount').value = 100;
                        document.getElementById('swal-discount-range').value = 100;
                        updatePricePreview();
                    }
                } else {
                    // إظهار خطة الدفع وطريقة الدفع للمعاملات المالية
                    paymentPlanSection.style.display = 'block';
                    paymentMethodSection.style.display = 'block';
                }
            });
            
            // عرض/إخفاء الأقسام حسب خطة الدفع
            paymentPlan.addEventListener('change', (e) => {
                installmentDetails.style.display = e.target.value === 'installments' ? 'block' : 'none';
                partialDetails.style.display = e.target.value === 'partial' ? 'block' : 'none';
                
                if (e.target.value === 'installments') {
                    updateInstallmentPreview();
                }
            });
            
            // تحديث أولي
            updatePricePreview();
        },
        preConfirm: () => {
            const paymentType = document.getElementById('swal-payment-type').value;
            const paymentPlan = document.getElementById('swal-payment-plan').value;
            const discount = parseFloat(document.getElementById('swal-discount').value) || 0;
            const paymentMethod = document.getElementById('swal-payment-method').value;
            
            const result = {
                transactionType: paymentType,
                paymentType: paymentPlan,
                discount: discount,
                finalPrice: course.price * (1 - discount / 100),
                paymentMethod: paymentMethod
            };
            
            // التحقق من طريقة الدفع للمعاملات المالية
            if (paymentType === 'payment' && !paymentMethod) {
                Swal.showValidationMessage('يجب اختيار طريقة الدفع');
                return false;
            }
            
            if (paymentPlan === 'installments') {
                result.installmentCount = parseInt(document.getElementById('swal-installment-count').value) || 3;
                result.firstPayment = parseFloat(document.getElementById('swal-first-payment').value) || 0;
                result.firstStatus = document.getElementById('swal-first-status').value;
            } else if (paymentPlan === 'partial') {
                result.partialAmount = parseFloat(document.getElementById('swal-partial-amount').value) || 0;
                result.partialStatus = document.getElementById('swal-partial-status').value;
                if (result.partialAmount <= 0) {
                    Swal.showValidationMessage('يجب إدخال مبلغ الدفعة الجزئية');
                    return false;
                }
            }
            
            return result;
        }
    });
    
    return paymentOptions;
}

// ==================== دالة createPaymentTransactions بالهيكل الجديد ====================
        async function createPaymentTransactions(course, paymentOptions) {
            if (!paymentOptions) return;
            
            try {
                showLoading('جاري إنشاء المعاملات المالية...');
                
                // إنشاء السجل المالي للدورة
                const financialRecord = CourseFinancialStructure.createCourseFinancialRecord(
                    course.id,
                    course,
                    paymentOptions
                );
                
                // إنشاء المعاملات حسب نوع الدفع
                const transactions = [];
                const baseAmount = paymentOptions.finalPrice;
                
                switch (paymentOptions.paymentType) {
                    case 'full':
                        // دفعة واحدة كاملة
                        const fullTransaction = TransactionStructure.createTransaction({
                            userId: currentUserId,
                            type: paymentOptions.transactionType || 'payment',
                            amount: baseAmount,
                            dueDate: new Date().toISOString(),
                            paymentMethod: paymentOptions.paymentMethod,
                            status: paymentOptions.transactionType === 'grant' ? 'completed' : 'pending',
                            relatedTo: {
                                type: course.type,
                                id: course.id,
                                title: course.title
                            },
                            notes: `دفعة كاملة للدورة: ${course.title}`,
                            discount: paymentOptions.discount,
                            originalAmount: course.price
                        });
                        transactions.push(fullTransaction);
                        break;
                        
                    case 'installments':
                        // أقساط متعددة
                        const installmentCount = paymentOptions.installmentCount;
                        const firstPayment = paymentOptions.firstPayment || (baseAmount / installmentCount);
                        const remainingAmount = baseAmount - firstPayment;
                        const regularInstallment = installmentCount > 1 ? remainingAmount / (installmentCount - 1) : 0;
                        
                        // القسط الأول
                        const firstInstallment = TransactionStructure.createTransaction({
                            userId: currentUserId,
                            type: 'payment',
                            amount: firstPayment,
                            dueDate: new Date().toISOString(),
                            paymentMethod: paymentOptions.paymentMethod,
                            status: paymentOptions.firstStatus || 'pending',
                            relatedTo: {
                                type: course.type,
                                id: course.id,
                                title: course.title
                            },
                            installmentInfo: {
                                number: 1,
                                total: installmentCount,
                                frequency: 'monthly'
                            },
                            notes: `القسط الأول (1/${installmentCount}) للدورة: ${course.title}`,
                            discount: paymentOptions.discount,
                            originalAmount: course.price
                        });
                        transactions.push(firstInstallment);
                        
                        // باقي الأقساط
                        for (let i = 2; i <= installmentCount; i++) {
                            const dueDate = new Date();
                            dueDate.setMonth(dueDate.getMonth() + (i - 1));
                            
                            const installment = TransactionStructure.createTransaction({
                                userId: currentUserId,
                                type: 'payment',
                                amount: regularInstallment,
                                dueDate: dueDate.toISOString(),
                                paymentMethod: paymentOptions.paymentMethod,
                                status: 'pending',
                                relatedTo: {
                                    type: course.type,
                                    id: course.id,
                                    title: course.title
                                },
                                installmentInfo: {
                                    number: i,
                                    total: installmentCount,
                                    frequency: 'monthly'
                                },
                                notes: `القسط ${i}/${installmentCount} للدورة: ${course.title}`,
                                discount: paymentOptions.discount,
                                originalAmount: course.price
                            });
                            transactions.push(installment);
                        }
                        break;
                        
                    case 'partial':
                        // دفعة جزئية
                        const partialAmount = paymentOptions.partialAmount;
                        const remaining = baseAmount - partialAmount;
                        
                        // الدفعة الأولى
                        const partialTransaction = TransactionStructure.createTransaction({
                            userId: currentUserId,
                            type: 'payment',
                            amount: partialAmount,
                            dueDate: new Date().toISOString(),
                            paymentMethod: paymentOptions.paymentMethod,
                            status: paymentOptions.partialStatus || 'pending',
                            relatedTo: {
                                type: course.type,
                                id: course.id,
                                title: course.title
                            },
                            notes: `دفعة جزئية للدورة: ${course.title}`,
                            partialPayment: {
                                paid: partialAmount,
                                remaining: remaining,
                                total: baseAmount
                            },
                            discount: paymentOptions.discount,
                            originalAmount: course.price
                        });
                        transactions.push(partialTransaction);
                        
                        // المبلغ المتبقي
                        if (remaining > 0) {
                            const remainingTransaction = TransactionStructure.createTransaction({
                                userId: currentUserId,
                                type: 'payment',
                                amount: remaining,
                                dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                                paymentMethod: 'pending',
                                status: 'pending',
                                relatedTo: {
                                    type: course.type,
                                    id: course.id,
                                    title: course.title
                                },
                                notes: `المبلغ المتبقي للدورة: ${course.title}`,
                                partialPayment: {
                                    paid: 0,
                                    remaining: remaining,
                                    total: baseAmount
                                },
                                discount: paymentOptions.discount,
                                originalAmount: course.price
                            });
                            transactions.push(remainingTransaction);
                        }
                        break;
                        
                    case 'grant':
                    case 'none':
                        // منحة دراسية أو مجاني
                        const grantTransaction = TransactionStructure.createTransaction({
                            userId: currentUserId,
                            type: paymentOptions.transactionType || 'grant',
                            amount: baseAmount,
                            dueDate: new Date().toISOString(),
                            paymentMethod: 'grant',
                            status: 'completed',
                            relatedTo: {
                                type: course.type,
                                id: course.id,
                                title: course.title
                            },
                            notes: `منحة دراسية كاملة للدورة: ${course.title}`,
                            discount: 100,
                            originalAmount: course.price,
                            grantDetails: {
                                reason: 'منحة دراسية',
                                approvedBy: currentUser?.email || 'system',
                                approvedAt: new Date().toISOString()
                            }
                        });
                        transactions.push(grantTransaction);
                        break;
                }
                
                // إضافة المعاملات للسجل المالي
                financialRecord.transactions = transactions;
                
                // تحديث ملخص السجل المالي
                updateFinancialRecordSummary(financialRecord);
                
                // حفظ في Firebase أو محلياً
                if (editMode && currentUserId) {
                    // حفظ في Firebase بالهيكل الجديد
                    await saveFinancialRecordToFirebase(financialRecord);
                } else {
                    // إضافة مؤقتة للعرض
                    transactions.forEach(transaction => {
                        userTransactions.push(transaction);
                    });
                }
                
                // تحديث العرض
                await loadUserTransactions();
                
                hideLoading();
                showSuccess(`تم إنشاء ${transactions.length} معاملة مالية بنجاح`);
                
            } catch (error) {
                console.error('خطأ في إنشاء المعاملات:', error);
                hideLoading();
                showError('حدث خطأ في إنشاء المعاملات المالية');
            }
        }

        // ==================== حفظ السجل المالي في Firebase ====================
        async function saveFinancialRecordToFirebase(financialRecord) {
            try {
                const recordRef = db.collection('users').doc(currentUserId)
                    .collection('financialRecords').doc(financialRecord.courseId);
                
                // التحقق من وجود سجل سابق
                const existingRecord = await recordRef.get();
                
                if (existingRecord.exists) {
                    // دمج المعاملات الجديدة مع القديمة
                    const existingData = existingRecord.data();
                    financialRecord.transactions = [
                        ...existingData.transactions,
                        ...financialRecord.transactions
                    ];
                    
                    // تحديث الملخص
                    updateFinancialRecordSummary(financialRecord);
                    
                    // تحديث السجل
                    await recordRef.update({
                        transactions: financialRecord.transactions,
                        summary: financialRecord.summary,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    // إنشاء سجل جديد
                    await recordRef.set(financialRecord);
                }
                
                console.log('✅ تم حفظ السجل المالي بنجاح');
                
            } catch (error) {
                console.error('خطأ في حفظ السجل المالي:', error);
                throw error;
            }
        }

        // ==================== تحديث ملخص السجل المالي ====================
        function updateFinancialRecordSummary(record) {
            let paidAmount = 0;
            let pendingAmount = 0;
            let completedInstallments = 0;
            let nextPaymentDate = null;
            let lastPaymentDate = null;
            
            record.transactions.forEach(transaction => {
                if (transaction.status === 'completed') {
                    paidAmount += transaction.amount;
                    if (transaction.installmentInfo) {
                        completedInstallments++;
                    }
                    // تحديث تاريخ آخر دفعة
                    const transactionDate = new Date(transaction.paidDate || transaction.createdAt);
                    if (!lastPaymentDate || transactionDate > lastPaymentDate) {
                        lastPaymentDate = transactionDate;
                    }
                } else if (transaction.status === 'pending') {
                    pendingAmount += transaction.amount;
                    // تحديد تاريخ الدفعة القادمة
                    if (transaction.dueDate) {
                        const dueDate = new Date(transaction.dueDate);
                        if (!nextPaymentDate || dueDate < nextPaymentDate) {
                            nextPaymentDate = dueDate;
                        }
                    }
                }
            });
            
            record.summary = {
                totalAmount: record.pricing.finalPrice,
                paidAmount: paidAmount,
                pendingAmount: pendingAmount,
                remainingAmount: record.pricing.finalPrice - paidAmount,
                completedInstallments: completedInstallments,
                status: paidAmount >= record.pricing.finalPrice ? 'completed' : 'active'
            };
            
            record.lastPaymentDate = lastPaymentDate ? lastPaymentDate.toISOString() : null;
            record.nextPaymentDate = nextPaymentDate ? nextPaymentDate.toISOString() : null;
            
            if (record.summary.status === 'completed' && !record.completionDate) {
                record.completionDate = new Date().toISOString();
            }
        }

        // ==================== تحديث نموذج المعاملة حسب النوع ====================
        function updateTransactionForm() {
            const type = document.getElementById('transactionType').value;
            const paymentDetailsRow = document.getElementById('paymentDetailsRow');
            const installmentRow = document.getElementById('installmentRow');
            
            if (type === 'payment') {
                paymentDetailsRow.style.display = 'flex';
                installmentRow.style.display = 'flex';
            } else {
                paymentDetailsRow.style.display = 'none';
                installmentRow.style.display = 'none';
            }
        }

        // ==================== تحديث خيارات العناصر المرتبطة ====================
        function updateRelatedOptions() {
            const relatedType = document.getElementById('relatedType').value;
            const relatedItemGroup = document.getElementById('relatedItemGroup');
            const relatedItem = document.getElementById('relatedItem');
            
            if (relatedType) {
                relatedItemGroup.style.display = 'block';
                relatedItem.innerHTML = '<option value="">جاري التحميل...</option>';
                
                // تحميل الخيارات من Firebase حسب النوع
                loadRelatedItems(relatedType);
            } else {
                relatedItemGroup.style.display = 'none';
            }
        }

        // ==================== تبديل تفاصيل الأقساط ====================
        function toggleInstallmentDetails() {
            const paymentPlanType = document.getElementById('paymentPlanType').value;
            const installmentDetails = document.querySelector('.installment-details');
            
            if (paymentPlanType === 'installment') {
                installmentDetails.classList.add('show');
            } else {
                installmentDetails.classList.remove('show');
            }
        }

        // ==================== تحميل العناصر المرتبطة ====================
        async function loadRelatedItems(type) {
            const relatedItem = document.getElementById('relatedItem');
            
            try {
                let items = [];
                
                if (type === 'course') {
                    items = availableCourses || [];
                } else if (type === 'path') {
                    items = availablePaths || [];
                } else if (type === 'subscription') {
                    // يمكن إضافة الاشتراكات لاحقاً
                    items = [];
                }
                
                relatedItem.innerHTML = '<option value="">اختر...</option>';
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.title;
                    relatedItem.appendChild(option);
                });
                
                if (items.length === 0) {
                    relatedItem.innerHTML = '<option value="">لا توجد عناصر متاحة</option>';
                }
            } catch (error) {
                console.error('خطأ في تحميل العناصر:', error);
                relatedItem.innerHTML = '<option value="">خطأ في التحميل</option>';
            }
        }

        // ==================== إضافة معاملة جديدة ====================
        async function addTransaction() {
            if (!currentUserId && !editMode) {
                showError('يجب حفظ بيانات المستخدم أولاً');
                return;
            }
            
            // جمع بيانات النموذج
            const transactionData = {
                userId: currentUserId || 'temp',
                type: document.getElementById('transactionType').value,
                amount: parseFloat(document.getElementById('transactionAmount').value) || 0,
                createdAt: document.getElementById('transactionDate').value || new Date().toISOString(),
                dueDate: document.getElementById('transactionDate').value || new Date().toISOString(),
                status: document.getElementById('transactionStatus')?.value || 'pending',
                notes: document.getElementById('transactionNotes').value,
                createdBy: currentUser.email
            };
            
            // إضافة تفاصيل الدفع إذا كانت معاملة دفع
            if (transactionData.type === 'payment') {
                transactionData.paymentMethod = document.getElementById('paymentMethod').value;
                
                // إضافة تفاصيل الأقساط إذا وجدت
                const paymentPlanType = document.getElementById('paymentPlanType').value;
                if (paymentPlanType === 'installment') {
                    transactionData.installmentInfo = {
                        number: parseInt(document.getElementById('currentInstallment').value) || 1,
                        total: parseInt(document.getElementById('totalInstallments').value) || 1,
                        frequency: document.getElementById('installmentFrequency').value || 'monthly'
                    };
                }
            }
            
            // إضافة العنصر المرتبط
            const relatedType = document.getElementById('relatedType').value;
            if (relatedType) {
                const relatedItemId = document.getElementById('relatedItem').value;
                if (relatedItemId) {
                    const relatedItemData = [...availableCourses, ...availablePaths].find(item => item.id === relatedItemId);
                    if (relatedItemData) {
                        transactionData.relatedTo = {
                            type: relatedType,
                            id: relatedItemId,
                            title: relatedItemData.title
                        };
                    }
                }
            }
            
            try {
                showLoading('جاري إضافة المعاملة...');
                
                // إنشاء المعاملة بالهيكل الجديد
                const newTransaction = TransactionStructure.createTransaction(transactionData);
                
                if (editMode && currentUserId && transactionData.relatedTo) {
                    // إضافة المعاملة للسجل المالي في Firebase
                    const recordRef = db.collection('users').doc(currentUserId)
                        .collection('financialRecords').doc(transactionData.relatedTo.id);
                    
                    const recordDoc = await recordRef.get();
                    if (recordDoc.exists) {
                        // إضافة للسجل الموجود
                        await recordRef.update({
                            transactions: firebase.firestore.FieldValue.arrayUnion(newTransaction),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } else {
                        // إنشاء سجل جديد إذا لم يكن موجود
                        const financialRecord = CourseFinancialStructure.createCourseFinancialRecord(
                            transactionData.relatedTo.id,
                            transactionData.relatedTo,
                            { finalPrice: transactionData.amount, discount: 0, paymentType: 'full' }
                        );
                        financialRecord.transactions = [newTransaction];
                        await recordRef.set(financialRecord);
                    }
                } else {
                    // إضافة مؤقتة للمعاملات
                    userTransactions.push(newTransaction);
                }
                
                // تحديث العرض
                await loadUserTransactions();
                resetTransactionForm();
                
                hideLoading();
                showSuccess('تمت إضافة المعاملة بنجاح');
                
            } catch (error) {
                console.error('خطأ في إضافة المعاملة:', error);
                hideLoading();
                showError('حدث خطأ في إضافة المعاملة');
            }
        }

        // ==================== إعادة تعيين نموذج المعاملة ====================
        function resetTransactionForm() {
            document.getElementById('transactionForm').reset();
            document.getElementById('transactionDate').value = new Date().toISOString().slice(0, 16);
            updateTransactionForm();
            updateRelatedOptions();
        }

        // ==================== تحميل معاملات المستخدم ====================
        async function loadUserTransactions() {
            try {
                console.log('📊 جاري تحميل المعاملات المالية...');
                
                // تهيئة القيم الافتراضية
                userTransactions = userTransactions || [];
                userWallet = userWallet || {
                    balance: {
                        total: 0,
                        paid: 0,
                        pending: 0,
                        grants: 0,
                        points: 0
                    },
                    upcomingPayments: []
                };
                
                if (!currentUserId) {
                    console.log('مستخدم جديد - لا توجد معاملات سابقة');
                    updateFinancialSummary();
                    updateTransactionsDisplay();
                    updateUpcomingPaymentsDisplay();
                    return;
                }
                
                // جلب السجلات المالية من الهيكل الجديد
                const financialRecords = await db.collection('users').doc(currentUserId)
                    .collection('financialRecords').get();
                
                userTransactions = [];
                
                // استخراج جميع المعاملات من السجلات
                for (const doc of financialRecords.docs) {
                    const record = doc.data();
                    if (record.transactions && Array.isArray(record.transactions)) {
                        userTransactions.push(...record.transactions);
                    }
                }
                
                console.log(`✅ تم تحميل ${userTransactions.length} معاملة`);
                
                // تحديث الواجهة
                updateFinancialSummary();
                updateTransactionsDisplay();
                updateUpcomingPaymentsDisplay();
                
            } catch (error) {
                console.error('خطأ في تحميل المعاملات:', error);
                // حتى لو حصل خطأ، اعرض الواجهة فاضية
                updateFinancialSummary();
                updateTransactionsDisplay();
                updateUpcomingPaymentsDisplay();
            }
        }

        // ==================== تحديث الملخص المالي ====================
        function updateFinancialSummary() {
            // حساب المبالغ من المعاملات الفعلية
            let totalPaid = 0;
            let totalPending = 0;
            let totalGrants = 0;
            let loyaltyPoints = 0;
            const upcomingPayments = [];
            
            // التأكد من وجود معاملات
            if (!userTransactions || userTransactions.length === 0) {
                document.getElementById('totalPaid').textContent = '0 جنيه';
                document.getElementById('totalPending').textContent = '0 جنيه';
                document.getElementById('totalGrants').textContent = '0 جنيه';
                document.getElementById('loyaltyPoints').textContent = '0 نقطة';
                return;
            }
            
            // حساب كل نوع من المعاملات
            userTransactions.forEach(transaction => {
                const amount = parseFloat(transaction.amount) || 0;
                
                if (transaction.status === 'completed') {
                    switch(transaction.type) {
                        case 'payment':
                            totalPaid += amount;
                            // نقطة لكل 100 جنيه مدفوعة
                            loyaltyPoints += Math.floor(amount / 100);
                            break;
                        case 'grant':
                            totalGrants += amount;
                            break;
                        case 'gift':
                            totalGrants += amount;
                            break;
                        case 'compensation':
                            totalPaid += amount;
                            break;
                    }
                } else if (transaction.status === 'pending' || transaction.status === 'overdue') {
                    totalPending += amount;
                    
                    // إضافة للدفعات القادمة
                    if (transaction.dueDate) {
                        upcomingPayments.push({
                            amount: amount,
                            dueDate: transaction.dueDate,
                            description: transaction.notes,
                            relatedTo: transaction.relatedTo,
                            installmentInfo: transaction.installmentInfo,
                            transactionId: transaction.id,
                            status: transaction.status
                        });
                    }
                }
            });
            
            // ترتيب الدفعات القادمة حسب التاريخ
            upcomingPayments.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            
            // تحديث العرض في الصفحة
            document.getElementById('totalPaid').textContent = `${totalPaid.toFixed(2)} جنيه`;
            document.getElementById('totalPending').textContent = `${totalPending.toFixed(2)} جنيه`;
            document.getElementById('totalGrants').textContent = `${totalGrants.toFixed(2)} جنيه`;
            document.getElementById('loyaltyPoints').textContent = `${loyaltyPoints} نقطة`;
            
            // حفظ البيانات في المحفظة
            userWallet = {
                balance: {
                    total: totalPaid + totalGrants,
                    paid: totalPaid,
                    pending: totalPending,
                    grants: totalGrants,
                    points: loyaltyPoints
                },
                upcomingPayments: upcomingPayments.slice(0, 5) // أول 5 دفعات قادمة فقط
            };
            
            // تحديث عرض الدفعات القادمة
            updateUpcomingPaymentsDisplay();
            // في نهاية الدالة الموجودة، بعد updateUpcomingPaymentsDisplay();
// تحديث قسم المنح والخصومات
userTransactions.forEach(transaction => {
    if (transaction.status === 'completed' && transaction.discount > 0) {
        const discountAmount = (transaction.originalAmount || transaction.amount || 0) * (transaction.discount / 100);
        totalGrants += discountAmount;
    }
});

// تحديث العرض مرة تانية للمنح
document.getElementById('totalGrants').textContent = `${totalGrants.toFixed(2)} جنيه`;
            // إعادة حساب المنح والخصومات بشكل صحيح
let recalculatedGrants = 0;

userTransactions.forEach(transaction => {
    if (transaction.status === 'completed') {
        if (transaction.type === 'grant' || transaction.type === 'gift') {
            recalculatedGrants += transaction.originalAmount || transaction.amount || 0;
        } else if (transaction.discount > 0 && transaction.originalAmount) {
            const discountAmount = transaction.originalAmount * (transaction.discount / 100);
            recalculatedGrants += discountAmount;
        }
    }
});

// تحديث القيمة إذا كانت مختلفة
if (recalculatedGrants > totalGrants) {
    totalGrants = recalculatedGrants;
    document.getElementById('totalGrants').textContent = `${totalGrants.toFixed(2)} جنيه`;
    userWallet.balance.grants = totalGrants;
}
            console.log('تم تحديث الملخص المالي:', userWallet);
        }

        // ==================== تحديث عرض الأقساط القادمة المطور ====================
        function updateUpcomingPaymentsDisplay() {
            const container = document.getElementById('upcomingPaymentsList');
            const noPayments = document.getElementById('noUpcomingPayments');
            
            if (!container || !noPayments) return;
            
            if (!userWallet.upcomingPayments || userWallet.upcomingPayments.length === 0) {
                container.style.display = 'none';
                noPayments.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            noPayments.style.display = 'none';
            
            const now = new Date();
            const thisMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            const nextMonth = new Date(now.getFullYear(), now.getMonth() + 2, 0);
            
            container.innerHTML = userWallet.upcomingPayments.map((payment, index) => {
                const dueDate = new Date(payment.dueDate);
                const isOverdue = dueDate < now;
                const isThisMonth = dueDate <= thisMonth;
                const isNextMonth = dueDate <= nextMonth;
                
                // تحديد إذا كان الزر نشط
                const isButtonActive = isOverdue || isThisMonth || isNextMonth;
                
                const dateStr = dueDate.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                return `
                    <div class="upcoming-payment-item ${isOverdue ? 'overdue' : ''}" 
                         style="background: ${isOverdue ? '#fee' : isThisMonth ? '#fef9e7' : '#f8f9fa'}; 
                                padding: 15px; 
                                border-radius: 8px; 
                                margin-bottom: 10px;
                                border-right: 4px solid ${isOverdue ? '#dc3545' : isThisMonth ? '#ff9800' : '#28a745'};">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h5 style="margin: 0 0 5px 0; color: #333;">
                                    ${payment.relatedTo?.title || payment.description}
                                </h5>
                                <p style="margin: 0; color: #666; font-size: 14px;">
                                    <i class="fas fa-calendar"></i> ${dateStr}
                                    ${payment.installmentInfo ? ` - قسط ${payment.installmentInfo.number}/${payment.installmentInfo.total}` : ''}
                                </p>
                                ${isOverdue ? '<div style="margin-top: 5px; color: #dc3545; font-size: 14px;"><i class="fas fa-exclamation-triangle"></i> متأخر!</div>' : ''}
                            </div>
                            <div style="text-align: center; min-width: 120px;">
                                <div style="font-size: 24px; font-weight: bold; color: ${isOverdue ? '#dc3545' : '#28a745'};">
                                    ${payment.amount.toFixed(2)}
                                </div>
                                <div style="font-size: 14px; color: #666;">جنيه</div>
                            </div>
                        </div>
                        <div class="payment-actions" style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-sm ${isButtonActive ? 'btn-primary' : 'btn-secondary'}" 
                                    onclick="sendPaymentReminder('${payment.transactionId}')"
                                    ${!isButtonActive ? 'disabled' : ''}>
                                <i class="fas fa-bell"></i> إرسال تذكير
                            </button>
                            <button class="btn btn-sm btn-success" 
                                    onclick="markPaymentAsPaid('${payment.transactionId}')">
                                <i class="fas fa-check"></i> تم الدفع
                            </button>
                            <button class="btn btn-sm btn-outline" 
                                    onclick="postponePayment('${payment.transactionId}')"
                                    ${!isButtonActive ? 'disabled' : ''}>
                                <i class="fas fa-calendar-plus"></i> تأجيل
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
// ==================== تحديث عرض المعاملات مع الأعمدة الجديدة ====================
        function updateTransactionsDisplay(transactionsToShow = null) {
            const transactions = transactionsToShow || userTransactions || [];
            const tbody = document.getElementById('transactionsTableBody');
            const noTransactions = document.getElementById('noTransactions');
            
            if (!tbody || !noTransactions) return;
            
            if (transactions.length === 0) {
                tbody.innerHTML = '';
                noTransactions.style.display = 'block';
                return;
            }
            
            noTransactions.style.display = 'none';
            tbody.innerHTML = transactions.map(transaction => {
                // التواريخ
                const createdDate = transaction.createdAt ? 
                    new Date(transaction.createdAt).toLocaleDateString('ar-EG') : '-';
                const dueDate = transaction.dueDate ? 
                    new Date(transaction.dueDate).toLocaleDateString('ar-EG') : '-';
                const updatedDate = transaction.lastUpdated ? 
                    new Date(transaction.lastUpdated).toLocaleDateString('ar-EG') : '-';
                
                // تحديد إذا كان متأخر
                const isOverdue = transaction.status === 'pending' && 
                    transaction.dueDate && 
                    new Date(transaction.dueDate) < new Date();
                
                // أنماط النوع والحالة
                const typeClass = `transaction-type ${transaction.type}`;
                const statusClass = `status-badge ${isOverdue ? 'overdue' : transaction.status}`;
                
                // تسميات الأنواع
                const typeLabels = {
                    payment: '<i class="fas fa-money-bill"></i> دفعة',
                    grant: '<i class="fas fa-graduation-cap"></i> منحة',
                    gift: '<i class="fas fa-gift"></i> هدية',
                    compensation: '<i class="fas fa-hand-holding-usd"></i> تعويض',
                    refund: '<i class="fas fa-undo"></i> استرجاع',
                    'group-offer': '<i class="fas fa-users"></i> عرض مجموعة',
                    'recommendation': '<i class="fas fa-star"></i> توصية'
                };
                
                // إنشاء dropdown للحالة
                const statusDropdown = `
                    <select class="transaction-status-select" 
                            onchange="updateTransactionStatus('${transaction.id}', this.value)"
                            ${transaction.status === 'completed' ? 'style="background: #d4edda;"' : ''}>
                        <option value="pending" ${transaction.status === 'pending' ? 'selected' : ''}>
                            ⏳ معلقة
                        </option>
                        <option value="completed" ${transaction.status === 'completed' ? 'selected' : ''}>
                            ✅ مكتملة
                        </option>
                        <option value="failed" ${transaction.status === 'failed' ? 'selected' : ''}>
                            ❌ فاشلة
                        </option>
                        ${isOverdue ? '<option value="overdue" selected>⚠️ متأخرة</option>' : ''}
                    </select>
                `;
                
                // المرجع
                const reference = transaction.reference ? 
                    `<span class="transaction-reference">${transaction.reference}</span>` : '-';
                
                // العنصر المرتبط
                const relatedToText = transaction.relatedTo ? 
                    `<div style="font-size: 12px;">
                        <strong>${transaction.relatedTo.type === 'course' ? 'دورة' : 'مسار'}:</strong> 
                        ${transaction.relatedTo.title}
                        ${transaction.installmentInfo ? 
                            `<br><small>قسط ${transaction.installmentInfo.number}/${transaction.installmentInfo.total}</small>` : ''}
                    </div>` : '-';
                
                return `
                    <tr>
                        <td>${createdDate}</td>
                        <td>
                            <span class="${isOverdue ? 'due-date-badge overdue' : 'due-date-badge'}">
                                ${dueDate}
                                ${isOverdue ? '<i class="fas fa-exclamation-triangle"></i>' : ''}
                            </span>
                        </td>
                        <td>${updatedDate}</td>
                        <td><span class="${typeClass}">${typeLabels[transaction.type] || transaction.type}</span></td>
                        <td><strong>${transaction.amount?.toFixed(2) || 0} جنيه</strong></td>
                        <td>${getPaymentMethodLabel(transaction.paymentMethod) || '-'}</td>
                        <td>${reference}</td>
                        <td>${relatedToText}</td>
                        <td>${statusDropdown}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewTransaction('${transaction.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="editTransaction('${transaction.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction('${transaction.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ==================== تحديث حالة المعاملة مباشرة ====================
        async function updateTransactionStatus(transactionId, newStatus) {
            try {
                showLoading('جاري تحديث الحالة...');
                
                // العثور على المعاملة
                const transaction = userTransactions.find(t => t.id === transactionId);
                if (!transaction) {
                    throw new Error('المعاملة غير موجودة');
                }
                
                // تحديث البيانات
                transaction.status = newStatus;
                transaction.lastUpdated = new Date().toISOString();
                transaction.lastUpdatedBy = currentUser?.email || 'system';
                
                if (newStatus === 'completed' && !transaction.paidDate) {
                    transaction.paidDate = new Date().toISOString();
                }
                
                // حفظ في Firebase إذا كان في وضع التعديل
                if (editMode && currentUserId && transaction.relatedTo) {
                    const recordRef = db.collection('users').doc(currentUserId)
                        .collection('financialRecords').doc(transaction.relatedTo.id);
                    
                    const record = await recordRef.get();
                    if (record.exists) {
                        const recordData = record.data();
                        const updatedTransactions = recordData.transactions.map(t => 
                            t.id === transactionId ? transaction : t
                        );
                        
                        // تحديث السجل
                        const updatedRecord = { ...recordData, transactions: updatedTransactions };
                        updateFinancialRecordSummary(updatedRecord);
                        
                        await recordRef.update({
                            transactions: updatedTransactions,
                            summary: updatedRecord.summary,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
                
                hideLoading();
                showSuccess('تم تحديث حالة المعاملة');
                
                // تحديث العرض
                updateFinancialSummary();
                updateTransactionsDisplay();
                updateUpcomingPaymentsDisplay();
                
            } catch (error) {
                console.error('خطأ في تحديث الحالة:', error);
                hideLoading();
                showError('حدث خطأ في تحديث الحالة');
            }
        }

        // ==================== تحرير المعاملة ====================
        async function editTransaction(transactionId) {
            const transaction = userTransactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            // ملء نموذج التعديل
            document.getElementById('editTransactionId').value = transaction.id;
            document.getElementById('editTransactionType').value = transaction.type;
            document.getElementById('editTransactionAmount').value = transaction.amount;
            document.getElementById('editTransactionDate').value = transaction.createdAt.slice(0, 16);
            document.getElementById('editDueDate').value = transaction.dueDate ? transaction.dueDate.slice(0, 10) : '';
            document.getElementById('editPaymentMethod').value = transaction.paymentMethod || '';
            document.getElementById('editTransactionStatus').value = transaction.status;
            document.getElementById('editTransactionReference').value = transaction.reference || '';
            document.getElementById('editTransactionNotes').value = transaction.notes || '';
            
            // إظهار النافذة
            document.getElementById('transactionEditModal').style.display = 'block';
        }

        // ==================== تحديث المعاملة ====================
        async function updateTransaction() {
            try {
                const transactionId = document.getElementById('editTransactionId').value;
                if (!transactionId) return;
                
                showLoading('جاري تحديث المعاملة...');
                
                // العثور على المعاملة
                const transaction = userTransactions.find(t => t.id === transactionId);
                if (!transaction) {
                    throw new Error('المعاملة غير موجودة');
                }
                
                // تحديث البيانات
                transaction.type = document.getElementById('editTransactionType').value;
                transaction.amount = parseFloat(document.getElementById('editTransactionAmount').value);
                transaction.createdAt = document.getElementById('editTransactionDate').value;
                transaction.dueDate = document.getElementById('editDueDate').value;
                transaction.paymentMethod = document.getElementById('editPaymentMethod').value;
                transaction.status = document.getElementById('editTransactionStatus').value;
                transaction.notes = document.getElementById('editTransactionNotes').value;
                transaction.lastUpdated = new Date().toISOString();
                transaction.lastUpdatedBy = currentUser?.email || 'system';
                
                // حفظ في Firebase
                if (editMode && currentUserId && transaction.relatedTo) {
                    const recordRef = db.collection('users').doc(currentUserId)
                        .collection('financialRecords').doc(transaction.relatedTo.id);
                    
                    const record = await recordRef.get();
                    if (record.exists) {
                        const recordData = record.data();
                        const updatedTransactions = recordData.transactions.map(t => 
                            t.id === transactionId ? transaction : t
                        );
                        
                        // تحديث السجل
                        const updatedRecord = { ...recordData, transactions: updatedTransactions };
                        updateFinancialRecordSummary(updatedRecord);
                        
                        await recordRef.update({
                            transactions: updatedTransactions,
                            summary: updatedRecord.summary,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
                
                // إغلاق النافذة
                closeTransactionEditModal();
                
                // تحديث العرض
                updateFinancialSummary();
                updateTransactionsDisplay();
                updateUpcomingPaymentsDisplay();
                
                hideLoading();
                showSuccess('تم تحديث المعاملة بنجاح');
                
            } catch (error) {
                console.error('خطأ في تحديث المعاملة:', error);
                hideLoading();
                showError('حدث خطأ في تحديث المعاملة');
            }
        }

        // ==================== حذف معاملة ====================
        async function deleteTransaction(transactionId) {
            const result = await Swal.fire({
                title: 'هل أنت متأكد؟',
                text: 'سيتم حذف هذه المعاملة نهائياً',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545'
            });
            
            if (result.isConfirmed) {
                try {
                    showLoading('جاري الحذف...');
                    
                    const transaction = userTransactions.find(t => t.id === transactionId);
                    if (!transaction) {
                        throw new Error('المعاملة غير موجودة');
                    }
                    
                    if (editMode && currentUserId && transaction.relatedTo) {
                        // حذف من Firebase
                        const recordRef = db.collection('users').doc(currentUserId)
                            .collection('financialRecords').doc(transaction.relatedTo.id);
                        
                        const record = await recordRef.get();
                        if (record.exists) {
                            const recordData = record.data();
                            const updatedTransactions = recordData.transactions.filter(t => t.id !== transactionId);
                            
                            // تحديث السجل
                            const updatedRecord = { ...recordData, transactions: updatedTransactions };
                            updateFinancialRecordSummary(updatedRecord);
                            
                            await recordRef.update({
                                transactions: updatedTransactions,
                                summary: updatedRecord.summary,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    }
                    
                    // حذف من المصفوفة المحلية
                    userTransactions = userTransactions.filter(t => t.id !== transactionId);
                    
                    // تحديث العرض
                    updateFinancialSummary();
                    updateTransactionsDisplay();
                    updateUpcomingPaymentsDisplay();
                    
                    hideLoading();
                    showSuccess('تم حذف المعاملة بنجاح');
                    
                } catch (error) {
                    console.error('خطأ في حذف المعاملة:', error);
                    hideLoading();
                    showError('حدث خطأ في حذف المعاملة');
                }
            }
        }

        // ==================== تحميل الدورات للفلاتر ====================
        async function loadCoursesForFilters() {
            try {
                const courseFilter = document.getElementById('filterCourse');
                const pathFilter = document.getElementById('filterPath');
                const statementSelect = document.getElementById('statementSelect');
                
                if (!courseFilter || !pathFilter || !statementSelect) return;
                
                // إعادة تعيين القوائم
                courseFilter.innerHTML = '<option value="">كل الدورات</option>';
                pathFilter.innerHTML = '<option value="">كل المسارات</option>';
                statementSelect.innerHTML = '<option value="">اختر دورة أو مسار لعرض البيان</option>';
                
                // استخراج الدورات والمسارات الفريدة من المعاملات
                const uniqueCourses = new Set();
                const uniquePaths = new Set();
                
                userTransactions.forEach(transaction => {
                    if (transaction.relatedTo) {
                        if (transaction.relatedTo.type === 'course') {
                            uniqueCourses.add(JSON.stringify({
                                id: transaction.relatedTo.id,
                                title: transaction.relatedTo.title
                            }));
                        } else if (transaction.relatedTo.type === 'path') {
                            uniquePaths.add(JSON.stringify({
                                id: transaction.relatedTo.id,
                                title: transaction.relatedTo.title
                            }));
                        }
                    }
                });
                
                // إضافة الدورات للفلاتر
                Array.from(uniqueCourses).forEach(courseStr => {
                    const course = JSON.parse(courseStr);
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.textContent = course.title;
                    courseFilter.appendChild(option);
                    
                    // إضافة لقائمة بيان الاستثمار
                    const statementOption = option.cloneNode(true);
                    statementOption.setAttribute('data-type', 'course');
                    statementSelect.appendChild(statementOption);
                });
                
                // إضافة المسارات للفلاتر
                Array.from(uniquePaths).forEach(pathStr => {
                    const path = JSON.parse(pathStr);
                    const option = document.createElement('option');
                    option.value = path.id;
                    option.textContent = path.title;
                    pathFilter.appendChild(option);
                    
                    // إضافة لقائمة بيان الاستثمار
                    const statementOption = option.cloneNode(true);
                    statementOption.setAttribute('data-type', 'path');
                    statementSelect.appendChild(statementOption);
                });
                
            } catch (error) {
                console.error('خطأ في تحميل الدورات للفلاتر:', error);
            }
        }

        // ==================== تطبيق الفلاتر المتقدمة ====================
        function applyFilters() {
            const typeFilter = document.getElementById('filterType').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const periodFilter = document.getElementById('filterPeriod').value;
            const courseFilter = document.getElementById('filterCourse').value;
            const pathFilter = document.getElementById('filterPath').value;
            const dueDateFilter = document.getElementById('filterDueDate').value;
            
            let filteredTransactions = [...userTransactions];
            
            // فلترة حسب النوع
            if (typeFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.type === typeFilter);
            }
            
            // فلترة حسب الحالة
            if (statusFilter) {
                if (statusFilter === 'overdue') {
                    filteredTransactions = filteredTransactions.filter(t => 
                        t.status === 'pending' && 
                        t.dueDate && 
                        new Date(t.dueDate) < new Date()
                    );
                } else {
                    filteredTransactions = filteredTransactions.filter(t => t.status === statusFilter);
                }
            }
            
            // فلترة حسب الفترة
            if (periodFilter) {
                const now = new Date();
                const startDate = new Date();
                
                switch (periodFilter) {
                    case 'today':
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'week':
                        startDate.setDate(now.getDate() - 7);
                        break;
                    case 'month':
                        startDate.setMonth(now.getMonth() - 1);
                        break;
                    case 'year':
                        startDate.setFullYear(now.getFullYear() - 1);
                        break;
                }
                
                filteredTransactions = filteredTransactions.filter(t => {
                    const transactionDate = new Date(t.createdAt);
                    return transactionDate >= startDate;
                });
            }
            
            // فلترة حسب الدورة
            if (courseFilter) {
                filteredTransactions = filteredTransactions.filter(t => 
                    t.relatedTo && 
                    t.relatedTo.type === 'course' && 
                    t.relatedTo.id === courseFilter
                );
            }
            
            // فلترة حسب المسار
            if (pathFilter) {
                filteredTransactions = filteredTransactions.filter(t => 
                    t.relatedTo && 
                    t.relatedTo.type === 'path' && 
                    t.relatedTo.id === pathFilter
                );
            }
            
            // فلترة حسب تاريخ الاستحقاق
            if (dueDateFilter) {
                const now = new Date();
                const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                const endOfNextMonth = new Date(now.getFullYear(), now.getMonth() + 2, 0);
                
                switch (dueDateFilter) {
                    case 'overdue':
                        filteredTransactions = filteredTransactions.filter(t => 
                            t.dueDate && new Date(t.dueDate) < now
                        );
                        break;
                    case 'this-month':
                        filteredTransactions = filteredTransactions.filter(t => 
                            t.dueDate && 
                            new Date(t.dueDate) >= now && 
                            new Date(t.dueDate) <= endOfMonth
                        );
                        break;
                    case 'next-month':
                        filteredTransactions = filteredTransactions.filter(t => 
                            t.dueDate && 
                            new Date(t.dueDate) > endOfMonth && 
                            new Date(t.dueDate) <= endOfNextMonth
                        );
                        break;
                    case 'future':
                        filteredTransactions = filteredTransactions.filter(t => 
                            t.dueDate && new Date(t.dueDate) > endOfNextMonth
                        );
                        break;
                }
            }
            
            // حفظ تفضيلات الفلاتر
            DataCache.filterPreferences = {
                type: typeFilter,
                status: statusFilter,
                period: periodFilter,
                course: courseFilter,
                path: pathFilter,
                dueDate: dueDateFilter
            };
            
            // تحديث العرض
            updateTransactionsDisplay(filteredTransactions);
            
            // عرض عدد النتائج
            showSuccess(`تم العثور على ${filteredTransactions.length} معاملة`);
        }

        // ==================== دوال الأقساط المستقبلية الذكية ====================
        
        // إرسال تذكير
        async function sendPaymentReminder(transactionId) {
            try {
                const transaction = userTransactions.find(t => t.id === transactionId);
                if (!transaction) return;
                
                const userData = await db.collection('users').doc(currentUserId).get();
                const user = userData.data();
                
                const message = WhatsAppTemplates.installmentReminder({
                    userName: user.name || 'عزيزنا العميل',
                    courseTitle: transaction.relatedTo?.title || 'الدورة',
                    amount: transaction.amount,
                    dueDate: new Date(transaction.dueDate).toLocaleDateString('ar-EG'),
                    paymentMethods: ['فودافون كاش: 01234567890', 'InstaPay: @fouadacademy']
                });
                
                const whatsappUrl = `https://wa.me/${user.whatsapp.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                // تسجيل النشاط
                console.log('تم إرسال تذكير للمعاملة:', transactionId);
                
            } catch (error) {
                console.error('خطأ في إرسال التذكير:', error);
                showError('حدث خطأ في إرسال التذكير');
            }
        }
        
        // تحديد الدفعة كمدفوعة
        async function markPaymentAsPaid(transactionId) {
            await updateTransactionStatus(transactionId, 'completed');
        }
        
        // تأجيل الدفعة
        async function postponePayment(transactionId) {
            const { value: days } = await Swal.fire({
                title: 'تأجيل الدفعة',
                input: 'number',
                inputLabel: 'عدد الأيام',
                inputPlaceholder: 'أدخل عدد أيام التأجيل',
                inputAttributes: {
                    min: 1,
                    max: 90,
                    step: 1
                },
                showCancelButton: true,
                confirmButtonText: 'تأجيل',
                cancelButtonText: 'إلغاء'
            });
            
            if (days) {
                try {
                    showLoading('جاري تأجيل الدفعة...');
                    
                    const transaction = userTransactions.find(t => t.id === transactionId);
                    if (!transaction) {
                        throw new Error('المعاملة غير موجودة');
                    }
                    
                    // حساب التاريخ الجديد
                    const currentDueDate = new Date(transaction.dueDate);
                    currentDueDate.setDate(currentDueDate.getDate() + parseInt(days));
                    
                    transaction.dueDate = currentDueDate.toISOString();
                    transaction.lastUpdated = new Date().toISOString();
                    transaction.notes = (transaction.notes || '') + `\n[تم التأجيل ${days} يوم بتاريخ ${new Date().toLocaleDateString('ar-EG')}]`;
                    
                    // حفظ في Firebase
                    if (editMode && currentUserId && transaction.relatedTo) {
                        const recordRef = db.collection('users').doc(currentUserId)
                            .collection('financialRecords').doc(transaction.relatedTo.id);
                        
                        const record = await recordRef.get();
                        if (record.exists) {
                            const recordData = record.data();
                            const updatedTransactions = recordData.transactions.map(t => 
                                t.id === transactionId ? transaction : t
                            );
                            
                            await recordRef.update({
                                transactions: updatedTransactions,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    }
                    
                    // تحديث العرض
                    updateFinancialSummary();
                    updateTransactionsDisplay();
                    updateUpcomingPaymentsDisplay();
                    
                    hideLoading();
                    showSuccess(`تم تأجيل الدفعة ${days} يوم`);
                    
                } catch (error) {
                    console.error('خطأ في تأجيل الدفعة:', error);
                    hideLoading();
                    showError('حدث خطأ في تأجيل الدفعة');
                }
            }
        }

// ==================== قسم بيان الاستثمار ====================
        
        // تحميل بيان الاستثمار
        async function loadInvestmentStatement() {
            const select = document.getElementById('statementSelect');
            const selectedId = select.value;
            
            if (!selectedId) {
                document.getElementById('statementPreview').style.display = 'none';
                document.getElementById('sendStatementBtn').disabled = true;
                return;
            }
            
            try {
                showLoading('جاري تحميل البيان...');
                
                // جلب المعاملات الخاصة بالدورة/المسار
                const relatedTransactions = userTransactions.filter(t => 
                    t.relatedTo && t.relatedTo.id === selectedId
                );
                
                if (relatedTransactions.length === 0) {
                    showError('لا توجد معاملات لهذا العنصر');
                    hideLoading();
                    return;
                }
                
                // بيانات الدورة/المسار
                const selectedOption = select.options[select.selectedIndex];
                const itemTitle = selectedOption.textContent;
                const itemType = selectedOption.getAttribute('data-type');
                
                // حساب البيانات المالية
                let originalPrice = 0;
                let discount = 0;
                let totalAmount = 0;
                let paidAmount = 0;
                let pendingAmount = 0;
                const installments = [];
                
                relatedTransactions.forEach(transaction => {
                    originalPrice = transaction.originalAmount || transaction.amount;
                    discount = transaction.discount || 0;
                    totalAmount += transaction.amount;
                    
                    if (transaction.status === 'completed') {
                        paidAmount += transaction.amount;
                    } else {
                        pendingAmount += transaction.amount;
                    }
                    
                    if (transaction.installmentInfo) {
                        installments.push({
                            number: transaction.installmentInfo.number,
                            total: transaction.installmentInfo.total,
                            amount: transaction.amount,
                            dueDate: transaction.dueDate,
                            status: transaction.status,
                            paidDate: transaction.paidDate
                        });
                    }
                });
                
                // ترتيب الأقساط
                installments.sort((a, b) => a.number - b.number);
                
                // تحديث العرض
                document.getElementById('statementTitle').textContent = itemTitle;
                document.getElementById('statementStartDate').textContent = 
                    new Date(relatedTransactions[0].createdAt).toLocaleDateString('ar-EG');
                document.getElementById('statementLastUpdate').textContent = 
                    new Date().toLocaleDateString('ar-EG');
                
                document.getElementById('statementOriginalPrice').textContent = `${originalPrice.toFixed(2)} جنيه`;
                document.getElementById('statementDiscount').textContent = 
                    discount > 0 ? `${discount}% (${(originalPrice * discount / 100).toFixed(2)} جنيه)` : '0 جنيه';
                document.getElementById('statementTotal').textContent = `${totalAmount.toFixed(2)} جنيه`;
                document.getElementById('statementPaid').textContent = `${paidAmount.toFixed(2)} جنيه`;
                document.getElementById('statementRemaining').textContent = `${pendingAmount.toFixed(2)} جنيه`;
                
                // ملء جدول التفاصيل
                const tbody = document.getElementById('statementDetailsBody');
                tbody.innerHTML = installments.length > 0 ? 
                    installments.map(installment => `
                        <tr>
                            <td>${installment.number}/${installment.total}</td>
                            <td>${new Date(installment.dueDate).toLocaleDateString('ar-EG')}</td>
                            <td>${installment.amount.toFixed(2)} جنيه</td>
                            <td>
                                <span class="status-badge ${installment.status}">
                                    ${installment.status === 'completed' ? '✅ مدفوع' : '⏳ معلق'}
                                </span>
                            </td>
                            <td>
                                ${installment.paidDate ? 
                                    new Date(installment.paidDate).toLocaleDateString('ar-EG') : '-'}
                            </td>
                        </tr>
                    `).join('') :
                    `<tr>
                        <td>دفعة واحدة</td>
                        <td>${new Date(relatedTransactions[0].dueDate).toLocaleDateString('ar-EG')}</td>
                        <td>${totalAmount.toFixed(2)} جنيه</td>
                        <td>
                            <span class="status-badge ${relatedTransactions[0].status}">
                                ${relatedTransactions[0].status === 'completed' ? '✅ مدفوع' : '⏳ معلق'}
                            </span>
                        </td>
                        <td>
                            ${relatedTransactions[0].paidDate ? 
                                new Date(relatedTransactions[0].paidDate).toLocaleDateString('ar-EG') : '-'}
                        </td>
                    </tr>`;
                
                // رسم المخطط البياني
                drawStatementChart(paidAmount, pendingAmount);
                
                // إظهار البيان وتفعيل زر الإرسال
                document.getElementById('statementPreview').style.display = 'block';
                document.getElementById('sendStatementBtn').disabled = false;
                
                // حفظ البيانات للإرسال
                window.currentStatementData = {
                    courseTitle: itemTitle,
                    originalPrice,
                    discount,
                    discountAmount: originalPrice * discount / 100,
                    totalAmount,
                    paidAmount,
                    remainingAmount: pendingAmount,
                    progressPercentage: Math.round((paidAmount / totalAmount) * 100),
                    installments: installments.filter(i => i.status === 'pending').map(i => ({
                        date: new Date(i.dueDate).toLocaleDateString('ar-EG'),
                        amount: i.amount.toFixed(2)
                    }))
                };
                
                hideLoading();
                
            } catch (error) {
                console.error('خطأ في تحميل البيان:', error);
                hideLoading();
                showError('حدث خطأ في تحميل البيان');
            }
        }
        
        // رسم المخطط البياني
        function drawStatementChart(paid, pending) {
            const ctx = document.getElementById('statementChart');
            if (!ctx) return;
            
            // إزالة المخطط السابق إذا وجد
            if (window.statementChartInstance) {
                window.statementChartInstance.destroy();
            }
            
            window.statementChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['مدفوع', 'متبقي'],
                    datasets: [{
                        data: [paid, pending],
                        backgroundColor: ['#28a745', '#ffc107'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 14,
                                    family: 'Noto Kufi Arabic'
                                },
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toFixed(2) + ' جنيه';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // إرسال بيان WhatsApp
        async function sendWhatsAppStatement() {
            if (!window.currentStatementData) {
                showError('لا توجد بيانات للإرسال');
                return;
            }
            
            try {
                const userData = await db.collection('users').doc(currentUserId).get();
                const user = userData.data();
                
                const message = WhatsAppTemplates.investmentStatement(window.currentStatementData);
                const whatsappUrl = `https://wa.me/${user.whatsapp.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
                
                window.open(whatsappUrl, '_blank');
                
                // تسجيل النشاط
                console.log('تم إرسال بيان الاستثمار');
                showSuccess('تم فتح WhatsApp لإرسال البيان');
                
            } catch (error) {
                console.error('خطأ في إرسال البيان:', error);
                showError('حدث خطأ في إرسال البيان');
            }
        }
        
        // طباعة البيان
        function printStatement() {
            window.print();
        }
        
        // تحميل البيان كـ PDF
        function downloadStatement() {
            // يمكن استخدام مكتبة مثل jsPDF لتحويل البيان إلى PDF
            showWarning('خاصية التحميل كـ PDF قيد التطوير');
        }

        // ==================== دوال مساعدة للمعاملات ====================
        
        function getPaymentMethodLabel(method) {
            const labels = {
                vodafone: 'فودافون كاش',
                instapay: 'InstaPay',
                bank: 'تحويل بنكي',
                western: 'ويسترن يونيون',
                cash: 'نقدي',
                other: 'أخرى',
                grant: 'منحة',
                pending: 'لم يحدد'
            };
            return labels[method] || method || 'غير محدد';
        }
        
        // عرض تفاصيل المعاملة
        function viewTransaction(transactionId) {
            const transaction = userTransactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            // حساب الأيام المتبقية/المتأخرة
            let dueDateInfo = '';
            if (transaction.dueDate && transaction.status === 'pending') {
                const dueDate = new Date(transaction.dueDate);
                const today = new Date();
                const diffTime = dueDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays < 0) {
                    dueDateInfo = `<span style="color: #dc3545;">متأخر ${Math.abs(diffDays)} يوم</span>`;
                } else if (diffDays === 0) {
                    dueDateInfo = `<span style="color: #ff9800;">مستحق اليوم</span>`;
                } else {
                    dueDateInfo = `<span style="color: #28a745;">متبقي ${diffDays} يوم</span>`;
                }
            }
            
            Swal.fire({
                title: 'تفاصيل المعاملة',
                html: `
                    <div style="text-align: right; direction: rtl;">
                        <div class="mb-3">
                            <strong>المرجع:</strong> 
                            <span style="font-family: monospace; background: #f8f9fa; padding: 2px 8px; border-radius: 4px;">
                                ${transaction.reference}
                            </span>
                        </div>
                        <div class="mb-3">
                            <strong>النوع:</strong> ${getTransactionTypeLabel(transaction.type)}
                        </div>
                        <div class="mb-3">
                            <strong>المبلغ:</strong> ${transaction.amount} جنيه
                            ${transaction.discount > 0 ? `<br><small>خصم: ${transaction.discount}%</small>` : ''}
                        </div>
                        <div class="mb-3">
                            <strong>تاريخ الإنشاء:</strong> ${new Date(transaction.createdAt).toLocaleString('ar-EG')}
                        </div>
                        <div class="mb-3">
                            <strong>تاريخ الاستحقاق:</strong> ${transaction.dueDate ? 
                                new Date(transaction.dueDate).toLocaleDateString('ar-EG') : 'غير محدد'}
                            ${dueDateInfo ? `<br>${dueDateInfo}` : ''}
                        </div>
                        <div class="mb-3">
                            <strong>الحالة:</strong> ${getTransactionStatusLabel(transaction.status)}
                            ${transaction.paidDate ? `<br><small>تم الدفع: ${new Date(transaction.paidDate).toLocaleDateString('ar-EG')}</small>` : ''}
                        </div>
                        ${transaction.paymentMethod ? `
                            <div class="mb-3">
                                <strong>طريقة الدفع:</strong> ${getPaymentMethodLabel(transaction.paymentMethod)}
                            </div>
                        ` : ''}
                        ${transaction.relatedTo ? `
                            <div class="mb-3">
                                <strong>مرتبط بـ:</strong> ${transaction.relatedTo.type === 'course' ? 'دورة' : 'مسار'}: ${transaction.relatedTo.title}
                                ${transaction.installmentInfo ? 
                                    `<br><small>قسط ${transaction.installmentInfo.number} من ${transaction.installmentInfo.total}</small>` : ''}
                            </div>
                        ` : ''}
                        ${transaction.notes ? `
                            <div class="mb-3">
                                <strong>ملاحظات:</strong><br>
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; white-space: pre-wrap;">
                                    ${transaction.notes}
                                </div>
                            </div>
                        ` : ''}
                        <div class="mb-3">
                            <strong>آخر تحديث:</strong> ${transaction.lastUpdated ? 
                                new Date(transaction.lastUpdated).toLocaleString('ar-EG') : '-'}
                            ${transaction.lastUpdatedBy ? `<br><small>بواسطة: ${transaction.lastUpdatedBy}</small>` : ''}
                        </div>
                    </div>
                `,
                confirmButtonColor: 'var(--primary)',
                confirmButtonText: 'إغلاق',
                width: '600px'
            });
        }
        
        function getTransactionTypeLabel(type) {
            const labels = {
                payment: 'دفعة مالية',
                grant: 'منحة دراسية',
                gift: 'هدية/مكافأة',
                compensation: 'تعويض',
                refund: 'استرجاع',
                'group-offer': 'عرض ضمن مجموعة',
                'recommendation': 'توصية خاصة'
            };
            return labels[type] || type;
        }
        
        function getTransactionStatusLabel(status) {
            const labels = {
                completed: 'مكتملة',
                pending: 'معلقة',
                failed: 'فاشلة',
                cancelled: 'ملغاة',
                overdue: 'متأخرة'
            };
            return labels[status] || status;
        }

// ==================== دوال التحكم في أقسام المعلومات المتقدمة ====================
        function toggleSection(section) {
            const content = document.getElementById(section + 'Content');
            const header = content.previousElementSibling;
            const icon = header.querySelector('.section-toggle i');
            
            content.classList.toggle('collapsed');
            
            if (content.classList.contains('collapsed')) {
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            } else {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            }
        }

        // ==================== WhatsApp Message Functions ====================
const messageTemplates = {
    welcome: `🎉 *مرحباً بك في منصة منظور الفؤاد*

أهلاً *{name}* 👋

تم إنشاء حسابك بنجاح! إليك بيانات الدخول الخاصة بك:

📧 *البريد الإلكتروني:* {email}
🔑 *كلمة المرور:* {password}

🔗 *رابط الدخول:*
https://fouad-perspective.web.app/login

💡 *نصائح مهمة:*
- احتفظ بكلمة المرور في مكان آمن
- يمكنك تغيير كلمة المرور من إعدادات حسابك
- في حالة نسيان كلمة المرور، استخدم خاصية "نسيت كلمة المرور"

نتمنى لك رحلة تعليمية ممتعة ومفيدة 🚀

فريق منظور الفؤاد 💛`,

    credentials: `📱 *بيانات الدخول لمنصة منظور الفؤاد*

مرحباً *{name}*

📧 *البريد:* {email}
🔑 *كلمة المرور:* {password}

🔗 *الدخول من هنا:*
https://fouad-perspective.web.app/login`,

    reset: `🔄 *استعادة بيانات الدخول*

مرحباً *{name}* 

بناءً على طلبك، إليك بيانات الدخول الخاصة بك:

📧 *البريد:* {email}
🔑 *كلمة المرور:* {password}

💡 ننصحك بتغيير كلمة المرور بعد الدخول

🔗 *رابط الدخول:*
https://fouad-perspective.web.app/login`,

    custom: `مرحباً {name}

[اكتب رسالتك المخصصة هنا]

البريد: {email}
كلمة المرور: {password}`
};

// حفظ كلمات المرور في localStorage مؤقتاً (للجلسة الحالية فقط)
function saveUserPassword(userId, password) {
    const passwords = JSON.parse(sessionStorage.getItem('tempPasswords') || '{}');
    passwords[userId] = password;
    sessionStorage.setItem('tempPasswords', JSON.stringify(passwords));
}

function getUserPassword(userId) {
    const passwords = JSON.parse(sessionStorage.getItem('tempPasswords') || '{}');
    return passwords[userId] || '[كلمة المرور غير متاحة]';
}

function updateMessagePreview() {
    const templateType = document.getElementById('messageTemplate').value;
    const template = messageTemplates[templateType];
    
    const name = document.getElementById('firstName').value + ' ' + document.getElementById('lastName').value;
    const email = document.getElementById('email').value;
    const password = editMode ? getUserPassword(currentUserId) : document.getElementById('password').value;
    
    let message = template
        .replace(/{name}/g, name || '[الاسم]')
        .replace(/{email}/g, email || '[البريد الإلكتروني]')
        .replace(/{password}/g, password || '[كلمة المرور]');
    
    document.getElementById('messagePreview').value = message;
}

function sendWhatsAppMessage() {
    const message = document.getElementById('messagePreview').value;
    const phoneNumber = document.getElementById('countryCode').value + document.getElementById('phoneNumber').value;
    
    // إزالة + من رقم الهاتف
    const cleanNumber = phoneNumber.replace(/\+/g, '');
    
    // فتح WhatsApp Web
    const whatsappURL = `https://wa.me/${cleanNumber}?text=${encodeURIComponent(message)}`;
    window.open(whatsappURL, '_blank');
    
    showSuccess('تم فتح WhatsApp - الصق الرسالة وأرسلها');
}

function copyMessage() {
    const message = document.getElementById('messagePreview').value;
    navigator.clipboard.writeText(message).then(() => {
        showSuccess('تم نسخ الرسالة');
    }).catch(() => {
        // Fallback للمتصفحات القديمة
        const textarea = document.getElementById('messagePreview');
        textarea.select();
        document.execCommand('copy');
        showSuccess('تم نسخ الرسالة');
    });
}

// حفظ كلمة المرور عند الإنشاء
function savePasswordForUser() {
    if (!editMode && currentUserId && formData.basic.password) {
        saveUserPassword(currentUserId, formData.basic.password);
    }
}
        // ==================== Event Listeners Setup ====================
        function setupEventListeners() {
            // مراقبة حقول الاسم لإظهار زر إنشاء المعرف
            document.getElementById('firstName').addEventListener('input', checkNameFields);
            document.getElementById('lastName').addEventListener('input', checkNameFields);
            
            // Avatar Upload
            document.getElementById('avatarInput').addEventListener('change', handleAvatarUpload);
            document.getElementById('avatarPreview').addEventListener('click', () => {
                document.getElementById('avatarInput').click();
            });
            
            // Email Check
            document.getElementById('checkEmailBtn').addEventListener('click', checkEmailAvailability);
            
            // Password Confirmation
            document.getElementById('confirmPassword').addEventListener('input', function() {
                const password = document.getElementById('password').value;
                if (this.value !== password) {
                    showFieldError('confirmPassword', 'كلمات المرور غير متطابقة');
                } else {
                    clearFieldError('confirmPassword');
                }
            });
            
            // Role Selection
            document.querySelectorAll('input[name="primaryRole"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updatePermissionsForRole(this.value);
                });
            });
            
            // Permissions Toggle
            document.querySelectorAll('input[name="permissions"]').forEach(checkbox => {
                checkbox.addEventListener('change', updatePermissionsCounts);
            });
            
            // Custom Role Toggle
            document.getElementById('enableCustomRole').addEventListener('change', function() {
                const builder = document.getElementById('customRoleBuilder');
                builder.style.display = this.checked ? 'block' : 'none';
            });
            
            // Course Search
            document.getElementById('courseSearchInput').addEventListener('input', 
                debounce(filterCourses, 300)
            );
            
            // Clear Search
            document.getElementById('clearSearch').addEventListener('click', function() {
                document.getElementById('courseSearchInput').value = '';
                filterCourses('');
                this.style.display = 'none';
            });
            
            // Filter Buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterByType(this.getAttribute('data-filter'));
                });
            });
            
            // Sort Select
            document.getElementById('sortSelect').addEventListener('change', function() {
                sortCourses(this.value);
            });
            
            // Field Type Change (for custom fields)
            document.getElementById('fieldType').addEventListener('change', function() {
                const optionsGroup = document.getElementById('fieldOptionsGroup');
                optionsGroup.style.display = this.value === 'select' ? 'block' : 'none';
            });
            
            // Interests Input
            document.getElementById('interestsInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const value = this.value.trim();
                    if (value) {
                        addInterestTag(value);
                        this.value = '';
                    }
                }
            });
            
            // Color Presets
            document.querySelectorAll('.color-preset').forEach(preset => {
                preset.addEventListener('click', function() {
                    const color = this.getAttribute('data-color');
                    document.getElementById('customRoleColor').value = color;
                });
            });
            
            // ==================== الأحداث المالية ====================
            
            // نوع المعاملة
            const transactionType = document.getElementById('transactionType');
            if (transactionType) {
                transactionType.addEventListener('change', updateTransactionForm);
            }
            
            // العنصر المرتبط
            const relatedType = document.getElementById('relatedType');
            if (relatedType) {
                relatedType.addEventListener('change', updateRelatedOptions);
            }
            
            // نوع الدفع
            const paymentPlanType = document.getElementById('paymentPlanType');
            if (paymentPlanType) {
                paymentPlanType.addEventListener('change', toggleInstallmentDetails);
            }
            
            // تاريخ المعاملة الافتراضي
            const transactionDate = document.getElementById('transactionDate');
            if (transactionDate && !transactionDate.value) {
                transactionDate.value = new Date().toISOString().slice(0, 16);
            }
            
            // Form Actions
            document.getElementById('cancelBtn').addEventListener('click', handleCancel);
            document.getElementById('resetBtn').addEventListener('click', handleReset);
            document.getElementById('saveDraftBtn').addEventListener('click', () => saveUser(true));
            document.getElementById('saveBtn').addEventListener('click', () => saveUser(false));
            document.getElementById('quickSaveBtn').addEventListener('click', quickSave);

            // Auto-save every 30 seconds
            setInterval(autoSave, 30000);
            
            // تحميل المعاملات عند فتح التبويب المالي
            const financialTab = document.getElementById('financialTab');
            if (financialTab) {
                financialTab.addEventListener('click', function() {
                    if (editMode && currentUserId) {
                        loadUserTransactions();
                        loadCoursesForFilters();
                    }
                });
            }
        }

        // ==================== Avatar Upload to GitHub ====================
        async function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // التحقق من حجم الملف
            if (file.size > 5 * 1024 * 1024) {
                showError('حجم الصورة يجب أن يكون أقل من 5 ميجابايت');
                return;
            }
            
            // التحقق من نوع الملف
            if (!file.type.startsWith('image/')) {
                showError('يجب أن يكون الملف صورة');
                return;
            }
            
            try {
                showLoading('جاري معالجة الصورة...');
                
                // قراءة الملف
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const imageData = e.target.result;
                    
                    // عرض معاينة مؤقتة
                    displayAvatar(imageData);
                    
                    // إنشاء اسم فريد للملف
                    const timestamp = Date.now();
                    const fileName = `avatar_${timestamp}_${file.name}`;
                    const githubPath = `/media/avatars/${fileName}`;
                    
                    // إظهار تعليمات GitHub
                    const githubNote = document.getElementById('githubUploadNote');
                    const pathElement = document.getElementById('githubPath');
                    
                    pathElement.textContent = githubPath;
                    githubNote.style.display = 'block';
                    
                    // حفظ مسار الصورة مؤقتاً
                    formData.basic.avatarPath = `https://raw.githubusercontent.com/MahmoudFouad25/fouad-perspective/main${githubPath}`;
                    formData.basic.avatarData = imageData;
                    
                    hideLoading();
                    
                    // تنبيه المستخدم
                    await Swal.fire({
                        icon: 'info',
                        title: 'تعليمات رفع الصورة',
                        html: `
                            <div style="text-align: right;">
                                <p>تم تجهيز الصورة للرفع. يرجى اتباع الخطوات التالية:</p>
                                <ol style="text-align: right; padding-right: 20px;">
                                    <li>افتح مستودع GitHub الخاص بك</li>
                                    <li>انتقل إلى مجلد <code>/media/avatars/</code></li>
                                    <li>ارفع الصورة باسم: <code>${fileName}</code></li>
                                    <li>بعد الرفع، ستكون الصورة متاحة تلقائياً</li>
                                </ol>
                            </div>
                        `,
                        confirmButtonText: 'فهمت',
                        confirmButtonColor: 'var(--primary)'
                    });
                };
                
                reader.readAsDataURL(file);
                
            } catch (error) {
                console.error('خطأ في معالجة الصورة:', error);
                showError('حدث خطأ في معالجة الصورة');
                hideLoading();
            }
        }

        // ==================== Copy GitHub Path ====================
        window.copyGithubPath = async function() {
            const path = document.getElementById('githubPath').textContent;
            try {
                await navigator.clipboard.writeText(path);
                showSuccess('تم نسخ المسار');
            } catch (error) {
                console.error('خطأ في النسخ:', error);
            }
        };

        // ==================== Email Availability Check ====================
        async function checkEmailAvailability() {
            const email = document.getElementById('email').value.trim();
            
            if (!email || !isValidEmail(email)) {
                showFieldError('email', 'البريد الإلكتروني غير صحيح');
                return;
            }
            
            if (editMode) {
                showWarning('لا يمكن تغيير البريد الإلكتروني في وضع التعديل');
                return;
            }
            
            try {
                showLoading('جاري التحقق من البريد الإلكتروني...');
                
                // فحص في Firebase Auth أولاً
                let authUserExists = false;
                try {
                    await auth.fetchSignInMethodsForEmail(email);
                    authUserExists = true;
                } catch (authError) {
                    if (authError.code !== 'auth/user-not-found') {
                        console.warn('خطأ في فحص Firebase Auth:', authError);
                    }
                }
                
                // فحص في users collection
                const usersQuery = await db.collection('users')
                    .where('email', '==', email)
                    .limit(1)
                    .get();
                
                // فحص في userCredentials (منطقة الانتظار)
                const credDoc = await db.collection('userCredentials').doc(email).get();
                
                // تحديد حالة البريد الإلكتروني
                if (authUserExists || !usersQuery.empty || credDoc.exists) {
                    showFieldError('email', 'هذا البريد الإلكتروني مستخدم بالفعل');
                    document.getElementById('email').classList.add('error');
                    
                    // تفاصيل إضافية عن مكان الاستخدام
                    let details = [];
                    if (authUserExists) details.push('مسجل في النظام');
                    if (!usersQuery.empty) details.push('مستخدم نشط');
                    if (credDoc.exists) details.push('في قائمة الانتظار');
                    
                    const feedback = document.getElementById('emailFeedback');
                    feedback.innerHTML = `هذا البريد مستخدم بالفعل (${details.join(', ')})`;
                    
                } else {
                    clearFieldError('email');
                    document.getElementById('email').classList.add('success');
                    document.getElementById('emailFeedback').textContent = '✅ البريد الإلكتروني متاح';
                    document.getElementById('emailFeedback').classList.add('show', 'success');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('خطأ في التحقق من البريد:', error);
                showError('حدث خطأ في التحقق من البريد الإلكتروني');
                hideLoading();
            }
        }

        // ==================== Generate User Slug ====================
        window.generateUserSlug = async function() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const slugInput = document.getElementById('slugPreview');
            const customSlug = slugInput.value.trim();
            
            if (!firstName || !lastName) {
                showError('يجب إدخال الاسم الأول واسم العائلة');
                return;
            }
            
            if (!customSlug) {
                showError('يجب إدخال معرف المستخدم');
                return;
            }
            
            try {
                showLoading('جاري التحقق من المعرف...');
                
                // التحقق من صحة المعرف
                const slugPattern = /^[a-z0-9-]+$/;
                if (!slugPattern.test(customSlug)) {
                    showError('المعرف يجب أن يحتوي على أحرف صغيرة وأرقام وشرطات فقط');
                    hideLoading();
                    return;
                }
                
                // التحقق من عدم وجود مستخدم بنفس المعرف
                const existingDoc = await db.collection('users').doc(customSlug).get();
                if (existingDoc.exists) {
                    showError('هذا المعرف مستخدم بالفعل');
                    hideLoading();
                    return;
                }
                
                // تغيير الـ URL
                window.history.pushState({}, '', `?id=${customSlug}`);
                
                // تفعيل وضع التعديل
                editMode = true;
                currentUserId = customSlug;
                
                // تحديث العنوان
                updatePageForEditMode();
                
                // إخفاء قسم إنشاء المعرف
                document.getElementById('generateSlugSection').style.display = 'none';
                
                // إضافة رسالة نجاح
                const successDiv = document.createElement('div');
                successDiv.className = 'alert alert-success mt-3';
                successDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    تم إنشاء معرف المستخدم: <strong>${customSlug}</strong>
                `;
                document.getElementById('generateSlugSection').parentElement.appendChild(successDiv);
                
                // جعل الحقول للقراءة فقط
                document.getElementById('firstName').readOnly = true;
                document.getElementById('lastName').readOnly = true;
                
                hideLoading();
                showSuccess('تم إنشاء معرف المستخدم بنجاح');
                
            } catch (error) {
                console.error('خطأ في إنشاء المعرف:', error);
                hideLoading();
                showError('حدث خطأ في إنشاء معرف المستخدم');
            }
        };

        // دالة لإظهار/إخفاء زر إنشاء المعرف
        function checkNameFields() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const generateSection = document.getElementById('generateSlugSection');
            const slugPreview = document.getElementById('slugPreview');
            
            if (firstName && lastName && !editMode) {
                // إنشاء معاينة للمعرف
                const createSlug = function(text) {
                    return text
                        .toLowerCase()
                        .trim()
                        .replace(/[\u0600-\u06FF]/g, '')
                        .replace(/[^\w\s-]/g, '')
                        .replace(/[\s_-]+/g, '-')
                        .replace(/^-+|-+$/g, '');
                };
                
                const previewSlug = createSlug(`${firstName}-${lastName}`) || `user-${Date.now()}`;
                slugPreview.value = previewSlug;
                generateSection.style.display = 'block';
            } else {
                generateSection.style.display = 'none';
            }
        }

        // ==================== جمع بيانات النموذج ====================
        function collectFormData() {
            try {
                // البيانات الأساسية
                formData.basic = {
                    firstName: document.getElementById('firstName')?.value || '',
                    lastName: document.getElementById('lastName')?.value || '',
                    email: document.getElementById('email')?.value || '',
                    countryCode: document.getElementById('countryCode')?.value || '+20',
                    phoneNumber: document.getElementById('phoneNumber')?.value || '',
                    accountStatus: document.querySelector('input[name="accountStatus"]:checked')?.value || 'active',
                    avatar: formData.basic?.avatarPath || null
                };
                
                // كلمة المرور (في وضع الإنشاء فقط)
                if (!editMode) {
                    const passwordField = document.getElementById('password');
                    formData.basic.password = passwordField?.value || '';
                }
                
                // الأدوار والصلاحيات
                const primaryRoleElement = document.querySelector('input[name="primaryRole"]:checked');
                const permissionElements = document.querySelectorAll('input[name="permissions"]:checked');
                const customRoleEnabled = document.getElementById('enableCustomRole')?.checked || false;
                
                formData.roles = {
                    primaryRole: primaryRoleElement?.value || 'student',
                    permissions: Array.from(permissionElements).map(cb => cb.value),
                    customRole: customRoleEnabled ? {
                        name: document.getElementById('customRoleName')?.value || '',
                        color: document.getElementById('customRoleColor')?.value || '#f4c430',
                        description: document.getElementById('customRoleDescription')?.value || ''
                    } : null
                };
                
                // المعلومات المتقدمة
                formData.advanced = {
                    // الشخصية
                    birthDate: document.getElementById('birthDate')?.value || null,
                    gender: document.getElementById('gender')?.value || null,
                    nationality: document.getElementById('nationality')?.value || null,
                    
                    // التواصل
                    country: document.getElementById('country')?.value || null,
                    city: document.getElementById('city')?.value || null,
                    timezone: document.getElementById('timezone')?.value || null,
                    language: document.getElementById('language')?.value || 'ar',
                    address: document.getElementById('address')?.value || null,
                    
                    // المهنية
                    occupation: document.getElementById('occupation')?.value || null,
                    company: document.getElementById('company')?.value || null,
                    education: document.getElementById('education')?.value || null,
                    experience: document.getElementById('experience')?.value || null,
                    interests: formData.advanced?.interests || [],
                    
                    // الإشعارات
                    notifications: {
                        emailNewCourse: document.getElementById('emailNewCourse')?.checked || false,
                        emailReminders: document.getElementById('emailReminders')?.checked || false,
                        emailPromotions: document.getElementById('emailPromotions')?.checked || false,
                        emailNewsletter: document.getElementById('emailNewsletter')?.checked || false,
                        whatsappReminders: document.getElementById('whatsappReminders')?.checked || false,
                        whatsappSupport: document.getElementById('whatsappSupport')?.checked || false,
                        whatsappProgress: document.getElementById('whatsappProgress')?.checked || false
                    },
                    
                    // ملاحظات الإدارة
                    adminNotes: document.getElementById('adminNotesEditor')?.innerHTML || null,
                    
                    // الحقول المخصصة
                    customFields: customFields || []
                };
                
                // البيانات المالية
                formData.financial = {
                    transactions: userTransactions || [],
                    wallet: userWallet || {
                        balance: {
                            total: 0,
                            paid: 0,
                            pending: 0,
                            points: 0
                        },
                        upcomingPayments: []
                    }
                };
                
                console.log('✅ تم جمع بيانات النموذج:', formData);
                
            } catch (error) {
                console.error('❌ خطأ في جمع بيانات النموذج:', error);
                throw error;
            }
            // في نهاية دالة collectFormData
// تحديث معاينة الرسالة
if (document.getElementById('messagePreview')) {
    updateMessagePreview();
}
        }

        // ==================== حفظ المستخدم ====================
       // ==================== حفظ المستخدم ====================
async function saveUser(isDraft = false) {
    try {
        // التحقق من وجود معرف المستخدم
        if (!editMode && !currentUserId) {
            showError('يجب إنشاء معرف المستخدم أولاً');
            document.getElementById('generateSlugSection').scrollIntoView();
            return;
        }
        
        // التحقق من صحة البيانات
        if (!validateBasicInfo()) {
            showError('يرجى التحقق من البيانات الأساسية');
            document.getElementById('basicTab').click();
            return;
        }
        
        showLoading(isDraft ? 'جاري حفظ المسودة...' : 'جاري حفظ البيانات...');
        
        // جمع البيانات
        collectFormData();
        
        // إعداد بيانات المستخدم
        const userData = {
            id: currentUserId,
            name: `${formData.basic.firstName} ${formData.basic.lastName}`.trim(),
            email: formData.basic.email,
            whatsapp: `${formData.basic.countryCode}${formData.basic.phoneNumber}`,
            phone: `${formData.basic.countryCode}${formData.basic.phoneNumber}`,
            avatar: formData.basic.avatar,
            
            isActive: formData.basic.accountStatus === 'active',
            status: formData.basic.accountStatus,
            
            role: formData.roles.primaryRole,
            permissions: formData.roles.permissions,
            customRole: formData.roles.customRole,
            
            enrollments: formData.courses.map(course => ({
                id: course.id,
                type: course.type,
                title: course.title,
                startDate: course.startDate,
                endDate: course.endDate,
                accessType: course.accessType,
                price: course.isFree ? 0 : course.customPrice,
                currency: course.currency,
                isFree: course.isFree,
                notes: course.notes,
                enrolledAt: new Date().toISOString()
            })),
            
            // المعلومات المتقدمة
            birthDate: formData.advanced.birthDate,
            gender: formData.advanced.gender,
            nationality: formData.advanced.nationality,
            country: formData.advanced.country,
            city: formData.advanced.city,
            timezone: formData.advanced.timezone,
            language: formData.advanced.language || 'ar',
            address: formData.advanced.address,
            occupation: formData.advanced.occupation,
            company: formData.advanced.company,
            education: formData.advanced.education,
            experience: formData.advanced.experience,
            interests: formData.advanced.interests || [],
            notifications: formData.advanced.notifications || {},
            adminNotes: formData.advanced.adminNotes,
            customFields: formData.advanced.customFields || [],
            
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastUpdatedBy: currentUser?.email || 'system'
        };
        
        // التحقق من وجود المستخدم
        const userDoc = await db.collection('users').doc(currentUserId).get();
        
        if (userDoc.exists) {
            // تحديث مستخدم موجود
            await db.collection('users').doc(currentUserId).update(userData);
        } else {
            // إنشاء مستخدم جديد
            userData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            userData.createdBy = currentUser.email;
            
            // إنشاء حساب Firebase Auth بالطريقة الصحيحة
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(
                    formData.basic.email,
                    formData.basic.password
                );
                
                userData.authId = userCredential.user.uid;
                
                // تحديث اسم المستخدم
                await userCredential.user.updateProfile({
                    displayName: userData.name
                });
                
                // مهم: تسجيل خروج المستخدم الجديد فوراً
                await auth.signOut();
                
                // إعادة تسجيل دخول الأدمن
                await auth.signInWithEmailAndPassword('admin@fouad-academy.com', 'RahmaMahmoud@2020$');
                
            } catch (authError) {
                console.log('Auth handling:', authError.code);
                
                // لو الخطأ بسبب إن الإيميل موجود، نكمل عادي
                if (authError.code === 'auth/email-already-in-use') {
                    console.log('المستخدم موجود بالفعل - نكمل');
                } 
                // لو مش قادر يسجل دخول الأدمن تاني، مش مشكلة
                else if (authError.code === 'auth/wrong-password' || 
                         authError.code === 'auth/user-not-found') {
                    console.log('فشل إعادة تسجيل دخول الأدمن - تجاهل');
                    // المستخدم اتعمل خلاص، نكمل
                }
                // أي خطأ تاني نرميه
                else if (authError.code !== 'auth/missing-password') {
                    throw authError;
                }
            }
            
            // حفظ في قاعدة البيانات
            await db.collection('users').doc(currentUserId).set(userData);
            
            // حفظ كلمة المرور مؤقتاً
            savePasswordForUser();
        }
        
        // حفظ المعاملات المالية بالهيكل الجديد
        if (userTransactions && userTransactions.length > 0) {
            // تجميع المعاملات حسب الدورة/المسار
            const transactionsByCourse = new Map();
            
            userTransactions.forEach(transaction => {
                if (transaction.relatedTo) {
                    const courseId = transaction.relatedTo.id;
                    if (!transactionsByCourse.has(courseId)) {
                        transactionsByCourse.set(courseId, []);
                    }
                    transactionsByCourse.get(courseId).push(transaction);
                }
            });
            
            // حفظ كل مجموعة معاملات في سجل مالي منفصل
            for (const [courseId, transactions] of transactionsByCourse) {
                const recordRef = db.collection('users').doc(currentUserId)
                    .collection('financialRecords').doc(courseId);
                
                const recordData = {
                    courseId: courseId,
                    courseType: transactions[0].relatedTo.type,
                    courseTitle: transactions[0].relatedTo.title,
                    userId: currentUserId,
                    transactions: transactions,
                    pricing: {
                        originalPrice: transactions[0].originalAmount || transactions[0].amount || 0,
                        finalPrice: transactions.reduce((sum, t) => sum + (t.amount || 0), 0),
                        currency: 'EGP'
                    },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // تحديث الملخص
                updateFinancialRecordSummary(recordData);
                
                await recordRef.set(recordData, { merge: true });
            }
        }
        
        hideLoading();
        
        if (!isDraft) {
            // عرض رسالة النجاح
            await Swal.fire({
                icon: 'success',
                title: editMode ? 'تم حفظ التعديلات' : 'تم إنشاء المستخدم',
                text: editMode ? 'تم تحديث بيانات المستخدم بنجاح' : 'تم إنشاء المستخدم الجديد بنجاح',
                timer: 2000,
                showConfirmButton: false
            });
            
            // إظهار بيانات الدخول للمستخدمين الجدد
            if (!userDoc.exists && formData.basic.password) {
                await showSuccessWithCredentials(
                    formData.basic.email,
                    formData.basic.password,
                    userData.whatsapp
                );
            }
            
            // تحديث حالة الصفحة بدون الانتقال
            if (!editMode) {
                editMode = true;
                currentUserId = currentUserId; // للتأكد
                updatePageForEditMode();
                
                // تحديث معاينة رسالة WhatsApp
                updateMessagePreview();
            }
            
        } else {
            showSuccess('تم حفظ المسودة');
        }
        
    } catch (error) {
        console.error('خطأ في حفظ المستخدم:', error);
        hideLoading();
        showError(error.message || 'حدث خطأ في حفظ البيانات');
    }
}
        // ==================== Quick Save ====================
        async function quickSave() {
            await saveFormData(false);
            showSuccess('تم الحفظ السريع');
        }

        // ==================== Success with Credentials ====================
        async function showSuccessWithCredentials(email, password, whatsapp) {
            const result = await Swal.fire({
                icon: 'success',
                title: 'تم إنشاء المستخدم بنجاح!',
                html: `
                    <div style="text-align: right; direction: rtl;">
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin: 1rem 0;">
                            <h4 style="color: var(--primary); margin-bottom: 1rem;">
                                <i class="fas fa-key"></i> بيانات الدخول
                            </h4>
                            <div style="margin-bottom: 0.8rem;">
                                <strong>البريد الإلكتروني:</strong><br>
                                <code style="background: white; padding: 0.5rem; display: block; margin-top: 0.3rem;">${email}</code>
                            </div>
                            <div>
                                <strong>كلمة المرور:</strong><br>
                                <code style="background: white; padding: 0.5rem; display: block; margin-top: 0.3rem;">${password}</code>
                            </div>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-copy"></i> نسخ البيانات',
                cancelButtonText: '<i class="fab fa-whatsapp"></i> إرسال WhatsApp',
                confirmButtonColor: 'var(--primary)',
                cancelButtonColor: 'var(--success)',
                reverseButtons: true
            });
            
            if (result.isConfirmed) {
                // نسخ البيانات
                const text = `البريد الإلكتروني: ${email}\nكلمة المرور: ${password}`;
                await navigator.clipboard.writeText(text);
                showSuccess('تم نسخ بيانات الدخول');
                
            } else if (result.dismiss === Swal.DismissReason.cancel) {
                // إرسال WhatsApp
                const message = `مرحباً،\n\nتم إنشاء حساب لك في منظور الفؤاد\n\nبيانات الدخول:\n📧 البريد: ${email}\n🔒 كلمة المرور: ${password}\n\n🔗 رابط تسجيل الدخول:\n${window.location.origin}/login.html\n\nمع تحيات فريق منظور الفؤاد`;
                
                const whatsappUrl = `https://wa.me/${whatsapp.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            }
            
            // العودة لصفحة المستخدمين
            setTimeout(() => {
                window.location.href = '/admin/users.html';
            }, 1000);
        }

        // ==================== Form Actions ====================
        function handleCancel() {
            Swal.fire({
                title: 'هل أنت متأكد؟',
                text: 'سيتم فقدان جميع التغييرات غير المحفوظة',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: 'var(--danger)',
                cancelButtonColor: 'var(--secondary)',
                confirmButtonText: 'نعم، إلغاء',
                cancelButtonText: 'لا، البقاء'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/admin/users.html';
                }
            });
        }

        function handleReset() {
            Swal.fire({
                title: 'هل أنت متأكد؟',
                text: 'سيتم إعادة تعيين جميع الحقول',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: 'var(--warning)',
                cancelButtonColor: 'var(--secondary)',
                confirmButtonText: 'نعم، إعادة تعيين',
                cancelButtonText: 'إلغاء'
            }).then((result) => {
                if (result.isConfirmed) {
                    if (editMode) {
                        // إعادة تحميل البيانات الأصلية
                        loadUserData(currentUserId);
                    } else {
                        // مسح النموذج
                        document.querySelector('form').reset();
                        formData = {
                            basic: {},
                            roles: {},
                            courses: [],
                            advanced: {},
                            financial: {}
                        };
                        customFields = [];
                        renderAssignedCourses();
                        updateCounts();
                    }
                    showSuccess('تم إعادة تعيين النموذج');
                }
            });
        }
// ==================== Load Available Content ====================
// ==================== Load Available Content ====================
async function loadAvailableContent() {
    try {
        showLoading('جاري تحميل الدورات والمسارات...');
        
        // تحميل الدورات - بدون شرط isActive إذا مش موجود
        let coursesQuery = db.collection('courses');
        
        // جرب الترتيب بدون order by في البداية
        const coursesSnapshot = await coursesQuery.get();
        
        availableCourses = [];
        coursesSnapshot.docs.forEach(doc => {
            const data = doc.data();
            // تحقق من أن الدورة نشطة (إذا كان الحقل موجود)
            if (data.isActive !== false) { // إذا مش false يبقى نعرضها
                availableCourses.push({
                    id: doc.id,
                    type: 'course',
                    ...data
                });
            }
        });
        
        console.log('تم تحميل الدورات:', availableCourses.length);
        
        // تحميل المسارات من bundles
        let bundlesQuery = db.collection('bundles');
        
        const bundlesSnapshot = await bundlesQuery.get();
        
        availablePaths = [];
        bundlesSnapshot.docs.forEach(doc => {
            const data = doc.data();
            // تحقق من أن المسار نشط
            if (data.isActive !== false) {
                availablePaths.push({
                    id: doc.id,
                    type: 'bundle',
                    ...data
                });
            }
        });
        
        console.log('تم تحميل المسارات:', availablePaths.length);
        
        // حفظ في الكاش
        DataCache.set('courses', 'all', [...availableCourses, ...availablePaths]);
        
        // عرض العناصر
        renderAvailableItems();
        updateCounts();
        
        hideLoading();
        
    } catch (error) {
        console.error('خطأ في تحميل المحتوى - التفاصيل:', error);
        console.error('رسالة الخطأ:', error.message);
        console.error('كود الخطأ:', error.code);
        hideLoading();
        showError('حدث خطأ في تحميل الدورات والمسارات: ' + error.message);
    }
}
        // ==================== Debug Function ====================
async function debugFirebaseCollections() {
    try {
        console.log('🔍 فحص مجموعات Firebase...');
        
        // فحص الدورات
        const coursesTest = await db.collection('courses').limit(1).get();
        console.log('✅ مجموعة courses موجودة:', !coursesTest.empty);
        
        if (!coursesTest.empty) {
            console.log('📋 مثال على دورة:', coursesTest.docs[0].data());
        }
        
        // فحص المسارات
        const bundlesTest = await db.collection('bundles').limit(1).get();
        console.log('✅ مجموعة bundles موجودة:', !bundlesTest.empty);
        
        if (!bundlesTest.empty) {
            console.log('📦 مثال على مسار:', bundlesTest.docs[0].data());
        }
        
        // فحص المستخدمين
        const usersTest = await db.collection('users').limit(1).get();
        console.log('👥 مجموعة users موجودة:', !usersTest.empty);
        
    } catch (error) {
        console.error('❌ خطأ في الفحص:', error);
    }
}

// استدعي الدالة للتحقق
debugFirebaseCollections();

// ==================== Render Available Items ====================
function renderAvailableItems() {
    const container = document.getElementById('availableItems');
    const allItems = [...availableCourses, ...availablePaths];
    
    if (allItems.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>لا توجد دورات أو مسارات متاحة</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = allItems.map(item => createItemElement(item)).join('');
    
    // إضافة الأحداث
    container.querySelectorAll('.add-btn').forEach(btn => {
        btn.addEventListener('click', handleAddCourse);
    });
    
    // تهيئة السحب والإفلات
    initializeDragAndDropForItems();
}

// ==================== Create Item Element ====================
function createItemElement(item) {
    const isAssigned = formData.courses.some(c => c.id === item.id);
    
    return `
        <div class="course-item ${isAssigned ? 'assigned' : ''}" 
             data-id="${item.id}" 
             data-type="${item.type}"
             draggable="true">
            <div class="item-header">
                <div class="item-type-badge ${item.type}">
                    <i class="fas fa-${item.type === 'course' ? 'graduation-cap' : 'route'}"></i>
                    <span>${item.type === 'course' ? 'دورة' : 'مسار'}</span>
                </div>
                <button class="item-action-btn ${isAssigned ? 'remove-btn' : 'add-btn'}">
                    <i class="fas fa-${isAssigned ? 'check' : 'plus'}"></i>
                </button>
            </div>
            
            <div class="item-thumbnail">
                <img src="${item.thumbnail || '/images/course-placeholder.jpg'}" alt="${item.title}">
                <div class="item-price">
                    <span class="price-value">${item.price || 0}</span>
                    <span class="price-currency">جنيه</span>
                </div>
            </div>
            
            <div class="item-content">
                <h4 class="item-title">${item.title || 'بدون عنوان'}</h4>
                <p class="item-instructor">
                    <i class="fas fa-user-tie"></i>
                    <span>${item.instructor || 'غير محدد'}</span>
                </p>
                <div class="item-meta">
                    <span class="meta-item">
                        <i class="fas fa-clock"></i>
                        <span class="duration">${item.duration || '0'} ساعة</span>
                    </span>
                    <span class="meta-item">
                        <i class="fas fa-users"></i>
                        <span class="students-count">${item.enrolledStudents || item.studentsCount || 0}</span>
                    </span>
                </div>
            </div>
        </div>
    `;
}

// ==================== Handle Add Course (مع النظام المالي) ====================
async function handleAddCourse(event) {
    const btn = event.currentTarget;
    const courseItem = btn.closest('.course-item');
    const courseId = courseItem.dataset.id;
    const courseType = courseItem.dataset.type;
    
    // جلب بيانات الدورة
    const course = [...availableCourses, ...availablePaths].find(c => c.id === courseId);
    if (!course) return;
    
    // إظهار نافذة خيارات الدفع
    const paymentOptions = await showPaymentOptionsDialog(course);
    
    if (paymentOptions) {
        // إضافة الدورة مع خيارات الدفع
        assignCourse(course, paymentOptions);
        
        // إنشاء المعاملات المالية
        await createPaymentTransactions(course, paymentOptions);
        
        // تحديث العرض
        renderAvailableItems();
        renderAssignedCourses();
        updateCounts();
        
        showSuccess('تم تخصيص الدورة وإنشاء المعاملات المالية');
    }
}

// ==================== Assign Course ====================
function assignCourse(course, paymentOptions = {}) {
    // التحقق من عدم التكرار
    if (formData.courses.some(c => c.id === course.id)) {
        showWarning('هذه الدورة مخصصة بالفعل');
        return;
    }
    
    // إضافة للدورات المخصصة
    const assignedCourse = {
        id: course.id,
        type: course.type,
        title: course.title,
        price: course.price,
        instructor: course.instructor,
        thumbnail: course.thumbnail,
        
        // خيارات التخصيص
        startDate: paymentOptions.startDate || new Date().toISOString().split('T')[0],
        endDate: paymentOptions.endDate || null,
        accessType: paymentOptions.accessType || 'full',
        
        // البيانات المالية
        isFree: paymentOptions.discount === 100 || paymentOptions.transactionType === 'grant',
        customPrice: paymentOptions.finalPrice || course.price,
        currency: 'EGP',
        discount: paymentOptions.discount || 0,
        paymentType: paymentOptions.paymentType || 'full',
        transactionType: paymentOptions.transactionType || 'payment',
        
        notes: paymentOptions.notes || '',
        assignedAt: new Date().toISOString()
    };
    
    formData.courses.push(assignedCourse);
}

// ==================== Render Assigned Courses ====================
function renderAssignedCourses() {
    const container = document.getElementById('assignedItems');
    
    if (formData.courses.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>لم يتم تخصيص أي دورات بعد</p>
                <span>اختر من القائمة المجاورة</span>
            </div>
        `;
        return;
    }
    
    container.innerHTML = formData.courses.map((course, index) => `
        <div class="assigned-item" data-index="${index}">
            <div class="assigned-item-header">
                <div class="assigned-item-info">
                    <div class="item-type-icon ${course.type}">
                        <i class="fas fa-${course.type === 'course' ? 'graduation-cap' : 'route'}"></i>
                    </div>
                    <div>
                        <h4 class="assigned-item-title">${course.title}</h4>
                        <p class="assigned-item-type">
                            ${course.type === 'course' ? 'دورة تدريبية' : course.type === 'bundle' ? 'مسار تدريبي' : 'محتوى'}
                            ${course.isFree ? '<span class="badge badge-success">مجاني</span>' : ''}
                            ${course.discount > 0 ? `<span class="badge badge-warning">خصم ${course.discount}%</span>` : ''}
                        </p>
                    </div>
                </div>
                <button class="remove-btn" onclick="removeCourse(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="assigned-item-settings">
                <!-- تواريخ الوصول -->
                <div class="setting-group">
                    <label class="setting-label">
                        <i class="fas fa-calendar-alt"></i>
                        فترة الوصول
                    </label>
                    <div class="date-inputs">
                        <input type="date" 
                               class="date-input start-date" 
                               value="${course.startDate}"
                               onchange="updateCourseDate(${index}, 'startDate', this.value)">
                        <span class="date-separator">إلى</span>
                        <input type="date" 
                               class="date-input end-date" 
                               value="${course.endDate || ''}"
                               onchange="updateCourseDate(${index}, 'endDate', this.value)">
                    </div>
                </div>
                
                <!-- نوع الوصول -->
                <div class="setting-group">
                    <label class="setting-label">
                        <i class="fas fa-key"></i>
                        نوع الوصول
                    </label>
                    <select class="setting-select access-type" 
                            value="${course.accessType}"
                            onchange="updateCourseAccess(${index}, this.value)">
                        <option value="full" ${course.accessType === 'full' ? 'selected' : ''}>وصول كامل</option>
                        <option value="limited" ${course.accessType === 'limited' ? 'selected' : ''}>وصول محدود</option>
                        <option value="preview" ${course.accessType === 'preview' ? 'selected' : ''}>معاينة فقط</option>
                    </select>
                </div>
                
                <!-- معلومات السعر -->
                <div class="setting-group">
                    <label class="setting-label">
                        <i class="fas fa-tag"></i>
                        السعر والدفع
                    </label>
                    <div class="price-info">
                        <span>السعر الأصلي: <strong>${course.price} جنيه</strong></span>
                        ${course.discount > 0 ? `<span>الخصم: <strong>${course.discount}%</strong></span>` : ''}
                        <span>السعر النهائي: <strong class="text-success">${course.customPrice} جنيه</strong></span>
                        <span>نوع الدفع: <strong>${getPaymentTypeLabel(course.paymentType)}</strong></span>
                    </div>
                </div>
                
                <!-- ملاحظات -->
                <div class="setting-group">
                    <label class="setting-label">
                        <i class="fas fa-sticky-note"></i>
                        ملاحظات
                    </label>
                    <textarea class="setting-textarea" 
                              rows="2" 
                              placeholder="ملاحظات خاصة بهذا التخصيص..."
                              onchange="updateCourseNotes(${index}, this.value)">${course.notes || ''}</textarea>
                </div>
            </div>
        </div>
    `).join('');
}

// ==================== Update Course Functions ====================
function updateCourseDate(index, field, value) {
    formData.courses[index][field] = value;
    autoSave();
}

function updateCourseAccess(index, value) {
    formData.courses[index].accessType = value;
    autoSave();
}

function updateCourseNotes(index, value) {
    formData.courses[index].notes = value;
    autoSave();
}

function removeCourse(index) {
    const course = formData.courses[index];
    
    Swal.fire({
        title: 'هل أنت متأكد؟',
        text: `سيتم إزالة "${course.title}" من القائمة`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'نعم، احذف',
        cancelButtonText: 'إلغاء',
        confirmButtonColor: '#dc3545'
    }).then((result) => {
        if (result.isConfirmed) {
            formData.courses.splice(index, 1);
            renderAssignedCourses();
            renderAvailableItems();
            updateCounts();
            showSuccess('تم إزالة الدورة');
        }
    });
}

// ==================== Search and Filter Functions ====================
function filterCourses(searchTerm = '') {
    const allItems = [...availableCourses, ...availablePaths];
    const clearBtn = document.getElementById('clearSearch');
    
    if (searchTerm) {
        clearBtn.style.display = 'block';
        const filtered = allItems.filter(item => 
            item.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
            item.instructor?.toLowerCase().includes(searchTerm.toLowerCase())
        );
        renderFilteredItems(filtered);
    } else {
        clearBtn.style.display = 'none';
        renderAvailableItems();
    }
}

function filterByType(type) {
    let filtered = [];
    
    switch (type) {
        case 'all':
            renderAvailableItems();
            return;
        case 'courses':
            filtered = availableCourses;
            break;
        case 'paths':
            filtered = availablePaths;
            break;
        case 'selected':
            const selectedIds = formData.courses.map(c => c.id);
            filtered = [...availableCourses, ...availablePaths].filter(item => 
                selectedIds.includes(item.id)
            );
            break;
    }
    
    renderFilteredItems(filtered);
}

function renderFilteredItems(items) {
    const container = document.getElementById('availableItems');
    
    if (items.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-search"></i>
                <p>لا توجد نتائج</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = items.map(item => createItemElement(item)).join('');
    
    // إضافة الأحداث
    container.querySelectorAll('.add-btn').forEach(btn => {
        btn.addEventListener('click', handleAddCourse);
    });
}

function sortCourses(sortBy) {
    const allItems = [...availableCourses, ...availablePaths];
    
    switch (sortBy) {
        case 'name':
            allItems.sort((a, b) => a.title.localeCompare(b.title, 'ar'));
            break;
        case 'date':
            allItems.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            break;
        case 'price':
            allItems.sort((a, b) => (b.price || 0) - (a.price || 0));
            break;
        case 'students':
            allItems.sort((a, b) => (b.studentsCount || 0) - (a.studentsCount || 0));
            break;
    }
    
    availableCourses = allItems.filter(item => item.type === 'course');
    availablePaths = allItems.filter(item => item.type === 'path');
    
    renderAvailableItems();
}

// ==================== Update Counts ====================
function updateCounts() {
    // تحديث عدادات التصنيفات
    document.getElementById('allCount').textContent = availableCourses.length + availablePaths.length;
    document.getElementById('coursesCount').textContent = availableCourses.length;
    document.getElementById('pathsCount').textContent = availablePaths.length;
    document.getElementById('selectedCount').textContent = formData.courses.length;
    
    // تحديث عدادات الدورات المخصصة
    const assignedCourses = formData.courses.filter(c => c.type === 'course').length;
    const assignedPaths = formData.courses.filter(c => c.type === 'path').length;
    
    document.getElementById('assignedCoursesCount').textContent = assignedCourses;
    document.getElementById('assignedPathsCount').textContent = assignedPaths;
}

// ==================== Drag and Drop Functions ====================
function initializeDragAndDrop() {
    const dropZone = document.getElementById('dropZone');
    const assignedContainer = document.getElementById('assignedItems');
    
    // Drop Zone Events
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });
    
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
    });
    
    dropZone.addEventListener('drop', async (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        
        const courseId = e.dataTransfer.getData('courseId');
        const courseType = e.dataTransfer.getData('courseType');
        
        if (courseId) {
            const course = [...availableCourses, ...availablePaths].find(c => c.id === courseId);
            if (course && !formData.courses.some(c => c.id === courseId)) {
                const paymentOptions = await showPaymentOptionsDialog(course);
                if (paymentOptions) {
                    assignCourse(course, paymentOptions);
                    await createPaymentTransactions(course, paymentOptions);
                    renderAvailableItems();
                    renderAssignedCourses();
                    updateCounts();
                }
            }
        }
    });
    
    // Assigned Container Drop
    assignedContainer.addEventListener('dragover', (e) => {
        e.preventDefault();
        assignedContainer.classList.add('drag-over');
    });
    
    assignedContainer.addEventListener('dragleave', () => {
        assignedContainer.classList.remove('drag-over');
    });
    
    assignedContainer.addEventListener('drop', async (e) => {
        e.preventDefault();
        assignedContainer.classList.remove('drag-over');
        
        const courseId = e.dataTransfer.getData('courseId');
        if (courseId) {
            const course = [...availableCourses, ...availablePaths].find(c => c.id === courseId);
            if (course && !formData.courses.some(c => c.id === courseId)) {
                const paymentOptions = await showPaymentOptionsDialog(course);
                if (paymentOptions) {
                    assignCourse(course, paymentOptions);
                    await createPaymentTransactions(course, paymentOptions);
                    renderAvailableItems();
                    renderAssignedCourses();
                    updateCounts();
                }
            }
        }
    });
}

function initializeDragAndDropForItems() {
    const items = document.querySelectorAll('.course-item[draggable="true"]');
    
    items.forEach(item => {
        item.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('courseId', item.dataset.id);
            e.dataTransfer.setData('courseType', item.dataset.type);
            item.classList.add('dragging');
        });
        
        item.addEventListener('dragend', () => {
            item.classList.remove('dragging');
        });
    });
}

// ==================== Bulk Actions ====================
async function assignAllVisible() {
    const visibleItems = document.querySelectorAll('.course-item:not(.assigned)');
    const items = [];
    
    visibleItems.forEach(item => {
        const courseId = item.dataset.id;
        const course = [...availableCourses, ...availablePaths].find(c => c.id === courseId);
        if (course) items.push(course);
    });
    
    if (items.length === 0) {
        showWarning('لا توجد دورات لإضافتها');
        return;
    }
    
    const result = await Swal.fire({
        title: 'إضافة جميع الدورات المرئية',
        text: `سيتم إضافة ${items.length} دورة/مسار. هل تريد المتابعة؟`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'نعم، أضف الكل',
        cancelButtonText: 'إلغاء'
    });
    
    if (result.isConfirmed) {
        showLoading('جاري إضافة الدورات...');
        
        for (const course of items) {
            const paymentOptions = {
                paymentType: 'full',
                discount: 0,
                finalPrice: course.price,
                paymentMethod: 'pending',
                transactionType: 'payment'
            };
            
            assignCourse(course, paymentOptions);
            await createPaymentTransactions(course, paymentOptions);
        }
        
        renderAvailableItems();
        renderAssignedCourses();
        updateCounts();
        hideLoading();
        showSuccess(`تم إضافة ${items.length} دورة/مسار`);
    }
}

async function removeAllAssigned() {
    if (formData.courses.length === 0) {
        showWarning('لا توجد دورات مخصصة');
        return;
    }
    
    const result = await Swal.fire({
        title: 'إزالة جميع الدورات',
        text: 'سيتم إزالة جميع الدورات المخصصة. هل أنت متأكد؟',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'نعم، احذف الكل',
        cancelButtonText: 'إلغاء',
        confirmButtonColor: '#dc3545'
    });
    
    if (result.isConfirmed) {
        formData.courses = [];
        renderAssignedCourses();
        renderAvailableItems();
        updateCounts();
        showSuccess('تم إزالة جميع الدورات');
    }
}

async function applyBulkSettings() {
    if (formData.courses.length === 0) {
        showWarning('لا توجد دورات مخصصة');
        return;
    }
    
    document.getElementById('bulkSettingsModal').style.display = 'block';
}

function applyBulkSettingsConfirm() {
    const duration = parseInt(document.getElementById('bulkDuration').value);
    const durationUnit = document.getElementById('bulkDurationUnit').value;
    const accessType = document.getElementById('bulkAccessType').value;
    const discount = parseFloat(document.getElementById('bulkDiscount').value) || 0;
    
    // حساب تاريخ النهاية
    const endDate = new Date();
    switch (durationUnit) {
        case 'days':
            endDate.setDate(endDate.getDate() + duration);
            break;
        case 'weeks':
            endDate.setDate(endDate.getDate() + (duration * 7));
            break;
        case 'months':
            endDate.setMonth(endDate.getMonth() + duration);
            break;
        case 'years':
            endDate.setFullYear(endDate.getFullYear() + duration);
            break;
    }
    
    // تطبيق الإعدادات على جميع الدورات
    formData.courses.forEach(course => {
        course.endDate = endDate.toISOString().split('T')[0];
        course.accessType = accessType;
        
        if (discount > 0) {
            course.discount = discount;
            course.customPrice = course.price * (1 - discount / 100);
        }
    });
    
    renderAssignedCourses();
    closeBulkSettings();
    showSuccess('تم تطبيق الإعدادات على جميع الدورات');
}

// ==================== Helper Functions ====================
function getPaymentTypeLabel(type) {
    const labels = {
        full: 'دفعة كاملة',
        installments: 'أقساط',
        partial: 'دفعة جزئية',
        grant: 'منحة',
        none: 'مجاني'
    };
    return labels[type] || type;
}
        // ==================== Initialize Notes Editor ====================
function initializeNotesEditor() {
    const editor = document.getElementById('adminNotesEditor');
    if (editor) {
        // إضافة placeholder
        editor.setAttribute('contenteditable', 'true');
        
        // معالجة الأحداث
        editor.addEventListener('input', () => {
            autoSave();
        });
        
        editor.addEventListener('paste', (e) => {
            e.preventDefault();
            const text = e.clipboardData.getData('text/plain');
            document.execCommand('insertText', false, text);
        });
    }
}

// ==================== Format Text in Editor ====================
function formatText(command, value = null) {
    document.execCommand(command, false, value);
    document.getElementById('adminNotesEditor').focus();
}

function insertLink() {
    const url = prompt('أدخل رابط URL:');
    if (url) {
        formatText('createLink', url);
    }
}

function insertHighlight() {
    formatText('backColor', '#ffff00');
}

// ==================== Load Countries ====================
async function loadCountries() {
    const countrySelect = document.getElementById('country');
    if (!countrySelect) return;
    
    const countries = [
        { code: 'EG', name: 'مصر' },
        { code: 'SA', name: 'السعودية' },
        { code: 'AE', name: 'الإمارات' },
        { code: 'KW', name: 'الكويت' },
        { code: 'QA', name: 'قطر' },
        { code: 'OM', name: 'عمان' },
        { code: 'BH', name: 'البحرين' },
        { code: 'JO', name: 'الأردن' },
        { code: 'LB', name: 'لبنان' },
        { code: 'PS', name: 'فلسطين' },
        { code: 'SY', name: 'سوريا' },
        { code: 'IQ', name: 'العراق' },
        { code: 'MA', name: 'المغرب' },
        { code: 'DZ', name: 'الجزائر' },
        { code: 'TN', name: 'تونس' },
        { code: 'LY', name: 'ليبيا' },
        { code: 'SD', name: 'السودان' },
        { code: 'YE', name: 'اليمن' }
    ];
    
    countrySelect.innerHTML = '<option value="">-- اختر الدولة --</option>';
    countries.forEach(country => {
        const option = document.createElement('option');
        option.value = country.code;
        option.textContent = country.name;
        countrySelect.appendChild(option);
    });
}

// ==================== Interest Tags Management ====================
function addInterestTag(interest) {
    if (!interest || formData.advanced.interests.includes(interest)) {
        return;
    }
    
    formData.advanced.interests.push(interest);
    renderInterestTags();
    autoSave();
}

function removeInterestTag(index) {
    formData.advanced.interests.splice(index, 1);
    renderInterestTags();
    autoSave();
}

function renderInterestTags() {
    const container = document.getElementById('interestsTags');
    if (!container) return;
    
    container.innerHTML = formData.advanced.interests.map((interest, index) => `
        <div class="tag-item">
            <span>${interest}</span>
            <button type="button" onclick="removeInterestTag(${index})">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
}

// ==================== Custom Fields Management ====================
function addCustomField() {
    document.getElementById('customFieldModal').style.display = 'block';
}

function saveCustomField() {
    const label = document.getElementById('fieldLabel').value.trim();
    const type = document.getElementById('fieldType').value;
    const required = document.getElementById('fieldRequired').checked;
    const options = type === 'select' ? 
        document.getElementById('fieldOptions').value.split('\n').filter(o => o.trim()) : null;
    
    if (!label) {
        showError('يجب إدخال اسم الحقل');
        return;
    }
    
    const field = {
        id: 'field_' + Date.now(),
        label,
        type,
        required,
        options,
        value: ''
    };
    
    customFields.push(field);
    addCustomFieldToForm(field);
    closeCustomFieldModal();
    showSuccess('تم إضافة الحقل');
}

function addCustomFieldToForm(field) {
    const container = document.getElementById('customFieldsContainer');
    const emptyState = document.getElementById('emptyCustomFields');
    
    if (customFields.length > 0) {
        emptyState.style.display = 'none';
    }
    
    const fieldElement = document.createElement('div');
    fieldElement.className = 'custom-field-item';
    fieldElement.dataset.fieldId = field.id;
    
    fieldElement.innerHTML = `
        <div class="custom-field-icon">
            <i class="fas fa-${getFieldIcon(field.type)}"></i>
        </div>
        <div class="custom-field-content">
            <div class="custom-field-label">${field.label}</div>
            <div class="custom-field-type">${getFieldTypeLabel(field.type)}</div>
        </div>
        <button class="custom-field-remove" onclick="removeCustomField('${field.id}')">
            <i class="fas fa-trash"></i>
        </button>
    `;
    
    container.appendChild(fieldElement);
}

function removeCustomField(fieldId) {
    customFields = customFields.filter(f => f.id !== fieldId);
    
    const element = document.querySelector(`[data-field-id="${fieldId}"]`);
    if (element) element.remove();
    
    if (customFields.length === 0) {
        document.getElementById('emptyCustomFields').style.display = 'block';
    }
    
    showSuccess('تم حذف الحقل');
}

function getFieldIcon(type) {
    const icons = {
        text: 'font',
        number: 'hashtag',
        email: 'envelope',
        date: 'calendar',
        select: 'list',
        textarea: 'align-left',
        checkbox: 'check-square'
    };
    return icons[type] || 'font';
}

function getFieldTypeLabel(type) {
    const labels = {
        text: 'نص',
        number: 'رقم',
        email: 'بريد إلكتروني',
        date: 'تاريخ',
        select: 'قائمة منسدلة',
        textarea: 'نص طويل',
        checkbox: 'مربع اختيار'
    };
    return labels[type] || type;
}

// ==================== Permission Management ====================
function updatePermissionsForRole(role) {
    const permissions = {
        student: ['view_courses'],
        assistant: ['view_courses', 'download_materials', 'post_discussions', 'comment_discussions'],
        'group-leader': ['view_courses', 'download_materials', 'manage_groups', 'view_reports'],
        analyst: ['view_analytics', 'view_reports', 'view_progress_reports', 'export_data']
    };
    
    // إلغاء تحديد جميع الصلاحيات
    document.querySelectorAll('input[name="permissions"]').forEach(cb => {
        cb.checked = false;
    });
    
    // تحديد الصلاحيات حسب الدور
    if (permissions[role]) {
        permissions[role].forEach(perm => {
            const checkbox = document.querySelector(`input[name="permissions"][value="${perm}"]`);
            if (checkbox) checkbox.checked = true;
        });
    }
    
    updatePermissionsCounts();
    updatePermissionsPreview();
}

function updatePermissionsCounts() {
    const categories = ['content', 'communication', 'admin', 'analytics'];
    
    categories.forEach(category => {
        const permissions = document.querySelectorAll(`#${category}Permissions input[type="checkbox"]`);
        const checked = document.querySelectorAll(`#${category}Permissions input[type="checkbox"]:checked`);
        document.getElementById(`${category}Count`).textContent = `${checked.length}/${permissions.length}`;
    });
    
    // تحديث الإحصائيات العامة
    const allPermissions = document.querySelectorAll('input[name="permissions"]');
    const checkedPermissions = document.querySelectorAll('input[name="permissions"]:checked');
    
    document.getElementById('activePermissionsCount').textContent = checkedPermissions.length;
    document.getElementById('inactivePermissionsCount').textContent = allPermissions.length - checkedPermissions.length;
    
    updatePermissionsPreview();
}

function updatePermissionsPreview() {
    const checkedPermissions = document.querySelectorAll('input[name="permissions"]:checked');
    const summaryList = document.getElementById('permissionsSummary');
    const previewRole = document.getElementById('previewRoleName');
    
    // تحديث اسم الدور
    const selectedRole = document.querySelector('input[name="primaryRole"]:checked');
    if (selectedRole) {
        const roleLabel = selectedRole.parentElement.querySelector('.role-name').textContent;
        previewRole.textContent = roleLabel;
    }
    
    // تحديث قائمة الصلاحيات
    if (checkedPermissions.length === 0) {
        summaryList.innerHTML = '<li>لا توجد صلاحيات محددة</li>';
    } else {
        summaryList.innerHTML = Array.from(checkedPermissions).map(cb => {
            const label = cb.parentElement.querySelector('.permission-name').textContent;
            return `<li>${label}</li>`;
        }).join('');
    }
}

function toggleCategory(category) {
    const permissions = document.getElementById(category + 'Permissions');
    const toggle = permissions.previousElementSibling.querySelector('.category-toggle');
    
    permissions.classList.toggle('collapsed');
    
    if (permissions.classList.contains('collapsed')) {
        toggle.classList.remove('fa-chevron-down');
        toggle.classList.add('fa-chevron-right');
    } else {
        toggle.classList.remove('fa-chevron-right');
        toggle.classList.add('fa-chevron-down');
    }
}

function selectAllPermissions() {
    document.querySelectorAll('input[name="permissions"]').forEach(cb => {
        cb.checked = true;
    });
    updatePermissionsCounts();
}

function deselectAllPermissions() {
    document.querySelectorAll('input[name="permissions"]').forEach(cb => {
        cb.checked = false;
    });
    updatePermissionsCounts();
}

// ==================== Activity Timeline ====================
function loadMoreActivity() {
    showLoading('جاري تحميل المزيد من النشاطات...');
    
    // هنا يمكن إضافة كود لتحميل المزيد من النشاطات من Firebase
    
    setTimeout(() => {
        hideLoading();
        showWarning('لا توجد نشاطات إضافية');
    }, 1000);
}

        // ==================== Auto Save Functions ====================
        function autoSave() {
            clearTimeout(autoSaveTimer);
            
            autoSaveTimer = setTimeout(async () => {
                try {
                    await saveFormData(true);
                    showAutoSaveIndicator();
                } catch (error) {
                    console.error('خطأ في الحفظ التلقائي:', error);
                }
            }, 2000);
        }

        function showAutoSaveIndicator() {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.classList.add('show');
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 3000);
        }

        async function saveFormData(isDraft = false) {
            // جمع جميع البيانات
            collectFormData();
            
            // حفظ في localStorage
            localStorage.setItem('userBuilderDraft', JSON.stringify({
                formData,
                customFields,
                savedAt: new Date().toISOString()
            }));
            
            if (!isDraft) {
                console.log('حفظ البيانات...', formData);
            }
        }


        // ==================== Initialize on Load ====================
        // تحميل المسودة إذا كانت موجودة
        window.addEventListener('load', function() {
            const draft = localStorage.getItem('userBuilderDraft');
            if (draft && !editMode) {
                const draftData = JSON.parse(draft);
                const savedDate = new Date(draftData.savedAt);
                const timeDiff = (new Date() - savedDate) / 1000 / 60; // بالدقائق
                
                if (timeDiff < 60) { // أقل من ساعة
                    Swal.fire({
                        title: 'توجد مسودة محفوظة',
                        text: `تم حفظ مسودة منذ ${Math.round(timeDiff)} دقيقة. هل تريد استكمالها؟`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'نعم، استكمال',
                        cancelButtonText: 'لا، بداية جديدة',
                        confirmButtonColor: 'var(--primary)'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            formData = draftData.formData;
                            customFields = draftData.customFields || [];
                            showSuccess('تم تحميل المسودة');
                        } else {
                            localStorage.removeItem('userBuilderDraft');
                        }
                    });
                }
            }
        });

        // Cleanup on page leave
        window.addEventListener('beforeunload', function(e) {
            if (formData.basic.firstName || formData.basic.email) {
                e.preventDefault();
                e.returnValue = 'لديك تغييرات غير محفوظة. هل أنت متأكد من مغادرة الصفحة؟';
            }
        });

        // ==================== Export Functions ====================
        window.UserBuilder = {
            showLoading,
            hideLoading,
            showSuccess,
            showError,
            showWarning,
            validateBasicInfo,
            generatePassword,
            togglePassword,
            displayAvatar,
            removeAvatar,
            formatDate,
            debounce
        };

        console.log('✅ تم تحميل جميع الوظائف بنجاح');
    </script>
</body>
</html>
