<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="إنشاء وإدارة المستخدمين - منظور الفؤاد">
    <meta name="keywords" content="إدارة المستخدمين, منظور الفؤاد, لوحة التحكم">
    <meta name="author" content="منظور الفؤاد">
    
    <title>إنشاء مستخدم جديد - منظور الفؤاد</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/MahmoudFouad25/fouad-perspective/main/media/images/favicon.png">
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts - Noto Kufi Arabic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 للتنبيهات الجميلة -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Sortable.js للسحب والإفلات -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <!-- Chart.js للرسوم البيانية -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom CSS -->
    <style>
        /* ==================== متغيرات CSS الأساسية ==================== */
        :root {
            /* الألوان الأساسية */
            --primary: #f4c430;
            --primary-dark: #e6b429;
            --primary-light: #ffd54f;
            --primary-rgb: 244, 196, 48;
            
            --secondary: #2196f3;
            --secondary-dark: #1976d2;
            --secondary-light: #64b5f6;
            --secondary-rgb: 33, 150, 243;
            
            /* ألوان الحالات */
            --success: #4caf50;
            --success-dark: #388e3c;
            --success-light: #81c784;
            
            --danger: #f44336;
            --danger-dark: #d32f2f;
            --danger-light: #ef5350;
            
            --warning: #ff9800;
            --warning-dark: #f57c00;
            --warning-light: #ffb74d;
            
            --info: #00bcd4;
            --info-dark: #0097a7;
            --info-light: #4dd0e1;
            
            /* ألوان الخلفيات */
            --dark: #1a1a1a;
            --darker: #0f0f0f;
            --light: #2a2a2a;
            --lighter: #3a3a3a;
            --lightest: #4a4a4a;
            
            /* ألوان النصوص */
            --text: #e0e0e0;
            --text-muted: #999;
            --text-light: #bbb;
            --text-dark: #666;
            
            /* ألوان إضافية */
            --border: rgba(255, 255, 255, 0.1);
            --border-light: rgba(255, 255, 255, 0.2);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            --shadow-sm: 0 2px 10px rgba(0, 0, 0, 0.3);
            
            /* القياسات */
            --radius: 12px;
            --radius-sm: 8px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            
            /* الحركات */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s ease-in-out;
            --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* أحجام الخطوط */
            --font-xs: 0.75rem;
            --font-sm: 0.875rem;
            --font-base: 1rem;
            --font-lg: 1.125rem;
            --font-xl: 1.25rem;
            --font-2xl: 1.5rem;
            --font-3xl: 1.875rem;
            --font-4xl: 2.25rem;
            
            /* المسافات */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            --spacing-3xl: 4rem;
            
            /* Z-Index */
            --z-dropdown: 1000;
            --z-sticky: 1020;
            --z-fixed: 1030;
            --z-modal-backdrop: 1040;
            --z-modal: 1050;
            --z-popover: 1060;
            --z-tooltip: 1070;
        }
        
        /* ==================== الأنماط العامة ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Kufi Arabic', sans-serif;
            background: var(--darker);
            color: var(--text);
            line-height: 1.6;
            font-size: var(--font-base);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        /* تحسين مظهر التحديد */
        ::selection {
            background: var(--primary);
            color: var(--dark);
        }
        
        /* Scrollbar مخصص */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--dark);
            border-radius: var(--radius-sm);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--lighter);
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        /* Firefox Scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--lighter) var(--dark);
        }
        
        /* ==================== أنماط العناصر الأساسية ==================== */
        
        /* الروابط */
        a {
            color: var(--primary);
            text-decoration: none;
            transition: var(--transition);
        }
        
        a:hover {
            color: var(--primary-light);
        }
        
        /* العناوين */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            line-height: 1.3;
            margin-bottom: var(--spacing-md);
        }
        
        h1 { font-size: var(--font-4xl); }
        h2 { font-size: var(--font-3xl); }
        h3 { font-size: var(--font-2xl); }
        h4 { font-size: var(--font-xl); }
        h5 { font-size: var(--font-lg); }
        h6 { font-size: var(--font-base); }
        
        /* الفقرات */
        p {
            margin-bottom: var(--spacing-md);
        }
        
        /* القوائم */
        ul, ol {
            margin-bottom: var(--spacing-md);
            padding-right: var(--spacing-xl);
        }
        
        /* التركيز على العناصر */
        :focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        /* إخفاء outline للماوس، إظهاره للكيبورد */
        :focus:not(:focus-visible) {
            outline: none;
        }
        
        /* ==================== فئات المساعدة ==================== */
        
        /* إخفاء العناصر */
        .hidden { display: none !important; }
        .invisible { visibility: hidden !important; }
        
        /* المحاذاة */
        .text-center { text-align: center !important; }
        .text-right { text-align: right !important; }
        .text-left { text-align: left !important; }
        
        /* الألوان */
        .text-primary { color: var(--primary) !important; }
        .text-secondary { color: var(--secondary) !important; }
        .text-success { color: var(--success) !important; }
        .text-danger { color: var(--danger) !important; }
        .text-warning { color: var(--warning) !important; }
        .text-info { color: var(--info) !important; }
        .text-muted { color: var(--text-muted) !important; }
        
        /* الخلفيات */
        .bg-primary { background-color: var(--primary) !important; }
        .bg-secondary { background-color: var(--secondary) !important; }
        .bg-success { background-color: var(--success) !important; }
        .bg-danger { background-color: var(--danger) !important; }
        .bg-warning { background-color: var(--warning) !important; }
        .bg-info { background-color: var(--info) !important; }
        .bg-dark { background-color: var(--dark) !important; }
        .bg-light { background-color: var(--light) !important; }
        
        /* المسافات */
        .mt-0 { margin-top: 0 !important; }
        .mt-1 { margin-top: var(--spacing-xs) !important; }
        .mt-2 { margin-top: var(--spacing-sm) !important; }
        .mt-3 { margin-top: var(--spacing-md) !important; }
        .mt-4 { margin-top: var(--spacing-lg) !important; }
        .mt-5 { margin-top: var(--spacing-xl) !important; }
        
        .mb-0 { margin-bottom: 0 !important; }
        .mb-1 { margin-bottom: var(--spacing-xs) !important; }
        .mb-2 { margin-bottom: var(--spacing-sm) !important; }
        .mb-3 { margin-bottom: var(--spacing-md) !important; }
        .mb-4 { margin-bottom: var(--spacing-lg) !important; }
        .mb-5 { margin-bottom: var(--spacing-xl) !important; }
        
        .p-0 { padding: 0 !important; }
        .p-1 { padding: var(--spacing-xs) !important; }
        .p-2 { padding: var(--spacing-sm) !important; }
        .p-3 { padding: var(--spacing-md) !important; }
        .p-4 { padding: var(--spacing-lg) !important; }
        .p-5 { padding: var(--spacing-xl) !important; }
        
        /* الظلال */
        .shadow { box-shadow: var(--shadow) !important; }
        .shadow-sm { box-shadow: var(--shadow-sm) !important; }
        .shadow-none { box-shadow: none !important; }
        
        /* الحدود */
        .border { border: 1px solid var(--border) !important; }
        .border-0 { border: 0 !important; }
        .rounded { border-radius: var(--radius) !important; }
        .rounded-sm { border-radius: var(--radius-sm) !important; }
        .rounded-lg { border-radius: var(--radius-lg) !important; }
        .rounded-xl { border-radius: var(--radius-xl) !important; }
        .rounded-circle { border-radius: 50% !important; }
        
        /* Flexbox */
        .d-flex { display: flex !important; }
        .flex-column { flex-direction: column !important; }
        .flex-row { flex-direction: row !important; }
        .justify-content-center { justify-content: center !important; }
        .justify-content-between { justify-content: space-between !important; }
        .justify-content-around { justify-content: space-around !important; }
        .align-items-center { align-items: center !important; }
        .align-items-start { align-items: flex-start !important; }
        .align-items-end { align-items: flex-end !important; }
        .flex-wrap { flex-wrap: wrap !important; }
        .flex-1 { flex: 1 !important; }
        .gap-1 { gap: var(--spacing-xs) !important; }
        .gap-2 { gap: var(--spacing-sm) !important; }
        .gap-3 { gap: var(--spacing-md) !important; }
        .gap-4 { gap: var(--spacing-lg) !important; }
        .gap-5 { gap: var(--spacing-xl) !important; }
        
        /* Grid */
        .d-grid { display: grid !important; }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr) !important; }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr) !important; }
        .grid-cols-4 { grid-template-columns: repeat(4, 1fr) !important; }
        
        /* العرض */
        .w-100 { width: 100% !important; }
        .w-auto { width: auto !important; }
        .h-100 { height: 100% !important; }
        .h-auto { height: auto !important; }
        
        /* الموضع */
        .position-relative { position: relative !important; }
        .position-absolute { position: absolute !important; }
        .position-fixed { position: fixed !important; }
        .position-sticky { position: sticky !important; }
        
        /* ==================== Animations ==================== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .animate-fadeIn { animation: fadeIn 0.3s ease-in-out; }
        .animate-slideIn { animation: slideIn 0.3s ease-in-out; }
        .animate-pulse { animation: pulse 2s infinite; }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- ==================== Loading Overlay ==================== -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <h3 class="loading-text">جاري التحميل...</h3>
            <p class="loading-subtext">يرجى الانتظار</p>
        </div>
    </div>

    <!-- ==================== Auto Save Indicator ==================== -->
    <div class="auto-save-indicator" id="autoSaveIndicator">
        <i class="fas fa-check-circle"></i>
        <span>تم الحفظ تلقائياً</span>
    </div>

    <!-- ==================== Header ==================== -->
    <header class="main-header">
        <div class="header-container">
            <!-- القسم الأيسر -->
            <div class="header-left">
                <button class="menu-toggle" id="menuToggle" aria-label="فتح القائمة">
                    <i class="fas fa-bars"></i>
                </button>
                <a href="/admin/dashboard.html" class="header-logo">
                    <img src="https://raw.githubusercontent.com/MahmoudFouad25/fouad-perspective/main/media/images/logo.png" alt="منظور الفؤاد">
                    <span class="logo-text">منظور الفؤاد</span>
                </a>
            </div>

            <!-- القسم الأوسط -->
            <div class="header-center">
                <nav class="breadcrumb" aria-label="التنقل">
                    <ol class="breadcrumb-list">
                        <li class="breadcrumb-item">
                            <a href="/admin/dashboard.html">
                                <i class="fas fa-home"></i>
                                الرئيسية
                            </a>
                        </li>
                        <li class="breadcrumb-separator">
                            <i class="fas fa-chevron-left"></i>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="/admin/users.html">
                                <i class="fas fa-users"></i>
                                المستخدمون
                            </a>
                        </li>
                        <li class="breadcrumb-separator">
                            <i class="fas fa-chevron-left"></i>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">
                            <i class="fas fa-user-plus"></i>
                            <span id="pageMode">إنشاء مستخدم جديد</span>
                        </li>
                    </ol>
                </nav>
            </div>

            <!-- القسم الأيمن -->
            <div class="header-right">
                <button class="icon-btn" id="themeToggle" aria-label="تبديل الوضع">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="icon-btn" id="notificationBtn" aria-label="الإشعارات">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </button>
                <div class="user-menu">
                    <button class="user-menu-toggle" id="userMenuToggle">
                        <img src="https://raw.githubusercontent.com/MahmoudFouad25/fouad-perspective/main/media/avatars/admin.jpg" alt="Admin" class="user-avatar">
                        <span class="user-name">الأدمن</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- ==================== Main Container ==================== -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="/admin/dashboard.html" class="nav-link">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>لوحة التحكم</span>
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a href="/admin/users.html" class="nav-link">
                            <i class="fas fa-users"></i>
                            <span>المستخدمون</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/courses.html" class="nav-link">
                            <i class="fas fa-graduation-cap"></i>
                            <span>الدورات</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/groups.html" class="nav-link">
                            <i class="fas fa-users-cog"></i>
                            <span>المجموعات</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/reports.html" class="nav-link">
                            <i class="fas fa-chart-bar"></i>
                            <span>التقارير</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/settings.html" class="nav-link">
                            <i class="fas fa-cog"></i>
                            <span>الإعدادات</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-header-content">
                    <div class="page-header-left">
                        <h1 class="page-title">
                            <i class="fas fa-user-plus"></i>
                            <span id="pageTitleText">إنشاء مستخدم جديد</span>
                        </h1>
                        <p class="page-subtitle">أضف مستخدم جديد للمنصة وحدد صلاحياته والدورات المتاحة له</p>
                    </div>
                    <div class="page-header-right">
                        <button class="btn btn-secondary" onclick="window.history.back()">
                            <i class="fas fa-arrow-right"></i>
                            رجوع
                        </button>
                        <button class="btn btn-primary" id="quickSaveBtn">
                            <i class="fas fa-save"></i>
                            حفظ سريع
                        </button>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 25%"></div>
                </div>
                <div class="progress-steps">
                    <div class="progress-step active" data-step="1">
                        <div class="step-circle">1</div>
                        <span class="step-label">البيانات الأساسية</span>
                    </div>
                    <div class="progress-step" data-step="2">
                        <div class="step-circle">2</div>
                        <span class="step-label">الأدوار والصلاحيات</span>
                    </div>
                    <div class="progress-step" data-step="3">
                        <div class="step-circle">3</div>
                        <span class="step-label">الدورات والمسارات</span>
                    </div>
                    <div class="progress-step" data-step="4">
                        <div class="step-circle">4</div>
                        <span class="step-label">معلومات إضافية</span>
                    </div>
                </div>
            </div>

            <!-- Tabs Container -->
            <div class="tabs-container">
                <!-- Tab Navigation -->
                <nav class="tabs-nav">
                    <ul class="tabs-list" role="tablist">
                        <li class="tab-item" role="presentation">
                            <button class="tab-link active" id="basicTab" data-tab="basic" role="tab" aria-selected="true" aria-controls="basicPanel">
                                <i class="fas fa-user"></i>
                                <span>البيانات الأساسية</span>
                            </button>
                        </li>
                        <li class="tab-item" role="presentation">
                            <button class="tab-link" id="rolesTab" data-tab="roles" role="tab" aria-selected="false" aria-controls="rolesPanel">
                                <i class="fas fa-user-shield"></i>
                                <span>الأدوار والصلاحيات</span>
                            </button>
                        </li>
                        <li class="tab-item" role="presentation">
                            <button class="tab-link" id="coursesTab" data-tab="courses" role="tab" aria-selected="false" aria-controls="coursesPanel">
                                <i class="fas fa-book"></i>
                                <span>الدورات والمسارات</span>
                            </button>
                        </li>
                        <li class="tab-item" role="presentation">
                            <button class="tab-link" id="advancedTab" data-tab="advanced" role="tab" aria-selected="false" aria-controls="advancedPanel">
                                <i class="fas fa-cogs"></i>
                                <span>معلومات إضافية</span>
                            </button>
                        </li>
                    </ul>
                </nav>

                <!-- Tab Panels Container -->
                <div class="tab-panels">
                    <!-- سيتم إضافة محتوى التبويبات في الأجزاء التالية -->
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <div class="actions-left">
                    <button class="btn btn-outline" id="cancelBtn">
                        <i class="fas fa-times"></i>
                        إلغاء
                    </button>
                    <button class="btn btn-outline" id="resetBtn">
                        <i class="fas fa-redo"></i>
                        إعادة تعيين
                    </button>
                </div>
                <div class="actions-right">
                    <button class="btn btn-secondary" id="saveDraftBtn">
                        <i class="fas fa-file-alt"></i>
                        حفظ كمسودة
                    </button>
                    <button class="btn btn-primary" id="saveBtn">
                        <i class="fas fa-check"></i>
                        <span id="saveBtnText">إنشاء المستخدم</span>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- ==================== Additional CSS for Structure ==================== -->
    <style>
        /* ==================== Loading Overlay ==================== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            margin: 0 auto var(--spacing-lg);
            position: relative;
        }

        .spinner-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 3px solid transparent;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
        }

        .spinner-ring:nth-child(2) {
            width: 60px;
            height: 60px;
            top: 10px;
            left: 10px;
            border-top-color: var(--secondary);
            animation-duration: 1s;
        }

        .spinner-ring:nth-child(3) {
            width: 40px;
            height: 40px;
            top: 20px;
            left: 20px;
            border-top-color: var(--success);
            animation-duration: 0.5s;
        }

        .loading-text {
            color: var(--primary);
            margin-bottom: var(--spacing-sm);
        }

        .loading-subtext {
            color: var(--text-muted);
            font-size: var(--font-sm);
        }

        /* ==================== Auto Save Indicator ==================== */
        .auto-save-indicator {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--success);
            color: white;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow);
            transition: var(--transition);
            z-index: var(--z-fixed);
        }

        .auto-save-indicator.show {
            transform: translateX(-50%) translateY(0);
        }

        /* ==================== Header ==================== */
        .main-header {
            background: var(--dark);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
            box-shadow: var(--shadow-sm);
        }

        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md) var(--spacing-xl);
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-left,
        .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .menu-toggle {
            background: none;
            border: none;
            color: var(--text);
            font-size: var(--font-xl);
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .menu-toggle:hover {
            background: var(--lighter);
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .header-logo img {
            height: 40px;
            width: auto;
        }

        .logo-text {
            font-size: var(--font-xl);
            font-weight: 600;
            color: var(--primary);
        }

        /* ==================== Breadcrumb ==================== */
        .breadcrumb {
            flex: 1;
        }

        .breadcrumb-list {
            display: flex;
            align-items: center;
            list-style: none;
            padding: 0;
            margin: 0;
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
        }

        .breadcrumb-item a {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            color: var(--text-muted);
            transition: var(--transition);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
        }

        .breadcrumb-item a:hover {
            color: var(--primary);
            background: rgba(var(--primary-rgb), 0.1);
        }

        .breadcrumb-item.active {
            color: var(--text);
            font-weight: 500;
        }

        .breadcrumb-separator {
            color: var(--text-dark);
            margin: 0 var(--spacing-xs);
            font-size: var(--font-sm);
        }

        /* ==================== Header Icons ==================== */
        .icon-btn {
            background: none;
            border: none;
            color: var(--text);
            font-size: var(--font-lg);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .icon-btn:hover {
            background: var(--lighter);
            color: var(--primary);
        }

        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--danger);
            color: white;
            font-size: var(--font-xs);
            padding: 2px 6px;
            border-radius: var(--radius-xl);
            font-weight: 600;
        }

        /* ==================== User Menu ==================== */
        .user-menu-toggle {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: var(--lighter);
            border: none;
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: var(--transition);
        }

        .user-menu-toggle:hover {
            background: rgba(var(--primary-rgb), 0.1);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-name {
            color: var(--text);
            font-weight: 500;
        }

        /* ==================== Main Container ==================== */
        .main-container {
            display: flex;
            min-height: calc(100vh - 65px);
        }

        /* ==================== Sidebar ==================== */
        .sidebar {
            width: 260px;
            background: var(--dark);
            border-left: 1px solid var(--border);
            overflow-y: auto;
            transition: var(--transition);
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .nav-list {
            list-style: none;
            padding: var(--spacing-md) 0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md) var(--spacing-lg);
            color: var(--text-light);
            transition: var(--transition);
            position: relative;
        }

        .nav-link:hover {
            background: var(--lighter);
            color: var(--primary);
        }

        .nav-item.active .nav-link {
            background: rgba(var(--primary-rgb), 0.1);
            color: var(--primary);
        }

        .nav-item.active .nav-link::before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary);
        }

        .sidebar.collapsed .nav-link span {
            display: none;
        }

        /* ==================== Main Content ==================== */
        .main-content {
            flex: 1;
            background: var(--darker);
            overflow-y: auto;
            padding: var(--spacing-xl);
        }

        /* ==================== Page Header ==================== */
        .page-header {
            background: var(--dark);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-sm);
        }

        .page-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-lg);
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            color: var(--primary);
            margin-bottom: var(--spacing-sm);
        }

        .page-subtitle {
            color: var(--text-muted);
            margin: 0;
        }

        .page-header-right {
            display: flex;
            gap: var(--spacing-md);
        }

        /* ==================== Progress Bar ==================== */
        .progress-container {
            background: var(--dark);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }

        .progress-bar {
            height: 8px;
            background: var(--lighter);
            border-radius: var(--radius-xl);
            overflow: hidden;
            margin-bottom: var(--spacing-xl);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            transition: width 0.5s ease;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
        }

        .progress-step {
            text-align: center;
            position: relative;
            flex: 1;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            background: var(--lighter);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--spacing-sm);
            font-weight: 600;
            transition: var(--transition);
        }

        .progress-step.active .step-circle {
            background: var(--primary);
            color: var(--dark);
        }

        .progress-step.completed .step-circle {
            background: var(--success);
            color: white;
        }

        .step-label {
            font-size: var(--font-sm);
            color: var(--text-muted);
        }

        .progress-step.active .step-label {
            color: var(--primary);
            font-weight: 500;
        }

        /* ==================== Tabs ==================== */
        .tabs-container {
            background: var(--dark);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-sm);
        }

        .tabs-nav {
            background: var(--lighter);
            padding: var(--spacing-sm);
        }

        .tabs-list {
            display: flex;
            list-style: none;
            gap: var(--spacing-sm);
            margin: 0;
            padding: 0;
        }

        .tab-link {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: var(--font-base);
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            white-space: nowrap;
        }

        .tab-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
        }

        .tab-link.active {
            background: var(--dark);
            color: var(--primary);
        }

        .tab-panels {
            padding: var(--spacing-xl);
            min-height: 400px;
        }

        /* ==================== Form Actions ==================== */
        .form-actions {
            background: var(--dark);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--spacing-lg);
            position: sticky;
            bottom: var(--spacing-xl);
            box-shadow: var(--shadow);
        }

        .actions-left,
        .actions-right {
            display: flex;
            gap: var(--spacing-md);
        }

        /* ==================== Buttons ==================== */
        .btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-sm);
            font-size: var(--font-base);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-family: inherit;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--dark);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(var(--primary-rgb), 0.4);
        }

        .btn-secondary {
            background: var(--lighter);
            color: var(--text);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--lightest);
        }

        .btn-outline {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        .btn-outline:hover:not(:disabled) {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(var(--primary-rgb), 0.1);
        }

        /* ==================== Responsive Design ==================== */
        @media (max-width: 1200px) {
            .header-center {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -260px;
                height: 100%;
                z-index: var(--z-modal-backdrop);
            }

            .sidebar.active {
                left: 0;
            }

            .main-content {
                padding: var(--spacing-md);
            }

            .page-header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .tabs-list {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .progress-steps {
                display: none;
            }

            .form-actions {
                flex-direction: column;
                gap: var(--spacing-md);
                bottom: 0;
                left: 0;
                right: 0;
                border-radius: 0;
                border-top: 1px solid var(--border);
            }

            .actions-left,
            .actions-right {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</body>
<!-- ==================== Basic Info Tab Panel ==================== -->
<div class="tab-panel active" id="basicPanel" role="tabpanel" aria-labelledby="basicTab">
    <div class="panel-header">
        <h2 class="panel-title">
            <i class="fas fa-user-circle"></i>
            المعلومات الأساسية
        </h2>
        <p class="panel-description">أدخل البيانات الأساسية للمستخدم الجديد</p>
    </div>

    <div class="panel-content">
        <div class="form-grid">
            <!-- القسم الأيسر - الصورة الشخصية -->
            <div class="form-section avatar-section">
                <h3 class="section-title">
                    <i class="fas fa-camera"></i>
                    الصورة الشخصية
                </h3>
                
                <div class="avatar-upload-container">
                    <div class="avatar-preview" id="avatarPreview">
                        <img src="" alt="Avatar" id="avatarImg" style="display: none;">
                        <div class="avatar-placeholder" id="avatarPlaceholder">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="avatar-overlay">
                            <i class="fas fa-camera"></i>
                            <span>تغيير الصورة</span>
                        </div>
                    </div>
                    
                    <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                    
                    <div class="avatar-actions">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('avatarInput').click()">
                            <i class="fas fa-upload"></i>
                            رفع صورة
                        </button>
                        <button type="button" class="btn btn-outline" id="removeAvatarBtn" style="display: none;">
                            <i class="fas fa-trash"></i>
                            حذف
                        </button>
                    </div>
                    
                    <div class="avatar-info">
                        <p class="text-muted text-sm">
                            <i class="fas fa-info-circle"></i>
                            الصور المسموحة: JPG, PNG, GIF
                        </p>
                        <p class="text-muted text-sm">
                            <i class="fas fa-exclamation-triangle"></i>
                            الحد الأقصى: 5 ميجابايت
                        </p>
                    </div>
                </div>

                <!-- GitHub Upload Instructions -->
                <div class="github-upload-note" id="githubUploadNote" style="display: none;">
                    <div class="note-header">
                        <i class="fas fa-github"></i>
                        تعليمات رفع الصورة
                    </div>
                    <div class="note-content">
                        <p>قم برفع الصورة إلى المسار التالي في GitHub:</p>
                        <code id="githubPath">/media/avatars/</code>
                        <button class="btn btn-sm btn-primary" onclick="copyGithubPath()">
                            <i class="fas fa-copy"></i>
                            نسخ المسار
                        </button>
                    </div>
                </div>
            </div>

            <!-- القسم الأيمن - البيانات الأساسية -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="fas fa-id-card"></i>
                    بيانات الحساب
                </h3>

                <!-- الاسم الكامل -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required" for="firstName">
                            <i class="fas fa-user"></i>
                            الاسم الأول
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="firstName" 
                               placeholder="أدخل الاسم الأول"
                               required
                               autocomplete="given-name">
                        <div class="form-feedback" id="firstNameFeedback"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label required" for="lastName">
                            <i class="fas fa-user"></i>
                            اسم العائلة
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="lastName" 
                               placeholder="أدخل اسم العائلة"
                               required
                               autocomplete="family-name">
                        <div class="form-feedback" id="lastNameFeedback"></div>
                    </div>
                </div>

                <!-- البريد الإلكتروني -->
                <div class="form-group">
                    <label class="form-label required" for="email">
                        <i class="fas fa-envelope"></i>
                        البريد الإلكتروني
                    </label>
                    <div class="input-group">
                        <input type="email" 
                               class="form-control" 
                               id="email" 
                               placeholder="example@domain.com"
                               required
                               autocomplete="email">
                        <button type="button" class="input-addon" id="checkEmailBtn">
                            <i class="fas fa-check-circle"></i>
                            تحقق
                        </button>
                    </div>
                    <div class="form-hint">سيستخدم هذا البريد لتسجيل الدخول</div>
                    <div class="form-feedback" id="emailFeedback"></div>
                </div>

                <!-- كلمة المرور -->
                <div class="form-group" id="passwordGroup">
                    <label class="form-label required" for="password">
                        <i class="fas fa-lock"></i>
                        كلمة المرور
                    </label>
                    <div class="input-group">
                        <input type="password" 
                               class="form-control" 
                               id="password" 
                               placeholder="أدخل كلمة مرور قوية"
                               required
                               autocomplete="new-password">
                        <button type="button" class="input-addon" onclick="togglePassword()">
                            <i class="fas fa-eye" id="passwordToggleIcon"></i>
                        </button>
                        <button type="button" class="input-addon btn-primary" onclick="generatePassword()">
                            <i class="fas fa-key"></i>
                            توليد
                        </button>
                    </div>
                    
                    <!-- مؤشر قوة كلمة المرور -->
                    <div class="password-strength" id="passwordStrength">
                        <div class="strength-bar">
                            <div class="strength-fill" id="strengthFill"></div>
                        </div>
                        <div class="strength-text" id="strengthText">أدخل كلمة المرور</div>
                    </div>
                    
                    <!-- معايير كلمة المرور -->
                    <div class="password-criteria">
                        <div class="criteria-item" id="lengthCriteria">
                            <i class="fas fa-times-circle"></i>
                            <span>8 أحرف على الأقل</span>
                        </div>
                        <div class="criteria-item" id="uppercaseCriteria">
                            <i class="fas fa-times-circle"></i>
                            <span>حرف كبير واحد على الأقل</span>
                        </div>
                        <div class="criteria-item" id="lowercaseCriteria">
                            <i class="fas fa-times-circle"></i>
                            <span>حرف صغير واحد على الأقل</span>
                        </div>
                        <div class="criteria-item" id="numberCriteria">
                            <i class="fas fa-times-circle"></i>
                            <span>رقم واحد على الأقل</span>
                        </div>
                        <div class="criteria-item" id="specialCriteria">
                            <i class="fas fa-times-circle"></i>
                            <span>رمز خاص واحد على الأقل (!@#$%^&*)</span>
                        </div>
                    </div>
                </div>

                <!-- تأكيد كلمة المرور -->
                <div class="form-group" id="confirmPasswordGroup">
                    <label class="form-label required" for="confirmPassword">
                        <i class="fas fa-lock"></i>
                        تأكيد كلمة المرور
                    </label>
                    <input type="password" 
                           class="form-control" 
                           id="confirmPassword" 
                           placeholder="أعد إدخال كلمة المرور"
                           required
                           autocomplete="new-password">
                    <div class="form-feedback" id="confirmPasswordFeedback"></div>
                </div>

                <!-- رقم الهاتف/WhatsApp -->
                <div class="form-group">
                    <label class="form-label required" for="whatsapp">
                        <i class="fab fa-whatsapp"></i>
                        رقم WhatsApp
                    </label>
                    <div class="phone-input-group">
                        <select class="country-code" id="countryCode">
                            <option value="+20" data-flag="🇪🇬">+20 (مصر)</option>
                            <option value="+966" data-flag="🇸🇦">+966 (السعودية)</option>
                            <option value="+971" data-flag="🇦🇪">+971 (الإمارات)</option>
                            <option value="+965" data-flag="🇰🇼">+965 (الكويت)</option>
                            <option value="+974" data-flag="🇶🇦">+974 (قطر)</option>
                            <option value="+968" data-flag="🇴🇲">+968 (عمان)</option>
                            <option value="+973" data-flag="🇧🇭">+973 (البحرين)</option>
                            <option value="+962" data-flag="🇯🇴">+962 (الأردن)</option>
                            <option value="+961" data-flag="🇱🇧">+961 (لبنان)</option>
                            <option value="+970" data-flag="🇵🇸">+970 (فلسطين)</option>
                            <option value="+963" data-flag="🇸🇾">+963 (سوريا)</option>
                            <option value="+964" data-flag="🇮🇶">+964 (العراق)</option>
                            <option value="+212" data-flag="🇲🇦">+212 (المغرب)</option>
                            <option value="+213" data-flag="🇩🇿">+213 (الجزائر)</option>
                            <option value="+216" data-flag="🇹🇳">+216 (تونس)</option>
                            <option value="+218" data-flag="🇱🇾">+218 (ليبيا)</option>
                            <option value="+249" data-flag="🇸🇩">+249 (السودان)</option>
                        </select>
                        <input type="tel" 
                               class="form-control" 
                               id="phoneNumber" 
                               placeholder="123456789"
                               pattern="[0-9]*"
                               required>
                    </div>
                    <div class="form-hint">سيستخدم للتواصل وإرسال الإشعارات</div>
                    <div class="form-feedback" id="phoneFeedback"></div>
                </div>

                <!-- حالة الحساب -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-toggle-on"></i>
                        حالة الحساب
                    </label>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="accountStatus" value="active" checked>
                            <span class="radio-mark"></span>
                            <span>نشط</span>
                            <small class="text-muted">يمكن للمستخدم الدخول فوراً</small>
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="accountStatus" value="pending">
                            <span class="radio-mark"></span>
                            <span>معلق</span>
                            <small class="text-muted">يحتاج موافقة قبل الدخول</small>
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="accountStatus" value="inactive">
                            <span class="radio-mark"></span>
                            <span>غير نشط</span>
                            <small class="text-muted">لا يمكن الدخول حالياً</small>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== Additional CSS for Basic Tab ==================== -->
<style>
    /* ==================== Panel Styles ==================== */
    .tab-panel {
        display: none;
        animation: fadeIn 0.3s ease-in-out;
    }

    .tab-panel.active {
        display: block;
    }

    .panel-header {
        margin-bottom: var(--spacing-2xl);
        padding-bottom: var(--spacing-lg);
        border-bottom: 1px solid var(--border);
    }

    .panel-title {
        color: var(--primary);
        font-size: var(--font-2xl);
        margin-bottom: var(--spacing-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .panel-description {
        color: var(--text-muted);
        font-size: var(--font-base);
        margin: 0;
    }

    /* ==================== Form Grid ==================== */
    .form-grid {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: var(--spacing-2xl);
    }

    .form-section {
        background: var(--lighter);
        padding: var(--spacing-xl);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
    }

    .section-title {
        font-size: var(--font-lg);
        color: var(--text);
        margin-bottom: var(--spacing-lg);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    /* ==================== Avatar Section ==================== */
    .avatar-section {
        text-align: center;
    }

    .avatar-upload-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--spacing-lg);
    }

    .avatar-preview {
        width: 180px;
        height: 180px;
        position: relative;
        border-radius: 50%;
        overflow: hidden;
        background: var(--dark);
        border: 4px solid var(--border);
        cursor: pointer;
        transition: var(--transition);
    }

    .avatar-preview:hover {
        border-color: var(--primary);
        transform: scale(1.05);
    }

    .avatar-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 4rem;
        color: var(--text-dark);
    }

    .avatar-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
        padding: var(--spacing-lg) var(--spacing-md) var(--spacing-md);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--spacing-xs);
        color: white;
        opacity: 0;
        transition: var(--transition);
    }

    .avatar-preview:hover .avatar-overlay {
        opacity: 1;
    }

    .avatar-actions {
        display: flex;
        gap: var(--spacing-sm);
    }

    .avatar-info {
        text-align: center;
    }

    .avatar-info p {
        margin: var(--spacing-xs) 0;
    }

    /* ==================== GitHub Upload Note ==================== */
    .github-upload-note {
        background: rgba(var(--info-rgb), 0.1);
        border: 1px solid var(--info);
        border-radius: var(--radius-sm);
        padding: var(--spacing-md);
        margin-top: var(--spacing-lg);
    }

    .note-header {
        font-weight: 600;
        color: var(--info);
        margin-bottom: var(--spacing-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .note-content {
        font-size: var(--font-sm);
    }

    .note-content code {
        background: var(--dark);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-sm);
        font-family: monospace;
        display: block;
        margin: var(--spacing-sm) 0;
    }

    /* ==================== Form Elements ==================== */
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-lg);
    }

    .form-group {
        margin-bottom: var(--spacing-lg);
    }

    .form-group:last-child {
        margin-bottom: 0;
    }

    .form-label {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-sm);
        font-weight: 500;
        color: var(--text);
    }

    .form-label.required::after {
        content: '*';
        color: var(--danger);
        margin-right: var(--spacing-xs);
    }

    .form-control {
        width: 100%;
        padding: var(--spacing-md);
        background: var(--dark);
        border: 2px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text);
        font-size: var(--font-base);
        font-family: inherit;
        transition: var(--transition);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        background: rgba(var(--primary-rgb), 0.05);
    }

    .form-control:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .form-control.error {
        border-color: var(--danger);
    }

    .form-control.success {
        border-color: var(--success);
    }

    /* ==================== Input Groups ==================== */
    .input-group {
        display: flex;
        align-items: stretch;
    }

    .input-group .form-control {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        border-left: none;
    }

    .input-addon {
        padding: var(--spacing-md);
        background: var(--lightest);
        border: 2px solid var(--border);
        border-right: none;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: var(--transition);
    }

    .input-addon:first-child {
        border-top-right-radius: var(--radius-sm);
        border-bottom-right-radius: var(--radius-sm);
    }

    .input-addon:last-child {
        border-top-left-radius: var(--radius-sm);
        border-bottom-left-radius: var(--radius-sm);
        border-right: 2px solid var(--border);
        border-left: none;
    }

    .input-addon:hover {
        background: var(--primary);
        color: var(--dark);
        border-color: var(--primary);
    }

    .input-addon.btn-primary {
        background: var(--primary);
        color: var(--dark);
        border-color: var(--primary);
    }

    /* ==================== Phone Input ==================== */
    .phone-input-group {
        display: flex;
        gap: var(--spacing-sm);
    }

    .country-code {
        width: 140px;
        padding: var(--spacing-md);
        background: var(--dark);
        border: 2px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text);
        font-size: var(--font-base);
        cursor: pointer;
    }

    /* ==================== Password Strength ==================== */
    .password-strength {
        margin-top: var(--spacing-sm);
    }

    .strength-bar {
        height: 6px;
        background: var(--dark);
        border-radius: var(--radius-sm);
        overflow: hidden;
        margin-bottom: var(--spacing-xs);
    }

    .strength-fill {
        height: 100%;
        width: 0;
        transition: width 0.3s ease, background 0.3s ease;
    }

    .strength-fill.weak {
        width: 25%;
        background: var(--danger);
    }

    .strength-fill.fair {
        width: 50%;
        background: var(--warning);
    }

    .strength-fill.good {
        width: 75%;
        background: var(--info);
    }

    .strength-fill.strong {
        width: 100%;
        background: var(--success);
    }

    .strength-text {
        font-size: var(--font-sm);
        color: var(--text-muted);
    }

    /* ==================== Password Criteria ==================== */
    .password-criteria {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-md);
        padding: var(--spacing-md);
        background: var(--dark);
        border-radius: var(--radius-sm);
        font-size: var(--font-sm);
    }

    .criteria-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        color: var(--text-muted);
    }

    .criteria-item i {
        color: var(--danger);
        transition: var(--transition);
    }

    .criteria-item.valid i {
        color: var(--success);
    }

    /* ==================== Radio Groups ==================== */
    .radio-group {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }

    .radio-item {
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-sm);
        padding: var(--spacing-md);
        background: var(--dark);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: var(--transition);
        position: relative;
    }

    .radio-item:hover {
        background: rgba(var(--primary-rgb), 0.05);
        border: 1px solid var(--primary);
    }

    .radio-item input[type="radio"] {
        position: absolute;
        opacity: 0;
    }

    .radio-mark {
        width: 20px;
        height: 20px;
        border: 2px solid var(--border);
        border-radius: 50%;
        position: relative;
        transition: var(--transition);
        flex-shrink: 0;
        margin-top: 2px;
    }

    .radio-mark::after {
        content: '';
        width: 10px;
        height: 10px;
        background: var(--primary);
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        transition: var(--transition);
    }

    .radio-item input[type="radio"]:checked ~ .radio-mark {
        border-color: var(--primary);
    }

    .radio-item input[type="radio"]:checked ~ .radio-mark::after {
        transform: translate(-50%, -50%) scale(1);
    }

    .radio-item small {
        display: block;
        margin-top: var(--spacing-xs);
    }

    /* ==================== Form Feedback ==================== */
    .form-hint {
        font-size: var(--font-sm);
        color: var(--text-muted);
        margin-top: var(--spacing-xs);
    }

    .form-feedback {
        font-size: var(--font-sm);
        margin-top: var(--spacing-xs);
        display: none;
    }

    .form-feedback.show {
        display: block;
    }

    .form-feedback.error {
        color: var(--danger);
    }

    .form-feedback.success {
        color: var(--success);
    }

    /* ==================== Utilities ==================== */
    .text-sm {
        font-size: var(--font-sm);
    }

    .btn-sm {
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: var(--font-sm);
    }

    /* ==================== Responsive ==================== */
    @media (max-width: 992px) {
        .form-grid {
            grid-template-columns: 1fr;
        }

        .avatar-section {
            order: -1;
        }
    }

    @media (max-width: 576px) {
        .form-row {
            grid-template-columns: 1fr;
        }

        .password-criteria {
            grid-template-columns: 1fr;
        }

        .phone-input-group {
            flex-direction: column;
        }

        .country-code {
            width: 100%;
        }
    }
</style>
<!-- ==================== Roles & Permissions Tab Panel ==================== -->
<div class="tab-panel" id="rolesPanel" role="tabpanel" aria-labelledby="rolesTab">
    <div class="panel-header">
        <h2 class="panel-title">
            <i class="fas fa-user-shield"></i>
            الأدوار والصلاحيات
        </h2>
        <p class="panel-description">حدد دور المستخدم وصلاحياته في المنصة</p>
    </div>

    <div class="panel-content">
        <!-- Role Selection -->
        <div class="role-selection-section">
            <h3 class="section-title">
                <i class="fas fa-crown"></i>
                اختر الدور الأساسي
            </h3>
            
            <div class="roles-grid">
                <!-- طالب -->
                <div class="role-card" data-role="student">
                    <input type="radio" name="primaryRole" id="roleStudent" value="student" checked>
                    <label for="roleStudent">
                        <div class="role-icon">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <div class="role-info">
                            <h4 class="role-name">طالب</h4>
                            <p class="role-description">الوصول للدورات المسجل بها والمحتوى التعليمي</p>
                        </div>
                        <div class="role-badge">
                            <span class="badge badge-info">افتراضي</span>
                        </div>
                    </label>
                </div>

                <!-- مدرب مساعد -->
                <div class="role-card" data-role="assistant">
                    <input type="radio" name="primaryRole" id="roleAssistant" value="assistant">
                    <label for="roleAssistant">
                        <div class="role-icon">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <div class="role-info">
                            <h4 class="role-name">مدرب مساعد</h4>
                            <p class="role-description">مساعدة في إدارة الدورات والرد على الاستفسارات</p>
                        </div>
                        <div class="role-badge">
                            <span class="badge badge-warning">متقدم</span>
                        </div>
                    </label>
                </div>

                <!-- مشرف مجموعة -->
                <div class="role-card" data-role="group-leader">
                    <input type="radio" name="primaryRole" id="roleGroupLeader" value="group-leader">
                    <label for="roleGroupLeader">
                        <div class="role-icon">
                            <i class="fas fa-users-cog"></i>
                        </div>
                        <div class="role-info">
                            <h4 class="role-name">مشرف مجموعة</h4>
                            <p class="role-description">إدارة مجموعة من الطلاب ومتابعة تقدمهم</p>
                        </div>
                        <div class="role-badge">
                            <span class="badge badge-primary">إداري</span>
                        </div>
                    </label>
                </div>

                <!-- محلل بيانات -->
                <div class="role-card" data-role="analyst">
                    <input type="radio" name="primaryRole" id="roleAnalyst" value="analyst">
                    <label for="roleAnalyst">
                        <div class="role-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="role-info">
                            <h4 class="role-name">محلل بيانات</h4>
                            <p class="role-description">عرض التقارير والإحصائيات دون صلاحيات التعديل</p>
                        </div>
                        <div class="role-badge">
                            <span class="badge badge-success">تحليلي</span>
                        </div>
                    </label>
                </div>
            </div>
        </div>

        <!-- Permissions Matrix -->
        <div class="permissions-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-key"></i>
                    الصلاحيات التفصيلية
                </h3>
                <div class="section-actions">
                    <button class="btn btn-sm btn-outline" onclick="selectAllPermissions()">
                        <i class="fas fa-check-square"></i>
                        تحديد الكل
                    </button>
                    <button class="btn btn-sm btn-outline" onclick="deselectAllPermissions()">
                        <i class="fas fa-square"></i>
                        إلغاء الكل
                    </button>
                </div>
            </div>

            <div class="permissions-categories">
                <!-- صلاحيات المحتوى التعليمي -->
                <div class="permission-category">
                    <div class="category-header" onclick="toggleCategory('content')">
                        <i class="fas fa-chevron-down category-toggle"></i>
                        <i class="fas fa-book"></i>
                        <span>المحتوى التعليمي</span>
                        <span class="category-count" id="contentCount">0/5</span>
                    </div>
                    <div class="category-permissions" id="contentPermissions">
                        <label class="permission-item">
                            <input type="checkbox" name="permissions" value="view_courses" checked>
                            <span class="permission-checkbox"></span>
                            <div class="permission-info">
                                <span class="permission-name">عرض الدورات</span>
                                <small class="permission-desc">الوصول للدورات المسجل بها</small>
                            </div>
                        </label>
                        <label class="permission-item">
                            <input type="checkbox" name="permissions" value="download_materials">
                            <span class="permission-checkbox"></span>
                            <div class="permission-info">
                                <span class="permission-name">تحميل المواد</span>
                                <small class="permission-desc">تحميل ملفات PDF والمرفقات</small>
                            </div>
                        </label>
                        <label class="permission-item">
                            <input type="checkbox" name="permissions" value="submit_assignments">
                            <span class="permission-checkbox"></span>
                            <div class="permission-info">
                                <span class="permission-name">تسليم الواجبات</span>
                                <small class="permission-desc">رفع وتسليم الواجبات والمشاريع</small>
                            </div>
                        </label>
                        <label class="permission-item">
                            <input type="checkbox" name="permissions" value="take_quizzes">
                            <span class="permission-checkbox"></span>
                            <div class="permission-info">
                                <span class="permission-name">أداء الاختبارات</span>
                                <small class="permission-desc">الدخول للاختبارات والتقييمات</small>
                            </div>
                        </label>
                        <label class="permission-item">
                            <input type="checkbox" name="permissions" value="view_certificates">
                            <span class="permission-checkbox"></span>
                            <div class="permission-info">
                                <span class="permission-name">الشهادات</span>
                                <small class="permission-desc">عرض وتحميل الشهادات</small>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- صلاحيات التواصل -->
                <div class="permission-category">
                    <div class="category-header" onclick="toggleCategory('communication')">
                        <i class="fas fa-chevron-down category-toggle"></i>
                        <i class="fas fa-comments"></i>
                        <span>التواصل والمناقشات</span>
                        <span class="category-count" id="communicationCount">0/4</span>
                    </div>
                    <div class="category-permissions" id="communicationPermissions">
                        <label class="permission-item">
                            <input type="checkbox" name="permissions" value="post_discussions">
                            <span class="permission-checkbox"></span>
                            <div class="permission-info">
                                <span class="permission-name">كتابة المناقشات</span>
                                <small class="permission-desc">إنشاء مواضيع جديدة في المنتدى</small>
                            </div>
                        </label>
                        <label class="permission-item">
                            <input type="checkbox" name="permissions" value="comment_discussions">
                            <span class="permission-checkbox"></span>
                            <div class="permission-info">
                                <span class="permission-name">التعليق</span>
                                <small class="permission-desc">الرد على المناقشات والتعليقات</small>
                            </div>
                        </label>
                        <label class="permission-item">
                            <input type="checkbox" name="permissions" value="send_messages">
                            <span class="permission-checkbox"></span>
                            <div class="permission-info">
                                <span class="permission-name">الرسائل الخاصة</span>
                                <small class="permission-desc">إرسال رسائل للمدربين والطلاب</small>
                            </div>
                        </label>
                        <label class="permission-item">
                            <input type="checkbox" name="permissions" value="rate_courses">
                            <span class="permission-checkbox"></span>
                            <div class="permission-info">
                                <span class="permission-name">تقييم الدورات</span>
                                <small class="permission-desc">إضافة تقييمات ومراجعات</small>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- صلاحيات إدارية -->
                <div class="permission-category">
                    <div class="category-header" onclick="toggleCategory('admin')">
                        <i class="fas fa-chevron-down category-toggle"></i>
                        <i class="fas fa-cogs"></i>
                        <span>الصلاحيات الإدارية</span>
                        <span class="category-count" id="adminCount">0/6</span>
                    </div>
                    <div class="category-permissions" id="adminPermissions">
                        <label class="permission-item">
                            <input type="checkbox" name="permissions" value="manage_users">
                            <span class="permission-checkbox"></span>
                            <div class="permission-info">
                                <span class="permission-name">إدارة المستخدمين</span>
                                <small class="permission-desc">إضافة وتعديل بيانات المستخدمين</small>
                            </div>
                        </label>
                        <label class="permission-item">
                            <input type="checkbox" name="permissions" value="manage_groups">
                            <span class="permission-checkbox"></span>
                            <div class="permission-info">
                                <span class="permission-name">إدارة المجموعات</span>
                                <small class="permission-desc">إنشاء وإدارة المجموعات التعليمية</small>
                            </div>
                        </label>
                        <label class="permission-item">
                            <input type="checkbox" name="permissions" value="view_reports">
                            <span class="permission-checkbox"></span>
                            <div class="permission-info">
                                <span class="permission-name">عرض التقارير</span>
                                <small class="permission-desc">الوصول لتقارير الأداء والإحصائيات</small>
                            </div>
                        </label>
                        <label class="permission-item">
                            <input type="checkbox" name="permissions" value="export_data">
                            <span class="permission-checkbox"></span>
                            <div class="permission-info">
                                <span class="permission-name">تصدير البيانات</span>
                                <small class="permission-desc">تصدير التقارير والبيانات</small>
                            </div>
                        </label>
                        <label class="permission-item">
                            <input type="checkbox" name="permissions" value="send_notifications">
                            <span class="permission-checkbox"></span>
                            <div class="permission-info">
                                <span class="permission-name">إرسال الإشعارات</span>
                                <small class="permission-desc">إرسال إشعارات للمستخدمين</small>
                            </div>
                        </label>
                        <label class="permission-item">
                            <input type="checkbox" name="permissions" value="manage_content">
                            <span class="permission-checkbox"></span>
                            <div class="permission-info">
                                <span class="permission-name">إدارة المحتوى</span>
                                <small class="permission-desc">تعديل محتوى الدورات</small>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- صلاحيات التحليلات -->
                <div class="permission-category">
                    <div class="category-header" onclick="toggleCategory('analytics')">
                        <i class="fas fa-chevron-down category-toggle"></i>
                        <i class="fas fa-chart-bar"></i>
                        <span>التحليلات والتقارير</span>
                        <span class="category-count" id="analyticsCount">0/4</span>
                    </div>
                    <div class="category-permissions" id="analyticsPermissions">
                        <label class="permission-item">
                            <input type="checkbox" name="permissions" value="view_analytics">
                            <span class="permission-checkbox"></span>
                            <div class="permission-info">
                                <span class="permission-name">لوحة التحليلات</span>
                                <small class="permission-desc">عرض لوحة التحليلات العامة</small>
                            </div>
                        </label>
                        <label class="permission-item">
                            <input type="checkbox" name="permissions" value="view_progress_reports">
                            <span class="permission-checkbox"></span>
                            <div class="permission-info">
                                <span class="permission-name">تقارير التقدم</span>
                                <small class="permission-desc">متابعة تقدم الطلاب</small>
                            </div>
                        </label>
                        <label class="permission-item">
                            <input type="checkbox" name="permissions" value="view_financial_reports">
                            <span class="permission-checkbox"></span>
                            <div class="permission-info">
                                <span class="permission-name">التقارير المالية</span>
                                <small class="permission-desc">عرض الإيرادات والمدفوعات</small>
                            </div>
                        </label>
                        <label class="permission-item">
                            <input type="checkbox" name="permissions" value="create_custom_reports">
                            <span class="permission-checkbox"></span>
                            <div class="permission-info">
                                <span class="permission-name">تقارير مخصصة</span>
                                <small class="permission-desc">إنشاء تقارير مخصصة</small>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Role Builder -->
        <div class="custom-role-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-magic"></i>
                    دور مخصص
                </h3>
                <div class="toggle-switch">
                    <input type="checkbox" id="enableCustomRole">
                    <label for="enableCustomRole">تفعيل دور مخصص</label>
                </div>
            </div>

            <div class="custom-role-builder" id="customRoleBuilder" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="customRoleName">
                            <i class="fas fa-tag"></i>
                            اسم الدور
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="customRoleName" 
                               placeholder="مثال: منسق الدورات">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="customRoleColor">
                            <i class="fas fa-palette"></i>
                            لون الدور
                        </label>
                        <div class="color-picker">
                            <input type="color" id="customRoleColor" value="#f4c430">
                            <div class="color-presets">
                                <button type="button" class="color-preset" style="background: #f4c430" data-color="#f4c430"></button>
                                <button type="button" class="color-preset" style="background: #2196f3" data-color="#2196f3"></button>
                                <button type="button" class="color-preset" style="background: #4caf50" data-color="#4caf50"></button>
                                <button type="button" class="color-preset" style="background: #ff9800" data-color="#ff9800"></button>
                                <button type="button" class="color-preset" style="background: #9c27b0" data-color="#9c27b0"></button>
                                <button type="button" class="color-preset" style="background: #f44336" data-color="#f44336"></button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="customRoleDescription">
                        <i class="fas fa-align-left"></i>
                        وصف الدور
                    </label>
                    <textarea class="form-control" 
                              id="customRoleDescription" 
                              rows="3" 
                              placeholder="اكتب وصف مختصر لهذا الدور ومسؤولياته..."></textarea>
                </div>
            </div>
        </div>

        <!-- Role Preview -->
        <div class="role-preview">
            <h3 class="section-title">
                <i class="fas fa-eye"></i>
                معاينة الصلاحيات
            </h3>
            <div class="preview-card">
                <div class="preview-header">
                    <div class="preview-role">
                        <i class="fas fa-user-graduate"></i>
                        <span id="previewRoleName">طالب</span>
                    </div>
                    <div class="preview-stats">
                        <span class="stat">
                            <i class="fas fa-check-circle text-success"></i>
                            <span id="activePermissionsCount">1</span> صلاحية نشطة
                        </span>
                        <span class="stat">
                            <i class="fas fa-times-circle text-danger"></i>
                            <span id="inactivePermissionsCount">18</span> صلاحية معطلة
                        </span>
                    </div>
                </div>
                <div class="preview-summary" id="previewSummary">
                    <p>هذا المستخدم سيتمكن من:</p>
                    <ul id="permissionsSummary">
                        <li>عرض الدورات المسجل بها</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== Additional CSS for Roles Tab ==================== -->
<style>
    /* ==================== Role Selection ==================== */
    .role-selection-section {
        margin-bottom: var(--spacing-2xl);
    }

    .roles-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: var(--spacing-lg);
        margin-top: var(--spacing-lg);
    }

    .role-card {
        position: relative;
        transition: var(--transition);
    }

    .role-card input[type="radio"] {
        position: absolute;
        opacity: 0;
    }

    .role-card label {
        display: flex;
        flex-direction: column;
        padding: var(--spacing-lg);
        background: var(--lighter);
        border: 2px solid var(--border);
        border-radius: var(--radius-lg);
        cursor: pointer;
        transition: var(--transition);
        height: 100%;
    }

    .role-card:hover label {
        border-color: var(--primary);
        background: rgba(var(--primary-rgb), 0.05);
    }

    .role-card input[type="radio"]:checked + label {
        border-color: var(--primary);
        background: rgba(var(--primary-rgb), 0.1);
        box-shadow: 0 0 0 4px rgba(var(--primary-rgb), 0.2);
    }

    .role-icon {
        font-size: 2.5rem;
        color: var(--primary);
        margin-bottom: var(--spacing-md);
    }

    .role-name {
        font-size: var(--font-xl);
        margin-bottom: var(--spacing-sm);
        color: var(--text);
    }

    .role-description {
        font-size: var(--font-sm);
        color: var(--text-muted);
        margin: 0;
        flex: 1;
    }

    .role-badge {
        margin-top: var(--spacing-md);
    }

    .badge {
        display: inline-block;
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: var(--font-xs);
        font-weight: 600;
        border-radius: var(--radius-sm);
        text-transform: uppercase;
    }

    .badge-info {
        background: rgba(var(--info-rgb), 0.2);
        color: var(--info);
    }

    .badge-warning {
        background: rgba(var(--warning-rgb), 0.2);
        color: var(--warning);
    }

    .badge-primary {
        background: rgba(var(--primary-rgb), 0.2);
        color: var(--primary);
    }

    .badge-success {
        background: rgba(var(--success-rgb), 0.2);
        color: var(--success);
    }

    /* ==================== Permissions Section ==================== */
    .permissions-section {
        background: var(--lighter);
        padding: var(--spacing-xl);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        margin-bottom: var(--spacing-2xl);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
    }

    .section-actions {
        display: flex;
        gap: var(--spacing-sm);
    }

    /* ==================== Permission Categories ==================== */
    .permissions-categories {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }

    .permission-category {
        background: var(--dark);
        border-radius: var(--radius-sm);
        overflow: hidden;
    }

    .category-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-md) var(--spacing-lg);
        cursor: pointer;
        user-select: none;
        transition: var(--transition);
    }

    .category-header:hover {
        background: rgba(var(--primary-rgb), 0.05);
    }

    .category-toggle {
        transition: var(--transition);
    }

    .category-header.collapsed .category-toggle {
        transform: rotate(-90deg);
    }

    .category-count {
        margin-right: auto;
        font-size: var(--font-sm);
        color: var(--text-muted);
        background: var(--lighter);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-sm);
    }

    .category-permissions {
        padding: var(--spacing-md);
        border-top: 1px solid var(--border);
        display: grid;
        gap: var(--spacing-sm);
    }

    .category-header.collapsed + .category-permissions {
        display: none;
    }

    /* ==================== Permission Items ==================== */
    .permission-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-md);
        background: var(--lighter);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: var(--transition);
        position: relative;
    }

    .permission-item:hover {
        background: rgba(var(--primary-rgb), 0.05);
    }

    .permission-item input[type="checkbox"] {
        position: absolute;
        opacity: 0;
    }

    .permission-checkbox {
        width: 20px;
        height: 20px;
        border: 2px solid var(--border);
        border-radius: var(--radius-sm);
        position: relative;
        transition: var(--transition);
        flex-shrink: 0;
    }

    .permission-checkbox::after {
        content: '\f00c';
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        color: white;
        font-size: 12px;
        transition: var(--transition);
    }

    .permission-item input[type="checkbox"]:checked ~ .permission-checkbox {
        background: var(--primary);
        border-color: var(--primary);
    }

    .permission-item input[type="checkbox"]:checked ~ .permission-checkbox::after {
        transform: translate(-50%, -50%) scale(1);
    }

    .permission-info {
        flex: 1;
    }

    .permission-name {
        display: block;
        font-weight: 500;
        color: var(--text);
        margin-bottom: var(--spacing-xs);
    }

    .permission-desc {
        display: block;
        font-size: var(--font-sm);
        color: var(--text-muted);
    }

    /* ==================== Custom Role Section ==================== */
    .custom-role-section {
        background: var(--lighter);
        padding: var(--spacing-xl);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        margin-bottom: var(--spacing-2xl);
    }

    .toggle-switch {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .toggle-switch input[type="checkbox"] {
        width: 50px;
        height: 26px;
        appearance: none;
        background: var(--dark);
        border-radius: 26px;
        position: relative;
        cursor: pointer;
        transition: var(--transition);
    }

    .toggle-switch input[type="checkbox"]::after {
        content: '';
        position: absolute;
        width: 22px;
        height: 22px;
        background: var(--text-muted);
        border-radius: 50%;
        top: 2px;
        right: 26px;
        transition: var(--transition);
    }

    .toggle-switch input[type="checkbox"]:checked {
        background: var(--primary);
    }

    .toggle-switch input[type="checkbox"]:checked::after {
        right: 2px;
        background: white;
    }

    .custom-role-builder {
        margin-top: var(--spacing-lg);
        padding-top: var(--spacing-lg);
        border-top: 1px solid var(--border);
    }

    /* ==================== Color Picker ==================== */
    .color-picker {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    input[type="color"] {
        width: 50px;
        height: 50px;
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
    }

    .color-presets {
        display: flex;
        gap: var(--spacing-sm);
    }

    .color-preset {
        width: 30px;
        height: 30px;
        border: 2px solid var(--border);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: var(--transition);
    }

    .color-preset:hover {
        transform: scale(1.1);
        border-color: var(--text);
    }

    /* ==================== Role Preview ==================== */
    .role-preview {
        background: var(--lighter);
        padding: var(--spacing-xl);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
    }

    .preview-card {
        background: var(--dark);
        border-radius: var(--radius-sm);
        padding: var(--spacing-lg);
        margin-top: var(--spacing-lg);
    }

    .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-lg);
        border-bottom: 1px solid var(--border);
    }

    .preview-role {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: var(--font-xl);
        font-weight: 600;
        color: var(--primary);
    }

    .preview-stats {
        display: flex;
        gap: var(--spacing-lg);
    }

    .stat {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: var(--font-sm);
    }

    .preview-summary ul {
        list-style: none;
        padding: 0;
        margin: var(--spacing-md) 0 0 0;
    }

    .preview-summary li {
        padding: var(--spacing-sm) 0;
        padding-right: var(--spacing-lg);
        position: relative;
    }

    .preview-summary li::before {
        content: '\f00c';
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        position: absolute;
        right: 0;
        color: var(--success);
    }

    /* ==================== Responsive ==================== */
    @media (max-width: 768px) {
        .roles-grid {
            grid-template-columns: 1fr;
        }

        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--spacing-md);
        }

        .section-actions {
            width: 100%;
        }

        .section-actions .btn {
            flex: 1;
        }

        .preview-header {
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .preview-stats {
            width: 100%;
            justify-content: space-around;
        }
    }
</style>
<!-- ==================== Courses & Paths Tab Panel ==================== -->
<div class="tab-panel" id="coursesPanel" role="tabpanel" aria-labelledby="coursesTab">
    <div class="panel-header">
        <h2 class="panel-title">
            <i class="fas fa-book"></i>
            الدورات والمسارات
        </h2>
        <p class="panel-description">حدد الدورات والمسارات التعليمية المتاحة للمستخدم</p>
    </div>

    <div class="panel-content">
        <!-- Search and Filter Section -->
        <div class="search-filter-section">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" 
                       class="search-input" 
                       id="courseSearchInput" 
                       placeholder="ابحث عن دورة أو مسار...">
                <button class="search-clear" id="clearSearch" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">
                    <i class="fas fa-th"></i>
                    الكل
                    <span class="filter-count" id="allCount">0</span>
                </button>
                <button class="filter-btn" data-filter="courses">
                    <i class="fas fa-graduation-cap"></i>
                    الدورات
                    <span class="filter-count" id="coursesCount">0</span>
                </button>
                <button class="filter-btn" data-filter="paths">
                    <i class="fas fa-route"></i>
                    المسارات
                    <span class="filter-count" id="pathsCount">0</span>
                </button>
                <button class="filter-btn" data-filter="selected">
                    <i class="fas fa-check-circle"></i>
                    المحددة
                    <span class="filter-count" id="selectedCount">0</span>
                </button>
            </div>
        </div>

        <!-- Course Assignment Container -->
        <div class="course-assignment-container">
            <!-- Available Courses/Paths -->
            <div class="assignment-column">
                <div class="column-header">
                    <h3 class="column-title">
                        <i class="fas fa-list"></i>
                        الدورات والمسارات المتاحة
                    </h3>
                    <div class="column-actions">
                        <select class="sort-select" id="sortSelect">
                            <option value="name">الترتيب حسب الاسم</option>
                            <option value="date">الترتيب حسب التاريخ</option>
                            <option value="price">الترتيب حسب السعر</option>
                            <option value="students">الترتيب حسب عدد الطلاب</option>
                        </select>
                    </div>
                </div>
                
                <div class="items-container" id="availableItems">
                    <!-- Loading State -->
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>جاري تحميل الدورات والمسارات...</p>
                    </div>
                    
                    <!-- سيتم ملء العناصر بواسطة JavaScript -->
                </div>
            </div>

            <!-- Drag & Drop Area -->
            <div class="drag-drop-area">
                <div class="drop-zone" id="dropZone">
                    <i class="fas fa-hand-point-left"></i>
                    <p>اسحب الدورات هنا</p>
                    <span>أو انقر على الدورة لإضافتها</span>
                </div>
            </div>

            <!-- Assigned Courses/Paths -->
            <div class="assignment-column">
                <div class="column-header">
                    <h3 class="column-title">
                        <i class="fas fa-user-check"></i>
                        الدورات والمسارات المخصصة
                    </h3>
                    <div class="column-stats">
                        <span class="stat-item">
                            <i class="fas fa-book-open"></i>
                            <span id="assignedCoursesCount">0</span> دورة
                        </span>
                        <span class="stat-item">
                            <i class="fas fa-layer-group"></i>
                            <span id="assignedPathsCount">0</span> مسار
                        </span>
                    </div>
                </div>
                
                <div class="items-container assigned-items" id="assignedItems">
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>لم يتم تخصيص أي دورات بعد</p>
                        <span>اختر من القائمة المجاورة</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Actions -->
        <div class="bulk-actions">
            <div class="bulk-actions-left">
                <button class="btn btn-outline" onclick="assignAllVisible()">
                    <i class="fas fa-plus-circle"></i>
                    إضافة جميع المرئية
                </button>
                <button class="btn btn-outline" onclick="removeAllAssigned()">
                    <i class="fas fa-minus-circle"></i>
                    إزالة الكل
                </button>
            </div>
            <div class="bulk-actions-right">
                <button class="btn btn-secondary" onclick="applyBulkSettings()">
                    <i class="fas fa-cog"></i>
                    إعدادات جماعية
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ==================== Course Item Template (يستخدم في JavaScript) ==================== -->
<template id="courseItemTemplate">
    <div class="course-item" draggable="true">
        <div class="item-header">
            <div class="item-type-badge">
                <i class="fas fa-graduation-cap"></i>
                <span>دورة</span>
            </div>
            <button class="item-action-btn add-btn">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        
        <div class="item-thumbnail">
            <img src="" alt="">
            <div class="item-price">
                <span class="price-value">0</span>
                <span class="price-currency">ريال</span>
            </div>
        </div>
        
        <div class="item-content">
            <h4 class="item-title"></h4>
            <p class="item-instructor">
                <i class="fas fa-user-tie"></i>
                <span></span>
            </p>
            <div class="item-meta">
                <span class="meta-item">
                    <i class="fas fa-clock"></i>
                    <span class="duration"></span>
                </span>
                <span class="meta-item">
                    <i class="fas fa-users"></i>
                    <span class="students-count"></span>
                </span>
            </div>
        </div>
    </div>
</template>

<!-- ==================== Assigned Item Template ==================== -->
<template id="assignedItemTemplate">
    <div class="assigned-item">
        <div class="assigned-item-header">
            <div class="assigned-item-info">
                <div class="item-type-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div>
                    <h4 class="assigned-item-title"></h4>
                    <p class="assigned-item-type"></p>
                </div>
            </div>
            <button class="remove-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="assigned-item-settings">
            <!-- تواريخ الوصول -->
            <div class="setting-group">
                <label class="setting-label">
                    <i class="fas fa-calendar-alt"></i>
                    فترة الوصول
                </label>
                <div class="date-inputs">
                    <input type="date" class="date-input start-date" placeholder="تاريخ البداية">
                    <span class="date-separator">إلى</span>
                    <input type="date" class="date-input end-date" placeholder="تاريخ النهاية">
                </div>
            </div>
            
            <!-- نوع الوصول -->
            <div class="setting-group">
                <label class="setting-label">
                    <i class="fas fa-key"></i>
                    نوع الوصول
                </label>
                <select class="setting-select access-type">
                    <option value="full">وصول كامل</option>
                    <option value="limited">وصول محدود</option>
                    <option value="preview">معاينة فقط</option>
                </select>
            </div>
            
            <!-- السعر المخصص -->
            <div class="setting-group">
                <label class="setting-label">
                    <i class="fas fa-tag"></i>
                    السعر المخصص
                </label>
                <div class="price-input-group">
                    <input type="number" class="price-input" placeholder="0" min="0">
                    <select class="currency-select">
                        <option value="SAR">ريال سعودي</option>
                        <option value="EGP">جنيه مصري</option>
                        <option value="USD">دولار أمريكي</option>
                    </select>
                    <label class="checkbox-label">
                        <input type="checkbox" class="free-checkbox">
                        <span>مجاني</span>
                    </label>
                </div>
            </div>
            
            <!-- ملاحظات -->
            <div class="setting-group">
                <label class="setting-label">
                    <i class="fas fa-sticky-note"></i>
                    ملاحظات
                </label>
                <textarea class="setting-textarea" rows="2" placeholder="ملاحظات خاصة بهذا التخصيص..."></textarea>
            </div>
        </div>
    </div>
</template>

<!-- ==================== Bulk Settings Modal ==================== -->
<div class="modal" id="bulkSettingsModal" style="display: none;">
    <div class="modal-backdrop" onclick="closeBulkSettings()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-cogs"></i>
                إعدادات جماعية
            </h3>
            <button class="modal-close" onclick="closeBulkSettings()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <p class="modal-description">ستطبق هذه الإعدادات على جميع الدورات والمسارات المخصصة</p>
            
            <div class="bulk-settings-form">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-calendar-alt"></i>
                        فترة الوصول الافتراضية
                    </label>
                    <div class="duration-input">
                        <input type="number" id="bulkDuration" value="90" min="1">
                        <select id="bulkDurationUnit">
                            <option value="days">يوم</option>
                            <option value="weeks">أسبوع</option>
                            <option value="months" selected>شهر</option>
                            <option value="years">سنة</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-key"></i>
                        نوع الوصول
                    </label>
                    <select class="form-control" id="bulkAccessType">
                        <option value="full">وصول كامل</option>
                        <option value="limited">وصول محدود</option>
                        <option value="preview">معاينة فقط</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-percent"></i>
                        نسبة الخصم
                    </label>
                    <div class="discount-input">
                        <input type="number" id="bulkDiscount" placeholder="0" min="0" max="100">
                        <span class="discount-symbol">%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeBulkSettings()">
                إلغاء
            </button>
            <button class="btn btn-primary" onclick="applyBulkSettingsConfirm()">
                <i class="fas fa-check"></i>
                تطبيق على الكل
            </button>
        </div>
    </div>
</div>

<!-- ==================== Additional CSS for Courses Tab ==================== -->
<style>
    /* ==================== Search & Filter Section ==================== */
    .search-filter-section {
        display: flex;
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
        flex-wrap: wrap;
    }

    .search-box {
        flex: 1;
        position: relative;
        min-width: 300px;
    }

    .search-icon {
        position: absolute;
        right: var(--spacing-md);
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        pointer-events: none;
    }

    .search-input {
        width: 100%;
        padding: var(--spacing-md) var(--spacing-3xl);
        background: var(--lighter);
        border: 2px solid var(--border);
        border-radius: var(--radius-xl);
        color: var(--text);
        font-size: var(--font-base);
        transition: var(--transition);
    }

    .search-input:focus {
        border-color: var(--primary);
        background: rgba(var(--primary-rgb), 0.05);
    }

    .search-clear {
        position: absolute;
        left: var(--spacing-md);
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        transition: var(--transition);
    }

    .search-clear:hover {
        background: var(--dark);
        color: var(--text);
    }

    /* ==================== Filter Buttons ==================== */
    .filter-buttons {
        display: flex;
        gap: var(--spacing-sm);
        flex-wrap: wrap;
    }

    .filter-btn {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--lighter);
        border: 2px solid var(--border);
        border-radius: var(--radius-xl);
        color: var(--text-muted);
        cursor: pointer;
        transition: var(--transition);
        white-space: nowrap;
    }

    .filter-btn:hover {
        border-color: var(--primary);
        color: var(--text);
    }

    .filter-btn.active {
        background: var(--primary);
        border-color: var(--primary);
        color: var(--dark);
    }

    .filter-count {
        background: var(--dark);
        color: var(--text);
        padding: 2px 8px;
        border-radius: var(--radius-xl);
        font-size: var(--font-sm);
        font-weight: 600;
    }

    .filter-btn.active .filter-count {
        background: var(--dark);
        color: var(--primary);
    }

    /* ==================== Assignment Container ==================== */
    .course-assignment-container {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
        min-height: 600px;
    }

    .assignment-column {
        background: var(--lighter);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        display: flex;
        flex-direction: column;
    }

    .column-header {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: var(--spacing-md);
    }

    .column-title {
        font-size: var(--font-lg);
        color: var(--text);
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .column-actions,
    .column-stats {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .sort-select {
        padding: var(--spacing-xs) var(--spacing-sm);
        background: var(--dark);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text);
        font-size: var(--font-sm);
        cursor: pointer;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: var(--font-sm);
        color: var(--text-muted);
    }

    /* ==================== Items Container ==================== */
    .items-container {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-lg);
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: var(--spacing-lg);
        align-content: start;
    }

    .assigned-items {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
        grid-template-columns: 1fr;
    }

    /* ==================== Loading & Empty States ==================== */
    .loading-state,
    .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: var(--spacing-3xl);
        color: var(--text-muted);
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 3px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        margin: 0 auto var(--spacing-lg);
        animation: spin 1s linear infinite;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: var(--spacing-md);
        opacity: 0.5;
    }

    .empty-state p {
        font-size: var(--font-lg);
        margin-bottom: var(--spacing-sm);
    }

    .empty-state span {
        font-size: var(--font-sm);
    }

    /* ==================== Course Item ==================== */
    .course-item {
        background: var(--dark);
        border-radius: var(--radius-lg);
        overflow: hidden;
        cursor: move;
        transition: var(--transition);
        display: flex;
        flex-direction: column;
    }

    .course-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .course-item.dragging {
        opacity: 0.5;
        transform: rotate(2deg);
    }

    .item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-sm) var(--spacing-md);
        background: rgba(0, 0, 0, 0.2);
    }

    .item-type-badge {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: var(--font-sm);
        color: var(--text-muted);
    }

    .item-type-badge.path {
        color: var(--secondary);
    }

    .item-action-btn {
        background: var(--primary);
        border: none;
        color: var(--dark);
        width: 28px;
        height: 28px;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
    }

    .item-action-btn:hover {
        transform: scale(1.1);
    }

    .item-action-btn.remove-btn {
        background: var(--danger);
        color: white;
    }

    .item-thumbnail {
        position: relative;
        height: 140px;
        overflow: hidden;
        background: var(--lighter);
    }

    .item-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .item-price {
        position: absolute;
        top: var(--spacing-sm);
        left: var(--spacing-sm);
        background: var(--primary);
        color: var(--dark);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-sm);
        font-weight: 600;
        font-size: var(--font-sm);
    }

    .item-content {
        padding: var(--spacing-md);
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .item-title {
        font-size: var(--font-base);
        font-weight: 600;
        margin-bottom: var(--spacing-sm);
        color: var(--text);
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .item-instructor {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: var(--font-sm);
        color: var(--text-muted);
        margin-bottom: var(--spacing-md);
    }

    .item-meta {
        display: flex;
        justify-content: space-between;
        margin-top: auto;
        padding-top: var(--spacing-sm);
        border-top: 1px solid var(--border);
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: var(--font-sm);
        color: var(--text-muted);
    }

    /* ==================== Drag & Drop Area ==================== */
    .drag-drop-area {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .drop-zone {
        padding: var(--spacing-xl);
        border: 3px dashed var(--border);
        border-radius: var(--radius-lg);
        text-align: center;
        color: var(--text-muted);
        transition: var(--transition);
    }

    .drop-zone i {
        font-size: 2rem;
        margin-bottom: var(--spacing-sm);
        display: block;
    }

    .drop-zone p {
        margin-bottom: var(--spacing-xs);
        font-weight: 500;
    }

    .drop-zone span {
        font-size: var(--font-sm);
    }

    .drop-zone.drag-over {
        border-color: var(--primary);
        background: rgba(var(--primary-rgb), 0.1);
        color: var(--primary);
    }

    /* ==================== Assigned Item ==================== */
    .assigned-item {
        background: var(--dark);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        border: 1px solid var(--border);
        transition: var(--transition);
    }

    .assigned-item:hover {
        border-color: var(--primary);
    }

    .assigned-item-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: var(--spacing-lg);
    }

    .assigned-item-info {
        display: flex;
        gap: var(--spacing-md);
        align-items: start;
    }

    .item-type-icon {
        width: 40px;
        height: 40px;
        background: var(--lighter);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary);
        font-size: var(--font-lg);
        flex-shrink: 0;
    }

    .assigned-item-title {
        font-size: var(--font-base);
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
        color: var(--text);
    }

    .assigned-item-type {
        font-size: var(--font-sm);
        color: var(--text-muted);
        margin: 0;
    }

    .remove-btn {
        background: var(--danger);
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
    }

    .remove-btn:hover {
        background: var(--danger-dark);
        transform: scale(1.1);
    }

    /* ==================== Assigned Item Settings ==================== */
    .assigned-item-settings {
        display: grid;
        gap: var(--spacing-md);
    }

    .setting-group {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
    }

    .setting-label {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: var(--font-sm);
        font-weight: 500;
        color: var(--text);
    }

    .date-inputs {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .date-input {
        flex: 1;
        padding: var(--spacing-sm);
        background: var(--lighter);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text);
        font-size: var(--font-sm);
    }

    .date-separator {
        color: var(--text-muted);
        font-size: var(--font-sm);
    }

    .setting-select {
        padding: var(--spacing-sm);
        background: var(--lighter);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text);
        font-size: var(--font-sm);
        cursor: pointer;
    }

    .price-input-group {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .price-input {
        flex: 1;
        padding: var(--spacing-sm);
        background: var(--lighter);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text);
        font-size: var(--font-sm);
    }

    .currency-select {
        padding: var(--spacing-sm);
        background: var(--lighter);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text);
        font-size: var(--font-sm);
        cursor: pointer;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
    }

    .setting-textarea {
        padding: var(--spacing-sm);
        background: var(--lighter);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text);
        font-size: var(--font-sm);
        font-family: inherit;
        resize: vertical;
    }

    /* ==================== Bulk Actions ==================== */
    .bulk-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-lg);
        background: var(--lighter);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
    }

    .bulk-actions-left,
    .bulk-actions-right {
        display: flex;
        gap: var(--spacing-md);
    }

    /* ==================== Modal ==================== */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: var(--z-modal);
        animation: fadeIn 0.3s ease;
    }

    .modal-backdrop {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
    }

    .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--dark);
        border-radius: var(--radius-lg);
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        animation: slideIn 0.3s ease;
    }

    .modal-header {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: var(--font-xl);
        color: var(--primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .modal-close {
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: var(--font-xl);
        cursor: pointer;
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        transition: var(--transition);
    }

    .modal-close:hover {
        background: var(--lighter);
        color: var(--text);
    }

    .modal-body {
        padding: var(--spacing-lg);
        overflow-y: auto;
        flex: 1;
    }

    .modal-description {
        color: var(--text-muted);
        margin-bottom: var(--spacing-lg);
    }

    .modal-footer {
        padding: var(--spacing-lg);
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-md);
    }

    /* ==================== Bulk Settings Form ==================== */
    .duration-input {
        display: flex;
        gap: var(--spacing-sm);
    }

    .duration-input input {
        flex: 1;
    }

    .discount-input {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .discount-symbol {
        font-size: var(--font-lg);
        color: var(--text-muted);
    }

    /* ==================== Responsive ==================== */
    @media (max-width: 1200px) {
        .course-assignment-container {
            grid-template-columns: 1fr;
            gap: var(--spacing-lg);
        }

        .drag-drop-area {
            display: none;
        }
    }

    @media (max-width: 768px) {
        .search-filter-section {
            flex-direction: column;
        }

        .search-box {
            min-width: 100%;
        }

        .filter-buttons {
            justify-content: center;
        }

        .items-container {
            grid-template-columns: 1fr;
        }

        .bulk-actions {
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .bulk-actions-left,
        .bulk-actions-right {
            width: 100%;
            justify-content: center;
        }
    }
</style>
<!-- ==================== Advanced Info Tab Panel ==================== -->
<div class="tab-panel" id="advancedPanel" role="tabpanel" aria-labelledby="advancedTab">
    <div class="panel-header">
        <h2 class="panel-title">
            <i class="fas fa-cogs"></i>
            المعلومات المتقدمة
        </h2>
        <p class="panel-description">أضف معلومات إضافية وحقول مخصصة للمستخدم</p>
    </div>

    <div class="panel-content">
        <!-- Personal Information Section -->
        <div class="info-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-user-circle"></i>
                    المعلومات الشخصية
                </h3>
                <button class="section-toggle" onclick="toggleSection('personal')">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
            
            <div class="section-content" id="personalContent">
                <div class="form-grid-3">
                    <div class="form-group">
                        <label class="form-label" for="birthDate">
                            <i class="fas fa-birthday-cake"></i>
                            تاريخ الميلاد
                        </label>
                        <input type="date" class="form-control" id="birthDate">
                        <div class="form-hint">سيستخدم لإرسال التهنئة</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="gender">
                            <i class="fas fa-venus-mars"></i>
                            الجنس
                        </label>
                        <select class="form-control" id="gender">
                            <option value="">-- اختر --</option>
                            <option value="male">ذكر</option>
                            <option value="female">أنثى</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="nationality">
                            <i class="fas fa-flag"></i>
                            الجنسية
                        </label>
                        <select class="form-control" id="nationality">
                            <option value="">-- اختر --</option>
                            <option value="EG">مصري</option>
                            <option value="SA">سعودي</option>
                            <option value="AE">إماراتي</option>
                            <option value="KW">كويتي</option>
                            <option value="QA">قطري</option>
                            <option value="OM">عماني</option>
                            <option value="BH">بحريني</option>
                            <option value="JO">أردني</option>
                            <option value="LB">لبناني</option>
                            <option value="PS">فلسطيني</option>
                            <option value="SY">سوري</option>
                            <option value="IQ">عراقي</option>
                            <option value="MA">مغربي</option>
                            <option value="DZ">جزائري</option>
                            <option value="TN">تونسي</option>
                            <option value="LY">ليبي</option>
                            <option value="SD">سوداني</option>
                            <option value="YE">يمني</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Information Section -->
        <div class="info-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-address-card"></i>
                    معلومات التواصل
                </h3>
                <button class="section-toggle" onclick="toggleSection('contact')">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
            
            <div class="section-content" id="contactContent">
                <div class="form-grid-2">
                    <div class="form-group">
                        <label class="form-label" for="country">
                            <i class="fas fa-globe"></i>
                            الدولة
                        </label>
                        <select class="form-control" id="country">
                            <option value="">-- اختر الدولة --</option>
                            <!-- سيتم ملؤها بواسطة JavaScript -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="city">
                            <i class="fas fa-city"></i>
                            المدينة
                        </label>
                        <input type="text" class="form-control" id="city" placeholder="أدخل المدينة">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="timezone">
                            <i class="fas fa-clock"></i>
                            المنطقة الزمنية
                        </label>
                        <select class="form-control" id="timezone">
                            <option value="">-- اختر المنطقة الزمنية --</option>
                            <option value="Africa/Cairo">توقيت القاهرة (GMT+2)</option>
                            <option value="Asia/Riyadh">توقيت الرياض (GMT+3)</option>
                            <option value="Asia/Dubai">توقيت دبي (GMT+4)</option>
                            <option value="Asia/Kuwait">توقيت الكويت (GMT+3)</option>
                            <option value="Asia/Qatar">توقيت الدوحة (GMT+3)</option>
                            <option value="Asia/Muscat">توقيت مسقط (GMT+4)</option>
                            <option value="Asia/Bahrain">توقيت المنامة (GMT+3)</option>
                            <option value="Asia/Amman">توقيت عمّان (GMT+2)</option>
                            <option value="Asia/Beirut">توقيت بيروت (GMT+2)</option>
                            <option value="Asia/Jerusalem">توقيت القدس (GMT+2)</option>
                            <option value="Asia/Damascus">توقيت دمشق (GMT+2)</option>
                            <option value="Asia/Baghdad">توقيت بغداد (GMT+3)</option>
                            <option value="Africa/Casablanca">توقيت الدار البيضاء (GMT+1)</option>
                            <option value="Africa/Algiers">توقيت الجزائر (GMT+1)</option>
                            <option value="Africa/Tunis">توقيت تونس (GMT+1)</option>
                            <option value="Africa/Tripoli">توقيت طرابلس (GMT+2)</option>
                            <option value="Africa/Khartoum">توقيت الخرطوم (GMT+2)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="language">
                            <i class="fas fa-language"></i>
                            اللغة المفضلة
                        </label>
                        <select class="form-control" id="language">
                            <option value="ar">العربية</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="address">
                        <i class="fas fa-map-marker-alt"></i>
                        العنوان التفصيلي
                    </label>
                    <textarea class="form-control" id="address" rows="2" placeholder="أدخل العنوان الكامل..."></textarea>
                </div>
            </div>
        </div>

        <!-- Professional Information Section -->
        <div class="info-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-briefcase"></i>
                    المعلومات المهنية
                </h3>
                <button class="section-toggle" onclick="toggleSection('professional')">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
            
            <div class="section-content" id="professionalContent">
                <div class="form-grid-2">
                    <div class="form-group">
                        <label class="form-label" for="occupation">
                            <i class="fas fa-user-tie"></i>
                            المهنة/الوظيفة
                        </label>
                        <input type="text" class="form-control" id="occupation" placeholder="مثال: مدير تسويق">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="company">
                            <i class="fas fa-building"></i>
                            الشركة/المؤسسة
                        </label>
                        <input type="text" class="form-control" id="company" placeholder="اسم الشركة">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="education">
                            <i class="fas fa-graduation-cap"></i>
                            المستوى التعليمي
                        </label>
                        <select class="form-control" id="education">
                            <option value="">-- اختر --</option>
                            <option value="high-school">ثانوية عامة</option>
                            <option value="diploma">دبلوم</option>
                            <option value="bachelor">بكالوريوس</option>
                            <option value="master">ماجستير</option>
                            <option value="phd">دكتوراه</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="experience">
                            <i class="fas fa-award"></i>
                            سنوات الخبرة
                        </label>
                        <select class="form-control" id="experience">
                            <option value="">-- اختر --</option>
                            <option value="0-1">أقل من سنة</option>
                            <option value="1-3">1-3 سنوات</option>
                            <option value="3-5">3-5 سنوات</option>
                            <option value="5-10">5-10 سنوات</option>
                            <option value="10+">أكثر من 10 سنوات</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="interests">
                        <i class="fas fa-heart"></i>
                        الاهتمامات
                    </label>
                    <div class="tags-input" id="interestsContainer">
                        <input type="text" 
                               class="tag-input" 
                               id="interestsInput" 
                               placeholder="اكتب اهتمام واضغط Enter">
                        <div class="tags-list" id="interestsTags"></div>
                    </div>
                    <div class="form-hint">مثال: التسويق الرقمي، التطوير الشخصي، ريادة الأعمال</div>
                </div>
            </div>
        </div>

        <!-- Notification Preferences Section -->
        <div class="info-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-bell"></i>
                    تفضيلات الإشعارات
                </h3>
                <button class="section-toggle" onclick="toggleSection('notifications')">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
            
            <div class="section-content" id="notificationsContent">
                <div class="notification-preferences">
                    <div class="notification-group">
                        <h4 class="notification-title">
                            <i class="fas fa-envelope"></i>
                            البريد الإلكتروني
                        </h4>
                        <div class="notification-options">
                            <label class="switch-item">
                                <input type="checkbox" id="emailNewCourse" checked>
                                <span class="switch-slider"></span>
                                <span class="switch-label">دورات جديدة</span>
                            </label>
                            <label class="switch-item">
                                <input type="checkbox" id="emailReminders" checked>
                                <span class="switch-slider"></span>
                                <span class="switch-label">تذكيرات الدروس</span>
                            </label>
                            <label class="switch-item">
                                <input type="checkbox" id="emailPromotions">
                                <span class="switch-slider"></span>
                                <span class="switch-label">العروض والخصومات</span>
                            </label>
                            <label class="switch-item">
                                <input type="checkbox" id="emailNewsletter">
                                <span class="switch-slider"></span>
                                <span class="switch-label">النشرة الإخبارية</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="notification-group">
                        <h4 class="notification-title">
                            <i class="fab fa-whatsapp"></i>
                            WhatsApp
                        </h4>
                        <div class="notification-options">
                            <label class="switch-item">
                                <input type="checkbox" id="whatsappReminders" checked>
                                <span class="switch-slider"></span>
                                <span class="switch-label">تذكيرات مهمة</span>
                            </label>
                            <label class="switch-item">
                                <input type="checkbox" id="whatsappSupport" checked>
                                <span class="switch-slider"></span>
                                <span class="switch-label">رسائل الدعم</span>
                            </label>
                            <label class="switch-item">
                                <input type="checkbox" id="whatsappProgress">
                                <span class="switch-slider"></span>
                                <span class="switch-label">تقارير التقدم</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Fields Section -->
        <div class="info-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-plus-circle"></i>
                    الحقول المخصصة
                </h3>
                <button class="btn btn-sm btn-primary" onclick="addCustomField()">
                    <i class="fas fa-plus"></i>
                    إضافة حقل
                </button>
            </div>
            
            <div class="section-content">
                <div class="custom-fields-container" id="customFieldsContainer">
                    <!-- سيتم إضافة الحقول المخصصة هنا -->
                </div>
                
                <div class="empty-custom-fields" id="emptyCustomFields">
                    <i class="fas fa-folder-open"></i>
                    <p>لا توجد حقول مخصصة</p>
                    <span>انقر على "إضافة حقل" لإنشاء حقل جديد</span>
                </div>
            </div>
        </div>

        <!-- Admin Notes Section -->
        <div class="info-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-sticky-note"></i>
                    ملاحظات الإدارة
                </h3>
                <button class="section-toggle" onclick="toggleSection('adminNotes')">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
            
            <div class="section-content" id="adminNotesContent">
                <div class="admin-notes-editor">
                    <div class="editor-toolbar">
                        <button class="editor-btn" onclick="formatText('bold')">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button class="editor-btn" onclick="formatText('italic')">
                            <i class="fas fa-italic"></i>
                        </button>
                        <button class="editor-btn" onclick="formatText('underline')">
                            <i class="fas fa-underline"></i>
                        </button>
                        <div class="editor-separator"></div>
                        <button class="editor-btn" onclick="formatText('insertUnorderedList')">
                            <i class="fas fa-list-ul"></i>
                        </button>
                        <button class="editor-btn" onclick="formatText('insertOrderedList')">
                            <i class="fas fa-list-ol"></i>
                        </button>
                        <div class="editor-separator"></div>
                        <button class="editor-btn" onclick="insertLink()">
                            <i class="fas fa-link"></i>
                        </button>
                        <button class="editor-btn" onclick="insertHighlight()">
                            <i class="fas fa-highlighter"></i>
                        </button>
                    </div>
                    <div class="editor-content" id="adminNotesEditor" contenteditable="true" placeholder="اكتب ملاحظاتك هنا..."></div>
                </div>
                
                <div class="notes-metadata">
                    <div class="metadata-item">
                        <i class="fas fa-user"></i>
                        <span>آخر تعديل بواسطة: <strong id="lastEditedBy">-</strong></span>
                    </div>
                    <div class="metadata-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span>تاريخ آخر تعديل: <strong id="lastEditedDate">-</strong></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Timeline Section -->
        <div class="info-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-history"></i>
                    سجل النشاطات
                </h3>
                <button class="section-toggle" onclick="toggleSection('activity')">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
            
            <div class="section-content" id="activityContent">
                <div class="activity-timeline">
                    <div class="timeline-item">
                        <div class="timeline-icon" style="background: var(--success);">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="timeline-content">
                            <h5 class="timeline-title">إنشاء الحساب</h5>
                            <p class="timeline-description">تم إنشاء حساب المستخدم</p>
                            <span class="timeline-date">
                                <i class="fas fa-clock"></i>
                                الآن
                            </span>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-outline w-100 mt-3" onclick="loadMoreActivity()">
                    <i class="fas fa-sync"></i>
                    تحميل المزيد
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ==================== Custom Field Modal ==================== -->
<div class="modal" id="customFieldModal" style="display: none;">
    <div class="modal-backdrop" onclick="closeCustomFieldModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-plus-circle"></i>
                إضافة حقل مخصص
            </h3>
            <button class="modal-close" onclick="closeCustomFieldModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label required" for="fieldLabel">
                    <i class="fas fa-tag"></i>
                    اسم الحقل
                </label>
                <input type="text" class="form-control" id="fieldLabel" placeholder="مثال: رقم الهوية">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="fieldType">
                    <i class="fas fa-list"></i>
                    نوع الحقل
                </label>
                <select class="form-control" id="fieldType">
                    <option value="text">نص</option>
                    <option value="number">رقم</option>
                    <option value="email">بريد إلكتروني</option>
                    <option value="date">تاريخ</option>
                    <option value="select">قائمة منسدلة</option>
                    <option value="textarea">نص طويل</option>
                    <option value="checkbox">مربع اختيار</option>
                </select>
            </div>
            
            <div class="form-group" id="fieldOptionsGroup" style="display: none;">
                <label class="form-label" for="fieldOptions">
                    <i class="fas fa-list-ul"></i>
                    خيارات القائمة
                </label>
                <textarea class="form-control" id="fieldOptions" rows="4" placeholder="خيار 1&#10;خيار 2&#10;خيار 3"></textarea>
                <div class="form-hint">اكتب كل خيار في سطر منفصل</div>
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="fieldRequired">
                    <span>حقل مطلوب</span>
                </label>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeCustomFieldModal()">
                إلغاء
            </button>
            <button class="btn btn-primary" onclick="saveCustomField()">
                <i class="fas fa-check"></i>
                إضافة الحقل
            </button>
        </div>
    </div>
</div>

<!-- ==================== Additional CSS for Advanced Tab ==================== -->
<style>
    /* ==================== Info Sections ==================== */
    .info-section {
        background: var(--lighter);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        margin-bottom: var(--spacing-xl);
        overflow: hidden;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-lg);
        background: var(--dark);
        border-bottom: 1px solid var(--border);
    }

    .section-toggle {
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: var(--font-lg);
        cursor: pointer;
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        transition: var(--transition);
    }

    .section-toggle:hover {
        background: var(--lighter);
        color: var(--primary);
    }

    .section-toggle i {
        transition: var(--transition);
    }

    .section-content {
        padding: var(--spacing-lg);
    }

    .section-content.collapsed {
        display: none;
    }

    .section-header.collapsed .section-toggle i {
        transform: rotate(180deg);
    }

    /* ==================== Form Grids ==================== */
    .form-grid-2 {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-lg);
    }

    .form-grid-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-lg);
    }

    /* ==================== Tags Input ==================== */
    .tags-input {
        background: var(--dark);
        border: 2px solid var(--border);
        border-radius: var(--radius-sm);
        padding: var(--spacing-sm);
        min-height: 120px;
        position: relative;
    }

    .tag-input {
        background: none;
        border: none;
        color: var(--text);
        font-size: var(--font-base);
        width: 100%;
        padding: var(--spacing-sm);
    }

    .tag-input:focus {
        outline: none;
    }

    .tags-list {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-sm);
    }

    .tag-item {
        background: var(--primary);
        color: var(--dark);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-xl);
        font-size: var(--font-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        animation: fadeIn 0.3s ease;
    }

    .tag-item button {
        background: none;
        border: none;
        color: var(--dark);
        cursor: pointer;
        padding: 0;
        margin-right: var(--spacing-xs);
        font-size: var(--font-sm);
    }

    .tag-item button:hover {
        color: var(--danger);
    }

    /* ==================== Notification Preferences ==================== */
    .notification-preferences {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--spacing-xl);
    }

    .notification-group {
        background: var(--dark);
        padding: var(--spacing-lg);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
    }

    .notification-title {
        font-size: var(--font-lg);
        margin-bottom: var(--spacing-lg);
        color: var(--text);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .notification-options {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }

    /* ==================== Switch Item ==================== */
    .switch-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        cursor: pointer;
        user-select: none;
    }

    .switch-item input[type="checkbox"] {
        position: absolute;
        opacity: 0;
    }

    .switch-slider {
        width: 44px;
        height: 24px;
        background: var(--lighter);
        border-radius: 24px;
        position: relative;
        transition: var(--transition);
    }

    .switch-slider::after {
        content: '';
        position: absolute;
        width: 18px;
        height: 18px;
        background: var(--text-muted);
        border-radius: 50%;
        top: 3px;
        right: 23px;
        transition: var(--transition);
    }

    .switch-item input[type="checkbox"]:checked ~ .switch-slider {
        background: var(--primary);
    }

    .switch-item input[type="checkbox"]:checked ~ .switch-slider::after {
        right: 3px;
        background: white;
    }

    .switch-label {
        color: var(--text);
        font-size: var(--font-base);
    }

    /* ==================== Custom Fields ==================== */
    .custom-fields-container {
        display: grid;
        gap: var(--spacing-md);
    }

    .custom-field-item {
        background: var(--dark);
        padding: var(--spacing-md);
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        animation: slideIn 0.3s ease;
    }

    .custom-field-icon {
        width: 40px;
        height: 40px;
        background: var(--lighter);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary);
        flex-shrink: 0;
    }

    .custom-field-content {
        flex: 1;
    }

    .custom-field-label {
        font-weight: 500;
        color: var(--text);
        margin-bottom: var(--spacing-xs);
    }

    .custom-field-type {
        font-size: var(--font-sm);
        color: var(--text-muted);
    }

    .custom-field-remove {
        background: var(--danger);
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
    }

    .custom-field-remove:hover {
        background: var(--danger-dark);
        transform: scale(1.1);
    }

    .empty-custom-fields {
        text-align: center;
        padding: var(--spacing-2xl);
        color: var(--text-muted);
    }

    .empty-custom-fields i {
        font-size: 3rem;
        margin-bottom: var(--spacing-md);
        opacity: 0.5;
    }

    .empty-custom-fields p {
        font-size: var(--font-lg);
        margin-bottom: var(--spacing-sm);
    }

    /* ==================== Admin Notes Editor ==================== */
    .admin-notes-editor {
        background: var(--dark);
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        overflow: hidden;
    }

    .editor-toolbar {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-sm);
        background: var(--lighter);
        border-bottom: 1px solid var(--border);
    }

    .editor-btn {
        background: none;
        border: none;
        color: var(--text-muted);
        width: 32px;
        height: 32px;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
    }

    .editor-btn:hover {
        background: var(--dark);
        color: var(--primary);
    }

    .editor-btn.active {
        background: var(--primary);
        color: var(--dark);
    }

    .editor-separator {
        width: 1px;
        height: 20px;
        background: var(--border);
        margin: 0 var(--spacing-xs);
    }

    .editor-content {
        padding: var(--spacing-lg);
        min-height: 150px;
        max-height: 300px;
        overflow-y: auto;
        color: var(--text);
        line-height: 1.6;
    }

    .editor-content:focus {
        outline: none;
    }

    .editor-content[contenteditable="true"]:empty::before {
        content: attr(placeholder);
        color: var(--text-muted);
        pointer-events: none;
    }

    .notes-metadata {
        display: flex;
        justify-content: space-between;
        margin-top: var(--spacing-md);
        padding-top: var(--spacing-md);
        border-top: 1px solid var(--border);
        font-size: var(--font-sm);
        color: var(--text-muted);
    }

    .metadata-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    /* ==================== Activity Timeline ==================== */
    .activity-timeline {
        position: relative;
        padding-right: var(--spacing-xl);
    }

    .activity-timeline::before {
        content: '';
        position: absolute;
        right: 16px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border);
    }

    .timeline-item {
        position: relative;
        margin-bottom: var(--spacing-xl);
        animation: slideIn 0.3s ease;
    }

    .timeline-icon {
        position: absolute;
        right: 0;
        width: 32px;
        height: 32px;
        background: var(--primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        border: 3px solid var(--lighter);
    }

    .timeline-content {
        background: var(--dark);
        padding: var(--spacing-md);
        border-radius: var(--radius-sm);
        margin-right: var(--spacing-3xl);
        border: 1px solid var(--border);
    }

    .timeline-title {
        font-size: var(--font-base);
        font-weight: 600;
        color: var(--text);
        margin-bottom: var(--spacing-xs);
    }

    .timeline-description {
        font-size: var(--font-sm);
        color: var(--text-muted);
        margin-bottom: var(--spacing-sm);
    }

    .timeline-date {
        font-size: var(--font-xs);
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    /* ==================== Utilities ==================== */
    .w-100 {
        width: 100%;
    }

    /* ==================== Responsive ==================== */
    @media (max-width: 992px) {
        .form-grid-3 {
            grid-template-columns: 1fr;
        }

        .form-grid-2 {
            grid-template-columns: 1fr;
        }

        .notification-preferences {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .section-header {
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .notes-metadata {
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .editor-toolbar {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    }
</style>
// ==================== Firebase Configuration ====================
const firebaseConfig = {
    apiKey: "AIzaSyDj0bV5gsyRbqpxzW0Zd9wjYmq53-Xdj3w",
    authDomain: "fouad-perspective.firebaseapp.com",
    projectId: "fouad-perspective",
    storageBucket: "fouad-perspective.firebasestorage.app",
    messagingSenderId: "1068763865336",
    appId: "1:1068763865336:web:b791abcd22d536aedd5b0d",
    measurementId: "G-RY1FYVB3Q9"
};

// Initialize Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const db = firebase.firestore();

// ==================== Global Variables ====================
let currentUser = null;
let editMode = false;
let currentUserId = null;
let autoSaveTimer = null;
let formData = {
    basic: {},
    roles: {},
    courses: [],
    advanced: {}
};
let customFields = [];
let availableCourses = [];
let availablePaths = [];

// ==================== Page Initialization ====================
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // التحقق من المصادقة
        await checkAuth();
        
        // التحقق من وضع التحرير
        checkEditMode();
        
        // تهيئة الصفحة
        await initializePage();
        
        // إعداد المستمعين
        setupEventListeners();
        
        // تحميل البيانات
        await loadInitialData();
        
        // إخفاء شاشة التحميل
        hideLoading();
        
    } catch (error) {
        console.error('خطأ في تهيئة الصفحة:', error);
        showError('حدث خطأ في تحميل الصفحة');
    }
});

// ==================== Authentication Functions ====================
async function checkAuth() {
    return new Promise((resolve, reject) => {
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                // التحقق من صلاحيات الأدمن
                if (user.email === 'admin@fouad-academy.com') {
                    resolve();
                } else {
                    window.location.href = '/admin/login.html';
                    reject('ليس لديك صلاحيات الوصول');
                }
            } else {
                window.location.href = '/admin/login.html';
                reject('يجب تسجيل الدخول');
            }
        });
    });
}

// ==================== Edit Mode Functions ====================
function checkEditMode() {
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('id');
    
    if (userId) {
        editMode = true;
        currentUserId = userId;
        updatePageForEditMode();
    }
}

function updatePageForEditMode() {
    // تحديث العنوان
    document.getElementById('pageMode').textContent = 'تعديل بيانات المستخدم';
    document.getElementById('pageTitleText').textContent = 'تعديل بيانات المستخدم';
    document.getElementById('saveBtnText').textContent = 'حفظ التعديلات';
    
    // إخفاء حقول كلمة المرور
    document.getElementById('passwordGroup').style.display = 'none';
    document.getElementById('confirmPasswordGroup').style.display = 'none';
    
    // جعل البريد الإلكتروني للقراءة فقط
    document.getElementById('email').readOnly = true;
    document.getElementById('emailFeedback').textContent = 'لا يمكن تغيير البريد الإلكتروني';
    document.getElementById('emailFeedback').classList.add('show', 'error');
}

// ==================== Page Initialization ====================
async function initializePage() {
    // تهيئة المحرر النصي للملاحظات
    initializeNotesEditor();
    
    // تهيئة اختيار الدول
    await loadCountries();
    
    // تهيئة التبويبات
    initializeTabs();
    
    // تهيئة السحب والإفلات
    initializeDragAndDrop();
}

// ==================== Load Initial Data ====================
async function loadInitialData() {
    try {
        showLoading('جاري تحميل البيانات...');
        
        // تحميل الدورات والمسارات المتاحة
        await loadAvailableContent();
        
        // إذا كان في وضع التعديل، تحميل بيانات المستخدم
        if (editMode && currentUserId) {
            await loadUserData(currentUserId);
        }
        
    } catch (error) {
        console.error('خطأ في تحميل البيانات:', error);
        showError('حدث خطأ في تحميل البيانات');
    }
}

// ==================== Load User Data for Edit ====================
async function loadUserData(userId) {
    try {
        // محاولة جلب البيانات من مجموعة users
        let userData = null;
        const userDoc = await db.collection('users').doc(userId).get();
        
        if (userDoc.exists) {
            userData = { id: userDoc.id, ...userDoc.data() };
        } else {
            // البحث بالبريد الإلكتروني
            const usersQuery = await db.collection('users').where('email', '==', userId).limit(1).get();
            if (!usersQuery.empty) {
                userData = { id: usersQuery.docs[0].id, ...usersQuery.docs[0].data() };
                currentUserId = usersQuery.docs[0].id;
            }
        }
        
        if (!userData) {
            throw new Error('المستخدم غير موجود');
        }
        
        // ملء البيانات في النموذج
        fillFormWithUserData(userData);
        
    } catch (error) {
        console.error('خطأ في تحميل بيانات المستخدم:', error);
        showError('حدث خطأ في تحميل بيانات المستخدم');
        setTimeout(() => {
            window.location.href = '/admin/users.html';
        }, 2000);
    }
}

// ==================== Fill Form with User Data ====================
function fillFormWithUserData(userData) {
    // البيانات الأساسية
    if (userData.name) {
        const nameParts = userData.name.split(' ');
        document.getElementById('firstName').value = nameParts[0] || '';
        document.getElementById('lastName').value = nameParts.slice(1).join(' ') || '';
    }
    document.getElementById('email').value = userData.email || '';
    
    // رقم WhatsApp
    if (userData.whatsapp || userData.phone) {
        const phoneNumber = userData.whatsapp || userData.phone;
        const phoneMatch = phoneNumber.match(/^(\+\d{1,4})?(\d+)$/);
        if (phoneMatch) {
            if (phoneMatch[1]) {
                document.getElementById('countryCode').value = phoneMatch[1];
            }
            document.getElementById('phoneNumber').value = phoneMatch[2] || '';
        }
    }
    
    // حالة الحساب
    const accountStatus = userData.isActive === false ? 'inactive' : 
                         userData.status === 'pending' ? 'pending' : 'active';
    document.querySelector(`input[name="accountStatus"][value="${accountStatus}"]`).checked = true;
    
    // الصورة الشخصية
    if (userData.avatar) {
        displayAvatar(userData.avatar);
    }
    
    // الدور الأساسي والصلاحيات
    if (userData.role) {
        document.querySelector(`input[name="primaryRole"][value="${userData.role}"]`).checked = true;
        updatePermissionsForRole(userData.role);
    }
    
    if (userData.permissions) {
        userData.permissions.forEach(permission => {
            const checkbox = document.querySelector(`input[name="permissions"][value="${permission}"]`);
            if (checkbox) checkbox.checked = true;
        });
        updatePermissionsCounts();
    }
    
    // الدورات المخصصة
    if (userData.enrollments) {
        userData.enrollments.forEach(enrollment => {
            const course = availableCourses.find(c => c.id === enrollment.id) || 
                          availablePaths.find(p => p.id === enrollment.id);
            if (course) {
                assignCourse(course, enrollment);
            }
        });
    }
    
    // المعلومات المتقدمة
    fillAdvancedInfo(userData);
}

// ==================== Fill Advanced Information ====================
function fillAdvancedInfo(userData) {
    // المعلومات الشخصية
    if (userData.birthDate) document.getElementById('birthDate').value = userData.birthDate;
    if (userData.gender) document.getElementById('gender').value = userData.gender;
    if (userData.nationality) document.getElementById('nationality').value = userData.nationality;
    
    // معلومات التواصل
    if (userData.country) document.getElementById('country').value = userData.country;
    if (userData.city) document.getElementById('city').value = userData.city;
    if (userData.timezone) document.getElementById('timezone').value = userData.timezone;
    if (userData.language) document.getElementById('language').value = userData.language;
    if (userData.address) document.getElementById('address').value = userData.address;
    
    // المعلومات المهنية
    if (userData.occupation) document.getElementById('occupation').value = userData.occupation;
    if (userData.company) document.getElementById('company').value = userData.company;
    if (userData.education) document.getElementById('education').value = userData.education;
    if (userData.experience) document.getElementById('experience').value = userData.experience;
    
    // الاهتمامات
    if (userData.interests && Array.isArray(userData.interests)) {
        userData.interests.forEach(interest => addInterestTag(interest));
    }
    
    // تفضيلات الإشعارات
    if (userData.notifications) {
        Object.keys(userData.notifications).forEach(key => {
            const checkbox = document.getElementById(key);
            if (checkbox) checkbox.checked = userData.notifications[key];
        });
    }
    
    // الحقول المخصصة
    if (userData.customFields && Array.isArray(userData.customFields)) {
        userData.customFields.forEach(field => addCustomFieldToForm(field));
    }
    
    // ملاحظات الإدارة
    if (userData.adminNotes) {
        document.getElementById('adminNotesEditor').innerHTML = userData.adminNotes;
    }
    
    // معلومات آخر تعديل
    if (userData.lastUpdated) {
        document.getElementById('lastEditedBy').textContent = userData.lastUpdatedBy || 'النظام';
        document.getElementById('lastEditedDate').textContent = formatDate(userData.lastUpdated.toDate());
    }
}

// ==================== Tab Navigation ====================
function initializeTabs() {
    const tabLinks = document.querySelectorAll('.tab-link');
    const tabPanels = document.querySelectorAll('.tab-panel');
    
    tabLinks.forEach(link => {
        link.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            
            // تحديث التبويبات النشطة
            tabLinks.forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            
            // تحديث المحتوى
            tabPanels.forEach(panel => panel.classList.remove('active'));
            document.getElementById(targetTab + 'Panel').classList.add('active');
            
            // تحديث شريط التقدم
            updateProgressBar(targetTab);
            
            // حفظ تلقائي عند تغيير التبويب
            autoSave();
        });
    });
}

// ==================== Progress Bar ====================
function updateProgressBar(currentTab) {
    const tabs = ['basic', 'roles', 'courses', 'advanced'];
    const currentIndex = tabs.indexOf(currentTab);
    const progress = ((currentIndex + 1) / tabs.length) * 100;
    
    document.getElementById('progressFill').style.width = progress + '%';
    
    // تحديث حالة الخطوات
    const steps = document.querySelectorAll('.progress-step');
    steps.forEach((step, index) => {
        if (index <= currentIndex) {
            step.classList.add('active');
        } else {
            step.classList.remove('active');
        }
        
        if (index < currentIndex) {
            step.classList.add('completed');
        } else {
            step.classList.remove('completed');
        }
    });
}

// ==================== Form Validation ====================
function validateBasicInfo() {
    let isValid = true;
    
    // التحقق من الاسم الأول
    const firstName = document.getElementById('firstName').value.trim();
    if (!firstName) {
        showFieldError('firstName', 'الاسم الأول مطلوب');
        isValid = false;
    } else {
        clearFieldError('firstName');
    }
    
    // التحقق من اسم العائلة
    const lastName = document.getElementById('lastName').value.trim();
    if (!lastName) {
        showFieldError('lastName', 'اسم العائلة مطلوب');
        isValid = false;
    } else {
        clearFieldError('lastName');
    }
    
    // التحقق من البريد الإلكتروني
    const email = document.getElementById('email').value.trim();
    if (!email || !isValidEmail(email)) {
        showFieldError('email', 'البريد الإلكتروني غير صحيح');
        isValid = false;
    } else {
        clearFieldError('email');
    }
    
    // التحقق من كلمة المرور (في وضع الإنشاء فقط)
    if (!editMode) {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (!password || password.length < 8) {
            showFieldError('password', 'كلمة المرور يجب أن تكون 8 أحرف على الأقل');
            isValid = false;
        } else {
            clearFieldError('password');
        }
        
        if (password !== confirmPassword) {
            showFieldError('confirmPassword', 'كلمات المرور غير متطابقة');
            isValid = false;
        } else {
            clearFieldError('confirmPassword');
        }
    }
    
    // التحقق من رقم WhatsApp
    const phoneNumber = document.getElementById('phoneNumber').value.trim();
    if (!phoneNumber || !isValidPhone(phoneNumber)) {
        showFieldError('phoneNumber', 'رقم الهاتف غير صحيح');
        isValid = false;
    } else {
        clearFieldError('phoneNumber');
    }
    
    return isValid;
}

// ==================== Helper Functions ====================
function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function isValidPhone(phone) {
    return /^\d{6,15}$/.test(phone);
}

function showFieldError(fieldId, message) {
    const field = document.getElementById(fieldId);
    const feedback = document.getElementById(fieldId + 'Feedback');
    
    field.classList.add('error');
    if (feedback) {
        feedback.textContent = message;
        feedback.classList.add('show', 'error');
    }
}

function clearFieldError(fieldId) {
    const field = document.getElementById(fieldId);
    const feedback = document.getElementById(fieldId + 'Feedback');
    
    field.classList.remove('error');
    if (feedback) {
        feedback.classList.remove('show', 'error');
    }
}

// ==================== Password Functions ====================
function generatePassword() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
    let password = '';
    
    // ضمان تضمين حرف كبير وصغير ورقم ورمز خاص
    password += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'[Math.floor(Math.random() * 26)];
    password += 'abcdefghijklmnopqrstuvwxyz'[Math.floor(Math.random() * 26)];
    password += '0123456789'[Math.floor(Math.random() * 10)];
    password += '!@#$%^&*'[Math.floor(Math.random() * 8)];
    
    // ملء باقي الأحرف
    for (let i = 4; i < 12; i++) {
        password += chars[Math.floor(Math.random() * chars.length)];
    }
    
    // خلط الأحرف
    password = password.split('').sort(() => Math.random() - 0.5).join('');
    
    // وضع كلمة المرور في الحقل
    document.getElementById('password').value = password;
    document.getElementById('password').type = 'text';
    
    // تحديث مؤشر القوة
    checkPasswordStrength(password);
    
    // نسخ كلمة المرور
    navigator.clipboard.writeText(password).then(() => {
        showSuccess('تم توليد ونسخ كلمة المرور');
    });
}

function togglePassword() {
    const passwordInput = document.getElementById('password');
    const toggleIcon = document.getElementById('passwordToggleIcon');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleIcon.classList.remove('fa-eye');
        toggleIcon.classList.add('fa-eye-slash');
    } else {
        passwordInput.type = 'password';
        toggleIcon.classList.remove('fa-eye-slash');
        toggleIcon.classList.add('fa-eye');
    }
}

// ==================== Password Strength Checker ====================
document.getElementById('password')?.addEventListener('input', function() {
    checkPasswordStrength(this.value);
});

function checkPasswordStrength(password) {
    let strength = 0;
    const criteria = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[!@#$%^&*]/.test(password)
    };
    
    // تحديث معايير كلمة المرور
    Object.keys(criteria).forEach(key => {
        const element = document.getElementById(key + 'Criteria');
        if (element) {
            if (criteria[key]) {
                element.classList.add('valid');
                element.querySelector('i').classList.remove('fa-times-circle');
                element.querySelector('i').classList.add('fa-check-circle');
                strength++;
            } else {
                element.classList.remove('valid');
                element.querySelector('i').classList.remove('fa-check-circle');
                element.querySelector('i').classList.add('fa-times-circle');
            }
        }
    });
    
    // تحديث مؤشر القوة
    const strengthFill = document.getElementById('strengthFill');
    const strengthText = document.getElementById('strengthText');
    
    strengthFill.className = 'strength-fill';
    
    if (strength === 0) {
        strengthText.textContent = 'أدخل كلمة المرور';
    } else if (strength <= 2) {
        strengthFill.classList.add('weak');
        strengthText.textContent = 'ضعيفة';
    } else if (strength === 3) {
        strengthFill.classList.add('fair');
        strengthText.textContent = 'متوسطة';
    } else if (strength === 4) {
        strengthFill.classList.add('good');
        strengthText.textContent = 'جيدة';
    } else {
        strengthFill.classList.add('strong');
        strengthText.textContent = 'قوية جداً';
    }
}

// ==================== Avatar Functions ====================
function displayAvatar(src) {
    const avatarImg = document.getElementById('avatarImg');
    const avatarPlaceholder = document.getElementById('avatarPlaceholder');
    const removeBtn = document.getElementById('removeAvatarBtn');
    
    avatarImg.src = src;
    avatarImg.style.display = 'block';
    avatarPlaceholder.style.display = 'none';
    removeBtn.style.display = 'inline-flex';
}

function removeAvatar() {
    const avatarImg = document.getElementById('avatarImg');
    const avatarPlaceholder = document.getElementById('avatarPlaceholder');
    const removeBtn = document.getElementById('removeAvatarBtn');
    const avatarInput = document.getElementById('avatarInput');
    
    avatarImg.src = '';
    avatarImg.style.display = 'none';
    avatarPlaceholder.style.display = 'flex';
    removeBtn.style.display = 'none';
    avatarInput.value = '';
    
    // حذف من البيانات المحفوظة
    if (formData.basic) {
        delete formData.basic.avatar;
    }
}

// ==================== Loading Functions ====================
function showLoading(message = 'جاري التحميل...') {
    const overlay = document.getElementById('loadingOverlay');
    const loadingText = overlay.querySelector('.loading-text');
    
    loadingText.textContent = message;
    overlay.classList.add('active');
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    overlay.classList.remove('active');
}

// ==================== Notification Functions ====================
function showSuccess(message) {
    Swal.fire({
        icon: 'success',
        title: 'نجح',
        text: message,
        timer: 2000,
        showConfirmButton: false,
        toast: true,
        position: 'top-end'
    });
}

function showError(message) {
    Swal.fire({
        icon: 'error',
        title: 'خطأ',
        text: message,
        confirmButtonColor: 'var(--primary)',
        confirmButtonText: 'موافق'
    });
}

function showWarning(message) {
    Swal.fire({
        icon: 'warning',
        title: 'تنبيه',
        text: message,
        confirmButtonColor: 'var(--primary)',
        confirmButtonText: 'موافق'
    });
}

// ==================== Utility Functions ====================
function formatDate(date) {
    if (!date) return '-';
    
    const options = {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    };
    
    return new Intl.DateTimeFormat('ar-SA', options).format(date);
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// ==================== Export Functions for Use in Other Parts ====================
window.UserBuilder = {
    showLoading,
    hideLoading,
    showSuccess,
    showError,
    showWarning,
    validateBasicInfo,
    generatePassword,
    togglePassword,
    displayAvatar,
    removeAvatar,
    formatDate,
    debounce
};
// ==================== Event Listeners Setup ====================
function setupEventListeners() {
    // Avatar Upload
    document.getElementById('avatarInput').addEventListener('change', handleAvatarUpload);
    document.getElementById('avatarPreview').addEventListener('click', () => {
        document.getElementById('avatarInput').click();
    });
    
    // Email Check
    document.getElementById('checkEmailBtn').addEventListener('click', checkEmailAvailability);
    
    // Password Confirmation
    document.getElementById('confirmPassword').addEventListener('input', function() {
        const password = document.getElementById('password').value;
        if (this.value !== password) {
            showFieldError('confirmPassword', 'كلمات المرور غير متطابقة');
        } else {
            clearFieldError('confirmPassword');
        }
    });
    
    // Role Selection
    document.querySelectorAll('input[name="primaryRole"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updatePermissionsForRole(this.value);
        });
    });
    
    // Permissions Toggle
    document.querySelectorAll('input[name="permissions"]').forEach(checkbox => {
        checkbox.addEventListener('change', updatePermissionsCounts);
    });
    
    // Custom Role Toggle
    document.getElementById('enableCustomRole').addEventListener('change', function() {
        const builder = document.getElementById('customRoleBuilder');
        builder.style.display = this.checked ? 'block' : 'none';
    });
    
    // Course Search
    document.getElementById('courseSearchInput').addEventListener('input', 
        debounce(filterCourses, 300)
    );
    
    // Clear Search
    document.getElementById('clearSearch').addEventListener('click', function() {
        document.getElementById('courseSearchInput').value = '';
        filterCourses('');
        this.style.display = 'none';
    });
    
    // Filter Buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            filterByType(this.getAttribute('data-filter'));
        });
    });
    
    // Sort Select
    document.getElementById('sortSelect').addEventListener('change', function() {
        sortCourses(this.value);
    });
    
    // Field Type Change (for custom fields)
    document.getElementById('fieldType').addEventListener('change', function() {
        const optionsGroup = document.getElementById('fieldOptionsGroup');
        optionsGroup.style.display = this.value === 'select' ? 'block' : 'none';
    });
    
    // Interests Input
    document.getElementById('interestsInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const value = this.value.trim();
            if (value) {
                addInterestTag(value);
                this.value = '';
            }
        }
    });
    
    // Color Presets
    document.querySelectorAll('.color-preset').forEach(preset => {
        preset.addEventListener('click', function() {
            const color = this.getAttribute('data-color');
            document.getElementById('customRoleColor').value = color;
        });
    });
    
    // Section Toggles
    window.toggleSection = function(sectionId) {
        const content = document.getElementById(sectionId + 'Content');
        const header = content.previousElementSibling;
        const toggle = header.querySelector('.section-toggle i');
        
        content.classList.toggle('collapsed');
        header.classList.toggle('collapsed');
    };
    
    // Bulk Settings Modal
    window.closeBulkSettings = function() {
        document.getElementById('bulkSettingsModal').style.display = 'none';
    };
    
    // Custom Field Modal
    window.closeCustomFieldModal = function() {
        document.getElementById('customFieldModal').style.display = 'none';
        document.getElementById('fieldLabel').value = '';
        document.getElementById('fieldType').value = 'text';
        document.getElementById('fieldOptions').value = '';
        document.getElementById('fieldRequired').checked = false;
    };
    
    // Form Actions
    document.getElementById('cancelBtn').addEventListener('click', handleCancel);
    document.getElementById('resetBtn').addEventListener('click', handleReset);
    document.getElementById('saveDraftBtn').addEventListener('click', () => saveUser(true));
    document.getElementById('saveBtn').addEventListener('click', () => saveUser(false));
    document.getElementById('quickSaveBtn').addEventListener('click', quickSave);
    
    // Auto-save every 30 seconds
    setInterval(autoSave, 30000);
}

// ==================== Avatar Upload to GitHub ====================
async function handleAvatarUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // التحقق من حجم الملف
    if (file.size > 5 * 1024 * 1024) {
        showError('حجم الصورة يجب أن يكون أقل من 5 ميجابايت');
        return;
    }
    
    // التحقق من نوع الملف
    if (!file.type.startsWith('image/')) {
        showError('يجب أن يكون الملف صورة');
        return;
    }
    
    try {
        showLoading('جاري معالجة الصورة...');
        
        // قراءة الملف
        const reader = new FileReader();
        reader.onload = async function(e) {
            const imageData = e.target.result;
            
            // عرض معاينة مؤقتة
            displayAvatar(imageData);
            
            // إنشاء اسم فريد للملف
            const timestamp = Date.now();
            const fileName = `avatar_${timestamp}_${file.name}`;
            const githubPath = `/media/avatars/${fileName}`;
            
            // إظهار تعليمات GitHub
            const githubNote = document.getElementById('githubUploadNote');
            const pathElement = document.getElementById('githubPath');
            
            pathElement.textContent = githubPath;
            githubNote.style.display = 'block';
            
            // حفظ مسار الصورة مؤقتاً
            formData.basic.avatarPath = `https://raw.githubusercontent.com/MahmoudFouad25/fouad-perspective/main${githubPath}`;
            formData.basic.avatarData = imageData;
            
            hideLoading();
            
            // تنبيه المستخدم
            await Swal.fire({
                icon: 'info',
                title: 'تعليمات رفع الصورة',
                html: `
                    <div style="text-align: right;">
                        <p>تم تجهيز الصورة للرفع. يرجى اتباع الخطوات التالية:</p>
                        <ol style="text-align: right; padding-right: 20px;">
                            <li>افتح مستودع GitHub الخاص بك</li>
                            <li>انتقل إلى مجلد <code>/media/avatars/</code></li>
                            <li>ارفع الصورة باسم: <code>${fileName}</code></li>
                            <li>بعد الرفع، ستكون الصورة متاحة تلقائياً</li>
                        </ol>
                    </div>
                `,
                confirmButtonText: 'فهمت',
                confirmButtonColor: 'var(--primary)'
            });
        };
        
        reader.readAsDataURL(file);
        
    } catch (error) {
        console.error('خطأ في معالجة الصورة:', error);
        showError('حدث خطأ في معالجة الصورة');
        hideLoading();
    }
}

// ==================== Copy GitHub Path ====================
window.copyGithubPath = async function() {
    const path = document.getElementById('githubPath').textContent;
    try {
        await navigator.clipboard.writeText(path);
        showSuccess('تم نسخ المسار');
    } catch (error) {
        console.error('خطأ في النسخ:', error);
    }
};

// ==================== Email Availability Check ====================
async function checkEmailAvailability() {
    const email = document.getElementById('email').value.trim();
    
    if (!email || !isValidEmail(email)) {
        showFieldError('email', 'البريد الإلكتروني غير صحيح');
        return;
    }
    
    if (editMode) {
        showWarning('لا يمكن تغيير البريد الإلكتروني في وضع التعديل');
        return;
    }
    
    try {
        showLoading('جاري التحقق من البريد الإلكتروني...');
        
        // البحث في users
        const usersQuery = await db.collection('users').where('email', '==', email).limit(1).get();
        
        // البحث في userCredentials
        const credDoc = await db.collection('userCredentials').doc(email).get();
        
        if (!usersQuery.empty || credDoc.exists) {
            showFieldError('email', 'هذا البريد الإلكتروني مستخدم بالفعل');
            document.getElementById('email').classList.add('error');
        } else {
            clearFieldError('email');
            document.getElementById('email').classList.add('success');
            document.getElementById('emailFeedback').textContent = 'البريد الإلكتروني متاح';
            document.getElementById('emailFeedback').classList.add('show', 'success');
        }
        
        hideLoading();
        
    } catch (error) {
        console.error('خطأ في التحقق من البريد:', error);
        showError('حدث خطأ في التحقق من البريد الإلكتروني');
        hideLoading();
    }
}

// ==================== Role & Permissions Management ====================
function updatePermissionsForRole(role) {
    // إعادة تعيين جميع الصلاحيات
    document.querySelectorAll('input[name="permissions"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // تحديد الصلاحيات حسب الدور
    const rolePermissions = {
        student: ['view_courses', 'download_materials', 'submit_assignments', 'take_quizzes', 'view_certificates'],
        assistant: ['view_courses', 'download_materials', 'post_discussions', 'comment_discussions', 'send_messages'],
        'group-leader': ['view_courses', 'manage_groups', 'view_reports', 'send_notifications'],
        analyst: ['view_reports', 'view_analytics', 'view_progress_reports', 'export_data']
    };
    
    if (rolePermissions[role]) {
        rolePermissions[role].forEach(permission => {
            const checkbox = document.querySelector(`input[name="permissions"][value="${permission}"]`);
            if (checkbox) checkbox.checked = true;
        });
    }
    
    updatePermissionsCounts();
    updateRolePreview(role);
}

function updatePermissionsCounts() {
    const categories = ['content', 'communication', 'admin', 'analytics'];
    
    categories.forEach(category => {
        const container = document.getElementById(category + 'Permissions');
        const checkboxes = container.querySelectorAll('input[type="checkbox"]');
        const checked = container.querySelectorAll('input[type="checkbox"]:checked');
        
        document.getElementById(category + 'Count').textContent = `${checked.length}/${checkboxes.length}`;
    });
    
    // تحديث المعاينة
    updatePermissionsPreview();
}

// ==================== Permission Selection Functions ====================
window.selectAllPermissions = function() {
    document.querySelectorAll('input[name="permissions"]').forEach(checkbox => {
        checkbox.checked = true;
    });
    updatePermissionsCounts();
};

window.deselectAllPermissions = function() {
    document.querySelectorAll('input[name="permissions"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    updatePermissionsCounts();
};

window.toggleCategory = function(category) {
    const header = event.currentTarget;
    const permissions = document.getElementById(category + 'Permissions');
    
    header.classList.toggle('collapsed');
    permissions.style.display = header.classList.contains('collapsed') ? 'none' : 'grid';
};

// ==================== Role Preview ====================
function updateRolePreview(role) {
    const roleNames = {
        student: 'طالب',
        assistant: 'مدرب مساعد',
        'group-leader': 'مشرف مجموعة',
        analyst: 'محلل بيانات'
    };
    
    const roleIcons = {
        student: 'fa-user-graduate',
        assistant: 'fa-chalkboard-teacher',
        'group-leader': 'fa-users-cog',
        analyst: 'fa-chart-line'
    };
    
    document.getElementById('previewRoleName').textContent = roleNames[role] || 'مخصص';
    const icon = document.querySelector('.preview-role i');
    icon.className = `fas ${roleIcons[role] || 'fa-user'}`;
}

function updatePermissionsPreview() {
    const checkedPermissions = document.querySelectorAll('input[name="permissions"]:checked');
    const totalPermissions = document.querySelectorAll('input[name="permissions"]').length;
    
    document.getElementById('activePermissionsCount').textContent = checkedPermissions.length;
    document.getElementById('inactivePermissionsCount').textContent = totalPermissions - checkedPermissions.length;
    
    // تحديث قائمة الصلاحيات
    const permissionsList = document.getElementById('permissionsSummary');
    permissionsList.innerHTML = '';
    
    checkedPermissions.forEach(checkbox => {
        const permissionName = checkbox.nextElementSibling.nextElementSibling.querySelector('.permission-name').textContent;
        const li = document.createElement('li');
        li.textContent = permissionName;
        permissionsList.appendChild(li);
    });
}

// ==================== Courses & Paths Management ====================
async function loadAvailableContent() {
    try {
        // تحميل الدورات
        const coursesSnapshot = await db.collection('courses')
            .where('status', '==', 'published')
            .get();
        
        availableCourses = [];
        coursesSnapshot.forEach(doc => {
            availableCourses.push({ id: doc.id, type: 'course', ...doc.data() });
        });
        
        // تحميل المسارات
        try {
            const pathsSnapshot = await db.collection('bundles')
                .where('status', '==', 'published')
                .get();
            
            availablePaths = [];
            pathsSnapshot.forEach(doc => {
                availablePaths.push({ id: doc.id, type: 'path', ...doc.data() });
            });
        } catch (error) {
            console.warn('لا توجد مسارات أو خطأ في تحميلها:', error);
            availablePaths = [];
        }
        
        // عرض المحتوى
        renderAvailableCourses();
        updateCounts();
        
    } catch (error) {
        console.error('خطأ في تحميل المحتوى:', error);
        showError('حدث خطأ في تحميل الدورات والمسارات');
    }
}

function renderAvailableCourses() {
    const container = document.getElementById('availableItems');
    const allItems = [...availableCourses, ...availablePaths];
    
    if (allItems.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>لا توجد دورات أو مسارات متاحة</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    
    allItems.forEach(item => {
        const itemElement = createCourseElement(item);
        container.appendChild(itemElement);
    });
}

function createCourseElement(item) {
    const div = document.createElement('div');
    div.className = 'course-item';
    div.draggable = true;
    div.dataset.id = item.id;
    div.dataset.type = item.type;
    
    const isAssigned = formData.courses.some(c => c.id === item.id);
    
    div.innerHTML = `
        <div class="item-header">
            <div class="item-type-badge ${item.type === 'path' ? 'path' : ''}">
                <i class="fas fa-${item.type === 'path' ? 'route' : 'graduation-cap'}"></i>
                <span>${item.type === 'path' ? 'مسار' : 'دورة'}</span>
            </div>
            <button class="item-action-btn ${isAssigned ? 'remove-btn' : 'add-btn'}" 
                    onclick="toggleCourseAssignment('${item.id}')">
                <i class="fas fa-${isAssigned ? 'minus' : 'plus'}"></i>
            </button>
        </div>
        
        <div class="item-thumbnail">
            <img src="${item.thumbnail || '/assets/course-placeholder.jpg'}" alt="${item.title}">
            ${item.price ? `
                <div class="item-price">
                    <span class="price-value">${item.price}</span>
                    <span class="price-currency">ريال</span>
                </div>
            ` : ''}
        </div>
        
        <div class="item-content">
            <h4 class="item-title">${item.title}</h4>
            <p class="item-instructor">
                <i class="fas fa-user-tie"></i>
                <span>${item.instructor || 'غير محدد'}</span>
            </p>
            <div class="item-meta">
                <span class="meta-item">
                    <i class="fas fa-clock"></i>
                    <span class="duration">${item.duration || '0'} ساعة</span>
                </span>
                <span class="meta-item">
                    <i class="fas fa-users"></i>
                    <span class="students-count">${item.studentsCount || 0}</span>
                </span>
            </div>
        </div>
    `;
    
    // إضافة أحداث السحب والإفلات
    div.addEventListener('dragstart', handleDragStart);
    div.addEventListener('dragend', handleDragEnd);
    
    return div;
}

// ==================== Course Assignment ====================
window.toggleCourseAssignment = function(courseId) {
    const course = [...availableCourses, ...availablePaths].find(c => c.id === courseId);
    if (!course) return;
    
    const index = formData.courses.findIndex(c => c.id === courseId);
    
    if (index > -1) {
        // إزالة من المخصص
        formData.courses.splice(index, 1);
        showSuccess(`تم إزالة "${course.title}"`);
    } else {
        // إضافة للمخصص
        assignCourse(course);
        showSuccess(`تم إضافة "${course.title}"`);
    }
    
    renderAvailableCourses();
    renderAssignedCourses();
    updateCounts();
};

function assignCourse(course, settings = {}) {
    const assignment = {
        id: course.id,
        type: course.type,
        title: course.title,
        thumbnail: course.thumbnail,
        startDate: settings.startDate || new Date().toISOString().split('T')[0],
        endDate: settings.endDate || '',
        accessType: settings.accessType || 'full',
        customPrice: settings.customPrice || course.price || 0,
        currency: settings.currency || 'SAR',
        isFree: settings.isFree || false,
        notes: settings.notes || ''
    };
    
    formData.courses.push(assignment);
}

function renderAssignedCourses() {
    const container = document.getElementById('assignedItems');
    
    if (formData.courses.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>لم يتم تخصيص أي دورات بعد</p>
                <span>اختر من القائمة المجاورة</span>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    
    formData.courses.forEach((assignment, index) => {
        const element = createAssignedCourseElement(assignment, index);
        container.appendChild(element);
    });
}

function createAssignedCourseElement(assignment, index) {
    const div = document.createElement('div');
    div.className = 'assigned-item';
    
    div.innerHTML = `
        <div class="assigned-item-header">
            <div class="assigned-item-info">
                <div class="item-type-icon">
                    <i class="fas fa-${assignment.type === 'path' ? 'route' : 'graduation-cap'}"></i>
                </div>
                <div>
                    <h4 class="assigned-item-title">${assignment.title}</h4>
                    <p class="assigned-item-type">${assignment.type === 'path' ? 'مسار تعليمي' : 'دورة تدريبية'}</p>
                </div>
            </div>
            <button class="remove-btn" onclick="toggleCourseAssignment('${assignment.id}')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="assigned-item-settings">
            <div class="setting-group">
                <label class="setting-label">
                    <i class="fas fa-calendar-alt"></i>
                    فترة الوصول
                </label>
                <div class="date-inputs">
                    <input type="date" class="date-input start-date" 
                           value="${assignment.startDate}"
                           onchange="updateCourseAssignment(${index}, 'startDate', this.value)">
                    <span class="date-separator">إلى</span>
                    <input type="date" class="date-input end-date" 
                           value="${assignment.endDate}"
                           onchange="updateCourseAssignment(${index}, 'endDate', this.value)">
                </div>
            </div>
            
            <div class="setting-group">
                <label class="setting-label">
                    <i class="fas fa-key"></i>
                    نوع الوصول
                </label>
                <select class="setting-select access-type" 
                        value="${assignment.accessType}"
                        onchange="updateCourseAssignment(${index}, 'accessType', this.value)">
                    <option value="full" ${assignment.accessType === 'full' ? 'selected' : ''}>وصول كامل</option>
                    <option value="limited" ${assignment.accessType === 'limited' ? 'selected' : ''}>وصول محدود</option>
                    <option value="preview" ${assignment.accessType === 'preview' ? 'selected' : ''}>معاينة فقط</option>
                </select>
            </div>
            
            <div class="setting-group">
                <label class="setting-label">
                    <i class="fas fa-tag"></i>
                    السعر المخصص
                </label>
                <div class="price-input-group">
                    <input type="number" class="price-input" 
                           value="${assignment.isFree ? 0 : assignment.customPrice}" 
                           ${assignment.isFree ? 'disabled' : ''}
                           onchange="updateCourseAssignment(${index}, 'customPrice', this.value)">
                    <select class="currency-select" 
                            value="${assignment.currency}"
                            onchange="updateCourseAssignment(${index}, 'currency', this.value)">
                        <option value="SAR" ${assignment.currency === 'SAR' ? 'selected' : ''}>ريال سعودي</option>
                        <option value="EGP" ${assignment.currency === 'EGP' ? 'selected' : ''}>جنيه مصري</option>
                        <option value="USD" ${assignment.currency === 'USD' ? 'selected' : ''}>دولار أمريكي</option>
                    </select>
                    <label class="checkbox-label">
                        <input type="checkbox" class="free-checkbox" 
                               ${assignment.isFree ? 'checked' : ''}
                               onchange="toggleFreeAccess(${index}, this.checked)">
                        <span>مجاني</span>
                    </label>
                </div>
            </div>
            
            <div class="setting-group">
                <label class="setting-label">
                    <i class="fas fa-sticky-note"></i>
                    ملاحظات
                </label>
                <textarea class="setting-textarea" rows="2" 
                          placeholder="ملاحظات خاصة بهذا التخصيص..."
                          onchange="updateCourseAssignment(${index}, 'notes', this.value)">${assignment.notes}</textarea>
            </div>
        </div>
    `;
    
    return div;
}

// ==================== Update Course Assignment ====================
window.updateCourseAssignment = function(index, field, value) {
    if (formData.courses[index]) {
        formData.courses[index][field] = value;
        autoSave();
    }
};

window.toggleFreeAccess = function(index, isFree) {
    if (formData.courses[index]) {
        formData.courses[index].isFree = isFree;
        // إعادة رسم العنصر لتحديث حالة حقل السعر
        renderAssignedCourses();
        autoSave();
    }
};

// ==================== Drag and Drop ====================
function initializeDragAndDrop() {
    const dropZone = document.getElementById('dropZone');
    
    dropZone.addEventListener('dragover', handleDragOver);
    dropZone.addEventListener('drop', handleDrop);
    dropZone.addEventListener('dragleave', handleDragLeave);
}

let draggedElement = null;

function handleDragStart(e) {
    draggedElement = e.target;
    e.target.classList.add('dragging');
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
    const dropZone = document.getElementById('dropZone');
    dropZone.classList.add('drag-over');
}

function handleDragLeave(e) {
    const dropZone = document.getElementById('dropZone');
    dropZone.classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    const dropZone = document.getElementById('dropZone');
    dropZone.classList.remove('drag-over');
    
    if (draggedElement) {
        const courseId = draggedElement.dataset.id;
        const isAssigned = formData.courses.some(c => c.id === courseId);
        
        if (!isAssigned) {
            toggleCourseAssignment(courseId);
        }
    }
}

// ==================== Filter & Sort Functions ====================
function filterCourses(searchTerm) {
    const items = document.querySelectorAll('#availableItems .course-item');
    const clearBtn = document.getElementById('clearSearch');
    
    clearBtn.style.display = searchTerm ? 'block' : 'none';
    
    items.forEach(item => {
        const title = item.querySelector('.item-title').textContent.toLowerCase();
        const instructor = item.querySelector('.item-instructor span').textContent.toLowerCase();
        const search = searchTerm.toLowerCase();
        
        if (title.includes(search) || instructor.includes(search)) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
}

function filterByType(type) {
    const items = document.querySelectorAll('#availableItems .course-item');
    
    items.forEach(item => {
        const itemType = item.dataset.type;
        const isAssigned = formData.courses.some(c => c.id === item.dataset.id);
        
        if (type === 'all') {
            item.style.display = '';
        } else if (type === 'courses' && itemType === 'course') {
            item.style.display = '';
        } else if (type === 'paths' && itemType === 'path') {
            item.style.display = '';
        } else if (type === 'selected' && isAssigned) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
}

function sortCourses(sortBy) {
    const container = document.getElementById('availableItems');
    const items = Array.from(container.querySelectorAll('.course-item'));
    
    items.sort((a, b) => {
        switch (sortBy) {
            case 'name':
                const titleA = a.querySelector('.item-title').textContent;
                const titleB = b.querySelector('.item-title').textContent;
                return titleA.localeCompare(titleB, 'ar');
                
            case 'date':
                // يمكن إضافة تاريخ الإنشاء في البيانات
                return 0;
                
            case 'price':
                const priceA = parseFloat(a.querySelector('.price-value')?.textContent || 0);
                const priceB = parseFloat(b.querySelector('.price-value')?.textContent || 0);
                return priceB - priceA;
                
            case 'students':
                const studentsA = parseInt(a.querySelector('.students-count').textContent);
                const studentsB = parseInt(b.querySelector('.students-count').textContent);
                return studentsB - studentsA;
                
            default:
                return 0;
        }
    });
    
    container.innerHTML = '';
    items.forEach(item => container.appendChild(item));
}

function updateCounts() {
    const courses = availableCourses.length;
    const paths = availablePaths.length;
    const assigned = formData.courses.length;
    const all = courses + paths;
    
    document.getElementById('allCount').textContent = all;
    document.getElementById('coursesCount').textContent = courses;
    document.getElementById('pathsCount').textContent = paths;
    document.getElementById('selectedCount').textContent = assigned;
    
    document.getElementById('assignedCoursesCount').textContent = 
        formData.courses.filter(c => c.type === 'course').length;
    document.getElementById('assignedPathsCount').textContent = 
        formData.courses.filter(c => c.type === 'path').length;
}

// ==================== Bulk Actions ====================
window.assignAllVisible = function() {
    const visibleItems = document.querySelectorAll('#availableItems .course-item:not([style*="display: none"])');
    
    visibleItems.forEach(item => {
        const courseId = item.dataset.id;
        const isAssigned = formData.courses.some(c => c.id === courseId);
        
        if (!isAssigned) {
            const course = [...availableCourses, ...availablePaths].find(c => c.id === courseId);
            if (course) {
                assignCourse(course);
            }
        }
    });
    
    renderAvailableCourses();
    renderAssignedCourses();
    updateCounts();
    showSuccess('تم إضافة جميع العناصر المرئية');
};

window.removeAllAssigned = function() {
    if (formData.courses.length === 0) {
        showWarning('لا توجد دورات مخصصة للإزالة');
        return;
    }
    
    Swal.fire({
        title: 'هل أنت متأكد؟',
        text: 'سيتم إزالة جميع الدورات والمسارات المخصصة',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: 'var(--danger)',
        cancelButtonColor: 'var(--secondary)',
        confirmButtonText: 'نعم، احذف الكل',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            formData.courses = [];
            renderAvailableCourses();
            renderAssignedCourses();
            updateCounts();
            showSuccess('تم إزالة جميع التخصيصات');
        }
    });
};

window.applyBulkSettings = function() {
    if (formData.courses.length === 0) {
        showWarning('لا توجد دورات مخصصة لتطبيق الإعدادات عليها');
        return;
    }
    
    document.getElementById('bulkSettingsModal').style.display = 'block';
};

window.applyBulkSettingsConfirm = function() {
    const duration = parseInt(document.getElementById('bulkDuration').value);
    const durationUnit = document.getElementById('bulkDurationUnit').value;
    const accessType = document.getElementById('bulkAccessType').value;
    const discount = parseInt(document.getElementById('bulkDiscount').value) || 0;
    
    // حساب تاريخ النهاية
    const today = new Date();
    let endDate = new Date(today);
    
    switch (durationUnit) {
        case 'days':
            endDate.setDate(endDate.getDate() + duration);
            break;
        case 'weeks':
            endDate.setDate(endDate.getDate() + (duration * 7));
            break;
        case 'months':
            endDate.setMonth(endDate.getMonth() + duration);
            break;
        case 'years':
            endDate.setFullYear(endDate.getFullYear() + duration);
            break;
    }
    
    // تطبيق الإعدادات على جميع الدورات
    formData.courses.forEach(course => {
        course.startDate = today.toISOString().split('T')[0];
        course.endDate = endDate.toISOString().split('T')[0];
        course.accessType = accessType;
        
        if (discount > 0 && !course.isFree) {
            course.customPrice = course.customPrice * (1 - discount / 100);
        }
    });
    
    renderAssignedCourses();
    closeBulkSettings();
    showSuccess('تم تطبيق الإعدادات الجماعية');
};

// ==================== Advanced Information Functions ====================

// Load Countries
async function loadCountries() {
    const countries = [
        { code: 'EG', name: 'مصر' },
        { code: 'SA', name: 'السعودية' },
        { code: 'AE', name: 'الإمارات' },
        { code: 'KW', name: 'الكويت' },
        { code: 'QA', name: 'قطر' },
        { code: 'OM', name: 'عمان' },
        { code: 'BH', name: 'البحرين' },
        { code: 'JO', name: 'الأردن' },
        { code: 'LB', name: 'لبنان' },
        { code: 'PS', name: 'فلسطين' },
        { code: 'SY', name: 'سوريا' },
        { code: 'IQ', name: 'العراق' },
        { code: 'MA', name: 'المغرب' },
        { code: 'DZ', name: 'الجزائر' },
        { code: 'TN', name: 'تونس' },
        { code: 'LY', name: 'ليبيا' },
        { code: 'SD', name: 'السودان' },
        { code: 'YE', name: 'اليمن' }
    ];
    
    const select = document.getElementById('country');
    select.innerHTML = '<option value="">-- اختر الدولة --</option>';
    
    countries.forEach(country => {
        const option = document.createElement('option');
        option.value = country.code;
        option.textContent = country.name;
        select.appendChild(option);
    });
}

// Interests Tags
function addInterestTag(interest) {
    if (!formData.advanced.interests) {
        formData.advanced.interests = [];
    }
    
    if (formData.advanced.interests.includes(interest)) {
        showWarning('هذا الاهتمام موجود بالفعل');
        return;
    }
    
    formData.advanced.interests.push(interest);
    
    const tagsList = document.getElementById('interestsTags');
    const tag = document.createElement('div');
    tag.className = 'tag-item';
    tag.innerHTML = `
        ${interest}
        <button onclick="removeInterestTag('${interest}')">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    tagsList.appendChild(tag);
}

window.removeInterestTag = function(interest) {
    const index = formData.advanced.interests.indexOf(interest);
    if (index > -1) {
        formData.advanced.interests.splice(index, 1);
    }
    
    // إعادة رسم القائمة
    const tagsList = document.getElementById('interestsTags');
    tagsList.innerHTML = '';
    formData.advanced.interests.forEach(tag => addInterestTag(tag));
};

// Custom Fields
window.addCustomField = function() {
    document.getElementById('customFieldModal').style.display = 'block';
};

window.saveCustomField = function() {
    const label = document.getElementById('fieldLabel').value.trim();
    const type = document.getElementById('fieldType').value;
    const required = document.getElementById('fieldRequired').checked;
    const options = document.getElementById('fieldOptions').value
        .split('\n')
        .filter(opt => opt.trim())
        .map(opt => opt.trim());
    
    if (!label) {
        showError('يجب إدخال اسم الحقل');
        return;
    }
    
    const field = {
        id: 'field_' + Date.now(),
        label,
        type,
        required,
        options: type === 'select' ? options : [],
        value: ''
    };
    
    customFields.push(field);
    addCustomFieldToForm(field);
    
    closeCustomFieldModal();
    showSuccess('تم إضافة الحقل المخصص');
};

function addCustomFieldToForm(field) {
    const container = document.getElementById('customFieldsContainer');
    const emptyState = document.getElementById('emptyCustomFields');
    
    emptyState.style.display = 'none';
    
    const fieldElement = document.createElement('div');
    fieldElement.className = 'custom-field-item';
    fieldElement.dataset.fieldId = field.id;
    
    let inputHtml = '';
    
    switch (field.type) {
        case 'text':
        case 'email':
        case 'number':
            inputHtml = `<input type="${field.type}" class="form-control" 
                         id="${field.id}" ${field.required ? 'required' : ''}>`;
            break;
            
        case 'date':
            inputHtml = `<input type="date" class="form-control" 
                         id="${field.id}" ${field.required ? 'required' : ''}>`;
            break;
            
        case 'textarea':
            inputHtml = `<textarea class="form-control" id="${field.id}" 
                         rows="3" ${field.required ? 'required' : ''}></textarea>`;
            break;
            
        case 'select':
            inputHtml = `
                <select class="form-control" id="${field.id}" ${field.required ? 'required' : ''}>
                    <option value="">-- اختر --</option>
                    ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                </select>
            `;
            break;
            
        case 'checkbox':
            inputHtml = `
                <label class="checkbox-label">
                    <input type="checkbox" id="${field.id}">
                    <span>${field.label}</span>
                </label>
            `;
            break;
    }
    
    fieldElement.innerHTML = `
        <div class="custom-field-icon">
            <i class="fas fa-${getFieldIcon(field.type)}"></i>
        </div>
        <div class="custom-field-content">
            ${field.type !== 'checkbox' ? `
                <label class="custom-field-label ${field.required ? 'required' : ''}">
                    ${field.label}
                </label>
                ${inputHtml}
            ` : inputHtml}
        </div>
        <button class="custom-field-remove" onclick="removeCustomField('${field.id}')">
            <i class="fas fa-trash"></i>
        </button>
    `;
    
    container.appendChild(fieldElement);
    
    // تحديث البيانات عند التغيير
    const input = fieldElement.querySelector('input, select, textarea');
    if (input) {
        input.addEventListener('change', function() {
            const fieldData = customFields.find(f => f.id === field.id);
            if (fieldData) {
                fieldData.value = field.type === 'checkbox' ? this.checked : this.value;
            }
        });
        
        // إذا كانت هناك قيمة محفوظة
        if (field.value !== undefined && field.value !== '') {
            if (field.type === 'checkbox') {
                input.checked = field.value;
            } else {
                input.value = field.value;
            }
        }
    }
}

window.removeCustomField = function(fieldId) {
    Swal.fire({
        title: 'هل أنت متأكد؟',
        text: 'سيتم حذف هذا الحقل المخصص',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: 'var(--danger)',
        cancelButtonColor: 'var(--secondary)',
        confirmButtonText: 'نعم، احذف',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            // حذف من المصفوفة
            const index = customFields.findIndex(f => f.id === fieldId);
            if (index > -1) {
                customFields.splice(index, 1);
            }
            
            // حذف من الواجهة
            const element = document.querySelector(`[data-field-id="${fieldId}"]`);
            if (element) {
                element.remove();
            }
            
            // إظهار الحالة الفارغة إذا لزم الأمر
            if (customFields.length === 0) {
                document.getElementById('emptyCustomFields').style.display = 'block';
            }
            
            showSuccess('تم حذف الحقل المخصص');
        }
    });
};

function getFieldIcon(type) {
    const icons = {
        text: 'font',
        email: 'envelope',
        number: 'hashtag',
        date: 'calendar',
        textarea: 'align-left',
        select: 'list',
        checkbox: 'check-square'
    };
    
    return icons[type] || 'tag';
}

// Notes Editor
function initializeNotesEditor() {
    const editor = document.getElementById('adminNotesEditor');
    
    // منع السلوك الافتراضي للروابط
    editor.addEventListener('click', function(e) {
        if (e.target.tagName === 'A') {
            e.preventDefault();
            window.open(e.target.href, '_blank');
        }
    });
}

window.formatText = function(command) {
    document.execCommand(command, false, null);
    
    // تحديث الأزرار النشطة
    const button = event.currentTarget;
    button.classList.toggle('active');
};

window.insertLink = function() {
    const url = prompt('أدخل رابط URL:');
    if (url) {
        document.execCommand('createLink', false, url);
    }
};

window.insertHighlight = function() {
    document.execCommand('hiliteColor', false, 'yellow');
};

// Activity Timeline
window.loadMoreActivity = function() {
    // يمكن تحميل المزيد من الأنشطة من قاعدة البيانات
    showWarning('لا توجد أنشطة إضافية');
};

// ==================== Auto Save Functions ====================
function autoSave() {
    clearTimeout(autoSaveTimer);
    
    autoSaveTimer = setTimeout(async () => {
        try {
            await saveFormData(true);
            showAutoSaveIndicator();
        } catch (error) {
            console.error('خطأ في الحفظ التلقائي:', error);
        }
    }, 2000);
}

function showAutoSaveIndicator() {
    const indicator = document.getElementById('autoSaveIndicator');
    indicator.classList.add('show');
    
    setTimeout(() => {
        indicator.classList.remove('show');
    }, 3000);
}

async function saveFormData(isDraft = false) {
    // جمع جميع البيانات
    collectFormData();
    
    // حفظ في localStorage
    localStorage.setItem('userBuilderDraft', JSON.stringify({
        formData,
        customFields,
        savedAt: new Date().toISOString()
    }));
    
    if (!isDraft) {
        // يمكن حفظ في Firestore إذا لزم الأمر
        console.log('حفظ البيانات...', formData);
    }
}

function collectFormData() {
    // البيانات الأساسية
    formData.basic = {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        countryCode: document.getElementById('countryCode').value,
        phoneNumber: document.getElementById('phoneNumber').value,
        accountStatus: document.querySelector('input[name="accountStatus"]:checked').value,
        avatar: formData.basic.avatarPath || null
    };
    
    // كلمة المرور (في وضع الإنشاء فقط)
    if (!editMode) {
        formData.basic.password = document.getElementById('password').value;
    }
    
    // الأدوار والصلاحيات
    formData.roles = {
        primaryRole: document.querySelector('input[name="primaryRole"]:checked').value,
        permissions: Array.from(document.querySelectorAll('input[name="permissions"]:checked'))
            .map(cb => cb.value),
        customRole: document.getElementById('enableCustomRole').checked ? {
            name: document.getElementById('customRoleName').value,
            color: document.getElementById('customRoleColor').value,
            description: document.getElementById('customRoleDescription').value
        } : null
    };
    
    // المعلومات المتقدمة
    formData.advanced = {
        // الشخصية
        birthDate: document.getElementById('birthDate').value,
        gender: document.getElementById('gender').value,
        nationality: document.getElementById('nationality').value,
        
        // التواصل
        country: document.getElementById('country').value,
        city: document.getElementById('city').value,
        timezone: document.getElementById('timezone').value,
        language: document.getElementById('language').value,
        address: document.getElementById('address').value,
        
        // المهنية
        occupation: document.getElementById('occupation').value,
        company: document.getElementById('company').value,
        education: document.getElementById('education').value,
        experience: document.getElementById('experience').value,
        interests: formData.advanced.interests || [],
        
        // الإشعارات
        notifications: {
            emailNewCourse: document.getElementById('emailNewCourse').checked,
            emailReminders: document.getElementById('emailReminders').checked,
            emailPromotions: document.getElementById('emailPromotions').checked,
            emailNewsletter: document.getElementById('emailNewsletter').checked,
            whatsappReminders: document.getElementById('whatsappReminders').checked,
            whatsappSupport: document.getElementById('whatsappSupport').checked,
            whatsappProgress: document.getElementById('whatsappProgress').checked
        },
        
        // ملاحظات الإدارة
        adminNotes: document.getElementById('adminNotesEditor').innerHTML,
        
        // الحقول المخصصة
        customFields: customFields
    };
}

// ==================== Save User Functions ====================
async function saveUser(isDraft = false) {
    try {
        // التحقق من صحة البيانات
        if (!validateBasicInfo()) {
            showError('يرجى التحقق من البيانات الأساسية');
            // الانتقال للتبويب الأول
            document.getElementById('basicTab').click();
            return;
        }
        
        showLoading(isDraft ? 'جاري حفظ المسودة...' : 'جاري حفظ البيانات...');
        
        // جمع البيانات
        collectFormData();
        
        // إعداد بيانات المستخدم
        const userData = {
            name: `${formData.basic.firstName} ${formData.basic.lastName}`.trim(),
            email: formData.basic.email,
            whatsapp: `${formData.basic.countryCode}${formData.basic.phoneNumber}`,
            phone: `${formData.basic.countryCode}${formData.basic.phoneNumber}`,
            avatar: formData.basic.avatar,
            
            isActive: formData.basic.accountStatus === 'active',
            status: formData.basic.accountStatus,
            
            role: formData.roles.primaryRole,
            permissions: formData.roles.permissions,
            customRole: formData.roles.customRole,
            
            enrollments: formData.courses.map(course => ({
                id: course.id,
                type: course.type,
                title: course.title,
                startDate: course.startDate,
                endDate: course.endDate,
                accessType: course.accessType,
                price: course.isFree ? 0 : course.customPrice,
                currency: course.currency,
                isFree: course.isFree,
                notes: course.notes,
                enrolledAt: new Date().toISOString()
            })),
            
            ...formData.advanced,
            
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
            lastUpdatedBy: currentUser.email
        };
        
        if (editMode) {
            // تحديث المستخدم الموجود
            await db.collection('users').doc(currentUserId).update(userData);
            
            hideLoading();
            showSuccess('تم حفظ التعديلات بنجاح');
            
            // العودة لصفحة المستخدمين بعد ثانيتين
            setTimeout(() => {
                window.location.href = '/admin/users.html';
            }, 2000);
            
        } else {
            // إنشاء مستخدم جديد
            userData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            userData.createdBy = currentUser.email;
            
            // حفظ في userCredentials للمصادقة
            const credentials = {
                ...userData,
                password: formData.basic.password,
                status: 'waiting_first_login'
            };
            
            await db.collection('userCredentials').doc(userData.email).set(credentials);
            
            // حفظ في users
            const newUserRef = await db.collection('users').add(userData);
            
            hideLoading();
            
            // عرض نافذة النجاح مع بيانات الدخول
            await showSuccessWithCredentials(userData.email, formData.basic.password, userData.whatsapp);
        }
        
    } catch (error) {
        console.error('خطأ في حفظ المستخدم:', error);
        hideLoading();
        showError('حدث خطأ في حفظ البيانات: ' + error.message);
    }
}

async function quickSave() {
    await saveFormData(false);
    showSuccess('تم الحفظ السريع');
}

// ==================== Success with Credentials ====================
async function showSuccessWithCredentials(email, password, whatsapp) {
    const result = await Swal.fire({
        icon: 'success',
        title: 'تم إنشاء المستخدم بنجاح!',
        html: `
            <div style="text-align: right; direction: rtl;">
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin: 1rem 0;">
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">
                        <i class="fas fa-key"></i> بيانات الدخول
                    </h4>
                    <div style="margin-bottom: 0.8rem;">
                        <strong>البريد الإلكتروني:</strong><br>
                        <code style="background: white; padding: 0.5rem; display: block; margin-top: 0.3rem;">${email}</code>
                    </div>
                    <div>
                        <strong>كلمة المرور:</strong><br>
                        <code style="background: white; padding: 0.5rem; display: block; margin-top: 0.3rem;">${password}</code>
                    </div>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '<i class="fas fa-copy"></i> نسخ البيانات',
        cancelButtonText: '<i class="fab fa-whatsapp"></i> إرسال WhatsApp',
        confirmButtonColor: 'var(--primary)',
        cancelButtonColor: 'var(--success)',
        reverseButtons: true
    });
    
    if (result.isConfirmed) {
        // نسخ البيانات
        const text = `البريد الإلكتروني: ${email}\nكلمة المرور: ${password}`;
        await navigator.clipboard.writeText(text);
        showSuccess('تم نسخ بيانات الدخول');
        
    } else if (result.dismiss === Swal.DismissReason.cancel) {
        // إرسال WhatsApp
        const message = `مرحباً،\n\nتم إنشاء حساب لك في منظور الفؤاد\n\nبيانات الدخول:\n📧 البريد: ${email}\n🔒 كلمة المرور: ${password}\n\n🔗 رابط تسجيل الدخول:\n${window.location.origin}/login.html\n\nمع تحيات فريق منظور الفؤاد`;
        
        const whatsappUrl = `https://wa.me/${whatsapp.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    }
    
    // العودة لصفحة المستخدمين
    setTimeout(() => {
        window.location.href = '/admin/users.html';
    }, 1000);
}

// ==================== Form Actions ====================
function handleCancel() {
    Swal.fire({
        title: 'هل أنت متأكد؟',
        text: 'سيتم فقدان جميع التغييرات غير المحفوظة',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: 'var(--danger)',
        cancelButtonColor: 'var(--secondary)',
        confirmButtonText: 'نعم، إلغاء',
        cancelButtonText: 'لا، البقاء'
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = '/admin/users.html';
        }
    });
}

function handleReset() {
    Swal.fire({
        title: 'هل أنت متأكد؟',
        text: 'سيتم إعادة تعيين جميع الحقول',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: 'var(--warning)',
        cancelButtonColor: 'var(--secondary)',
        confirmButtonText: 'نعم، إعادة تعيين',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            if (editMode) {
                // إعادة تحميل البيانات الأصلية
                loadUserData(currentUserId);
            } else {
                // مسح النموذج
                document.querySelector('form').reset();
                formData = {
                    basic: {},
                    roles: {},
                    courses: [],
                    advanced: {}
                };
                customFields = [];
                renderAssignedCourses();
                updateCounts();
            }
            showSuccess('تم إعادة تعيين النموذج');
        }
    });
}

// ==================== Initialize on Load ====================
// تحميل المسودة إذا كانت موجودة
window.addEventListener('load', function() {
    const draft = localStorage.getItem('userBuilderDraft');
    if (draft && !editMode) {
        const draftData = JSON.parse(draft);
        const savedDate = new Date(draftData.savedAt);
        const timeDiff = (new Date() - savedDate) / 1000 / 60; // بالدقائق
        
        if (timeDiff < 60) { // أقل من ساعة
            Swal.fire({
                title: 'توجد مسودة محفوظة',
                text: `تم حفظ مسودة منذ ${Math.round(timeDiff)} دقيقة. هل تريد استكمالها؟`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'نعم، استكمال',
                cancelButtonText: 'لا، بداية جديدة',
                confirmButtonColor: 'var(--primary)'
            }).then((result) => {
                if (result.isConfirmed) {
                    formData = draftData.formData;
                    customFields = draftData.customFields || [];
                    // يمكن إضافة دالة لملء النموذج من المسودة
                    showSuccess('تم تحميل المسودة');
                } else {
                    localStorage.removeItem('userBuilderDraft');
                }
            });
        }
    }
});

// Cleanup on page leave
window.addEventListener('beforeunload', function(e) {
    if (formData.basic.firstName || formData.basic.email) {
        e.preventDefault();
        e.returnValue = 'لديك تغييرات غير محفوظة. هل أنت متأكد من مغادرة الصفحة؟';
    }
});
    </script>
</body>
</html>
