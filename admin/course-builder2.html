<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منشئ الدورات الاحترافي - منظور الفؤاد</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 for better modals -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Sortable JS for drag & drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* ==================== CSS Variables ==================== */
        :root {
            /* Modern Color Palette */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --primary-rgb: 99, 102, 241;
            
            --secondary: #22d3ee;
            --secondary-dark: #06b6d4;
            --secondary-light: #67e8f9;
            --secondary-rgb: 34, 211, 238;
            
            --accent: #f43f5e;
            --accent-dark: #e11d48;
            --accent-light: #fb7185;
            --accent-rgb: 244, 63, 94;
            
            --success: #10b981;
            --success-dark: #059669;
            --success-light: #34d399;
            --success-rgb: 16, 185, 129;
            
            --warning: #f59e0b;
            --warning-dark: #d97706;
            --warning-light: #fbbf24;
            --warning-rgb: 245, 158, 11;
            
            --danger: #ef4444;
            --danger-dark: #dc2626;
            --danger-light: #f87171;
            --danger-rgb: 239, 68, 68;
            
            --info: #3b82f6;
            --info-dark: #2563eb;
            --info-light: #60a5fa;
            --info-rgb: 59, 130, 246;
            
            /* Background Colors */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            
            /* Text Colors */
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --text-disabled: #64748b;
            
            /* Border Colors */
            --border-primary: rgba(148, 163, 184, 0.2);
            --border-secondary: rgba(148, 163, 184, 0.1);
            --border-focus: rgba(99, 102, 241, 0.5);
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-glow: 0 0 20px rgba(99, 102, 241, 0.3);
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, var(--primary), var(--primary-dark));
            --gradient-secondary: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            --gradient-accent: linear-gradient(135deg, var(--accent), var(--accent-dark));
            --gradient-success: linear-gradient(135deg, var(--success), var(--success-dark));
            --gradient-dark: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
            --gradient-mesh: radial-gradient(at 40% 20%, rgba(99, 102, 241, 0.1) 0px, transparent 50%),
                            radial-gradient(at 80% 0%, rgba(34, 211, 238, 0.1) 0px, transparent 50%),
                            radial-gradient(at 0% 50%, rgba(244, 63, 94, 0.1) 0px, transparent 50%);
            
            /* Spacing */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            /* Transitions */
            --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Z-index */
            --z-dropdown: 100;
            --z-sticky: 200;
            --z-fixed: 300;
            --z-modal-backdrop: 400;
            --z-modal: 500;
            --z-popover: 600;
            --z-tooltip: 700;
        }

        /* ==================== Reset & Base Styles ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Noto Kufi Arabic', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }

        /* Background Mesh Effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-mesh);
            pointer-events: none;
            z-index: 0;
        }

        /* Selection */
        ::selection {
            background: rgba(99, 102, 241, 0.3);
            color: var(--text-primary);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            border: 2px solid var(--bg-secondary);
            transition: var(--transition-base);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
            border-color: var(--primary-dark);
        }

        /* Focus Styles */
        :focus {
            outline: none;
        }

        :focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
            border-radius: var(--radius-sm);
        }
/* ==================== Typography ==================== */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
            line-height: 1.3;
            color: var(--text-primary);
        }

        h1 { font-size: 2.5rem; }
        h2 { font-size: 2rem; }
        h3 { font-size: 1.5rem; }
        h4 { font-size: 1.25rem; }
        h5 { font-size: 1.125rem; }
        h6 { font-size: 1rem; }

        p {
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        /* ==================== Main Layout ==================== */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* ==================== Header Styles ==================== */
        .app-header {
            height: 80px;
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            padding: 0 2rem;
            gap: 2rem;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
            transition: var(--transition-base);
        }

        .app-header:hover {
            background: rgba(30, 41, 59, 0.95);
        }

        .header-back {
            width: 45px;
            height: 45px;
            background: var(--gradient-primary);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-base);
            box-shadow: var(--shadow-md);
            font-size: 1.1rem;
        }

        .header-back:hover {
            transform: translateX(3px) scale(1.05);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
        }

        .header-title {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .course-title-edit {
            background: rgba(99, 102, 241, 0.1);
            border: 2px solid transparent;
            color: var(--text-primary);
            font-size: 1.4rem;
            font-weight: 600;
            padding: 0.6rem 1.2rem;
            border-radius: var(--radius-md);
            min-width: 350px;
            transition: var(--transition-base);
        }

        .course-title-edit:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.2);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .save-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            transition: var(--transition-base);
        }

        .save-indicator.saving {
            color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }

        .save-indicator.saved {
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        /* ==================== Button Styles ==================== */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-base);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: inherit;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), 0 10px 25px rgba(99, 102, 241, 0.3);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), 0 10px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: var(--gradient-accent);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), 0 10px 25px rgba(244, 63, 94, 0.3);
        }

        /* Icon Button */
        .icon-btn {
            width: 40px;
            height: 40px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .icon-btn:hover {
            background: var(--bg-hover);
            color: var(--primary);
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .icon-btn.danger:hover {
            background: rgba(244, 63, 94, 0.1);
            color: var(--danger);
            border-color: var(--danger);
        }

        /* ==================== Main Content Area ==================== */
        .app-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            background: var(--bg-primary);
        }

        /* ==================== Steps Navigation ==================== */
        .steps-nav {
            width: 280px;
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border-left: 1px solid var(--border-primary);
            padding: 2rem 1.5rem;
            overflow-y: auto;
            flex-shrink: 0;
            transition: var(--transition-base);
        }

        .steps-nav.collapsed {
            width: 80px;
            padding: 2rem 0.5rem;
        }

        .steps-title {
            font-size: 1.2rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 2rem;
            text-align: center;
        }

        .step-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition-base);
            position: relative;
            border: 2px solid transparent;
            background: var(--bg-card);
        }

        .step-item::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: var(--radius-lg);
            padding: 2px;
            background: linear-gradient(135deg, transparent, transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            transition: var(--transition-base);
        }

        .step-item:hover {
            background: rgba(99, 102, 241, 0.05);
            transform: translateX(-5px);
        }

        .step-item:hover::before {
            background: var(--gradient-primary);
        }

        .step-item.active {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.2);
        }

        .step-item.completed .step-number {
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
        }

        .step-number {
            width: 45px;
            height: 45px;
            background: var(--bg-hover);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            transition: var(--transition-base);
            border: 2px solid var(--border-primary);
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
            overflow: hidden;
        }

        .step-name {
            font-weight: 600;
            margin-bottom: 0.2rem;
            color: var(--text-primary);
        }

        .step-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ==================== Main Panel ==================== */
        .main-panel {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background: var(--bg-primary);
            position: relative;
        }

        .panel-container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* ==================== Step Panels ==================== */
        .step-panel {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .step-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }

        .panel-header {
            margin-bottom: 3rem;
            text-align: center;
        }

        .panel-title {
            font-size: 2.2rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .panel-subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        /* ==================== Form Sections ==================== */
        .form-section {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            padding: 2.5rem;
            border-radius: var(--radius-xl);
            margin-bottom: 2rem;
            border: 1px solid var(--border-primary);
            transition: var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .form-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.5s ease;
        }

        .form-section:hover::before {
            transform: scaleX(1);
        }

        .form-section:hover {
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.1);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .section-icon {
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
            box-shadow: var(--shadow-lg);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .section-subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
/* ==================== Form Elements ==================== */
        .form-group {
            margin-bottom: 1.8rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 0.6rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-label .required {
            color: var(--accent);
        }

        .form-hint {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.4rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-control {
            width: 100%;
            padding: 0.9rem 1.2rem;
            background: var(--bg-primary);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 1rem;
            transition: var(--transition-base);
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-control::placeholder {
            color: var(--text-disabled);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        select.form-control {
            cursor: pointer;
        }

        /* Input Group */
        .input-group {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .input-group .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Currency Input */
        .currency-input {
            display: flex;
            align-items: center;
            background: var(--bg-primary);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-md);
            transition: var(--transition-base);
            overflow: hidden;
        }

        .currency-input:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .currency-symbol {
            padding: 0.9rem 1.2rem;
            background: var(--gradient-primary);
            color: white;
            font-weight: 600;
            border-left: none;
        }

        .currency-input input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 0.9rem 1.2rem;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
        }

        .currency-input input:focus {
            outline: none;
        }

        /* Toggle Switch */
        .toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toggle {
            position: relative;
            width: 56px;
            height: 30px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: var(--transition-base);
            border: 2px solid var(--border-primary);
        }

        .toggle input {
            display: none;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 22px;
            height: 22px;
            background: var(--text-muted);
            border-radius: var(--radius-full);
            transition: var(--transition-base);
            box-shadow: var(--shadow-sm);
        }

        .toggle input:checked + .toggle {
            background: var(--gradient-primary);
            border-color: var(--primary);
        }

        .toggle input:checked + .toggle .toggle-slider {
            transform: translateX(26px);
            background: white;
        }

        /* Rich Text Editor Custom Styles */
        .editor-container {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 2px solid var(--border-primary);
            transition: var(--transition-base);
        }

        .editor-container:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .ql-toolbar {
            background: var(--bg-secondary) !important;
            border: none !important;
            border-bottom: 1px solid var(--border-primary) !important;
            padding: 1rem !important;
        }

        .ql-container {
            border: none !important;
            font-family: inherit;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .ql-editor {
            min-height: 200px;
            padding: 1.5rem;
            color: var(--text-primary);
        }

        .ql-editor.ql-blank::before {
            color: var(--text-disabled);
            font-style: normal;
        }

        /* Progress Bar */
        .progress-container {
            margin-bottom: 3rem;
            background: rgba(30, 41, 59, 0.3);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-primary);
        }

        .progress-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .progress-stat {
            text-align: center;
            padding: 0.5rem;
        }

        .progress-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .progress-stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .progress-bar {
            height: 10px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-bottom: 0.5rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: var(--radius-full);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Navigation Buttons */
        .step-navigation {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-primary);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .steps-nav {
                position: fixed;
                right: -280px;
                top: 80px;
                bottom: 0;
                z-index: var(--z-fixed);
                transition: right 0.3s;
                box-shadow: -5px 0 20px rgba(0, 0, 0, 0.3);
            }

            .steps-nav.active {
                right: 0;
            }

            .main-panel {
                padding: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .app-header {
                padding: 0 1rem;
                height: 70px;
            }

            .course-title-edit {
                min-width: 200px;
                font-size: 1.1rem;
            }

            .header-actions {
                gap: 0.5rem;
            }

            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }

            .panel-title {
                font-size: 1.8rem;
            }

            .form-section {
                padding: 1.5rem;
            }

            .input-group {
                flex-direction: column;
            }
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Loading States */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(99, 102, 241, 0.1),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        /* Tooltips */
        [data-tooltip] {
            position: relative;
            cursor: help;
        }

        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-5px);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition-base);
            box-shadow: var(--shadow-lg);
            z-index: var(--z-tooltip);
        }

        [data-tooltip]:hover::after {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <button class="header-back" onclick="goBack()" title="العودة للوحة التحكم">
                <i class="fas fa-arrow-right"></i>
            </button>
            
            <div class="header-title">
                <input type="text" 
                       class="course-title-edit" 
                       id="courseTitle"
                       placeholder="اسم الدورة..." 
                       value="دورة جديدة">
                
                <div class="save-indicator" id="saveIndicator">
                    <i class="fas fa-check-circle"></i>
                    <span>تم الحفظ</span>
                </div>
            </div>
            
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="previewCourse()">
                    <i class="fas fa-eye"></i>
                    <span>معاينة</span>
                </button>
                
                <button class="btn btn-primary" onclick="publishCourse()">
                    <i class="fas fa-rocket"></i>
                    <span>نشر الدورة</span>
                </button>
            </div>
        </header>

        <div class="app-content">
            <!-- Steps Navigation -->
            <nav class="steps-nav" id="stepsNav">
                <h3 class="steps-title">خطوات إنشاء الدورة</h3>
                
                <div class="step-item active" onclick="showStep(1)" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <div class="step-name">المعلومات الأساسية</div>
                        <div class="step-desc">العنوان والوصف والأهداف</div>
                    </div>
                </div>
                
                <div class="step-item" onclick="showStep(2)" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <div class="step-name">التسعير والوصول</div>
                        <div class="step-desc">الأسعار وخطط الدفع</div>
                    </div>
                </div>
                
                <div class="step-item" onclick="showStep(3)" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <div class="step-name">بناء المنهج</div>
                        <div class="step-desc">الوحدات والدروس</div>
                    </div>
                </div>
                
                <div class="step-item" onclick="showStep(4)" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <div class="step-name">تجربة الطالب</div>
                        <div class="step-desc">الإعدادات والشهادات</div>
                    </div>
                </div>
                
                <div class="step-item" onclick="showStep(5)" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-content">
                        <div class="step-name">النشر والتسويق</div>
                        <div class="step-desc">إطلاق الدورة</div>
                    </div>
                </div>
            </nav>

            <!-- Main Panel -->
            <main class="main-panel">
                <div class="panel-container">
                    <!-- Progress -->
                    <div class="progress-container">
                        <div class="progress-stats">
                            <div class="progress-stat">
                                <div class="progress-stat-value" id="completedSteps">1</div>
                                <div class="progress-stat-label">خطوات مكتملة</div>
                            </div>
                            <div class="progress-stat">
                                <div class="progress-stat-value" id="totalLessons">0</div>
                                <div class="progress-stat-label">إجمالي الدروس</div>
                            </div>
                            <div class="progress-stat">
                                <div class="progress-stat-value" id="courseDuration">0</div>
                                <div class="progress-stat-label">مدة الدورة (دقيقة)</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressBar" style="width: 20%;"></div>
                        </div>
                        <div class="progress-text">اكتمل <span id="progressPercent">20</span>% من إعداد الدورة</div>
                    </div>
<!-- Step 1: Basic Info -->
                    <div class="step-panel active" id="step1">
                        <div class="panel-header">
                            <h1 class="panel-title">المعلومات الأساسية للدورة</h1>
                            <p class="panel-subtitle">أضف المعلومات الأساسية التي ستظهر للطلاب وتساعدهم في اتخاذ قرار الالتحاق</p>
                        </div>

                        <!-- Course Basic Info -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <div>
                                    <h3 class="section-title">معلومات الدورة</h3>
                                    <p class="section-subtitle">المعلومات الأساسية التي تعرّف بالدورة</p>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    عنوان الدورة <span class="required">*</span>
                                </label>
                                <input type="text" class="form-control" id="courseTitleMain" 
                                       placeholder="مثال: رحلة اكتشاف الذات بمنظور الفؤاد"
                                       maxlength="100">
                                <div class="form-hint">
                                    <i class="fas fa-info-circle"></i>
                                    اختر عنواناً جذاباً وواضحاً يعبر عن محتوى الدورة (حد أقصى 100 حرف)
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">العنوان الفرعي</label>
                                <input type="text" class="form-control" id="courseSubtitle" 
                                       placeholder="مثال: رحلة تحولية لفهم النفس واكتشاف الهدف"
                                       maxlength="150">
                                <div class="form-hint">
                                    <i class="fas fa-lightbulb"></i>
                                    عنوان توضيحي يظهر تحت العنوان الرئيسي
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">رابط الدورة (URL)</label>
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="color: var(--text-muted); font-size: 0.9rem;">
                                        mahmoudfouad25.github.io/fouad-perspective/courses/
                                    </span>
                                    <span id="slugPreview" style="color: var(--primary); font-weight: 600;">
                                        course-url-here
                                    </span>
                                </div>
                                <input type="text" 
                                       class="form-control" 
                                       id="courseSlug" 
                                       placeholder="اتركه فارغاً وسيتم إنشاؤه تلقائياً من العنوان"
                                       style="direction: ltr;"
                                       pattern="[a-z0-9-]+"
                                       oninput="updateSlugPreview(this.value)">
                                <div class="form-hint">
                                    <i class="fas fa-globe"></i>
                                    يُقبل فقط: أحرف إنجليزية صغيرة، أرقام، وعلامة - (مثال: journey-of-self-discovery)
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    الوصف المختصر <span class="required">*</span>
                                </label>
                                <textarea class="form-control" id="courseDescription" rows="3" 
                                          placeholder="وصف موجز للدورة يظهر في نتائج البحث وصفحة الدورات..."
                                          maxlength="200"></textarea>
                                <div class="form-hint">
                                    <i class="fas fa-chart-bar"></i>
                                    <span id="descriptionCount">0</span>/200 حرف
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">الوصف التفصيلي</label>
                                <div class="editor-container">
                                    <div id="descriptionEditor"></div>
                                </div>
                                <div class="form-hint">
                                    <i class="fas fa-pen"></i>
                                    اشرح بالتفصيل ما ستقدمه في الدورة ولماذا يجب على الطلاب الالتحاق بها
                                </div>
                            </div>

                            <div class="input-group">
                                <div class="form-group">
                                    <label class="form-label">الفئة المستهدفة</label>
                                    <select class="form-control" id="targetAudience">
                                        <option value="">اختر الفئة المستهدفة</option>
                                        <option value="beginners">المبتدئين</option>
                                        <option value="intermediate">المستوى المتوسط</option>
                                        <option value="advanced">المستوى المتقدم</option>
                                        <option value="all">جميع المستويات</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">اللغة</label>
                                    <select class="form-control" id="courseLanguage">
                                        <option value="ar">العربية</option>
                                        <option value="en">English</option>
                                        <option value="ar-en">عربي + إنجليزي</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">صورة الدورة</label>
                                <div class="image-upload" id="courseImageUpload" onclick="uploadCourseImage()">
                                    <div class="upload-content">
                                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                        <div class="upload-title">اسحب الصورة هنا أو انقر للاختيار</div>
                                        <div class="upload-subtitle">1920x1080 بكسل - JPG أو PNG (حجم أقصى 5MB)</div>
                                    </div>
                                    <div class="upload-overlay">
                                        <button class="btn btn-primary">تغيير الصورة</button>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">فيديو تعريفي (اختياري)</label>
                                <input type="url" class="form-control" id="courseIntroVideo" 
                                       placeholder="رابط YouTube أو Vimeo">
                                <div class="form-hint">
                                    <i class="fas fa-video"></i>
                                    فيديو قصير (2-5 دقائق) يعرّف بالدورة ويجذب الطلاب
                                </div>
                            </div>
                        </div>

                        <!-- Learning Objectives -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-bullseye"></i>
                                </div>
                                <div>
                                    <h3 class="section-title">الأهداف التعليمية</h3>
                                    <p class="section-subtitle">ما سيتعلمه الطالب من هذه الدورة</p>
                                </div>
                            </div>
                            
                            <div class="objectives-list" id="learningObjectives">
                                <div class="objective-item">
                                    <div class="objective-number">1</div>
                                    <input type="text" class="form-control objective-input" 
                                           placeholder="سيتمكن الطالب من...">
                                    <button class="icon-btn danger" onclick="removeObjective(this)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <button class="btn btn-secondary" onclick="addObjective()">
                                <i class="fas fa-plus"></i> إضافة هدف تعليمي
                            </button>
                        </div>

                        <!-- Requirements -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-list-check"></i>
                                </div>
                                <div>
                                    <h3 class="section-title">المتطلبات المسبقة</h3>
                                    <p class="section-subtitle">ما يحتاجه الطالب قبل البدء في الدورة</p>
                                </div>
                            </div>
                            
                            <div class="requirements-list" id="courseRequirements">
                                <div class="requirement-item">
                                    <div class="requirement-icon">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <input type="text" class="form-control requirement-input" 
                                           placeholder="مثال: معرفة أساسية بـ...">
                                    <button class="icon-btn danger" onclick="removeRequirement(this)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <button class="btn btn-secondary" onclick="addRequirement()">
                                <i class="fas fa-plus"></i> إضافة متطلب
                            </button>
                        </div>

                        <!-- Instructor Info -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-user-tie"></i>
                                </div>
                                <div>
                                    <h3 class="section-title">معلومات المدرب</h3>
                                    <p class="section-subtitle">عرّف الطلاب بنفسك وخبراتك</p>
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <div class="form-group">
                                    <label class="form-label">اسم المدرب</label>
                                    <input type="text" class="form-control" id="instructorName" 
                                           placeholder="الاسم الكامل للمدرب">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">المسمى الوظيفي</label>
                                    <input type="text" class="form-control" id="instructorTitle" 
                                           placeholder="مثال: خبير تطوير الذات">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">نبذة عن المدرب</label>
                                <textarea class="form-control" id="instructorBio" rows="4" 
                                          placeholder="خبرة المدرب ومؤهلاته وإنجازاته..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">صورة المدرب</label>
                                <div class="image-upload square" id="instructorImageUpload" 
                                     onclick="uploadInstructorImage()" style="max-width: 300px;">
                                    <div class="upload-content">
                                        <i class="fas fa-user-circle upload-icon"></i>
                                        <div class="upload-title">صورة المدرب</div>
                                        <div class="upload-subtitle">500x500 بكسل</div>
                                    </div>
                                    <div class="upload-overlay">
                                        <button class="btn btn-primary">تغيير الصورة</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <div></div>
                            <button class="btn btn-primary" onclick="saveAndNext(1)">
                                حفظ والمتابعة <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Pricing & Access -->
                    <div class="step-panel" id="step2">
                        <div class="panel-header">
                            <h1 class="panel-title">التسعير والوصول</h1>
                            <p class="panel-subtitle">حدد كيف سيصل الطلاب لدورتك واستراتيجية التسعير المناسبة</p>
                        </div>

                        <!-- Pricing Strategy -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-tags"></i>
                                </div>
                                <div>
                                    <h3 class="section-title">استراتيجية التسعير</h3>
                                    <p class="section-subtitle">اختر النموذج المناسب لدورتك</p>
                                </div>
                            </div>
                            
                            <div class="pricing-options">
                                <div class="price-option active" onclick="selectPriceType('free')" data-type="free">
                                    <div class="price-option-icon">
                                        <i class="fas fa-gift"></i>
                                    </div>
                                    <div class="price-option-name">مجانية</div>
                                    <div class="price-option-desc">متاحة للجميع بدون رسوم</div>
                                    <ul class="price-features">
                                        <li><i class="fas fa-check"></i> بناء قاعدة جماهيرية</li>
                                        <li><i class="fas fa-check"></i> زيادة الانتشار</li>
                                        <li><i class="fas fa-check"></i> تسويق للدورات المدفوعة</li>
                                    </ul>
                                </div>
                                
                                <div class="price-option" onclick="selectPriceType('paid')" data-type="paid">
                                    <div class="price-option-icon">
                                        <i class="fas fa-dollar-sign"></i>
                                    </div>
                                    <div class="price-option-name">دفعة واحدة</div>
                                    <div class="price-option-desc">سعر ثابت للوصول الدائم</div>
                                    <ul class="price-features">
                                        <li><i class="fas fa-check"></i> دخل فوري</li>
                                        <li><i class="fas fa-check"></i> وصول دائم للطالب</li>
                                        <li><i class="fas fa-check"></i> إمكانية عمل عروض</li>
                                    </ul>
                                </div>
                                
                                <div class="price-option" onclick="selectPriceType('subscription')" data-type="subscription">
                                    <div class="price-option-icon">
                                        <i class="fas fa-sync"></i>
                                    </div>
                                    <div class="price-option-name">اشتراك شهري</div>
                                    <div class="price-option-desc">رسوم شهرية متكررة</div>
                                    <ul class="price-features">
                                        <li><i class="fas fa-check"></i> دخل متكرر</li>
                                        <li><i class="fas fa-check"></i> تحديثات مستمرة</li>
                                        <li><i class="fas fa-check"></i> مجتمع نشط</li>
                                    </ul>
                                </div>

                                <div class="price-option" onclick="selectPriceType('payment-plan')" data-type="payment-plan">
                                    <div class="price-option-icon">
                                        <i class="fas fa-credit-card"></i>
                                    </div>
                                    <div class="price-option-name">خطة دفع</div>
                                    <div class="price-option-desc">تقسيط المبلغ على دفعات</div>
                                    <ul class="price-features">
                                        <li><i class="fas fa-check"></i> سهولة الدفع</li>
                                        <li><i class="fas fa-check"></i> زيادة المبيعات</li>
                                        <li><i class="fas fa-check"></i> مرونة للطلاب</li>
                                    </ul>
                                </div>
                            </div>

                            <div id="pricingDetails" style="display: none;">
                                <div class="pricing-config">
                                    <div class="pricing-main">
                                        <div class="form-group">
                                            <label class="form-label">العملة</label>
                                            <select class="form-control" id="currency" onchange="updateCurrency(this.value)">
                                                <option value="SAR">ريال سعودي (SAR)</option>
                                                <option value="USD">دولار أمريكي (USD)</option>
                                                <option value="EUR">يورو (EUR)</option>
                                                <option value="EGP">جنيه مصري (EGP)</option>
                                                <option value="AED">درهم إماراتي (AED)</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">السعر الأساسي</label>
                                            <div class="currency-input">
                                                <div class="currency-symbol" id="currencySymbol">ر.س</div>
                                                <input type="number" placeholder="0.00" step="0.01" min="0" 
                                                       id="coursePrice" oninput="updatePricePreview()">
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">سعر العرض (اختياري)</label>
                                            <div class="currency-input">
                                                <div class="currency-symbol">ر.س</div>
                                                <input type="number" placeholder="0.00" step="0.01" min="0" 
                                                       id="courseSalePrice" oninput="updatePricePreview()">
                                            </div>
                                            <div class="form-hint">
                                                <i class="fas fa-percentage"></i>
                                                السعر بعد الخصم - اتركه فارغاً إذا لم يكن هناك عرض
                                            </div>
                                        </div>
                                    </div>

                                    <div class="pricing-preview">
                                        <div class="price-preview-card">
                                            <div class="preview-label">معاينة السعر</div>
                                            <div class="preview-original" id="previewOriginal" style="display: none;">
                                                <span class="original-price"></span>
                                            </div>
                                            <div class="preview-price" id="previewPrice">0</div>
                                            <div class="preview-currency" id="previewCurrency">ريال سعودي</div>
                                            <div class="preview-savings" id="previewSavings" style="display: none;">
                                                <i class="fas fa-tag"></i>
                                                <span>وفر <span id="savingsAmount">0</span> <span id="savingsCurrency">ر.س</span></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Plans -->
                        <div class="form-section" id="paymentPlansSection" style="display: none;">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div>
                                    <h3 class="section-title">خطط الدفع</h3>
                                    <p class="section-subtitle">أضف خيارات دفع مرنة للطلاب</p>
                                </div>
                            </div>

                            <div class="payment-plans-list" id="paymentPlansList">
                                <!-- Payment plans will be added here -->
                            </div>

                            <button class="btn btn-secondary" onclick="addPaymentPlan()">
                                <i class="fas fa-plus"></i> إضافة خطة دفع
                            </button>
                        </div>

                        <!-- Coupons -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-ticket-alt"></i>
                                </div>
                                <div>
                                    <h3 class="section-title">كوبونات الخصم</h3>
                                    <p class="section-subtitle">أنشئ كوبونات لتحفيز التسجيل</p>
                                </div>
                            </div>
                            
                            <div class="coupon-list" id="couponList">
                                <!-- Coupons will be added here -->
                            </div>
                            
                            <button class="btn btn-secondary" onclick="addCoupon()">
                                <i class="fas fa-plus"></i> إضافة كوبون خصم
                            </button>
                        </div>

                        <!-- Access Settings -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-users-cog"></i>
                                </div>
                                <div>
                                    <h3 class="section-title">إعدادات الوصول</h3>
                                    <p class="section-subtitle">تحكم في من يمكنه الوصول للدورة</p>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">طريقة التسجيل</label>
                                <div class="access-options">
                                    <label class="access-option">
                                        <input type="radio" name="enrollmentType" value="open" checked>
                                        <div class="access-option-content">
                                            <div class="access-option-icon">
                                                <i class="fas fa-door-open"></i>
                                            </div>
                                            <div class="access-option-info">
                                                <div class="access-option-title">تسجيل مفتوح</div>
                                                <div class="access-option-desc">يمكن لأي شخص التسجيل مباشرة</div>
                                            </div>
                                        </div>
                                    </label>

                                    <label class="access-option">
                                        <input type="radio" name="enrollmentType" value="approval">
                                        <div class="access-option-content">
                                            <div class="access-option-icon">
                                                <i class="fas fa-user-check"></i>
                                            </div>
                                            <div class="access-option-info">
                                                <div class="access-option-title">يتطلب موافقة</div>
                                                <div class="access-option-desc">مراجعة طلبات التسجيل يدوياً</div>
                                            </div>
                                        </div>
                                    </label>

                                    <label class="access-option">
                                        <input type="radio" name="enrollmentType" value="password">
                                        <div class="access-option-content">
                                            <div class="access-option-icon">
                                                <i class="fas fa-key"></i>
                                            </div>
                                            <div class="access-option-info">
                                                <div class="access-option-title">محمي بكلمة مرور</div>
                                                <div class="access-option-desc">يتطلب كلمة مرور للتسجيل</div>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="input-group">
                                <div class="form-group">
                                    <label class="form-label">عدد الطلاب المسموح</label>
                                    <input type="number" class="form-control" id="maxStudents" 
                                           placeholder="غير محدود" min="1">
                                    <div class="form-hint">
                                        <i class="fas fa-users"></i>
                                        اتركه فارغاً لعدد غير محدود
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">فترة الوصول</label>
                                    <select class="form-control" id="accessDuration">
                                        <option value="lifetime">وصول دائم</option>
                                        <option value="1month">شهر واحد</option>
                                        <option value="3months">3 أشهر</option>
                                        <option value="6months">6 أشهر</option>
                                        <option value="1year">سنة واحدة</option>
                                        <option value="custom">مخصص</option>
                                    </select>
                                </div>
                            </div>

                            <div class="input-group">
                                <div class="form-group">
                                    <label class="form-label">تاريخ البدء</label>
                                    <input type="datetime-local" class="form-control" id="startDate">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">تاريخ الانتهاء</label>
                                    <input type="datetime-local" class="form-control" id="endDate">
                                    <div class="form-hint">
                                        <i class="fas fa-calendar-times"></i>
                                        اتركه فارغاً للوصول المستمر
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="toggle-wrapper">
                                    <label class="toggle">
                                        <input type="checkbox" id="enableWaitlist">
                                        <span class="toggle"></span>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <div>
                                        <div class="toggle-label">تفعيل قائمة الانتظار</div>
                                        <div class="toggle-desc">السماح للطلاب بالتسجيل في قائمة الانتظار عند امتلاء الدورة</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <button class="btn btn-secondary" onclick="showStep(1)">
                                <i class="fas fa-arrow-right"></i> السابق
                            </button>
                            <button class="btn btn-primary" onclick="saveAndNext(2)">
                                حفظ والمتابعة <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>
/* ==================== Additional CSS for New Elements ==================== */
        
        /* Image Upload */
        .image-upload {
            border: 3px dashed var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition-base);
            background: rgba(99, 102, 241, 0.02);
            position: relative;
            overflow: hidden;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-upload:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
            transform: scale(1.01);
        }

        .image-upload.has-image {
            padding: 0;
            border-style: solid;
        }

        .image-upload.square {
            aspect-ratio: 1;
        }

        .image-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-content {
            pointer-events: none;
        }

        .upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition-base);
        }

        .image-upload:hover .upload-overlay {
            opacity: 1;
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .upload-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .upload-subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* Objectives & Requirements */
        .objectives-list,
        .requirements-list {
            margin-bottom: 1rem;
        }

        .objective-item,
        .requirement-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.8rem;
            animation: slideInLeft 0.3s ease;
        }

        .objective-number {
            width: 35px;
            height: 35px;
            background: var(--gradient-primary);
            color: white;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
            box-shadow: var(--shadow-md);
        }

        .requirement-icon {
            width: 35px;
            height: 35px;
            background: var(--gradient-secondary);
            color: white;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: var(--shadow-md);
        }

        .objective-input,
        .requirement-input {
            flex: 1;
        }

        /* Pricing Options */
        .pricing-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .price-option {
            padding: 2rem;
            background: var(--bg-card);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-lg);
            text-align: center;
            cursor: pointer;
            transition: var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .price-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: transparent;
            transition: var(--transition-base);
        }

        .price-option:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }

        .price-option.active {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .price-option.active::before {
            background: var(--gradient-primary);
        }

        .price-option-icon {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .price-option-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .price-option-desc {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .price-features {
            list-style: none;
            text-align: right;
            font-size: 0.85rem;
        }

        .price-features li {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .price-features i {
            color: var(--success);
            font-size: 0.8rem;
        }

        /* Pricing Config */
        .pricing-config {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .pricing-preview {
            position: sticky;
            top: 2rem;
        }

        .price-preview-card {
            background: var(--gradient-primary);
            color: white;
            border-radius: var(--radius-xl);
            padding: 2rem;
            text-align: center;
            box-shadow: var(--shadow-xl);
        }

        .preview-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 1rem;
        }

        .preview-original {
            margin-bottom: 0.5rem;
        }

        .original-price {
            text-decoration: line-through;
            opacity: 0.7;
            font-size: 1.2rem;
        }

        .preview-price {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .preview-currency {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .preview-savings {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-full);
            font-size: 0.9rem;
            display: inline-block;
        }

        /* Access Options */
        .access-options {
            display: grid;
            gap: 1rem;
        }

        .access-option {
            display: block;
            cursor: pointer;
        }

        .access-option input {
            display: none;
        }

        .access-option-content {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            background: var(--bg-card);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-lg);
            transition: var(--transition-base);
        }

        .access-option:hover .access-option-content {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .access-option input:checked + .access-option-content {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .access-option-icon {
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            color: white;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }

        .access-option-title {
            font-weight: 600;
            margin-bottom: 0.2rem;
            color: var(--text-primary);
        }

        .access-option-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Coupon List */
        .coupon-list {
            margin-bottom: 1rem;
        }

        .coupon-item {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition-base);
        }

        .coupon-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .coupon-info {
            flex: 1;
        }

        .coupon-code {
            font-family: monospace;
            background: var(--gradient-primary);
            color: white;
            padding: 0.4rem 1rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            display: inline-block;
            margin-bottom: 0.5rem;
        }

        .coupon-details {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .coupon-stats {
            text-align: center;
            padding: 0 2rem;
        }

        .coupon-usage {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .coupon-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .coupon-actions {
            display: flex;
            gap: 0.5rem;
        }
    </style>

    <!-- Additional CSS for Curriculum Builder -->
    <style>
        /* ==================== Curriculum Builder Styles ==================== */
        
        .curriculum-builder {
            background: rgba(30, 41, 59, 0.3);
            border-radius: var(--radius-xl);
            padding: 2rem;
            border: 1px solid var(--border-primary);
        }

        .curriculum-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .curriculum-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .curriculum-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-item i {
            color: var(--primary);
        }

        /* Modules */
        .modules-list {
            margin-bottom: 1.5rem;
        }

        .module-item {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            margin-bottom: 1.5rem;
            overflow: hidden;
            border: 2px solid var(--border-primary);
            transition: var(--transition-base);
            box-shadow: var(--shadow-md);
        }

        .module-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .module-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .module-header {
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            cursor: move;
            transition: var(--transition-base);
        }

        .module-header:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(99, 102, 241, 0.05));
        }

        .drag-handle {
            color: var(--text-muted);
            cursor: move;
            font-size: 1.2rem;
            transition: var(--transition-base);
        }

        .drag-handle:hover {
            color: var(--primary);
            transform: scale(1.2);
        }

        .module-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .module-number {
            width: 45px;
            height: 45px;
            background: var(--gradient-primary);
            color: white;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            box-shadow: var(--shadow-md);
        }

        .module-title-input {
            background: transparent;
            border: 2px solid transparent;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            flex: 1;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            transition: var(--transition-base);
        }

        .module-title-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .module-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.3rem;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .module-actions {
            display: flex;
            gap: 0.5rem;
        }

        .module-content {
            display: none;
            border-top: 1px solid var(--border-primary);
            background: var(--bg-primary);
        }

        .module-item.expanded .module-content {
            display: block;
        }

        .module-item.expanded .fa-chevron-down {
            transform: rotate(180deg);
        }

        /* Lessons */
        .lessons-container {
            padding: 1.5rem;
        }

        .lessons-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .lessons-title {
            font-weight: 600;
            color: var(--primary);
        }

        .lessons-list {
            margin-bottom: 1rem;
        }

        .lesson-item {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: var(--transition-base);
            border: 1px solid var(--border-primary);
            position: relative;
        }

        .lesson-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: transparent;
            transition: var(--transition-base);
            border-radius: var(--radius-sm) 0 0 var(--radius-sm);
        }

        .lesson-item:hover {
            border-color: var(--primary);
            transform: translateX(-5px);
            box-shadow: var(--shadow-md);
        }

        .lesson-item:hover::before {
            background: var(--gradient-primary);
        }

        .lesson-type-icon {
            width: 45px;
            height: 45px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.2rem;
            transition: var(--transition-base);
        }

        .lesson-item:hover .lesson-type-icon {
            background: var(--gradient-primary);
            color: white;
            transform: scale(1.1);
        }

        .lesson-info {
            flex: 1;
        }

        .lesson-title {
            font-weight: 600;
            margin-bottom: 0.3rem;
            color: var(--text-primary);
        }

        .lesson-meta {
            font-size: 0.85rem;
            color: var(--text-muted);
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .lesson-meta span {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .lesson-status {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: var(--radius-full);
            animation: pulse 2s infinite;
        }

        .status-dot.published {
            background: var(--success);
        }

        .status-dot.draft {
            background: var(--warning);
        }

        .lesson-actions {
            display: flex;
            gap: 0.3rem;
            opacity: 0;
            transition: var(--transition-base);
        }

        .lesson-item:hover .lesson-actions {
            opacity: 1;
        }

        /* Add Content */
        .add-content-section {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-primary);
            background: rgba(99, 102, 241, 0.02);
        }

        .add-content-btn {
            width: 100%;
            padding: 1.2rem;
            background: transparent;
            border: 2px dashed var(--primary);
            border-radius: var(--radius-lg);
            color: var(--primary);
            cursor: pointer;
            transition: var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 600;
            font-family: inherit;
            font-size: 0.95rem;
        }

        .add-content-btn:hover {
            background: rgba(99, 102, 241, 0.1);
            border-style: solid;
            transform: translateY(-2px);
        }

        .content-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.8rem;
            margin-top: 1rem;
            display: none;
        }

        .content-type-grid.show {
            display: grid;
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .content-type-option {
            padding: 1.2rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: var(--transition-base);
        }

        .content-type-option:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .content-type-icon {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .content-type-name {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* Main Add Module Button */
        .main-add-btn {
            width: 100%;
            padding: 1.5rem;
            background: var(--gradient-primary);
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            cursor: pointer;
            transition: var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            font-weight: 600;
            font-size: 1.1rem;
            font-family: inherit;
            margin-top: 2rem;
            box-shadow: var(--shadow-lg);
        }

        .main-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl), 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 4rem;
            color: var(--text-disabled);
            margin-bottom: 1rem;
        }

        .empty-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .empty-desc {
            font-size: 0.95rem;
        }
    </style>

<!-- Step 3: Curriculum -->
                    <div class="step-panel" id="step3">
                        <div class="panel-header">
                            <h1 class="panel-title">بناء منهج الدورة</h1>
                            <p class="panel-subtitle">قسّم المحتوى إلى وحدات ودروس منظمة لتوفير تجربة تعليمية متدرجة</p>
                        </div>

                        <!-- Course Structure Overview -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-sitemap"></i>
                                </div>
                                <div>
                                    <h3 class="section-title">هيكل الدورة</h3>
                                    <p class="section-subtitle">نظرة عامة على بنية المحتوى</p>
                                </div>
                            </div>

                            <div class="structure-options">
                                <label class="structure-option">
                                    <input type="radio" name="courseStructure" value="linear" checked>
                                    <div class="structure-option-content">
                                        <div class="structure-icon">
                                            <i class="fas fa-stream"></i>
                                        </div>
                                        <div class="structure-info">
                                            <div class="structure-title">خطي متسلسل</div>
                                            <div class="structure-desc">الطلاب يتقدمون درس بدرس بالترتيب</div>
                                        </div>
                                    </div>
                                </label>

                                <label class="structure-option">
                                    <input type="radio" name="courseStructure" value="flexible">
                                    <div class="structure-option-content">
                                        <div class="structure-icon">
                                            <i class="fas fa-th"></i>
                                        </div>
                                        <div class="structure-info">
                                            <div class="structure-title">مرن</div>
                                            <div class="structure-desc">الطلاب يمكنهم اختيار ترتيب الدروس</div>
                                        </div>
                                    </div>
                                </label>

                                <label class="structure-option">
                                    <input type="radio" name="courseStructure" value="prerequisite">
                                    <div class="structure-option-content">
                                        <div class="structure-icon">
                                            <i class="fas fa-project-diagram"></i>
                                        </div>
                                        <div class="structure-info">
                                            <div class="structure-title">متطلبات مسبقة</div>
                                            <div class="structure-desc">بعض الدروس تتطلب إكمال دروس معينة</div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Curriculum Builder -->
                        <div class="curriculum-builder">
                            <div class="curriculum-header">
                                <h3 class="curriculum-title">محتوى الدورة</h3>
                                <div class="curriculum-stats">
                                    <div class="stat-item">
                                        <i class="fas fa-folder"></i>
                                        <span id="modulesCount">0</span> وحدات
                                    </div>
                                    <div class="stat-item">
                                        <i class="fas fa-play-circle"></i>
                                        <span id="lessonsCount">0</span> درس
                                    </div>
                                    <div class="stat-item">
                                        <i class="fas fa-clock"></i>
                                        <span id="totalDuration">0</span> دقيقة
                                    </div>
                                </div>
                            </div>

                            <div class="modules-list" id="modulesList">
                                <!-- Modules will be dynamically added here -->
                                <div class="empty-state" id="emptyModulesState">
                                    <i class="fas fa-folder-open empty-icon"></i>
                                    <div class="empty-title">لم تضف أي وحدات بعد</div>
                                    <div class="empty-desc">ابدأ ببناء منهج دورتك بإضافة الوحدة الأولى</div>
                                </div>
                            </div>
                            
                            <button class="main-add-btn" onclick="addModule()">
                                <i class="fas fa-folder-plus"></i>
                                إضافة وحدة جديدة
                            </button>
                        </div>

                        <!-- Content Settings -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-cog"></i>
                                </div>
                                <div>
                                    <h3 class="section-title">إعدادات المحتوى</h3>
                                    <p class="section-subtitle">تحكم في كيفية عرض المحتوى للطلاب</p>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="toggle-wrapper">
                                    <label class="toggle">
                                        <input type="checkbox" id="dripContent" onchange="toggleDripSettings()">
                                        <span class="toggle"></span>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <div>
                                        <div class="toggle-label">تفعيل المحتوى المتدرج</div>
                                        <div class="toggle-desc">إطلاق المحتوى تدريجياً حسب جدول زمني محدد</div>
                                    </div>
                                </div>
                            </div>

                            <div id="dripSettings" style="display: none;">
                                <div class="drip-options">
                                    <label class="drip-option">
                                        <input type="radio" name="dripType" value="daily">
                                        <div class="drip-option-content">
                                            <div class="drip-icon">
                                                <i class="fas fa-calendar-day"></i>
                                            </div>
                                            <div class="drip-info">
                                                <div class="drip-title">يومي</div>
                                                <div class="drip-desc">درس جديد كل يوم</div>
                                            </div>
                                        </div>
                                    </label>

                                    <label class="drip-option">
                                        <input type="radio" name="dripType" value="weekly" checked>
                                        <div class="drip-option-content">
                                            <div class="drip-icon">
                                                <i class="fas fa-calendar-week"></i>
                                            </div>
                                            <div class="drip-info">
                                                <div class="drip-title">أسبوعي</div>
                                                <div class="drip-desc">وحدة جديدة كل أسبوع</div>
                                            </div>
                                        </div>
                                    </label>

                                    <label class="drip-option">
                                        <input type="radio" name="dripType" value="custom">
                                        <div class="drip-option-content">
                                            <div class="drip-icon">
                                                <i class="fas fa-calendar-alt"></i>
                                            </div>
                                            <div class="drip-info">
                                                <div class="drip-title">مخصص</div>
                                                <div class="drip-desc">جدول مخصص لكل درس</div>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="toggle-wrapper">
                                    <label class="toggle">
                                        <input type="checkbox" id="enableQuizzes" checked>
                                        <span class="toggle"></span>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <div>
                                        <div class="toggle-label">تفعيل الاختبارات</div>
                                        <div class="toggle-desc">إضافة اختبارات لتقييم فهم الطلاب</div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="toggle-wrapper">
                                    <label class="toggle">
                                        <input type="checkbox" id="enableAssignments">
                                        <span class="toggle"></span>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <div>
                                        <div class="toggle-label">تفعيل المهام</div>
                                        <div class="toggle-desc">السماح للطلاب برفع مهام وواجبات</div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">الحد الأدنى لإكمال الدرس (%)</label>
                                <input type="range" class="form-control range-input" id="minCompletion" 
                                       min="50" max="100" value="80" oninput="updateRangeValue(this)">
                                <div class="range-value">
                                    <span id="minCompletionValue">80</span>%
                                </div>
                                <div class="form-hint">
                                    <i class="fas fa-info-circle"></i>
                                    النسبة المطلوبة لاعتبار الدرس مكتملاً
                                </div>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <button class="btn btn-secondary" onclick="showStep(2)">
                                <i class="fas fa-arrow-right"></i> السابق
                            </button>
                            <button class="btn btn-primary" onclick="saveAndNext(3)">
                                حفظ والمتابعة <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>
/* ==================== Additional CSS for New Elements (continued) ==================== */
        
        /* Structure Options */
        .structure-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .structure-option {
            display: block;
            cursor: pointer;
        }

        .structure-option input {
            display: none;
        }

        .structure-option-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            background: var(--bg-card);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-lg);
            text-align: center;
            transition: var(--transition-base);
        }

        .structure-option:hover .structure-option-content {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .structure-option input:checked + .structure-option-content {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .structure-icon {
            width: 60px;
            height: 60px;
            background: var(--gradient-primary);
            color: white;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .structure-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .structure-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Drip Options */
        .drip-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .drip-option {
            display: block;
            cursor: pointer;
        }

        .drip-option input {
            display: none;
        }

        .drip-option-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-md);
            text-align: center;
            transition: var(--transition-base);
        }

        .drip-option:hover .drip-option-content {
            border-color: var(--primary);
        }

        .drip-option input:checked + .drip-option-content {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .drip-icon {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .drip-title {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .drip-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Range Input */
        .range-input {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            outline: none;
            cursor: pointer;
        }

        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--gradient-primary);
            cursor: pointer;
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-md);
            transition: var(--transition-base);
        }

        .range-input::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .range-input::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--gradient-primary);
            cursor: pointer;
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-md);
            transition: var(--transition-base);
        }

        .range-value {
            text-align: center;
            margin-top: 0.5rem;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
        }

        /* Student Experience */
        .experience-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .experience-card {
            background: var(--bg-card);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            transition: var(--transition-base);
            cursor: pointer;
        }

        .experience-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }

        .experience-card.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .experience-icon {
            width: 80px;
            height: 80px;
            background: var(--gradient-primary);
            color: white;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 1.5rem;
            box-shadow: var(--shadow-lg);
        }

        .experience-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .experience-desc {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .experience-features {
            list-style: none;
            text-align: right;
        }

        .experience-features li {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .experience-features i {
            color: var(--success);
            font-size: 0.8rem;
        }

        /* Email Templates */
        .email-templates {
            display: grid;
            gap: 1rem;
        }

        .email-template {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            transition: var(--transition-base);
        }

        .email-template:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .template-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .template-status {
            padding: 0.3rem 0.8rem;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 600;
        }

        .template-status.active {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .template-status.draft {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .template-preview {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-secondary);
        }

        .template-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Certificates */
        .certificate-preview {
            background: var(--bg-card);
            border: 2px dashed var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 3rem;
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .certificate-preview::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(99, 102, 241, 0.03) 10px,
                rgba(99, 102, 241, 0.03) 20px
            );
            transform: rotate(45deg);
        }

        .certificate-icon {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        /* Publishing Options */
        .publish-options {
            display: grid;
            gap: 1.5rem;
        }

        .publish-option {
            background: var(--bg-card);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 2rem;
            transition: var(--transition-base);
        }

        .publish-option:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .publish-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .publish-icon {
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            color: white;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }

        .publish-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .publish-desc {
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        /* SEO Preview */
        .seo-preview {
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .seo-preview-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .seo-result {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: 1rem;
        }

        .seo-title {
            color: var(--primary);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
            cursor: pointer;
        }

        .seo-url {
            color: var(--success);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .seo-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Ready State */
        .ready-state {
            text-align: center;
            padding: 3rem;
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            border: 2px solid var(--primary);
            margin: 2rem 0;
        }

        .ready-icon {
            width: 100px;
            height: 100px;
            background: var(--gradient-primary);
            color: white;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 1.5rem;
            box-shadow: var(--shadow-xl);
            animation: bounceIn 0.6s ease;
        }

        .ready-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .ready-desc {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .ready-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
    </style>
<!-- Step 4: Student Experience -->
                    <div class="step-panel" id="step4">
                        <div class="panel-header">
                            <h1 class="panel-title">تجربة الطالب</h1>
                            <p class="panel-subtitle">صمم تجربة تعليمية مميزة ومحفزة لطلابك</p>
                        </div>

                        <!-- Learning Experience -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-graduation-cap"></i>
                                </div>
                                <div>
                                    <h3 class="section-title">نمط التعلم</h3>
                                    <p class="section-subtitle">اختر الطريقة المناسبة لتقديم المحتوى</p>
                                </div>
                            </div>

                            <div class="experience-grid">
                                <div class="experience-card selected" onclick="selectExperience(this, 'self-paced')">
                                    <div class="experience-icon">
                                        <i class="fas fa-user-clock"></i>
                                    </div>
                                    <h4 class="experience-title">ذاتي السرعة</h4>
                                    <p class="experience-desc">يتقدم الطلاب حسب سرعتهم الخاصة</p>
                                    <ul class="experience-features">
                                        <li><i class="fas fa-check"></i> مرونة كاملة</li>
                                        <li><i class="fas fa-check"></i> وصول دائم</li>
                                        <li><i class="fas fa-check"></i> تعلم مستقل</li>
                                    </ul>
                                </div>

                                <div class="experience-card" onclick="selectExperience(this, 'cohort-based')">
                                    <div class="experience-icon">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <h4 class="experience-title">مجموعات</h4>
                                    <p class="experience-desc">دفعات تبدأ في تواريخ محددة</p>
                                    <ul class="experience-features">
                                        <li><i class="fas fa-check"></i> تفاعل جماعي</li>
                                        <li><i class="fas fa-check"></i> دعم الأقران</li>
                                        <li><i class="fas fa-check"></i> جلسات حية</li>
                                    </ul>
                                </div>

                                <div class="experience-card" onclick="selectExperience(this, 'hybrid')">
                                    <div class="experience-icon">
                                        <i class="fas fa-layer-group"></i>
                                    </div>
                                    <h4 class="experience-title">مختلط</h4>
                                    <p class="experience-desc">دمج التعلم الذاتي مع الجلسات الحية</p>
                                    <ul class="experience-features">
                                        <li><i class="fas fa-check"></i> أفضل النمطين</li>
                                        <li><i class="fas fa-check"></i> مرونة وتفاعل</li>
                                        <li><i class="fas fa-check"></i> دعم شامل</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Student Progress -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div>
                                    <h3 class="section-title">تتبع التقدم</h3>
                                    <p class="section-subtitle">كيف سيتابع الطلاب تقدمهم في الدورة</p>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="toggle-wrapper">
                                    <label class="toggle">
                                        <input type="checkbox" id="showProgressBar" checked>
                                        <span class="toggle"></span>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <div>
                                        <div class="toggle-label">عرض شريط التقدم</div>
                                        <div class="toggle-desc">إظهار نسبة إكمال الدورة للطلاب</div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="toggle-wrapper">
                                    <label class="toggle">
                                        <input type="checkbox" id="showCompletionBadges" checked>
                                        <span class="toggle"></span>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <div>
                                        <div class="toggle-label">شارات الإنجاز</div>
                                        <div class="toggle-desc">منح شارات عند إكمال مراحل معينة</div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="toggle-wrapper">
                                    <label class="toggle">
                                        <input type="checkbox" id="sendProgressEmails">
                                        <span class="toggle"></span>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <div>
                                        <div class="toggle-label">رسائل تحفيزية</div>
                                        <div class="toggle-desc">إرسال رسائل تشجيعية حسب التقدم</div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">معدل الإكمال المتوقع</label>
                                <select class="form-control" id="expectedCompletion">
                                    <option value="1week">أسبوع واحد</option>
                                    <option value="2weeks">أسبوعان</option>
                                    <option value="1month" selected>شهر واحد</option>
                                    <option value="2months">شهران</option>
                                    <option value="3months">3 أشهر</option>
                                    <option value="custom">مخصص</option>
                                </select>
                                <div class="form-hint">
                                    <i class="fas fa-info-circle"></i>
                                    المدة المتوقعة لإكمال الطالب للدورة
                                </div>
                            </div>
                        </div>

                        <!-- Certificates -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-certificate"></i>
                                </div>
                                <div>
                                    <h3 class="section-title">الشهادات</h3>
                                    <p class="section-subtitle">منح شهادات إتمام للطلاب المتميزين</p>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="toggle-wrapper">
                                    <label class="toggle">
                                        <input type="checkbox" id="certificateEnabled" checked>
                                        <span class="toggle"></span>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <div>
                                        <div class="toggle-label">منح شهادة عند الإتمام</div>
                                        <div class="toggle-desc">يحصل الطالب على شهادة عند إكمال الدورة</div>
                                    </div>
                                </div>
                            </div>

                            <div id="certificateSettings">
                                <div class="certificate-preview">
                                    <i class="fas fa-award certificate-icon"></i>
                                    <h4>شهادة إتمام الدورة</h4>
                                    <p>سيحصل الطلاب على شهادة رسمية باسمهم عند إكمال جميع متطلبات الدورة</p>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">نسبة الإتمام المطلوبة (%)</label>
                                    <input type="range" class="form-control range-input" id="certificateThreshold" 
                                           min="60" max="100" value="80" step="5" oninput="updateRangeValue(this)">
                                    <div class="range-value">
                                        <span id="certificateThresholdValue">80</span>%
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">متطلبات الحصول على الشهادة</label>
                                    <div class="certificate-requirements">
                                        <label class="requirement-option">
                                            <input type="checkbox" checked>
                                            <span>إكمال جميع الدروس</span>
                                        </label>
                                        <label class="requirement-option">
                                            <input type="checkbox">
                                            <span>اجتياز الاختبار النهائي</span>
                                        </label>
                                        <label class="requirement-option">
                                            <input type="checkbox">
                                            <span>تسليم جميع المهام</span>
                                        </label>
                                        <label class="requirement-option">
                                            <input type="checkbox">
                                            <span>المشاركة في المناقشات</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Student Communication -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-envelope"></i>
                                </div>
                                <div>
                                    <h3 class="section-title">التواصل مع الطلاب</h3>
                                    <p class="section-subtitle">رسائل تلقائية لتحسين تجربة التعلم</p>
                                </div>
                            </div>

                            <div class="email-templates">
                                <div class="email-template">
                                    <div class="template-header">
                                        <h4 class="template-name">رسالة الترحيب</h4>
                                        <span class="template-status active">مفعّل</span>
                                    </div>
                                    <div class="template-preview">
                                        ترسل فور التسجيل في الدورة لترحيب الطالب وتوجيهه للبداية الصحيحة
                                    </div>
                                    <div class="template-actions">
                                        <button class="btn btn-secondary btn-sm" onclick="editEmailTemplate('welcome')">
                                            <i class="fas fa-edit"></i> تعديل
                                        </button>
                                        <button class="btn btn-secondary btn-sm" onclick="previewEmailTemplate('welcome')">
                                            <i class="fas fa-eye"></i> معاينة
                                        </button>
                                    </div>
                                </div>

                                <div class="email-template">
                                    <div class="template-header">
                                        <h4 class="template-name">تذكير بالإكمال</h4>
                                        <span class="template-status active">مفعّل</span>
                                    </div>
                                    <div class="template-preview">
                                        ترسل للطلاب غير النشطين لتحفيزهم على العودة وإكمال الدورة
                                    </div>
                                    <div class="template-actions">
                                        <button class="btn btn-secondary btn-sm" onclick="editEmailTemplate('reminder')">
                                            <i class="fas fa-edit"></i> تعديل
                                        </button>
                                        <button class="btn btn-secondary btn-sm" onclick="previewEmailTemplate('reminder')">
                                            <i class="fas fa-eye"></i> معاينة
                                        </button>
                                    </div>
                                </div>

                                <div class="email-template">
                                    <div class="template-header">
                                        <h4 class="template-name">تهنئة بالإتمام</h4>
                                        <span class="template-status active">مفعّل</span>
                                    </div>
                                    <div class="template-preview">
                                        ترسل عند إكمال الدورة مع رابط تحميل الشهادة
                                    </div>
                                    <div class="template-actions">
                                        <button class="btn btn-secondary btn-sm" onclick="editEmailTemplate('completion')">
                                            <i class="fas fa-edit"></i> تعديل
                                        </button>
                                        <button class="btn btn-secondary btn-sm" onclick="previewEmailTemplate('completion')">
                                            <i class="fas fa-eye"></i> معاينة
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <button class="btn btn-secondary" onclick="addEmailTemplate()">
                                <i class="fas fa-plus"></i> إضافة قالب رسالة
                            </button>
                        </div>

                        <!-- Student Support -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-headset"></i>
                                </div>
                                <div>
                                    <h3 class="section-title">الدعم والمساعدة</h3>
                                    <p class="section-subtitle">توفير الدعم المناسب للطلاب</p>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="toggle-wrapper">
                                    <label class="toggle">
                                        <input type="checkbox" id="enableComments" checked>
                                        <span class="toggle"></span>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <div>
                                        <div class="toggle-label">السماح بالتعليقات</div>
                                        <div class="toggle-desc">يمكن للطلاب التعليق والسؤال في كل درس</div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="toggle-wrapper">
                                    <label class="toggle">
                                        <input type="checkbox" id="enableForum">
                                        <span class="toggle"></span>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <div>
                                        <div class="toggle-label">منتدى النقاش</div>
                                        <div class="toggle-desc">مساحة خاصة للنقاش بين الطلاب</div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="toggle-wrapper">
                                    <label class="toggle">
                                        <input type="checkbox" id="enableLiveSupport">
                                        <span class="toggle"></span>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <div>
                                        <div class="toggle-label">دعم مباشر</div>
                                        <div class="toggle-desc">دردشة حية مع المدرب أو فريق الدعم</div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">ساعات الدعم</label>
                                <select class="form-control" id="supportHours">
                                    <option value="24/7">24/7 - على مدار الساعة</option>
                                    <option value="business">ساعات العمل (9 ص - 5 م)</option>
                                    <option value="extended">موسع (9 ص - 9 م)</option>
                                    <option value="custom">مخصص</option>
                                </select>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <button class="btn btn-secondary" onclick="showStep(3)">
                                <i class="fas fa-arrow-right"></i> السابق
                            </button>
                            <button class="btn btn-primary" onclick="saveAndNext(4)">
                                حفظ والمتابعة <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 5: Publishing -->
                    <div class="step-panel" id="step5">
                        <div class="panel-header">
                            <h1 class="panel-title">النشر والتسويق</h1>
                            <p class="panel-subtitle">جهّز دورتك للنشر وحسّن ظهورها في محركات البحث</p>
                        </div>

                        <!-- SEO Optimization -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-search"></i>
                                </div>
                                <div>
                                    <h3 class="section-title">تحسين محركات البحث (SEO)</h3>
                                    <p class="section-subtitle">ساعد الطلاب في العثور على دورتك بسهولة</p>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">العنوان في محركات البحث</label>
                                <input type="text" class="form-control" id="seoTitle" 
                                       placeholder="سيتم استخدام عنوان الدورة" maxlength="60">
                                <div class="form-hint">
                                    <i class="fas fa-chart-bar"></i>
                                    <span id="seoTitleCount">0</span>/60 حرف - الأمثل بين 50-60 حرف
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">الوصف في محركات البحث</label>
                                <textarea class="form-control" id="seoDescription" rows="3" 
                                          placeholder="سيتم استخدام الوصف المختصر" maxlength="160"></textarea>
                                <div class="form-hint">
                                    <i class="fas fa-chart-bar"></i>
                                    <span id="seoDescCount">0</span>/160 حرف - الأمثل بين 150-160 حرف
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">الكلمات المفتاحية</label>
                                <div class="tags-input" id="keywordsContainer">
                                    <input type="text" class="tag-input" id="keywordInput" 
                                           placeholder="اكتب كلمة واضغط Enter">
                                </div>
                                <div class="form-hint">
                                    <i class="fas fa-tags"></i>
                                    أضف 5-10 كلمات مفتاحية ذات صلة بمحتوى الدورة
                                </div>
                            </div>

                            <div class="seo-preview">
                                <div class="seo-preview-label">معاينة في نتائج البحث</div>
                                <div class="seo-result">
                                    <div class="seo-title" id="seoPreviewTitle">عنوان الدورة يظهر هنا</div>
                                    <div class="seo-url" id="seoPreviewUrl">
                                        mahmoudfouad25.github.io/fouad-perspective/courses/course-url
                                    </div>
                                    <div class="seo-description" id="seoPreviewDesc">
                                        وصف الدورة يظهر هنا في نتائج البحث...
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Social Media -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-share-alt"></i>
                                </div>
                                <div>
                                    <h3 class="section-title">وسائل التواصل الاجتماعي</h3>
                                    <p class="section-subtitle">حسّن ظهور دورتك عند المشاركة</p>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">صورة المشاركة</label>
                                <div class="image-upload" id="socialImageUpload" onclick="uploadSocialImage()">
                                    <div class="upload-content">
                                        <i class="fas fa-image upload-icon"></i>
                                        <div class="upload-title">صورة وسائل التواصل</div>
                                        <div class="upload-subtitle">1200x630 بكسل - مثالية لفيسبوك ولينكد إن</div>
                                    </div>
                                    <div class="upload-overlay">
                                        <button class="btn btn-primary">تغيير الصورة</button>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">وصف المشاركة</label>
                                <textarea class="form-control" id="socialDescription" rows="2" 
                                          placeholder="وصف مختصر يظهر عند مشاركة الدورة" maxlength="200"></textarea>
                            </div>

                            <div class="form-group">
                                <div class="toggle-wrapper">
                                    <label class="toggle">
                                        <input type="checkbox" id="allowSharing" checked>
                                        <span class="toggle"></span>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <div>
                                        <div class="toggle-label">السماح بالمشاركة</div>
                                        <div class="toggle-desc">إظهار أزرار المشاركة في صفحة الدورة</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Publishing Options -->
                        <div class="form-section">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="fas fa-rocket"></i>
                                </div>
                                <div>
                                    <h3 class="section-title">خيارات النشر</h3>
                                    <p class="section-subtitle">حدد كيف ومتى تريد نشر دورتك</p>
                                </div>
                            </div>

                            <div class="publish-options">
                                <div class="publish-option">
                                    <div class="publish-header">
                                        <div class="publish-icon">
                                            <i class="fas fa-globe"></i>
                                        </div>
                                        <div>
                                            <h4 class="publish-title">النشر العام</h4>
                                        </div>
                                    </div>
                                    <p class="publish-desc">ستكون الدورة متاحة لجميع الزوار في صفحة الدورات</p>
                                    <div class="toggle-wrapper">
                                        <label class="toggle">
                                            <input type="checkbox" id="isPublic" checked>
                                            <span class="toggle"></span>
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span>نشر في صفحة الدورات العامة</span>
                                    </div>
                                </div>

                                <div class="publish-option">
                                    <div class="publish-header">
                                        <div class="publish-icon">
                                            <i class="fas fa-link"></i>
                                        </div>
                                        <div>
                                            <h4 class="publish-title">رابط خاص</h4>
                                        </div>
                                    </div>
                                    <p class="publish-desc">الدورة متاحة فقط لمن لديه الرابط المباشر</p>
                                    <div class="toggle-wrapper">
                                        <label class="toggle">
                                            <input type="checkbox" id="privateLink">
                                            <span class="toggle"></span>
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span>تفعيل الرابط الخاص</span>
                                    </div>
                                </div>

                                <div class="publish-option">
                                    <div class="publish-header">
                                        <div class="publish-icon">
                                            <i class="fas fa-calendar"></i>
                                        </div>
                                        <div>
                                            <h4 class="publish-title">النشر المجدول</h4>
                                        </div>
                                    </div>
                                    <p class="publish-desc">جدولة نشر الدورة في تاريخ محدد</p>
                                    <div class="form-group">
                                        <input type="datetime-local" class="form-control" id="scheduledPublish">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ready to Publish -->
                        <div class="ready-state">
                            <div class="ready-icon">
                                <i class="fas fa-check"></i>
                            </div>
                            <h2 class="ready-title">دورتك جاهزة للنشر!</h2>
                            <p class="ready-desc">
                                راجع جميع المعلومات قبل النشر. يمكنك دائماً تعديل الدورة لاحقاً.
                            </p>
                            <div class="ready-actions">
                                <button class="btn btn-secondary" onclick="saveDraft()">
                                    <i class="fas fa-save"></i> حفظ كمسودة
                                </button>
                                <button class="btn btn-primary" onclick="publishCourse()">
                                    <i class="fas fa-rocket"></i> نشر الدورة الآن
                                </button>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <button class="btn btn-secondary" onclick="showStep(4)">
                                <i class="fas fa-arrow-right"></i> السابق
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
<!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="../js/firebase-config.js"></script>
    
    <script>
        // ==================== Global Variables ====================
        let courseData = {
            id: null,
            title: 'دورة جديدة',
            subtitle: '',
            slug: '',
            description: '',
            detailedDescription: '',
            targetAudience: 'all',
            language: 'ar',
            objectives: [],
            requirements: [],
            thumbnail: null,
            thumbnailUrl: null,
            introVideo: '',
            socialImage: null,
            socialImageUrl: null,
            instructorName: '',
            instructorTitle: '',
            instructorBio: '',
            instructorImage: null,
            // Pricing
            priceType: 'free',
            currency: 'SAR',
            price: 0,
            salePrice: null,
            paymentPlans: [],
            coupons: [],
            // Access
            enrollmentType: 'open',
            maxStudents: null,
            accessDuration: 'lifetime',
            startDate: null,
            endDate: null,
            enableWaitlist: false,
            // Curriculum
            courseStructure: 'linear',
            modules: [],
            dripContent: false,
            dripType: 'weekly',
            enableQuizzes: true,
            enableAssignments: false,
            minCompletion: 80,
            // Student Experience
            learningType: 'self-paced',
            showProgressBar: true,
            showCompletionBadges: true,
            sendProgressEmails: false,
            expectedCompletion: '1month',
            // Certificates
            certificate: true,
            certificateThreshold: 80,
            certificateRequirements: ['complete_lessons'],
            // Support
            enableComments: true,
            enableForum: false,
            enableLiveSupport: false,
            supportHours: 'business',
            // SEO & Marketing
            seoTitle: '',
            seoDescription: '',
            keywords: [],
            socialDescription: '',
            allowSharing: true,
            // Publishing
            isPublic: true,
            privateLink: false,
            scheduledPublish: null,
            status: 'draft',
            publishedAt: null,
            // Stats
            progress: 20,
            totalLessons: 0,
            totalDuration: 0,
            createdAt: null,
            updatedAt: null
        };

        let currentStep = 1;
        let quillEditor = null;
        let autoSaveTimeout = null;
        let isLoading = false;

        // Currency symbols mapping
        const currencySymbols = {
            'SAR': 'ر.س',
            'USD': '$',
            'EUR': '€',
            'EGP': 'ج.م',
            'AED': 'د.إ'
        };

        // ==================== Initialize ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (window.firebaseAuth && window.firebaseAuth.protectAdminPage) {
                window.firebaseAuth.protectAdminPage();
            }

            // Initialize components
            initializeEditor();
            loadCourseData();
            setupEventListeners();
            updateProgress();
            initializeSortable();
            setupCharacterCounters();
            setupTagsInput();
        });

        // ==================== Quill Editor ====================
        function initializeEditor() {
            const editorElement = document.getElementById('descriptionEditor');
            if (editorElement && typeof Quill !== 'undefined') {
                try {
                    editorElement.innerHTML = '';
                    
                    quillEditor = new Quill('#descriptionEditor', {
                        theme: 'snow',
                        placeholder: 'اكتب وصفاً تفصيلياً للدورة...',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                [{ 'align': [] }],
                                [{ 'color': [] }, { 'background': [] }],
                                ['link', 'image'],
                                ['clean']
                            ]
                        }
                    });
                    
                    // Custom styles for dark theme
                    const editorContainer = document.querySelector('.ql-container');
                    const toolbar = document.querySelector('.ql-toolbar');
                    
                    if (toolbar) {
                        toolbar.style.borderColor = 'var(--border-primary)';
                        toolbar.style.background = 'var(--bg-secondary)';
                    }
                    
                    if (editorContainer) {
                        editorContainer.style.borderColor = 'var(--border-primary)';
                    }
                    
                    quillEditor.on('text-change', function(delta, oldDelta, source) {
                        if (source === 'user') {
                            courseData.detailedDescription = quillEditor.root.innerHTML;
                            autoSave();
                        }
                    });
                } catch (error) {
                    console.error('Error initializing Quill editor:', error);
                }
            }
        }

        // ==================== Event Listeners ====================
        function setupEventListeners() {
            // Course title sync
            const courseTitleInput = document.getElementById('courseTitle');
            const courseTitleMainInput = document.getElementById('courseTitleMain');
            
            if (courseTitleInput) {
                courseTitleInput.addEventListener('input', function(e) {
                    courseData.title = e.target.value;
                    if (courseTitleMainInput) {
                        courseTitleMainInput.value = e.target.value;
                    }
                    updateSlugPreview('');
                    updateSeoPreview();
                    autoSaveTitle();
                });
            }
            
            if (courseTitleMainInput) {
                courseTitleMainInput.addEventListener('input', function(e) {
                    courseData.title = e.target.value;
                    if (courseTitleInput) {
                        courseTitleInput.value = e.target.value;
                    }
                    updateSlugPreview('');
                    updateSeoPreview();
                    autoSaveTitle();
                });
            }

            // Slug input
            const slugInput = document.getElementById('courseSlug');
            if (slugInput) {
                slugInput.addEventListener('input', function(e) {
                    this.value = this.value.toLowerCase().replace(/[^a-z0-9-]/g, '');
                    courseData.slug = this.value;
                    updateSlugPreview(this.value);
                    updateSeoPreview();
                    autoSave();
                });
            }

            // Text inputs mapping
            const textInputs = {
                'courseSubtitle': 'subtitle',
                'courseDescription': 'description',
                'courseIntroVideo': 'introVideo',
                'instructorName': 'instructorName',
                'instructorTitle': 'instructorTitle',
                'instructorBio': 'instructorBio',
                'coursePrice': 'price',
                'courseSalePrice': 'salePrice',
                'maxStudents': 'maxStudents',
                'seoTitle': 'seoTitle',
                'seoDescription': 'seoDescription',
                'socialDescription': 'socialDescription'
            };

            Object.keys(textInputs).forEach(inputId => {
                const element = document.getElementById(inputId);
                if (element) {
                    element.addEventListener('input', function(e) {
                        let value = e.target.value;
                        
                        // Type conversions
                        if (inputId === 'coursePrice' || inputId === 'courseSalePrice') {
                            value = parseFloat(value) || 0;
                        } else if (inputId === 'maxStudents') {
                            value = parseInt(value) || null;
                        }
                        
                        courseData[textInputs[inputId]] = value;
                        
                        // Update previews
                        if (inputId === 'coursePrice' || inputId === 'courseSalePrice') {
                            updatePricePreview();
                        }
                        if (inputId === 'seoTitle' || inputId === 'seoDescription' || inputId === 'courseDescription') {
                            updateSeoPreview();
                        }
                        
                        autoSave();
                    });
                }
            });

            // Select inputs mapping
            const selectInputs = {
                'targetAudience': 'targetAudience',
                'courseLanguage': 'language',
                'currency': 'currency',
                'accessDuration': 'accessDuration',
                'expectedCompletion': 'expectedCompletion',
                'supportHours': 'supportHours'
            };

            Object.keys(selectInputs).forEach(selectId => {
                const element = document.getElementById(selectId);
                if (element) {
                    element.addEventListener('change', function(e) {
                        courseData[selectInputs[selectId]] = e.target.value;
                        
                        if (selectId === 'currency') {
                            updateCurrency(e.target.value);
                        }
                        
                        autoSave();
                    });
                }
            });

            // Date inputs
            ['startDate', 'endDate', 'scheduledPublish'].forEach(dateId => {
                const element = document.getElementById(dateId);
                if (element) {
                    element.addEventListener('change', function(e) {
                        courseData[dateId] = e.target.value;
                        autoSave();
                    });
                }
            });

            // Checkboxes mapping
            const checkboxes = {
                'enableWaitlist': 'enableWaitlist',
                'dripContent': 'dripContent',
                'enableQuizzes': 'enableQuizzes',
                'enableAssignments': 'enableAssignments',
                'showProgressBar': 'showProgressBar',
                'showCompletionBadges': 'showCompletionBadges',
                'sendProgressEmails': 'sendProgressEmails',
                'certificateEnabled': 'certificate',
                'enableComments': 'enableComments',
                'enableForum': 'enableForum',
                'enableLiveSupport': 'enableLiveSupport',
                'allowSharing': 'allowSharing',
                'isPublic': 'isPublic',
                'privateLink': 'privateLink'
            };

            Object.keys(checkboxes).forEach(checkboxId => {
                const element = document.getElementById(checkboxId);
                if (element) {
                    element.addEventListener('change', function(e) {
                        courseData[checkboxes[checkboxId]] = e.target.checked;
                        
                        // Handle dependent elements
                        if (checkboxId === 'dripContent') {
                            toggleDripSettings();
                        }
                        if (checkboxId === 'certificateEnabled') {
                            document.getElementById('certificateSettings').style.display = 
                                e.target.checked ? 'block' : 'none';
                        }
                        
                        autoSave();
                    });
                }
            });

            // Radio inputs
            const radioGroups = ['courseStructure', 'enrollmentType', 'dripType'];
            radioGroups.forEach(groupName => {
                document.querySelectorAll(`input[name="${groupName}"]`).forEach(radio => {
                    radio.addEventListener('change', function(e) {
                        courseData[groupName] = e.target.value;
                        autoSave();
                    });
                });
            });

            // Range inputs
            const rangeInputs = {
                'minCompletion': 'minCompletion',
                'certificateThreshold': 'certificateThreshold'
            };

            Object.keys(rangeInputs).forEach(rangeId => {
                const element = document.getElementById(rangeId);
                if (element) {
                    element.addEventListener('input', function(e) {
                        courseData[rangeInputs[rangeId]] = parseInt(e.target.value);
                        updateRangeValue(element);
                        autoSave();
                    });
                }
            });

            // Objectives event listeners
            document.querySelectorAll('.objective-input').forEach(input => {
                input.addEventListener('input', updateObjectives);
            });

            // Requirements event listeners
            document.querySelectorAll('.requirement-input').forEach(input => {
                input.addEventListener('input', updateRequirements);
            });
        }

        // ==================== Character Counters ====================
        function setupCharacterCounters() {
            // Description counter
            const descInput = document.getElementById('courseDescription');
            if (descInput) {
                descInput.addEventListener('input', function() {
                    document.getElementById('descriptionCount').textContent = this.value.length;
                });
            }

            // SEO title counter
            const seoTitleInput = document.getElementById('seoTitle');
            if (seoTitleInput) {
                seoTitleInput.addEventListener('input', function() {
                    document.getElementById('seoTitleCount').textContent = this.value.length;
                });
            }

            // SEO description counter
            const seoDescInput = document.getElementById('seoDescription');
            if (seoDescInput) {
                seoDescInput.addEventListener('input', function() {
                    document.getElementById('seoDescCount').textContent = this.value.length;
                });
            }
        }

        // ==================== Tags Input ====================
        function setupTagsInput() {
            const keywordInput = document.getElementById('keywordInput');
            const container = document.getElementById('keywordsContainer');
            
            if (!keywordInput || !container) return;

            keywordInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    const value = this.value.trim();
                    if (value && !courseData.keywords.includes(value)) {
                        addKeywordTag(value);
                        courseData.keywords.push(value);
                        this.value = '';
                        autoSave();
                    }
                }
            });

            // Click on container to focus input
            container.addEventListener('click', function() {
                keywordInput.focus();
            });
        }

        function addKeywordTag(keyword) {
            const container = document.getElementById('keywordsContainer');
            const input = container.querySelector('.tag-input');
            
            const tag = document.createElement('span');
            tag.className = 'keyword-tag';
            tag.innerHTML = `
                ${keyword}
                <i class="fas fa-times" onclick="removeKeyword('${keyword}')"></i>
            `;
            
            container.insertBefore(tag, input);
        }

        function removeKeyword(keyword) {
            courseData.keywords = courseData.keywords.filter(k => k !== keyword);
            setupKeywordTags();
            autoSave();
        }

        function setupKeywordTags() {
            const container = document.getElementById('keywordsContainer');
            if (!container) return;
            
            // Remove existing tags
            container.querySelectorAll('.keyword-tag').forEach(tag => tag.remove());
            
            // Add tags from data
            courseData.keywords.forEach(keyword => {
                addKeywordTag(keyword);
            });
        }

        // ==================== Navigation ====================
        function showStep(stepNumber) {
            // Update navigation
            document.querySelectorAll('.step-item').forEach(item => {
                item.classList.remove('active');
                const itemStep = parseInt(item.dataset.step);
                if (itemStep === stepNumber) {
                    item.classList.add('active');
                }
                if (itemStep < stepNumber) {
                    item.classList.add('completed');
                } else {
                    item.classList.remove('completed');
                }
            });
            
            // Show step panel
            document.querySelectorAll('.step-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            const targetPanel = document.getElementById(`step${stepNumber}`);
            if (targetPanel) {
                targetPanel.classList.add('active');
            }
            
            currentStep = stepNumber;
            
            // Scroll to top
            const mainPanel = document.querySelector('.main-panel');
            if (mainPanel) {
                mainPanel.scrollTop = 0;
            }

            // Update URL
            const url = new URL(window.location);
            url.searchParams.set('step', stepNumber);
            window.history.replaceState({}, '', url);
        }

        function saveAndNext(currentStepNum) {
            saveCourseData().then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'تم الحفظ',
                    text: 'تم حفظ البيانات بنجاح',
                    timer: 1500,
                    showConfirmButton: false,
                    background: 'var(--bg-card)',
                    color: 'var(--text-primary)'
                });
                
                if (currentStepNum < 5) {
                    showStep(currentStepNum + 1);
                }
                
                updateProgress();
            }).catch(error => {
                console.error('Error saving:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'حدث خطأ في حفظ البيانات',
                    background: 'var(--bg-card)',
                    color: 'var(--text-primary)'
                });
            });
        }

        // ==================== Auto Save ====================
        function autoSave() {
            clearTimeout(autoSaveTimeout);
            
            const saveIndicator = document.getElementById('saveIndicator');
            if (saveIndicator) {
                saveIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>جاري الحفظ...</span>';
                saveIndicator.classList.add('saving');
                saveIndicator.classList.remove('saved');
            }
            
            autoSaveTimeout = setTimeout(() => {
                saveCourseData().then(() => {
                    if (saveIndicator) {
                        saveIndicator.innerHTML = '<i class="fas fa-check-circle"></i> <span>تم الحفظ</span>';
                        saveIndicator.classList.remove('saving');
                        saveIndicator.classList.add('saved');
                        
                        setTimeout(() => {
                            saveIndicator.classList.remove('saved');
                        }, 3000);
                    }
                }).catch(error => {
                    console.error('Auto save error:', error);
                    if (saveIndicator) {
                        saveIndicator.innerHTML = '<i class="fas fa-exclamation-circle"></i> <span>خطأ في الحفظ</span>';
                        saveIndicator.classList.remove('saving');
                    }
                });
            }, 2000);
        }

        function autoSaveTitle() {
            clearTimeout(autoSaveTimeout);
            
            const saveIndicator = document.getElementById('saveIndicator');
            if (saveIndicator) {
                saveIndicator.innerHTML = '<i class="fas fa-clock"></i> <span>في انتظار الحفظ...</span>';
                saveIndicator.classList.add('saving');
                saveIndicator.classList.remove('saved');
            }
            
            autoSaveTimeout = setTimeout(() => {
                saveCourseData().then(() => {
                    if (saveIndicator) {
                        saveIndicator.innerHTML = '<i class="fas fa-check-circle"></i> <span>تم الحفظ</span>';
                        saveIndicator.classList.remove('saving');
                        saveIndicator.classList.add('saved');
                        
                        setTimeout(() => {
                            saveIndicator.classList.remove('saved');
                        }, 3000);
                    }
                });
            }, 5000);
        }

        // ==================== Firebase Operations ====================
        async function saveCourseData() {
            if (!firebase.firestore || isLoading) {
                return Promise.reject('Firestore not initialized or already loading');
            }
            
            isLoading = true;
            
            try {
                // Determine slug
                let finalSlug = courseData.slug;
                
                const slugInput = document.getElementById('courseSlug');
                if (slugInput && slugInput.value.trim()) {
                    finalSlug = slugInput.value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '');
                }
                
                if (!finalSlug && courseData.title && courseData.title !== 'دورة جديدة') {
                    finalSlug = generateSlug(courseData.title);
                }
                
                if (!finalSlug) {
                    const now = new Date();
                    finalSlug = `course-${now.getTime()}`;
                }
                
                const dataToSave = {
                    ...courseData,
                    slug: finalSlug,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Remove undefined values
                Object.keys(dataToSave).forEach(key => {
                    if (dataToSave[key] === undefined) {
                        delete dataToSave[key];
                    }
                });
                
                if (courseData.id) {
                    // Update existing course
                    await window.firebaseDB.courses.updateCourse(courseData.id, dataToSave);
                } else {
                    // Create new course
                    dataToSave.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    const newId = await window.firebaseDB.courses.createCourse(dataToSave);
                    courseData.id = newId;
                    courseData.slug = finalSlug;
                    
                    // Update URL
                    const newUrl = `${window.location.pathname}?id=${newId}`;
                    window.history.replaceState({}, '', newUrl);
                    
                    // Update slug preview
                    const slugPreview = document.getElementById('slugPreview');
                    if (slugPreview) {
                        slugPreview.textContent = finalSlug;
                    }
                    
                    if (slugInput) {
                        slugInput.value = finalSlug;
                    }
                }
                
                isLoading = false;
                return Promise.resolve();
            } catch (error) {
                isLoading = false;
                console.error('Error saving course:', error);
                return Promise.reject(error);
            }
        }

        async function loadCourseData() {
            const urlParams = new URLSearchParams(window.location.search);
            const courseId = urlParams.get('id');
            const step = urlParams.get('step');
            
            if (step) {
                showStep(parseInt(step));
            }
            
            if (courseId && firebase.firestore) {
                try {
                    const doc = await window.firebaseDB.courses.getCourse(courseId);
                    
                    if (doc) {
                        courseData = { id: courseId, ...doc };
                        updateUIWithCourseData();
                        updateProgress();
                    }
                } catch (error) {
                    console.error('Error loading course:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'خطأ',
                        text: 'حدث خطأ في تحميل بيانات الدورة',
                        background: 'var(--bg-card)',
                        color: 'var(--text-primary)'
                    });
                }
            }
        }

        // ==================== UI Updates ====================
        function updateUIWithCourseData() {
            // Basic info
            if (courseData.title) {
                document.getElementById('courseTitle').value = courseData.title;
                document.getElementById('courseTitleMain').value = courseData.title;
            }
            
            // Update all text fields
            const textFields = ['subtitle', 'slug', 'description', 'introVideo', 
                               'instructorName', 'instructorTitle', 'instructorBio',
                               'seoTitle', 'seoDescription', 'socialDescription'];
            
            textFields.forEach(field => {
                const element = document.getElementById('course' + field.charAt(0).toUpperCase() + field.slice(1));
                if (element && courseData[field]) {
                    element.value = courseData[field];
                }
            });
            
            // Rich text editor
            if (courseData.detailedDescription && quillEditor) {
                quillEditor.root.innerHTML = courseData.detailedDescription;
            }
            
            // Select fields
            const selectFields = ['targetAudience', 'courseLanguage', 'currency', 
                                 'accessDuration', 'expectedCompletion', 'supportHours'];
            
            selectFields.forEach(field => {
                const element = document.getElementById(field);
                if (element && courseData[field]) {
                    element.value = courseData[field];
                }
            });
            
            // Pricing
            selectPriceType(courseData.priceType);
            if (courseData.price) {
                document.getElementById('coursePrice').value = courseData.price;
            }
            if (courseData.salePrice) {
                document.getElementById('courseSalePrice').value = courseData.salePrice;
            }
            updatePricePreview();
            
            // Dates
            ['startDate', 'endDate', 'scheduledPublish'].forEach(field => {
                const element = document.getElementById(field);
                if (element && courseData[field]) {
                    element.value = courseData[field];
                }
            });
            
            // Numbers
            if (courseData.maxStudents) {
                document.getElementById('maxStudents').value = courseData.maxStudents;
            }
            
            // Radio buttons
            const radioFields = ['courseStructure', 'enrollmentType', 'dripType'];
            radioFields.forEach(field => {
                const radio = document.querySelector(`input[name="${field}"][value="${courseData[field]}"]`);
                if (radio) radio.checked = true;
            });
            
            // Checkboxes
            const checkboxFields = ['enableWaitlist', 'dripContent', 'enableQuizzes', 
                                   'enableAssignments', 'showProgressBar', 'showCompletionBadges',
                                   'sendProgressEmails', 'certificateEnabled', 'enableComments',
                                   'enableForum', 'enableLiveSupport', 'allowSharing', 
                                   'isPublic', 'privateLink'];
            
            checkboxFields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.checked = courseData[field.replace('Enabled', '')] || false;
                }
            });
            
            // Range inputs
            document.getElementById('minCompletion').value = courseData.minCompletion || 80;
            document.getElementById('certificateThreshold').value = courseData.certificateThreshold || 80;
            updateRangeValue(document.getElementById('minCompletion'));
            updateRangeValue(document.getElementById('certificateThreshold'));
            
            // Images
            if (courseData.thumbnailUrl) {
                displayCourseImage(courseData.thumbnailUrl);
            }
            if (courseData.instructorImage) {
                displayInstructorImage(courseData.instructorImage);
            }
            if (courseData.socialImageUrl) {
                displaySocialImage(courseData.socialImageUrl);
            }
            
            // Learning objectives
            if (courseData.objectives && courseData.objectives.length) {
                loadObjectives();
            }
            
            // Requirements
            if (courseData.requirements && courseData.requirements.length) {
                loadRequirements();
            }
            
            // Keywords
            if (courseData.keywords && courseData.keywords.length) {
                setupKeywordTags();
            }
            
            // Coupons
            if (courseData.coupons && courseData.coupons.length) {
                renderCoupons();
            }
            
            // Payment plans
            if (courseData.paymentPlans && courseData.paymentPlans.length) {
                renderPaymentPlans();
            }
            
            // Modules
            if (courseData.modules && courseData.modules.length) {
                document.getElementById('emptyModulesState').style.display = 'none';
                courseData.modules.forEach(module => {
                    renderModule(module);
                });
            }
            
            // Update previews
            updateSlugPreview(courseData.slug);
            updateSeoPreview();
            updateCurriculumStats();
            
            // Experience selection
            selectExperience(null, courseData.learningType);
            
            // Toggle dependent elements
            if (courseData.dripContent) {
                document.getElementById('dripSettings').style.display = 'block';
            }
            if (!courseData.certificate) {
                document.getElementById('certificateSettings').style.display = 'none';
            }
        }

        // ==================== Progress Tracking ====================
        function updateProgress() {
            let completedSteps = 0;
            const totalSteps = 25;
            
            // Step 1: Basic info (5 points)
            if (courseData.title && courseData.title !== 'دورة جديدة') completedSteps++;
            if (courseData.description) completedSteps++;
            if (courseData.detailedDescription) completedSteps++;
            if (courseData.objectives && courseData.objectives.length > 0) completedSteps++;
            if (courseData.thumbnailUrl) completedSteps++;
            
            // Step 2: Pricing (4 points)
            if (courseData.priceType) completedSteps++;
            if (courseData.priceType === 'free' || courseData.price > 0) completedSteps++;
            if (courseData.enrollmentType) completedSteps++;
            if (courseData.accessDuration) completedSteps++;
            
            // Step 3: Curriculum (8 points)
            if (courseData.modules && courseData.modules.length > 0) completedSteps += 2;
            if (courseData.modules && courseData.modules.length >= 3) completedSteps += 2;
            
            let totalLessons = 0;
            if (courseData.modules) {
                courseData.modules.forEach(module => {
                    if (module.lessons) {
                        totalLessons += module.lessons.length;
                    }
                });
            }
            
            if (totalLessons > 0) completedSteps += 2;
            if (totalLessons >= 5) completedSteps += 2;
            
            // Step 4: Student experience (4 points)
            if (courseData.learningType) completedSteps++;
            if (courseData.certificate !== undefined) completedSteps++;
            if (courseData.certificateThreshold) completedSteps++;
            if (courseData.expectedCompletion) completedSteps++;
            
            // Step 5: Publishing (4 points)
            if (courseData.seoTitle || courseData.title) completedSteps++;
            if (courseData.seoDescription || courseData.description) completedSteps++;
            if (courseData.keywords && courseData.keywords.length > 0) completedSteps++;
            if (courseData.isPublic !== undefined) completedSteps++;
            
            const progress = Math.round((completedSteps / totalSteps) * 100);
            courseData.progress = progress;
            
            // Update UI
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const completedStepsEl = document.getElementById('completedSteps');
            
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }
            if (progressPercent) {
                progressPercent.textContent = progress;
            }
            if (completedStepsEl) {
                completedStepsEl.textContent = Math.floor(completedSteps / 5);
            }
            
            // Update total lessons and duration
            document.getElementById('totalLessons').textContent = totalLessons;
            document.getElementById('courseDuration').textContent = courseData.totalDuration || 0;
        }

        // ==================== Slug Management ====================
        function updateSlugPreview(value) {
            const preview = document.getElementById('slugPreview');
            const seoPreview = document.getElementById('seoPreviewUrl');
            
            if (value) {
                preview.textContent = value.toLowerCase().replace(/[^a-z0-9-]/g, '');
            } else {
                const title = document.getElementById('courseTitleMain').value;
                if (title && title !== 'دورة جديدة') {
                    const generatedSlug = generateSlug(title);
                    preview.textContent = generatedSlug;
                } else {
                    preview.textContent = 'course-url-here';
                }
            }
            
            if (seoPreview) {
                seoPreview.textContent = `mahmoudfouad25.github.io/fouad-perspective/courses/${preview.textContent}`;
            }
        }

        function generateSlug(title) {
            const arabicToEnglish = {
                'ا': 'a', 'أ': 'a', 'إ': 'i', 'آ': 'aa', 'ء': 'a',
                'ب': 'b', 'ت': 't', 'ث': 'th', 'ج': 'j', 'ح': 'h',
                'خ': 'kh', 'د': 'd', 'ذ': 'dh', 'ر': 'r', 'ز': 'z',
                'س': 's', 'ش': 'sh', 'ص': 's', 'ض': 'd', 'ط': 't',
                'ظ': 'dh', 'ع': 'a', 'غ': 'gh', 'ف': 'f', 'ق': 'q',
                'ك': 'k', 'ل': 'l', 'م': 'm', 'ن': 'n', 'ه': 'h',
                'و': 'w', 'ي': 'y', 'ة': 'h', 'ى': 'a',
                ' ': '-'
            };
            
            let slug = title.toLowerCase();
            
            for (let [arabic, english] of Object.entries(arabicToEnglish)) {
                slug = slug.replace(new RegExp(arabic, 'g'), english);
            }
            
            slug = slug
                .replace(/[^\w\-]+/g, '')
                .replace(/\-\-+/g, '-')
                .replace(/^-+/, '')
                .replace(/-+$/, '');
            
            if (slug.length > 50) {
                slug = slug.substring(0, 50);
                slug = slug.substring(0, slug.lastIndexOf('-'));
            }
            
            return slug || 'untitled-course';
        }

        // ==================== Learning Objectives ====================
        function addObjective() {
            const container = document.getElementById('learningObjectives');
            const count = container.children.length + 1;
            
            const newObjective = document.createElement('div');
            newObjective.className = 'objective-item';
            newObjective.innerHTML = `
                <div class="objective-number">${count}</div>
                <input type="text" class="form-control objective-input" 
                       placeholder="سيتمكن الطالب من...">
                <button class="icon-btn danger" onclick="removeObjective(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(newObjective);
            
            // Add event listener
            newObjective.querySelector('.objective-input').addEventListener('input', updateObjectives);
        }

        function removeObjective(element) {
            element.parentElement.remove();
            updateObjectiveNumbers();
            updateObjectives();
        }

        function updateObjectiveNumbers() {
            const items = document.querySelectorAll('.objective-item');
            items.forEach((item, index) => {
                item.querySelector('.objective-number').textContent = index + 1;
            });
        }

        function updateObjectives() {
            const objectives = [];
            document.querySelectorAll('.objective-input').forEach(input => {
                if (input.value.trim()) {
                    objectives.push(input.value.trim());
                }
            });
            courseData.objectives = objectives;
            autoSave();
        }

        function loadObjectives() {
            const container = document.getElementById('learningObjectives');
            container.innerHTML = '';
            
            courseData.objectives.forEach((objective, index) => {
                const item = document.createElement('div');
                item.className = 'objective-item';
                item.innerHTML = `
                    <div class="objective-number">${index + 1}</div>
                    <input type="text" class="form-control objective-input" value="${objective}">
                    <button class="icon-btn danger" onclick="removeObjective(this)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(item);
                
                item.querySelector('.objective-input').addEventListener('input', updateObjectives);
            });
        }

        // ==================== Requirements ====================
        function addRequirement() {
            const container = document.getElementById('courseRequirements');
            
            const newRequirement = document.createElement('div');
            newRequirement.className = 'requirement-item';
            newRequirement.innerHTML = `
                <div class="requirement-icon">
                    <i class="fas fa-check"></i>
                </div>
                <input type="text" class="form-control requirement-input" 
                       placeholder="مثال: معرفة أساسية بـ...">
                <button class="icon-btn danger" onclick="removeRequirement(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(newRequirement);
            
            // Add event listener
            newRequirement.querySelector('.requirement-input').addEventListener('input', updateRequirements);
        }

        function removeRequirement(element) {
            element.parentElement.remove();
            updateRequirements();
        }

        function updateRequirements() {
            const requirements = [];
            document.querySelectorAll('.requirement-input').forEach(input => {
                if (input.value.trim()) {
                    requirements.push(input.value.trim());
                }
            });
            courseData.requirements = requirements;
            autoSave();
        }

        function loadRequirements() {
            const container = document.getElementById('courseRequirements');
            container.innerHTML = '';
            
            courseData.requirements.forEach(requirement => {
                const item = document.createElement('div');
                item.className = 'requirement-item';
                item.innerHTML = `
                    <div class="requirement-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <input type="text" class="form-control requirement-input" value="${requirement}">
                    <button class="icon-btn danger" onclick="removeRequirement(this)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(item);
                
                item.querySelector('.requirement-input').addEventListener('input', updateRequirements);
            });
        }

        // ==================== Image Upload ====================
        async function uploadCourseImage() {
            const result = await Swal.fire({
                title: 'رفع صورة الدورة',
                html: `
                    <div style="text-align: center;">
                        <p style="margin-bottom: 1rem;">اختر طريقة رفع الصورة:</p>
                        <button class="btn btn-primary" onclick="selectImageFile('course'); Swal.close();" style="margin: 0.5rem;">
                            <i class="fas fa-upload"></i> رفع من جهازك
                        </button>
                        <br>
                        <button class="btn btn-secondary" onclick="enterImageUrl('course'); Swal.close();" style="margin: 0.5rem;">
                            <i class="fas fa-link"></i> إدخال رابط
                        </button>
                    </div>
                `,
                showConfirmButton: false,
                showCancelButton: true,
                cancelButtonText: 'إلغاء',
                background: 'var(--bg-card)',
                color: 'var(--text-primary)'
            });
        }

        async function uploadInstructorImage() {
            const result = await Swal.fire({
                title: 'رفع صورة المدرب',
                html: `
                    <div style="text-align: center;">
                        <p style="margin-bottom: 1rem;">اختر طريقة رفع الصورة:</p>
                        <button class="btn btn-primary" onclick="selectImageFile('instructor'); Swal.close();" style="margin: 0.5rem;">
                            <i class="fas fa-upload"></i> رفع من جهازك
                        </button>
                        <br>
                        <button class="btn btn-secondary" onclick="enterImageUrl('instructor'); Swal.close();" style="margin: 0.5rem;">
                            <i class="fas fa-link"></i> إدخال رابط
                        </button>
                    </div>
                `,
                showConfirmButton: false,
                showCancelButton: true,
                cancelButtonText: 'إلغاء',
                background: 'var(--bg-card)',
                color: 'var(--text-primary)'
            });
        }

        async function uploadSocialImage() {
            const result = await Swal.fire({
                title: 'رفع صورة وسائل التواصل',
                html: `
                    <div style="text-align: center;">
                        <p style="margin-bottom: 1rem;">اختر طريقة رفع الصورة:</p>
                        <button class="btn btn-primary" onclick="selectImageFile('social'); Swal.close();" style="margin: 0.5rem;">
                            <i class="fas fa-upload"></i> رفع من جهازك
                        </button>
                        <br>
                        <button class="btn btn-secondary" onclick="enterImageUrl('social'); Swal.close();" style="margin: 0.5rem;">
                            <i class="fas fa-link"></i> إدخال رابط
                        </button>
                    </div>
                `,
                showConfirmButton: false,
                showCancelButton: true,
                cancelButtonText: 'إلغاء',
                background: 'var(--bg-card)',
                color: 'var(--text-primary)'
            });
        }

        function selectImageFile(type) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                handleImageFile(e.target.files[0], type);
            };
            input.click();
        }

        async function handleImageFile(file, type) {
            if (!file) return;
            
            // Check file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                Swal.fire({
                    icon: 'error',
                    title: 'حجم الملف كبير',
                    text: 'الحد الأقصى لحجم الصورة هو 5MB',
                    background: 'var(--bg-card)',
                    color: 'var(--text-primary)'
                });
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                // Display preview
                if (type === 'course') {
                    displayCourseImage(e.target.result);
                } else if (type === 'instructor') {
                    displayInstructorImage(e.target.result);
                } else if (type === 'social') {
                    displaySocialImage(e.target.result);
                }
                
                // Upload to Firebase Storage if available
                if (firebase.storage && courseData.id) {
                    try {
                        const storageRef = firebase.storage().ref();
                        const fileName = `courses/${courseData.id}/${type}-${Date.now()}.jpg`;
                        const uploadTask = storageRef.child(fileName).put(file);
                        
                        uploadTask.on('state_changed', 
                            (snapshot) => {
                                // Progress
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                console.log('Upload progress:', progress);
                            },
                            (error) => {
                                console.error('Upload error:', error);
                            },
                            async () => {
                                // Complete
                                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                
                                if (type === 'course') {
                                    courseData.thumbnailUrl = downloadURL;
                                } else if (type === 'instructor') {
                                    courseData.instructorImage = downloadURL;
                                } else if (type === 'social') {
                                    courseData.socialImageUrl = downloadURL;
                                }
                                
                                autoSave();
                            }
                        );
                    } catch (error) {
                        console.error('Firebase storage error:', error);
                    }
                } else {
                    // Store as base64 if no Firebase Storage
                    if (type === 'course') {
                        courseData.thumbnailUrl = e.target.result;
                    } else if (type === 'instructor') {
                        courseData.instructorImage = e.target.result;
                    } else if (type === 'social') {
                        courseData.socialImageUrl = e.target.result;
                    }
                    autoSave();
                }
            };
            reader.readAsDataURL(file);
        }

        async function enterImageUrl(type) {
            const { value: url } = await Swal.fire({
                title: 'إدخال رابط الصورة',
                input: 'url',
                inputPlaceholder: 'https://example.com/image.jpg',
                showCancelButton: true,
                confirmButtonText: 'حفظ',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: 'var(--primary)',
                background: 'var(--bg-card)',
                color: 'var(--text-primary)',
                inputValidator: (value) => {
                    if (!value) {
                        return 'يرجى إدخال رابط صحيح';
                    }
                }
            });

            if (url) {
                if (type === 'course') {
                    courseData.thumbnailUrl = url;
                    displayCourseImage(url);
                } else if (type === 'instructor') {
                    courseData.instructorImage = url;
                    displayInstructorImage(url);
                } else if (type === 'social') {
                    courseData.socialImageUrl = url;
                    displaySocialImage(url);
                }
                autoSave();
            }
        }

        function displayCourseImage(url) {
            const uploadDiv = document.getElementById('courseImageUpload');
            uploadDiv.classList.add('has-image');
            
            uploadDiv.innerHTML = `
                <img src="${url}" alt="Course thumbnail" 
                     onerror="this.parentElement.innerHTML='<div class=\\'upload-content\\'><i class=\\'fas fa-exclamation-triangle upload-icon\\'></i><div class=\\'upload-title\\'>خطأ في تحميل الصورة</div></div>'">
                <div class="upload-overlay">
                    <button class="btn btn-primary" onclick="uploadCourseImage(); event.stopPropagation();">تغيير الصورة</button>
                </div>
            `;
        }

        function displayInstructorImage(url) {
            const uploadDiv = document.getElementById('instructorImageUpload');
            uploadDiv.classList.add('has-image');
            
            uploadDiv.innerHTML = `
                <img src="${url}" alt="Instructor" 
                     onerror="this.parentElement.innerHTML='<div class=\\'upload-content\\'><i class=\\'fas fa-exclamation-triangle upload-icon\\'></i><div class=\\'upload-title\\'>خطأ في تحميل الصورة</div></div>'">
                <div class="upload-overlay">
                    <button class="btn btn-primary" onclick="uploadInstructorImage(); event.stopPropagation();">تغيير الصورة</button>
                </div>
            `;
        }

        function displaySocialImage(url) {
            const uploadDiv = document.getElementById('socialImageUpload');
            uploadDiv.classList.add('has-image');
            
            uploadDiv.innerHTML = `
                <img src="${url}" alt="Social media image" 
                     onerror="this.parentElement.innerHTML='<div class=\\'upload-content\\'><i class=\\'fas fa-exclamation-triangle upload-icon\\'></i><div class=\\'upload-title\\'>خطأ في تحميل الصورة</div></div>'">
                <div class="upload-overlay">
                    <button class="btn btn-primary" onclick="uploadSocialImage(); event.stopPropagation();">تغيير الصورة</button>
                </div>
            `;
        }

        // ==================== Pricing Functions ====================
        function selectPriceType(type) {
            document.querySelectorAll('.price-option').forEach(option => {
                option.classList.remove('active');
            });
            
            const selectedOption = document.querySelector(`[data-type="${type}"]`);
            if (selectedOption) {
                selectedOption.classList.add('active');
            }
            
            courseData.priceType = type;
            
            const pricingDetails = document.getElementById('pricingDetails');
            const paymentPlansSection = document.getElementById('paymentPlansSection');
            
            if (pricingDetails) {
                if (type === 'paid' || type === 'subscription' || type === 'payment-plan') {
                    pricingDetails.style.display = 'block';
                } else {
                    pricingDetails.style.display = 'none';
                    courseData.price = 0;
                    courseData.salePrice = null;
                }
            }
            
            if (paymentPlansSection) {
                paymentPlansSection.style.display = type === 'payment-plan' ? 'block' : 'none';
            }
            
            updatePricePreview();
            autoSave();
        }

        function updateCurrency(currency) {
            courseData.currency = currency;
            const symbols = document.querySelectorAll('.currency-symbol');
            symbols.forEach(symbol => {
                symbol.textContent = currencySymbols[currency];
            });
            updatePricePreview();
        }

        function updatePricePreview() {
            const basePrice = parseFloat(document.getElementById('coursePrice').value) || 0;
            const salePrice = parseFloat(document.getElementById('courseSalePrice').value) || 0;
            const finalPrice = salePrice > 0 ? salePrice : basePrice;
            const savings = salePrice > 0 ? basePrice - salePrice : 0;
            
            document.getElementById('previewPrice').textContent = finalPrice.toFixed(2);
            document.getElementById('previewCurrency').textContent = 
                courseData.currency === 'SAR' ? 'ريال سعودي' :
                courseData.currency === 'USD' ? 'دولار أمريكي' :
                courseData.currency === 'EUR' ? 'يورو' :
                courseData.currency === 'EGP' ? 'جنيه مصري' :
                'درهم إماراتي';
            
            const originalDiv = document.getElementById('previewOriginal');
            const savingsDiv = document.getElementById('previewSavings');
            
            if (salePrice > 0 && salePrice < basePrice) {
                originalDiv.style.display = 'block';
                originalDiv.querySelector('.original-price').textContent = 
                    basePrice.toFixed(2) + ' ' + currencySymbols[courseData.currency];
                
                savingsDiv.style.display = 'block';
                document.getElementById('savingsAmount').textContent = savings.toFixed(2);
                document.getElementById('savingsCurrency').textContent = currencySymbols[courseData.currency];
            } else {
                originalDiv.style.display = 'none';
                savingsDiv.style.display = 'none';
            }
        }

        // ==================== Coupons ====================
        async function addCoupon() {
            const { value: formValues } = await Swal.fire({
                title: 'إضافة كوبون خصم',
                html: `
                    <div style="text-align: right;">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">كود الكوبون</label>
                            <input id="couponCode" class="swal2-input" placeholder="مثال: SAVE20" 
                                   style="direction: ltr; text-transform: uppercase;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">نوع الخصم</label>
                            <select id="couponType" class="swal2-select">
                                <option value="percentage">نسبة مئوية (%)</option>
                                <option value="fixed">مبلغ ثابت</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">قيمة الخصم</label>
                            <input id="couponValue" type="number" class="swal2-input" placeholder="20" min="1">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">عدد مرات الاستخدام</label>
                            <input id="couponLimit" type="number" class="swal2-input" placeholder="غير محدود" min="1">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">تاريخ الانتهاء</label>
                            <input id="couponExpiry" type="date" class="swal2-input">
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'إضافة',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: 'var(--primary)',
                background: 'var(--bg-card)',
                color: 'var(--text-primary)',
                preConfirm: () => {
                    const code = document.getElementById('couponCode').value;
                    const type = document.getElementById('couponType').value;
                    const value = document.getElementById('couponValue').value;
                    
                    if (!code || !value) {
                        Swal.showValidationMessage('يرجى إدخال كود الكوبون وقيمة الخصم');
                        return false;
                    }
                    
                    return {
                        code: code.toUpperCase(),
                        type: type,
                        value: parseInt(value),
                        limit: document.getElementById('couponLimit').value || null,
                        expiry: document.getElementById('couponExpiry').value || null,
                        used: 0
                    };
                }
            });

            if (formValues) {
                if (!courseData.coupons) {
                    courseData.coupons = [];
                }
                courseData.coupons.push(formValues);
                renderCoupons();
                autoSave();
            }
        }

        function renderCoupons() {
            const couponList = document.getElementById('couponList');
            if (!couponList || !courseData.coupons) return;
            
            couponList.innerHTML = courseData.coupons.map((coupon, index) => `
                <div class="coupon-item">
                    <div class="coupon-info">
                        <div class="coupon-code">${coupon.code}</div>
                        <div class="coupon-details">
                            ${coupon.type === 'percentage' ? 
                                `خصم ${coupon.value}%` : 
                                `خصم ${coupon.value} ${currencySymbols[courseData.currency]}`}
                            ${coupon.limit ? ` • حد الاستخدام: ${coupon.limit}` : ' • غير محدود'}
                            ${coupon.expiry ? ` • ينتهي: ${new Date(coupon.expiry).toLocaleDateString('ar-SA')}` : ''}
                        </div>
                    </div>
                    <div class="coupon-stats">
                        <div class="coupon-usage">${coupon.used || 0}</div>
                        <div class="coupon-label">استخدام</div>
                    </div>
                    <div class="coupon-actions">
                        <button class="icon-btn" onclick="editCoupon(${index})" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="icon-btn danger" onclick="removeCoupon(${index})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function removeCoupon(index) {
            Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا الكوبون؟',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'حذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: 'var(--danger)',
                background: 'var(--bg-card)',
                color: 'var(--text-primary)'
            }).then((result) => {
                if (result.isConfirmed) {
                    courseData.coupons.splice(index, 1);
                    renderCoupons();
                    autoSave();
                }
            });
        }

        // ==================== Payment Plans ====================
        async function addPaymentPlan() {
            const basePrice = parseFloat(document.getElementById('coursePrice').value) || 299;
            
            const { value: formValues } = await Swal.fire({
                title: 'إضافة خطة دفع',
                html: `
                    <div style="text-align: right;">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">اسم الخطة</label>
                            <input id="planName" class="swal2-input" placeholder="مثال: ثلاث دفعات شهرية">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">عدد الدفعات</label>
                            <input id="planInstallments" type="number" class="swal2-input" 
                                   placeholder="3" min="2" max="12" value="3">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">الفترة بين الدفعات (أيام)</label>
                            <input id="planInterval" type="number" class="swal2-input" 
                                   placeholder="30" min="1" value="30">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">رسوم إضافية (%)</label>
                            <input id="planFee" type="number" class="swal2-input" 
                                   placeholder="5" min="0" max="50" value="5">
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'إضافة الخطة',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: 'var(--primary)',
                background: 'var(--bg-card)',
                color: 'var(--text-primary)',
                preConfirm: () => {
                    const name = document.getElementById('planName').value;
                    const installments = document.getElementById('planInstallments').value;
                    
                    if (!name || !installments) {
                        Swal.showValidationMessage('يرجى ملء جميع الحقول المطلوبة');
                        return false;
                    }
                    
                    return {
                        name: name,
                        installments: parseInt(installments),
                        interval: parseInt(document.getElementById('planInterval').value),
                        fee: parseFloat(document.getElementById('planFee').value) || 0
                    };
                }
            });

            if (formValues) {
                if (!courseData.paymentPlans) {
                    courseData.paymentPlans = [];
               }
               
               // Calculate plan details
               const totalWithFee = basePrice * (1 + formValues.fee / 100);
               const installmentAmount = totalWithFee / formValues.installments;
               
               formValues.totalAmount = totalWithFee;
               formValues.installmentAmount = installmentAmount;
               
               courseData.paymentPlans.push(formValues);
               renderPaymentPlans();
               autoSave();
           }
       }

       function renderPaymentPlans() {
           const plansList = document.getElementById('paymentPlansList');
           if (!plansList || !courseData.paymentPlans) return;
           
           plansList.innerHTML = courseData.paymentPlans.map((plan, index) => `
               <div class="payment-plan-item">
                   <div class="plan-header">
                       <h4 class="plan-name">${plan.name}</h4>
                       <div class="plan-actions">
                           <button class="icon-btn" onclick="editPaymentPlan(${index})" title="تعديل">
                               <i class="fas fa-edit"></i>
                           </button>
                           <button class="icon-btn danger" onclick="removePaymentPlan(${index})" title="حذف">
                               <i class="fas fa-trash"></i>
                           </button>
                       </div>
                   </div>
                   <div class="plan-details">
                       <div class="plan-info">
                           <span class="plan-label">الدفعة:</span>
                           <span class="plan-value">${plan.installmentAmount.toFixed(2)} ${currencySymbols[courseData.currency]}</span>
                       </div>
                       <div class="plan-info">
                           <span class="plan-label">عدد الدفعات:</span>
                           <span class="plan-value">${plan.installments}</span>
                       </div>
                       <div class="plan-info">
                           <span class="plan-label">المجموع:</span>
                           <span class="plan-value">${plan.totalAmount.toFixed(2)} ${currencySymbols[courseData.currency]}</span>
                       </div>
                       <div class="plan-info">
                           <span class="plan-label">التكرار:</span>
                           <span class="plan-value">كل ${plan.interval} يوم</span>
                       </div>
                   </div>
               </div>
           `).join('');
       }

       function removePaymentPlan(index) {
           Swal.fire({
               title: 'تأكيد الحذف',
               text: 'هل أنت متأكد من حذف خطة الدفع هذه؟',
               icon: 'warning',
               showCancelButton: true,
               confirmButtonText: 'حذف',
               cancelButtonText: 'إلغاء',
               confirmButtonColor: 'var(--danger)',
               background: 'var(--bg-card)',
               color: 'var(--text-primary)'
           }).then((result) => {
               if (result.isConfirmed) {
                   courseData.paymentPlans.splice(index, 1);
                   renderPaymentPlans();
                   autoSave();
               }
           });
       }

       // ==================== Curriculum Builder ====================
       function initializeSortable() {
           setTimeout(() => {
               const modulesList = document.getElementById('modulesList');
               if (modulesList && typeof Sortable !== 'undefined') {
                   try {
                       new Sortable(modulesList, {
                           animation: 150,
                           handle: '.drag-handle',
                           ghostClass: 'dragging',
                           onEnd: function() {
                               updateModulesOrder();
                               autoSave();
                           }
                       });
                   } catch (error) {
                       console.warn('Sortable initialization warning:', error);
                   }
               }
           }, 1000);
       }

       function addModule() {
           const moduleId = Date.now();
           const moduleNumber = courseData.modules.length + 1;
           const module = {
               id: moduleId,
               title: `الوحدة ${moduleNumber}`,
               description: '',
               lessons: [],
               expanded: true
           };
           
           courseData.modules.push(module);
           
           // Hide empty state
           document.getElementById('emptyModulesState').style.display = 'none';
           
           renderModule(module);
           updateCurriculumStats();
           updateProgress();
           autoSave();
       }

       function renderModule(module) {
           const modulesList = document.getElementById('modulesList');
           if (!modulesList) return;
           
           const moduleElement = document.createElement('div');
           moduleElement.className = 'module-item' + (module.expanded ? ' expanded' : '');
           moduleElement.dataset.moduleId = module.id;
           
           moduleElement.innerHTML = `
               <div class="module-header">
                   <i class="fas fa-grip-vertical drag-handle"></i>
                   <div class="module-info">
                       <div class="module-number">${courseData.modules.indexOf(module) + 1}</div>
                       <input type="text" 
                              class="module-title-input" 
                              value="${module.title}" 
                              onchange="updateModuleTitle(${module.id}, this.value)"
                              placeholder="اسم الوحدة">
                   </div>
                   <div class="module-meta">
                       <span>${module.lessons.length} دروس</span>
                       <span>${calculateModuleDuration(module)} دقيقة</span>
                   </div>
                   <div class="module-actions">
                       <button class="icon-btn" onclick="toggleModule(${module.id})" title="إظهار/إخفاء">
                           <i class="fas fa-chevron-down"></i>
                       </button>
                       <button class="icon-btn" onclick="moduleSettings(${module.id})" title="إعدادات">
                           <i class="fas fa-cog"></i>
                       </button>
                       <button class="icon-btn danger" onclick="deleteModule(${module.id})" title="حذف">
                           <i class="fas fa-trash"></i>
                       </button>
                   </div>
               </div>
               <div class="module-content">
                   <div class="lessons-container">
                       <div class="lessons-header">
                           <h4 class="lessons-title">محتوى الوحدة</h4>
                       </div>
                       <div class="lessons-list" id="lessons-${module.id}">
                           ${module.lessons.map(lesson => renderLessonHTML(lesson, module.id)).join('')}
                       </div>
                       <div class="add-content-section">
                           <button class="add-content-btn" onclick="toggleContentTypes(${module.id}, this)">
                               <i class="fas fa-plus"></i>
                               ${module.lessons.length === 0 ? 'إضافة أول درس' : 'إضافة محتوى جديد'}
                           </button>
                           <div class="content-type-grid" id="contentTypes-${module.id}">
                               <div class="content-type-option" onclick="addLesson(${module.id}, 'video')">
                                   <div class="content-type-icon">
                                       <i class="fas fa-video"></i>
                                   </div>
                                   <div class="content-type-name">فيديو</div>
                               </div>
                               <div class="content-type-option" onclick="addLesson(${module.id}, 'text')">
                                   <div class="content-type-icon">
                                       <i class="fas fa-file-alt"></i>
                                   </div>
                                   <div class="content-type-name">نص</div>
                               </div>
                               <div class="content-type-option" onclick="addLesson(${module.id}, 'quiz')">
                                   <div class="content-type-icon">
                                       <i class="fas fa-question-circle"></i>
                                   </div>
                                   <div class="content-type-name">اختبار</div>
                               </div>
                               <div class="content-type-option" onclick="addLesson(${module.id}, 'assignment')">
                                   <div class="content-type-icon">
                                       <i class="fas fa-tasks"></i>
                                   </div>
                                   <div class="content-type-name">مهمة</div>
                               </div>
                               <div class="content-type-option" onclick="addLesson(${module.id}, 'resource')">
                                   <div class="content-type-icon">
                                       <i class="fas fa-download"></i>
                                   </div>
                                   <div class="content-type-name">مورد</div>
                               </div>
                               <div class="content-type-option" onclick="addLesson(${module.id}, 'live')">
                                   <div class="content-type-icon">
                                       <i class="fas fa-broadcast-tower"></i>
                                   </div>
                                   <div class="content-type-name">جلسة حية</div>
                               </div>
                           </div>
                       </div>
                   </div>
               </div>
           `;
           
           modulesList.appendChild(moduleElement);
           
           // Initialize sortable for lessons
           setTimeout(() => {
               const lessonsContainer = document.getElementById(`lessons-${module.id}`);
               if (lessonsContainer && typeof Sortable !== 'undefined') {
                   try {
                       new Sortable(lessonsContainer, {
                           animation: 150,
                           handle: '.lesson-item',
                           ghostClass: 'dragging',
                           onEnd: function() {
                               updateLessonsOrder(module.id);
                               autoSave();
                           }
                       });
                   } catch (error) {
                       console.warn('Sortable lessons initialization warning:', error);
                   }
               }
           }, 500);
       }

       function renderLessonHTML(lesson, moduleId) {
           const iconMap = {
               video: 'fa-video',
               text: 'fa-file-alt',
               quiz: 'fa-question-circle',
               assignment: 'fa-tasks',
               resource: 'fa-download',
               live: 'fa-broadcast-tower'
           };
           
           return `
               <div class="lesson-item" data-lesson-id="${lesson.id}" onclick="editLesson(${moduleId}, ${lesson.id})">
                   <div class="lesson-type-icon">
                       <i class="fas ${iconMap[lesson.type] || 'fa-file'}"></i>
                   </div>
                   <div class="lesson-info">
                       <div class="lesson-title">${lesson.title}</div>
                       <div class="lesson-meta">
                           <span><i class="far fa-clock"></i> ${lesson.duration || 0} دقيقة</span>
                           <span>${getLessonTypeLabel(lesson.type)}</span>
                           <span class="lesson-status">
                               <span class="status-dot ${lesson.status || 'draft'}"></span>
                               ${lesson.status === 'published' ? 'منشور' : 'مسودة'}
                           </span>
                       </div>
                   </div>
                   <div class="lesson-actions" onclick="event.stopPropagation()">
                       <button class="icon-btn" onclick="duplicateLesson(${moduleId}, ${lesson.id})" title="نسخ">
                           <i class="fas fa-copy"></i>
                       </button>
                       <button class="icon-btn" onclick="previewLesson(${moduleId}, ${lesson.id})" title="معاينة">
                           <i class="fas fa-eye"></i>
                       </button>
                       <button class="icon-btn danger" onclick="deleteLesson(${moduleId}, ${lesson.id})" title="حذف">
                           <i class="fas fa-trash"></i>
                       </button>
                   </div>
               </div>
           `;
       }

       function getLessonTypeLabel(type) {
           const labels = {
               video: 'فيديو',
               text: 'نص',
               quiz: 'اختبار',
               assignment: 'مهمة',
               resource: 'مورد',
               live: 'جلسة حية'
           };
           return labels[type] || 'درس';
       }

       function toggleContentTypes(moduleId, button) {
           const grid = document.getElementById(`contentTypes-${moduleId}`);
           const isVisible = grid.classList.contains('show');
           
           // Hide all other grids
           document.querySelectorAll('.content-type-grid').forEach(g => {
               g.classList.remove('show');
           });
           
           // Reset all buttons
           document.querySelectorAll('.add-content-btn').forEach(btn => {
               btn.innerHTML = '<i class="fas fa-plus"></i> إضافة محتوى جديد';
           });
           
           if (!isVisible) {
               grid.classList.add('show');
               button.innerHTML = '<i class="fas fa-times"></i> إلغاء';
           }
       }

       function addLesson(moduleId, type) {
           const lessonId = Date.now();
           const lesson = {
               id: lessonId,
               type: type,
               title: `${getLessonTypeLabel(type)} جديد`,
               content: '',
               duration: 0,
               status: 'draft'
           };
           
           showLessonEditor(moduleId, lesson, true);
       }

       async function showLessonEditor(moduleId, lesson, isNew = false) {
           let editorContent = '';
           
           switch(lesson.type) {
               case 'video':
                   editorContent = `
                       <div class="form-group">
                           <label class="form-label">عنوان الدرس</label>
                           <input type="text" id="lessonTitle" class="form-control" value="${lesson.title}">
                       </div>
                       <div class="form-group">
                           <label class="form-label">رابط الفيديو</label>
                           <input type="url" id="videoUrl" class="form-control" 
                                  placeholder="YouTube, Vimeo, أو رابط مباشر" value="${lesson.videoUrl || ''}">
                       </div>
                       <div class="form-group">
                           <label class="form-label">مدة الفيديو (بالدقائق)</label>
                           <input type="number" id="lessonDuration" class="form-control" 
                                  value="${lesson.duration || ''}" min="1">
                       </div>
                       <div class="form-group">
                           <label class="form-label">وصف الدرس</label>
                           <textarea id="lessonDescription" class="form-control" rows="3">${lesson.description || ''}</textarea>
                       </div>
                   `;
                   break;
                   
               case 'text':
                   editorContent = `
                       <div class="form-group">
                           <label class="form-label">عنوان الدرس</label>
                           <input type="text" id="lessonTitle" class="form-control" value="${lesson.title}">
                       </div>
                       <div class="form-group">
                           <label class="form-label">محتوى الدرس</label>
                           <div id="lessonContentEditor" style="height: 300px; background: white; color: black;"></div>
                       </div>
                       <div class="form-group">
                           <label class="form-label">وقت القراءة المتوقع (بالدقائق)</label>
                           <input type="number" id="lessonDuration" class="form-control" 
                                  value="${lesson.duration || ''}" min="1">
                       </div>
                   `;
                   break;
                   
               case 'quiz':
                   editorContent = `
                       <div class="form-group">
                           <label class="form-label">عنوان الاختبار</label>
                           <input type="text" id="lessonTitle" class="form-control" value="${lesson.title}">
                       </div>
                       <div class="form-group">
                           <label class="form-label">وصف الاختبار</label>
                           <textarea id="lessonDescription" class="form-control" rows="3">${lesson.description || ''}</textarea>
                       </div>
                       <div class="form-group">
                           <label class="form-label">عدد الأسئلة</label>
                           <input type="number" id="questionCount" class="form-control" 
                                  value="${lesson.questionCount || 10}" min="1">
                       </div>
                       <div class="form-group">
                           <label class="form-label">الوقت المسموح (بالدقائق)</label>
                           <input type="number" id="lessonDuration" class="form-control" 
                                  value="${lesson.duration || 30}" min="5">
                       </div>
                       <div class="form-group">
                           <label class="form-label">نسبة النجاح (%)</label>
                           <input type="number" id="passingScore" class="form-control" 
                                  value="${lesson.passingScore || 70}" min="0" max="100">
                       </div>
                   `;
                   break;
                   
               case 'assignment':
                   editorContent = `
                       <div class="form-group">
                           <label class="form-label">عنوان المهمة</label>
                           <input type="text" id="lessonTitle" class="form-control" value="${lesson.title}">
                       </div>
                       <div class="form-group">
                           <label class="form-label">تعليمات المهمة</label>
                           <textarea id="lessonDescription" class="form-control" rows="5">${lesson.description || ''}</textarea>
                       </div>
                       <div class="form-group">
                           <label class="form-label">الوقت المتوقع لإنجاز المهمة (بالدقائق)</label>
                           <input type="number" id="lessonDuration" class="form-control" 
                                  value="${lesson.duration || 60}" min="10">
                       </div>
                       <div class="form-group">
                           <label class="form-label">نوع التسليم</label>
                           <select id="submissionType" class="form-control">
                               <option value="text" ${lesson.submissionType === 'text' ? 'selected' : ''}>نص</option>
                               <option value="file" ${lesson.submissionType === 'file' ? 'selected' : ''}>ملف</option>
                               <option value="link" ${lesson.submissionType === 'link' ? 'selected' : ''}>رابط</option>
                           </select>
                       </div>
                   `;
                   break;
                   
               case 'resource':
                   editorContent = `
                       <div class="form-group">
                           <label class="form-label">عنوان المورد</label>
                           <input type="text" id="lessonTitle" class="form-control" value="${lesson.title}">
                       </div>
                       <div class="form-group">
                           <label class="form-label">وصف المورد</label>
                           <textarea id="lessonDescription" class="form-control" rows="3">${lesson.description || ''}</textarea>
                       </div>
                       <div class="form-group">
                           <label class="form-label">رابط التحميل</label>
                           <input type="url" id="resourceUrl" class="form-control" 
                                  placeholder="رابط الملف" value="${lesson.resourceUrl || ''}">
                       </div>
                       <div class="form-group">
                           <label class="form-label">حجم الملف (MB)</label>
                           <input type="number" id="fileSize" class="form-control" 
                                  value="${lesson.fileSize || ''}" min="0.1" step="0.1">
                       </div>
                   `;
                   break;
                   
               case 'live':
                   editorContent = `
                       <div class="form-group">
                           <label class="form-label">عنوان الجلسة</label>
                           <input type="text" id="lessonTitle" class="form-control" value="${lesson.title}">
                       </div>
                       <div class="form-group">
                           <label class="form-label">وصف الجلسة</label>
                           <textarea id="lessonDescription" class="form-control" rows="3">${lesson.description || ''}</textarea>
                       </div>
                       <div class="form-group">
                           <label class="form-label">تاريخ ووقت الجلسة</label>
                           <input type="datetime-local" id="sessionDateTime" class="form-control" 
                                  value="${lesson.sessionDateTime || ''}">
                       </div>
                       <div class="form-group">
                           <label class="form-label">مدة الجلسة (بالدقائق)</label>
                           <input type="number" id="lessonDuration" class="form-control" 
                                  value="${lesson.duration || 60}" min="30">
                       </div>
                       <div class="form-group">
                           <label class="form-label">رابط الجلسة</label>
                           <input type="url" id="sessionUrl" class="form-control" 
                                  placeholder="Zoom, Google Meet, etc." value="${lesson.sessionUrl || ''}">
                       </div>
                   `;
                   break;
           }
           
           const { value: formValues } = await Swal.fire({
               title: isNew ? 'إضافة محتوى جديد' : 'تعديل المحتوى',
               html: editorContent,
               width: '700px',
               showCancelButton: true,
               confirmButtonText: isNew ? 'إضافة' : 'حفظ',
               cancelButtonText: 'إلغاء',
               confirmButtonColor: 'var(--primary)',
               background: 'var(--bg-card)',
               color: 'var(--text-primary)',
               didOpen: () => {
                   // Initialize Quill for text lessons
                   if (lesson.type === 'text') {
                       const textEditor = new Quill('#lessonContentEditor', {
                           theme: 'snow',
                           placeholder: 'اكتب محتوى الدرس هنا...',
                           modules: {
                               toolbar: [
                                   ['bold', 'italic', 'underline'],
                                   [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                   ['link', 'image'],
                                   ['clean']
                               ]
                           }
                       });
                       if (lesson.content) {
                           textEditor.root.innerHTML = lesson.content;
                       }
                       window.tempTextEditor = textEditor;
                   }
               },
               preConfirm: () => {
                   const title = document.getElementById('lessonTitle').value;
                   if (!title) {
                       Swal.showValidationMessage('يرجى إدخال عنوان المحتوى');
                       return false;
                   }
                   
                   const updatedLesson = {
                       ...lesson,
                       title: title,
                       duration: parseInt(document.getElementById('lessonDuration')?.value || 0)
                   };
                   
                   // Get type-specific data
                   switch(lesson.type) {
                       case 'video':
                           updatedLesson.videoUrl = document.getElementById('videoUrl').value;
                           updatedLesson.description = document.getElementById('lessonDescription').value;
                           break;
                       case 'text':
                           updatedLesson.content = window.tempTextEditor.root.innerHTML;
                           break;
                       case 'quiz':
                           updatedLesson.description = document.getElementById('lessonDescription').value;
                           updatedLesson.questionCount = parseInt(document.getElementById('questionCount').value);
                           updatedLesson.passingScore = parseInt(document.getElementById('passingScore').value);
                           break;
                       case 'assignment':
                           updatedLesson.description = document.getElementById('lessonDescription').value;
                           updatedLesson.submissionType = document.getElementById('submissionType').value;
                           break;
                       case 'resource':
                           updatedLesson.description = document.getElementById('lessonDescription').value;
                           updatedLesson.resourceUrl = document.getElementById('resourceUrl').value;
                           updatedLesson.fileSize = parseFloat(document.getElementById('fileSize').value || 0);
                           break;
                       case 'live':
                           updatedLesson.description = document.getElementById('lessonDescription').value;
                           updatedLesson.sessionDateTime = document.getElementById('sessionDateTime').value;
                           updatedLesson.sessionUrl = document.getElementById('sessionUrl').value;
                           break;
                   }
                   
                   return updatedLesson;
               }
           });

           if (formValues) {
               const module = courseData.modules.find(m => m.id === moduleId);
               if (!module) return;
               
               if (isNew) {
                   module.lessons.push(formValues);
               } else {
                   const index = module.lessons.findIndex(l => l.id === lesson.id);
                   if (index !== -1) {
                       module.lessons[index] = formValues;
                   }
               }
               
               // Re-render lessons
               const lessonsContainer = document.getElementById(`lessons-${moduleId}`);
               if (lessonsContainer) {
                   lessonsContainer.innerHTML = module.lessons.map(l => renderLessonHTML(l, moduleId)).join('');
               }
               
               // Update module meta
               updateModuleMeta(moduleId);
               updateCurriculumStats();
               updateProgress();
               autoSave();
               
               // Show success toast
               const Toast = Swal.mixin({
                   toast: true,
                   position: 'top-end',
                   showConfirmButton: false,
                   timer: 3000,
                   timerProgressBar: true,
                   background: 'var(--bg-card)',
                   color: 'var(--text-primary)'
               });
               
               Toast.fire({
                   icon: 'success',
                   title: isNew ? 'تم إضافة المحتوى بنجاح' : 'تم حفظ التغييرات'
               });
           }
           
           // Clean up
           if (window.tempTextEditor) {
               delete window.tempTextEditor;
           }
       }

       function editLesson(moduleId, lessonId) {
           const module = courseData.modules.find(m => m.id === moduleId);
           const lesson = module.lessons.find(l => l.id === lessonId);
           
           if (lesson) {
               showLessonEditor(moduleId, lesson, false);
           }
       }

       function deleteLesson(moduleId, lessonId) {
           event.stopPropagation();
           
           Swal.fire({
               title: 'تأكيد الحذف',
               text: 'هل أنت متأكد من حذف هذا المحتوى؟',
               icon: 'warning',
               showCancelButton: true,
               confirmButtonText: 'حذف',
               cancelButtonText: 'إلغاء',
               confirmButtonColor: 'var(--danger)',
               background: 'var(--bg-card)',
               color: 'var(--text-primary)'
           }).then((result) => {
               if (result.isConfirmed) {
                   const module = courseData.modules.find(m => m.id === moduleId);
                   if (module) {
                       module.lessons = module.lessons.filter(l => l.id !== lessonId);
                       
                       // Re-render lessons
                       const lessonsContainer = document.getElementById(`lessons-${moduleId}`);
                       if (lessonsContainer) {
                           lessonsContainer.innerHTML = module.lessons.map(l => renderLessonHTML(l, moduleId)).join('');
                       }
                       
                       updateModuleMeta(moduleId);
                       updateCurriculumStats();
                       updateProgress();
                       autoSave();
                   }
               }
           });
       }

       function updateModuleTitle(moduleId, title) {
           const module = courseData.modules.find(m => m.id === moduleId);
           if (module) {
               module.title = title;
               autoSave();
           }
       }

       function toggleModule(moduleId) {
           const moduleElement = document.querySelector(`[data-module-id="${moduleId}"]`);
           const module = courseData.modules.find(m => m.id === moduleId);
           
           if (module && moduleElement) {
               module.expanded = !module.expanded;
               moduleElement.classList.toggle('expanded');
           }
       }

       function deleteModule(moduleId) {
           Swal.fire({
               title: 'تأكيد الحذف',
               text: 'هل أنت متأكد من حذف هذه الوحدة وجميع دروسها؟',
               icon: 'warning',
               showCancelButton: true,
               confirmButtonText: 'حذف',
               cancelButtonText: 'إلغاء',
               confirmButtonColor: 'var(--danger)',
               background: 'var(--bg-card)',
               color: 'var(--text-primary)'
           }).then((result) => {
               if (result.isConfirmed) {
                   courseData.modules = courseData.modules.filter(m => m.id !== moduleId);
                   const moduleElement = document.querySelector(`[data-module-id="${moduleId}"]`);
                   if (moduleElement) {
                       moduleElement.remove();
                   }
                   
                   // Show empty state if no modules
                   if (courseData.modules.length === 0) {
                       document.getElementById('emptyModulesState').style.display = 'block';
                   }
                   
                   updateModuleNumbers();
                   updateCurriculumStats();
                   updateProgress();
                   autoSave();
               }
           });
       }

       function updateModuleNumbers() {
           document.querySelectorAll('.module-item').forEach((element, index) => {
               const numberElement = element.querySelector('.module-number');
               if (numberElement) {
                   numberElement.textContent = index + 1;
               }
           });
       }

       function updateModulesOrder() {
           const moduleElements = document.querySelectorAll('.module-item');
           const newOrder = [];
           
           moduleElements.forEach(element => {
               const moduleId = parseInt(element.dataset.moduleId);
               const module = courseData.modules.find(m => m.id === moduleId);
               if (module) {
                   newOrder.push(module);
               }
           });
           
           courseData.modules = newOrder;
           updateModuleNumbers();
       }

       function updateLessonsOrder(moduleId) {
           const module = courseData.modules.find(m => m.id === moduleId);
           if (!module) return;
           
           const lessonElements = document.querySelectorAll(`#lessons-${moduleId} .lesson-item`);
           const newOrder = [];
           
           lessonElements.forEach(element => {
               const lessonId = parseInt(element.dataset.lessonId);
               const lesson = module.lessons.find(l => l.id === lessonId);
               if (lesson) {
                   newOrder.push(lesson);
               }
           });
           
           module.lessons = newOrder;
       }

       function updateModuleMeta(moduleId) {
           const module = courseData.modules.find(m => m.id === moduleId);
           const moduleElement = document.querySelector(`[data-module-id="${moduleId}"]`);
           
           if (module && moduleElement) {
               const metaElement = moduleElement.querySelector('.module-meta');
               if (metaElement) {
                   metaElement.innerHTML = `
                       <span>${module.lessons.length} دروس</span>
                       <span>${calculateModuleDuration(module)} دقيقة</span>
                   `;
               }
           }
       }

       function calculateModuleDuration(module) {
           return module.lessons.reduce((total, lesson) => total + (lesson.duration || 0), 0);
       }

       function updateCurriculumStats() {
           let totalModules = courseData.modules.length;
           let totalLessons = 0;
           let totalDuration = 0;
           
           courseData.modules.forEach(module => {
               totalLessons += module.lessons.length;
               totalDuration += calculateModuleDuration(module);
           });
           
           courseData.totalLessons = totalLessons;
           courseData.totalDuration = totalDuration;
           
           document.getElementById('modulesCount').textContent = totalModules;
           document.getElementById('lessonsCount').textContent = totalLessons;
           document.getElementById('totalDuration').textContent = totalDuration;
           document.getElementById('totalLessons').textContent = totalLessons;
           document.getElementById('courseDuration').textContent = totalDuration;
       }

       // ==================== Student Experience ====================
       function selectExperience(element, type) {
           if (!type && element) {
               type = element.getAttribute('onclick').match(/'([^']+)'/)[1];
           }
           
           document.querySelectorAll('.experience-card').forEach(card => {
               card.classList.remove('selected');
           });
           
           if (element) {
               element.classList.add('selected');
           } else {
               document.querySelector(`.experience-card[onclick*="${type}"]`)?.classList.add('selected');
           }
           
           courseData.learningType = type;
           autoSave();
       }

       function toggleDripSettings() {
           const dripSettings = document.getElementById('dripSettings');
           const isEnabled = document.getElementById('dripContent').checked;
           
           if (dripSettings) {
               dripSettings.style.display = isEnabled ? 'block' : 'none';
           }
       }

       function updateRangeValue(input) {
           const valueId = input.id + 'Value';
           const valueElement = document.getElementById(valueId);
           if (valueElement) {
               valueElement.textContent = input.value;
           }
       }

       // ==================== Email Templates ====================
       async function editEmailTemplate(templateType) {
           // Placeholder for email template editor
           Swal.fire({
               title: 'تعديل قالب الرسالة',
               text: 'محرر قوالب الرسائل سيكون متاحاً قريباً',
               icon: 'info',
               confirmButtonColor: 'var(--primary)',
               background: 'var(--bg-card)',
               color: 'var(--text-primary)'
           });
       }

       async function previewEmailTemplate(templateType) {
           // Placeholder for email template preview
           Swal.fire({
               title: 'معاينة الرسالة',
               text: 'معاينة الرسائل ستكون متاحة قريباً',
               icon: 'info',
               confirmButtonColor: 'var(--primary)',
               background: 'var(--bg-card)',
               color: 'var(--text-primary)'
           });
       }

       async function addEmailTemplate() {
           // Placeholder for adding new email template
           Swal.fire({
               title: 'إضافة قالب رسالة',
               text: 'إضافة قوالب رسائل جديدة ستكون متاحة قريباً',
               icon: 'info',
               confirmButtonColor: 'var(--primary)',
               background: 'var(--bg-card)',
               color: 'var(--text-primary)'
           });
       }

       // ==================== SEO Functions ====================
       function updateSeoPreview() {
           const title = document.getElementById('seoTitle').value || 
                         document.getElementById('courseTitleMain').value || 
                         'عنوان الدورة';
           const description = document.getElementById('seoDescription').value || 
                              document.getElementById('courseDescription').value || 
                              'وصف الدورة...';
           const slug = document.getElementById('slugPreview').textContent;
           
           document.getElementById('seoPreviewTitle').textContent = title.substring(0, 60);
           document.getElementById('seoPreviewUrl').textContent = 
               `mahmoudfouad25.github.io/fouad-perspective/courses/${slug}`;
           document.getElementById('seoPreviewDesc').textContent = description.substring(0, 160);
       }

       // ==================== Publishing Functions ====================
       function saveDraft() {
           courseData.status = 'draft';
           saveCourseData().then(() => {
               Swal.fire({
                   icon: 'success',
                   title: 'تم الحفظ',
                   text: 'تم حفظ الدورة كمسودة',
                   timer: 1500,
                   showConfirmButton: false,
                   background: 'var(--bg-card)',
                   color: 'var(--text-primary)'
               });
           });
       }

       async function publishCourse() {
           if (courseData.progress < 60) {
               Swal.fire({
                   icon: 'warning',
                   title: 'الدورة غير مكتملة',
                   text: 'يجب إكمال 60% على الأقل من محتوى الدورة قبل النشر',
                   confirmButtonColor: 'var(--primary)',
                   background: 'var(--bg-card)',
                   color: 'var(--text-primary)'
               });
               return;
           }
           
           const result = await Swal.fire({
               title: 'نشر الدورة',
               text: 'هل أنت متأكد من نشر الدورة؟ سيتمكن الطلاب من الوصول إليها',
               icon: 'question',
               showCancelButton: true,
               confirmButtonText: 'نشر الآن',
               cancelButtonText: 'إلغاء',
               confirmButtonColor: 'var(--primary)',
               background: 'var(--bg-card)',
               color: 'var(--text-primary)'
           });

           if (result.isConfirmed) {
               courseData.status = 'published';
               courseData.publishedAt = new Date().toISOString();
               
               saveCourseData().then(() => {
                   if (window.firebaseDB && window.firebaseDB.courses) {
                       window.firebaseDB.courses.publishCourse(courseData.id).then(() => {
                           Swal.fire({
                               icon: 'success',
                               title: 'تم النشر بنجاح!',
                               text: 'دورتك متاحة الآن للطلاب',
                               confirmButtonColor: 'var(--primary)',
                               background: 'var(--bg-card)',
                               color: 'var(--text-primary)'
                           }).then(() => {
                               window.location.href = './courses.html';
                           });
                       });
                   }
               });
           }
       }

       function previewCourse() {
           saveCourseData().then(() => {
               if (courseData.id) {
                   window.open(`./course-preview.html?id=${courseData.id}`, '_blank');
               } else {
                   Swal.fire({
                       icon: 'warning',
                       title: 'احفظ الدورة أولاً',
                       text: 'يجب حفظ الدورة قبل المعاينة',
                       confirmButtonColor: 'var(--primary)',
                       background: 'var(--bg-card)',
                       color: 'var(--text-primary)'
                   });
               }
           });
       }

       function goBack() {
           Swal.fire({
               title: 'هل تريد المغادرة؟',
               text: 'سيتم حفظ جميع التغييرات تلقائياً',
               icon: 'question',
               showCancelButton: true,
               confirmButtonText: 'مغادرة',
               cancelButtonText: 'البقاء',
               confirmButtonColor: 'var(--primary)',
               background: 'var(--bg-card)',
               color: 'var(--text-primary)'
           }).then((result) => {
               if (result.isConfirmed) {
                   window.location.href = './dashboard.html';
               }
           });
       }

       // ==================== Expose Functions Globally ====================
       window.showStep = showStep;
       window.saveAndNext = saveAndNext;
       window.goBack = goBack;
       window.previewCourse = previewCourse;
       window.publishCourse = publishCourse;
       window.saveDraft = saveDraft;
       window.selectPriceType = selectPriceType;
       window.updateCurrency = updateCurrency;
       window.updatePricePreview = updatePricePreview;
       window.addCoupon = addCoupon;
       window.removeCoupon = removeCoupon;
       window.addPaymentPlan = addPaymentPlan;
       window.removePaymentPlan = removePaymentPlan;
       window.addModule = addModule;
       window.updateModuleTitle = updateModuleTitle;
       window.toggleModule = toggleModule;
       window.deleteModule = deleteModule;
       window.toggleContentTypes = toggleContentTypes;
       window.addLesson = addLesson;
       window.editLesson = editLesson;
       window.deleteLesson = deleteLesson;
       window.duplicateLesson = duplicateLesson;
       window.previewLesson = previewLesson;
       window.addObjective = addObjective;
       window.removeObjective = removeObjective;
       window.addRequirement = addRequirement;
       window.removeRequirement = removeRequirement;
       window.uploadCourseImage = uploadCourseImage;
       window.uploadInstructorImage = uploadInstructorImage;
       window.uploadSocialImage = uploadSocialImage;
       window.selectImageFile = selectImageFile;
       window.enterImageUrl = enterImageUrl;
       window.removeKeyword = removeKeyword;
       window.selectExperience = selectExperience;
       window.toggleDripSettings = toggleDripSettings;
       window.updateRangeValue = updateRangeValue;
       window.editEmailTemplate = editEmailTemplate;
       window.previewEmailTemplate = previewEmailTemplate;
       window.addEmailTemplate = addEmailTemplate;
       window.updateSlugPreview = updateSlugPreview;
       window.moduleSettings = moduleSettings;
       window.editCoupon = editCoupon;
       window.editPaymentPlan = editPaymentPlan;

       // Placeholder functions
       function duplicateLesson(moduleId, lessonId) {
           console.log('Duplicate lesson:', moduleId, lessonId);
           // Implementation coming soon
       }

       function previewLesson(moduleId, lessonId) {
           console.log('Preview lesson:', moduleId, lessonId);
           // Implementation coming soon
       }

       function moduleSettings(moduleId) {
           console.log('Module settings:', moduleId);
           // Implementation coming soon
       }

       function editCoupon(index) {
           console.log('Edit coupon:', index);
           // Implementation coming soon
       }

       function editPaymentPlan(index) {
           console.log('Edit payment plan:', index);
           // Implementation coming soon
       }
   </script>
</body>
</html>
