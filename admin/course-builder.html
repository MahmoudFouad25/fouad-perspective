<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بناء دورة جديدة - منصة فؤاد</title>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f3f4f6;
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-card: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #e5e7eb;
            --text-muted: #9ca3af;
            --border-color: #4b5563;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Layout */
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }

        .main-content {
            flex: 1;
            background-color: var(--bg-primary);
            overflow-x: hidden;
        }

        /* Header Styles */
        .page-header {
            background-color: var(--bg-secondary);
            padding: 2rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .page-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .breadcrumb {
            background: transparent;
            padding: 0;
            margin: 0;
        }

        .breadcrumb-item {
            color: var(--text-muted);
        }

        .breadcrumb-item.active {
            color: var(--text-secondary);
        }

        /* Builder Container */
        .builder-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem 2rem;
        }

        /* Progress Bar */
        .progress-tracker {
            background-color: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
        }

        .progress {
            height: 0.5rem;
            background-color: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .progress-bar {
            background-color: var(--primary);
            transition: width 0.3s ease;
        }

        .step-indicators {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .step-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .step-indicator:hover {
            transform: translateY(-2px);
        }

        .step-number {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background-color: var(--bg-card);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .step-indicator.active .step-number {
            background-color: var(--primary);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }

        .step-indicator.completed .step-number {
            background-color: var(--success);
            border-color: var(--success);
            color: white;
        }

        .step-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            text-align: center;
            max-width: 100px;
        }

        .step-indicator.active .step-label,
        .step-indicator.completed .step-label {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Form Styles */
        .builder-form {
            background-color: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-md);
        }

        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .form-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title i {
            color: var(--primary);
        }

        .form-label {
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-label .required {
            color: var(--danger);
        }

        .form-control,
        .form-select {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: var(--radius-md);
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus,
        .form-select:focus {
            background-color: var(--bg-card);
            border-color: var(--primary);
            color: var(--text-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        .form-text {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Switches */
        .form-switch {
            padding-left: 3rem;
        }

        .form-switch .form-check-input {
            width: 3rem;
            height: 1.5rem;
            background-color: var(--bg-card);
            border-color: var(--border-color);
            cursor: pointer;
        }

        .form-switch .form-check-input:checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background-color: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--bg-primary);
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #059669;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-outline-primary {
            background-color: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary);
            color: white;
        }

        /* Cards */
        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* File Upload */
        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            padding: 3rem;
            text-align: center;
            background-color: var(--bg-card);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background-color: rgba(99, 102, 241, 0.05);
        }

        .file-upload-area i {
            font-size: 3rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        /* Image Preview */
        .image-preview {
            position: relative;
            border-radius: var(--radius-lg);
            overflow: hidden;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
        }

        .image-preview img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .image-preview .remove-image {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: var(--danger);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-preview .remove-image:hover {
            background-color: #dc2626;
        }
/* زر تثبيت الرابط */
#saveSlugBtn {
    transition: all 0.3s ease;
    font-weight: 600;
}

#saveSlugBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

#saveSlugBtn.btn-success {
    background-color: #10b981;
    border-color: #10b981;
}

#saveSlugBtn.btn-danger {
    animation: shake 0.5s;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

/* تنسيق خاص لحقل الـ Slug */
#courseSlug {
    font-family: monospace;
    font-weight: 600;
    letter-spacing: 0.5px;
    background-color: rgba(99, 102, 241, 0.05);
}

        /* Tags Input */
        .tags-input {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 0.5rem;
            min-height: 3rem;
        }

        .tag {
            background-color: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tag .remove-tag {
            cursor: pointer;
            font-size: 1rem;
        }

        .price-preview-container {
    background-color: var(--bg-card);
    padding: 20px;
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
}

.preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.preview-card {
    background: var(--bg-secondary);
    padding: 20px;
    border-radius: var(--radius-md);
    text-align: center;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

.preview-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.preview-card.featured {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.1);
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
}

.preview-card h5 {
    font-size: 0.9rem;
    margin-bottom: 10px;
    color: var(--text-secondary);
}

.price-display {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--primary);
    margin: 10px 0;
}

.discount-badge {
    display: inline-block;
    background: rgba(16, 185, 129, 0.2);
    color: var(--success);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
}

.preview-section-title {
    grid-column: 1 / -1;
    text-align: center;
    margin: 20px 0 10px;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 1.1rem;
}

.preview-card.payment-plan {
    background-color: rgba(99, 102, 241, 0.05);
    border-color: rgba(99, 102, 241, 0.3);
}

.preview-card.group {
    background-color: rgba(251, 191, 36, 0.05);
    border-color: rgba(251, 191, 36, 0.3);
}


.price-amount {
    font-size: 24px;
    font-weight: bold;
    color: var(--primary);
    margin: 10px 0;
}

.discount-info {
    color: #28a745;
    font-size: 14px;
}
        /* تحسين شكل معاينة خطط الدفع */
.preview-card .price-display {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 5px;
}

.preview-card small {
    color: var(--text-muted);
    display: block;
    margin-top: 5px;
}

        /* Module Builder */
        .module-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .module-header {
            background-color: var(--bg-secondary);
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: move;
        }

        .module-header .drag-handle {
            color: var(--text-muted);
            margin-left: 0.5rem;
        }

        .module-content {
            padding: 1rem;
        }

        .lesson-item {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: move;
        }

        .lesson-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .lesson-type-icon {
            width: 2.5rem;
            height: 2.5rem;
            background-color: var(--primary);
            color: white;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Navigation */
        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .builder-container {
                padding: 0 1rem 1rem;
            }

            .step-indicators {
                flex-wrap: wrap;
                gap: 1rem;
            }

            .step-navigation {
                flex-direction: column-reverse;
                gap: 1rem;
            }

            .step-navigation .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Quill Editor Custom Styles */
        .ql-toolbar.ql-snow {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .ql-container.ql-snow {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            color: var(--text-primary);
        }

        .ql-editor {
            min-height: 200px;
            font-family: 'Cairo', sans-serif;
        }

        .ql-snow .ql-stroke {
            stroke: var(--text-secondary);
        }

        .ql-snow .ql-fill {
            fill: var(--text-secondary);
        }

        .ql-snow .ql-picker {
            color: var(--text-secondary);
        }

        /* Alert Styles */
        .alert {
            border-radius: var(--radius-md);
            border: none;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .alert-info {
            background-color: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .alert-success {
            background-color: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .alert-warning {
            background-color: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        .alert-danger {
            background-color: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid var(--bg-card);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Auto-save indicator */
        .auto-save-indicator {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .auto-save-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .auto-save-indicator i {
            color: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Tooltips */
        .tooltip-wrapper {
            position: relative;
            display: inline-block;
        }

        .tooltip-content {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 10;
            margin-bottom: 0.5rem;
        }

        .tooltip-wrapper:hover .tooltip-content {
            opacity: 1;
            visibility: visible;
        }

        /* Accordion styles for advanced sections */
        .accordion {
            background-color: transparent;
        }

        .accordion-item {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            margin-bottom: 0.5rem;
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .accordion-header {
            margin: 0;
        }

        .accordion-button {
            background-color: var(--bg-card);
            color: var(--text-primary);
            border: none;
            padding: 1rem 1.5rem;
            font-weight: 500;
        }

        .accordion-button:not(.collapsed) {
            background-color: var(--bg-secondary);
            color: var(--primary);
        }

        .accordion-button:focus {
            box-shadow: none;
        }

        .accordion-button::after {
            filter: invert(1);
        }

        .accordion-body {
            background-color: var(--bg-card);
            color: var(--text-secondary);
            padding: 1.5rem;
        }

        /* Step content */
        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Badge styles */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-primary {
            background-color: var(--primary);
            color: white;
        }

        .badge-success {
            background-color: var(--success);
            color: white;
        }

        .badge-warning {
            background-color: var(--warning);
            color: white;
        }

        .badge-danger {
            background-color: var(--danger);
            color: white;
        }

        /* List items */
        .list-group {
            background-color: transparent;
        }

        .list-group-item {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 1rem 1.5rem;
            margin-bottom: 0.5rem;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .list-group-item:hover {
            background-color: var(--bg-secondary);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .empty-state p {
            margin-bottom: 1.5rem;
        }

        /* Price input group */
        .price-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .price-input-group .currency-label {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Module statistics */
        .module-stats {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--bg-card);
            border-radius: var(--radius-md);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Payment method cards */
        .payment-method-card {
            background-color: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .payment-method-card.active {
            border-color: var(--primary);
            background-color: rgba(99, 102, 241, 0.05);
        }

        .payment-method-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .payment-method-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
        }

        .payment-method-icon {
            width: 2.5rem;
            height: 2.5rem;
            background-color: var(--primary);
            color: white;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* إصلاح ألوان خطط الدفع */
#paymentPlansList .card {
    background-color: var(--bg-card);
    border: 1px solid var(--border-color);
}

#paymentPlansList .card-body {
    color: var(--text-primary);
}

#paymentPlansList h5 {
    color: var(--text-primary);
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
}

#paymentPlansList p {
    color: var(--text-secondary);
    margin-bottom: 0;
}

#paymentPlansList .btn-info {
    background-color: var(--info);
    border-color: var(--info);
    color: white;
}

#paymentPlansList .btn-info:hover {
    background-color: #2563eb;
    border-color: #2563eb;
}
        // إضافة CSS للكوبونات والمنح
const additionalCSS = `
.preview-card.coupon {
    background-color: rgba(139, 92, 246, 0.05);
    border-color: rgba(139, 92, 246, 0.3);
}

/* CSS لمعاينة المنح */
.preview-card.grant {
    background-color: rgba(16, 185, 129, 0.05);
    border-color: rgba(16, 185, 129, 0.3);
}

.preview-card.grant h5 {
    color: var(--text-primary);
    font-weight: 500;
}
`;
/* ============ قسم المنح المرن ============ */
.grant-types-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 10px;
}

.grant-types-grid .form-check {
    background: var(--bg-secondary);
    padding: 15px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

.grant-types-grid .form-check:hover {
    border-color: var(--primary);
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
}

.grant-types-grid .form-check-label {
    cursor: pointer;
    width: 100%;
}

.grant-types-grid .form-check-label strong {
    color: var(--text-primary);
    display: block;
    margin-bottom: 5px;
}

.criteria-list {
    background: var(--bg-secondary);
    padding: 20px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
}

.criterion-item {
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color);
}

.criterion-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.evaluation-criteria .form-check-label {
    color: var(--text-primary);
    margin-left: 10px;
}

#grantsSettings .alert-info {
    background-color: rgba(99, 102, 241, 0.1);
    border-color: rgba(99, 102, 241, 0.3);
    color: var(--text-primary);
}

#grantsSettings .alert-info h5 {
    color: var(--primary);
    margin-bottom: 10px;
}

#grantsSettings .alert-info ul {
    margin-bottom: 0;
    padding-left: 25px;
}

#grantsSettings .alert-info li {
    margin-bottom: 5px;
    color: var(--text-secondary);
}

/* ========== جدول الأسعار المحسّن ========== */
.pricing-table-wrapper {
    background: #1a1f2e;
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    margin-top: 2rem;
}

.pricing-table-title,
.sub-table-title {
    color: #fbbf24;
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
    text-align: center;
    font-weight: 600;
}

.sub-table-title {
    font-size: 1.2rem;
    text-align: right;
}

.table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.pricing-table,
.sub-table {
    width: 100%;
    border-collapse: collapse;
    background: #0f172a;
    border-radius: 10px;
    overflow: hidden;
}

.pricing-table thead,
.sub-table thead {
    background: linear-gradient(135deg, #3730a3 0%, #4c1d95 100%);
}

.pricing-table th,
.sub-table th {
    padding: 1rem;
    color: white;
    font-weight: 600;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.pricing-table td,
.sub-table td {
    padding: 1rem;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #e5e7eb;
}

/* صفوف العروض بألوان مختلفة */
.discount-early-extra {
    background: rgba(16, 185, 129, 0.15);
}

.discount-early {
    background: rgba(59, 130, 246, 0.15);
}

.discount-regular {
    background: rgba(251, 191, 36, 0.15);
}

/* تنسيق الخلايا */
.offer-name-cell {
    font-weight: bold;
    text-align: right;
}

.offer-name {
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
}

.discount-badge {
    display: inline-block;
    background: #10b981;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
}

.date-range {
    font-size: 0.8rem;
    color: #9ca3af;
    line-height: 1.4;
}

.price-value {
    font-size: 1.3rem;
    font-weight: 700;
    color: #fbbf24;
}

.base-price-cell .price-value {
    color: #10b981;
    font-size: 1.5rem;
}

.payment-note,
.group-note {
    font-size: 0.85rem;
    color: #9ca3af;
    margin-top: 0.25rem;
}

.cash-payment {
    background: rgba(16, 185, 129, 0.1);
}

.group-cell {
    background: rgba(139, 92, 246, 0.1);
}

.installment-info {
    font-weight: 600;
    color: #60a5fa;
}

/* جداول الكوبونات والمنح */
.coupons-table {
    background: rgba(99, 102, 241, 0.05);
}

.grants-table {
    background: rgba(16, 185, 129, 0.05);
}

.coupon-code {
    font-family: 'Courier New', monospace;
    font-size: 1.1rem;
    font-weight: 700;
    color: #818cf8;
    letter-spacing: 1px;
}

/* Hover effect */
.pricing-table tbody tr:hover,
.sub-table tbody tr:hover {
    background-color: rgba(99, 102, 241, 0.2);
    transition: background-color 0.3s ease;
}

/* Responsive */
@media (max-width: 768px) {
    .pricing-table-wrapper {
        padding: 1rem;
    }
    
    .pricing-table,
    .sub-table {
        font-size: 0.85rem;
    }
    
    .price-value {
        font-size: 1rem;
    }
    
    .base-price-cell .price-value {
        font-size: 1.2rem;
    }
}
        /* تحسينات الجدول */
.pricing-table th[rowspan="2"] {
    background: linear-gradient(135deg, #4c1d95 0%, #3730a3 100%);
    vertical-align: middle !important;
}

.pricing-table th[colspan] {
    background: #3730a3;
    text-align: center;
}

.cash-payment {
    background: rgba(16, 185, 129, 0.1);
    padding: 10px;
    border-radius: 8px;
}

.installment-payment {
    padding: 10px;
}

.discount-note {
    color: #10b981;
    font-size: 0.8rem;
    margin-top: 5px;
    display: block;
}

.individual-cell {
    text-align: center;
    color: #6b7280;
}

        /* صفوف الأقساط الفرعية */
.sub-row {
    background: rgba(255, 255, 255, 0.02);
    font-size: 0.9rem;
}

.sub-row td {
    padding: 8px !important;
    border-top: none !important;
}

.individual-installments,
.group-installments {
    color: #9ca3af;
}

.active-plan {
    color: #10b981;
    text-align: center;
}
/* Library Content Styles */

        /* Library Content Styles */
.library-content-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.library-content-card:hover {
    border-color: #6366f1 !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
}

/* Spinner animation */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Auto-save Indicator -->
    <div class="auto-save-indicator" id="autoSaveIndicator">
        <i class="fas fa-check-circle"></i>
        <span>تم الحفظ تلقائياً</span>
    </div>

    <!-- Main Layout -->
    <div class="admin-layout">
        <div class="main-content">
            <!-- Page Header -->
            <header class="page-header">
                <div class="container-fluid">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/admin">لوحة التحكم</a></li>
                            <li class="breadcrumb-item"><a href="/fouad-perspective/admin/courses.html">الدورات</a></li>
                            <li class="breadcrumb-item active">دورة جديدة</li>
                        </ol>
                    </nav>
                    <h1 id="courseTitleHeader">دورة جديدة</h1>
                </div>
            </header>

            <!-- Main Content -->
            <main class="builder-container">
                <!-- Progress Tracker -->
                <div class="progress-tracker">
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" style="width: 20%"></div>
                    </div>
                    <div class="step-indicators">
                        <div class="step-indicator active" onclick="showStep(1)">
                            <div class="step-number">1</div>
                            <div class="step-label">المعلومات الأساسية</div>
                        </div>
                        <div class="step-indicator" onclick="showStep(2)">
                            <div class="step-number">2</div>
                            <div class="step-label">التسعير والدفع</div>
                        </div>
                        <div class="step-indicator" onclick="showStep(3)">
                            <div class="step-number">3</div>
                            <div class="step-label">بناء المنهج</div>
                        </div>
                        <div class="step-indicator" onclick="showStep(4)">
                            <div class="step-number">4</div>
                            <div class="step-label">الإعدادات المتقدمة</div>
                        </div>
                        <div class="step-indicator" onclick="showStep(5)">
                            <div class="step-number">5</div>
                            <div class="step-label">المراجعة والنشر</div>
                        </div>
                    </div>
                </div>

                <!-- Form Steps -->
                <div class="builder-form">
                    <!-- Step 1: Basic Information -->
                    <div class="step-content active" id="step1">
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-info-circle"></i>
                                معلومات الدورة الأساسية
                            </h2>
                            
                            <div class="row">
                                <div class="col-lg-8 mb-3">
                                    <label class="form-label">
                                        عنوان الدورة <span class="required">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="courseTitle" 
       placeholder="مثال: دورة احتراف التصميم الجرافيكي"
       onchange="updateCourseTitle(this.value)" required>
                                    <div class="form-text">اختر عنواناً واضحاً وجذاباً يصف محتوى الدورة</div>
                                </div>
                                
                                <div class="col-lg-4 mb-3">
                                    <label class="form-label">الرابط المخصص (Slug)</label>
                                    <div class="input-group">
    <input type="text" class="form-control" id="courseSlug" 
           placeholder="يتم توليده تلقائياً" dir="ltr">
    <button class="btn btn-primary" type="button" onclick="saveCourseSlug()" 
            id="saveSlugBtn" style="min-width: 140px;">
        <i class="fas fa-link"></i> تثبيت الرابط
    </button>
</div>
<div class="form-text">
    <span class="text-danger">
        <i class="fas fa-exclamation-circle"></i> 
        مهم جداً: اضغط "تثبيت الرابط" فور كتابة العنوان لحفظه في Firebase
    </span>
</div>
                                    <div class="form-text">سيظهر في: /courses/<span id="slugPreview">course-name</span></div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">العنوان الفرعي</label>
                                <input type="text" class="form-control" id="subtitle" 
                                       placeholder="وصف قصير يظهر تحت العنوان الرئيسي">
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">الوصف المختصر <span class="required">*</span></label>
                                    <textarea class="form-control" id="description" rows="4" 
                                              placeholder="وصف مختصر للدورة (150-200 كلمة)" required></textarea>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">الوصف التفصيلي</label>
                                    <textarea class="form-control" id="detailedDescription" rows="4" 
                                              placeholder="وصف تفصيلي يظهر في صفحة الدورة"></textarea>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">اللغة <span class="required">*</span></label>
                                    <select class="form-select" id="language" required>
                                        <option value="ar">العربية</option>
                                        <option value="en">English</option>
                                        <option value="ar-en">عربي + English</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">الجمهور المستهدف</label>
                                    <select class="form-select" id="targetAudience">
    <option value="">من يحتاج هذه الدورة في رحلته؟</option>
    
    <optgroup label="الغرباء - لم يبدأوا الرحلة بعد">
        <option value="comfortable-sleepers">النائمون المرتاحون - يعيشون في الوهم دون وعي</option>
        <option value="restless-sleepers">النائمون القلقون - يشعرون أن شيئاً ما ليس صحيحاً</option>
        <option value="disturbed-dreamers">الحالمون المضطربون - بدأت الأقنعة تضايقهم</option>
    </optgroup>
    
    <optgroup label="المستيقظون - بدأوا يرون">
        <option value="newly-awakened">المستيقظون حديثاً - صُدموا من رؤية أقنعتهم</option>
        <option value="confused-seekers">الباحثون الحائرون - يريدون الحقيقة لكن لا يعرفون الطريق</option>
        <option value="resistant-fighters">المقاومون المكافحون - يحاربون الأقنعة لكن بطريقة خاطئة</option>
    </optgroup>
    
    <optgroup label="السائرون - في الطريق">
        <option value="brave-walkers">السائرون الشجعان - بدأوا خلع الأقنعة رغم الألم</option>
        <option value="stumbling-travelers">المتعثرون المثابرون - يقعون ويقومون في الرحلة</option>
        <option value="steady-progressers">المتقدمون بثبات - وجدوا إيقاعهم في الرحلة</option>
    </optgroup>
    
    <optgroup label="الواصلون - يعيشون الحياة الطيبة">
        <option value="integrated-beings">المتكاملون - يعيشون من الأصالة</option>
        <option value="serving-guides">المرشدون الخادمون - يريدون مساعدة الآخرين</option>
        <option value="wisdom-sharers">ناقلو الحكمة - يشاركون ثمار رحلتهم</option>
    </optgroup>
</select>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">فيديو تعريفي</label>
                                    <input type="url" class="form-control" id="introVideo" 
                                           placeholder="رابط YouTube أو Vimeo" dir="ltr">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-bullseye"></i>
                                أهداف ومتطلبات الدورة
                            </h2>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">أهداف الدورة</label>
                                    <div id="objectivesList" class="mb-2"></div>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="objectiveInput" 
                                               placeholder="أضف هدف جديد">
                                        <button class="btn btn-primary" onclick="addObjective()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">ماذا سيتعلم الطلاب من هذه الدورة؟</div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">المتطلبات المسبقة</label>
                                    <div id="requirementsList" class="mb-2"></div>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="requirementInput" 
                                               placeholder="أضف متطلب جديد">
                                        <button class="btn btn-primary" onclick="addRequirement()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">ما الذي يحتاجه الطالب قبل البدء؟</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-image"></i>
                                الصور والوسائط
                            </h2>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">صورة الدورة الرئيسية</label>
                                    <div class="file-upload-area" onclick="document.getElementById('thumbnailInput').click()">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p>اسحب الصورة هنا أو انقر للاختيار</p>
                                        <small class="text-muted">JPG, PNG (1920x1080px مستحسن)</small>
                                    </div>
                                    <input type="file" id="thumbnailInput" accept="image/*" style="display: none;" 
                                           onchange="handleImageUpload(this, 'thumbnail')">
                                    <div id="thumbnailPreview" class="image-preview mt-2" style="display: none;">
                                        <img id="thumbnailImage" src="" alt="">
                                        <button class="remove-image" onclick="removeImage('thumbnail')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">صورة وسائل التواصل</label>
                                    <div class="file-upload-area" onclick="document.getElementById('socialImageInput').click()">
                                        <i class="fas fa-share-alt"></i>
                                        <p>صورة للمشاركة على السوشيال ميديا</p>
                                        <small class="text-muted">JPG, PNG (1200x630px مستحسن)</small>
                                    </div>
                                    <input type="file" id="socialImageInput" accept="image/*" style="display: none;" 
                                           onchange="handleImageUpload(this, 'social')">
                                    <div id="socialImagePreview" class="image-preview mt-2" style="display: none;">
                                        <img id="socialImage" src="" alt="">
                                        <button class="remove-image" onclick="removeImage('social')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">صورة المدرب</label>
                                    <div class="file-upload-area" onclick="document.getElementById('instructorImageInput').click()">
                                        <i class="fas fa-user-tie"></i>
                                        <p>صورة شخصية للمدرب</p>
                                        <small class="text-muted">JPG, PNG (مربعة مستحسن)</small>
                                    </div>
                                    <input type="file" id="instructorImageInput" accept="image/*" style="display: none;" 
                                           onchange="handleImageUpload(this, 'instructor')">
                                    <div id="instructorImagePreview" class="image-preview mt-2" style="display: none;">
                                        <img id="instructorImage" src="" alt="">
                                        <button class="remove-image" onclick="removeImage('instructor')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-chalkboard-teacher"></i>
                                معلومات المدرب
                            </h2>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">اسم المدرب <span class="required">*</span></label>
                                    <input type="text" class="form-control" id="instructorName" 
                                           placeholder="الاسم الكامل" required>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">المسمى الوظيفي</label>
                                    <input type="text" class="form-control" id="instructorTitle" 
                                           placeholder="مثال: خبير تصميم جرافيك">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">نبذة عن المدرب</label>
                                <textarea class="form-control" id="instructorBio" rows="4" 
                                          placeholder="نبذة مختصرة عن خبرات ومؤهلات المدرب"></textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">LinkedIn</label>
                                    <input type="url" class="form-control" id="instructorLinkedIn" 
                                           placeholder="https://linkedin.com/in/username" dir="ltr">
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Twitter/X</label>
                                    <input type="url" class="form-control" id="instructorTwitter" 
                                           placeholder="https://twitter.com/username" dir="ltr">
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">الموقع الشخصي</label>
                                    <input type="url" class="form-control" id="instructorWebsite" 
                                           placeholder="https://example.com" dir="ltr">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-tags"></i>
                                التصنيف والكلمات المفتاحية
                            </h2>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">مجال التطبيق </label>
                                    <select class="form-select" id="applicationDomain">
    <option value="">في أي مجال من مجالات الحياة؟</option>
    
    <optgroup label="الذات - رحلة داخلية">
        <option value="self-masks">كشف أقنعة الذات - رؤية الوجه الحقيقي</option>
        <option value="heart-awakening">إحياء الفؤاد - إيقاظ القلب الميت</option>
        <option value="illusion-breaking">كسر الأوهام - التحرر من الإضافة/الإزالة/التجاوز</option>
        <option value="authentic-living">العيش الأصيل - الحياة من المركز الحقيقي</option>
    </optgroup>
    
    <optgroup label="العلاقات - رحلة مع الآخرين">
        <option value="family-healing">شفاء الأسرة - علاقات بلا أقنعة</option>
        <option value="marriage-depth">عمق الزواج - الحب من القلب للقلب</option>
        <option value="parenting-wisdom">حكمة التربية - تربية على الفطرة</option>
        <option value="friendship-truth">صدق الصداقة - علاقات على الحقيقة</option>
    </optgroup>
    
    <optgroup label="العمل - رحلة في المهنة">
        <option value="work-purpose">غاية العمل - من الوظيفة للرسالة</option>
        <option value="leadership-heart">قيادة القلب - القيادة بالرحمة</option>
        <option value="creative-flow">تدفق الإبداع - الإبداع من الفؤاد</option>
        <option value="service-excellence">إتقان الخدمة - الإحسان في العمل</option>
    </optgroup>
    
    <optgroup label="الحياة - رحلة شاملة">
        <option value="health-holistic">الصحة الشاملة - علاج الجسد والروح</option>
        <option value="money-wisdom">حكمة المال - من الجشع للكفاية</option>
        <option value="time-presence">حضور الوقت - من الهروب للحضور</option>
        <option value="life-balance">توازن الحياة - الحياة الطيبة</option>
    </optgroup>
</select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">عمق الممارسة</label>
                                    <select class="form-select" id="practiceDepth">
    <option value="">ما مستوى العمق المطلوب؟</option>
    
    <option value="first-touch">اللمسة الأولى - تعريف لطيف يفتح الباب</option>
    <option value="gentle-intro">المقدمة الرقيقة - دعوة آمنة للاستكشاف</option>
    <option value="safe-exploration">الاستكشاف الآمن - مساحة محمية للتجربة</option>
    <option value="guided-practice">الممارسة الموجهة - تطبيق مع مرافقة</option>
    <option value="deep-diving">الغوص العميق - مواجهة الظلال والجروح</option>
    <option value="intensive-work">العمل المكثف - تفكيك وإعادة بناء</option>
    <option value="transformation-journey">رحلة التحول - مرافقة طويلة المدى</option>
    <option value="integration-mastery">التكامل والإتقان - تجسيد كامل للمنظور</option>
</select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">الكلمات المفتاحية</label>
                                <div class="tags-input" id="keywordsTags"></div>
                                <input type="text" class="form-control mt-2" id="keywordInput" 
                                       placeholder="اكتب كلمة مفتاحية واضغط Enter">
                                <div class="form-text">أضف كلمات مفتاحية لتحسين ظهور الدورة في البحث</div>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <div></div>
                            <button class="btn btn-primary" onclick="showStep(2)">
                                التالي <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>

<!-- Step 2: التسعير والدفع -->
<div class="step-content" id="step2">
    <!-- القسم الأساسي للتسعير -->
    <div class="form-section">
        <h2 class="section-title">
            <i class="fas fa-tag"></i>
            التسعير الأساسي
        </h2>
        
        <div class="row">
            <div class="col-md-3 mb-3">
                <label class="form-label">نوع التسعير <span class="required">*</span></label>
                <select class="form-select" id="priceType" onchange="updatePricingFields()">
                    <option value="free">مجانية</option>
                    <option value="paid-enrolled">مدفوعة - مسجلة</option>
                    <option value="paid-direct">مدفوعة - مباشر</option>
                </select>
            </div>
            
            <div class="col-md-3 mb-3">
                <label class="form-label">العملة</label>
                <select class="form-select" id="currency" onchange="updateCurrencyLabel()">
                    <option value="EGP">جنيه مصري (EGP)</option>
                    <option value="SAR">ريال سعودي (SAR)</option>
                    <option value="USD">دولار أمريكي (USD)</option>
                    <option value="EUR">يورو (EUR)</option>
                    <option value="AED">درهم إماراتي (AED)</option>
                </select>
            </div>
            
            <div class="col-md-3 mb-3" id="priceField" style="display: none;">
                <label class="form-label">سعر الدورة <span class="required">*</span></label>
                <div class="price-input-group">
                    <input type="number" class="form-control" id="price" 
                           placeholder="0" min="0" step="1" onchange="updatePricePreview()">
                    <span class="currency-label" id="currencyLabel">EGP</span>
                </div>
            </div>
            
            <div class="col-md-3 mb-3" id="salePriceField" style="display: none;">
                <label class="form-label">سعر التخفيض (اختياري)</label>
                <input type="number" class="form-control" id="salePrice" 
                       placeholder="0" min="0" step="1" onchange="updatePricePreview()">
            </div>
        </div>
    </div>

    <!-- العروض والخصومات الزمنية -->
    <div class="form-section">
        <h2 class="section-title">
            <i class="fas fa-clock"></i>
            العروض والخصومات الزمنية
        </h2>
        
        <div id="discountsList" class="mb-3"></div>
        
        <button class="btn btn-outline-primary" onclick="addDiscountTier()">
            <i class="fas fa-plus"></i> إضافة عرض خصم
        </button>
    </div>

    <!-- خصم الدفع الكامل -->
    <div class="form-section">
        <h2 class="section-title">
            <i class="fas fa-money-bill-wave"></i>
            خصم الدفع الكامل
        </h2>
        
        <div class="form-check mb-3">
            <input type="checkbox" class="form-check-input" id="enableCashDiscount" onchange="toggleCashDiscount()">
            <label class="form-check-label" for="enableCashDiscount">
                تفعيل خصم للدفع الكامل (كاش)
            </label>
        </div>
        
        <div id="cashDiscountSection" style="display: none;">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">نسبة الخصم</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="cashDiscountPercent" 
                               value="5" min="0" max="50" onchange="updatePricePreview()">
                        <span class="input-group-text">%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- خصومات المجموعات -->
    <div class="form-section">
        <h2 class="section-title">
            <i class="fas fa-users"></i>
            خصومات المجموعات
        </h2>
        
        <div id="groupDiscountsList" class="mb-3"></div>
        
        <button class="btn btn-outline-primary" onclick="addGroupDiscount()">
            <i class="fas fa-plus"></i> إضافة عرض مجموعات
        </button>
    </div>

    <!-- خطط الدفع والتقسيط -->
    <div class="form-section">
        <h2 class="section-title">
            <i class="fas fa-calendar-alt"></i>
            خطط الدفع والتقسيط
        </h2>
        
        <div id="paymentPlansList" class="mb-3"></div>
        
        <button class="btn btn-outline-primary" onclick="addPaymentPlan()">
            <i class="fas fa-plus"></i> إضافة خطة دفع
        </button>
    </div>

    <!-- كوبونات الخصم -->
    <div class="form-section">
        <h2 class="section-title">
            <i class="fas fa-ticket-alt"></i>
            كوبونات الخصم
        </h2>
        
        <div id="couponsList" class="mb-3"></div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <input type="text" class="form-control" id="couponCode" 
                       placeholder="كود الكوبون" style="text-transform: uppercase;">
            </div>
            <div class="col-md-3 mb-3">
                <select class="form-select" id="couponType">
                    <option value="percentage">نسبة مئوية</option>
                    <option value="fixed">مبلغ ثابت</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <input type="number" class="form-control" id="couponValue" 
                       placeholder="القيمة" min="0">
            </div>
            <div class="col-md-2 mb-3">
                <button class="btn btn-primary w-100" onclick="addCoupon()">
                    <i class="fas fa-plus"></i> إضافة
                </button>
            </div>
        </div>
    </div>

<!-- برنامج المنح -->
<div class="form-section">
    <h2 class="section-title">
        <i class="fas fa-hands-helping"></i>
        برنامج المنح الدراسية
    </h2>
    
    <div class="form-check mb-3">
        <input type="checkbox" class="form-check-input" id="enableGrants" onchange="toggleGrants()">
        <label class="form-check-label" for="enableGrants">
            تفعيل برنامج المنح لهذه الدورة
        </label>
    </div>
    
    <div id="grantsSettings" style="display: none;">
        <!-- الإعدادات العامة للمنح -->
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">عدد المقاعد المخصصة للمنح</label>
                <input type="number" class="form-control" id="grantSeats" value="5" min="1">
            </div>
            <div class="col-md-6">
                <label class="form-label">إجمالي مقاعد الدورة</label>
                <input type="number" class="form-control" id="totalSeats" value="30" min="1">
            </div>
        </div>
        
        <h5>أنواع الدعم المتاحة:</h5>
        <div class="grant-types-grid mb-3">
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="grantDiscount" checked>
                <label class="form-check-label" for="grantDiscount">
                    <strong>خصومات مرنة</strong>
                    <small class="d-block">خصومات حسب الحالة</small>
                </label>
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="grantInstallments" checked>
                <label class="form-check-label" for="grantInstallments">
                    <strong>تقسيط ميسر</strong>
                    <small class="d-block">أقساط مريحة</small>
                </label>
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="grantDeferred">
                <label class="form-check-label" for="grantDeferred">
                    <strong>تأجيل السداد</strong>
                    <small class="d-block">البدء لاحقاً</small>
                </label>
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="grantService">
                <label class="form-check-label" for="grantService">
                    <strong>خدمات مقابل المنحة</strong>
                    <small class="d-block">تبادل منفعة</small>
                </label>
            </div>
        </div>
        
        <h5>معايير التقييم:</h5>
        <div class="criteria-list mb-3">
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="criteriaFinancial" checked>
                <label class="form-check-label" for="criteriaFinancial">الحاجة المالية</label>
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="criteriaMotivation" checked>
                <label class="form-check-label" for="criteriaMotivation">الدافع والالتزام</label>
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="criteriaImpact">
                <label class="form-check-label" for="criteriaImpact">الأثر المتوقع</label>
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="criteriaHistory">
                <label class="form-check-label" for="criteriaHistory">التاريخ مع المنظور</label>
            </div>
        </div>
        
        <div class="mb-3">
            <label class="form-label">رابط استمارة التقديم (اختياري)</label>
            <input type="url" class="form-control" id="grantFormUrl" 
                   placeholder="https://forms.google.com/...">
        </div>
        
        <!-- خطط المنح -->
        <hr class="my-4">
        <h5>خطط المنح المخصصة:</h5>
        <div id="grantPlansList" class="mb-3"></div>
        
        <button class="btn btn-outline-primary" onclick="addGrantPlan()">
            <i class="fas fa-plus"></i> إضافة خطة منحة
        </button>
    </div>
</div>

    <!-- طرق الدفع -->
    <div class="form-section">
        <h2 class="section-title">
            <i class="fas fa-credit-card"></i>
            طرق الدفع المتاحة
        </h2>
        
        <!-- Vodafone Cash -->
        <div class="payment-method-card">
            <div class="payment-method-header">
                <div class="payment-method-title">
                    <div class="payment-method-icon">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <span>فودافون كاش</span>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="vodafoneEnabled" 
                           checked onchange="togglePaymentMethod('vodafone')">
                </div>
            </div>
            <div class="payment-method-content" id="vodafoneContent">
                <label class="form-label">رقم فودافون كاش</label>
                <input type="tel" class="form-control" id="vodafoneNumber" 
                       placeholder="01XXXXXXXXX" dir="ltr">
            </div>
        </div>

        <!-- InstaPay -->
        <div class="payment-method-card">
            <div class="payment-method-header">
                <div class="payment-method-title">
                    <div class="payment-method-icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <span>InstaPay</span>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="instapayEnabled" 
                           checked onchange="togglePaymentMethod('instapay')">
                </div>
            </div>
            <div class="payment-method-content" id="instapayContent">
                <label class="form-label">رقم InstaPay</label>
                <input type="tel" class="form-control" id="instapayNumber" 
                       placeholder="01XXXXXXXXX" dir="ltr">
            </div>
        </div>

        <!-- Bank Transfer -->
        <div class="payment-method-card">
            <div class="payment-method-header">
                <div class="payment-method-title">
                    <div class="payment-method-icon">
                        <i class="fas fa-university"></i>
                    </div>
                    <span>تحويل بنكي</span>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="bankEnabled" 
                           onchange="togglePaymentMethod('bank')">
                </div>
            </div>
            <div class="payment-method-content" id="bankContent" style="display: none;">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">اسم البنك</label>
                        <input type="text" class="form-control" id="bankName" 
                               placeholder="مثال: البنك الأهلي المصري">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">رقم الحساب</label>
                        <input type="text" class="form-control" id="bankAccountNumber" 
                               placeholder="رقم الحساب البنكي" dir="ltr">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">اسم صاحب الحساب</label>
                    <input type="text" class="form-control" id="bankAccountName" 
                           placeholder="الاسم كما يظهر في البنك">
                </div>
            </div>
        </div>
    </div>

    <!-- معاينة الأسعار -->
    <div class="form-section">
        <h2 class="section-title">
            <i class="fas fa-table"></i>
            جدول الأسعار الشامل
        </h2>
        <div id="pricePreview" class="price-preview-container">
            <div class="text-center text-muted py-4">
                <i class="fas fa-info-circle"></i>
                <p>أدخل سعر الدورة لمعاينة جدول الأسعار</p>
            </div>
        </div>
    </div>

    <div class="step-navigation">
        <button class="btn btn-secondary" onclick="showStep(1)">
            <i class="fas fa-arrow-right"></i> السابق
        </button>
        <button class="btn btn-primary" onclick="showStep(3)">
            التالي <i class="fas fa-arrow-left"></i>
        </button>
    </div>
</div>
                    <!-- Step 3: Curriculum Builder -->
                    <div class="step-content" id="step3">
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-book"></i>
                                بناء منهج الدورة
                            </h2>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                قم بتنظيم محتوى الدورة في وحدات ودروس. يمكنك سحب وإعادة ترتيب العناصر.
                            </div>

                            <div class="module-stats">
                                <div class="stat-item">
                                    <div class="stat-value" id="totalModules">0</div>
                                    <div class="stat-label">وحدة</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="totalLessons">0</div>
                                    <div class="stat-label">درس</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="totalDuration">0</div>
                                    <div class="stat-label">دقيقة</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div id="modulesContainer" class="modules-container"></div>
                            
                            <button class="btn btn-primary" onclick="addModule()">
                                <i class="fas fa-plus"></i> إضافة وحدة جديدة
                            </button>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-cog"></i>
                                إعدادات المنهج
                            </h2>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">هيكل الدورة</label>
                                    <select class="form-select" id="courseStructure">
                                        <option value="linear">خطي (يجب إكمال الدروس بالترتيب)</option>
                                        <option value="flexible">مرن (يمكن الوصول لأي درس)</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">نوع التعلم</label>
                                    <select class="form-select" id="learningType">
                                        <option value="self-paced">ذاتي السرعة</option>
                                        <option value="scheduled">مجدول</option>
                                        <option value="cohort">مجموعات</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="dripContent">
                                        <label class="form-check-label" for="dripContent">
                                            المحتوى التدريجي
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enableQuizzes" checked>
                                        <label class="form-check-label" for="enableQuizzes">
                                            تفعيل الاختبارات
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enableAssignments">
                                        <label class="form-check-label" for="enableAssignments">
                                            تفعيل الواجبات
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="row" id="dripSettings" style="display: none;">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">نوع التدريج</label>
                                    <select class="form-select" id="dripType">
                                        <option value="daily">يومي</option>
                                        <option value="weekly">أسبوعي</option>
                                        <option value="custom">مخصص</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">الحد الأدنى للإكمال (%)</label>
                                    <input type="number" class="form-control" id="minCompletion" 
                                           value="80" min="0" max="100">
                                </div>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <button class="btn btn-secondary" onclick="showStep(2)">
                                <i class="fas fa-arrow-right"></i> السابق
                            </button>
                            <button class="btn btn-primary" onclick="showStep(4)">
                                التالي <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 4: Advanced Settings -->
                    <div class="step-content" id="step4">
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-users"></i>
                                إعدادات التسجيل والوصول
                            </h2>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">نوع التسجيل</label>
                                    <select class="form-select" id="enrollmentType">
                                        <option value="open">مفتوح للجميع</option>
                                        <option value="approval">يتطلب موافقة</option>
                                        <option value="application">يتطلب تقديم طلب</option>
                                        <option value="closed">مغلق</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">الحد الأقصى للطلاب</label>
                                    <input type="number" class="form-control" id="maxStudents" 
                                           placeholder="غير محدود" min="1">
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">مدة الوصول</label>
                                    <select class="form-select" id="accessDuration">
                                        <option value="lifetime">مدى الحياة</option>
                                        <option value="1year">سنة واحدة</option>
                                        <option value="6months">6 أشهر</option>
                                        <option value="3months">3 أشهر</option>
                                        <option value="custom">مخصص</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">تاريخ بدء التسجيل</label>
                                    <input type="datetime-local" class="form-control" id="enrollmentStartDate">
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">تاريخ انتهاء التسجيل</label>
                                    <input type="datetime-local" class="form-control" id="enrollmentEndDate">
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableWaitlist">
                                    <label class="form-check-label" for="enableWaitlist">
                                        تفعيل قائمة الانتظار عند امتلاء الدورة
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-comments"></i>
                                التواصل والدعم
                            </h2>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">رقم واتساب للتواصل</label>
                                    <input type="tel" class="form-control" id="whatsappNumber" 
                                           placeholder="201XXXXXXXXX" dir="ltr">
                                    <div class="form-text">سيتم استخدامه للتواصل مع الطلاب</div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">رابط مجموعة واتساب</label>
                                    <input type="url" class="form-control" id="whatsappGroupLink" 
                                           placeholder="https://chat.whatsapp.com/..." dir="ltr">
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="autoWelcomeMessage" checked>
                                    <label class="form-check-label" for="autoWelcomeMessage">
                                        إرسال رسالة ترحيب تلقائية عبر واتساب
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3" id="welcomeMessageField">
                                <label class="form-label">رسالة الترحيب</label>
                                <textarea class="form-control" id="welcomeMessage" rows="4" 
                                          placeholder="مرحباً {الاسم}، نرحب بك في دورة {اسم الدورة}..."></textarea>
                                <div class="form-text">استخدم {الاسم} و {اسم الدورة} كمتغيرات</div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enableComments" checked>
                                        <label class="form-check-label" for="enableComments">
                                            تفعيل التعليقات
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enableForum">
                                        <label class="form-check-label" for="enableForum">
                                            تفعيل المنتدى
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enableLiveSupport">
                                        <label class="form-check-label" for="enableLiveSupport">
                                            دعم مباشر
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="row" id="supportSettings" style="display: none;">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">ساعات الدعم</label>
                                    <select class="form-select" id="supportHours">
                                        <option value="business">ساعات العمل (9 ص - 5 م)</option>
                                        <option value="extended">ممتدة (9 ص - 9 م)</option>
                                        <option value="24/7">24/7</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-certificate"></i>
                                الشهادات والإنجازات
                            </h2>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="certificate" checked>
                                    <label class="form-check-label" for="certificate">
                                        منح شهادة إتمام
                                    </label>
                                </div>
                            </div>

                            <div id="certificateSettings">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">نسبة الإنجاز المطلوبة (%)</label>
                                        <input type="number" class="form-control" id="certificateThreshold" 
                                               value="80" min="0" max="100">
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">نص الشهادة المخصص</label>
                                        <input type="text" class="form-control" id="certificateText" 
                                               placeholder="يشهد بأن {الاسم} قد أتم بنجاح...">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="requireQuizzes">
                                            <label class="form-check-label" for="requireQuizzes">
                                                اجتياز الاختبارات
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="requireAssignments">
                                            <label class="form-check-label" for="requireAssignments">
                                                تسليم الواجبات
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="requireParticipation">
                                            <label class="form-check-label" for="requireParticipation">
                                                المشاركة النشطة
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="requireFinalProject">
                                            <label class="form-check-label" for="requireFinalProject">
                                                مشروع نهائي
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showCompletionBadges" checked>
                                        <label class="form-check-label" for="showCompletionBadges">
                                            عرض شارات الإنجاز
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="sendProgressEmails">
                                        <label class="form-check-label" for="sendProgressEmails">
                                            إرسال رسائل التقدم بالبريد
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-chart-line"></i>
                                تتبع التقدم والإحصائيات
                            </h2>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">طريقة حساب التقدم</label>
                                    <select class="form-select" id="progressMethod">
                                        <option value="lessons">بناءً على الدروس المكتملة</option>
                                        <option value="time">بناءً على وقت المشاهدة</option>
                                        <option value="mixed">مختلط</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">المدة المتوقعة للإكمال</label>
                                    <select class="form-select" id="expectedCompletion">
                                        <option value="1week">أسبوع واحد</option>
                                        <option value="2weeks">أسبوعان</option>
                                        <option value="1month">شهر واحد</option>
                                        <option value="2months">شهران</option>
                                        <option value="3months">3 أشهر</option>
                                        <option value="custom">مخصص</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showProgressBar" checked>
                                        <label class="form-check-label" for="showProgressBar">
                                            عرض شريط التقدم
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-3 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showModuleProgress" checked>
                                        <label class="form-check-label" for="showModuleProgress">
                                            تقدم الوحدات
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-3 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showLearningStats">
                                        <label class="form-check-label" for="showLearningStats">
                                            إحصائيات التعلم
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-3 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showAchievementBadges">
                                        <label class="form-check-label" for="showAchievementBadges">
                                            شارات الإنجاز
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-search"></i>
                                SEO والتسويق
                            </h2>
                            
                            <div class="mb-3">
                                <label class="form-label">عنوان SEO</label>
                                <input type="text" class="form-control" id="seoTitle" 
                                       placeholder="يُنشأ تلقائياً من عنوان الدورة" maxlength="60">
                                <div class="form-text">الحد الأقصى 60 حرف</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">وصف SEO</label>
                                <textarea class="form-control" id="seoDescription" rows="3" 
                                          placeholder="وصف مختصر يظهر في نتائج البحث" maxlength="160"></textarea>
                                <div class="form-text">الحد الأقصى 160 حرف</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">وصف وسائل التواصل الاجتماعي</label>
                                <textarea class="form-control" id="socialDescription" rows="2" 
                                          placeholder="النص الذي يظهر عند مشاركة الدورة"></textarea>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="allowSharing" checked>
                                    <label class="form-check-label" for="allowSharing">
                                        السماح بمشاركة الدورة على وسائل التواصل
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-eye"></i>
                                إعدادات النشر والخصوصية
                            </h2>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">حالة الدورة</label>
                                    <select class="form-select" id="status">
                                        <option value="draft">مسودة</option>
                                        <option value="review">قيد المراجعة</option>
                                        <option value="published">منشورة</option>
                                        <option value="archived">مؤرشفة</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">مستوى الخصوصية</label>
                                    <select class="form-select" id="isPublic">
                                        <option value="true">عامة (متاحة للجميع)</option>
                                        <option value="false">خاصة (تحتاج رابط)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="privateLink">
                                        <label class="form-check-label" for="privateLink">
                                            إنشاء رابط خاص للدورة
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">النشر المجدول</label>
                                    <input type="datetime-local" class="form-control" id="scheduledPublish">
                                </div>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <button class="btn btn-secondary" onclick="showStep(3)">
                                <i class="fas fa-arrow-right"></i> السابق
                            </button>
                            <button class="btn btn-primary" onclick="showStep(5)">
                                التالي <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 5: Review and Publish -->
                    <div class="step-content" id="step5">
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-eye"></i>
                                مراجعة نهائية
                            </h2>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                راجع جميع المعلومات قبل نشر الدورة. يمكنك دائماً تعديلها لاحقاً.
                            </div>

                            <div class="review-section">
                                <h3>المعلومات الأساسية</h3>
                                <div class="review-content" id="reviewBasicInfo"></div>
                            </div>

                            <div class="review-section">
                                <h3>التسعير والدفع</h3>
                                <div class="review-content" id="reviewPricing"></div>
                            </div>

                            <div class="review-section">
                                <h3>المنهج</h3>
                                <div class="review-content" id="reviewCurriculum"></div>
                            </div>

                            <div class="review-section">
                                <h3>الإعدادات المتقدمة</h3>
                                <div class="review-content" id="reviewSettings"></div>
                            </div>
                        </div>

                        <div class="form-section text-center">
                            <h3>الدورة جاهزة للنشر!</h3>
                            <p>يمكنك نشر الدورة الآن أو حفظها كمسودة لتعديلها لاحقاً.</p>
                            
                            <div class="d-flex justify-content-center gap-3">
                                <button class="btn btn-secondary" onclick="saveDraft()">
                                    <i class="fas fa-save"></i> حفظ كمسودة
                                </button>
                                <button class="btn btn-success" onclick="publishCourse()">
                                    <i class="fas fa-rocket"></i> نشر الدورة
                                </button>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <button class="btn btn-secondary" onclick="showStep(4)">
                                <i class="fas fa-arrow-right"></i> السابق
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="../js/firebase-config.js"></script>
    
    <!-- External Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <script>
        // ========================================
        // GLOBAL VARIABLES
        // ========================================
let courseData = {
    id: null,
    title: 'دورة جديدة',
    slug: '',
    subtitle: '',
    description: '',
    detailedDescription: '',
    language: 'ar',
    targetAudience: 'all',
    applicationDomain: '',
    practiceDepth: '',
    courseLevel: 'foundational',
    introVideo: '',
    objectives: [],
    requirements: [],
    thumbnail: null,
    thumbnailUrl: null,
    socialImage: null,
    socialImageUrl: null,
    instructorName: '',
    instructorTitle: '',
    instructorBio: '',
    instructorImage: null,
    instructorImageUrl: '',
    instructorLinkedIn: '',
    instructorTwitter: '',
    instructorWebsite: '',
    category: '',
    level: 'beginner',
    keywords: [],
    priceType: 'free',
    price: 0,
    salePrice: null,
    currency: 'EGP',
    donationMin: null,
    donationMax: null,
    discounts: [],
    groupDiscounts: [],
    coupons: [],
    paymentPlans: [],
    grants: {
        enabled: false,
        seats: 5,
        totalSeats: 30,
        supportTypes: {
            discount: false,
            installments: false,
            deferred: false,
            service: false
        },
        criteria: {
            financial: false,
            motivation: false,
            impact: false,
            history: false
        },
        formUrl: null
    },
    paymentMethods: {
        instapay: { enabled: true, number: '' },
        vodafone: { enabled: true, number: '' },
        bank: { enabled: false, name: '', accountNumber: '', accountName: '' }
    },
    enrollmentType: 'open',
    maxStudents: null,
    accessDuration: 'lifetime',
    enrollmentStartDate: null,
    enrollmentEndDate: null,
    enableWaitlist: false,
    whatsappNumber: '',
    whatsappGroupLink: '',
    autoWelcomeMessage: true,
    welcomeMessage: '',
    modules: [],
    courseStructure: 'linear',
    learningType: 'self-paced',
    dripContent: false,
    dripType: 'weekly',
    enableQuizzes: true,
    enableAssignments: false,
    minCompletion: 80,
    enableComments: true,
    enableForum: false,
    enableLiveSupport: false,
    supportHours: 'business',
    certificate: true,
    certificateThreshold: 80,
    certificateText: '',
    certificateRequirements: {
        requireQuizzes: false,
        requireAssignments: false,
        requireParticipation: false,
        requireFinalProject: false
    },
    showCompletionBadges: true,
    sendProgressEmails: false,
    progressMethod: 'lessons',
    expectedCompletion: '1month',
    showProgressBar: true,
    showModuleProgress: true,
    showLearningStats: false,
    showAchievementBadges: false,
    seoTitle: '',
    seoDescription: '',
    socialDescription: '',
    allowSharing: true,
    status: 'draft',
    isPublic: true,
    privateLink: false,
    scheduledPublish: null,
    publishedAt: null,
    progress: 20,
    totalLessons: 0,
    totalDuration: 0,
    createdAt: null,
    updatedAt: null
};

        let currentStep = 1;
        let autoSaveTimeout = null;
        let isSaving = false;
        let isAddingItem = false;
        let isLoading = false;

        // ========================================
        // INITIALIZATION
        // ========================================
// الكود الموجود الأصلي - سيبه زي ما هو
// متغير للتأكد من عدم تكرار التحميل
let courseDataLoaded = false;

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded, initializing...');
    
    // Check authentication
    if (window.firebaseAuth && window.firebaseAuth.protectAdminPage) {
        window.firebaseAuth.protectAdminPage();
    }
    
    // Initialize components
    initializeEventListeners();
    initializeKeywordInput();
    
    // Update currency label
    const currencyElement = document.getElementById('currency');
    if (currencyElement) {
        currencyElement.addEventListener('change', updateCurrencyLabel);
        updateCurrencyLabel();
    }
    
    // تحميل بيانات الدورة بعد تأخير بسيط
    setTimeout(function() {
        if (!courseDataLoaded) {
            courseDataLoaded = true;
            loadCourseData();
        }
    }, 1000); // ثانية واحدة للتأكد من تحميل كل شيء
    
    // تحميل SweetAlert2 إذا لم يكن محملاً
    if (typeof Swal === 'undefined') {
        console.error('SweetAlert2 لم يتم تحميله بشكل صحيح');
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11';
        script.onload = function() {
            console.log('تم تحميل SweetAlert2 بنجاح');
        };
        document.head.appendChild(script);
    }
});


        // ========================================
        // STEP NAVIGATION
        // ========================================
        function showStep(step) {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected step
            document.getElementById(`step${step}`).classList.add('active');
            
            // Update step indicators
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                indicator.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    indicator.classList.add('completed');
                } else if (index + 1 === step) {
                    indicator.classList.add('active');
                }
            });
            
            // Update progress bar
            const progress = (step / 5) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
            currentStep = step;
            
            // Save progress
            courseData.progress = progress;
           // حفظ تلقائي ذكي - فقط لو في ID موجود (مش دورة جديدة)
if (courseData.id) {
    autoSave();
}
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ========================================
        // COURSE TITLE & SLUG
        // ========================================
function updateCourseTitle(title) {
    courseData.title = title;
    document.getElementById('courseTitleHeader').textContent = title || 'دورة جديدة';
    
    // مجرد عرض اقتراح في placeholder بس
    if (title && title !== 'دورة جديدة') {
        const suggestedSlug = generateSlug(title);
        const slugInput = document.getElementById('courseSlug');
        
        // عرض الاقتراح في placeholder فقط
        slugInput.placeholder = suggestedSlug;
        document.getElementById('slugPreview').textContent = suggestedSlug;
        
        // لا تغير القيمة أبداً
        // slugInput.value يبقى زي ما هو
    }
}
// دالة محسنة لتوليد الـ Slug
function generateSlug(text) {
    // قاموس تحويل الكلمات العربية الشائعة
    const arabicToEnglish = {
        'دورة': 'course',
        'تعلم': 'learn',
        'احتراف': 'professional',
        'أساسيات': 'basics',
        'متقدم': 'advanced',
        'مقدمة': 'introduction',
        'شرح': 'explanation',
        'كورس': 'course',
        'للمبتدئين': 'for-beginners',
        'من الصفر': 'from-zero',
        'كامل': 'complete',
        'في': 'in',
        'مع': 'with',
        'و': 'and',
        'او': 'or',
        'إلى': 'to',
        'على': 'on'
    };
    
    let slug = text.toLowerCase().trim();
    
    // استبدل الكلمات العربية الشائعة
    Object.keys(arabicToEnglish).forEach(arabic => {
        const regex = new RegExp(arabic, 'g');
        slug = slug.replace(regex, arabicToEnglish[arabic]);
    });
    
    // حول الحروف العربية المتبقية
    const arabicLetters = {
        'ا': 'a', 'أ': 'a', 'إ': 'i', 'آ': 'aa',
        'ب': 'b', 'ت': 't', 'ث': 'th', 'ج': 'g',
        'ح': 'h', 'خ': 'kh', 'د': 'd', 'ذ': 'dh',
        'ر': 'r', 'ز': 'z', 'س': 's', 'ش': 'sh',
        'ص': 's', 'ض': 'd', 'ط': 't', 'ظ': 'z',
        'ع': 'a', 'غ': 'gh', 'ف': 'f', 'ق': 'q',
        'ك': 'k', 'ل': 'l', 'م': 'm', 'ن': 'n',
        'ه': 'h', 'و': 'w', 'ي': 'y', 'ة': 'h',
        'ى': 'a', 'ئ': 'e', 'ء': 'a', 'ؤ': 'o'
    };
    
    Object.keys(arabicLetters).forEach(arabic => {
        const regex = new RegExp(arabic, 'g');
        slug = slug.replace(regex, arabicLetters[arabic]);
    });
    
    // تنظيف نهائي
    return slug
        .replace(/[^\w\s-]/g, '') // احذف الرموز الخاصة
        .replace(/[\s_-]+/g, '-') // استبدل المسافات بـ -
        .replace(/^-+|-+$/g, ''); // احذف - من البداية والنهاية
}

        // ========================================
        // OBJECTIVES & REQUIREMENTS
        // ========================================
        function addObjective() {
            const input = document.getElementById('objectiveInput');
            const value = input.value.trim();
            
            if (value) {
                courseData.objectives.push(value);
                renderObjectives();
                input.value = '';
                autoSave();
            }
        }

        function removeObjective(index) {
            courseData.objectives.splice(index, 1);
            renderObjectives();
            autoSave();
        }

        function renderObjectives() {
            const container = document.getElementById('objectivesList');
            container.innerHTML = courseData.objectives.map((obj, index) => `
                <div class="list-group-item">
                    <span>${obj}</span>
                    <button class="btn btn-sm btn-danger" onclick="removeObjective(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function addRequirement() {
            const input = document.getElementById('requirementInput');
            const value = input.value.trim();
            
            if (value) {
                courseData.requirements.push(value);
                renderRequirements();
                input.value = '';
                autoSave();
            }
        }

        function removeRequirement(index) {
            courseData.requirements.splice(index, 1);
            renderRequirements();
            autoSave();
        }

        function renderRequirements() {
            const container = document.getElementById('requirementsList');
            container.innerHTML = courseData.requirements.map((req, index) => `
                <div class="list-group-item">
                    <span>${req}</span>
                    <button class="btn btn-sm btn-danger" onclick="removeRequirement(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        // دالة حفظ الـ Slug في Firebase
// دالة حفظ الـ Slug في Firebase
async function saveCourseSlug() {
    const titleInput = document.getElementById('courseTitle');
    const slugInput = document.getElementById('courseSlug');
    const saveBtn = document.getElementById('saveSlugBtn');
    
    // التأكد من وجود عنوان
    if (!titleInput.value.trim() || titleInput.value.trim() === 'دورة جديدة') {
        Swal.fire({
            icon: 'error',
            title: 'خطأ',
            text: 'من فضلك اكتب عنوان صحيح للدورة أولاً'
        });
        return;
    }
    
    // تحديث البيانات
    courseData.title = titleInput.value.trim();
    
    // تحديد الـ slug - المهم هنا
    let finalSlug = '';
    
    // إذا المستخدم كتب slug مخصص
    if (slugInput.value && slugInput.value.trim()) {
        finalSlug = slugInput.value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '');
    } 
    // إذا الحقل فاضي، ولّد من العنوان
    else {
        finalSlug = generateSlug(courseData.title);
    }
    
    // حفظ الـ slug النهائي
    courseData.slug = finalSlug;
    slugInput.value = finalSlug;
    document.getElementById('slugPreview').textContent = finalSlug;
    
    // عرض مؤشر التحميل
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
    
    try {
        // إذا كانت دورة جديدة - أنشئ ID الآن فقط
        if (!courseData.id) {
            // جمع البيانات
            collectFormData();
            
            // تجهيز البيانات للحفظ
            const dataToSave = {
                ...courseData,
                slug: finalSlug, // استخدم الـ slug النهائي
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // حذف القيم الغير معرفة
            Object.keys(dataToSave).forEach(key => {
                if (dataToSave[key] === undefined) {
                    delete dataToSave[key];
                }
            });
            
            // إنشاء دورة جديدة - الـ ID سيكون نفس الـ slug في أول مرة
            const newId = await window.firebaseDB.courses.createCourse(dataToSave);
            courseData.id = newId;
            
            // تحديث URL
            const newUrl = `${window.location.pathname}?id=${newId}`;
            window.history.replaceState({}, '', newUrl);
            
            console.log('تم إنشاء دورة جديدة:', newId);
            console.log('Slug:', finalSlug);
            
            saveBtn.innerHTML = '<i class="fas fa-check"></i> تم إنشاء الدورة';
            
        } else {
            // دورة موجودة - حدث البيانات فقط
            await saveCourseData();
            saveBtn.innerHTML = '<i class="fas fa-check"></i> تم التحديث';
        }
        
        // نجاح
        saveBtn.classList.remove('btn-primary');
        saveBtn.classList.add('btn-success');
        saveBtn.disabled = false;
        
        // رسالة نجاح
        Swal.fire({
            icon: 'success',
            title: courseData.id ? 'تم الحفظ بنجاح' : 'تم إنشاء الدورة',
            html: `
                <div style="text-align: right;">
                    <p><strong>العنوان:</strong> ${courseData.title}</p>
                    <p><strong>ID:</strong> ${courseData.id}</p>
                    <p><strong>الرابط (Slug):</strong> ${courseData.slug}</p>
                    <p style="color: #666; font-size: 0.9em; margin-top: 10px;">
                        يمكنك تغيير الرابط (Slug) في أي وقت
                    </p>
                </div>
            `,
            timer: 5000,
            showConfirmButton: true
        });
        
        // إرجاع الزر لحالته الطبيعية بعد 3 ثواني
        setTimeout(() => {
            saveBtn.classList.remove('btn-success');
            saveBtn.classList.add('btn-primary');
            saveBtn.innerHTML = '<i class="fas fa-link"></i> تثبيت الرابط';
            
            // تغيير نص الزر للدورات الموجودة
            if (courseData.id) {
                saveBtn.innerHTML = '<i class="fas fa-sync"></i> تحديث الرابط';
            }
        }, 3000);
        
    } catch (error) {
        console.error('Error saving:', error);
        saveBtn.classList.remove('btn-success');
        saveBtn.classList.add('btn-danger');
        saveBtn.innerHTML = '<i class="fas fa-times"></i> فشل الحفظ';
        saveBtn.disabled = false;
        
        Swal.fire({
            icon: 'error',
            title: 'خطأ',
            text: 'حدث خطأ أثناء الحفظ: ' + error.message
        });
    }
}
        // ========================================
        // IMAGE HANDLING
        // ========================================
function handleImageUpload(input, type) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        if (type === 'thumbnail') {
            displayCourseImage(e.target.result);
        } else if (type === 'instructor') {
            displayInstructorImage(e.target.result);
        } else if (type === 'social') {
            displaySocialImage(e.target.result);
        }
        
        // إرشادات الرفع على GitHub
        const folderName = type === 'thumbnail' ? 'courses' : 
                          type === 'instructor' ? 'instructors' : 'social';
        
        Swal.fire({
            title: 'حفظ الصورة',
            html: `
                <div style="text-align: right;">
                    <p>لحفظ الصورة، ارفعها على GitHub في:</p>
                    <code style="background: #f0f0f0; padding: 0.5rem; display: block; direction: ltr;">
                        media/${folderName}/${file.name}
                    </code>
                    <p style="color: #666;">ثم اضغط تم بعد رفعها</p>
                </div>
            `,
            confirmButtonText: 'تم الرفع',
            showCancelButton: true
        }).then((result) => {
            if (result.isConfirmed) {
                const baseUrl = 'https://mahmoudfouad25.github.io/fouad-perspective/media/';
                const imageUrl = baseUrl + folderName + '/' + file.name;
                
                if (type === 'thumbnail') {
                    courseData.thumbnailUrl = imageUrl;
                } else if (type === 'instructor') {
                    courseData.instructorImageUrl = imageUrl;
                } else if (type === 'social') {
                    courseData.socialImageUrl = imageUrl;
                }
                
                autoSave();
            }
        });
    };
    reader.readAsDataURL(file);
}

        function displayCourseImage(url) {
    const uploadDiv = document.getElementById('thumbnailPreview');
    const img = document.getElementById('thumbnailImage');
    if (uploadDiv && img) {
        uploadDiv.style.display = 'block';
        img.src = url;
    }
}

function displayInstructorImage(url) {
    const uploadDiv = document.getElementById('instructorImagePreview');
    const img = document.getElementById('instructorImage');
    if (uploadDiv && img) {
        uploadDiv.style.display = 'block';
        img.src = url;
    }
}

function displaySocialImage(url) {
    const uploadDiv = document.getElementById('socialImagePreview');
    const img = document.getElementById('socialImage');
    if (uploadDiv && img) {
        uploadDiv.style.display = 'block';
        img.src = url;
    }
}


        function displayImage(type, src) {
            const preview = document.getElementById(`${type}Preview`);
            const image = document.getElementById(`${type}Image`);
            
            preview.style.display = 'block';
            image.src = src;
        }

        function removeImage(type) {
            const preview = document.getElementById(`${type}Preview`);
            const input = document.getElementById(`${type}Input`);
            
            preview.style.display = 'none';
            input.value = '';
            
            if (type === 'thumbnail') {
                courseData.thumbnail = null;
                courseData.thumbnailUrl = null;
            } else if (type === 'social') {
                courseData.socialImage = null;
                courseData.socialImageUrl = null;
            } else if (type === 'instructor') {
                courseData.instructorImage = null;
            }
            
            autoSave();
        }

        // ========================================
        // KEYWORDS
        // ========================================
        function initializeKeywordInput() {
            const input = document.getElementById('keywordInput');
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addKeyword();
                }
            });
        }

        function addKeyword() {
            const input = document.getElementById('keywordInput');
            const value = input.value.trim();
            
            if (value && !courseData.keywords.includes(value)) {
                courseData.keywords.push(value);
                renderKeywords();
                input.value = '';
                autoSave();
            }
        }

        function removeKeyword(index) {
            courseData.keywords.splice(index, 1);
            renderKeywords();
            autoSave();
        }

        function renderKeywords() {
            const container = document.getElementById('keywordsTags');
            container.innerHTML = courseData.keywords.map((keyword, index) => `
                <span class="tag">
                    ${keyword}
                    <span class="remove-tag" onclick="removeKeyword(${index})">×</span>
                </span>
            `).join('');
        }

        

        // ========================================
        // CURRICULUM BUILDER
        // ========================================
        function addModule() {
            const module = {
                id: 'module_' + Date.now(),
                title: `الوحدة ${courseData.modules.length + 1}`,
                description: '',
                lessons: [],
                isExpanded: true
            };
            
            courseData.modules.push(module);
            renderModules();
            updateCurriculumStats();
            autoSave();
        }

        function renderModules() {
            const container = document.getElementById('modulesContainer');
            container.innerHTML = courseData.modules.map((module, index) => `
                <div class="module-card" data-module-id="${module.id}">
                    <div class="module-header">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-grip-vertical drag-handle"></i>
                            <input type="text" class="form-control ms-2" value="${module.title}"
                                   onchange="updateModuleTitle('${module.id}', this.value)"
                                   style="background: transparent; border: none; font-weight: 600;">
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleModule('${module.id}')">
                                <i class="fas fa-chevron-${module.isExpanded ? 'up' : 'down'}"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteModule(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="module-content" style="display: ${module.isExpanded ? 'block' : 'none'}">
                        <div class="mb-3">
                            <textarea class="form-control" placeholder="وصف الوحدة (اختياري)"
                                      onchange="updateModuleDescription('${module.id}', this.value)">${module.description}</textarea>
                        </div>
                        <div class="lessons-container" id="lessons-${module.id}">
                            ${renderLessons(module.lessons, module.id)}
                        </div>
                        <button class="btn btn-outline-primary btn-sm" onclick="showContentTypes('${module.id}')">
                            <i class="fas fa-plus"></i> إضافة محتوى
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Initialize sortable
            initializeSortable();
        }

        function renderLessons(lessons, moduleId) {
            return lessons.map((lesson, index) => `
                <div class="lesson-item" data-lesson-id="${lesson.id}">
                    <div class="lesson-info">
                        <i class="fas fa-grip-vertical drag-handle"></i>
                        <div class="lesson-type-icon">
                            <i class="fas fa-${getLessonIcon(lesson.type)}"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">${lesson.title}</div>
                            <small class="text-muted">${lesson.duration} دقيقة</small>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="editLesson('${moduleId}', '${lesson.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteLesson('${moduleId}', '${lesson.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-sm ${lesson.isFreePreview ? 'btn-success' : 'btn-outline-success'}" 
        onclick="toggleFreePreview('${moduleId}', '${lesson.id}')"
        title="${lesson.isFreePreview ? 'إلغاء المعاينة المجانية' : 'إتاحة كمعاينة مجانية'}">
    <i class="fas ${lesson.isFreePreview ? 'fa-eye' : 'fa-eye-slash'}"></i>
</button>
                    </div>
                </div>
            `).join('');
        }
        function toggleFreePreview(moduleId, lessonId) {
    const module = courseData.modules.find(m => m.id === moduleId);
    const lesson = module.lessons.find(l => l.id === lessonId);
    
    lesson.isFreePreview = !lesson.isFreePreview;
    
    renderModules();
    autoSave();
    
    Swal.fire({
        icon: 'success',
        title: lesson.isFreePreview ? 'تم التفعيل' : 'تم الإلغاء',
        text: lesson.isFreePreview ? 
            'تم إتاحة هذا الدرس كمعاينة مجانية' : 
            'تم إلغاء المعاينة المجانية لهذا الدرس',
        timer: 2000,
        showConfirmButton: false
    });
}

        function getLessonIcon(type) {
            const icons = {
                video: 'play-circle',
                text: 'file-alt',
                quiz: 'question-circle',
                assignment: 'tasks',
                live: 'broadcast-tower',
                download: 'download'
            };
            return icons[type] || 'file';
        }

function showContentTypes(moduleId) {
    Swal.fire({
        title: 'اختر نوع المحتوى',
        html: `
            <div class="content-types-grid">
                <button class="content-type-btn" onclick="openContentLibrary('${moduleId}')">
                    <i class="fas fa-book"></i>
                    <span>📚 محتوى من المكتبة</span>
                </button>
                <button class="content-type-btn" onclick="addLesson('${moduleId}', 'text')">
                    <i class="fas fa-file-alt"></i>
                    <span>📝 نص مباشر</span>
                </button>
                <button class="content-type-btn" onclick="addLesson('${moduleId}', 'file')">
                    <i class="fas fa-download"></i>
                    <span>📎 ملف للتحميل</span>
                </button>
            </div>
        `,
        showConfirmButton: false,
        customClass: {
            popup: 'content-types-popup'
        }
    });
}

        function addLesson(moduleId, type) {
            Swal.close();
            
            const module = courseData.modules.find(m => m.id === moduleId);
            if (!module) return;
            
            Swal.fire({
                title: 'إضافة درس جديد',
                html: `
                    <div class="form-group mb-3">
                        <label class="form-label">عنوان الدرس</label>
                        <input type="text" id="lessonTitle" class="form-control" placeholder="أدخل عنوان الدرس">
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">المدة (بالدقائق)</label>
                        <input type="number" id="lessonDuration" class="form-control" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">الوصف (اختياري)</label>
                        <textarea id="lessonDescription" class="form-control" rows="3" placeholder="وصف مختصر للدرس"></textarea>
                    </div>
                `,
                confirmButtonText: 'إضافة',
                showCancelButton: true,
                cancelButtonText: 'إلغاء',
                preConfirm: () => {
                    const title = document.getElementById('lessonTitle').value;
                    const duration = parseInt(document.getElementById('lessonDuration').value) || 0;
                    const description = document.getElementById('lessonDescription').value;
                    
                    if (!title) {
                        Swal.showValidationMessage('يرجى إدخال عنوان الدرس');
                        return false;
                    }
                    
                    return { title, duration, description };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const lesson = {
                        id: 'lesson_' + Date.now(),
                        type: type,
                        title: result.value.title,
                        duration: result.value.duration,
                        description: result.value.description,
                        content: '',
                        isCompleted: false
                    };
                    
                    module.lessons.push(lesson);
                    renderModules();
                    updateCurriculumStats();
                    autoSave();
                }
            });
        }

       async function editLesson(moduleId, lessonId) {
    const module = courseData.modules.find(m => m.id === moduleId);
    const lesson = module.lessons.find(l => l.id === lessonId);
    
    if (!lesson) return;
    
    // لو ده محتوى من المكتبة، نجيب تفاصيله
    let libraryContent = null;
    if (lesson.type === 'library-content' && lesson.libraryContentId) {
        try {
            const contentDoc = await db.collection('courseContentLibrary').doc(lesson.libraryContentId).get();
            if (contentDoc.exists) {
                libraryContent = contentDoc.data();
            }
        } catch (error) {
            console.error('خطأ في جلب محتوى المكتبة:', error);
        }
    }
    
    // بناء HTML للتعديل حسب نوع المحتوى
    let editFormHtml = `
        <div class="form-group mb-3">
            <label class="form-label">عنوان الدرس</label>
            <input type="text" id="lessonTitle" class="form-control" value="${lesson.title}">
        </div>
        <div class="form-group mb-3">
            <label class="form-label">المدة (بالدقائق)</label>
            <input type="number" id="lessonDuration" class="form-control" value="${lesson.duration}" min="0">
        </div>
        <div class="form-group">
            <label class="form-label">الوصف</label>
            <textarea id="lessonDescription" class="form-control" rows="3">${lesson.description || ''}</textarea>
        </div>
    `;
    
    // إضافة تفاصيل المحتوى من المكتبة
    if (libraryContent) {
        editFormHtml += `
            <hr class="my-4">
            <h5 class="text-primary mb-3">📚 محتوى من المكتبة</h5>
            <div class="alert alert-info">
                <strong>النوع:</strong> ${lesson.libraryContentType}<br>
                <strong>المحتوى الأصلي:</strong> ${libraryContent.name || 'غير محدد'}
            </div>
        `;
        
        // أضف هنا - عرض كل التفاصيل للتعديل
        editFormHtml += `
            <div class="form-group mb-3">
                <label class="form-label">تعديل المحتوى الأصلي</label>
            </div>
        `;
        
        // عرض حقول التعديل حسب النوع
        if (lesson.libraryContentType === 'educational-video' && libraryContent.videoData) {
            editFormHtml += `
                <div class="form-group mb-3">
                    <label class="form-label">رابط الفيديو</label>
                    <input type="url" id="editVideoUrl" class="form-control" value="${libraryContent.videoData.url || ''}" dir="ltr">
                </div>
                <div class="form-group mb-3">
                    <label class="form-label">ملاحظات</label>
                    <textarea id="editVideoNotes" class="form-control" rows="3">${libraryContent.videoData.notes || ''}</textarea>
                </div>
            `;
        } else if (lesson.libraryContentType === 'quiz' && libraryContent.quizData) {
            editFormHtml += `
                <div class="card bg-light p-3 mb-3">
                    <h6>❓ تفاصيل الاختبار:</h6>
                    <p><strong>عدد الأسئلة:</strong> ${libraryContent.quizData.questions?.length || 0}</p>
                    <p><strong>درجة النجاح:</strong> ${libraryContent.quizData.passingGrade || 70}%</p>
                </div>
            `;
        }
        
        editFormHtml += `
            <div class="alert alert-warning">
                <i class="fas fa-info-circle"></i> لتعديل المحتوى الأساسي، اذهب إلى 
                <a href="course-content-library.html" target="_blank">مكتبة المحتوى</a>
            </div>
        `;
    }
    
    // عرض النافذة
    Swal.fire({
        title: 'تعديل الدرس',
        html: editFormHtml,
        confirmButtonText: 'حفظ التغييرات',
        showCancelButton: true,
        cancelButtonText: 'إلغاء',
        width: '600px',
        preConfirm: async () => {
            const title = document.getElementById('lessonTitle').value;
            const duration = parseInt(document.getElementById('lessonDuration').value) || 0;
            const description = document.getElementById('lessonDescription').value;
            
            if (!title) {
                Swal.showValidationMessage('يرجى إدخال عنوان الدرس');
                return false;
            }
            
            // حفظ التعديلات على المحتوى الأصلي
            if (lesson.libraryContentId && document.getElementById('editVideoUrl')) {
                const updates = {
                    'videoData.url': document.getElementById('editVideoUrl').value,
                    'videoData.notes': document.getElementById('editVideoNotes').value
                };
                
                await db.collection('courseContentLibrary').doc(lesson.libraryContentId).update(updates);
            }
            
            return { title, duration, description };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            lesson.title = result.value.title;
            lesson.duration = result.value.duration;
            lesson.description = result.value.description;
            
            renderModules();
            updateCurriculumStats();
            autoSave();
            
            Swal.fire({
                icon: 'success',
                title: 'تم التحديث',
                text: 'تم حفظ التغييرات بنجاح',
                timer: 2000,
                showConfirmButton: false
            });
        }
    });
}

        async function deleteLesson(moduleId, lessonId) {
    const module = courseData.modules.find(m => m.id === moduleId);
    const lesson = module.lessons.find(l => l.id === lessonId);
    
    Swal.fire({
        title: 'حذف الدرس؟',
        text: 'لا يمكن التراجع عن هذا الإجراء',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'نعم، احذف',
        cancelButtonText: 'إلغاء',
        confirmButtonColor: '#dc3545'
    }).then(async (result) => {
        if (result.isConfirmed) {
            // لو كان محتوى من المكتبة، نقلل عدد الاستخدامات
            if (lesson.type === 'library-content' && lesson.libraryContentId) {
                try {
                    await db.collection('courseContentLibrary').doc(lesson.libraryContentId).update({
                        timesUsed: firebase.firestore.FieldValue.increment(-1)
                    });
                    console.log('تم تحديث عدد استخدامات المحتوى');
                } catch (error) {
                    console.error('خطأ في تحديث الاستخدامات:', error);
                }
            }
            
            // حذف الدرس
            module.lessons = module.lessons.filter(l => l.id !== lessonId);
            
            renderModules();
            updateCurriculumStats();
            autoSave();
            
            Swal.fire({
                icon: 'success',
                title: 'تم الحذف',
                text: 'تم حذف الدرس بنجاح',
                timer: 2000,
                showConfirmButton: false
            });
        }
    });
}
// ===============================
// CONTENT LIBRARY INTEGRATION
// ===============================

// Open Content Library Modal
function openContentLibrary(moduleId) {
    Swal.close(); // Close the content types modal
    
    Swal.fire({
        title: '📚 اختر محتوى من المكتبة',
        html: `
            <div id="libraryLoadingState" style="text-align: center; padding: 2rem;">
                <div class="spinner" style="border: 3px solid #f3f3f3; border-top: 3px solid #6366f1; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                <p style="margin-top: 1rem;">جاري تحميل المحتوى...</p>
            </div>
            <div id="libraryContentGrid" style="display: none;">
                <!-- سيتم ملؤها بواسطة JavaScript -->
            </div>
            <div id="libraryEmptyState" style="display: none; text-align: center; padding: 2rem; color: #666;">
                <i class="fas fa-book" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                <h4>لا يوجد محتوى في المكتبة</h4>
                <p>قم بإنشاء محتوى في مكتبة المحتوى التعليمي أولاً</p>
                <button class="btn btn-primary" onclick="openContentCreatorPage()" style="margin-top: 1rem;">
                    <i class="fas fa-plus"></i> إنشاء محتوى جديد
                </button>
            </div>
        `,
        width: '90%',
        maxWidth: '1000px',
        showConfirmButton: false,
        showCancelButton: true,
        cancelButtonText: 'إغلاق'
    });
    
    // Load content from library
    loadLibraryContent(moduleId);
}

// Load Content from Firebase
async function loadLibraryContent(moduleId) {
    try {
        const snapshot = await db.collection('courseContentLibrary')
            .orderBy('createdDate', 'desc')
            .get();
        
        const content = [];
        
        snapshot.forEach(doc => {
            content.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        displayLibraryContent(content, moduleId);
        
    } catch (error) {
        console.error('Error loading library content:', error);
        document.getElementById('libraryLoadingState').innerHTML = `
            <div style="color: #dc3545; text-align: center;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                <h4>خطأ في تحميل المحتوى</h4>
                <p>تأكد من الاتصال بالإنترنت وحاول مرة أخرى</p>
            </div>
        `;
    }
}

// Display Library Content
function displayLibraryContent(content, moduleId) {
    const loadingState = document.getElementById('libraryLoadingState');
    const contentGrid = document.getElementById('libraryContentGrid');
    const emptyState = document.getElementById('libraryEmptyState');
    
    loadingState.style.display = 'none';
    
    if (content.length === 0) {
        emptyState.style.display = 'block';
        return;
    }
    
    contentGrid.style.display = 'block';
    
    // Content type icons
    const typeIcons = {
        'educational-video': '🎥',
        'quiz': '❓',
        'assignment': '📝',
        'discussion': '💬',
        'presentation': '📊',
        'exercise': '💪',
        'case-study': '📋',
        'survey': '📊',
        'simulation': '🔬',
        'educational-game': '🎮',
        'workshop': '🛠️',
        'qa-session': '🙋',
        'self-assessment': '🪞',
        'peer-review': '👥',
        'infographic': '📈',
        'custom': '🎨'
    };
    
    let html = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; max-height: 60vh; overflow-y: auto; padding: 1rem;">
    `;
    
    content.forEach(item => {
        const icon = typeIcons[item.type] || '📦';
        const duration = item.duration || 15;
        
        html += `
            <div class="library-content-card" onclick="selectLibraryContent('${item.id}', '${moduleId}')" 
                 style="background: white; border: 2px solid #e5e7eb; border-radius: 10px; padding: 1.5rem; cursor: pointer; transition: all 0.3s; hover: border-color: #6366f1;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <div style="font-size: 2rem;">${icon}</div>
                    <span style="background: #f3f4f6; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; color: #6b7280;">
                        ${duration} دقيقة
                    </span>
                </div>
                
                <h4 style="color: #1f2937; margin-bottom: 0.5rem; font-size: 1.1rem;">
                    ${item.name}
                </h4>
                
                <p style="color: #6b7280; font-size: 0.9rem; line-height: 1.4; margin-bottom: 1rem;">
                    ${item.description || 'لا يوجد وصف'}
                </p>
                
                <div style="display: flex; justify-content: between; align-items: center; font-size: 0.8rem; color: #9ca3af;">
                    <span>استُخدم ${item.timesUsed || 0} مرة</span>
                    <span style="margin-right: auto;">⭐ ${item.averageRating || 0}</span>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    contentGrid.innerHTML = html;
    
    // Add hover effects
    const cards = document.querySelectorAll('.library-content-card');
    cards.forEach(card => {
        card.addEventListener('mouseenter', () => {
            card.style.borderColor = '#6366f1';
            card.style.transform = 'translateY(-2px)';
            card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        });
        card.addEventListener('mouseleave', () => {
            card.style.borderColor = '#e5e7eb';
            card.style.transform = 'translateY(0)';
            card.style.boxShadow = 'none';
        });
    });
}

// Select Content from Library
function selectLibraryContent(contentId, moduleId) {
    Swal.fire({
        title: 'إضافة المحتوى',
        text: 'هل تريد إضافة هذا المحتوى إلى الوحدة؟',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'نعم، أضف',
        cancelButtonText: 'إلغاء',
        confirmButtonColor: '#10b981'
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                // Get the content details
                const contentDoc = await db.collection('courseContentLibrary').doc(contentId).get();
                const contentData = contentDoc.data();
                
                // Create lesson with library content
                const lesson = {
                    id: 'lesson_' + Date.now(),
                    type: 'library-content',
                    title: contentData.name,
                    duration: contentData.duration || 15,
                    description: contentData.description || '',
                    libraryContentId: contentId,
                    libraryContentType: contentData.type,
                    isCompleted: false
                };
                
                // Find the module and add the lesson
                const module = courseData.modules.find(m => m.id === moduleId);
                if (module) {
                    module.lessons.push(lesson);
                    
                    // Update UI
                    renderModules();
                    updateCurriculumStats();
                    autoSave();
                    
                    // Update usage count in library
                    await db.collection('courseContentLibrary').doc(contentId).update({
                        timesUsed: firebase.firestore.FieldValue.increment(1),
                        lastUsed: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'تم الإضافة',
                        text: 'تم إضافة المحتوى إلى الوحدة بنجاح',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
                
            } catch (error) {
                console.error('Error adding library content:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء إضافة المحتوى'
                });
            }
        }
    });
}

// Open Content Creator Page
function openContentCreatorPage() {
    window.open('course-content-library.html', '_blank');
}

// Update lesson rendering to handle library content
function getLessonIcon(type) {
    const icons = {
        'library-content': 'book',
        'text': 'file-alt',
        'file': 'download',
        // Add other types as needed
    };
    return icons[type] || 'file';
}
        function updateModuleTitle(moduleId, title) {
            const module = courseData.modules.find(m => m.id === moduleId);
            if (module) {
                module.title = title;
                autoSave();
            }
        }

        function updateModuleDescription(moduleId, description) {
            const module = courseData.modules.find(m => m.id === moduleId);
            if (module) {
                module.description = description;
                autoSave();
            }
        }

        function toggleModule(moduleId) {
            const module = courseData.modules.find(m => m.id === moduleId);
            if (module) {
                module.isExpanded = !module.isExpanded;
                renderModules();
            }
        }

        function deleteModule(index) {
            Swal.fire({
                title: 'حذف الوحدة؟',
                text: 'سيتم حذف الوحدة وجميع الدروس التابعة لها',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545'
            }).then((result) => {
                if (result.isConfirmed) {
                    courseData.modules.splice(index, 1);
                    renderModules();
                    updateCurriculumStats();
                    autoSave();
                }
            });
        }

        function updateCurriculumStats() {
            const totalModules = courseData.modules.length;
            let totalLessons = 0;
            let totalDuration = 0;
            
            courseData.modules.forEach(module => {
                totalLessons += module.lessons.length;
                module.lessons.forEach(lesson => {
                    totalDuration += lesson.duration || 0;
                });
            });
            
            document.getElementById('totalModules').textContent = totalModules;
            document.getElementById('totalLessons').textContent = totalLessons;
            document.getElementById('totalDuration').textContent = totalDuration;
            
            courseData.totalLessons = totalLessons;
            courseData.totalDuration = totalDuration;
        }

        function initializeSortable() {
            // Sortable for modules
            const modulesContainer = document.getElementById('modulesContainer');
            if (modulesContainer) {
                new Sortable(modulesContainer, {
                    animation: 150,
                    handle: '.drag-handle',
                    onEnd: function(evt) {
                        const moduleIds = Array.from(modulesContainer.children).map(el => el.dataset.moduleId);
                        const reorderedModules = [];
                        
                        moduleIds.forEach(id => {
                            const module = courseData.modules.find(m => m.id === id);
                            if (module) reorderedModules.push(module);
                        });
                        
                        courseData.modules = reorderedModules;
                        autoSave();
                    }
                });
            }
            
            // Sortable for lessons within each module
            courseData.modules.forEach(module => {
                const lessonsContainer = document.getElementById(`lessons-${module.id}`);
                if (lessonsContainer) {
                    new Sortable(lessonsContainer, {
                        animation: 150,
                        handle: '.drag-handle',
                        onEnd: function(evt) {
                            const lessonIds = Array.from(lessonsContainer.children).map(el => el.dataset.lessonId);
                            const reorderedLessons = [];
                            
                            lessonIds.forEach(id => {
                                const lesson = module.lessons.find(l => l.id === id);
                                if (lesson) reorderedLessons.push(lesson);
                            });
                            
                            module.lessons = reorderedLessons;
                            autoSave();
                        }
                    });
                }
            });
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================
function initializeEventListeners() {
    // Basic Info
document.getElementById('courseTitle').addEventListener('input', (e) => {
    // فقط تحديث العنوان في الهيدر
    document.getElementById('courseTitleHeader').textContent = e.target.value || 'دورة جديدة';
    
    // عرض slug مقترح كـ placeholder فقط
    if (e.target.value && e.target.value !== 'دورة جديدة') {
        const suggestedSlug = generateSlug(e.target.value);
        document.getElementById('courseSlug').placeholder = suggestedSlug;
        document.getElementById('slugPreview').textContent = suggestedSlug;
    }
});

// حفظ العنوان عند الخروج من الحقل فقط (لو موجود ID)
document.getElementById('courseTitle').addEventListener('blur', (e) => {
    courseData.title = e.target.value;
    if (courseData.id) {
        autoSave();
    }
});
    
    document.getElementById('courseSlug').addEventListener('change', (e) => {
        courseData.slug = e.target.value;
        document.getElementById('slugPreview').textContent = e.target.value;
        autoSave();
    });
    
    // All other form fields
    const formFields = [
        'subtitle', 'description', 'detailedDescription', 'language', 'targetAudience',
        'introVideo', 'instructorName', 'instructorTitle', 'instructorBio',
        'instructorLinkedIn', 'instructorTwitter', 'instructorWebsite',
        'category', 'level', 'price', 'salePrice', 'donationMin', 'donationMax',
        'vodafoneNumber', 'instapayNumber', 'bankName', 'bankAccountNumber', 'bankAccountName',
        'maxStudents', 'whatsappNumber', 'whatsappGroupLink', 'welcomeMessage',
        'courseStructure', 'learningType', 'dripType', 'minCompletion',
        'supportHours', 'certificateThreshold', 'certificateText',
        'progressMethod', 'expectedCompletion', 'seoTitle', 'seoDescription',
        'socialDescription', 'status', 'applicationDomain', 'practiceDepth', 'courseLevel'
    ];
    
    formFields.forEach(field => {
        const element = document.getElementById(field);
        if (element) {
            element.addEventListener('change', (e) => {
                courseData[field] = e.target.value;
                autoSave();
            });
        }
    });
    
    // Checkboxes
    const checkboxes = [
        'dripContent', 'enableQuizzes', 'enableAssignments', 'enableWaitlist',
        'autoWelcomeMessage', 'enableComments', 'enableForum', 'enableLiveSupport',
        'certificate', 'requireQuizzes', 'requireAssignments', 'requireParticipation',
        'requireFinalProject', 'showCompletionBadges', 'sendProgressEmails',
        'showProgressBar', 'showModuleProgress', 'showLearningStats',
        'showAchievementBadges', 'allowSharing', 'privateLink'
    ];
    
    checkboxes.forEach(field => {
        const element = document.getElementById(field);
        if (element) {
            element.addEventListener('change', (e) => {
                if (field.startsWith('require')) {
                    courseData.certificateRequirements[field] = e.target.checked;
                } else {
                    courseData[field] = e.target.checked;
                }
                
                // Handle dependent fields
                if (field === 'dripContent') {
                    document.getElementById('dripSettings').style.display = 
                        e.target.checked ? 'flex' : 'none';
                }
                if (field === 'autoWelcomeMessage') {
                    document.getElementById('welcomeMessageField').style.display = 
                        e.target.checked ? 'block' : 'none';
                }
                if (field === 'enableLiveSupport') {
                    document.getElementById('supportSettings').style.display = 
                        e.target.checked ? 'block' : 'none';
                }
                if (field === 'certificate') {
                    document.getElementById('certificateSettings').style.display = 
                        e.target.checked ? 'block' : 'none';
                }
                
                autoSave();
            });
        }
    });
    
    // Date fields
    const dateFields = ['enrollmentStartDate', 'enrollmentEndDate', 'scheduledPublish'];
    dateFields.forEach(field => {
        const element = document.getElementById(field);
        if (element) {
            element.addEventListener('change', (e) => {
                courseData[field] = e.target.value;
                autoSave();
            });
        }
    });
    
    // Select fields
    document.getElementById('isPublic').addEventListener('change', (e) => {
        courseData.isPublic = e.target.value === 'true';
        autoSave();
    });
    
    // إضافة مستمع لتفعيل المنح
    const enableGrants = document.getElementById('enableGrants');
    if (enableGrants) {
        enableGrants.addEventListener('change', (e) => {
            const grantsSettings = document.getElementById('grantsSettings');
            if (grantsSettings) {
                grantsSettings.style.display = e.target.checked ? 'block' : 'none';
            }
            collectFormData();
            autoSave();
        });
    }
    
    // مستمعي أحداث المنح
    const grantFields = [
        'grantSeats', 'totalSeats', 'grantFormUrl',
        'grantDiscount', 'grantInstallments', 'grantDeferred', 'grantService',
        'criteriaFinancial', 'criteriaMotivation', 'criteriaImpact', 'criteriaHistory'
    ];
    
    grantFields.forEach(field => {
        const element = document.getElementById(field);
        if (element) {
            element.addEventListener('change', () => {
                collectFormData();
                autoSave();
            });
        }
    });
}
        // ========================================
        // AUTO-SAVE
        // ========================================
function autoSave() {
    // منع الحفظ التلقائي للدورات الجديدة
    if (!courseData.id) {
        console.log('تجاهل الحفظ التلقائي - لا يوجد ID بعد');
        return;
    }
    
    // منع الحفظ المتكرر
    if (isSaving) {
        console.log('حفظ قيد التنفيذ بالفعل');
        return;
    }
    
    // إلغاء أي حفظ سابق معلق
    clearTimeout(autoSaveTimeout);
    
    autoSaveTimeout = setTimeout(() => {
        saveCourseData().then(() => {
            showAutoSaveIndicator();
            console.log('تم الحفظ التلقائي بنجاح');
        }).catch(error => {
            console.error('فشل الحفظ التلقائي:', error);
        });
    }, 2000);
}
        function showAutoSaveIndicator() {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.classList.add('show');
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 3000);
        }

        // ========================================
        // FIREBASE INTEGRATION
        // ========================================
async function saveCourseData() {
    // منع الحفظ التلقائي للدورات الجديدة تماماً
    if (!courseData.id) {
        console.log('دورة جديدة - منع الحفظ التلقائي');
        return Promise.resolve();
    }
    
    // منع الحفظ المتكرر
    if (isSaving) {
        console.log('حفظ قيد التنفيذ بالفعل');
        return Promise.resolve();
    }
    
    if (!firebase.firestore) {
        console.error('Firestore not initialized');
        return Promise.reject('Firestore not initialized');
    }
    
    isSaving = true;
    
    try {
        // جمع كل البيانات من الفورم
        collectFormData();
        
        // تنظيف البيانات قبل الحفظ
        const dataToSave = cleanDataBeforeSave(courseData);
        
        // تحديث slug فقط (مش ID)
        let finalSlug = dataToSave.slug;
        const slugInput = document.getElementById('courseSlug');
        
        if (slugInput && slugInput.value.trim()) {
            finalSlug = slugInput.value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '');
        }
        
        if (!finalSlug && dataToSave.title && dataToSave.title !== 'دورة جديدة') {
            finalSlug = generateSlug(dataToSave.title);
        }
        
        // تجهيز البيانات للحفظ
        const finalData = {
            ...dataToSave,
            slug: finalSlug,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // حذف القيم الغير معرفة
        Object.keys(finalData).forEach(key => {
            if (finalData[key] === undefined) {
                delete finalData[key];
            }
        });
        
        // تحديث دورة موجودة فقط
        await window.firebaseDB.courses.updateCourse(courseData.id, finalData);
        console.log('تم تحديث الدورة:', courseData.id);
        
        return Promise.resolve();
    } catch (error) {
        console.error('Error saving course:', error);
        return Promise.reject(error);
    } finally {
        isSaving = false;
    }
}

        // دالة تنظيف البيانات قبل الحفظ
function cleanDataBeforeSave(data) {
    const cleaned = { ...data };
    
    // تنظيف الخصومات الفارغة
    if (cleaned.discounts && Array.isArray(cleaned.discounts)) {
        cleaned.discounts = cleaned.discounts.filter(d => 
            d && (d.name || d.percentage > 0)
        );
    }
    
    // تنظيف خصومات المجموعات الفارغة
    if (cleaned.groupDiscounts && Array.isArray(cleaned.groupDiscounts)) {
        cleaned.groupDiscounts = cleaned.groupDiscounts.filter(g => 
            g && g.percentage > 0
        );
    }
    
    // تنظيف خطط الدفع الفارغة
    if (cleaned.paymentPlans && Array.isArray(cleaned.paymentPlans)) {
        cleaned.paymentPlans = cleaned.paymentPlans.filter(p => 
            p && p.name && p.installments > 0
        );
    }
    
    // تنظيف الكوبونات الفارغة
    if (cleaned.coupons && Array.isArray(cleaned.coupons)) {
        cleaned.coupons = cleaned.coupons.filter(c => 
            c && c.code && c.value > 0
        );
    }
    
    // تنظيف خطط المنح الفارغة
    if (cleaned.grantPlans && Array.isArray(cleaned.grantPlans)) {
        cleaned.grantPlans = cleaned.grantPlans.filter(p => 
            p && p.name
        );
    }
    
    return cleaned;
}
        
function collectFormData() {
    // تأكد من تحميل الصفحة أولاً
    if (!document.getElementById('courseTitle')) {
        console.log('الصفحة لم تحمل بعد');
        return;
    }
    
    // ========== البيانات الأساسية ==========
    courseData.title = document.getElementById('courseTitle')?.value || 'دورة جديدة';
    courseData.slug = document.getElementById('courseSlug')?.value || generateSlug(courseData.title);
    courseData.subtitle = document.getElementById('subtitle')?.value || '';
    courseData.description = document.getElementById('description')?.value || '';
    courseData.detailedDescription = document.getElementById('detailedDescription')?.value || '';
    courseData.language = document.getElementById('language')?.value || 'ar';
    courseData.targetAudience = document.getElementById('targetAudience')?.value || 'all';
    courseData.introVideo = document.getElementById('introVideo')?.value || '';
    courseData.courseLevel = document.getElementById('courseLevel')?.value || 'foundational';
    courseData.applicationDomain = document.getElementById('applicationDomain')?.value || '';
    courseData.practiceDepth = document.getElementById('practiceDepth')?.value || '';
    
    // ========== التسعير والعروض ==========
    // التسعير الأساسي
    courseData.priceType = document.getElementById('priceType')?.value || 'free';
    courseData.currency = document.getElementById('currency')?.value || 'EGP';
    courseData.price = parseFloat(document.getElementById('price')?.value) || 0;
    courseData.salePrice = document.getElementById('salePrice')?.value ? parseFloat(document.getElementById('salePrice').value) : null;
    
    // خصم الدفع الكامل
    courseData.cashDiscount = {
        enabled: document.getElementById('enableCashDiscount')?.checked || false,
        percentage: parseFloat(document.getElementById('cashDiscountPercent')?.value) || 10
    };
    
    // خطط المنح (محفوظة مسبقاً في المصفوفة)
if (!courseData.grantPlans) courseData.grantPlans = [];
    
    // العروض الزمنية
    courseData.discounts = [];
    document.querySelectorAll('#discountsList .card').forEach((card, index) => {
        const nameInput = card.querySelector('input[placeholder="اسم العرض"]');
        const percentageInput = card.querySelector('input[type="number"][min="0"][max="100"]');
        const startDateInput = card.querySelector('input[type="date"]:first-of-type');
        const endDateInput = card.querySelector('input[type="date"]:last-of-type');
        
        if (nameInput && percentageInput) {
            const discount = {
                id: 'discount_' + Date.now() + '_' + index,
                name: nameInput.value || '',
                percentage: parseInt(percentageInput.value) || 0,
                startDate: startDateInput?.value || '',
                endDate: endDateInput?.value || ''
            };
            
            if (discount.name || discount.percentage > 0) {
                courseData.discounts.push(discount);
            }
        }
    });

    
    // خصومات المجموعات
    courseData.groupDiscounts = [];
    document.querySelectorAll('#groupDiscountsList .card').forEach((card, index) => {
        const nameInput = card.querySelector('input[placeholder="اسم عرض المجموعة"]');
        const minSizeInput = card.querySelector('input[type="number"][min="2"]');
        const percentageInput = card.querySelector('.input-group input[type="number"]');
        
        if (percentageInput) {
            const groupDiscount = {
                id: 'group_' + Date.now() + '_' + index,
                name: nameInput?.value || '',
                minSize: parseInt(minSizeInput?.value) || 3,
                percentage: parseInt(percentageInput.value) || 0
            };
            
            if (groupDiscount.percentage > 0) {
                courseData.groupDiscounts.push(groupDiscount);
            }
        }
    });
    
    // خطط الدفع والكوبونات (محفوظة مسبقاً في المصفوفات)
    if (!courseData.paymentPlans) courseData.paymentPlans = [];
    if (!courseData.coupons) courseData.coupons = [];
    
    // ========== برنامج المنح ==========
    courseData.grants = {
        enabled: document.getElementById('enableGrants')?.checked || false,
        seats: parseInt(document.getElementById('grantSeats')?.value) || 5,
        totalSeats: parseInt(document.getElementById('totalSeats')?.value) || 30,
        supportTypes: {
            discount: document.getElementById('grantDiscount')?.checked || false,
            installments: document.getElementById('grantInstallments')?.checked || false,
            deferred: document.getElementById('grantDeferred')?.checked || false,
            service: document.getElementById('grantService')?.checked || false
        },
        criteria: {
            financial: document.getElementById('criteriaFinancial')?.checked || false,
            motivation: document.getElementById('criteriaMotivation')?.checked || false,
            impact: document.getElementById('criteriaImpact')?.checked || false,
            history: document.getElementById('criteriaHistory')?.checked || false
        },
        formUrl: document.getElementById('grantFormUrl')?.value || ''
    };
    
    // ========== طرق الدفع ==========
    courseData.paymentMethods = {
        vodafone: {
            enabled: document.getElementById('vodafoneEnabled')?.checked || false,
            number: document.getElementById('vodafoneNumber')?.value || ''
        },
        instapay: {
            enabled: document.getElementById('instapayEnabled')?.checked || false,
            number: document.getElementById('instapayNumber')?.value || ''
        },
        bank: {
            enabled: document.getElementById('bankEnabled')?.checked || false,
            name: document.getElementById('bankName')?.value || '',
            accountNumber: document.getElementById('bankAccountNumber')?.value || '',
            accountName: document.getElementById('bankAccountName')?.value || ''
        }
    };
    
    // ========== معلومات المدرب ==========
    courseData.instructorName = document.getElementById('instructorName')?.value || '';
    courseData.instructorTitle = document.getElementById('instructorTitle')?.value || '';
    courseData.instructorBio = document.getElementById('instructorBio')?.value || '';
    courseData.instructorLinkedIn = document.getElementById('instructorLinkedIn')?.value || '';
    courseData.instructorTwitter = document.getElementById('instructorTwitter')?.value || '';
    courseData.instructorWebsite = document.getElementById('instructorWebsite')?.value || '';
    
    // ========== التصنيف والمستوى ==========
    courseData.category = document.getElementById('category')?.value || '';
    courseData.level = document.getElementById('level')?.value || 'beginner';
    
    // ========== إعدادات التسجيل ==========
    courseData.enrollmentType = document.getElementById('enrollmentType')?.value || 'open';
    courseData.maxStudents = document.getElementById('maxStudents')?.value ? parseInt(document.getElementById('maxStudents').value) : null;
    courseData.accessDuration = document.getElementById('accessDuration')?.value || 'lifetime';
    courseData.enrollmentStartDate = document.getElementById('enrollmentStartDate')?.value || null;
    courseData.enrollmentEndDate = document.getElementById('enrollmentEndDate')?.value || null;
    courseData.enableWaitlist = document.getElementById('enableWaitlist')?.checked || false;
    
    // ========== التواصل ==========
    courseData.whatsappNumber = document.getElementById('whatsappNumber')?.value || '';
    courseData.whatsappGroupLink = document.getElementById('whatsappGroupLink')?.value || '';
    courseData.autoWelcomeMessage = document.getElementById('autoWelcomeMessage')?.checked || true;
    courseData.welcomeMessage = document.getElementById('welcomeMessage')?.value || '';
    
    // ========== هيكل الدورة ==========
    courseData.courseStructure = document.getElementById('courseStructure')?.value || 'linear';
    courseData.learningType = document.getElementById('learningType')?.value || 'self-paced';
    courseData.dripContent = document.getElementById('dripContent')?.checked || false;
    courseData.dripType = document.getElementById('dripType')?.value || 'weekly';
    courseData.enableQuizzes = document.getElementById('enableQuizzes')?.checked || true;
    courseData.enableAssignments = document.getElementById('enableAssignments')?.checked || false;
    courseData.minCompletion = parseInt(document.getElementById('minCompletion')?.value) || 80;
    
    // ========== مميزات التواصل ==========
    courseData.enableComments = document.getElementById('enableComments')?.checked || true;
    courseData.enableForum = document.getElementById('enableForum')?.checked || false;
    courseData.enableLiveSupport = document.getElementById('enableLiveSupport')?.checked || false;
    courseData.supportHours = document.getElementById('supportHours')?.value || 'business';
    
    // ========== إعدادات الشهادة ==========
    courseData.certificate = document.getElementById('certificate')?.checked || true;
    courseData.certificateThreshold = parseInt(document.getElementById('certificateThreshold')?.value) || 80;
    courseData.certificateText = document.getElementById('certificateText')?.value || '';
    courseData.certificateRequirements = {
        requireQuizzes: document.getElementById('requireQuizzes')?.checked || false,
        requireAssignments: document.getElementById('requireAssignments')?.checked || false,
        requireParticipation: document.getElementById('requireParticipation')?.checked || false,
        requireFinalProject: document.getElementById('requireFinalProject')?.checked || false
    };
    
    // ========== إعدادات التقدم ==========
    courseData.showCompletionBadges = document.getElementById('showCompletionBadges')?.checked || true;
    courseData.sendProgressEmails = document.getElementById('sendProgressEmails')?.checked || false;
    courseData.progressMethod = document.getElementById('progressMethod')?.value || 'lessons';
    courseData.expectedCompletion = document.getElementById('expectedCompletion')?.value || '1month';
    courseData.showProgressBar = document.getElementById('showProgressBar')?.checked || true;
    courseData.showModuleProgress = document.getElementById('showModuleProgress')?.checked || true;
    courseData.showLearningStats = document.getElementById('showLearningStats')?.checked || false;
    courseData.showAchievementBadges = document.getElementById('showAchievementBadges')?.checked || false;
    
    // ========== إعدادات SEO ==========
    courseData.seoTitle = document.getElementById('seoTitle')?.value || courseData.title;
    courseData.seoDescription = document.getElementById('seoDescription')?.value || courseData.description;
    courseData.socialDescription = document.getElementById('socialDescription')?.value || courseData.description;
    courseData.allowSharing = document.getElementById('allowSharing')?.checked || true;
    
    // ========== إعدادات النشر ==========
    courseData.status = document.getElementById('status')?.value || 'draft';
    courseData.isPublic = document.getElementById('isPublic')?.value === 'true';
    courseData.privateLink = document.getElementById('privateLink')?.checked || false;
    courseData.scheduledPublish = document.getElementById('scheduledPublish')?.value || null;
}
        
async function loadCourseData() {
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('id');
    
    if (courseId && firebase.firestore) {
        try {
            showLoading();
            console.log('جاري تحميل الدورة:', courseId);
            
            // جلب بيانات الدورة
            const course = await window.firebaseDB.courses.getCourse(courseId);
            
            if (course) {
                console.log('بيانات الدورة المحملة:', course);
                
                // دمج البيانات المحملة مع البيانات الافتراضية
                courseData = { ...courseData, ...course };
                
                // انتظر حتى تحميل الصفحة بالكامل قبل تحديث UI
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                        setTimeout(function() {
    updateUIWithCourseData();
}, 100); // تأخير بسيط جداً

                        updateProgress();
                    });
                } else {
                    // الصفحة محملة بالفعل
                    updateUIWithCourseData();
                    updateProgress();
                }
                
                // تحديث زر الحفظ
                if (courseData.id) {
                    const saveBtn = document.getElementById('saveSlugBtn');
                    if (saveBtn) {
                        saveBtn.innerHTML = '<i class="fas fa-sync"></i> تحديث الرابط';
                    }
                }
                
                // عرض رسالة نجاح
                Swal.fire({
                    icon: 'success',
                    title: 'تم التحميل',
                    text: `تم تحميل دورة: ${course.title}`,
                    timer: 2000,
                    showConfirmButton: false,
                    position: 'top-end',
                    toast: true
                });
            } else {
                throw new Error('الدورة غير موجودة');
            }
            
            hideLoading();
        } catch (error) {
            console.error('Error loading course:', error);
            hideLoading();
            
            Swal.fire({
                icon: 'error',
                title: 'خطأ في تحميل البيانات',
                text: 'حدث خطأ أثناء تحميل بيانات الدورة: ' + error.message,
                confirmButtonText: 'حسناً'
            });
        }
    } else {
        console.log('دورة جديدة - لا يوجد ID');
        // انتظر تحميل الصفحة
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                updateUIWithCourseData();
            });
        } else {
            updateUIWithCourseData();
        }
    }
}

function updateUIWithCourseData() {
    // تحقق من وجود العناصر الأساسية أولاً
    if (!document.getElementById('courseTitle')) {
        console.log('العناصر لم تحمل بعد، سيتم المحاولة لاحقاً...');
        setTimeout(updateUIWithCourseData, 500);
        return;
    }
    
    try {
        // ========== البيانات الأساسية ==========
        const setValueSafe = (elementId, value) => {
            const element = document.getElementById(elementId);
            if (element && value !== undefined && value !== null) {
                element.value = value;
            }
        };
        
        const setCheckedSafe = (elementId, checked) => {
            const element = document.getElementById(elementId);
            if (element) {
                element.checked = !!checked;
            }
        };
        
        // البيانات الأساسية
        setValueSafe('courseTitle', courseData.title);
        setValueSafe('courseSlug', courseData.slug);
        setValueSafe('subtitle', courseData.subtitle);
        setValueSafe('description', courseData.description);
        setValueSafe('detailedDescription', courseData.detailedDescription);
        setValueSafe('language', courseData.language);
        setValueSafe('targetAudience', courseData.targetAudience);
        setValueSafe('introVideo', courseData.introVideo);
        setValueSafe('courseLevel', courseData.courseLevel);
        setValueSafe('applicationDomain', courseData.applicationDomain);
        setValueSafe('practiceDepth', courseData.practiceDepth);
        
        // ========== التسعير والعروض ==========
        // التسعير الأساسي
        if (courseData.priceType) {
            setValueSafe('priceType', courseData.priceType);
            if (typeof updatePricingFields === 'function') {
                updatePricingFields();
            }
        }
        setValueSafe('currency', courseData.currency);
        setValueSafe('price', courseData.price);
        setValueSafe('salePrice', courseData.salePrice);
        
        // خصم الدفع الكامل
        if (courseData.cashDiscount) {
            setCheckedSafe('enableCashDiscount', courseData.cashDiscount.enabled);
            setValueSafe('cashDiscountPercent', courseData.cashDiscount.percentage || 10);
            if (typeof toggleCashDiscount === 'function') {
                toggleCashDiscount();
            }
        }
        
        // العروض الزمنية
        if (courseData.discounts && courseData.discounts.length > 0) {
            courseData.discounts.forEach(() => {
                if (typeof addDiscountTier === 'function') {
                    addDiscountTier();
                }
            });
            if (typeof renderDiscounts === 'function') {
                renderDiscounts();
            }
        }
        
        // خصومات المجموعات
        if (courseData.groupDiscounts && courseData.groupDiscounts.length > 0) {
            courseData.groupDiscounts.forEach(() => {
                if (typeof addGroupDiscount === 'function') {
                    addGroupDiscount();
                }
            });
            if (typeof renderGroupDiscounts === 'function') {
                renderGroupDiscounts();
            }
        }
        
        // خطط الدفع
        if (courseData.paymentPlans && courseData.paymentPlans.length > 0) {
            if (typeof renderPaymentPlans === 'function') {
                renderPaymentPlans();
            }
        }
        
        // الكوبونات
        if (courseData.coupons && courseData.coupons.length > 0) {
            if (typeof renderCoupons === 'function') {
                renderCoupons();
            }
        }
        
        // خطط المنح
        if (courseData.grantPlans && courseData.grantPlans.length > 0) {
            if (typeof renderGrantPlans === 'function') {
                renderGrantPlans();
            }
        }
        
        // ========== برنامج المنح ==========
        if (courseData.grants) {
            setCheckedSafe('enableGrants', courseData.grants.enabled);
            setValueSafe('grantSeats', courseData.grants.seats || 5);
            setValueSafe('totalSeats', courseData.grants.totalSeats || 30);
            
            // أنواع الدعم
            if (courseData.grants.supportTypes) {
                setCheckedSafe('grantDiscount', courseData.grants.supportTypes.discount);
                setCheckedSafe('grantInstallments', courseData.grants.supportTypes.installments);
                setCheckedSafe('grantDeferred', courseData.grants.supportTypes.deferred);
                setCheckedSafe('grantService', courseData.grants.supportTypes.service);
            }
            
            // معايير التقييم
            if (courseData.grants.criteria) {
                setCheckedSafe('criteriaFinancial', courseData.grants.criteria.financial);
                setCheckedSafe('criteriaMotivation', courseData.grants.criteria.motivation);
                setCheckedSafe('criteriaImpact', courseData.grants.criteria.impact);
                setCheckedSafe('criteriaHistory', courseData.grants.criteria.history);
            }
            
            setValueSafe('grantFormUrl', courseData.grants.formUrl);
            if (typeof toggleGrants === 'function') {
                toggleGrants();
            }
        }
        
        // ========== طرق الدفع ==========
        if (courseData.paymentMethods) {
            // Vodafone Cash
            if (courseData.paymentMethods.vodafone) {
                setCheckedSafe('vodafoneEnabled', courseData.paymentMethods.vodafone.enabled);
                setValueSafe('vodafoneNumber', courseData.paymentMethods.vodafone.number);
                if (typeof togglePaymentMethod === 'function') {
                    togglePaymentMethod('vodafone');
                }
            }
            
            // InstaPay
            if (courseData.paymentMethods.instapay) {
                setCheckedSafe('instapayEnabled', courseData.paymentMethods.instapay.enabled);
                setValueSafe('instapayNumber', courseData.paymentMethods.instapay.number);
                if (typeof togglePaymentMethod === 'function') {
                    togglePaymentMethod('instapay');
                }
            }
            
            // Bank
            if (courseData.paymentMethods.bank) {
                setCheckedSafe('bankEnabled', courseData.paymentMethods.bank.enabled);
                setValueSafe('bankName', courseData.paymentMethods.bank.name);
                setValueSafe('bankAccountNumber', courseData.paymentMethods.bank.accountNumber);
                setValueSafe('bankAccountName', courseData.paymentMethods.bank.accountName);
                if (typeof togglePaymentMethod === 'function') {
                    togglePaymentMethod('bank');
                }
            }
        }
        
        // ========== معلومات المدرب ==========
        setValueSafe('instructorName', courseData.instructorName);
        setValueSafe('instructorTitle', courseData.instructorTitle);
        setValueSafe('instructorBio', courseData.instructorBio);
        setValueSafe('instructorLinkedIn', courseData.instructorLinkedIn);
        setValueSafe('instructorTwitter', courseData.instructorTwitter);
        setValueSafe('instructorWebsite', courseData.instructorWebsite);
        
        // ========== التصنيف والمستوى ==========
        setValueSafe('category', courseData.category);
        setValueSafe('level', courseData.level);
        
        // ========== إعدادات التسجيل ==========
        setValueSafe('enrollmentType', courseData.enrollmentType);
        setValueSafe('maxStudents', courseData.maxStudents);
        setValueSafe('accessDuration', courseData.accessDuration);
        setValueSafe('enrollmentStartDate', courseData.enrollmentStartDate);
        setValueSafe('enrollmentEndDate', courseData.enrollmentEndDate);
        setCheckedSafe('enableWaitlist', courseData.enableWaitlist);
        
        // ========== التواصل ==========
        setValueSafe('whatsappNumber', courseData.whatsappNumber);
        setValueSafe('whatsappGroupLink', courseData.whatsappGroupLink);
        setCheckedSafe('autoWelcomeMessage', courseData.autoWelcomeMessage !== false);
        setValueSafe('welcomeMessage', courseData.welcomeMessage);
        
        // ========== هيكل الدورة ==========
        setValueSafe('courseStructure', courseData.courseStructure);
        setValueSafe('learningType', courseData.learningType);
        setCheckedSafe('dripContent', courseData.dripContent);
        setValueSafe('dripType', courseData.dripType);
        setCheckedSafe('enableQuizzes', courseData.enableQuizzes !== false);
        setCheckedSafe('enableAssignments', courseData.enableAssignments);
        setValueSafe('minCompletion', courseData.minCompletion);
        
        // ========== مميزات التواصل ==========
        setCheckedSafe('enableComments', courseData.enableComments !== false);
        setCheckedSafe('enableForum', courseData.enableForum);
        setCheckedSafe('enableLiveSupport', courseData.enableLiveSupport);
        setValueSafe('supportHours', courseData.supportHours);
        
        // ========== إعدادات الشهادة ==========
        setCheckedSafe('certificate', courseData.certificate !== false);
        setValueSafe('certificateThreshold', courseData.certificateThreshold);
        setValueSafe('certificateText', courseData.certificateText);
        
        if (courseData.certificateRequirements) {
            setCheckedSafe('requireQuizzes', courseData.certificateRequirements.requireQuizzes);
            setCheckedSafe('requireAssignments', courseData.certificateRequirements.requireAssignments);
            setCheckedSafe('requireParticipation', courseData.certificateRequirements.requireParticipation);
            setCheckedSafe('requireFinalProject', courseData.certificateRequirements.requireFinalProject);
        }
        
        // ========== إعدادات التقدم ==========
        setCheckedSafe('showCompletionBadges', courseData.showCompletionBadges !== false);
        setCheckedSafe('sendProgressEmails', courseData.sendProgressEmails);
        setValueSafe('progressMethod', courseData.progressMethod);
        setValueSafe('expectedCompletion', courseData.expectedCompletion);
        setCheckedSafe('showProgressBar', courseData.showProgressBar !== false);
        setCheckedSafe('showModuleProgress', courseData.showModuleProgress !== false);
        setCheckedSafe('showLearningStats', courseData.showLearningStats);
        setCheckedSafe('showAchievementBadges', courseData.showAchievementBadges);
        
        // ========== إعدادات SEO ==========
        setValueSafe('seoTitle', courseData.seoTitle);
        setValueSafe('seoDescription', courseData.seoDescription);
        setValueSafe('socialDescription', courseData.socialDescription);
        setCheckedSafe('allowSharing', courseData.allowSharing !== false);
        
        // ========== إعدادات النشر ==========
        setValueSafe('status', courseData.status);
        if (courseData.isPublic !== undefined) {
            setValueSafe('isPublic', courseData.isPublic.toString());
        }
        setCheckedSafe('privateLink', courseData.privateLink);
        setValueSafe('scheduledPublish', courseData.scheduledPublish);
        
        // الصور
        if (courseData.thumbnailUrl) {
            const preview = document.getElementById('thumbnailPreview');
            const image = document.getElementById('thumbnailImage');
            if (preview && image) {
                image.src = courseData.thumbnailUrl;
                preview.style.display = 'block';
            }
        }
        
        // تحديث العناصر الديناميكية الأخرى إذا كانت الدوال موجودة
        const dynamicFunctions = [
            'renderObjectives',
            'renderRequirements', 
            'renderKeywords',
            'renderModules',
            'updateCurriculumStats',
            'updateCurrencyLabel'
        ];
        
        dynamicFunctions.forEach(funcName => {
            if (typeof window[funcName] === 'function') {
                window[funcName]();
            }
        });
        
        // تحديث معاينة الأسعار
        if (typeof updatePricePreview === 'function') {
            setTimeout(updatePricePreview, 100);
        }
        
        console.log('تم تحديث واجهة المستخدم بنجاح');
        
    } catch (error) {
        console.error('خطأ في تحديث واجهة المستخدم:', error);
        // في حالة الخطأ، حاول مرة أخرى بعد قليل
        setTimeout(() => {
            updateUIWithCourseData();
        }, 1000);
    }
}

        function updateProgress() {
            let completedFields = 0;
            let totalFields = 0;
            
            // Check required fields
            const requiredFields = [
                'title', 'description', 'instructorName', 'language'
            ];
            
            requiredFields.forEach(field => {
                totalFields++;
                if (courseData[field] && courseData[field].trim() !== '') {
                    completedFields++;
                }
            });
            
            // Check modules
            totalFields++;
            if (courseData.modules && courseData.modules.length > 0) {
                completedFields++;
            }
            
            // Calculate progress
            const progress = Math.round((completedFields / totalFields) * 100);
            courseData.progress = progress;
            
            // Update UI
            document.getElementById('progressBar').style.width = progress + '%';
        }
// دالة تبديل طرق الدفع
function togglePaymentMethod(method) {
    const methodContent = document.getElementById(method + 'Content');
    const methodCheckbox = document.getElementById(method + 'Enabled');
    
    if (methodContent && methodCheckbox) {
        methodContent.style.display = methodCheckbox.checked ? 'block' : 'none';
    }
}





function addCoupon() {
    const code = document.getElementById('couponCode').value.trim().toUpperCase();
    const type = document.getElementById('couponType').value;
    const value = parseFloat(document.getElementById('couponValue').value) || 0;
    
    if (!code || value === 0) {
        Swal.fire({
            icon: 'error',
            title: 'خطأ',
            text: 'يرجى إدخال كود الكوبون والقيمة'
        });
        return;
    }
    
    const coupon = { code, type, value };
    
    if (!courseData.coupons) courseData.coupons = [];
    courseData.coupons.push(coupon);
    
    // Clear inputs
    document.getElementById('couponCode').value = '';
    document.getElementById('couponValue').value = '';
    
    renderCoupons();
    updatePricePreview();
}



function renderModules() {
    const container = document.getElementById('modulesContainer');
    if (!container) return;
    
    if (!courseData.modules || courseData.modules.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-book"></i>
                <h3>لم تقم بإضافة أي وحدات بعد</h3>
                <p>ابدأ ببناء منهج الدورة بإضافة الوحدات والدروس</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = courseData.modules.map((module, index) => `
        <div class="module-card" data-module-id="${module.id}">
            <div class="module-header">
                <div class="d-flex align-items-center">
                    <i class="fas fa-grip-vertical drag-handle"></i>
                    <input type="text" class="form-control ms-2" value="${module.title}"
                           onchange="updateModuleTitle('${module.id}', this.value)"
                           style="background: transparent; border: none; font-weight: 600;">
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleModule('${module.id}')">
                        <i class="fas fa-chevron-${module.isExpanded ? 'up' : 'down'}"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteModule(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="module-content" style="display: ${module.isExpanded ? 'block' : 'none'}">
                <div class="mb-3">
                    <textarea class="form-control" placeholder="وصف الوحدة (اختياري)"
                              onchange="updateModuleDescription('${module.id}', this.value)">${module.description || ''}</textarea>
                </div>
                <div class="lessons-container" id="lessons-${module.id}">
                    ${module.lessons && module.lessons.length > 0 ? renderLessons(module.lessons, module.id) : '<p class="text-muted">لا توجد دروس في هذه الوحدة</p>'}
                </div>
                <button class="btn btn-outline-primary btn-sm" onclick="showContentTypes('${module.id}')">
                    <i class="fas fa-plus"></i> إضافة محتوى
                </button>
            </div>
        </div>
    `).join('');
    
    // Initialize sortable
    if (typeof initializeSortable === 'function') {
        initializeSortable();
    }
}

function updateCurriculumStats() {
    const totalModules = courseData.modules ? courseData.modules.length : 0;
    let totalLessons = 0;
    let totalDuration = 0;
    
    if (courseData.modules) {
        courseData.modules.forEach(module => {
            if (module.lessons) {
                totalLessons += module.lessons.length;
                module.lessons.forEach(lesson => {
                    totalDuration += lesson.duration || 0;
                });
            }
        });
    }
    
    const modulesElement = document.getElementById('totalModules');
    const lessonsElement = document.getElementById('totalLessons');
    const durationElement = document.getElementById('totalDuration');
    
    if (modulesElement) modulesElement.textContent = totalModules;
    if (lessonsElement) lessonsElement.textContent = totalLessons;
    if (durationElement) durationElement.textContent = totalDuration;
    
    courseData.totalLessons = totalLessons;
    courseData.totalDuration = totalDuration;
}

function renderLessons(lessons, moduleId) {
    if (!lessons || lessons.length === 0) {
        return '<p class="text-muted">لا توجد دروس في هذه الوحدة</p>';
    }
    
    return lessons.map((lesson, index) => `
        <div class="lesson-item" data-lesson-id="${lesson.id}">
            <div class="lesson-info">
                <i class="fas fa-grip-vertical drag-handle"></i>
                <div class="lesson-type-icon">
                    <i class="fas fa-${getLessonIcon(lesson.type)}"></i>
                </div>
                <div>
                    <div class="fw-semibold">${lesson.title}</div>
                    <small class="text-muted">${lesson.duration} دقيقة</small>
                </div>
            </div>
            <div>
                <button class="btn btn-sm btn-outline-secondary" onclick="editLesson('${moduleId}', '${lesson.id}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteLesson('${moduleId}', '${lesson.id}')">
                    <i class="fas fa-trash"></i>
                </button>
                <button class="btn btn-sm ${lesson.isFreePreview ? 'btn-success' : 'btn-outline-success'}" 
                        onclick="toggleFreePreview('${moduleId}', '${lesson.id}')"
                        title="${lesson.isFreePreview ? 'إلغاء المعاينة المجانية' : 'إتاحة كمعاينة مجانية'}">
                    <i class="fas ${lesson.isFreePreview ? 'fa-eye' : 'fa-eye-slash'}"></i>
                </button>
            </div>
        </div>
    `).join('');
}
        
        // ========================================
        // FINAL ACTIONS
        // ========================================
        async function saveDraft() {
            try {
                showLoading();
                courseData.status = 'draft';
                await saveCourseData();
                hideLoading();
                
                Swal.fire({
                    icon: 'success',
                    title: 'تم الحفظ',
                    text: 'تم حفظ الدورة كمسودة بنجاح',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                hideLoading();
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء حفظ الدورة'
                });
            }
        }

        async function publishCourse() {
            // Validate required fields
            if (!validateCourse()) {
                return;
            }
            
            Swal.fire({
                title: 'نشر الدورة؟',
                text: 'هل أنت متأكد من نشر هذه الدورة؟',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'نعم، انشر',
                cancelButtonText: 'إلغاء'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        showLoading();
                        courseData.status = 'published';
                        courseData.publishedAt = firebase.firestore.FieldValue.serverTimestamp();
                        await saveCourseData();
                        hideLoading();
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'تم النشر!',
                            text: 'تم نشر الدورة بنجاح',
                            confirmButtonText: 'عرض الدورة'
                        }).then(() => {
                            window.location.href = `/courses/${courseData.slug || courseData.id}`;
                        });
                    } catch (error) {
                        hideLoading();
                        Swal.fire({
                            icon: 'error',
                            title: 'خطأ',
                            text: 'حدث خطأ أثناء نشر الدورة'
                        });
                    }
                }
            });
        }

        function validateCourse() {
            const errors = [];
            
            if (!courseData.title || courseData.title.trim() === '') {
                errors.push('عنوان الدورة مطلوب');
            }
            
            if (!courseData.description || courseData.description.trim() === '') {
                errors.push('وصف الدورة مطلوب');
            }
            
            if (!courseData.instructorName || courseData.instructorName.trim() === '') {
                errors.push('اسم المدرب مطلوب');
            }
            
            if (!courseData.modules || courseData.modules.length === 0) {
                errors.push('يجب إضافة وحدة واحدة على الأقل');
            }
            
            if (courseData.priceType === 'paid' && (!courseData.price || courseData.price <= 0)) {
                errors.push('يجب تحديد سعر الدورة');
            }
            
            if (errors.length > 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'معلومات ناقصة',
                    html: errors.join('<br>')
                });
                return false;
            }
            
            return true;
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // Add custom styles for content types popup
        const style = document.createElement('style');
        style.textContent = `
            .content-types-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 1rem;
                padding: 1rem;
            }
            
            .content-type-btn {
                background-color: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-lg);
                padding: 2rem 1rem;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.5rem;
                color: var(--text-primary);
            }
            
            .content-type-btn:hover {
                background-color: var(--primary);
                color: white;
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }
            
            .content-type-btn i {
                font-size: 2rem;
            }
            
            .content-types-popup {
                background-color: var(--bg-secondary) !important;
                color: var(--text-primary) !important;
            }
            
            .swal2-popup {
                background-color: var(--bg-secondary);
                color: var(--text-primary);
            }
            
            .swal2-title {
                color: var(--text-primary);
            }
            
            .swal2-input, .swal2-textarea {
                background-color: var(--bg-card);
                border: 1px solid var(--border-color);
                color: var(--text-primary);
            }
            
            .swal2-confirm {
                background-color: var(--primary) !important;
            }
            
            .swal2-cancel {
                background-color: var(--bg-card) !important;
                color: var(--text-primary) !important;
                border: 1px solid var(--border-color) !important;
            }
            
            .review-section {
                background-color: var(--bg-card);
                border-radius: var(--radius-lg);
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
            
            .review-section h3 {
                color: var(--primary);
                margin-bottom: 1rem;
                font-size: 1.25rem;
            }
            
            .review-content {
                color: var(--text-secondary);
                line-height: 1.8;
            }
            
            .review-content .review-item {
                margin-bottom: 0.5rem;
                padding-left: 1.5rem;
                position: relative;
            }
            
            .review-content .review-item::before {
                content: "•";
                position: absolute;
                left: 0;
                color: var(--primary);
            }
        `;
        document.head.appendChild(style);
        // 2. JavaScript Functions للتعامل مع البيانات


        // دالة إضافة عرض خصم
// دالة إضافة عرض خصم محسّنة
// متغير لمنع الضغط المتكرر
let isAddingItem = false;

// دالة إضافة عرض خصم



// 4. معاينة الأسعار الحية



        // احتفظ بالدوال دي:
function renderCoupons() {
    const container = document.getElementById('couponsList');
    if (!courseData.coupons || courseData.coupons.length === 0) {
        container.innerHTML = '<p class="text-muted">لا توجد كوبونات حالياً</p>';
        return;
    }
    
    container.innerHTML = courseData.coupons.map((coupon, index) => `
        <div class="card mb-2">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge badge-primary">${coupon.code}</span>
                        <span class="ms-2">
                            ${coupon.type === 'percentage' ? `${coupon.value}%` : `${coupon.value} ${courseData.currency}`}
                        </span>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeCoupon(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function removeCoupon(index) {
    courseData.coupons.splice(index, 1);
    renderCoupons();
    updatePricePreview();
}

        function renderPaymentPlans() {
    const container = document.getElementById('paymentPlansList');
    if (!courseData.paymentPlans || courseData.paymentPlans.length === 0) {
        container.innerHTML = '<p class="text-muted">لا توجد خطط دفع حالياً</p>';
        return;
    }
    
    container.innerHTML = courseData.paymentPlans.map((plan, index) => `
        <div class="card mb-2">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5>${plan.name}</h5>
                        <p class="mb-0">
                            ${plan.installments} ${plan.installments === 1 ? 'دفعة' : 'دفعات'}
                            ${plan.frequency ? ` - ${getFrequencyText(plan.frequency)}` : ''}
                        </p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removePaymentPlan(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function removePaymentPlan(index) {
    courseData.paymentPlans.splice(index, 1);
    renderPaymentPlans();
    updatePricePreview();
}

function getFrequencyText(frequency) {
    const texts = {
        'monthly': 'شهرياً',
        'weekly': 'أسبوعياً',
        'custom': 'مخصص'
    };
    return texts[frequency] || frequency;
}
// معاينة الأسعار - الجدول الاحترافي الكامل
function updatePricePreview() {
    const basePrice = parseFloat(document.getElementById('price')?.value) || 0;
    const salePrice = parseFloat(document.getElementById('salePrice')?.value) || null;
    const currency = document.getElementById('currency')?.value || 'EGP';
    const container = document.getElementById('pricePreview');
    
    if (basePrice === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-info-circle"></i>
                <p>أدخل السعر الأساسي لعرض جدول الأسعار</p>
            </div>
        `;
        return;
    }
    
    // جمع البيانات
    const discounts = collectDiscounts();
    const groupDiscounts = collectGroupDiscounts();
    const paymentPlans = collectPaymentPlans();
    const cashDiscountEnabled = document.getElementById('enableCashDiscount')?.checked || false;
    const cashDiscountPercent = parseFloat(document.getElementById('cashDiscountPercent')?.value) || 10;
    
    // عرض السعر الأساسي أولاً
    let html = `
        <div class="pricing-table-wrapper">
            <div style="text-align: center; margin-bottom: 20px;">
                <h4 style="color: #fbbf24;">السعر الأساسي: ${formatPrice(basePrice, currency)}</h4>
                ${salePrice ? `<p style="color: #10b981;">سعر التخفيض: ${formatPrice(salePrice, currency)}</p>` : ''}
            </div>
            
            <h3 class="pricing-table-title">
                <i class="fas fa-table"></i> جدول الأسعار
            </h3>
    `;
    
    // التحقق من وجود عروض أو خطط
    const hasDiscounts = discounts.length > 0;
    const hasPaymentPlans = paymentPlans.length > 0;
    const hasGroupDiscounts = groupDiscounts.length > 0;
    
    // إذا لم توجد أي عروض، استخدم سعر التخفيض أو السعر الأساسي
    if (!hasDiscounts && !hasPaymentPlans && !hasGroupDiscounts && !cashDiscountEnabled) {
        const displayPrice = salePrice || basePrice;
        html += `
            <div class="table-responsive">
                <table class="pricing-table">
                    <thead>
                        <tr>
                            <th colspan="2">السعر الأساسي</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>السعر</td>
                            <td class="price-value">${formatPrice(displayPrice, currency)}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        `;
    } else {
        // بناء الجدول مع العروض
        html += buildFullPricingTable(basePrice, salePrice, currency, discounts, groupDiscounts, paymentPlans, cashDiscountEnabled, cashDiscountPercent);
    }
    
    // إضافة الكوبونات والمنح
    const coupons = collectCoupons();
    if (coupons.length > 0) {
        html += buildCouponsTable(coupons, basePrice, currency);
    }
    
    if (document.getElementById('enableGrants')?.checked) {
        html += buildGrantsInfo();
    }
    
    html += `</div>`;
    container.innerHTML = html;
}

function buildFullPricingTable(basePrice, salePrice, currency, discounts, groupDiscounts, paymentPlans, cashDiscountEnabled, cashDiscountPercent) {
    // إذا لم توجد عروض زمنية ولكن يوجد سعر تخفيض
    if (discounts.length === 0 && salePrice) {
        discounts.push({
            name: 'السعر بعد التخفيض',
            percentage: ((basePrice - salePrice) / basePrice) * 100
        });
    } else if (discounts.length === 0) {
        discounts.push({ name: 'السعر العادي', percentage: 0 });
    }
    
    // حساب عدد الأعمدة
    let individualColumns = 1; // على الأقل عمود واحد للسعر الأساسي
    if (cashDiscountEnabled) individualColumns++;
    individualColumns += paymentPlans.length;
    
    let groupColumns = 0;
    if (groupDiscounts.length > 0) {
        groupColumns = 1; // على الأقل عمود واحد للسعر الأساسي للمجموعة
        if (cashDiscountEnabled) groupColumns++;
        groupColumns += paymentPlans.length;
    }
    
    let html = `
        <div class="table-responsive">
            <table class="pricing-table">
                <thead>
                    <tr>
                        <th rowspan="2">وقت التسجيل</th>
    `;
    
    // إذا لم توجد خطط دفع ولا خصم نقدي ولا مجموعات
    if (!cashDiscountEnabled && paymentPlans.length === 0 && groupDiscounts.length === 0) {
        html += `<th>السعر الأساسي</th>`;
    } 
    // إذا لم توجد خطط دفع ولا خصم نقدي لكن توجد مجموعات
    else if (!cashDiscountEnabled && paymentPlans.length === 0 && groupDiscounts.length > 0) {
        html += `<th>السعر الأساسي</th>`;
        groupDiscounts.forEach(group => {
            html += `<th>مجموعة ${group.minSize}+ (خصم ${group.percentage}%)</th>`;
        });
    }
    // باقي الحالات
    else {
        if (individualColumns === 1) {
            html += `<th>السعر الأساسي</th>`;
        } else {
            html += `<th colspan="${individualColumns}">الفرد</th>`;
        }
        
        if (groupDiscounts.length > 0) {
            groupDiscounts.forEach(group => {
                if (groupColumns === 1) {
                    html += `<th>مجموعة ${group.minSize}+ (خصم ${group.percentage}%)</th>`;
                } else {
                    html += `<th colspan="${groupColumns}">مجموعة ${group.minSize}+ (خصم ${group.percentage}%)</th>`;
                }
            });
        }
    }
    
    html += `
                    </tr>
    `;
    
    // الصف الثاني من الـ headers (إذا كان مطلوباً)
    if (cashDiscountEnabled || paymentPlans.length > 0) {
        html += `<tr>`;
        
        // أعمدة الأفراد
        html += `<th>السعر الأساسي</th>`;
        if (cashDiscountEnabled) {
            html += `<th>دفع نقدي (خصم ${cashDiscountPercent}%)</th>`;
        }
        paymentPlans.forEach(plan => {
            html += `<th>${plan.name}</th>`;
        });
        
        // أعمدة المجموعات
        if (groupDiscounts.length > 0) {
            groupDiscounts.forEach(() => {
                html += `<th>السعر الأساسي</th>`;
                if (cashDiscountEnabled) {
                    html += `<th>دفع نقدي</th>`;
                }
                paymentPlans.forEach(plan => {
                    html += `<th>${plan.name}</th>`;
                });
            });
        }
        
        html += `</tr>`;
    }
    
    html += `
                </thead>
                <tbody>
    `;
    
    // بناء صفوف الجدول
    discounts.forEach((discount, index) => {
        const priceAfterDiscount = roundPrice(basePrice * (1 - discount.percentage/100));
        const rowClass = index === 0 ? 'discount-early-extra' : 
                        index === 1 ? 'discount-early' : 'discount-regular';
        
        html += `<tr class="${rowClass}">`;
        
        // اسم العرض
        html += `<td class="offer-name-cell">`;
        if (discount.name) {
            html += `<div class="offer-name">${discount.name}</div>`;
        }
        if (discount.percentage > 0) {
            html += `<span class="discount-badge">خصم ${discount.percentage}%</span>`;
        }
        if (discount.startDate || discount.endDate) {
            html += `<div class="date-range">`;
            if (discount.startDate) html += `من ${formatDate(discount.startDate)}`;
            if (discount.startDate && discount.endDate) html += ` - `;
            if (discount.endDate) html += `إلى ${formatDate(discount.endDate)}`;
            html += `</div>`;
        }
        html += `</td>`;
        
        // السعر الأساسي للفرد
        html += `<td class="base-price-cell">
            <div class="price-value">${formatPrice(priceAfterDiscount, currency)}</div>
        </td>`;
        
        // خطط الدفع للأفراد (إن وجدت)
        if (cashDiscountEnabled) {
            const cashPrice = roundPrice(priceAfterDiscount * (1 - cashDiscountPercent/100));
            html += `<td class="cash-payment">
                <div class="price-value">${formatPrice(cashPrice, currency)}</div>
            </td>`;
        }
        
        paymentPlans.forEach(plan => {
            if (plan.installments === 1) {
                const planPrice = cashDiscountEnabled ? priceAfterDiscount : roundPrice(priceAfterDiscount * (1 - cashDiscountPercent/100));
                html += `<td>
                    <div class="price-value">${formatPrice(planPrice, currency)}</div>
                </td>`;
            } else {
                const installments = calculateInstallments(priceAfterDiscount, plan.installments);
                html += `<td>
                    <div class="installment-info">${formatInstallmentText(installments, plan.installments, currency)}</div>
                </td>`;
            }
        });
        
        // أسعار المجموعات
        groupDiscounts.forEach(group => {
            const groupPrice = roundPrice(priceAfterDiscount * (1 - group.percentage/100));
            
            // إذا لم توجد خطط دفع، اعرض السعر مباشرة
            if (!cashDiscountEnabled && paymentPlans.length === 0) {
                html += `<td class="group-cell">
                    <div class="price-value">${formatPrice(groupPrice, currency)}</div>
                </td>`;
            } else {
                // السعر الأساسي للمجموعة
                html += `<td class="group-cell">
                    <div class="price-value">${formatPrice(groupPrice, currency)}</div>
                </td>`;
                
                // خصم الدفع النقدي للمجموعة
                if (cashDiscountEnabled) {
                    const groupCashPrice = roundPrice(groupPrice * (1 - cashDiscountPercent/100));
                    html += `<td class="group-cell cash-payment">
                        <div class="price-value">${formatPrice(groupCashPrice, currency)}</div>
                    </td>`;
                }
                
                // خطط الدفع للمجموعة
                paymentPlans.forEach(plan => {
                    if (plan.installments === 1) {
                        const planPrice = cashDiscountEnabled ? groupPrice : roundPrice(groupPrice * (1 - cashDiscountPercent/100));
                        html += `<td class="group-cell">
                            <div class="price-value">${formatPrice(planPrice, currency)}</div>
                        </td>`;
                    } else {
                        const installments = calculateInstallments(groupPrice, plan.installments);
                        html += `<td class="group-cell">
                            <div class="installment-info">${formatInstallmentText(installments, plan.installments, currency)}</div>
                        </td>`;
                    }
                });
            }
        });
        
        html += `</tr>`;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    return html;
}

// تحديث دالة حساب الأقساط
function calculateInstallments(totalPrice, installmentCount) {
    if (installmentCount === 1) return [totalPrice];
    
    if (installmentCount === 2) {
        const amount = roundPrice(totalPrice / 2);
        return [amount, amount];
    }
    
    if (installmentCount === 3) {
        const first = roundPrice(totalPrice * 0.4);
        const remaining = totalPrice - first;
        const second = roundPrice(remaining / 2);
        const third = totalPrice - first - second;
        return [first, second, third];
    }
    
    // للأقساط الأكثر - توزيع متساوي
    const amount = roundPrice(totalPrice / installmentCount);
    const lastAmount = totalPrice - (amount * (installmentCount - 1));
    const result = Array(installmentCount - 1).fill(amount);
    result.push(lastAmount);
    return result;
}

// تحديث دالة تنسيق الأقساط
function formatInstallmentText(prices, count, currency) {
    if (count === 1) {
        return formatPrice(prices[0], currency);
    }
    
    if (count === 2) {
        return `${formatPrice(prices[0], currency)} × 2`;
    }
    
    if (count === 3 && prices[0] !== prices[1]) {
        // عرض مفصل للـ 3 أقساط المختلفة
        return `${formatPrice(prices[0], currency)} + ${formatPrice(prices[1], currency)} × 2`;
    }
    
    // للأقساط المتساوية
    return `${formatPrice(prices[0], currency)} × ${count}`;
}
        
// دالة مبسطة لمعلومات المنح
function buildGrantsInfo() {
    const grantSeats = document.getElementById('grantSeats')?.value || 0;
    const supportTypes = [];
    
    if (document.getElementById('grantDiscount')?.checked) supportTypes.push('خصومات مرنة');
    if (document.getElementById('grantInstallments')?.checked) supportTypes.push('تقسيط ميسر');
    if (document.getElementById('grantDeferred')?.checked) supportTypes.push('تأجيل السداد');
    if (document.getElementById('grantService')?.checked) supportTypes.push('خدمات مقابل');
    
    return `
        <div class="grants-info mt-4">
            <h4 class="sub-table-title">
                <i class="fas fa-hands-helping"></i> برنامج المنح الدراسية
            </h4>
            <div class="alert alert-info">
                <p><strong>عدد المقاعد:</strong> ${grantSeats} مقعد للمنح</p>
                <p><strong>أنواع الدعم:</strong> ${supportTypes.join(' • ') || 'لم يتم تحديد'}</p>
            </div>
        </div>
    `;
}

// دوال مساعدة محسّنة
// دالة تقريب الأسعار
function roundPrice(price) {
    // تقريب لأقرب 10
    return Math.round(price / 10) * 10;
}




// دالة بناء جدول المنح
function buildGrantsTable() {
    // جمع بيانات المنح من الحقول
    const grantSeats = parseInt(document.getElementById('grantSeats')?.value) || 0;
    const totalSeats = parseInt(document.getElementById('totalSeats')?.value) || 0;
    
    // أنواع الدعم
    const supportTypes = [];
    if (document.getElementById('grantDiscount')?.checked) supportTypes.push('خصومات مرنة');
    if (document.getElementById('grantInstallments')?.checked) supportTypes.push('تقسيط ميسر');
    if (document.getElementById('grantDeferred')?.checked) supportTypes.push('تأجيل السداد');
    if (document.getElementById('grantService')?.checked) supportTypes.push('خدمات مقابل المنحة');
    
    // معايير التقييم
    const criteria = [];
    if (document.getElementById('criteriaFinancial')?.checked) criteria.push('الحاجة المالية');
    if (document.getElementById('criteriaMotivation')?.checked) criteria.push('الدافع والالتزام');
    if (document.getElementById('criteriaImpact')?.checked) criteria.push('الأثر المتوقع');
    if (document.getElementById('criteriaHistory')?.checked) criteria.push('التاريخ مع المنظور');
    
    let html = `
        <h4 class="sub-table-title mt-4">
            <i class="fas fa-hands-helping"></i> برنامج المنح الدراسية
        </h4>
    `;
    
    if (supportTypes.length > 0 || criteria.length > 0) {
        html += `
            <div class="table-responsive">
                <table class="sub-table grants-table">
                    <thead>
                        <tr>
                            <th>تفاصيل البرنامج</th>
                            <th>القيمة</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>عدد المقاعد المتاحة</td>
                            <td>${grantSeats} من أصل ${totalSeats} مقعد</td>
                        </tr>
                        <tr>
                            <td>أنواع الدعم المتاحة</td>
                            <td>${supportTypes.join(' • ') || 'غير محدد'}</td>
                        </tr>
                        <tr>
                            <td>معايير التقييم</td>
                            <td>${criteria.join(' • ') || 'غير محدد'}</td>
                        </tr>
                        <tr>
                            <td>طريقة التقديم</td>
                            <td>${document.getElementById('grantFormUrl')?.value ? 'استمارة إلكترونية' : 'نموذج مدمج في الموقع'}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        `;
    } else {
        html += `
            <div class="alert alert-info">
                <p>برنامج المنح متاح - يتم تصميم خطط مخصصة حسب كل حالة</p>
            </div>
        `;
    }
    
    return html;
}
function buildCouponsTable(coupons, basePrice, currency) {
    let html = `
        <h4 class="sub-table-title mt-4">
            <i class="fas fa-tags"></i> كوبونات الخصم المتاحة
        </h4>
        <div class="table-responsive">
            <table class="sub-table coupons-table">
                <thead>
                    <tr>
                        <th>كود الكوبون</th>
                        <th>نوع الخصم</th>
                        <th>القيمة</th>
                        <th>السعر بعد الخصم</th>
                        <th>العدد المتاح</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    coupons.forEach(coupon => {
        let finalPrice;
        if (coupon.type === 'percentage') {
            finalPrice = roundPrice(basePrice * (1 - coupon.value/100));
        } else {
            finalPrice = roundPrice(basePrice - coupon.value);
        }
        
        html += `
            <tr>
                <td class="coupon-code">${coupon.code}</td>
                <td>${coupon.type === 'percentage' ? 'نسبة مئوية' : 'مبلغ ثابت'}</td>
                <td>${coupon.type === 'percentage' ? coupon.value + '%' : formatPrice(coupon.value, currency)}</td>
                <td class="price-value">${formatPrice(finalPrice, currency)}</td>
                <td>${coupon.limit || 'غير محدود'}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    return html;
}

function buildGrantsTable() {
    const grantPlans = collectGrantPlans();
    
    if (grantPlans.length === 0) {
        return `
            <div class="grants-info mt-4">
                <h4 class="sub-table-title">
                    <i class="fas fa-hands-helping"></i> برنامج المنح الدراسية
                </h4>
                <div class="alert alert-info">
                    <p>برنامج المنح متاح - يتم تصميم خطط مخصصة حسب كل حالة</p>
                </div>
            </div>
        `;
    }
    
    let html = `
        <h4 class="sub-table-title mt-4">
            <i class="fas fa-hands-helping"></i> خطط المنح المتاحة
        </h4>
        <div class="table-responsive">
            <table class="sub-table grants-table">
                <thead>
                    <tr>
                        <th>اسم المنحة</th>
                        <th>نوع الدعم</th>
                        <th>التفاصيل</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    grantPlans.forEach(plan => {
        html += `
            <tr>
                <td>${plan.name}</td>
                <td>${plan.type}</td>
                <td>${plan.details}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    return html;
}

function collectGrantPlans() {
    const plans = [];
    
    // التحقق من تفعيل المنح
    if (!document.getElementById('enableGrants')?.checked) {
        return plans;
    }
    
    // جمع البيانات من الحقول الموجودة
    const grantSeats = parseInt(document.getElementById('grantSeats')?.value) || 0;
    const totalSeats = parseInt(document.getElementById('totalSeats')?.value) || 0;
    
    // أنواع الدعم المحددة
    const supportTypes = [];
    if (document.getElementById('grantDiscount')?.checked) {
        supportTypes.push('خصومات مرنة');
    }
    if (document.getElementById('grantInstallments')?.checked) {
        supportTypes.push('تقسيط ميسر');
    }
    if (document.getElementById('grantDeferred')?.checked) {
        supportTypes.push('تأجيل السداد');
    }
    if (document.getElementById('grantService')?.checked) {
        supportTypes.push('خدمات مقابل المنحة');
    }
    
    // معايير التقييم
    const criteria = [];
    if (document.getElementById('criteriaFinancial')?.checked) {
        criteria.push('الحاجة المالية');
    }
    if (document.getElementById('criteriaMotivation')?.checked) {
        criteria.push('الدافع والالتزام');
    }
    if (document.getElementById('criteriaImpact')?.checked) {
        criteria.push('الأثر المتوقع');
    }
    if (document.getElementById('criteriaHistory')?.checked) {
        criteria.push('التاريخ مع المنظور');
    }
    
    // إضافة خطة المنح إذا كانت مفعلة
    if (supportTypes.length > 0 || criteria.length > 0) {
        plans.push({
            name: 'برنامج المنح المرن',
            type: supportTypes.join(' • ') || 'دعم مخصص',
            details: `${grantSeats} مقاعد من أصل ${totalSeats} • معايير: ${criteria.join(', ') || 'حسب الحالة'}`
        });
    }
    
    return plans;
}

// دوال مساعدة جديدة
function collectDiscounts() {
    const discounts = [];
    document.querySelectorAll('#discountsList .card').forEach(card => {
        const name = card.querySelector('input[placeholder="اسم العرض"]')?.value || '';
        const percentage = parseFloat(card.querySelector('input[type="number"][min="0"][max="100"]')?.value) || 0;
        const startDate = card.querySelector('input[type="date"]:first-of-type')?.value || '';
        const endDate = card.querySelector('input[type="date"]:last-of-type')?.value || '';
        
        if (name || percentage > 0) {
            discounts.push({ name, percentage, startDate, endDate });
        }
    });
    
    // إضافة السعر العادي إذا لم توجد عروض
    if (discounts.length === 0) {
        discounts.push({
            name: 'السعر العادي',
            percentage: 0,
            startDate: '',
            endDate: ''
        });
    }
    
    return discounts;
}

function collectGroupDiscounts() {
    const groupDiscounts = [];
    document.querySelectorAll('#groupDiscountsList .card').forEach(card => {
        const name = card.querySelector('input[placeholder="اسم عرض المجموعة"]')?.value || '';
        const minSize = parseInt(card.querySelector('input[type="number"][min="2"]')?.value) || 3;
        const percentage = parseFloat(card.querySelector('.input-group input[type="number"]')?.value) || 0;
        
        if (percentage > 0) {
            groupDiscounts.push({ name, minSize, percentage });
        }
    });
    return groupDiscounts;
}

function collectPaymentPlans() {
    const plans = [];
    document.querySelectorAll('#paymentPlansList .card').forEach(card => {
        const name = card.querySelector('h5')?.textContent || '';
        const installmentsText = card.querySelector('p')?.textContent || '';
        const installments = parseInt(installmentsText.match(/\d+/)?.[0]) || 1;
        
        plans.push({ 
            name: name,
            installments: installments,
            isFullPayment: installments === 1
        });
    });
    
       
    return plans;
}

function collectCoupons() {
    const coupons = [];
    document.querySelectorAll('#couponsList .card').forEach(card => {
        const code = card.querySelector('.badge')?.textContent || '';
        const valueText = card.querySelector('.ms-2')?.textContent || '';
        const type = valueText.includes('%') ? 'percentage' : 'fixed';
        const value = parseFloat(valueText.match(/\d+/)?.[0]) || 0;
        
        if (code && value > 0) {
            coupons.push({ code, type, value });
        }
    });
    return coupons;
}

function calculateDiscountedPrice(basePrice, discountPercentage) {
    return basePrice * (1 - discountPercentage / 100);
}

function calculatePlanPrice(price, plan) {
    if (plan.isFullPayment) {
        // خصم 10% للدفع الكامل
        const cashPrice = price * 0.9;
        return `
            <div class="cash-payment">
                <div class="price-value">${formatPrice(cashPrice, 'EGP')}</div>
                <small class="discount-note">خصم 10%</small>
            </div>
        `;
    } else {
        // الأقساط بدون خصم
        const installmentAmount = price / plan.installments;
        return `
            <div class="installment-payment">
                <div class="price-value">${plan.installments} × ${formatPrice(installmentAmount, 'EGP')}</div>
            </div>
        `;
    }
}

function calculateGroupPrice(basePrice, groupDiscount) {
    return basePrice * (1 - groupDiscount / 100);
}



function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-EG', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    });
}



// دالة التقريب التسويقي
function marketingRound(price) {
    if (price < 100) return Math.round(price);
    if (price < 1000) {
        // 299, 399, 499, etc
        return Math.floor(price / 100) * 100 + 99;
    }
    if (price < 10000) {
        // 2900, 3900, 4900, etc
        return Math.floor(price / 1000) * 1000 + 900;
    }
    // 19900, 29900, etc
    return Math.floor(price / 10000) * 10000 + 9900;
}

// دالة تنسيق التاريخ
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-EG', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    });
}

// دالة تنسيق السعر
function formatPrice(price, currency = 'EGP') {
    const symbols = {
        'EGP': 'ج.م',
        'SAR': 'ر.س',
        'USD': '$',
        'EUR': '€',
        'AED': 'د.إ'
    };
    return `${price.toLocaleString('ar-EG')} ${symbols[currency] || currency}`;
}

// دوال مساعدة للجدول
function generatePaymentOption(plan, price, currency) {
    if (plan.installments === 1) {
        const cashPrice = marketingRound(price * (1 - plan.discount/100));
        return `
            <div class="payment-option cash-option">
                <span class="option-label">${plan.name}</span>
                <span class="option-price">${formatPrice(cashPrice, currency)}</span>
                ${plan.discount > 0 ? `<span class="discount-badge">خصم ${plan.discount}%</span>` : ''}
            </div>
        `;
    } else {
        const installmentAmount = marketingRound(price / plan.installments);
        return `
            <div class="payment-option">
                <span class="option-label">${plan.name}</span>
                <span class="option-price">${plan.installments} × ${formatPrice(installmentAmount, currency)}</span>
            </div>
        `;
    }
}

function generateGroupPaymentOption(plan, groupPrice, currency) {
    if (plan.installments === 1 && plan.discount > 0) {
        const cashPrice = marketingRound(groupPrice * (1 - plan.discount/100));
        return `
            <div class="payment-option group-payment">
                <span class="option-price">${formatPrice(cashPrice, currency)}</span>
            </div>
        `;
    } else {
        const installmentAmount = marketingRound(groupPrice / plan.installments);
        return `
            <div class="payment-option group-payment">
                <span class="option-price">${plan.installments} × ${formatPrice(installmentAmount, currency)}</span>
            </div>
        `;
    }
}

function formatGrantPaymentDetails(plan, totalPrice, currency) {
    if (plan.installments === 1) {
        return `دفعة واحدة: ${formatPrice(totalPrice, currency)}`;
    } else {
        const firstPayment = marketingRound(totalPrice * plan.firstPayment / 100);
        const remainingAmount = totalPrice - firstPayment;
        const monthlyPayment = marketingRound(remainingAmount / (plan.installments - 1));
        
        return `
            دفعة أولى: ${formatPrice(firstPayment, currency)}<br>
            ثم ${plan.installments - 1} أقساط × ${formatPrice(monthlyPayment, currency)}
        `;
    }
}

function calculateCouponPrice(basePrice, coupon) {
    if (coupon.type === 'percentage') {
        return basePrice * (1 - coupon.value / 100);
    } else {
        return Math.max(0, basePrice - coupon.value);
    }
}




// Event listener للمنح
window.addEventListener('load', function() {
    setTimeout(function() {
        const enableGrantsCheckbox = document.getElementById('enableGrants');
        if (enableGrantsCheckbox) {
            enableGrantsCheckbox.addEventListener('change', function() {
                const grantsSettings = document.getElementById('grantsSettings');
                if (grantsSettings) {
                    grantsSettings.style.display = this.checked ? 'block' : 'none';
                    updatePricePreview();
                }
            });
        }
    }, 1000);
});

        // ========================================
// دوال جمع البيانات Helper Functions
// ========================================



// دالة جمع إعدادات المجموعات
function collectGroupSettings() {
    const groups = [];
    
    if (courseData.groupDiscounts && courseData.groupDiscounts.length > 0) {
        courseData.groupDiscounts.forEach(group => {
            groups.push({
                enabled: true,
                name: group.name || `مجموعة ${group.minSize}+ أشخاص`,
                minSize: group.minSize,
                discount: group.percentage
            });
        });
    }
    
    return groups;
}




// دالة تنسيق الأقساط
function formatInstallments(totalPrice, plan, currency) {
    const installment = marketingRound(totalPrice / plan.installments);
    return `${plan.installments} × ${formatPrice(installment, currency)}`;
}

// ========================================
// التكامل مع collectFormData
// ========================================

// أضف هذا في نهاية دالة collectFormData الموجودة
function updateCollectFormDataForPricing() {
    // جمع بيانات التسعير
    courseData.priceType = document.getElementById('priceType')?.value || 'free';
    courseData.currency = document.getElementById('currency')?.value || 'EGP';
    courseData.price = parseFloat(document.getElementById('price')?.value) || 0;
    courseData.salePrice = parseFloat(document.getElementById('salePrice')?.value) || null;
    
    // خصم الدفع الكامل
    courseData.cashDiscount = {
        enabled: document.getElementById('enableCashDiscount')?.checked || false,
        percentage: parseInt(document.getElementById('cashDiscountPercent')?.value) || 0
    };
    
    // الخصومات الزمنية تم جمعها بالفعل في courseData.discounts
    // خصومات المجموعات تم جمعها بالفعل في courseData.groupDiscounts
    // خطط الدفع تم جمعها بالفعل في courseData.paymentPlans
    // الكوبونات تم جمعها بالفعل في courseData.coupons
    // خطط المنح تم جمعها بالفعل في courseData.grantPlans
}

        // ========================================
// نظام التسعير الجديد
// ========================================

// تحديث حقول التسعير
function updatePricingFields() {
    const priceType = document.getElementById('priceType').value;
    const priceField = document.getElementById('priceField');
    const salePriceField = document.getElementById('salePriceField');
    
    if (priceType === 'free') {
        priceField.style.display = 'none';
        salePriceField.style.display = 'none';
    } else {
        priceField.style.display = 'block';
        salePriceField.style.display = 'block';
    }
    
    courseData.priceType = priceType;
    updatePricePreview();
}

// تحديث تسمية العملة
function updateCurrencyLabel() {
    const currency = document.getElementById('currency').value;
    document.getElementById('currencyLabel').textContent = currency;
    courseData.currency = currency;
    updatePricePreview();
}

// خصم الدفع الكامل
function toggleCashDiscount() {
    const enabled = document.getElementById('enableCashDiscount').checked;
    document.getElementById('cashDiscountSection').style.display = enabled ? 'block' : 'none';
    updatePricePreview();
}

// إضافة عرض خصم



function renderDiscounts() {
    const container = document.getElementById('discountsList');
    if (!container) return;
    
    // إفراغ المحتوى أولاً لمنع التكرار
    container.innerHTML = '';
    
    if (!courseData.discounts || courseData.discounts.length === 0) {
        container.innerHTML = '<p class="text-muted">لا توجد عروض خصم حالياً</p>';
        return;
    }
    
    // عرض الخصومات الموجودة فقط - بدون إضافة عناصر فارغة
    courseData.discounts.forEach((discount, index) => {
        // تخطي العناصر الفارغة تماماً
        if (!discount || (!discount.name && !discount.percentage && !discount.startDate && !discount.endDate)) {
            return;
        }
        
        const discountHTML = `
            <div class="card mb-2" data-discount-index="${index}">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <input type="text" class="form-control" placeholder="اسم العرض"
                                   value="${discount.name || ''}" 
                                   onchange="updateDiscountField(${index}, 'name', this.value)">
                        </div>
                        <div class="col-md-2">
                            <div class="input-group">
                                <input type="number" class="form-control" 
                                       value="${discount.percentage || 0}"
                                       min="0" max="100" 
                                       onchange="updateDiscountField(${index}, 'percentage', parseInt(this.value) || 0)">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" 
                                   value="${discount.startDate || ''}"
                                   onchange="updateDiscountField(${index}, 'startDate', this.value)">
                            <small class="text-muted">من تاريخ</small>
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" 
                                   value="${discount.endDate || ''}"
                                   onchange="updateDiscountField(${index}, 'endDate', this.value)">
                            <small class="text-muted">إلى تاريخ</small>
                        </div>
                        <div class="col-md-1">
                            <button class="btn btn-danger btn-sm" onclick="removeDiscount(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', discountHTML);
    });
}

        // دالة تحديث حقل خصم محدد
function updateDiscountField(index, field, value) {
    if (!courseData.discounts[index]) {
        courseData.discounts[index] = {};
    }
    
    courseData.discounts[index][field] = value;
    updatePricePreview();
    autoSave();
}
        

function addDiscountTier() {
    // منع الإضافة المتكررة
    if (isAddingItem) return;
    isAddingItem = true;
    
    const discount = {
        id: 'discount_' + Date.now(),
        name: '',
        percentage: 0,
        startDate: '',
        endDate: ''
    };
    
    if (!courseData.discounts) courseData.discounts = [];
    courseData.discounts.push(discount);
    
    renderDiscounts();
    updatePricePreview();
    
    // السماح بالإضافة مرة أخرى بعد قليل
    setTimeout(() => {
        isAddingItem = false;
    }, 300);
}
        
function removeDiscount(index) {
    courseData.discounts.splice(index, 1);
    renderDiscounts();
    updatePricePreview();
}

// خصومات المجموعات
function addGroupDiscount() {
    // منع الإضافة المتكررة
    if (isAddingItem) return;
    isAddingItem = true;
    
    const groupDiscount = {
        id: 'group_' + Date.now(),
        name: '',
        minSize: 3,
        percentage: 0
    };
    
    if (!courseData.groupDiscounts) courseData.groupDiscounts = [];
    courseData.groupDiscounts.push(groupDiscount);
    
    renderGroupDiscounts();
    updatePricePreview();
    
    // السماح بالإضافة مرة أخرى بعد قليل
    setTimeout(() => {
        isAddingItem = false;
    }, 300);
}

        function removeGroupDiscount(index) {
    courseData.groupDiscounts.splice(index, 1);
    renderGroupDiscounts();
    updatePricePreview();
}

function renderGroupDiscounts() {
    const container = document.getElementById('groupDiscountsList');
    if (!container) return;
    
    // إفراغ المحتوى أولاً لمنع التكرار
    container.innerHTML = '';
    
    if (!courseData.groupDiscounts || courseData.groupDiscounts.length === 0) {
        container.innerHTML = '<p class="text-muted">لا توجد عروض مجموعات حالياً</p>';
        return;
    }
    
    // عرض خصومات المجموعات الموجودة فقط - بدون إضافة عناصر فارغة
    courseData.groupDiscounts.forEach((group, index) => {
        // تخطي العناصر الفارغة تماماً
        if (!group || (!group.name && !group.minSize && !group.percentage)) {
            return;
        }
        
        const groupHTML = `
            <div class="card mb-2">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <input type="text" class="form-control" placeholder="اسم عرض المجموعة"
                                   value="${group.name || ''}" 
                                   onchange="updateGroupField(${index}, 'name', this.value)">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">الحد الأدنى للمجموعة</label>
                            <input type="number" class="form-control" 
                                   value="${group.minSize || 3}"
                                   min="2" 
                                   onchange="updateGroupField(${index}, 'minSize', parseInt(this.value) || 3)">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">نسبة الخصم</label>
                            <div class="input-group">
                                <input type="number" class="form-control" 
                                       value="${group.percentage || 0}"
                                       min="0" max="100" 
                                       onchange="updateGroupField(${index}, 'percentage', parseInt(this.value) || 0)">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-md-2 text-end">
                            <button class="btn btn-danger btn-sm" onclick="removeGroupDiscount(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', groupHTML);
    });
}

        // دالة تحديث حقل خصم مجموعة محدد
function updateGroupField(index, field, value) {
    if (!courseData.groupDiscounts[index]) {
        courseData.groupDiscounts[index] = {};
    }
    
    courseData.groupDiscounts[index][field] = value;
    updatePricePreview();
    autoSave();
}

        

// برنامج المنح
function toggleGrants() {
    // انتظر لو الصفحة لسه بتحمل
    if (!document.getElementById('enableGrants')) {
        console.log('Grants elements not ready yet');
        return;
    }
    
    const enabled = document.getElementById('enableGrants').checked;
    const grantsDiv = document.getElementById('grantsSettings') || document.getElementById('grantsSection');
    
    if (grantsDiv) {
        grantsDiv.style.display = enabled ? 'block' : 'none';
    } else {
        console.error('Grants div not found!');
    }
    
    // تحديث معاينة الأسعار فقط لو الدالة موجودة
    if (typeof updatePricePreview === 'function') {
        updatePricePreview();
    }
}

// دوال مساعدة


function getFrequencyText(frequency) {
    const texts = {
        'monthly': 'شهرياً',
        'weekly': 'أسبوعياً',
        'custom': 'مخصص'
    };
    return texts[frequency] || frequency;
}

// متغير لتتبع التغييرات
let hasUnsavedChanges = false;

// دالة لتسجيل التغييرات
function markAsChanged() {
    hasUnsavedChanges = true;
    autoSave();
}
        // إصلاح مشكلة خطط الدفع
window.addPaymentPlan = function() {
    if (typeof Swal === 'undefined') {
        alert('مكتبة SweetAlert غير محملة. تأكد من تحميل الصفحة بالكامل.');
        return;
    }
    
    Swal.fire({
        title: 'إضافة خطة دفع جديدة',
        html: `
            <div class="form-group mb-3">
                <label>اسم الخطة</label>
                <input type="text" id="planName" class="swal2-input" 
                       placeholder="مثال: دفعتين شهريتين">
            </div>
            
            <div class="form-group mb-3">
                <label>عدد الدفعات</label>
                <input type="number" id="installments" class="swal2-input" 
                       value="2" min="2" max="12">
            </div>
            
            <div class="form-group mb-3">
                <label>التكرار</label>
                <select id="frequency" class="swal2-select">
                    <option value="monthly">شهري</option>
                    <option value="weekly">أسبوعي</option>
                    <option value="custom">مخصص</option>
                </select>
            </div>
        `,
        confirmButtonText: 'إضافة',
        showCancelButton: true,
        cancelButtonText: 'إلغاء',
        confirmButtonColor: '#6366f1',
        preConfirm: () => {
            const plan = {
                id: 'plan_' + Date.now(),
                name: document.getElementById('planName').value,
                installments: parseInt(document.getElementById('installments').value),
                frequency: document.getElementById('frequency').value
            };
            
            if (!plan.name) {
                Swal.showValidationMessage('يرجى إدخال اسم الخطة');
                return false;
            }
            
            return plan;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            if (!courseData.paymentPlans) courseData.paymentPlans = [];
            courseData.paymentPlans.push(result.value);
            renderPaymentPlans();
            updatePricePreview();
        }
    });
};

// إصلاح مشكلة خطط المنح
window.addGrantPlan = function() {
    if (typeof Swal === 'undefined') {
        alert('مكتبة SweetAlert غير محملة. تأكد من تحميل الصفحة بالكامل.');
        return;
    }
    
    Swal.fire({
        title: 'إضافة خطة منحة',
        html: `
            <div class="form-group mb-3">
                <label>اسم الخطة</label>
                <input type="text" id="grantName" class="swal2-input" 
                       placeholder="مثال: منحة الطلاب المتفوقين">
            </div>
            
            <div class="form-group mb-3">
                <label>نوع الخصم</label>
                <select id="grantDiscountType" class="swal2-select" onchange="toggleGrantDiscountFields()">
                    <option value="percentage">نسبة مئوية</option>
                    <option value="fixed">مبلغ ثابت</option>
                </select>
            </div>
            
            <div class="form-group mb-3" id="grantPercentageField">
                <label>نسبة الخصم (%)</label>
                <input type="number" id="grantPercentage" class="swal2-input" 
                       value="50" min="0" max="100">
            </div>
            
            <div class="form-group mb-3" id="grantFixedField" style="display: none;">
                <label>مبلغ الخصم</label>
                <input type="number" id="grantFixed" class="swal2-input" 
                       placeholder="المبلغ">
            </div>
            
            <div class="form-group mb-3">
                <label>عدد الأقساط</label>
                <input type="number" id="grantInstallments" class="swal2-input" 
                       value="6" min="1" max="24">
            </div>
            
            <div class="form-group mb-3">
                <label>الدفعة الأولى (%)</label>
                <input type="number" id="grantFirstPayment" class="swal2-input" 
                       value="20" min="0" max="100">
                <small>باقي المبلغ سيوزع على الأقساط المتبقية</small>
            </div>
        `,
        confirmButtonText: 'إضافة',
        showCancelButton: true,
        cancelButtonText: 'إلغاء',
        confirmButtonColor: '#6366f1',
        didOpen: () => {
            window.toggleGrantDiscountFields = function() {
                const type = document.getElementById('grantDiscountType').value;
                document.getElementById('grantPercentageField').style.display = 
                    type === 'percentage' ? 'block' : 'none';
                document.getElementById('grantFixedField').style.display = 
                    type === 'fixed' ? 'block' : 'none';
            };
        },
        preConfirm: () => {
            const plan = {
                id: 'grant_' + Date.now(),
                name: document.getElementById('grantName').value,
                discountType: document.getElementById('grantDiscountType').value,
                percentage: document.getElementById('grantDiscountType').value === 'percentage' 
                    ? parseInt(document.getElementById('grantPercentage').value) : 0,
                fixedAmount: document.getElementById('grantDiscountType').value === 'fixed' 
                    ? parseInt(document.getElementById('grantFixed').value) : 0,
                installments: parseInt(document.getElementById('grantInstallments').value),
                firstPayment: parseInt(document.getElementById('grantFirstPayment').value)
            };
            
            if (!plan.name) {
                Swal.showValidationMessage('يرجى إدخال اسم الخطة');
                return false;
            }
            
            if (plan.discountType === 'percentage' && (!plan.percentage || plan.percentage === 0)) {
                Swal.showValidationMessage('يرجى إدخال نسبة الخصم');
                return false;
            }
            
            if (plan.discountType === 'fixed' && (!plan.fixedAmount || plan.fixedAmount === 0)) {
                Swal.showValidationMessage('يرجى إدخال مبلغ الخصم');
                return false;
            }
            
            return plan;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            if (!courseData.grantPlans) courseData.grantPlans = [];
            courseData.grantPlans.push(result.value);
            renderGrantPlans();
            updatePricePreview();
        }
    });
};
// تهيئة مصفوفة خطط المنح
if (!courseData.grantPlans) courseData.grantPlans = [];

// دالة عرض خطط المنح
function renderGrantPlans() {
    const container = document.getElementById('grantPlansList');
    if (!courseData.grantPlans || courseData.grantPlans.length === 0) {
        container.innerHTML = '<p class="text-muted">لا توجد خطط منح حالياً</p>';
        return;
    }
    
    container.innerHTML = courseData.grantPlans.map((plan, index) => `
        <div class="card mb-2">
            <div class="card-body">
                <h5>${plan.name}</h5>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1">
                            <strong>نوع الخصم:</strong> 
                            ${plan.discountType === 'percentage' ? `${plan.percentage}%` : `${plan.fixedAmount} ${courseData.currency}`}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1">
                            <strong>الأقساط:</strong> ${plan.installments} 
                            ${plan.installments === 1 ? 'دفعة' : 'دفعات'}
                        </p>
                    </div>
                </div>
                ${plan.firstPayment > 0 ? `<p class="mb-0"><small>الدفعة الأولى: ${plan.firstPayment}%</small></p>` : ''}
                
                <button class="btn btn-sm btn-danger mt-2" onclick="removeGrantPlan(${index})">
                    <i class="fas fa-trash"></i> حذف
                </button>
            </div>
        </div>
    `).join('');
}

// دالة حذف خطة منحة
function removeGrantPlan(index) {
    courseData.grantPlans.splice(index, 1);
    renderGrantPlans();
    updatePricePreview();
}


// تحذير قبل مغادرة الصفحة
window.addEventListener('beforeunload', (e) => {
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'لديك تغييرات غير محفوظة. هل تريد المغادرة؟';
    }
});

// نظام debug
const DEBUG_MODE = true;

function debugLog(...args) {
    if (DEBUG_MODE) {
        console.log('[Course Builder]', new Date().toLocaleTimeString(), ...args);
    }
}
    
    </script>
</body>
</html>
