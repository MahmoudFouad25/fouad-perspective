<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Builder - ملاذ الحياري</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #8B5CF6;
            --primary-dark: #7C3AED;
            --primary-light: #A78BFA;
            --secondary: #10B981;
            --secondary-dark: #059669;
            --secondary-light: #34D399;
            --accent: #F59E0B;
            --accent-dark: #D97706;
            --accent-light: #FCD34D;
            --danger: #EF4444;
            --danger-dark: #DC2626;
            --danger-light: #F87171;
            --dark: #111827;
            --gray-900: #1F2937;
            --gray-800: #374151;
            --gray-700: #4B5563;
            --gray-600: #6B7280;
            --gray-500: #9CA3AF;
            --gray-400: #D1D5DB;
            --gray-300: #E5E7EB;
            --gray-200: #F3F4F6;
            --gray-100: #F9FAFB;
            --white: #FFFFFF;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --transition: all 0.2s ease;
            --transition-slow: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Cairo', sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Top Bar */
        .top-bar {
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            height: 64px;
            background: var(--white);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            z-index: 1000;
            box-shadow: var(--shadow-sm);
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-600);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
        }

        .back-btn:hover {
            color: var(--primary);
        }

        .course-title-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .course-title-bar h1 {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--gray-900);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .status-badge.draft {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .status-badge.published {
            background: rgba(16, 185, 129, 0.1);
            color: var(--secondary);
        }

        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .auto-save-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-500);
            font-size: 0.875rem;
        }

        .auto-save-indicator.saving {
            color: var(--accent);
        }

        .auto-save-indicator.saved {
            color: var(--secondary);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinning {
            animation: spin 1s linear infinite;
        }

        /* Action Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        .btn-success {
            background: var(--secondary);
            color: white;
        }

        .btn-success:hover {
            background: var(--secondary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: var(--danger-dark);
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
        }

        .btn-lg {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-top: 64px;
            display: flex;
        }

        /* Sidebar Navigation */
        .sidebar-nav {
            width: 280px;
            background: var(--white);
            border-right: 1px solid var(--gray-200);
            overflow-y: auto;
            position: sticky;
            top: 64px;
            height: calc(100vh - 64px);
        }

        .sidebar-progress {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .progress-label {
            font-weight: 600;
            color: var(--gray-700);
        }

        .progress-value {
            font-weight: 700;
            color: var(--primary);
        }

        .progress-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: var(--gray-600);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
            position: relative;
        }

        .menu-item:hover {
            background: var(--gray-50);
            color: var(--gray-900);
        }

        .menu-item.active {
            background: rgba(139, 92, 246, 0.1);
            color: var(--primary);
            border-right: 3px solid var(--primary);
        }

        .menu-item i {
            width: 20px;
            margin-left: 0.75rem;
            font-size: 1.1rem;
        }

        .menu-item .badge {
            margin-right: auto;
            background: var(--gray-200);
            color: var(--gray-700);
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .menu-item.active .badge {
            background: var(--primary);
            color: white;
        }

        .menu-divider {
            margin: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* Tabs */
        .tabs-container {
            background: var(--white);
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .tabs-header {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
            padding: 0 1rem;
        }

        .tab-button {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            color: var(--gray-600);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            font-family: inherit;
        }

        .tab-button:hover {
            color: var(--gray-900);
        }

        .tab-button.active {
            color: var(--primary);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            right: 0;
            left: 0;
            height: 3px;
            background: var(--primary);
        }

        .tab-content {
            padding: 2rem;
        }

        /* Form Elements */
        .form-section {
            margin-bottom: 2rem;
        }

        .form-section-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
        }

        .form-label.required::after {
            content: ' *';
            color: var(--danger);
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-family: inherit;
            font-size: 0.875rem;
            transition: var(--transition);
            background: white;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-helper {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .form-error {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--danger);
        }

        /* Image Upload */
        .image-upload {
            border: 2px dashed var(--gray-300);
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            background: var(--gray-50);
        }

        .image-upload:hover {
            border-color: var(--primary);
            background: rgba(139, 92, 246, 0.05);
        }

        .image-upload.dragover {
            border-color: var(--primary);
            background: rgba(139, 92, 246, 0.1);
        }

        .upload-icon {
            font-size: 2.5rem;
            color: var(--gray-400);
            margin-bottom: 1rem;
        }

        .upload-text {
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .image-preview {
            position: relative;
            border-radius: 0.5rem;
            overflow: hidden;
            background: var(--gray-100);
        }

        .image-preview img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .image-actions {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        /* Curriculum Builder */
        .curriculum-container {
            background: var(--white);
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            padding: 2rem;
        }

        .curriculum-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .curriculum-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .curriculum-actions {
            display: flex;
            gap: 0.75rem;
        }

        /* Module */
        .module {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            overflow: hidden;
            transition: var(--transition);
        }

        .module.dragging {
            opacity: 0.5;
        }

        .module-header {
            padding: 1rem;
            background: white;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: move;
        }

        .drag-handle {
            color: var(--gray-400);
            cursor: move;
        }

        .module-info {
            flex: 1;
        }

        .module-title {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .module-meta {
            font-size: 0.75rem;
            color: var(--gray-500);
            display: flex;
            gap: 1rem;
        }

        .module-actions {
            display: flex;
            gap: 0.5rem;
        }

        .module-content {
            padding: 1rem;
        }

        /* Lesson */
        .lesson {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: var(--transition);
        }

        .lesson:hover {
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .lesson.dragging {
            opacity: 0.5;
        }

        .lesson-icon {
            width: 40px;
            height: 40px;
            background: var(--gray-100);
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
            flex-shrink: 0;
        }

        .lesson-icon.video {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .lesson-icon.text {
            background: rgba(59, 130, 246, 0.1);
            color: #3B82F6;
        }

        .lesson-icon.quiz {
            background: rgba(245, 158, 11, 0.1);
            color: var(--accent);
        }

        .lesson-icon.assignment {
            background: rgba(139, 92, 246, 0.1);
            color: var(--primary);
        }

        .lesson-info {
            flex: 1;
        }

        .lesson-title {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .lesson-duration {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .lesson-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: var(--transition);
        }

        .lesson:hover .lesson-actions {
            opacity: 1;
        }

        /* Add Content Menu */
        .add-content-btn {
            width: 100%;
            padding: 0.75rem;
            border: 2px dashed var(--gray-300);
            background: white;
            border-radius: 0.375rem;
            color: var(--gray-600);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .add-content-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(139, 92, 246, 0.05);
        }

        .content-menu {
            position: absolute;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            padding: 0.5rem;
            min-width: 200px;
            z-index: 100;
            display: none;
        }

        .content-menu.active {
            display: block;
        }

        .content-menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .content-menu-item:hover {
            background: var(--gray-50);
        }

        .content-menu-icon {
            width: 32px;
            height: 32px;
            background: var(--gray-100);
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
        }

        .content-menu-text {
            flex: 1;
        }

        .content-menu-title {
            font-weight: 600;
            color: var(--gray-900);
            font-size: 0.875rem;
        }

        .content-menu-desc {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        /* Rich Text Editor */
        .editor-container {
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .ql-toolbar {
            background: var(--gray-50);
            border: none;
            border-bottom: 1px solid var(--gray-300);
        }

        .ql-container {
            border: none;
            font-family: inherit;
        }

        .ql-editor {
            min-height: 200px;
            font-size: 0.875rem;
        }

        /* Settings Panel */
        .settings-panel {
            background: var(--gray-50);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .settings-title {
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 1rem;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        /* Toggle Switch */
        .toggle-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .toggle-label {
            font-weight: 500;
            color: var(--gray-700);
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--gray-300);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .toggle-switch.active {
            background: var(--primary);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .toggle-switch.active::after {
            transform: translateX(-20px);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-xl);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.95);
            transition: var(--transition);
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            background: var(--gray-100);
            border: none;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--gray-200);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: 60vh;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-start;
            gap: 0.75rem;
        }

        /* Preview Mode */
        .preview-bar {
            position: fixed;
            top: 64px;
            right: 0;
            left: 0;
            background: var(--gray-900);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 999;
            transform: translateY(-100%);
            transition: var(--transition);
        }

        .preview-bar.active {
            transform: translateY(0);
        }

        .preview-devices {
            display: flex;
            gap: 0.5rem;
        }

        .device-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.375rem;
            color: white;
            cursor: pointer;
            transition: var(--transition);
        }

        .device-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .device-btn.active {
            background: var(--primary);
            border-color: var(--primary);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .content-area {
                padding: 1.5rem;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar-nav {
                position: fixed;
                left: -280px;
                transition: left 0.3s;
                z-index: 999;
                box-shadow: var(--shadow-xl);
            }

            .sidebar-nav.active {
                left: 0;
            }

            .content-area {
                padding: 1rem;
            }

            .top-bar {
                padding: 0 1rem;
            }

            .course-title-bar h1 {
                font-size: 1.125rem;
            }

            .tabs-header {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .modal {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
        }

        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-100) 50%, var(--gray-200) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Tooltips */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(50%);
            background: var(--gray-900);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 100;
            pointer-events: none;
            margin-bottom: 0.5rem;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        /* Success States */
        .success-message {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--secondary);
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .success-message.active {
            opacity: 1;
            visibility: visible;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 20px);
            }
            to {
                transform: translate(-50%, 0);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="top-bar-left">
                <a href="courses-management.html" class="back-btn">
                    <i class="fas fa-arrow-right"></i>
                    <span>العودة للدورات</span>
                </a>
                <div class="course-title-bar">
                    <h1>ملاذ الحياري</h1>
                    <span class="status-badge draft">
                        <i class="fas fa-circle" style="font-size: 0.5rem;"></i>
                        مسودة
                    </span>
                </div>
            </div>
            <div class="top-bar-right">
                <div class="auto-save-indicator saved">
                    <i class="fas fa-check-circle"></i>
                    <span>تم الحفظ</span>
                </div>
                <button class="btn btn-secondary">
                    <i class="fas fa-eye"></i>
                    معاينة
                </button>
                <button class="btn btn-success btn-lg">
                    <i class="fas fa-rocket"></i>
                    نشر الدورة
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar Navigation -->
            <nav class="sidebar-nav">
                <div class="sidebar-progress">
                    <div class="progress-header">
                        <span class="progress-label">إكمال إعداد الدورة</span>
                        <span class="progress-value">65%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 65%"></div>
                    </div>
                </div>
                
                <div class="sidebar-menu">
                    <a href="#basic-info" class="menu-item active">
                        <i class="fas fa-info-circle"></i>
                        <span>المعلومات الأساسية</span>
                        <span class="badge">3</span>
                    </a>
                    <a href="#curriculum" class="menu-item">
                        <i class="fas fa-book"></i>
                        <span>المنهج الدراسي</span>
                        <span class="badge">7</span>
                    </a>
                    <a href="#pricing" class="menu-item">
                        <i class="fas fa-tag"></i>
                        <span>التسعير والوصول</span>
                    </a>
                    <a href="#messages" class="menu-item">
                        <i class="fas fa-envelope"></i>
                        <span>الرسائل التلقائية</span>
                    </a>
                    <div class="menu-divider"></div>
                    <a href="#students" class="menu-item">
                        <i class="fas fa-users"></i>
                        <span>الطلاب المسجلين</span>
                        <span class="badge">0</span>
                    </a>
                    <a href="#analytics" class="menu-item">
    <i class="fas fa-chart-line"></i>
    <span>الإحصائيات</span>
</a>
<a href="#content-schedule" class="menu-item">
    <i class="fas fa-calendar-alt"></i>
    <span>جدولة المحتوى</span>
</a>
<a href="#settings" class="menu-item">
    <i class="fas fa-cog"></i>
    <span>إعدادات متقدمة</span>
</a>
                </div>
            </nav>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Basic Info Section -->
                <div class="tabs-container fade-in" id="basic-info">
                    <div class="tabs-header">
<button class="tab-button active" data-tab="info" onclick="switchTab('info')">معلومات الدورة</button>
<button class="tab-button" data-tab="media" onclick="switchTab('media')">الوسائط</button>
<button class="tab-button" data-tab="seo" onclick="switchTab('seo')">SEO</button>
                    </div>
                    
                    <div class="tab-content" id="info-tab">
                        <div class="form-section">
                            <h3 class="form-section-title">
                                <i class="fas fa-book"></i>
                                معلومات الدورة
                            </h3>
                            
                            <div class="form-group">
                                <label class="form-label required">اسم الدورة</label>
                                <input type="text" class="form-input" value="ملاذ الحياري" placeholder="أدخل اسم الدورة">
                                <p class="form-helper">اختر اسماً واضحاً وجذاباً لدورتك</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">العنوان الفرعي</label>
                                <input type="text" class="form-input" value="خريطة البحث عن المأوى للقلوب التائهة" placeholder="عنوان فرعي اختياري">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label required">وصف مختصر</label>
                                <textarea class="form-textarea" rows="3" placeholder="وصف قصير يظهر في بطاقة الدورة">سلسلة ورش عمل مجانية تفاعلية لمساعدة الأشخاص الذين يعيشون حالة من التيه الوجودي والعطش الداخلي على فهم طبيعة الألم واكتشاف طريق التحول.</textarea>
                                <p class="form-helper">140 حرف متبقي</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">الوصف التفصيلي</label>
                                <div class="editor-container">
                                    <div id="editor">
                                        <h3>نظرة عامة على الدورة</h3>
                                        <p>تقدم سلسلة "ملاذ الحياري" <strong>خريطة طريق</strong> للأشخاص الذين يعيشون حالة من التيه الوجودي والعطش الداخلي، لمساعدتهم على:</p>
                                        <ul>
                                            <li>فهم طبيعة الألم الداخلي الذي يعيشونه</li>
                                            <li>اكتشاف الأوهام الثلاثة التي يقعون فيها</li>
                                            <li>تعلم أسلوب عملي للتعامل مع المحفزات اليومية</li>
                                            <li>التعرف على 9 أبواب مختلفة للتحول</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">التصنيف</label>
                                <select class="form-select">
                                    <option>تطوير الذات</option>
                                    <option>علم النفس</option>
                                    <option>الصحة النفسية</option>
                                    <option>التحول الشخصي</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">المستوى</label>
                                <select class="form-select">
                                    <option>مبتدئ</option>
                                    <option selected>جميع المستويات</option>
                                    <option>متوسط</option>
                                    <option>متقدم</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">اللغة</label>
                                <select class="form-select">
                                    <option selected>العربية</option>
                                    <option>الإنجليزية</option>
                                    <option>العربية والإنجليزية</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="media-tab" style="display: none;">
                        <div class="form-section">
                            <h3 class="form-section-title">
                                <i class="fas fa-image"></i>
                                صورة الغلاف
                            </h3>
                            
                            <div class="form-group">
                                <label class="form-label">صورة الدورة الرئيسية</label>
                                <div class="image-upload" onclick="document.getElementById('cover-upload').click()">
                                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                    <p class="upload-text">اسحب الصورة هنا أو اضغط للاختيار</p>
                                    <p class="upload-hint">JPG, PNG حتى 5MB • الأبعاد المثالية 1200×600</p>
                                    <input type="file" id="cover-upload" accept="image/*" style="display: none;">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3 class="form-section-title">
                                <i class="fas fa-video"></i>
                                فيديو ترويجي
                            </h3>
                            
                            <div class="form-group">
                                <label class="form-label">رابط الفيديو</label>
                                <input type="url" class="form-input" placeholder="https://www.youtube.com/watch?v=...">
                                <p class="form-helper">يدعم YouTube و Vimeo</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="seo-tab" style="display: none;">
                        <div class="form-section">
                            <h3 class="form-section-title">
                                <i class="fas fa-search"></i>
                                تحسين محركات البحث
                            </h3>
                            
                            <div class="form-group">
                                <label class="form-label">رابط الدورة (Slug)</label>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="color: var(--gray-500);">fouad-academy.com/courses/</span>
                                    <input type="text" class="form-input" value="malaz-alhayari" style="flex: 1;">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">عنوان SEO</label>
                                <input type="text" class="form-input" value="ملاذ الحياري - رحلة التحول من التيه إلى الوضوح">
                                <p class="form-helper">55 حرف - مثالي لمحركات البحث</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">وصف Meta</label>
                                <textarea class="form-textarea" rows="3">اكتشف طريقك من التيه الوجودي إلى الوضوح الداخلي عبر 7 ورش عمل تفاعلية مجانية مع محمود فؤاد، خبير منظور الفؤاد.</textarea>
                                <p class="form-helper">155 حرف - طول مثالي</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">الكلمات المفتاحية</label>
                                <input type="text" class="form-input" value="التحول الشخصي, التيه الوجودي, تطوير الذات, منظور الفؤاد">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Curriculum Builder -->
                <div class="curriculum-container fade-in" id="curriculum" style="margin-top: 2rem;">
                    <div class="curriculum-header">
                        <h2 class="curriculum-title">
                            <i class="fas fa-book" style="color: var(--primary); margin-left: 0.5rem;"></i>
                            المنهج الدراسي
                        </h2>
                        <div class="curriculum-actions">
                            <button class="btn btn-secondary">
                                <i class="fas fa-file-import"></i>
                                استيراد من دورة
                            </button>
                            <button class="btn btn-primary" onclick="addModule()">
                                <i class="fas fa-plus"></i>
                                إضافة وحدة
                            </button>
                        </div>
                    </div>
                    
                    <div id="modules-container">
                        <!-- Module 1 -->
                        <div class="module" draggable="true">
                            <div class="module-header">
                                <i class="fas fa-grip-vertical drag-handle"></i>
                                <div class="module-info">
                                    <h4 class="module-title">الوحدة الأولى: فهم العطش الوجودي</h4>
                                    <div class="module-meta">
                                        <span><i class="fas fa-book-open"></i> 3 دروس</span>
                                        <span><i class="fas fa-clock"></i> 2 ساعة 30 دقيقة</span>
                                    </div>
                                </div>
                                <div class="module-actions">
                                    <button class="btn btn-icon btn-secondary" data-tooltip="تعديل">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-icon btn-secondary" data-tooltip="حذف">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <button class="btn btn-icon btn-secondary" data-tooltip="طي/فتح">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="module-content">
                                <!-- Lesson 1 -->
                                <div class="lesson" draggable="true">
                                    <i class="fas fa-grip-vertical drag-handle"></i>
                                    <div class="lesson-icon video">
                                        <i class="fas fa-play"></i>
                                    </div>
                                    <div class="lesson-info">
                                        <h5 class="lesson-title">مقدمة: ما هو العطش الأبدي؟</h5>
                                        <span class="lesson-duration">15 دقيقة</span>
                                    </div>
                                    <div class="lesson-actions">
                                        <button class="btn btn-icon btn-secondary btn-sm" data-tooltip="تعديل">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-icon btn-secondary btn-sm" data-tooltip="معاينة">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-icon btn-secondary btn-sm" data-tooltip="حذف">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Lesson 2 -->
                                <div class="lesson" draggable="true">
                                    <i class="fas fa-grip-vertical drag-handle"></i>
                                    <div class="lesson-icon text">
                                        <i class="fas fa-file-alt"></i>
                                    </div>
                                    <div class="lesson-info">
                                        <h5 class="lesson-title">الفرق بين الحاجات السطحية والعطش الحقيقي</h5>
                                        <span class="lesson-duration">قراءة 10 دقائق</span>
                                    </div>
                                    <div class="lesson-actions">
                                        <button class="btn btn-icon btn-secondary btn-sm" data-tooltip="تعديل">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-icon btn-secondary btn-sm" data-tooltip="معاينة">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-icon btn-secondary btn-sm" data-tooltip="حذف">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Lesson 3 -->
                                <div class="lesson" draggable="true">
                                    <i class="fas fa-grip-vertical drag-handle"></i>
                                    <div class="lesson-icon quiz">
                                        <i class="fas fa-question-circle"></i>
                                    </div>
                                    <div class="lesson-info">
                                        <h5 class="lesson-title">اختبار: اكتشف نوع عطشك الداخلي</h5>
                                        <span class="lesson-duration">10 أسئلة</span>
                                    </div>
                                    <div class="lesson-actions">
                                        <button class="btn btn-icon btn-secondary btn-sm" data-tooltip="تعديل">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-icon btn-secondary btn-sm" data-tooltip="معاينة">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-icon btn-secondary btn-sm" data-tooltip="حذف">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Add Content Button -->
                                <button class="add-content-btn" onclick="showContentMenu(this)">
                                    <i class="fas fa-plus"></i>
                                    إضافة محتوى
                                </button>
                            </div>
                        </div>
                        
                        <!-- Module 2 -->
                        <div class="module" draggable="true">
                            <div class="module-header">
                                <i class="fas fa-grip-vertical drag-handle"></i>
                                <div class="module-info">
                                    <h4 class="module-title">الوحدة الثانية: الأوهام الثلاثة</h4>
                                    <div class="module-meta">
                                        <span><i class="fas fa-book-open"></i> 4 دروس</span>
                                        <span><i class="fas fa-clock"></i> 3 ساعات</span>
                                    </div>
                                </div>
                                <div class="module-actions">
                                    <button class="btn btn-icon btn-secondary" data-tooltip="تعديل">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-icon btn-secondary" data-tooltip="حذف">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <button class="btn btn-icon btn-secondary" data-tooltip="طي/فتح">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pricing Section -->
                <div class="settings-panel" id="pricing" style="display: none;">
                    <h3 class="settings-title">
                        <i class="fas fa-tag" style="color: var(--primary); margin-left: 0.5rem;"></i>
                        التسعير والوصول
                    </h3>
                    
                    <div class="settings-grid">
                        <div class="form-group">
                            <label class="form-label">نوع الدورة</label>
                            <select class="form-select">
                                <option selected>مجانية</option>
                                <option>مدفوعة</option>
                                <option>اشتراك</option>
                                <option>خاصة (بدعوة)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">تاريخ البدء</label>
                            <input type="date" class="form-input" value="2025-07-17">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">مدة الوصول</label>
                            <select class="form-select">
                                <option>وصول مدى الحياة</option>
                                <option>سنة واحدة</option>
                                <option>6 شهور</option>
                                <option>3 شهور</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">الحد الأقصى للطلاب</label>
                            <input type="number" class="form-input" placeholder="غير محدود">
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <div class="toggle-group">
                            <span class="toggle-label">السماح بالتسجيل التلقائي</span>
                            <div class="toggle-switch active" data-toggle="autoEnroll" onclick="toggleSwitch(this)"></div>
                        </div>
                        
                        <div class="toggle-group">
                            <span class="toggle-label">إتاحة المحتوى تدريجياً</span>
                            <div class="toggle-switch" data-toggle="dripContent" onclick="toggleSwitch(this)"></div>
                        </div>
                        
                        <div class="toggle-group">
                            <span class="toggle-label">إصدار شهادة عند الإكمال</span>
                            <div class="toggle-switch active" data-toggle="certificate" onclick="toggleSwitch(this)"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- أضف هذا القسم في صفحة course-builder.html بعد قسم التسعير -->

<div class="settings-panel" id="content-schedule" style="display: none;">
    <h3 class="settings-title">
        <i class="fas fa-calendar-alt" style="color: var(--primary); margin-left: 0.5rem;"></i>
        جدولة إتاحة المحتوى
    </h3>
    
    <!-- التحكم العام -->
    <div class="form-section">
        <div class="toggle-group">
            <span class="toggle-label">تفعيل الإتاحة التدريجية</span>
            <div class="toggle-switch" data-toggle="dripContent" onclick="toggleDripContent(this)"></div>
        </div>
        <p class="form-helper">عند التفعيل، سيتم إتاحة المحتوى للطلاب بشكل تدريجي حسب الجدول المحدد</p>
    </div>

    <!-- إعدادات الإتاحة -->
    <div id="drip-settings" style="display: none; margin-top: 2rem;">
        <div class="form-group">
            <label class="form-label">نوع الجدولة</label>
            <select class="form-select" id="drip-type" onchange="updateDripType()">
                <option value="date">حسب التاريخ</option>
                <option value="enrollment">حسب تاريخ التسجيل</option>
                <option value="completion">حسب إكمال المحتوى السابق</option>
                <option value="custom">مخصص لكل درس</option>
            </select>
        </div>

        <!-- جدولة حسب التاريخ -->
        <div id="date-schedule" class="schedule-type">
            <h4 style="margin: 1.5rem 0 1rem;">جدول إتاحة الوحدات</h4>
            <div id="modules-schedule-list">
                <!-- سيتم ملؤها ديناميكياً -->
            </div>
        </div>

        <!-- جدولة حسب التسجيل -->
        <div id="enrollment-schedule" class="schedule-type" style="display: none;">
            <h4 style="margin: 1.5rem 0 1rem;">الإتاحة بعد التسجيل</h4>
            <div class="info-box" style="background: var(--gray-100); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                <i class="fas fa-info-circle" style="color: var(--info);"></i>
                سيتم إتاحة المحتوى تدريجياً بناءً على عدد الأيام من تاريخ تسجيل كل طالب
            </div>
            <div id="enrollment-schedule-list">
                <!-- سيتم ملؤها ديناميكياً -->
            </div>
        </div>

        <!-- جدولة حسب الإكمال -->
        <div id="completion-schedule" class="schedule-type" style="display: none;">
            <h4 style="margin: 1.5rem 0 1rem;">الشروط المسبقة</h4>
            <div class="info-box" style="background: var(--gray-100); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                <i class="fas fa-check-circle" style="color: var(--success);"></i>
                يجب على الطالب إكمال المحتوى السابق قبل الانتقال للتالي
            </div>
            <div class="form-group">
                <label class="form-label">نسبة الإكمال المطلوبة</label>
                <input type="number" class="form-input" value="100" min="0" max="100" style="width: 100px;">
                <span style="margin-right: 0.5rem;">%</span>
            </div>
        </div>
    </div>
</div>

<!-- نافذة إعدادات الدرس المتقدمة -->
<div class="modal-overlay" id="lesson-settings-modal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">إعدادات الإتاحة والشروط المسبقة</h3>
            <button class="modal-close" onclick="closeModal('lesson-settings-modal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- إعدادات الإتاحة -->
            <div class="form-section">
                <h4 class="form-section-title">
                    <i class="fas fa-clock"></i>
                    متى يُتاح هذا الدرس؟
                </h4>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="radio" name="availability" value="immediate" checked onchange="updateAvailability()">
                        متاح فوراً
                    </label>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="radio" name="availability" value="scheduled" onchange="updateAvailability()">
                        متاح في تاريخ محدد
                    </label>
                    <div id="scheduled-date" style="display: none; margin-top: 0.5rem;">
                        <input type="datetime-local" class="form-input">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="radio" name="availability" value="after-days" onchange="updateAvailability()">
                        متاح بعد عدد من الأيام من التسجيل
                    </label>
                    <div id="after-days" style="display: none; margin-top: 0.5rem;">
                        <input type="number" class="form-input" placeholder="عدد الأيام" style="width: 100px;">
                        <span> يوم</span>
                    </div>
                </div>
            </div>

            <!-- الشروط المسبقة -->
            <div class="form-section">
                <h4 class="form-section-title">
                    <i class="fas fa-lock"></i>
                    الشروط المسبقة
                </h4>
                
                <div class="toggle-group">
                    <span class="toggle-label">تفعيل الشروط المسبقة</span>
                    <div class="toggle-switch" onclick="togglePrerequisites(this)"></div>
                </div>
                
                <div id="prerequisites-settings" style="display: none; margin-top: 1rem;">
                    <div id="prerequisites-list">
                        <!-- قائمة الشروط -->
                    </div>
                    
                    <button class="btn btn-secondary" onclick="addPrerequisite()">
                        <i class="fas fa-plus"></i>
                        إضافة شرط
                    </button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('lesson-settings-modal')">إلغاء</button>
            <button class="btn btn-primary" onclick="saveLessonSettings()">
                <i class="fas fa-save"></i>
                حفظ الإعدادات
            </button>
        </div>
    </div>
</div>

<!-- قالب شرط مسبق -->
<template id="prerequisite-template">
    <div class="prerequisite-item" style="background: var(--gray-50); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
        <div class="form-group">
            <label class="form-label">نوع الشرط</label>
            <select class="form-select" onchange="updatePrerequisiteType(this)">
                <option value="complete_lesson">إكمال درس سابق</option>
                <option value="pass_quiz">النجاح في اختبار</option>
                <option value="complete_assignment">إكمال تمرين</option>
                <option value="watch_percentage">مشاهدة نسبة من الفيديو</option>
                <option value="wait_time">الانتظار لفترة زمنية</option>
            </select>
        </div>
        
        <div class="prerequisite-details">
            <!-- تفاصيل الشرط حسب النوع -->
        </div>
        
        <div class="form-group">
            <label class="form-label">رسالة للطالب</label>
            <input type="text" class="form-input" placeholder="الرسالة التي تظهر عند عدم تحقق الشرط">
        </div>
        
        <button class="btn btn-danger btn-sm" onclick="removePrerequisite(this)">
            <i class="fas fa-trash"></i>
            حذف الشرط
        </button>
    </div>
</template>

<style>
/* أضف هذه الأنماط لملف CSS */
.schedule-type {
    margin-top: 1.5rem;
}

.module-schedule-item {
    background: var(--gray-50);
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.module-schedule-title {
    flex: 1;
    font-weight: 600;
}

.prerequisite-item {
    position: relative;
}

.prerequisite-details {
    margin: 1rem 0;
    padding: 1rem;
    background: white;
    border-radius: 0.375rem;
    border: 1px solid var(--gray-200);
}

.info-box {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.lesson-settings-btn {
    background: var(--gray-100);
    border: 1px solid var(--gray-300);
    color: var(--gray-700);
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
}

.lesson-settings-btn:hover {
    background: var(--gray-200);
    border-color: var(--gray-400);
}
</style>

<script>
// أضف هذه الدوال لملف JavaScript

// تفعيل/إلغاء الإتاحة التدريجية
function toggleDripContent(toggle) {
    const isActive = toggle.classList.contains('active');
    const dripSettings = document.getElementById('drip-settings');
    
    if (isActive) {
        dripSettings.style.display = 'block';
        updateModulesSchedule();
    } else {
        dripSettings.style.display = 'none';
    }
    
    courseData.dripContent = isActive;
    saveCourse();
}

// تحديث نوع الجدولة
function updateDripType() {
    const type = document.getElementById('drip-type').value;
    
    // إخفاء جميع الأنواع
    document.querySelectorAll('.schedule-type').forEach(el => {
        el.style.display = 'none';
    });
    
    // إظهار النوع المحدد
    document.getElementById(type + '-schedule').style.display = 'block';
    
    if (type === 'date') {
        updateModulesSchedule();
    } else if (type === 'enrollment') {
        updateEnrollmentSchedule();
    }
    
    courseData.dripType = type;
    saveCourse();
}

// تحديث جدول الوحدات
function updateModulesSchedule() {
    const container = document.getElementById('modules-schedule-list');
    container.innerHTML = '';
    
    courseData.modules.forEach((module, index) => {
        const item = document.createElement('div');
        item.className = 'module-schedule-item';
        item.innerHTML = `
            <div class="module-schedule-title">
                <i class="fas fa-book"></i>
                ${module.title}
            </div>
            <div class="form-group" style="margin: 0;">
                <input type="date" class="form-input" 
                       value="${module.availableDate || ''}"
                       onchange="updateModuleDate(${index}, this.value)">
            </div>
        `;
        container.appendChild(item);
    });
}

// تحديث جدول التسجيل
function updateEnrollmentSchedule() {
    const container = document.getElementById('enrollment-schedule-list');
    container.innerHTML = '';
    
    courseData.modules.forEach((module, index) => {
        const item = document.createElement('div');
        item.className = 'module-schedule-item';
        item.innerHTML = `
            <div class="module-schedule-title">
                <i class="fas fa-book"></i>
                ${module.title}
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span>بعد</span>
                <input type="number" class="form-input" 
                       style="width: 80px;"
                       value="${module.daysAfterEnrollment || 0}"
                       onchange="updateModuleDays(${index}, this.value)">
                <span>يوم من التسجيل</span>
            </div>
        `;
        container.appendChild(item);
    });
}

// تحديث تاريخ الوحدة
function updateModuleDate(moduleIndex, date) {
    courseData.modules[moduleIndex].availableDate = date;
    saveCourse();
}

// تحديث أيام الوحدة
function updateModuleDays(moduleIndex, days) {
    courseData.modules[moduleIndex].daysAfterEnrollment = parseInt(days) || 0;
    saveCourse();
}

// فتح إعدادات الدرس
function openLessonSettings(moduleIndex, lessonIndex) {
    const modal = document.getElementById('lesson-settings-modal');
    modal.dataset.moduleIndex = moduleIndex;
    modal.dataset.lessonIndex = lessonIndex;
    
    const lesson = courseData.modules[moduleIndex].lessons[lessonIndex];
    
    // تحميل الإعدادات الحالية
    if (lesson.availability) {
        document.querySelector(`input[name="availability"][value="${lesson.availability.type}"]`).checked = true;
        updateAvailability();
        
        if (lesson.availability.type === 'scheduled') {
            document.querySelector('#scheduled-date input').value = lesson.availability.date;
        } else if (lesson.availability.type === 'after-days') {
            document.querySelector('#after-days input').value = lesson.availability.days;
        }
    }
    
    // تحميل الشروط المسبقة
    if (lesson.prerequisites && lesson.prerequisites.length > 0) {
        document.querySelector('#prerequisites-settings').previousElementSibling.querySelector('.toggle-switch').classList.add('active');
        document.getElementById('prerequisites-settings').style.display = 'block';
        
        // عرض الشروط
        lesson.prerequisites.forEach(prereq => {
            addPrerequisite(prereq);
        });
    }
    
    modal.classList.add('active');
}

// تحديث نوع الإتاحة
function updateAvailability() {
    const selectedType = document.querySelector('input[name="availability"]:checked').value;
    
    document.getElementById('scheduled-date').style.display = selectedType === 'scheduled' ? 'block' : 'none';
    document.getElementById('after-days').style.display = selectedType === 'after-days' ? 'block' : 'none';
}

// تفعيل الشروط المسبقة
function togglePrerequisites(toggle) {
    const isActive = toggle.classList.contains('active');
    document.getElementById('prerequisites-settings').style.display = isActive ? 'block' : 'none';
}

// إضافة شرط مسبق
function addPrerequisite(data = null) {
    const template = document.getElementById('prerequisite-template');
    const clone = template.content.cloneNode(true);
    
    if (data) {
        // ملء البيانات إذا كانت موجودة
        clone.querySelector('select').value = data.type;
        clone.querySelector('input[type="text"]').value = data.message;
    }
    
    document.getElementById('prerequisites-list').appendChild(clone);
}

// إزالة شرط مسبق
function removePrerequisite(button) {
    button.closest('.prerequisite-item').remove();
}

// تحديث نوع الشرط المسبق
function updatePrerequisiteType(select) {
    const type = select.value;
    const details = select.closest('.prerequisite-item').querySelector('.prerequisite-details');
    
    let html = '';
    
    switch(type) {
        case 'complete_lesson':
            html = `
                <div class="form-group">
                    <label class="form-label">اختر الدرس المطلوب إكماله</label>
                    <select class="form-select">
                        ${getAllLessonsOptions()}
                    </select>
                </div>
            `;
            break;
            
        case 'pass_quiz':
            html = `
                <div class="form-group">
                    <label class="form-label">اختر الاختبار</label>
                    <select class="form-select">
                        ${getQuizLessonsOptions()}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">النسبة المطلوبة للنجاح</label>
                    <input type="number" class="form-input" value="80" min="0" max="100" style="width: 100px;">
                    <span> %</span>
                </div>
            `;
            break;
            
        case 'watch_percentage':
            html = `
                <div class="form-group">
                    <label class="form-label">نسبة المشاهدة المطلوبة</label>
                    <input type="number" class="form-input" value="90" min="0" max="100" style="width: 100px;">
                    <span> %</span>
                </div>
            `;
            break;
            
        case 'wait_time':
            html = `
                <div class="form-group">
                    <label class="form-label">فترة الانتظار</label>
                    <input type="number" class="form-input" value="1" min="1" style="width: 100px;">
                    <select class="form-select" style="width: auto; margin-right: 0.5rem;">
                        <option value="hours">ساعة</option>
                        <option value="days">يوم</option>
                        <option value="weeks">أسبوع</option>
                    </select>
                </div>
            `;
            break;
    }
    
    details.innerHTML = html;
}

// الحصول على جميع الدروس
function getAllLessonsOptions() {
    let options = '<option value="">اختر درس...</option>';
    
    courseData.modules.forEach((module, mIndex) => {
        if (module.lessons) {
            module.lessons.forEach((lesson, lIndex) => {
                options += `<option value="${mIndex}-${lIndex}">${module.title} - ${lesson.title}</option>`;
            });
        }
    });
    
    return options;
}

// الحصول على دروس الاختبارات
function getQuizLessonsOptions() {
    let options = '<option value="">اختر اختبار...</option>';
    
    courseData.modules.forEach((module, mIndex) => {
        if (module.lessons) {
            module.lessons.forEach((lesson, lIndex) => {
                if (lesson.type === 'quiz') {
                    options += `<option value="${mIndex}-${lIndex}">${module.title} - ${lesson.title}</option>`;
                }
            });
        }
    });
    
    return options;
}

// حفظ إعدادات الدرس
async function saveLessonSettings() {
    const modal = document.getElementById('lesson-settings-modal');
    const moduleIndex = parseInt(modal.dataset.moduleIndex);
    const lessonIndex = parseInt(modal.dataset.lessonIndex);
    
    const lesson = courseData.modules[moduleIndex].lessons[lessonIndex];
    
    // حفظ إعدادات الإتاحة
    const availabilityType = document.querySelector('input[name="availability"]:checked').value;
    lesson.availability = { type: availabilityType };
    
    if (availabilityType === 'scheduled') {
        lesson.availability.date = document.querySelector('#scheduled-date input').value;
    } else if (availabilityType === 'after-days') {
        lesson.availability.days = parseInt(document.querySelector('#after-days input').value) || 0;
    }
    
    // حفظ الشروط المسبقة
    const hasPrerequisites = document.querySelector('#prerequisites-settings').previousElementSibling.querySelector('.toggle-switch').classList.contains('active');
    
    if (hasPrerequisites) {
        lesson.prerequisites = [];
        
        document.querySelectorAll('.prerequisite-item').forEach(item => {
            const prereq = {
                type: item.querySelector('select').value,
                message: item.querySelector('input[type="text"]').value
            };
            
            // إضافة التفاصيل حسب النوع
            if (prereq.type === 'complete_lesson' || prereq.type === 'pass_quiz') {
                prereq.targetId = item.querySelector('.prerequisite-details select').value;
            }
            
            if (prereq.type === 'pass_quiz') {
                prereq.minScore = parseInt(item.querySelector('.prerequisite-details input[type="number"]').value) || 80;
            }
            
            if (prereq.type === 'watch_percentage') {
                prereq.percentage = parseInt(item.querySelector('.prerequisite-details input[type="number"]').value) || 90;
            }
            
            if (prereq.type === 'wait_time') {
                prereq.duration = parseInt(item.querySelector('.prerequisite-details input[type="number"]').value) || 1;
                prereq.unit = item.querySelector('.prerequisite-details select').value;
            }
            
            lesson.prerequisites.push(prereq);
        });
    } else {
        lesson.prerequisites = [];
    }
    
    await saveCourse();
    updateCurriculum();
    closeModal('lesson-settings-modal');
    showSuccessMessage('تم حفظ إعدادات الدرس');
}

// إضافة زر الإعدادات لكل درس
function addSettingsButtonToLessons() {
    // هذه الدالة يجب استدعاؤها عند إنشاء الدروس
    // أضف زر صغير بجانب أزرار الدرس الأخرى:
    /*
    <button class="lesson-settings-btn" onclick="openLessonSettings(${moduleIndex}, ${lessonIndex})" data-tooltip="إعدادات متقدمة">
        <i class="fas fa-cog"></i>
    </button>
    */
}
</script>
    <!-- Content Menu -->
    <div class="content-menu" id="content-menu">
        <div class="content-menu-item" onclick="addLesson('video')">
            <div class="content-menu-icon" style="background: rgba(239, 68, 68, 0.1); color: var(--danger);">
                <i class="fas fa-video"></i>
            </div>
            <div class="content-menu-text">
                <div class="content-menu-title">درس فيديو</div>
                <div class="content-menu-desc">فيديو تعليمي أو تسجيل</div>
            </div>
        </div>
        
        <div class="content-menu-item" onclick="addLesson('text')">
            <div class="content-menu-icon" style="background: rgba(59, 130, 246, 0.1); color: #3B82F6;">
                <i class="fas fa-file-alt"></i>
            </div>
            <div class="content-menu-text">
                <div class="content-menu-title">درس نصي</div>
                <div class="content-menu-desc">مقال أو شرح مكتوب</div>
            </div>
        </div>
        
        <div class="content-menu-item" onclick="addLesson('quiz')">
            <div class="content-menu-icon" style="background: rgba(245, 158, 11, 0.1); color: var(--accent);">
                <i class="fas fa-question-circle"></i>
            </div>
            <div class="content-menu-text">
                <div class="content-menu-title">اختبار</div>
                <div class="content-menu-desc">أسئلة تقييمية</div>
            </div>
        </div>
        
        <div class="content-menu-item" onclick="addLesson('assignment')">
            <div class="content-menu-icon" style="background: rgba(139, 92, 246, 0.1); color: var(--primary);">
                <i class="fas fa-tasks"></i>
            </div>
            <div class="content-menu-text">
                <div class="content-menu-title">تمرين عملي</div>
                <div class="content-menu-desc">مهمة أو تطبيق</div>
            </div>
        </div>
        
        <div class="content-menu-item" onclick="addLesson('live')">
            <div class="content-menu-icon" style="background: rgba(16, 185, 129, 0.1); color: var(--secondary);">
                <i class="fas fa-broadcast-tower"></i>
            </div>
            <div class="content-menu-text">
                <div class="content-menu-title">جلسة مباشرة</div>
                <div class="content-menu-desc">بث مباشر أو ويبينار</div>
            </div>
        </div>
        
        <div class="content-menu-item" onclick="addLesson('download')">
            <div class="content-menu-icon">
                <i class="fas fa-download"></i>
            </div>
            <div class="content-menu-text">
                <div class="content-menu-title">ملف للتحميل</div>
                <div class="content-menu-desc">PDF أو موارد إضافية</div>
            </div>
        </div>
    </div>

    <!-- Lesson Modal -->
    <div class="modal-overlay" id="lesson-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">إضافة درس فيديو</h3>
                <button class="modal-close" onclick="closeModal('lesson-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label required">عنوان الدرس</label>
                    <input type="text" class="form-input" placeholder="أدخل عنوان الدرس">
                </div>
                
                <div class="form-group">
                    <label class="form-label">نوع الفيديو</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <label class="radio-card">
                            <input type="radio" name="video-type" value="upload" checked>
                            <div class="radio-card-content">
                                <i class="fas fa-upload"></i>
                                <span>رفع فيديو</span>
                            </div>
                        </label>
                        <label class="radio-card">
                            <input type="radio" name="video-type" value="youtube">
                            <div class="radio-card-content">
                                <i class="fab fa-youtube"></i>
                                <span>YouTube</span>
                            </div>
                        </label>
                        <label class="radio-card">
                            <input type="radio" name="video-type" value="vimeo">
                            <div class="radio-card-content">
                                <i class="fab fa-vimeo"></i>
                                <span>Vimeo</span>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">رابط الفيديو</label>
                    <input type="url" class="form-input" placeholder="https://www.youtube.com/watch?v=...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">وصف الدرس</label>
                    <textarea class="form-textarea" rows="4" placeholder="اكتب وصفاً مختصراً للدرس"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">مدة الفيديو</label>
                    <input type="text" class="form-input" placeholder="مثال: 15:30">
                </div>
                
                <div class="settings-panel" style="margin: 0; padding: 1rem;">
                    <h4 style="font-size: 1rem; margin-bottom: 1rem;">إعدادات الدرس</h4>
                    <div class="toggle-group">
                        <span class="toggle-label">معاينة مجانية</span>
                        <div class="toggle-switch" data-modal-toggle="free-preview" onclick="toggleSwitch(this)"></div>
                    </div>
                    <div class="toggle-group">
                        <span class="toggle-label">تحميل الفيديو متاح</span>
                        <div class="toggle-switch" data-modal-toggle="downloadable" onclick="toggleSwitch(this)"></div>
                    </div>
                    <div class="toggle-group">
                        <span class="toggle-label">تفعيل التعليقات</span>
                        <div class="toggle-switch active" data-modal-toggle="comments" onclick="toggleSwitch(this)"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('lesson-modal')">إلغاء</button>
                <button class="btn btn-primary" onclick="saveLesson()">
    <i class="fas fa-save"></i>
    حفظ الدرس
</button>
            </div>
        </div>
    </div>

    <!-- Success Message -->
    <div class="success-message" id="success-message">
        <i class="fas fa-check-circle"></i>
        <span>تم الحفظ بنجاح!</span>
    </div>

    <!-- Preview Bar -->
    <div class="preview-bar" id="preview-bar">
        <div class="preview-devices">
            <button class="device-btn active">
                <i class="fas fa-desktop"></i>
                سطح المكتب
            </button>
            <button class="device-btn">
                <i class="fas fa-tablet-alt"></i>
                تابلت
            </button>
            <button class="device-btn">
                <i class="fas fa-mobile-alt"></i>
                موبايل
            </button>
        </div>
        <button class="btn btn-secondary" style="background: rgba(255,255,255,0.2); border: none; color: white;">
            <i class="fas fa-times"></i>
            إغلاق المعاينة
        </button>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        // Initialize Quill Editor
        var quill = new Quill('#editor', {
            theme: 'snow',
            placeholder: 'اكتب وصف الدورة هنا...',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'direction': 'rtl' }],
                    ['link', 'image', 'video'],
                    ['clean']
                ]
            }
        });

        // Auto-save functionality
        let saveTimeout;
        let isSaving = false;

        function autoSave() {
            const indicator = document.querySelector('.auto-save-indicator');
            clearTimeout(saveTimeout);
            
            // Show saving state
            indicator.className = 'auto-save-indicator saving';
            indicator.innerHTML = '<i class="fas fa-spinner spinning"></i><span>جاري الحفظ...</span>';
            
            // Simulate save
            saveTimeout = setTimeout(() => {
                indicator.className = 'auto-save-indicator saved';
                indicator.innerHTML = '<i class="fas fa-check-circle"></i><span>تم الحفظ</span>';
                showSuccessMessage();
            }, 1000);
        }

        // Add auto-save listeners
        document.querySelectorAll('input, textarea, select').forEach(element => {
            element.addEventListener('input', autoSave);
            element.addEventListener('change', autoSave);
        });

        quill.on('text-change', autoSave);
// دوال إدارة الوحدات والدروس
function addModule() {
    const modulesContainer = document.getElementById('modules-container');
    const moduleCount = modulesContainer.children.length + 1;
    
    const newModule = document.createElement('div');
    newModule.className = 'module fade-in';
    newModule.draggable = true;
    newModule.innerHTML = `
        <div class="module-header">
            <i class="fas fa-grip-vertical drag-handle"></i>
            <div class="module-info">
                <h4 class="module-title">الوحدة ${moduleCount}: عنوان الوحدة الجديدة</h4>
                <div class="module-meta">
                    <span><i class="fas fa-book-open"></i> 0 دروس</span>
                    <span><i class="fas fa-clock"></i> 0 دقيقة</span>
                </div>
            </div>
            <div class="module-actions">
                <button class="btn btn-icon btn-secondary" data-tooltip="تعديل" onclick="editModule(this)">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-icon btn-secondary" data-tooltip="حذف" onclick="deleteModule(this)">
                    <i class="fas fa-trash"></i>
                </button>
                <button class="btn btn-icon btn-secondary" data-tooltip="طي/فتح">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
        </div>
        <div class="module-content">
            <button class="add-content-btn" onclick="showContentMenu(this)">
                <i class="fas fa-plus"></i>
                إضافة محتوى
            </button>
        </div>
    `;
    
    modulesContainer.appendChild(newModule);
    autoSave();
}

function editModule(button) {
    const moduleTitle = button.closest('.module').querySelector('.module-title');
    const currentTitle = moduleTitle.textContent;
    const newTitle = prompt('تعديل عنوان الوحدة:', currentTitle);
    
    if (newTitle && newTitle !== currentTitle) {
        moduleTitle.textContent = newTitle;
        autoSave();
    }
}

function deleteModule(button) {
    if (confirm('هل أنت متأكد من حذف هذه الوحدة؟')) {
        button.closest('.module').remove();
        autoSave();
    }
}

function saveLesson() {
    const modal = document.getElementById('lesson-modal');
    const title = modal.querySelector('input[placeholder*="عنوان"]').value;
    const videoUrl = modal.querySelector('input[type="url"]').value;
    const description = modal.querySelector('textarea').value;
    const duration = modal.querySelector('input[placeholder*="15:30"]').value;
    
    if (!title) {
        alert('من فضلك أدخل عنوان الدرس');
        return;
    }
    
    // إنشاء عنصر الدرس
    const lessonHTML = `
        <div class="lesson" draggable="true">
            <i class="fas fa-grip-vertical drag-handle"></i>
            <div class="lesson-icon video">
                <i class="fas fa-play"></i>
            </div>
            <div class="lesson-info">
                <h5 class="lesson-title">${title}</h5>
                <span class="lesson-duration">${duration || '0 دقيقة'}</span>
            </div>
            <div class="lesson-actions">
                <button class="btn btn-icon btn-secondary btn-sm" data-tooltip="تعديل" onclick="editLesson(this)">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-icon btn-secondary btn-sm" data-tooltip="معاينة">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-icon btn-secondary btn-sm" data-tooltip="حذف" onclick="deleteLesson(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    // إضافة الدرس للوحدة الحالية
    if (window.currentModule) {
        const addButton = window.currentModule.querySelector('.add-content-btn');
        addButton.insertAdjacentHTML('beforebegin', lessonHTML);
        
        // تحديث عدد الدروس
        updateModuleStats(window.currentModule);
    }
    
    closeModal('lesson-modal');
    showSuccessMessage();
    autoSave();
}

function editLesson(button) {
    const lesson = button.closest('.lesson');
    const title = lesson.querySelector('.lesson-title').textContent;
    const newTitle = prompt('تعديل عنوان الدرس:', title);
    
    if (newTitle && newTitle !== title) {
        lesson.querySelector('.lesson-title').textContent = newTitle;
        autoSave();
    }
}

function deleteLesson(button) {
    if (confirm('هل أنت متأكد من حذف هذا الدرس؟')) {
        const lesson = button.closest('.lesson');
        const module = lesson.closest('.module');
        lesson.remove();
        updateModuleStats(module);
        autoSave();
    }
}

function updateModuleStats(module) {
    const lessons = module.querySelectorAll('.lesson').length;
    const metaSpan = module.querySelector('.module-meta span:first-child');
    metaSpan.innerHTML = `<i class="fas fa-book-open"></i> ${lessons} دروس`;
}

// تخزين الوحدة الحالية عند فتح قائمة المحتوى
window.currentModule = null;

// تحديث دالة showContentMenu
const originalShowContentMenu = window.showContentMenu;
window.showContentMenu = function(button) {
    window.currentModule = button.closest('.module');
    if (originalShowContentMenu) {
        originalShowContentMenu(button);
    } else {
        const menu = document.getElementById('content-menu');
        const rect = button.getBoundingClientRect();
        menu.style.top = rect.bottom + 10 + 'px';
        menu.style.left = rect.left + 'px';
        menu.classList.add('active');
        
        setTimeout(() => {
            document.addEventListener('click', closeContentMenu);
        }, 100);
    }
};

// تحديث العنوان عند تغيير اسم الدورة
document.addEventListener('DOMContentLoaded', function() {
    const titleInput = document.querySelector('input[value="ملاذ الحياري"]');
    if (titleInput) {
        titleInput.addEventListener('input', function() {
            // تحديث العنوان في الأعلى
            const pageTitle = document.querySelector('.page-title');
            if (pageTitle) {
                pageTitle.textContent = this.value || 'دورة جديدة';
            }
        });
    }
});
        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // Toggle switch
        function toggleSwitch(element) {
            element.classList.toggle('active');
            autoSave();
        }

        // Show content menu
        function showContentMenu(button) {
            const menu = document.getElementById('content-menu');
            const rect = button.getBoundingClientRect();
            
            menu.style.top = rect.bottom + 10 + 'px';
            menu.style.left = rect.left + 'px';
            menu.classList.add('active');
            
            // Close menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeContentMenu);
            }, 100);
        }

        function closeContentMenu() {
            document.getElementById('content-menu').classList.remove('active');
            document.removeEventListener('click', closeContentMenu);
        }

        // Add module
        function addModule() {
            const modulesContainer = document.getElementById('modules-container');
            const moduleCount = modulesContainer.children.length + 1;
            
            const newModule = document.createElement('div');
            newModule.className = 'module fade-in';
            newModule.draggable = true;
            newModule.innerHTML = `
                <div class="module-header">
                    <i class="fas fa-grip-vertical drag-handle"></i>
                    <div class="module-info">
                        <h4 class="module-title">الوحدة ${moduleCount}: عنوان الوحدة الجديدة</h4>
                        <div class="module-meta">
                            <span><i class="fas fa-book-open"></i> 0 دروس</span>
                            <span><i class="fas fa-clock"></i> 0 دقيقة</span>
                        </div>
                    </div>
                    <div class="module-actions">
                        <button class="btn btn-icon btn-secondary" data-tooltip="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-icon btn-secondary" data-tooltip="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-icon btn-secondary" data-tooltip="طي/فتح">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                </div>
                <div class="module-content">
                    <button class="add-content-btn" onclick="showContentMenu(this)">
                        <i class="fas fa-plus"></i>
                        إضافة محتوى
                    </button>
                </div>
            `;
            
            modulesContainer.appendChild(newModule);
            autoSave();
        }

        // Add lesson
        function addLesson(type) {
            closeContentMenu();
            
            // Show lesson modal
            const modal = document.getElementById('lesson-modal');
            modal.classList.add('active');
            
            // Update modal title based on type
            const titles = {
                'video': 'إضافة درس فيديو',
                'text': 'إضافة درس نصي',
                'quiz': 'إضافة اختبار',
                'assignment': 'إضافة تمرين عملي',
                'live': 'جدولة جلسة مباشرة',
                'download': 'إضافة ملف للتحميل'
            };
            
            modal.querySelector('.modal-title').textContent = titles[type];
        }

        // Modal functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Show success message
        function showSuccessMessage() {
            const message = document.getElementById('success-message');
            message.classList.add('active');
            
            setTimeout(() => {
                message.classList.remove('active');
            }, 3000);
        }

        // Sidebar menu navigation
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all items
                document.querySelectorAll('.menu-item').forEach(i => {
                    i.classList.remove('active');
                });
                
                // Add active class to clicked item
                this.classList.add('active');
                
                // Hide all sections
                document.querySelectorAll('.tabs-container, .curriculum-container, .settings-panel').forEach(section => {
                    section.style.display = 'none';
                });
                
                // Show relevant section
                const target = this.getAttribute('href').substring(1);
                const targetElement = document.getElementById(target);
                if (targetElement) {
                    targetElement.style.display = 'block';
                    targetElement.classList.add('fade-in');
                }
            });
        });

        // Drag and Drop functionality
        let draggedElement = null;

        // For modules
        document.addEventListener('dragstart', function(e) {
            if (e.target.classList.contains('module')) {
                draggedElement = e.target;
                e.target.classList.add('dragging');
            } else if (e.target.classList.contains('lesson')) {
                draggedElement = e.target;
                e.target.classList.add('dragging');
            }
        });

        document.addEventListener('dragend', function(e) {
            if (e.target.classList.contains('module') || e.target.classList.contains('lesson')) {
                e.target.classList.remove('dragging');
            }
        });

        document.addEventListener('dragover', function(e) {
            e.preventDefault();
            
            if (!draggedElement) return;
            
            const container = draggedElement.classList.contains('module') 
                ? document.getElementById('modules-container')
                : draggedElement.closest('.module-content');
                
            const afterElement = getDragAfterElement(container, e.clientY);
            
            if (afterElement == null) {
                container.appendChild(draggedElement);
            } else {
                container.insertBefore(draggedElement, afterElement);
            }
        });

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.module:not(.dragging), .lesson:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Image upload
        document.getElementById('cover-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const uploadBox = document.querySelector('.image-upload');
                    uploadBox.innerHTML = `
                        <div class="image-preview">
                            <img src="${e.target.result}" alt="Course cover">
                            <div class="image-actions">
                                <button class="btn btn-icon btn-secondary btn-sm" onclick="changeCover()">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-icon btn-danger btn-sm" onclick="removeCover()">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    autoSave();
                };
                reader.readAsDataURL(file);
            }
        });

        // Preview functionality
        document.querySelector('.btn-secondary:has(.fa-eye)').addEventListener('click', function() {
            const previewBar = document.getElementById('preview-bar');
            previewBar.classList.add('active');
            
            // Open preview in new tab or iframe
            window.open('course-preview.html', '_blank');
        });

        // Publish course
        document.querySelector('.btn-success').addEventListener('click', function() {
            if (confirm('هل أنت متأكد من نشر الدورة؟ سيتمكن الطلاب من التسجيل فوراً.')) {
                // Change status
                const statusBadge = document.querySelector('.status-badge');
                statusBadge.className = 'status-badge published';
                statusBadge.innerHTML = '<i class="fas fa-circle" style="font-size: 0.5rem;"></i> منشورة';
                
                // Change button
                this.innerHTML = '<i class="fas fa-edit"></i> تعديل الدورة';
                this.className = 'btn btn-secondary btn-lg';
                
                showSuccessMessage();
            }
        });

        // Progress calculation
        function calculateProgress() {
            let totalFields = 0;
            let filledFields = 0;
            
            // Count all required fields
            document.querySelectorAll('.form-input, .form-textarea, .form-select').forEach(field => {
                totalFields++;
                if (field.value.trim() !== '') {
                    filledFields++;
                }
            });
            
            // Calculate percentage
            const progress = Math.round((filledFields / totalFields) * 100);
            
            // Update progress bar
            document.querySelector('.progress-fill').style.width = progress + '%';
            document.querySelector('.progress-value').textContent = progress + '%';
        }

        // Calculate initial progress
        calculateProgress();

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                autoSave();
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });

        // Mobile sidebar toggle
        let sidebarToggle = document.createElement('button');
        sidebarToggle.className = 'btn btn-icon btn-secondary';
        sidebarToggle.style.position = 'fixed';
        sidebarToggle.style.bottom = '2rem';
        sidebarToggle.style.left = '2rem';
        sidebarToggle.style.display = 'none';
        sidebarToggle.style.zIndex = '1000';
        sidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';

        if (window.innerWidth <= 768) {
            sidebarToggle.style.display = 'flex';
            document.body.appendChild(sidebarToggle);
        }

        sidebarToggle.addEventListener('click', function() {
            document.querySelector('.sidebar-nav').classList.toggle('active');
        });

        // Responsive check
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 768) {
                sidebarToggle.style.display = 'flex';
            } else {
                sidebarToggle.style.display = 'none';
                document.querySelector('.sidebar-nav').classList.remove('active');
            }
        });

        // Advanced features initialization
        function initializeAdvancedFeatures() {
            // Chapter markers for videos
            initializeChapterMarkers();
            
            // AI content suggestions
            initializeAISuggestions();
            
            // Collaboration features
            initializeCollaboration();
            
            // Analytics tracking
            initializeAnalytics();
        }

        function initializeChapterMarkers() {
            // Video chapter markers functionality
            console.log('Chapter markers initialized');
        }

        function initializeAISuggestions() {
            // AI-powered content suggestions
            const suggestButton = document.createElement('button');
            suggestButton.className = 'btn btn-secondary btn-sm';
            suggestButton.innerHTML = '<i class="fas fa-magic"></i> اقتراحات AI';
            suggestButton.style.marginRight = '1rem';
            
            // Add to relevant sections
            document.querySelectorAll('.form-section-title').forEach(title => {
                if (title.textContent.includes('معلومات الدورة')) {
                    title.appendChild(suggestButton);
                }
            });
        }

        function initializeCollaboration() {
            // Real-time collaboration indicators
            console.log('Collaboration features initialized');
        }

        function initializeAnalytics() {
            // Track user interactions
            console.log('Analytics tracking initialized');
        }

        // Initialize on load
        window.addEventListener('load', function() {
            initializeAdvancedFeatures();
            calculateProgress();
        });

        // Course analytics preview
        function showAnalyticsPreview() {
            const analyticsData = {
                expectedDuration: '14 ساعة',
                difficulty: 'متوسط',
                completionRate: '85%',
                engagementScore: '4.8/5'
            };
            
            console.log('Analytics Preview:', analyticsData);
        }

        // Export course structure
        function exportCourseStructure() {
            const courseData = {
                title: document.querySelector('.form-input').value,
                modules: [],
                settings: {}
            };
            
            // Collect all module data
            document.querySelectorAll('.module').forEach(module => {
                const moduleData = {
                    title: module.querySelector('.module-title').textContent,
                    lessons: []
                };
                
                module.querySelectorAll('.lesson').forEach(lesson => {
                    moduleData.lessons.push({
                        title: lesson.querySelector('.lesson-title').textContent,
                        type: lesson.querySelector('.lesson-icon').className,
                        duration: lesson.querySelector('.lesson-duration').textContent
                    });
                });
                
                courseData.modules.push(moduleData);
            });
            
            // Download as JSON
            const dataStr = JSON.stringify(courseData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportLink = document.createElement('a');
            exportLink.setAttribute('href', dataUri);
            exportLink.setAttribute('download', 'course-structure.json');
            exportLink.click();
        }

        // Import course structure
        function importCourseStructure() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const courseData = JSON.parse(e.target.result);
                    // Apply imported structure
                    console.log('Imported course:', courseData);
                    showSuccessMessage();
                };
                
                reader.readAsText(file);
            });
            
            input.click();
        }

        // Final setup
        console.log('Course Builder Pro initialized successfully!');
    </script>
<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="../js/firebase-config.js"></script>

<script>
// إصلاح مشكلة course-preview.html
if (window.location.pathname.includes('course-preview.html')) {
    // للمعاينة فقط
    window.addEventListener('load', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('courseId');
        
        if (courseId && typeof db !== 'undefined') {
            db.collection('courses').doc(courseId).get().then(doc => {
                if (doc.exists) {
                    const course = doc.data();
                    document.getElementById('course-title').textContent = course.title || 'دورة جديدة';
                    // عرض باقي البيانات
                }
            }).catch(error => {
                console.error('Error loading course:', error);
            });
        }
    });
} else {
    // لصفحة course-builder فقط
    
    // إضافة وظيفة الحفظ لـ Firebase
    window.firebaseSaveCourse = async function() {
        try {
            const courseData = {
                title: document.querySelector('input[value*="ملاذ"]')?.value || 'دورة جديدة',
                subtitle: document.querySelector('input[placeholder*="عنوان فرعي"]')?.value || '',
                description: document.querySelector('textarea[placeholder*="وصف"]')?.value || '',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            const urlParams = new URLSearchParams(window.location.search);
            let courseId = urlParams.get('id');
            
            if (courseId && courseId !== 'new') {
                await db.collection('courses').doc(courseId).update(courseData);
            } else {
                const docRef = await db.collection('courses').add(courseData);
                courseId = docRef.id;
                window.history.replaceState({}, '', `?id=${courseId}`);
            }
            
            console.log('تم حفظ الدورة:', courseId);
            showSuccessMessage();
            return courseId;
            
        } catch (error) {
            console.error('خطأ في الحفظ:', error);
            alert('حدث خطأ في الحفظ');
        }
    };
    
    // ربط زر النشر بالحفظ
    const publishBtn = document.querySelector('.btn-success');
    if (publishBtn) {
        publishBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            const courseId = await firebaseSaveCourse();
            if (courseId) {
                alert('تم نشر الدورة بنجاح!');
            }
        });
    }
    
    // ربط زر المعاينة
    const previewBtn = document.querySelector('button:has(.fa-eye)');
    if (previewBtn) {
        previewBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            const courseId = await firebaseSaveCourse();
            if (courseId) {
                window.open(`course-preview.html?courseId=${courseId}`, '_blank');
            }
        });
    }
}
</script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="../js/firebase-config.js"></script>
<script src="../js/course-builder-firebase.js"></script>
</body>
</html>
