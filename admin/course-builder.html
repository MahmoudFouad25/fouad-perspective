<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بناء دورة جديدة - منصة فؤاد</title>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f3f4f6;
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-card: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #e5e7eb;
            --text-muted: #9ca3af;
            --border-color: #4b5563;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Layout */
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }

        .main-content {
            flex: 1;
            background-color: var(--bg-primary);
            overflow-x: hidden;
        }

        /* Header Styles */
        .page-header {
            background-color: var(--bg-secondary);
            padding: 2rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .page-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .breadcrumb {
            background: transparent;
            padding: 0;
            margin: 0;
        }

        .breadcrumb-item {
            color: var(--text-muted);
        }

        .breadcrumb-item.active {
            color: var(--text-secondary);
        }

        /* Builder Container */
        .builder-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem 2rem;
        }

        /* Progress Bar */
        .progress-tracker {
            background-color: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
        }

        .progress {
            height: 0.5rem;
            background-color: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .progress-bar {
            background-color: var(--primary);
            transition: width 0.3s ease;
        }

        .step-indicators {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .step-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .step-indicator:hover {
            transform: translateY(-2px);
        }

        .step-number {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background-color: var(--bg-card);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .step-indicator.active .step-number {
            background-color: var(--primary);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }

        .step-indicator.completed .step-number {
            background-color: var(--success);
            border-color: var(--success);
            color: white;
        }

        .step-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            text-align: center;
            max-width: 100px;
        }

        .step-indicator.active .step-label,
        .step-indicator.completed .step-label {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Form Styles */
        .builder-form {
            background-color: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-md);
        }

        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .form-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title i {
            color: var(--primary);
        }

        .form-label {
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-label .required {
            color: var(--danger);
        }

        .form-control,
        .form-select {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: var(--radius-md);
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus,
        .form-select:focus {
            background-color: var(--bg-card);
            border-color: var(--primary);
            color: var(--text-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        .form-text {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Switches */
        .form-switch {
            padding-left: 3rem;
        }

        .form-switch .form-check-input {
            width: 3rem;
            height: 1.5rem;
            background-color: var(--bg-card);
            border-color: var(--border-color);
            cursor: pointer;
        }

        .form-switch .form-check-input:checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background-color: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--bg-primary);
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #059669;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-outline-primary {
            background-color: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary);
            color: white;
        }

        /* Cards */
        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* File Upload */
        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            padding: 3rem;
            text-align: center;
            background-color: var(--bg-card);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background-color: rgba(99, 102, 241, 0.05);
        }

        .file-upload-area i {
            font-size: 3rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        /* Image Preview */
        .image-preview {
            position: relative;
            border-radius: var(--radius-lg);
            overflow: hidden;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
        }

        .image-preview img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .image-preview .remove-image {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: var(--danger);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-preview .remove-image:hover {
            background-color: #dc2626;
        }
/* زر تثبيت الرابط */
#saveSlugBtn {
    transition: all 0.3s ease;
    font-weight: 600;
}

#saveSlugBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

#saveSlugBtn.btn-success {
    background-color: #10b981;
    border-color: #10b981;
}

#saveSlugBtn.btn-danger {
    animation: shake 0.5s;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

/* تنسيق خاص لحقل الـ Slug */
#courseSlug {
    font-family: monospace;
    font-weight: 600;
    letter-spacing: 0.5px;
    background-color: rgba(99, 102, 241, 0.05);
}

        /* Tags Input */
        .tags-input {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 0.5rem;
            min-height: 3rem;
        }

        .tag {
            background-color: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tag .remove-tag {
            cursor: pointer;
            font-size: 1rem;
        }

        .price-preview-container {
    background-color: var(--bg-card);
    padding: 20px;
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
}

.preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.preview-card {
    background: var(--bg-secondary);
    padding: 20px;
    border-radius: var(--radius-md);
    text-align: center;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

.preview-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.preview-card.featured {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.1);
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
}

.preview-card h5 {
    font-size: 0.9rem;
    margin-bottom: 10px;
    color: var(--text-secondary);
}

.price-display {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--primary);
    margin: 10px 0;
}

.discount-badge {
    display: inline-block;
    background: rgba(16, 185, 129, 0.2);
    color: var(--success);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
}

.preview-section-title {
    grid-column: 1 / -1;
    text-align: center;
    margin: 20px 0 10px;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 1.1rem;
}

.preview-card.payment-plan {
    background-color: rgba(99, 102, 241, 0.05);
    border-color: rgba(99, 102, 241, 0.3);
}

.preview-card.group {
    background-color: rgba(251, 191, 36, 0.05);
    border-color: rgba(251, 191, 36, 0.3);
}


.price-amount {
    font-size: 24px;
    font-weight: bold;
    color: var(--primary);
    margin: 10px 0;
}

.discount-info {
    color: #28a745;
    font-size: 14px;
}
        /* تحسين شكل معاينة خطط الدفع */
.preview-card .price-display {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 5px;
}

.preview-card small {
    color: var(--text-muted);
    display: block;
    margin-top: 5px;
}

        /* Module Builder */
        .module-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .module-header {
            background-color: var(--bg-secondary);
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: move;
        }

        .module-header .drag-handle {
            color: var(--text-muted);
            margin-left: 0.5rem;
        }

        .module-content {
            padding: 1rem;
        }

        .lesson-item {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: move;
        }

        .lesson-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .lesson-type-icon {
            width: 2.5rem;
            height: 2.5rem;
            background-color: var(--primary);
            color: white;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Navigation */
        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .builder-container {
                padding: 0 1rem 1rem;
            }

            .step-indicators {
                flex-wrap: wrap;
                gap: 1rem;
            }

            .step-navigation {
                flex-direction: column-reverse;
                gap: 1rem;
            }

            .step-navigation .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Quill Editor Custom Styles */
        .ql-toolbar.ql-snow {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .ql-container.ql-snow {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            color: var(--text-primary);
        }

        .ql-editor {
            min-height: 200px;
            font-family: 'Cairo', sans-serif;
        }

        .ql-snow .ql-stroke {
            stroke: var(--text-secondary);
        }

        .ql-snow .ql-fill {
            fill: var(--text-secondary);
        }

        .ql-snow .ql-picker {
            color: var(--text-secondary);
        }

        /* Alert Styles */
        .alert {
            border-radius: var(--radius-md);
            border: none;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .alert-info {
            background-color: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .alert-success {
            background-color: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .alert-warning {
            background-color: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        .alert-danger {
            background-color: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid var(--bg-card);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Auto-save indicator */
        .auto-save-indicator {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .auto-save-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .auto-save-indicator i {
            color: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Tooltips */
        .tooltip-wrapper {
            position: relative;
            display: inline-block;
        }

        .tooltip-content {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 10;
            margin-bottom: 0.5rem;
        }

        .tooltip-wrapper:hover .tooltip-content {
            opacity: 1;
            visibility: visible;
        }

        /* Accordion styles for advanced sections */
        .accordion {
            background-color: transparent;
        }

        .accordion-item {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            margin-bottom: 0.5rem;
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .accordion-header {
            margin: 0;
        }

        .accordion-button {
            background-color: var(--bg-card);
            color: var(--text-primary);
            border: none;
            padding: 1rem 1.5rem;
            font-weight: 500;
        }

        .accordion-button:not(.collapsed) {
            background-color: var(--bg-secondary);
            color: var(--primary);
        }

        .accordion-button:focus {
            box-shadow: none;
        }

        .accordion-button::after {
            filter: invert(1);
        }

        .accordion-body {
            background-color: var(--bg-card);
            color: var(--text-secondary);
            padding: 1.5rem;
        }

        /* Step content */
        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Badge styles */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-primary {
            background-color: var(--primary);
            color: white;
        }

        .badge-success {
            background-color: var(--success);
            color: white;
        }

        .badge-warning {
            background-color: var(--warning);
            color: white;
        }

        .badge-danger {
            background-color: var(--danger);
            color: white;
        }

        /* List items */
        .list-group {
            background-color: transparent;
        }

        .list-group-item {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 1rem 1.5rem;
            margin-bottom: 0.5rem;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .list-group-item:hover {
            background-color: var(--bg-secondary);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .empty-state p {
            margin-bottom: 1.5rem;
        }

        /* Price input group */
        .price-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .price-input-group .currency-label {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Module statistics */
        .module-stats {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--bg-card);
            border-radius: var(--radius-md);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Payment method cards */
        .payment-method-card {
            background-color: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .payment-method-card.active {
            border-color: var(--primary);
            background-color: rgba(99, 102, 241, 0.05);
        }

        .payment-method-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .payment-method-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
        }

        .payment-method-icon {
            width: 2.5rem;
            height: 2.5rem;
            background-color: var(--primary);
            color: white;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* إصلاح ألوان خطط الدفع */
#paymentPlansList .card {
    background-color: var(--bg-card);
    border: 1px solid var(--border-color);
}

#paymentPlansList .card-body {
    color: var(--text-primary);
}

#paymentPlansList h5 {
    color: var(--text-primary);
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
}

#paymentPlansList p {
    color: var(--text-secondary);
    margin-bottom: 0;
}

#paymentPlansList .btn-info {
    background-color: var(--info);
    border-color: var(--info);
    color: white;
}

#paymentPlansList .btn-info:hover {
    background-color: #2563eb;
    border-color: #2563eb;
}
        // إضافة CSS للكوبونات والمنح
const additionalCSS = `
.preview-card.coupon {
    background-color: rgba(139, 92, 246, 0.05);
    border-color: rgba(139, 92, 246, 0.3);
}

/* CSS لمعاينة المنح */
.preview-card.grant {
    background-color: rgba(16, 185, 129, 0.05);
    border-color: rgba(16, 185, 129, 0.3);
}

.preview-card.grant h5 {
    color: var(--text-primary);
    font-weight: 500;
}
`;
/* ============ قسم المنح المرن ============ */
.grant-types-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 10px;
}

.grant-types-grid .form-check {
    background: var(--bg-secondary);
    padding: 15px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

.grant-types-grid .form-check:hover {
    border-color: var(--primary);
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
}

.grant-types-grid .form-check-label {
    cursor: pointer;
    width: 100%;
}

.grant-types-grid .form-check-label strong {
    color: var(--text-primary);
    display: block;
    margin-bottom: 5px;
}

.criteria-list {
    background: var(--bg-secondary);
    padding: 20px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
}

.criterion-item {
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color);
}

.criterion-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.evaluation-criteria .form-check-label {
    color: var(--text-primary);
    margin-left: 10px;
}

#grantsSettings .alert-info {
    background-color: rgba(99, 102, 241, 0.1);
    border-color: rgba(99, 102, 241, 0.3);
    color: var(--text-primary);
}

#grantsSettings .alert-info h5 {
    color: var(--primary);
    margin-bottom: 10px;
}

#grantsSettings .alert-info ul {
    margin-bottom: 0;
    padding-left: 25px;
}

#grantsSettings .alert-info li {
    margin-bottom: 5px;
    color: var(--text-secondary);
}

/* ========== جدول الأسعار الاحترافي الجديد ========== */
.pricing-master-table {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    padding: 2.5rem;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.table-main-header {
    text-align: center;
    color: #fbbf24;
    font-size: 1.8rem;
    margin-bottom: 2rem;
    font-weight: 700;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

.main-pricing-table,
.secondary-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    overflow: hidden;
    backdrop-filter: blur(10px);
}

.main-pricing-table thead,
.secondary-table thead {
    background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
}

.main-pricing-table th,
.secondary-table th {
    padding: 1.2rem;
    text-align: right;
    color: white;
    font-weight: 600;
    font-size: 0.95rem;
    letter-spacing: 0.5px;
}

.main-pricing-table td,
.secondary-table td {
    padding: 1.2rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    color: #e5e7eb;
    vertical-align: middle;
}

.main-pricing-table tbody tr,
.secondary-table tbody tr {
    transition: all 0.3s ease;
}

.main-pricing-table tbody tr:hover,
.secondary-table tbody tr:hover {
    background: rgba(99, 102, 241, 0.1);
    transform: scale(1.01);
}

/* صف السعر الأساسي */
.base-price-row {
    background: rgba(251, 191, 36, 0.1);
}

/* العروض المميزة */
.premium-offer {
    background: rgba(139, 92, 246, 0.1);
}

.early-offer {
    background: rgba(16, 185, 129, 0.1);
}

/* الأسعار */
.main-price {
    font-size: 1.8rem;
    font-weight: 700;
    color: #10b981;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
}

.price-cell {
    text-align: center;
    font-weight: bold;
}

/* خيارات الدفع */
.payment-options-cell {
    padding: 0.5rem 1rem;
}

.payment-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    margin-bottom: 0.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
}

.payment-option:hover {
    background: rgba(99, 102, 241, 0.2);
    border-color: #6366f1;
}

.cash-option {
    background: rgba(16, 185, 129, 0.1);
    border-color: rgba(16, 185, 129, 0.3);
}

.option-label {
    color: #9ca3af;
    font-size: 0.9rem;
}

.option-price {
    color: #fbbf24;
    font-weight: 600;
    font-size: 1.1rem;
}

.discount-badge {
    background: #10b981;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
}

.discount-percent {
    color: #10b981;
    font-weight: 600;
}

.date-range {
    color: #9ca3af;
    font-size: 0.8rem;
}

.no-options {
    color: #6b7280;
    font-style: italic;
    text-align: center;
    padding: 1rem;
}

/* رؤوس الأقسام */
.section-header {
    color: #fbbf24;
    font-size: 1.4rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* الكوبونات */
.coupon-code {
    font-family: 'Courier New', monospace;
    font-size: 1.2rem;
    font-weight: 700;
    color: #818cf8;
    letter-spacing: 2px;
}

/* جدول المنح */
.grants-table {
    background: rgba(16, 185, 129, 0.05);
}

.grants-table td {
    color: #d1fae5;
}

/* Responsive */
@media (max-width: 768px) {
    .pricing-master-table {
        padding: 1.5rem;
    }
    
    .table-main-header {
        font-size: 1.4rem;
    }
    
    .main-pricing-table,
    .secondary-table {
        font-size: 0.85rem;
    }
    
    .main-price {
        font-size: 1.3rem;
    }
    
    .payment-option {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .modern-pricing-table {
        font-size: 0.9rem;
    }
    
    .modern-pricing-table th,
    .modern-pricing-table td {
        padding: 0.75rem 0.5rem;
    }
    
    .price-amount {
        font-size: 1.2rem;
    }
    
    .payment-options {
        font-size: 0.85rem;
    }
}

/* Library Content Styles */

        /* Library Content Styles */
.library-content-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.library-content-card:hover {
    border-color: #6366f1 !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
}

/* Spinner animation */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Auto-save Indicator -->
    <div class="auto-save-indicator" id="autoSaveIndicator">
        <i class="fas fa-check-circle"></i>
        <span>تم الحفظ تلقائياً</span>
    </div>

    <!-- Main Layout -->
    <div class="admin-layout">
        <div class="main-content">
            <!-- Page Header -->
            <header class="page-header">
                <div class="container-fluid">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/admin">لوحة التحكم</a></li>
                            <li class="breadcrumb-item"><a href="/fouad-perspective/admin/courses.html">الدورات</a></li>
                            <li class="breadcrumb-item active">دورة جديدة</li>
                        </ol>
                    </nav>
                    <h1 id="courseTitleHeader">دورة جديدة</h1>
                </div>
            </header>

            <!-- Main Content -->
            <main class="builder-container">
                <!-- Progress Tracker -->
                <div class="progress-tracker">
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" style="width: 20%"></div>
                    </div>
                    <div class="step-indicators">
                        <div class="step-indicator active" onclick="showStep(1)">
                            <div class="step-number">1</div>
                            <div class="step-label">المعلومات الأساسية</div>
                        </div>
                        <div class="step-indicator" onclick="showStep(2)">
                            <div class="step-number">2</div>
                            <div class="step-label">التسعير والدفع</div>
                        </div>
                        <div class="step-indicator" onclick="showStep(3)">
                            <div class="step-number">3</div>
                            <div class="step-label">بناء المنهج</div>
                        </div>
                        <div class="step-indicator" onclick="showStep(4)">
                            <div class="step-number">4</div>
                            <div class="step-label">الإعدادات المتقدمة</div>
                        </div>
                        <div class="step-indicator" onclick="showStep(5)">
                            <div class="step-number">5</div>
                            <div class="step-label">المراجعة والنشر</div>
                        </div>
                    </div>
                </div>

                <!-- Form Steps -->
                <div class="builder-form">
                    <!-- Step 1: Basic Information -->
                    <div class="step-content active" id="step1">
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-info-circle"></i>
                                معلومات الدورة الأساسية
                            </h2>
                            
                            <div class="row">
                                <div class="col-lg-8 mb-3">
                                    <label class="form-label">
                                        عنوان الدورة <span class="required">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="courseTitle" 
       placeholder="مثال: دورة احتراف التصميم الجرافيكي"
       onchange="updateCourseTitle(this.value)" required>
                                    <div class="form-text">اختر عنواناً واضحاً وجذاباً يصف محتوى الدورة</div>
                                </div>
                                
                                <div class="col-lg-4 mb-3">
                                    <label class="form-label">الرابط المخصص (Slug)</label>
                                    <div class="input-group">
    <input type="text" class="form-control" id="courseSlug" 
           placeholder="يتم توليده تلقائياً" dir="ltr">
    <button class="btn btn-primary" type="button" onclick="saveCourseSlug()" 
            id="saveSlugBtn" style="min-width: 140px;">
        <i class="fas fa-link"></i> تثبيت الرابط
    </button>
</div>
<div class="form-text">
    <span class="text-danger">
        <i class="fas fa-exclamation-circle"></i> 
        مهم جداً: اضغط "تثبيت الرابط" فور كتابة العنوان لحفظه في Firebase
    </span>
</div>
                                    <div class="form-text">سيظهر في: /courses/<span id="slugPreview">course-name</span></div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">العنوان الفرعي</label>
                                <input type="text" class="form-control" id="subtitle" 
                                       placeholder="وصف قصير يظهر تحت العنوان الرئيسي">
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">الوصف المختصر <span class="required">*</span></label>
                                    <textarea class="form-control" id="description" rows="4" 
                                              placeholder="وصف مختصر للدورة (150-200 كلمة)" required></textarea>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">الوصف التفصيلي</label>
                                    <textarea class="form-control" id="detailedDescription" rows="4" 
                                              placeholder="وصف تفصيلي يظهر في صفحة الدورة"></textarea>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">اللغة <span class="required">*</span></label>
                                    <select class="form-select" id="language" required>
                                        <option value="ar">العربية</option>
                                        <option value="en">English</option>
                                        <option value="ar-en">عربي + English</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">الجمهور المستهدف</label>
                                    <select class="form-select" id="targetAudience">
    <option value="">من يحتاج هذه الدورة في رحلته؟</option>
    
    <optgroup label="الغرباء - لم يبدأوا الرحلة بعد">
        <option value="comfortable-sleepers">النائمون المرتاحون - يعيشون في الوهم دون وعي</option>
        <option value="restless-sleepers">النائمون القلقون - يشعرون أن شيئاً ما ليس صحيحاً</option>
        <option value="disturbed-dreamers">الحالمون المضطربون - بدأت الأقنعة تضايقهم</option>
    </optgroup>
    
    <optgroup label="المستيقظون - بدأوا يرون">
        <option value="newly-awakened">المستيقظون حديثاً - صُدموا من رؤية أقنعتهم</option>
        <option value="confused-seekers">الباحثون الحائرون - يريدون الحقيقة لكن لا يعرفون الطريق</option>
        <option value="resistant-fighters">المقاومون المكافحون - يحاربون الأقنعة لكن بطريقة خاطئة</option>
    </optgroup>
    
    <optgroup label="السائرون - في الطريق">
        <option value="brave-walkers">السائرون الشجعان - بدأوا خلع الأقنعة رغم الألم</option>
        <option value="stumbling-travelers">المتعثرون المثابرون - يقعون ويقومون في الرحلة</option>
        <option value="steady-progressers">المتقدمون بثبات - وجدوا إيقاعهم في الرحلة</option>
    </optgroup>
    
    <optgroup label="الواصلون - يعيشون الحياة الطيبة">
        <option value="integrated-beings">المتكاملون - يعيشون من الأصالة</option>
        <option value="serving-guides">المرشدون الخادمون - يريدون مساعدة الآخرين</option>
        <option value="wisdom-sharers">ناقلو الحكمة - يشاركون ثمار رحلتهم</option>
    </optgroup>
</select>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">فيديو تعريفي</label>
                                    <input type="url" class="form-control" id="introVideo" 
                                           placeholder="رابط YouTube أو Vimeo" dir="ltr">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-bullseye"></i>
                                أهداف ومتطلبات الدورة
                            </h2>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">أهداف الدورة</label>
                                    <div id="objectivesList" class="mb-2"></div>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="objectiveInput" 
                                               placeholder="أضف هدف جديد">
                                        <button class="btn btn-primary" onclick="addObjective()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">ماذا سيتعلم الطلاب من هذه الدورة؟</div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">المتطلبات المسبقة</label>
                                    <div id="requirementsList" class="mb-2"></div>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="requirementInput" 
                                               placeholder="أضف متطلب جديد">
                                        <button class="btn btn-primary" onclick="addRequirement()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">ما الذي يحتاجه الطالب قبل البدء؟</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-image"></i>
                                الصور والوسائط
                            </h2>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">صورة الدورة الرئيسية</label>
                                    <div class="file-upload-area" onclick="document.getElementById('thumbnailInput').click()">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p>اسحب الصورة هنا أو انقر للاختيار</p>
                                        <small class="text-muted">JPG, PNG (1920x1080px مستحسن)</small>
                                    </div>
                                    <input type="file" id="thumbnailInput" accept="image/*" style="display: none;" 
                                           onchange="handleImageUpload(this, 'thumbnail')">
                                    <div id="thumbnailPreview" class="image-preview mt-2" style="display: none;">
                                        <img id="thumbnailImage" src="" alt="">
                                        <button class="remove-image" onclick="removeImage('thumbnail')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">صورة وسائل التواصل</label>
                                    <div class="file-upload-area" onclick="document.getElementById('socialImageInput').click()">
                                        <i class="fas fa-share-alt"></i>
                                        <p>صورة للمشاركة على السوشيال ميديا</p>
                                        <small class="text-muted">JPG, PNG (1200x630px مستحسن)</small>
                                    </div>
                                    <input type="file" id="socialImageInput" accept="image/*" style="display: none;" 
                                           onchange="handleImageUpload(this, 'social')">
                                    <div id="socialImagePreview" class="image-preview mt-2" style="display: none;">
                                        <img id="socialImage" src="" alt="">
                                        <button class="remove-image" onclick="removeImage('social')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">صورة المدرب</label>
                                    <div class="file-upload-area" onclick="document.getElementById('instructorImageInput').click()">
                                        <i class="fas fa-user-tie"></i>
                                        <p>صورة شخصية للمدرب</p>
                                        <small class="text-muted">JPG, PNG (مربعة مستحسن)</small>
                                    </div>
                                    <input type="file" id="instructorImageInput" accept="image/*" style="display: none;" 
                                           onchange="handleImageUpload(this, 'instructor')">
                                    <div id="instructorImagePreview" class="image-preview mt-2" style="display: none;">
                                        <img id="instructorImage" src="" alt="">
                                        <button class="remove-image" onclick="removeImage('instructor')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-chalkboard-teacher"></i>
                                معلومات المدرب
                            </h2>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">اسم المدرب <span class="required">*</span></label>
                                    <input type="text" class="form-control" id="instructorName" 
                                           placeholder="الاسم الكامل" required>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">المسمى الوظيفي</label>
                                    <input type="text" class="form-control" id="instructorTitle" 
                                           placeholder="مثال: خبير تصميم جرافيك">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">نبذة عن المدرب</label>
                                <textarea class="form-control" id="instructorBio" rows="4" 
                                          placeholder="نبذة مختصرة عن خبرات ومؤهلات المدرب"></textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">LinkedIn</label>
                                    <input type="url" class="form-control" id="instructorLinkedIn" 
                                           placeholder="https://linkedin.com/in/username" dir="ltr">
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Twitter/X</label>
                                    <input type="url" class="form-control" id="instructorTwitter" 
                                           placeholder="https://twitter.com/username" dir="ltr">
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">الموقع الشخصي</label>
                                    <input type="url" class="form-control" id="instructorWebsite" 
                                           placeholder="https://example.com" dir="ltr">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-tags"></i>
                                التصنيف والكلمات المفتاحية
                            </h2>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">مجال التطبيق </label>
                                    <select class="form-select" id="applicationDomain">
    <option value="">في أي مجال من مجالات الحياة؟</option>
    
    <optgroup label="الذات - رحلة داخلية">
        <option value="self-masks">كشف أقنعة الذات - رؤية الوجه الحقيقي</option>
        <option value="heart-awakening">إحياء الفؤاد - إيقاظ القلب الميت</option>
        <option value="illusion-breaking">كسر الأوهام - التحرر من الإضافة/الإزالة/التجاوز</option>
        <option value="authentic-living">العيش الأصيل - الحياة من المركز الحقيقي</option>
    </optgroup>
    
    <optgroup label="العلاقات - رحلة مع الآخرين">
        <option value="family-healing">شفاء الأسرة - علاقات بلا أقنعة</option>
        <option value="marriage-depth">عمق الزواج - الحب من القلب للقلب</option>
        <option value="parenting-wisdom">حكمة التربية - تربية على الفطرة</option>
        <option value="friendship-truth">صدق الصداقة - علاقات على الحقيقة</option>
    </optgroup>
    
    <optgroup label="العمل - رحلة في المهنة">
        <option value="work-purpose">غاية العمل - من الوظيفة للرسالة</option>
        <option value="leadership-heart">قيادة القلب - القيادة بالرحمة</option>
        <option value="creative-flow">تدفق الإبداع - الإبداع من الفؤاد</option>
        <option value="service-excellence">إتقان الخدمة - الإحسان في العمل</option>
    </optgroup>
    
    <optgroup label="الحياة - رحلة شاملة">
        <option value="health-holistic">الصحة الشاملة - علاج الجسد والروح</option>
        <option value="money-wisdom">حكمة المال - من الجشع للكفاية</option>
        <option value="time-presence">حضور الوقت - من الهروب للحضور</option>
        <option value="life-balance">توازن الحياة - الحياة الطيبة</option>
    </optgroup>
</select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">عمق الممارسة</label>
                                    <select class="form-select" id="practiceDepth">
    <option value="">ما مستوى العمق المطلوب؟</option>
    
    <option value="first-touch">اللمسة الأولى - تعريف لطيف يفتح الباب</option>
    <option value="gentle-intro">المقدمة الرقيقة - دعوة آمنة للاستكشاف</option>
    <option value="safe-exploration">الاستكشاف الآمن - مساحة محمية للتجربة</option>
    <option value="guided-practice">الممارسة الموجهة - تطبيق مع مرافقة</option>
    <option value="deep-diving">الغوص العميق - مواجهة الظلال والجروح</option>
    <option value="intensive-work">العمل المكثف - تفكيك وإعادة بناء</option>
    <option value="transformation-journey">رحلة التحول - مرافقة طويلة المدى</option>
    <option value="integration-mastery">التكامل والإتقان - تجسيد كامل للمنظور</option>
</select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">الكلمات المفتاحية</label>
                                <div class="tags-input" id="keywordsTags"></div>
                                <input type="text" class="form-control mt-2" id="keywordInput" 
                                       placeholder="اكتب كلمة مفتاحية واضغط Enter">
                                <div class="form-text">أضف كلمات مفتاحية لتحسين ظهور الدورة في البحث</div>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <div></div>
                            <button class="btn btn-primary" onclick="showStep(2)">
                                التالي <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>

<!-- Step 2: التسعير والدفع -->
<div class="step-content" id="step2">
    <!-- القسم الأساسي للتسعير -->
    <div class="form-section">
        <h2 class="section-title">
            <i class="fas fa-tag"></i>
            التسعير الأساسي
        </h2>
        
        <div class="row">
            <div class="col-md-3 mb-3">
                <label class="form-label">نوع التسعير <span class="required">*</span></label>
                <select class="form-select" id="priceType" onchange="updatePricingFields()">
                    <option value="free">مجانية</option>
                    <option value="paid-enrolled">مدفوعة - مسجلة</option>
                    <option value="paid-direct">مدفوعة - مباشر</option>
                </select>
            </div>
            
            <div class="col-md-3 mb-3">
                <label class="form-label">العملة</label>
                <select class="form-select" id="currency" onchange="updateCurrencyLabel()">
                    <option value="EGP">جنيه مصري (EGP)</option>
                    <option value="SAR">ريال سعودي (SAR)</option>
                    <option value="USD">دولار أمريكي (USD)</option>
                    <option value="EUR">يورو (EUR)</option>
                    <option value="AED">درهم إماراتي (AED)</option>
                </select>
            </div>
            
            <div class="col-md-3 mb-3" id="priceField" style="display: none;">
                <label class="form-label">سعر الدورة <span class="required">*</span></label>
                <div class="price-input-group">
                    <input type="number" class="form-control" id="price" 
                           placeholder="0" min="0" step="1" onchange="updatePricePreview()">
                    <span class="currency-label" id="currencyLabel">EGP</span>
                </div>
            </div>
            
            <div class="col-md-3 mb-3" id="salePriceField" style="display: none;">
                <label class="form-label">سعر التخفيض (اختياري)</label>
                <input type="number" class="form-control" id="salePrice" 
                       placeholder="0" min="0" step="1" onchange="updatePricePreview()">
            </div>
        </div>
    </div>

    <!-- العروض والخصومات الزمنية -->
    <div class="form-section">
        <h2 class="section-title">
            <i class="fas fa-clock"></i>
            العروض والخصومات الزمنية
        </h2>
        
        <div id="discountsList" class="mb-3"></div>
        
        <button class="btn btn-outline-primary" onclick="addDiscountTier()">
            <i class="fas fa-plus"></i> إضافة عرض خصم
        </button>
    </div>

    <!-- خصم الدفع الكامل -->
    <div class="form-section">
        <h2 class="section-title">
            <i class="fas fa-money-bill-wave"></i>
            خصم الدفع الكامل
        </h2>
        
        <div class="form-check mb-3">
            <input type="checkbox" class="form-check-input" id="enableCashDiscount" onchange="toggleCashDiscount()">
            <label class="form-check-label" for="enableCashDiscount">
                تفعيل خصم للدفع الكامل (كاش)
            </label>
        </div>
        
        <div id="cashDiscountSection" style="display: none;">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">نسبة الخصم</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="cashDiscountPercent" 
                               value="5" min="0" max="50" onchange="updatePricePreview()">
                        <span class="input-group-text">%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- خصومات المجموعات -->
    <div class="form-section">
        <h2 class="section-title">
            <i class="fas fa-users"></i>
            خصومات المجموعات
        </h2>
        
        <div id="groupDiscountsList" class="mb-3"></div>
        
        <button class="btn btn-outline-primary" onclick="addGroupDiscount()">
            <i class="fas fa-plus"></i> إضافة عرض مجموعات
        </button>
    </div>

    <!-- خطط الدفع والتقسيط -->
    <div class="form-section">
        <h2 class="section-title">
            <i class="fas fa-calendar-alt"></i>
            خطط الدفع والتقسيط
        </h2>
        
        <div id="paymentPlansList" class="mb-3"></div>
        
        <button class="btn btn-outline-primary" onclick="addPaymentPlan()">
            <i class="fas fa-plus"></i> إضافة خطة دفع
        </button>
    </div>

    <!-- كوبونات الخصم -->
    <div class="form-section">
        <h2 class="section-title">
            <i class="fas fa-ticket-alt"></i>
            كوبونات الخصم
        </h2>
        
        <div id="couponsList" class="mb-3"></div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <input type="text" class="form-control" id="couponCode" 
                       placeholder="كود الكوبون" style="text-transform: uppercase;">
            </div>
            <div class="col-md-3 mb-3">
                <select class="form-select" id="couponType">
                    <option value="percentage">نسبة مئوية</option>
                    <option value="fixed">مبلغ ثابت</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <input type="number" class="form-control" id="couponValue" 
                       placeholder="القيمة" min="0">
            </div>
            <div class="col-md-2 mb-3">
                <button class="btn btn-primary w-100" onclick="addCoupon()">
                    <i class="fas fa-plus"></i> إضافة
                </button>
            </div>
        </div>
    </div>

    <!-- برنامج المنح -->
    <div class="form-section">
        <h2 class="section-title">
            <i class="fas fa-graduation-cap"></i>
            برنامج المنح الدراسية
        </h2>
        
        <div class="form-check mb-3">
            <input type="checkbox" class="form-check-input" id="enableGrants" onchange="toggleGrants()">
            <label class="form-check-label" for="enableGrants">
                تفعيل برنامج المنح لهذه الدورة
            </label>
        </div>
        
        <div id="grantsSection" style="display: none;">
            <div id="grantPlansList" class="mb-3"></div>
            
            <button class="btn btn-outline-primary" onclick="addGrantPlan()">
                <i class="fas fa-plus"></i> إضافة خطة منحة
            </button>
        </div>
    </div>

    <!-- طرق الدفع -->
    <div class="form-section">
        <h2 class="section-title">
            <i class="fas fa-credit-card"></i>
            طرق الدفع المتاحة
        </h2>
        
        <!-- Vodafone Cash -->
        <div class="payment-method-card">
            <div class="payment-method-header">
                <div class="payment-method-title">
                    <div class="payment-method-icon">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <span>فودافون كاش</span>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="vodafoneEnabled" 
                           checked onchange="togglePaymentMethod('vodafone')">
                </div>
            </div>
            <div class="payment-method-content" id="vodafoneContent">
                <label class="form-label">رقم فودافون كاش</label>
                <input type="tel" class="form-control" id="vodafoneNumber" 
                       placeholder="01XXXXXXXXX" dir="ltr">
            </div>
        </div>

        <!-- InstaPay -->
        <div class="payment-method-card">
            <div class="payment-method-header">
                <div class="payment-method-title">
                    <div class="payment-method-icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <span>InstaPay</span>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="instapayEnabled" 
                           checked onchange="togglePaymentMethod('instapay')">
                </div>
            </div>
            <div class="payment-method-content" id="instapayContent">
                <label class="form-label">رقم InstaPay</label>
                <input type="tel" class="form-control" id="instapayNumber" 
                       placeholder="01XXXXXXXXX" dir="ltr">
            </div>
        </div>

        <!-- Bank Transfer -->
        <div class="payment-method-card">
            <div class="payment-method-header">
                <div class="payment-method-title">
                    <div class="payment-method-icon">
                        <i class="fas fa-university"></i>
                    </div>
                    <span>تحويل بنكي</span>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="bankEnabled" 
                           onchange="togglePaymentMethod('bank')">
                </div>
            </div>
            <div class="payment-method-content" id="bankContent" style="display: none;">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">اسم البنك</label>
                        <input type="text" class="form-control" id="bankName" 
                               placeholder="مثال: البنك الأهلي المصري">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">رقم الحساب</label>
                        <input type="text" class="form-control" id="bankAccountNumber" 
                               placeholder="رقم الحساب البنكي" dir="ltr">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">اسم صاحب الحساب</label>
                    <input type="text" class="form-control" id="bankAccountName" 
                           placeholder="الاسم كما يظهر في البنك">
                </div>
            </div>
        </div>
    </div>

    <!-- معاينة الأسعار -->
    <div class="form-section">
        <h2 class="section-title">
            <i class="fas fa-table"></i>
            جدول الأسعار الشامل
        </h2>
        <div id="pricePreview" class="price-preview-container">
            <div class="text-center text-muted py-4">
                <i class="fas fa-info-circle"></i>
                <p>أدخل سعر الدورة لمعاينة جدول الأسعار</p>
            </div>
        </div>
    </div>

    <div class="step-navigation">
        <button class="btn btn-secondary" onclick="showStep(1)">
            <i class="fas fa-arrow-right"></i> السابق
        </button>
        <button class="btn btn-primary" onclick="showStep(3)">
            التالي <i class="fas fa-arrow-left"></i>
        </button>
    </div>
</div>
                    <!-- Step 3: Curriculum Builder -->
                    <div class="step-content" id="step3">
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-book"></i>
                                بناء منهج الدورة
                            </h2>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                قم بتنظيم محتوى الدورة في وحدات ودروس. يمكنك سحب وإعادة ترتيب العناصر.
                            </div>

                            <div class="module-stats">
                                <div class="stat-item">
                                    <div class="stat-value" id="totalModules">0</div>
                                    <div class="stat-label">وحدة</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="totalLessons">0</div>
                                    <div class="stat-label">درس</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="totalDuration">0</div>
                                    <div class="stat-label">دقيقة</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div id="modulesContainer" class="modules-container"></div>
                            
                            <button class="btn btn-primary" onclick="addModule()">
                                <i class="fas fa-plus"></i> إضافة وحدة جديدة
                            </button>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-cog"></i>
                                إعدادات المنهج
                            </h2>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">هيكل الدورة</label>
                                    <select class="form-select" id="courseStructure">
                                        <option value="linear">خطي (يجب إكمال الدروس بالترتيب)</option>
                                        <option value="flexible">مرن (يمكن الوصول لأي درس)</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">نوع التعلم</label>
                                    <select class="form-select" id="learningType">
                                        <option value="self-paced">ذاتي السرعة</option>
                                        <option value="scheduled">مجدول</option>
                                        <option value="cohort">مجموعات</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="dripContent">
                                        <label class="form-check-label" for="dripContent">
                                            المحتوى التدريجي
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enableQuizzes" checked>
                                        <label class="form-check-label" for="enableQuizzes">
                                            تفعيل الاختبارات
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enableAssignments">
                                        <label class="form-check-label" for="enableAssignments">
                                            تفعيل الواجبات
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="row" id="dripSettings" style="display: none;">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">نوع التدريج</label>
                                    <select class="form-select" id="dripType">
                                        <option value="daily">يومي</option>
                                        <option value="weekly">أسبوعي</option>
                                        <option value="custom">مخصص</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">الحد الأدنى للإكمال (%)</label>
                                    <input type="number" class="form-control" id="minCompletion" 
                                           value="80" min="0" max="100">
                                </div>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <button class="btn btn-secondary" onclick="showStep(2)">
                                <i class="fas fa-arrow-right"></i> السابق
                            </button>
                            <button class="btn btn-primary" onclick="showStep(4)">
                                التالي <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 4: Advanced Settings -->
                    <div class="step-content" id="step4">
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-users"></i>
                                إعدادات التسجيل والوصول
                            </h2>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">نوع التسجيل</label>
                                    <select class="form-select" id="enrollmentType">
                                        <option value="open">مفتوح للجميع</option>
                                        <option value="approval">يتطلب موافقة</option>
                                        <option value="application">يتطلب تقديم طلب</option>
                                        <option value="closed">مغلق</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">الحد الأقصى للطلاب</label>
                                    <input type="number" class="form-control" id="maxStudents" 
                                           placeholder="غير محدود" min="1">
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">مدة الوصول</label>
                                    <select class="form-select" id="accessDuration">
                                        <option value="lifetime">مدى الحياة</option>
                                        <option value="1year">سنة واحدة</option>
                                        <option value="6months">6 أشهر</option>
                                        <option value="3months">3 أشهر</option>
                                        <option value="custom">مخصص</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">تاريخ بدء التسجيل</label>
                                    <input type="datetime-local" class="form-control" id="enrollmentStartDate">
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">تاريخ انتهاء التسجيل</label>
                                    <input type="datetime-local" class="form-control" id="enrollmentEndDate">
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableWaitlist">
                                    <label class="form-check-label" for="enableWaitlist">
                                        تفعيل قائمة الانتظار عند امتلاء الدورة
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-comments"></i>
                                التواصل والدعم
                            </h2>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">رقم واتساب للتواصل</label>
                                    <input type="tel" class="form-control" id="whatsappNumber" 
                                           placeholder="201XXXXXXXXX" dir="ltr">
                                    <div class="form-text">سيتم استخدامه للتواصل مع الطلاب</div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">رابط مجموعة واتساب</label>
                                    <input type="url" class="form-control" id="whatsappGroupLink" 
                                           placeholder="https://chat.whatsapp.com/..." dir="ltr">
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="autoWelcomeMessage" checked>
                                    <label class="form-check-label" for="autoWelcomeMessage">
                                        إرسال رسالة ترحيب تلقائية عبر واتساب
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3" id="welcomeMessageField">
                                <label class="form-label">رسالة الترحيب</label>
                                <textarea class="form-control" id="welcomeMessage" rows="4" 
                                          placeholder="مرحباً {الاسم}، نرحب بك في دورة {اسم الدورة}..."></textarea>
                                <div class="form-text">استخدم {الاسم} و {اسم الدورة} كمتغيرات</div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enableComments" checked>
                                        <label class="form-check-label" for="enableComments">
                                            تفعيل التعليقات
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enableForum">
                                        <label class="form-check-label" for="enableForum">
                                            تفعيل المنتدى
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enableLiveSupport">
                                        <label class="form-check-label" for="enableLiveSupport">
                                            دعم مباشر
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="row" id="supportSettings" style="display: none;">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">ساعات الدعم</label>
                                    <select class="form-select" id="supportHours">
                                        <option value="business">ساعات العمل (9 ص - 5 م)</option>
                                        <option value="extended">ممتدة (9 ص - 9 م)</option>
                                        <option value="24/7">24/7</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-certificate"></i>
                                الشهادات والإنجازات
                            </h2>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="certificate" checked>
                                    <label class="form-check-label" for="certificate">
                                        منح شهادة إتمام
                                    </label>
                                </div>
                            </div>

                            <div id="certificateSettings">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">نسبة الإنجاز المطلوبة (%)</label>
                                        <input type="number" class="form-control" id="certificateThreshold" 
                                               value="80" min="0" max="100">
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">نص الشهادة المخصص</label>
                                        <input type="text" class="form-control" id="certificateText" 
                                               placeholder="يشهد بأن {الاسم} قد أتم بنجاح...">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="requireQuizzes">
                                            <label class="form-check-label" for="requireQuizzes">
                                                اجتياز الاختبارات
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="requireAssignments">
                                            <label class="form-check-label" for="requireAssignments">
                                                تسليم الواجبات
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="requireParticipation">
                                            <label class="form-check-label" for="requireParticipation">
                                                المشاركة النشطة
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="requireFinalProject">
                                            <label class="form-check-label" for="requireFinalProject">
                                                مشروع نهائي
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showCompletionBadges" checked>
                                        <label class="form-check-label" for="showCompletionBadges">
                                            عرض شارات الإنجاز
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="sendProgressEmails">
                                        <label class="form-check-label" for="sendProgressEmails">
                                            إرسال رسائل التقدم بالبريد
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-chart-line"></i>
                                تتبع التقدم والإحصائيات
                            </h2>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">طريقة حساب التقدم</label>
                                    <select class="form-select" id="progressMethod">
                                        <option value="lessons">بناءً على الدروس المكتملة</option>
                                        <option value="time">بناءً على وقت المشاهدة</option>
                                        <option value="mixed">مختلط</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">المدة المتوقعة للإكمال</label>
                                    <select class="form-select" id="expectedCompletion">
                                        <option value="1week">أسبوع واحد</option>
                                        <option value="2weeks">أسبوعان</option>
                                        <option value="1month">شهر واحد</option>
                                        <option value="2months">شهران</option>
                                        <option value="3months">3 أشهر</option>
                                        <option value="custom">مخصص</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showProgressBar" checked>
                                        <label class="form-check-label" for="showProgressBar">
                                            عرض شريط التقدم
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-3 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showModuleProgress" checked>
                                        <label class="form-check-label" for="showModuleProgress">
                                            تقدم الوحدات
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-3 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showLearningStats">
                                        <label class="form-check-label" for="showLearningStats">
                                            إحصائيات التعلم
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-3 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showAchievementBadges">
                                        <label class="form-check-label" for="showAchievementBadges">
                                            شارات الإنجاز
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-search"></i>
                                SEO والتسويق
                            </h2>
                            
                            <div class="mb-3">
                                <label class="form-label">عنوان SEO</label>
                                <input type="text" class="form-control" id="seoTitle" 
                                       placeholder="يُنشأ تلقائياً من عنوان الدورة" maxlength="60">
                                <div class="form-text">الحد الأقصى 60 حرف</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">وصف SEO</label>
                                <textarea class="form-control" id="seoDescription" rows="3" 
                                          placeholder="وصف مختصر يظهر في نتائج البحث" maxlength="160"></textarea>
                                <div class="form-text">الحد الأقصى 160 حرف</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">وصف وسائل التواصل الاجتماعي</label>
                                <textarea class="form-control" id="socialDescription" rows="2" 
                                          placeholder="النص الذي يظهر عند مشاركة الدورة"></textarea>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="allowSharing" checked>
                                    <label class="form-check-label" for="allowSharing">
                                        السماح بمشاركة الدورة على وسائل التواصل
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-eye"></i>
                                إعدادات النشر والخصوصية
                            </h2>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">حالة الدورة</label>
                                    <select class="form-select" id="status">
                                        <option value="draft">مسودة</option>
                                        <option value="review">قيد المراجعة</option>
                                        <option value="published">منشورة</option>
                                        <option value="archived">مؤرشفة</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">مستوى الخصوصية</label>
                                    <select class="form-select" id="isPublic">
                                        <option value="true">عامة (متاحة للجميع)</option>
                                        <option value="false">خاصة (تحتاج رابط)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="privateLink">
                                        <label class="form-check-label" for="privateLink">
                                            إنشاء رابط خاص للدورة
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">النشر المجدول</label>
                                    <input type="datetime-local" class="form-control" id="scheduledPublish">
                                </div>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <button class="btn btn-secondary" onclick="showStep(3)">
                                <i class="fas fa-arrow-right"></i> السابق
                            </button>
                            <button class="btn btn-primary" onclick="showStep(5)">
                                التالي <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 5: Review and Publish -->
                    <div class="step-content" id="step5">
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-eye"></i>
                                مراجعة نهائية
                            </h2>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                راجع جميع المعلومات قبل نشر الدورة. يمكنك دائماً تعديلها لاحقاً.
                            </div>

                            <div class="review-section">
                                <h3>المعلومات الأساسية</h3>
                                <div class="review-content" id="reviewBasicInfo"></div>
                            </div>

                            <div class="review-section">
                                <h3>التسعير والدفع</h3>
                                <div class="review-content" id="reviewPricing"></div>
                            </div>

                            <div class="review-section">
                                <h3>المنهج</h3>
                                <div class="review-content" id="reviewCurriculum"></div>
                            </div>

                            <div class="review-section">
                                <h3>الإعدادات المتقدمة</h3>
                                <div class="review-content" id="reviewSettings"></div>
                            </div>
                        </div>

                        <div class="form-section text-center">
                            <h3>الدورة جاهزة للنشر!</h3>
                            <p>يمكنك نشر الدورة الآن أو حفظها كمسودة لتعديلها لاحقاً.</p>
                            
                            <div class="d-flex justify-content-center gap-3">
                                <button class="btn btn-secondary" onclick="saveDraft()">
                                    <i class="fas fa-save"></i> حفظ كمسودة
                                </button>
                                <button class="btn btn-success" onclick="publishCourse()">
                                    <i class="fas fa-rocket"></i> نشر الدورة
                                </button>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <button class="btn btn-secondary" onclick="showStep(4)">
                                <i class="fas fa-arrow-right"></i> السابق
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="../js/firebase-config.js"></script>
    
    <!-- External Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <script>
        // ========================================
        // GLOBAL VARIABLES
        // ========================================
let courseData = {
    id: null,
    title: 'دورة جديدة',
    slug: '',
    subtitle: '',
    description: '',
    detailedDescription: '',
    language: 'ar',
    targetAudience: 'all',
    applicationDomain: '',
    practiceDepth: '',
    courseLevel: 'foundational',
    introVideo: '',
    objectives: [],
    requirements: [],
    thumbnail: null,
    thumbnailUrl: null,
    socialImage: null,
    socialImageUrl: null,
    instructorName: '',
    instructorTitle: '',
    instructorBio: '',
    instructorImage: null,
    instructorImageUrl: '',
    instructorLinkedIn: '',
    instructorTwitter: '',
    instructorWebsite: '',
    category: '',
    level: 'beginner',
    keywords: [],
    priceType: 'free',
    price: 0,
    salePrice: null,
    currency: 'EGP',
    donationMin: null,
    donationMax: null,
    discounts: [],
    groupDiscounts: [],
    coupons: [],
    paymentPlans: [],
    grants: {
        enabled: false,
        seats: 5,
        totalSeats: 30,
        supportTypes: {
            discount: false,
            installments: false,
            deferred: false,
            service: false
        },
        criteria: {
            financial: false,
            motivation: false,
            impact: false,
            history: false
        },
        formUrl: null
    },
    paymentMethods: {
        instapay: { enabled: true, number: '' },
        vodafone: { enabled: true, number: '' },
        bank: { enabled: false, name: '', accountNumber: '', accountName: '' }
    },
    enrollmentType: 'open',
    maxStudents: null,
    accessDuration: 'lifetime',
    enrollmentStartDate: null,
    enrollmentEndDate: null,
    enableWaitlist: false,
    whatsappNumber: '',
    whatsappGroupLink: '',
    autoWelcomeMessage: true,
    welcomeMessage: '',
    modules: [],
    courseStructure: 'linear',
    learningType: 'self-paced',
    dripContent: false,
    dripType: 'weekly',
    enableQuizzes: true,
    enableAssignments: false,
    minCompletion: 80,
    enableComments: true,
    enableForum: false,
    enableLiveSupport: false,
    supportHours: 'business',
    certificate: true,
    certificateThreshold: 80,
    certificateText: '',
    certificateRequirements: {
        requireQuizzes: false,
        requireAssignments: false,
        requireParticipation: false,
        requireFinalProject: false
    },
    showCompletionBadges: true,
    sendProgressEmails: false,
    progressMethod: 'lessons',
    expectedCompletion: '1month',
    showProgressBar: true,
    showModuleProgress: true,
    showLearningStats: false,
    showAchievementBadges: false,
    seoTitle: '',
    seoDescription: '',
    socialDescription: '',
    allowSharing: true,
    status: 'draft',
    isPublic: true,
    privateLink: false,
    scheduledPublish: null,
    publishedAt: null,
    progress: 20,
    totalLessons: 0,
    totalDuration: 0,
    createdAt: null,
    updatedAt: null
};

        let currentStep = 1;
        let autoSaveTimeout = null;
        let isLoading = false;

        // ========================================
        // INITIALIZATION
        // ========================================
// الكود الموجود الأصلي - سيبه زي ما هو
document.addEventListener('DOMContentLoaded', function() {
    // Check authentication
    if (window.firebaseAuth && window.firebaseAuth.protectAdminPage) {
        window.firebaseAuth.protectAdminPage();
    }
    // Initialize components
    initializeEventListeners();
    initializeKeywordInput();
    loadCourseData();
    
    // Update currency label
    document.getElementById('currency').addEventListener('change', updateCurrencyLabel);
    updateCurrencyLabel();
});


        // ========================================
        // STEP NAVIGATION
        // ========================================
        function showStep(step) {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected step
            document.getElementById(`step${step}`).classList.add('active');
            
            // Update step indicators
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                indicator.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    indicator.classList.add('completed');
                } else if (index + 1 === step) {
                    indicator.classList.add('active');
                }
            });
            
            // Update progress bar
            const progress = (step / 5) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
            currentStep = step;
            
            // Save progress
            courseData.progress = progress;
           // حفظ تلقائي ذكي - فقط لو في ID موجود (مش دورة جديدة)
if (courseData.id) {
    autoSave();
}
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ========================================
        // COURSE TITLE & SLUG
        // ========================================
function updateCourseTitle(title) {
    courseData.title = title;
    document.getElementById('courseTitleHeader').textContent = title || 'دورة جديدة';
    
    // مجرد عرض اقتراح في placeholder بس
    if (title && title !== 'دورة جديدة') {
        const suggestedSlug = generateSlug(title);
        const slugInput = document.getElementById('courseSlug');
        
        // عرض الاقتراح في placeholder فقط
        slugInput.placeholder = suggestedSlug;
        document.getElementById('slugPreview').textContent = suggestedSlug;
        
        // لا تغير القيمة أبداً
        // slugInput.value يبقى زي ما هو
    }
}
// دالة محسنة لتوليد الـ Slug
function generateSlug(text) {
    // قاموس تحويل الكلمات العربية الشائعة
    const arabicToEnglish = {
        'دورة': 'course',
        'تعلم': 'learn',
        'احتراف': 'professional',
        'أساسيات': 'basics',
        'متقدم': 'advanced',
        'مقدمة': 'introduction',
        'شرح': 'explanation',
        'كورس': 'course',
        'للمبتدئين': 'for-beginners',
        'من الصفر': 'from-zero',
        'كامل': 'complete',
        'في': 'in',
        'مع': 'with',
        'و': 'and',
        'او': 'or',
        'إلى': 'to',
        'على': 'on'
    };
    
    let slug = text.toLowerCase().trim();
    
    // استبدل الكلمات العربية الشائعة
    Object.keys(arabicToEnglish).forEach(arabic => {
        const regex = new RegExp(arabic, 'g');
        slug = slug.replace(regex, arabicToEnglish[arabic]);
    });
    
    // حول الحروف العربية المتبقية
    const arabicLetters = {
        'ا': 'a', 'أ': 'a', 'إ': 'i', 'آ': 'aa',
        'ب': 'b', 'ت': 't', 'ث': 'th', 'ج': 'g',
        'ح': 'h', 'خ': 'kh', 'د': 'd', 'ذ': 'dh',
        'ر': 'r', 'ز': 'z', 'س': 's', 'ش': 'sh',
        'ص': 's', 'ض': 'd', 'ط': 't', 'ظ': 'z',
        'ع': 'a', 'غ': 'gh', 'ف': 'f', 'ق': 'q',
        'ك': 'k', 'ل': 'l', 'م': 'm', 'ن': 'n',
        'ه': 'h', 'و': 'w', 'ي': 'y', 'ة': 'h',
        'ى': 'a', 'ئ': 'e', 'ء': 'a', 'ؤ': 'o'
    };
    
    Object.keys(arabicLetters).forEach(arabic => {
        const regex = new RegExp(arabic, 'g');
        slug = slug.replace(regex, arabicLetters[arabic]);
    });
    
    // تنظيف نهائي
    return slug
        .replace(/[^\w\s-]/g, '') // احذف الرموز الخاصة
        .replace(/[\s_-]+/g, '-') // استبدل المسافات بـ -
        .replace(/^-+|-+$/g, ''); // احذف - من البداية والنهاية
}

        // ========================================
        // OBJECTIVES & REQUIREMENTS
        // ========================================
        function addObjective() {
            const input = document.getElementById('objectiveInput');
            const value = input.value.trim();
            
            if (value) {
                courseData.objectives.push(value);
                renderObjectives();
                input.value = '';
                autoSave();
            }
        }

        function removeObjective(index) {
            courseData.objectives.splice(index, 1);
            renderObjectives();
            autoSave();
        }

        function renderObjectives() {
            const container = document.getElementById('objectivesList');
            container.innerHTML = courseData.objectives.map((obj, index) => `
                <div class="list-group-item">
                    <span>${obj}</span>
                    <button class="btn btn-sm btn-danger" onclick="removeObjective(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function addRequirement() {
            const input = document.getElementById('requirementInput');
            const value = input.value.trim();
            
            if (value) {
                courseData.requirements.push(value);
                renderRequirements();
                input.value = '';
                autoSave();
            }
        }

        function removeRequirement(index) {
            courseData.requirements.splice(index, 1);
            renderRequirements();
            autoSave();
        }

        function renderRequirements() {
            const container = document.getElementById('requirementsList');
            container.innerHTML = courseData.requirements.map((req, index) => `
                <div class="list-group-item">
                    <span>${req}</span>
                    <button class="btn btn-sm btn-danger" onclick="removeRequirement(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        // دالة حفظ الـ Slug في Firebase
// دالة حفظ الـ Slug في Firebase
async function saveCourseSlug() {
    const titleInput = document.getElementById('courseTitle');
    const slugInput = document.getElementById('courseSlug');
    const saveBtn = document.getElementById('saveSlugBtn');
    
    // التأكد من وجود عنوان
    if (!titleInput.value.trim() || titleInput.value.trim() === 'دورة جديدة') {
        Swal.fire({
            icon: 'error',
            title: 'خطأ',
            text: 'من فضلك اكتب عنوان صحيح للدورة أولاً'
        });
        return;
    }
    
    // تحديث البيانات
    courseData.title = titleInput.value.trim();
    
    // تحديد الـ slug - المهم هنا
    let finalSlug = '';
    
    // إذا المستخدم كتب slug مخصص
    if (slugInput.value && slugInput.value.trim()) {
        finalSlug = slugInput.value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '');
    } 
    // إذا الحقل فاضي، ولّد من العنوان
    else {
        finalSlug = generateSlug(courseData.title);
    }
    
    // حفظ الـ slug النهائي
    courseData.slug = finalSlug;
    slugInput.value = finalSlug;
    document.getElementById('slugPreview').textContent = finalSlug;
    
    // عرض مؤشر التحميل
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
    
    try {
        // إذا كانت دورة جديدة - أنشئ ID الآن فقط
        if (!courseData.id) {
            // جمع البيانات
            collectFormData();
            
            // تجهيز البيانات للحفظ
            const dataToSave = {
                ...courseData,
                slug: finalSlug, // استخدم الـ slug النهائي
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // حذف القيم الغير معرفة
            Object.keys(dataToSave).forEach(key => {
                if (dataToSave[key] === undefined) {
                    delete dataToSave[key];
                }
            });
            
            // إنشاء دورة جديدة - الـ ID سيكون نفس الـ slug في أول مرة
            const newId = await window.firebaseDB.courses.createCourse(dataToSave);
            courseData.id = newId;
            
            // تحديث URL
            const newUrl = `${window.location.pathname}?id=${newId}`;
            window.history.replaceState({}, '', newUrl);
            
            console.log('تم إنشاء دورة جديدة:', newId);
            console.log('Slug:', finalSlug);
            
            saveBtn.innerHTML = '<i class="fas fa-check"></i> تم إنشاء الدورة';
            
        } else {
            // دورة موجودة - حدث البيانات فقط
            await saveCourseData();
            saveBtn.innerHTML = '<i class="fas fa-check"></i> تم التحديث';
        }
        
        // نجاح
        saveBtn.classList.remove('btn-primary');
        saveBtn.classList.add('btn-success');
        saveBtn.disabled = false;
        
        // رسالة نجاح
        Swal.fire({
            icon: 'success',
            title: courseData.id ? 'تم الحفظ بنجاح' : 'تم إنشاء الدورة',
            html: `
                <div style="text-align: right;">
                    <p><strong>العنوان:</strong> ${courseData.title}</p>
                    <p><strong>ID:</strong> ${courseData.id}</p>
                    <p><strong>الرابط (Slug):</strong> ${courseData.slug}</p>
                    <p style="color: #666; font-size: 0.9em; margin-top: 10px;">
                        يمكنك تغيير الرابط (Slug) في أي وقت
                    </p>
                </div>
            `,
            timer: 5000,
            showConfirmButton: true
        });
        
        // إرجاع الزر لحالته الطبيعية بعد 3 ثواني
        setTimeout(() => {
            saveBtn.classList.remove('btn-success');
            saveBtn.classList.add('btn-primary');
            saveBtn.innerHTML = '<i class="fas fa-link"></i> تثبيت الرابط';
            
            // تغيير نص الزر للدورات الموجودة
            if (courseData.id) {
                saveBtn.innerHTML = '<i class="fas fa-sync"></i> تحديث الرابط';
            }
        }, 3000);
        
    } catch (error) {
        console.error('Error saving:', error);
        saveBtn.classList.remove('btn-success');
        saveBtn.classList.add('btn-danger');
        saveBtn.innerHTML = '<i class="fas fa-times"></i> فشل الحفظ';
        saveBtn.disabled = false;
        
        Swal.fire({
            icon: 'error',
            title: 'خطأ',
            text: 'حدث خطأ أثناء الحفظ: ' + error.message
        });
    }
}
        // ========================================
        // IMAGE HANDLING
        // ========================================
function handleImageUpload(input, type) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        if (type === 'thumbnail') {
            displayCourseImage(e.target.result);
        } else if (type === 'instructor') {
            displayInstructorImage(e.target.result);
        } else if (type === 'social') {
            displaySocialImage(e.target.result);
        }
        
        // إرشادات الرفع على GitHub
        const folderName = type === 'thumbnail' ? 'courses' : 
                          type === 'instructor' ? 'instructors' : 'social';
        
        Swal.fire({
            title: 'حفظ الصورة',
            html: `
                <div style="text-align: right;">
                    <p>لحفظ الصورة، ارفعها على GitHub في:</p>
                    <code style="background: #f0f0f0; padding: 0.5rem; display: block; direction: ltr;">
                        media/${folderName}/${file.name}
                    </code>
                    <p style="color: #666;">ثم اضغط تم بعد رفعها</p>
                </div>
            `,
            confirmButtonText: 'تم الرفع',
            showCancelButton: true
        }).then((result) => {
            if (result.isConfirmed) {
                const baseUrl = 'https://mahmoudfouad25.github.io/fouad-perspective/media/';
                const imageUrl = baseUrl + folderName + '/' + file.name;
                
                if (type === 'thumbnail') {
                    courseData.thumbnailUrl = imageUrl;
                } else if (type === 'instructor') {
                    courseData.instructorImageUrl = imageUrl;
                } else if (type === 'social') {
                    courseData.socialImageUrl = imageUrl;
                }
                
                autoSave();
            }
        });
    };
    reader.readAsDataURL(file);
}

        function displayCourseImage(url) {
    const uploadDiv = document.getElementById('thumbnailPreview');
    const img = document.getElementById('thumbnailImage');
    if (uploadDiv && img) {
        uploadDiv.style.display = 'block';
        img.src = url;
    }
}

function displayInstructorImage(url) {
    const uploadDiv = document.getElementById('instructorImagePreview');
    const img = document.getElementById('instructorImage');
    if (uploadDiv && img) {
        uploadDiv.style.display = 'block';
        img.src = url;
    }
}

function displaySocialImage(url) {
    const uploadDiv = document.getElementById('socialImagePreview');
    const img = document.getElementById('socialImage');
    if (uploadDiv && img) {
        uploadDiv.style.display = 'block';
        img.src = url;
    }
}


        function displayImage(type, src) {
            const preview = document.getElementById(`${type}Preview`);
            const image = document.getElementById(`${type}Image`);
            
            preview.style.display = 'block';
            image.src = src;
        }

        function removeImage(type) {
            const preview = document.getElementById(`${type}Preview`);
            const input = document.getElementById(`${type}Input`);
            
            preview.style.display = 'none';
            input.value = '';
            
            if (type === 'thumbnail') {
                courseData.thumbnail = null;
                courseData.thumbnailUrl = null;
            } else if (type === 'social') {
                courseData.socialImage = null;
                courseData.socialImageUrl = null;
            } else if (type === 'instructor') {
                courseData.instructorImage = null;
            }
            
            autoSave();
        }

        // ========================================
        // KEYWORDS
        // ========================================
        function initializeKeywordInput() {
            const input = document.getElementById('keywordInput');
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addKeyword();
                }
            });
        }

        function addKeyword() {
            const input = document.getElementById('keywordInput');
            const value = input.value.trim();
            
            if (value && !courseData.keywords.includes(value)) {
                courseData.keywords.push(value);
                renderKeywords();
                input.value = '';
                autoSave();
            }
        }

        function removeKeyword(index) {
            courseData.keywords.splice(index, 1);
            renderKeywords();
            autoSave();
        }

        function renderKeywords() {
            const container = document.getElementById('keywordsTags');
            container.innerHTML = courseData.keywords.map((keyword, index) => `
                <span class="tag">
                    ${keyword}
                    <span class="remove-tag" onclick="removeKeyword(${index})">×</span>
                </span>
            `).join('');
        }

        

        // ========================================
        // CURRICULUM BUILDER
        // ========================================
        function addModule() {
            const module = {
                id: 'module_' + Date.now(),
                title: `الوحدة ${courseData.modules.length + 1}`,
                description: '',
                lessons: [],
                isExpanded: true
            };
            
            courseData.modules.push(module);
            renderModules();
            updateCurriculumStats();
            autoSave();
        }

        function renderModules() {
            const container = document.getElementById('modulesContainer');
            container.innerHTML = courseData.modules.map((module, index) => `
                <div class="module-card" data-module-id="${module.id}">
                    <div class="module-header">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-grip-vertical drag-handle"></i>
                            <input type="text" class="form-control ms-2" value="${module.title}"
                                   onchange="updateModuleTitle('${module.id}', this.value)"
                                   style="background: transparent; border: none; font-weight: 600;">
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleModule('${module.id}')">
                                <i class="fas fa-chevron-${module.isExpanded ? 'up' : 'down'}"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteModule(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="module-content" style="display: ${module.isExpanded ? 'block' : 'none'}">
                        <div class="mb-3">
                            <textarea class="form-control" placeholder="وصف الوحدة (اختياري)"
                                      onchange="updateModuleDescription('${module.id}', this.value)">${module.description}</textarea>
                        </div>
                        <div class="lessons-container" id="lessons-${module.id}">
                            ${renderLessons(module.lessons, module.id)}
                        </div>
                        <button class="btn btn-outline-primary btn-sm" onclick="showContentTypes('${module.id}')">
                            <i class="fas fa-plus"></i> إضافة محتوى
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Initialize sortable
            initializeSortable();
        }

        function renderLessons(lessons, moduleId) {
            return lessons.map((lesson, index) => `
                <div class="lesson-item" data-lesson-id="${lesson.id}">
                    <div class="lesson-info">
                        <i class="fas fa-grip-vertical drag-handle"></i>
                        <div class="lesson-type-icon">
                            <i class="fas fa-${getLessonIcon(lesson.type)}"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">${lesson.title}</div>
                            <small class="text-muted">${lesson.duration} دقيقة</small>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="editLesson('${moduleId}', '${lesson.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteLesson('${moduleId}', '${lesson.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-sm ${lesson.isFreePreview ? 'btn-success' : 'btn-outline-success'}" 
        onclick="toggleFreePreview('${moduleId}', '${lesson.id}')"
        title="${lesson.isFreePreview ? 'إلغاء المعاينة المجانية' : 'إتاحة كمعاينة مجانية'}">
    <i class="fas ${lesson.isFreePreview ? 'fa-eye' : 'fa-eye-slash'}"></i>
</button>
                    </div>
                </div>
            `).join('');
        }
        function toggleFreePreview(moduleId, lessonId) {
    const module = courseData.modules.find(m => m.id === moduleId);
    const lesson = module.lessons.find(l => l.id === lessonId);
    
    lesson.isFreePreview = !lesson.isFreePreview;
    
    renderModules();
    autoSave();
    
    Swal.fire({
        icon: 'success',
        title: lesson.isFreePreview ? 'تم التفعيل' : 'تم الإلغاء',
        text: lesson.isFreePreview ? 
            'تم إتاحة هذا الدرس كمعاينة مجانية' : 
            'تم إلغاء المعاينة المجانية لهذا الدرس',
        timer: 2000,
        showConfirmButton: false
    });
}

        function getLessonIcon(type) {
            const icons = {
                video: 'play-circle',
                text: 'file-alt',
                quiz: 'question-circle',
                assignment: 'tasks',
                live: 'broadcast-tower',
                download: 'download'
            };
            return icons[type] || 'file';
        }

function showContentTypes(moduleId) {
    Swal.fire({
        title: 'اختر نوع المحتوى',
        html: `
            <div class="content-types-grid">
                <button class="content-type-btn" onclick="openContentLibrary('${moduleId}')">
                    <i class="fas fa-book"></i>
                    <span>📚 محتوى من المكتبة</span>
                </button>
                <button class="content-type-btn" onclick="addLesson('${moduleId}', 'text')">
                    <i class="fas fa-file-alt"></i>
                    <span>📝 نص مباشر</span>
                </button>
                <button class="content-type-btn" onclick="addLesson('${moduleId}', 'file')">
                    <i class="fas fa-download"></i>
                    <span>📎 ملف للتحميل</span>
                </button>
            </div>
        `,
        showConfirmButton: false,
        customClass: {
            popup: 'content-types-popup'
        }
    });
}

        function addLesson(moduleId, type) {
            Swal.close();
            
            const module = courseData.modules.find(m => m.id === moduleId);
            if (!module) return;
            
            Swal.fire({
                title: 'إضافة درس جديد',
                html: `
                    <div class="form-group mb-3">
                        <label class="form-label">عنوان الدرس</label>
                        <input type="text" id="lessonTitle" class="form-control" placeholder="أدخل عنوان الدرس">
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">المدة (بالدقائق)</label>
                        <input type="number" id="lessonDuration" class="form-control" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">الوصف (اختياري)</label>
                        <textarea id="lessonDescription" class="form-control" rows="3" placeholder="وصف مختصر للدرس"></textarea>
                    </div>
                `,
                confirmButtonText: 'إضافة',
                showCancelButton: true,
                cancelButtonText: 'إلغاء',
                preConfirm: () => {
                    const title = document.getElementById('lessonTitle').value;
                    const duration = parseInt(document.getElementById('lessonDuration').value) || 0;
                    const description = document.getElementById('lessonDescription').value;
                    
                    if (!title) {
                        Swal.showValidationMessage('يرجى إدخال عنوان الدرس');
                        return false;
                    }
                    
                    return { title, duration, description };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const lesson = {
                        id: 'lesson_' + Date.now(),
                        type: type,
                        title: result.value.title,
                        duration: result.value.duration,
                        description: result.value.description,
                        content: '',
                        isCompleted: false
                    };
                    
                    module.lessons.push(lesson);
                    renderModules();
                    updateCurriculumStats();
                    autoSave();
                }
            });
        }

       async function editLesson(moduleId, lessonId) {
    const module = courseData.modules.find(m => m.id === moduleId);
    const lesson = module.lessons.find(l => l.id === lessonId);
    
    if (!lesson) return;
    
    // لو ده محتوى من المكتبة، نجيب تفاصيله
    let libraryContent = null;
    if (lesson.type === 'library-content' && lesson.libraryContentId) {
        try {
            const contentDoc = await db.collection('courseContentLibrary').doc(lesson.libraryContentId).get();
            if (contentDoc.exists) {
                libraryContent = contentDoc.data();
            }
        } catch (error) {
            console.error('خطأ في جلب محتوى المكتبة:', error);
        }
    }
    
    // بناء HTML للتعديل حسب نوع المحتوى
    let editFormHtml = `
        <div class="form-group mb-3">
            <label class="form-label">عنوان الدرس</label>
            <input type="text" id="lessonTitle" class="form-control" value="${lesson.title}">
        </div>
        <div class="form-group mb-3">
            <label class="form-label">المدة (بالدقائق)</label>
            <input type="number" id="lessonDuration" class="form-control" value="${lesson.duration}" min="0">
        </div>
        <div class="form-group">
            <label class="form-label">الوصف</label>
            <textarea id="lessonDescription" class="form-control" rows="3">${lesson.description || ''}</textarea>
        </div>
    `;
    
    // إضافة تفاصيل المحتوى من المكتبة
    if (libraryContent) {
        editFormHtml += `
            <hr class="my-4">
            <h5 class="text-primary mb-3">📚 محتوى من المكتبة</h5>
            <div class="alert alert-info">
                <strong>النوع:</strong> ${lesson.libraryContentType}<br>
                <strong>المحتوى الأصلي:</strong> ${libraryContent.name || 'غير محدد'}
            </div>
        `;
        
        // أضف هنا - عرض كل التفاصيل للتعديل
        editFormHtml += `
            <div class="form-group mb-3">
                <label class="form-label">تعديل المحتوى الأصلي</label>
            </div>
        `;
        
        // عرض حقول التعديل حسب النوع
        if (lesson.libraryContentType === 'educational-video' && libraryContent.videoData) {
            editFormHtml += `
                <div class="form-group mb-3">
                    <label class="form-label">رابط الفيديو</label>
                    <input type="url" id="editVideoUrl" class="form-control" value="${libraryContent.videoData.url || ''}" dir="ltr">
                </div>
                <div class="form-group mb-3">
                    <label class="form-label">ملاحظات</label>
                    <textarea id="editVideoNotes" class="form-control" rows="3">${libraryContent.videoData.notes || ''}</textarea>
                </div>
            `;
        } else if (lesson.libraryContentType === 'quiz' && libraryContent.quizData) {
            editFormHtml += `
                <div class="card bg-light p-3 mb-3">
                    <h6>❓ تفاصيل الاختبار:</h6>
                    <p><strong>عدد الأسئلة:</strong> ${libraryContent.quizData.questions?.length || 0}</p>
                    <p><strong>درجة النجاح:</strong> ${libraryContent.quizData.passingGrade || 70}%</p>
                </div>
            `;
        }
        
        editFormHtml += `
            <div class="alert alert-warning">
                <i class="fas fa-info-circle"></i> لتعديل المحتوى الأساسي، اذهب إلى 
                <a href="course-content-library.html" target="_blank">مكتبة المحتوى</a>
            </div>
        `;
    }
    
    // عرض النافذة
    Swal.fire({
        title: 'تعديل الدرس',
        html: editFormHtml,
        confirmButtonText: 'حفظ التغييرات',
        showCancelButton: true,
        cancelButtonText: 'إلغاء',
        width: '600px',
        preConfirm: async () => {
            const title = document.getElementById('lessonTitle').value;
            const duration = parseInt(document.getElementById('lessonDuration').value) || 0;
            const description = document.getElementById('lessonDescription').value;
            
            if (!title) {
                Swal.showValidationMessage('يرجى إدخال عنوان الدرس');
                return false;
            }
            
            // حفظ التعديلات على المحتوى الأصلي
            if (lesson.libraryContentId && document.getElementById('editVideoUrl')) {
                const updates = {
                    'videoData.url': document.getElementById('editVideoUrl').value,
                    'videoData.notes': document.getElementById('editVideoNotes').value
                };
                
                await db.collection('courseContentLibrary').doc(lesson.libraryContentId).update(updates);
            }
            
            return { title, duration, description };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            lesson.title = result.value.title;
            lesson.duration = result.value.duration;
            lesson.description = result.value.description;
            
            renderModules();
            updateCurriculumStats();
            autoSave();
            
            Swal.fire({
                icon: 'success',
                title: 'تم التحديث',
                text: 'تم حفظ التغييرات بنجاح',
                timer: 2000,
                showConfirmButton: false
            });
        }
    });
}

        async function deleteLesson(moduleId, lessonId) {
    const module = courseData.modules.find(m => m.id === moduleId);
    const lesson = module.lessons.find(l => l.id === lessonId);
    
    Swal.fire({
        title: 'حذف الدرس؟',
        text: 'لا يمكن التراجع عن هذا الإجراء',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'نعم، احذف',
        cancelButtonText: 'إلغاء',
        confirmButtonColor: '#dc3545'
    }).then(async (result) => {
        if (result.isConfirmed) {
            // لو كان محتوى من المكتبة، نقلل عدد الاستخدامات
            if (lesson.type === 'library-content' && lesson.libraryContentId) {
                try {
                    await db.collection('courseContentLibrary').doc(lesson.libraryContentId).update({
                        timesUsed: firebase.firestore.FieldValue.increment(-1)
                    });
                    console.log('تم تحديث عدد استخدامات المحتوى');
                } catch (error) {
                    console.error('خطأ في تحديث الاستخدامات:', error);
                }
            }
            
            // حذف الدرس
            module.lessons = module.lessons.filter(l => l.id !== lessonId);
            
            renderModules();
            updateCurriculumStats();
            autoSave();
            
            Swal.fire({
                icon: 'success',
                title: 'تم الحذف',
                text: 'تم حذف الدرس بنجاح',
                timer: 2000,
                showConfirmButton: false
            });
        }
    });
}
// ===============================
// CONTENT LIBRARY INTEGRATION
// ===============================

// Open Content Library Modal
function openContentLibrary(moduleId) {
    Swal.close(); // Close the content types modal
    
    Swal.fire({
        title: '📚 اختر محتوى من المكتبة',
        html: `
            <div id="libraryLoadingState" style="text-align: center; padding: 2rem;">
                <div class="spinner" style="border: 3px solid #f3f3f3; border-top: 3px solid #6366f1; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                <p style="margin-top: 1rem;">جاري تحميل المحتوى...</p>
            </div>
            <div id="libraryContentGrid" style="display: none;">
                <!-- سيتم ملؤها بواسطة JavaScript -->
            </div>
            <div id="libraryEmptyState" style="display: none; text-align: center; padding: 2rem; color: #666;">
                <i class="fas fa-book" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                <h4>لا يوجد محتوى في المكتبة</h4>
                <p>قم بإنشاء محتوى في مكتبة المحتوى التعليمي أولاً</p>
                <button class="btn btn-primary" onclick="openContentCreatorPage()" style="margin-top: 1rem;">
                    <i class="fas fa-plus"></i> إنشاء محتوى جديد
                </button>
            </div>
        `,
        width: '90%',
        maxWidth: '1000px',
        showConfirmButton: false,
        showCancelButton: true,
        cancelButtonText: 'إغلاق'
    });
    
    // Load content from library
    loadLibraryContent(moduleId);
}

// Load Content from Firebase
async function loadLibraryContent(moduleId) {
    try {
        const snapshot = await db.collection('courseContentLibrary')
            .orderBy('createdDate', 'desc')
            .get();
        
        const content = [];
        
        snapshot.forEach(doc => {
            content.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        displayLibraryContent(content, moduleId);
        
    } catch (error) {
        console.error('Error loading library content:', error);
        document.getElementById('libraryLoadingState').innerHTML = `
            <div style="color: #dc3545; text-align: center;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                <h4>خطأ في تحميل المحتوى</h4>
                <p>تأكد من الاتصال بالإنترنت وحاول مرة أخرى</p>
            </div>
        `;
    }
}

// Display Library Content
function displayLibraryContent(content, moduleId) {
    const loadingState = document.getElementById('libraryLoadingState');
    const contentGrid = document.getElementById('libraryContentGrid');
    const emptyState = document.getElementById('libraryEmptyState');
    
    loadingState.style.display = 'none';
    
    if (content.length === 0) {
        emptyState.style.display = 'block';
        return;
    }
    
    contentGrid.style.display = 'block';
    
    // Content type icons
    const typeIcons = {
        'educational-video': '🎥',
        'quiz': '❓',
        'assignment': '📝',
        'discussion': '💬',
        'presentation': '📊',
        'exercise': '💪',
        'case-study': '📋',
        'survey': '📊',
        'simulation': '🔬',
        'educational-game': '🎮',
        'workshop': '🛠️',
        'qa-session': '🙋',
        'self-assessment': '🪞',
        'peer-review': '👥',
        'infographic': '📈',
        'custom': '🎨'
    };
    
    let html = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; max-height: 60vh; overflow-y: auto; padding: 1rem;">
    `;
    
    content.forEach(item => {
        const icon = typeIcons[item.type] || '📦';
        const duration = item.duration || 15;
        
        html += `
            <div class="library-content-card" onclick="selectLibraryContent('${item.id}', '${moduleId}')" 
                 style="background: white; border: 2px solid #e5e7eb; border-radius: 10px; padding: 1.5rem; cursor: pointer; transition: all 0.3s; hover: border-color: #6366f1;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <div style="font-size: 2rem;">${icon}</div>
                    <span style="background: #f3f4f6; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; color: #6b7280;">
                        ${duration} دقيقة
                    </span>
                </div>
                
                <h4 style="color: #1f2937; margin-bottom: 0.5rem; font-size: 1.1rem;">
                    ${item.name}
                </h4>
                
                <p style="color: #6b7280; font-size: 0.9rem; line-height: 1.4; margin-bottom: 1rem;">
                    ${item.description || 'لا يوجد وصف'}
                </p>
                
                <div style="display: flex; justify-content: between; align-items: center; font-size: 0.8rem; color: #9ca3af;">
                    <span>استُخدم ${item.timesUsed || 0} مرة</span>
                    <span style="margin-right: auto;">⭐ ${item.averageRating || 0}</span>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    contentGrid.innerHTML = html;
    
    // Add hover effects
    const cards = document.querySelectorAll('.library-content-card');
    cards.forEach(card => {
        card.addEventListener('mouseenter', () => {
            card.style.borderColor = '#6366f1';
            card.style.transform = 'translateY(-2px)';
            card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        });
        card.addEventListener('mouseleave', () => {
            card.style.borderColor = '#e5e7eb';
            card.style.transform = 'translateY(0)';
            card.style.boxShadow = 'none';
        });
    });
}

// Select Content from Library
function selectLibraryContent(contentId, moduleId) {
    Swal.fire({
        title: 'إضافة المحتوى',
        text: 'هل تريد إضافة هذا المحتوى إلى الوحدة؟',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'نعم، أضف',
        cancelButtonText: 'إلغاء',
        confirmButtonColor: '#10b981'
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                // Get the content details
                const contentDoc = await db.collection('courseContentLibrary').doc(contentId).get();
                const contentData = contentDoc.data();
                
                // Create lesson with library content
                const lesson = {
                    id: 'lesson_' + Date.now(),
                    type: 'library-content',
                    title: contentData.name,
                    duration: contentData.duration || 15,
                    description: contentData.description || '',
                    libraryContentId: contentId,
                    libraryContentType: contentData.type,
                    isCompleted: false
                };
                
                // Find the module and add the lesson
                const module = courseData.modules.find(m => m.id === moduleId);
                if (module) {
                    module.lessons.push(lesson);
                    
                    // Update UI
                    renderModules();
                    updateCurriculumStats();
                    autoSave();
                    
                    // Update usage count in library
                    await db.collection('courseContentLibrary').doc(contentId).update({
                        timesUsed: firebase.firestore.FieldValue.increment(1),
                        lastUsed: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'تم الإضافة',
                        text: 'تم إضافة المحتوى إلى الوحدة بنجاح',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
                
            } catch (error) {
                console.error('Error adding library content:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء إضافة المحتوى'
                });
            }
        }
    });
}

// Open Content Creator Page
function openContentCreatorPage() {
    window.open('course-content-library.html', '_blank');
}

// Update lesson rendering to handle library content
function getLessonIcon(type) {
    const icons = {
        'library-content': 'book',
        'text': 'file-alt',
        'file': 'download',
        // Add other types as needed
    };
    return icons[type] || 'file';
}
        function updateModuleTitle(moduleId, title) {
            const module = courseData.modules.find(m => m.id === moduleId);
            if (module) {
                module.title = title;
                autoSave();
            }
        }

        function updateModuleDescription(moduleId, description) {
            const module = courseData.modules.find(m => m.id === moduleId);
            if (module) {
                module.description = description;
                autoSave();
            }
        }

        function toggleModule(moduleId) {
            const module = courseData.modules.find(m => m.id === moduleId);
            if (module) {
                module.isExpanded = !module.isExpanded;
                renderModules();
            }
        }

        function deleteModule(index) {
            Swal.fire({
                title: 'حذف الوحدة؟',
                text: 'سيتم حذف الوحدة وجميع الدروس التابعة لها',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545'
            }).then((result) => {
                if (result.isConfirmed) {
                    courseData.modules.splice(index, 1);
                    renderModules();
                    updateCurriculumStats();
                    autoSave();
                }
            });
        }

        function updateCurriculumStats() {
            const totalModules = courseData.modules.length;
            let totalLessons = 0;
            let totalDuration = 0;
            
            courseData.modules.forEach(module => {
                totalLessons += module.lessons.length;
                module.lessons.forEach(lesson => {
                    totalDuration += lesson.duration || 0;
                });
            });
            
            document.getElementById('totalModules').textContent = totalModules;
            document.getElementById('totalLessons').textContent = totalLessons;
            document.getElementById('totalDuration').textContent = totalDuration;
            
            courseData.totalLessons = totalLessons;
            courseData.totalDuration = totalDuration;
        }

        function initializeSortable() {
            // Sortable for modules
            const modulesContainer = document.getElementById('modulesContainer');
            if (modulesContainer) {
                new Sortable(modulesContainer, {
                    animation: 150,
                    handle: '.drag-handle',
                    onEnd: function(evt) {
                        const moduleIds = Array.from(modulesContainer.children).map(el => el.dataset.moduleId);
                        const reorderedModules = [];
                        
                        moduleIds.forEach(id => {
                            const module = courseData.modules.find(m => m.id === id);
                            if (module) reorderedModules.push(module);
                        });
                        
                        courseData.modules = reorderedModules;
                        autoSave();
                    }
                });
            }
            
            // Sortable for lessons within each module
            courseData.modules.forEach(module => {
                const lessonsContainer = document.getElementById(`lessons-${module.id}`);
                if (lessonsContainer) {
                    new Sortable(lessonsContainer, {
                        animation: 150,
                        handle: '.drag-handle',
                        onEnd: function(evt) {
                            const lessonIds = Array.from(lessonsContainer.children).map(el => el.dataset.lessonId);
                            const reorderedLessons = [];
                            
                            lessonIds.forEach(id => {
                                const lesson = module.lessons.find(l => l.id === id);
                                if (lesson) reorderedLessons.push(lesson);
                            });
                            
                            module.lessons = reorderedLessons;
                            autoSave();
                        }
                    });
                }
            });
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================
function initializeEventListeners() {
    // Basic Info
document.getElementById('courseTitle').addEventListener('input', (e) => {
    // فقط تحديث العنوان في الهيدر
    document.getElementById('courseTitleHeader').textContent = e.target.value || 'دورة جديدة';
    
    // عرض slug مقترح كـ placeholder فقط
    if (e.target.value && e.target.value !== 'دورة جديدة') {
        const suggestedSlug = generateSlug(e.target.value);
        document.getElementById('courseSlug').placeholder = suggestedSlug;
        document.getElementById('slugPreview').textContent = suggestedSlug;
    }
});

// حفظ العنوان عند الخروج من الحقل فقط (لو موجود ID)
document.getElementById('courseTitle').addEventListener('blur', (e) => {
    courseData.title = e.target.value;
    if (courseData.id) {
        autoSave();
    }
});
    
    document.getElementById('courseSlug').addEventListener('change', (e) => {
        courseData.slug = e.target.value;
        document.getElementById('slugPreview').textContent = e.target.value;
        autoSave();
    });
    
    // All other form fields
    const formFields = [
        'subtitle', 'description', 'detailedDescription', 'language', 'targetAudience',
        'introVideo', 'instructorName', 'instructorTitle', 'instructorBio',
        'instructorLinkedIn', 'instructorTwitter', 'instructorWebsite',
        'category', 'level', 'price', 'salePrice', 'donationMin', 'donationMax',
        'vodafoneNumber', 'instapayNumber', 'bankName', 'bankAccountNumber', 'bankAccountName',
        'maxStudents', 'whatsappNumber', 'whatsappGroupLink', 'welcomeMessage',
        'courseStructure', 'learningType', 'dripType', 'minCompletion',
        'supportHours', 'certificateThreshold', 'certificateText',
        'progressMethod', 'expectedCompletion', 'seoTitle', 'seoDescription',
        'socialDescription', 'status', 'applicationDomain', 'practiceDepth', 'courseLevel'
    ];
    
    formFields.forEach(field => {
        const element = document.getElementById(field);
        if (element) {
            element.addEventListener('change', (e) => {
                courseData[field] = e.target.value;
                autoSave();
            });
        }
    });
    
    // Checkboxes
    const checkboxes = [
        'dripContent', 'enableQuizzes', 'enableAssignments', 'enableWaitlist',
        'autoWelcomeMessage', 'enableComments', 'enableForum', 'enableLiveSupport',
        'certificate', 'requireQuizzes', 'requireAssignments', 'requireParticipation',
        'requireFinalProject', 'showCompletionBadges', 'sendProgressEmails',
        'showProgressBar', 'showModuleProgress', 'showLearningStats',
        'showAchievementBadges', 'allowSharing', 'privateLink'
    ];
    
    checkboxes.forEach(field => {
        const element = document.getElementById(field);
        if (element) {
            element.addEventListener('change', (e) => {
                if (field.startsWith('require')) {
                    courseData.certificateRequirements[field] = e.target.checked;
                } else {
                    courseData[field] = e.target.checked;
                }
                
                // Handle dependent fields
                if (field === 'dripContent') {
                    document.getElementById('dripSettings').style.display = 
                        e.target.checked ? 'flex' : 'none';
                }
                if (field === 'autoWelcomeMessage') {
                    document.getElementById('welcomeMessageField').style.display = 
                        e.target.checked ? 'block' : 'none';
                }
                if (field === 'enableLiveSupport') {
                    document.getElementById('supportSettings').style.display = 
                        e.target.checked ? 'block' : 'none';
                }
                if (field === 'certificate') {
                    document.getElementById('certificateSettings').style.display = 
                        e.target.checked ? 'block' : 'none';
                }
                
                autoSave();
            });
        }
    });
    
    // Date fields
    const dateFields = ['enrollmentStartDate', 'enrollmentEndDate', 'scheduledPublish'];
    dateFields.forEach(field => {
        const element = document.getElementById(field);
        if (element) {
            element.addEventListener('change', (e) => {
                courseData[field] = e.target.value;
                autoSave();
            });
        }
    });
    
    // Select fields
    document.getElementById('isPublic').addEventListener('change', (e) => {
        courseData.isPublic = e.target.value === 'true';
        autoSave();
    });
    
    // إضافة مستمع لتفعيل المنح
    const enableGrants = document.getElementById('enableGrants');
    if (enableGrants) {
        enableGrants.addEventListener('change', (e) => {
            const grantsSettings = document.getElementById('grantsSettings');
            if (grantsSettings) {
                grantsSettings.style.display = e.target.checked ? 'block' : 'none';
            }
            collectFormData();
            autoSave();
        });
    }
    
    // مستمعي أحداث المنح
    const grantFields = [
        'grantSeats', 'totalSeats', 'grantFormUrl',
        'grantDiscount', 'grantInstallments', 'grantDeferred', 'grantService',
        'criteriaFinancial', 'criteriaMotivation', 'criteriaImpact', 'criteriaHistory'
    ];
    
    grantFields.forEach(field => {
        const element = document.getElementById(field);
        if (element) {
            element.addEventListener('change', () => {
                collectFormData();
                autoSave();
            });
        }
    });
}
        // ========================================
        // AUTO-SAVE
        // ========================================
function autoSave() {
    // منع الحفظ التلقائي للدورات الجديدة
    if (!courseData.id) {
        console.log('تجاهل الحفظ التلقائي - لا يوجد ID بعد');
        return;
    }
    
    // إلغاء أي حفظ سابق معلق
    clearTimeout(autoSaveTimeout);
    
    autoSaveTimeout = setTimeout(() => {
        saveCourseData().then(() => {
            showAutoSaveIndicator();
            console.log('تم الحفظ التلقائي بنجاح');
        }).catch(error => {
            console.error('فشل الحفظ التلقائي:', error);
        });
    }, 2000);
}

        function showAutoSaveIndicator() {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.classList.add('show');
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 3000);
        }

        // ========================================
        // FIREBASE INTEGRATION
        // ========================================
async function saveCourseData() {
    // منع الحفظ التلقائي للدورات الجديدة تماماً
    if (!courseData.id) {
        console.log('دورة جديدة - منع الحفظ التلقائي');
        return Promise.resolve();
    }
    
    if (!firebase.firestore) {
        console.error('Firestore not initialized');
        return Promise.reject('Firestore not initialized');
    }
    
    try {
        // جمع كل البيانات من الفورم
        collectFormData();
        
        // تحديث slug فقط (مش ID)
        let finalSlug = courseData.slug;
        const slugInput = document.getElementById('courseSlug');
        
        if (slugInput && slugInput.value.trim()) {
            finalSlug = slugInput.value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '');
        }
        
        if (!finalSlug && courseData.title && courseData.title !== 'دورة جديدة') {
            finalSlug = generateSlug(courseData.title);
        }
        
        // تجهيز البيانات للحفظ
        const dataToSave = {
            ...courseData,
            slug: finalSlug,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // حذف القيم الغير معرفة
        Object.keys(dataToSave).forEach(key => {
            if (dataToSave[key] === undefined) {
                delete dataToSave[key];
            }
        });
        
        // تحديث دورة موجودة فقط
        await window.firebaseDB.courses.updateCourse(courseData.id, dataToSave);
        console.log('تم تحديث الدورة:', courseData.id);
        
        return Promise.resolve();
    } catch (error) {
        console.error('Error saving course:', error);
        return Promise.reject(error);
    }
}
function collectFormData() {
    // تأكد من تحميل الصفحة أولاً
    if (!document.getElementById('courseTitle')) {
        console.log('الصفحة لم تحمل بعد');
        return;
    }
    
    // جمع البيانات الأساسية
    courseData.title = document.getElementById('courseTitle')?.value || 'دورة جديدة';
    courseData.slug = document.getElementById('courseSlug')?.value || generateSlug(courseData.title);
    courseData.subtitle = document.getElementById('subtitle')?.value || '';
    courseData.description = document.getElementById('description')?.value || '';
    courseData.detailedDescription = document.getElementById('detailedDescription')?.value || '';
    courseData.language = document.getElementById('language')?.value || 'ar';
    courseData.targetAudience = document.getElementById('targetAudience')?.value || 'all';
    courseData.introVideo = document.getElementById('introVideo')?.value || '';
    courseData.courseLevel = document.getElementById('courseLevel')?.value || 'foundational';
    courseData.applicationDomain = document.getElementById('applicationDomain')?.value || '';
    courseData.practiceDepth = document.getElementById('practiceDepth')?.value || '';
    
    // باقي الكود كما هو...

    // جمع بيانات العروض الزمنية من DOM مباشرة
    courseData.discounts = [];
    document.querySelectorAll('#discountsList .card').forEach((card, index) => {
        const nameInput = card.querySelector('input[placeholder="اسم العرض"]');
        const percentageInput = card.querySelector('input[type="number"]');
        const startDateInput = card.querySelector('input[type="date"]:first-of-type');
        const endDateInput = card.querySelector('input[type="date"]:last-of-type');
        
        if (nameInput && percentageInput) {
            const discount = {
                id: 'discount_' + Date.now() + '_' + index,
                name: nameInput.value || '',
                percentage: parseInt(percentageInput.value) || 0,
                startDate: startDateInput?.value || '',
                endDate: endDateInput?.value || ''
            };
            
            if (discount.name || discount.percentage > 0) {
                courseData.discounts.push(discount);
            }
        }
    });
    
    // جمع بيانات خصومات المجموعات من DOM مباشرة
    courseData.groupDiscounts = [];
    document.querySelectorAll('#groupDiscountsList .card').forEach((card, index) => {
        const nameInput = card.querySelector('input[placeholder="اسم العرض"]');
        const minSizeInputLabel = Array.from(card.querySelectorAll('label')).find(label => label.textContent.includes('من'));
        const minSizeInput = minSizeInputLabel ? minSizeInputLabel.nextElementSibling : card.querySelector('input[value="3"]');
        const maxSizeInputLabel = Array.from(card.querySelectorAll('label')).find(label => label.textContent.includes('إلى'));
        const maxSizeInput = maxSizeInputLabel ? maxSizeInputLabel.nextElementSibling : card.querySelector('input[value="5"]');
        const percentageInput = card.querySelector('.input-group input[type="number"]');
        
        if (percentageInput) {
            const groupDiscount = {
                id: 'group_' + Date.now() + '_' + index,
                name: nameInput?.value || '',
                minSize: parseInt(minSizeInput?.value) || 3,
                maxSize: parseInt(maxSizeInput?.value) || 5,
                percentage: parseInt(percentageInput.value) || 0
            };
            
            if (groupDiscount.percentage > 0) {
                courseData.groupDiscounts.push(groupDiscount);
            }
        }
    });
    
    // خطط الدفع والكوبونات محفوظة مسبقاً في المصفوفات عند الإضافة
    if (!courseData.paymentPlans) courseData.paymentPlans = [];
    if (!courseData.coupons) courseData.coupons = [];
    
    // جمع بيانات المنح
    courseData.grants = {
        enabled: document.getElementById('enableGrants')?.checked || false,
        seats: parseInt(document.getElementById('grantSeats')?.value) || 5,
        totalSeats: parseInt(document.getElementById('totalSeats')?.value) || 30,
        supportTypes: {
            discount: document.getElementById('grantDiscount')?.checked || false,
            installments: document.getElementById('grantInstallments')?.checked || false,
            deferred: document.getElementById('grantDeferred')?.checked || false,
            service: document.getElementById('grantService')?.checked || false
        },
        criteria: {
            financial: document.getElementById('criteriaFinancial')?.checked || false,
            motivation: document.getElementById('criteriaMotivation')?.checked || false,
            impact: document.getElementById('criteriaImpact')?.checked || false,
            history: document.getElementById('criteriaHistory')?.checked || false
        },
        formUrl: document.getElementById('grantFormUrl')?.value || null
    };
    
    // معلومات المدرب
    courseData.instructorName = document.getElementById('instructorName')?.value || '';
    courseData.instructorTitle = document.getElementById('instructorTitle')?.value || '';
    courseData.instructorBio = document.getElementById('instructorBio')?.value || '';
    courseData.instructorLinkedIn = document.getElementById('instructorLinkedIn')?.value || '';
    courseData.instructorTwitter = document.getElementById('instructorTwitter')?.value || '';
    courseData.instructorWebsite = document.getElementById('instructorWebsite')?.value || '';
    
    // التصنيف والمستوى
    courseData.category = document.getElementById('category')?.value || '';
    courseData.level = document.getElementById('level')?.value || 'beginner';
    
    // التسعير
    courseData.priceType = document.getElementById('priceType')?.value || 'free';
    courseData.currency = document.getElementById('currency')?.value || 'EGP';
    const priceValue = document.getElementById('price')?.value;
    courseData.price = priceValue ? parseFloat(priceValue) : 0;
    
    const salePriceValue = document.getElementById('salePrice')?.value;
    courseData.salePrice = salePriceValue ? parseFloat(salePriceValue) : null;
    
    const donationMinValue = document.getElementById('donationMin')?.value;
    courseData.donationMin = donationMinValue ? parseFloat(donationMinValue) : null;
    
    const donationMaxValue = document.getElementById('donationMax')?.value;
    courseData.donationMax = donationMaxValue ? parseFloat(donationMaxValue) : null;
    
    // إعدادات التسجيل
    courseData.enrollmentType = document.getElementById('enrollmentType')?.value || 'open';
    const maxStudentsValue = document.getElementById('maxStudents')?.value;
    courseData.maxStudents = maxStudentsValue ? parseInt(maxStudentsValue) : null;
    courseData.accessDuration = document.getElementById('accessDuration')?.value || 'lifetime';
    courseData.enrollmentStartDate = document.getElementById('enrollmentStartDate')?.value || null;
    courseData.enrollmentEndDate = document.getElementById('enrollmentEndDate')?.value || null;
    courseData.enableWaitlist = document.getElementById('enableWaitlist')?.checked || false;
    
    // التواصل
    courseData.whatsappNumber = document.getElementById('whatsappNumber')?.value || '';
    courseData.whatsappGroupLink = document.getElementById('whatsappGroupLink')?.value || '';
    courseData.autoWelcomeMessage = document.getElementById('autoWelcomeMessage')?.checked || true;
    courseData.welcomeMessage = document.getElementById('welcomeMessage')?.value || '';
    
    // هيكل الدورة
    courseData.courseStructure = document.getElementById('courseStructure')?.value || 'linear';
    courseData.learningType = document.getElementById('learningType')?.value || 'self-paced';
    courseData.dripContent = document.getElementById('dripContent')?.checked || false;
    courseData.dripType = document.getElementById('dripType')?.value || 'weekly';
    courseData.enableQuizzes = document.getElementById('enableQuizzes')?.checked || true;
    courseData.enableAssignments = document.getElementById('enableAssignments')?.checked || false;
    const minCompletionValue = document.getElementById('minCompletion')?.value;
    courseData.minCompletion = minCompletionValue ? parseInt(minCompletionValue) : 80;
    
    // مميزات التواصل
    courseData.enableComments = document.getElementById('enableComments')?.checked || true;
    courseData.enableForum = document.getElementById('enableForum')?.checked || false;
    courseData.enableLiveSupport = document.getElementById('enableLiveSupport')?.checked || false;
    courseData.supportHours = document.getElementById('supportHours')?.value || 'business';
    
    // إعدادات الشهادة
    courseData.certificate = document.getElementById('certificate')?.checked || true;
    const certificateThresholdValue = document.getElementById('certificateThreshold')?.value;
    courseData.certificateThreshold = certificateThresholdValue ? parseInt(certificateThresholdValue) : 80;
    courseData.certificateText = document.getElementById('certificateText')?.value || '';
    
    courseData.certificateRequirements = {
        requireQuizzes: document.getElementById('requireQuizzes')?.checked || false,
        requireAssignments: document.getElementById('requireAssignments')?.checked || false,
        requireParticipation: document.getElementById('requireParticipation')?.checked || false,
        requireFinalProject: document.getElementById('requireFinalProject')?.checked || false
    };
    
    // إعدادات التقدم
    courseData.showCompletionBadges = document.getElementById('showCompletionBadges')?.checked || true;
    courseData.sendProgressEmails = document.getElementById('sendProgressEmails')?.checked || false;
    courseData.progressMethod = document.getElementById('progressMethod')?.value || 'lessons';
    courseData.expectedCompletion = document.getElementById('expectedCompletion')?.value || '1month';
    courseData.showProgressBar = document.getElementById('showProgressBar')?.checked || true;
    courseData.showModuleProgress = document.getElementById('showModuleProgress')?.checked || true;
    courseData.showLearningStats = document.getElementById('showLearningStats')?.checked || false;
    courseData.showAchievementBadges = document.getElementById('showAchievementBadges')?.checked || false;
    
    // إعدادات SEO
    courseData.seoTitle = document.getElementById('seoTitle')?.value || courseData.title;
    courseData.seoDescription = document.getElementById('seoDescription')?.value || courseData.description;
    courseData.socialDescription = document.getElementById('socialDescription')?.value || courseData.description;
    courseData.allowSharing = document.getElementById('allowSharing')?.checked || true;
    
    // إعدادات النشر
    courseData.status = document.getElementById('status')?.value || 'draft';
    courseData.isPublic = document.getElementById('isPublic')?.value === 'true';
    courseData.privateLink = document.getElementById('privateLink')?.checked || false;
    courseData.scheduledPublish = document.getElementById('scheduledPublish')?.value || null;
    
    // طرق الدفع
    if (!courseData.paymentMethods) {
        courseData.paymentMethods = {
            instapay: { enabled: false, number: '' },
            vodafone: { enabled: false, number: '' },
            bank: { enabled: false, name: '', accountNumber: '', accountName: '' }
        };
    }
    
    courseData.paymentMethods.instapay.enabled = document.getElementById('instapayEnabled')?.checked || false;
    courseData.paymentMethods.instapay.number = document.getElementById('instapayNumber')?.value || '';
    
    courseData.paymentMethods.vodafone.enabled = document.getElementById('vodafoneEnabled')?.checked || false;
    courseData.paymentMethods.vodafone.number = document.getElementById('vodafoneNumber')?.value || '';
    
    courseData.paymentMethods.bank.enabled = document.getElementById('bankEnabled')?.checked || false;
    courseData.paymentMethods.bank.name = document.getElementById('bankName')?.value || '';
    courseData.paymentMethods.bank.accountNumber = document.getElementById('bankAccountNumber')?.value || '';
    courseData.paymentMethods.bank.accountName = document.getElementById('bankAccountName')?.value || '';
}
        
async function loadCourseData() {
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('id');
    
    if (courseId && firebase.firestore) {
        try {
            showLoading();
            console.log('جاري تحميل الدورة:', courseId);
            
            // جلب بيانات الدورة
            const course = await window.firebaseDB.courses.getCourse(courseId);
            
            if (course) {
                console.log('بيانات الدورة المحملة:', course);
                
                // دمج البيانات المحملة مع البيانات الافتراضية
                courseData = { ...courseData, ...course };
                
                // تحديث واجهة المستخدم
                updateUIWithCourseData();
                
                // تحديث شريط التقدم
                updateProgress();
                
                // عرض رسالة نجاح
                Swal.fire({
                    icon: 'success',
                    title: 'تم التحميل',
                    text: `تم تحميل دورة: ${course.title}`,
                    timer: 2000,
                    showConfirmButton: false,
                    position: 'top-end',
                    toast: true
                });
            } else {
                throw new Error('الدورة غير موجودة');
            }
            
            hideLoading();
        } catch (error) {
            console.error('Error loading course:', error);
            hideLoading();
            
            Swal.fire({
                icon: 'error',
                title: 'خطأ في تحميل البيانات',
                text: 'حدث خطأ أثناء تحميل بيانات الدورة: ' + error.message,
                confirmButtonText: 'حسناً'
            });
        }
    } else {
        console.log('دورة جديدة - لا يوجد ID');
    }
    // في نهاية دالة loadCourseData بعد تحميل البيانات بنجاح
if (courseData.id) {
    const saveBtn = document.getElementById('saveSlugBtn');
    if (saveBtn) {
        saveBtn.innerHTML = '<i class="fas fa-sync"></i> تحديث الرابط';
    }
}
}

function updateUIWithCourseData() {
    // تأكد من وجود courseData أولاً
    if (!courseData) {
        console.error('courseData غير موجود');
        return;
    }
    
    // تأكد من تحميل الصفحة
    if (!document.getElementById('courseTitle')) {
        console.log('الصفحة لم تحمل بعد - تأجيل updateUIWithCourseData');
        setTimeout(updateUIWithCourseData, 500);
        return;
    }
    
    // Update all form fields with loaded data
    
    // حقول العنوان الأساسية
    if (courseData.title) {
        document.getElementById('courseTitle').value = courseData.title;
        document.getElementById('courseTitleHeader').textContent = courseData.title;
    }
    
    if (courseData.slug) {
        document.getElementById('courseSlug').value = courseData.slug;
        document.getElementById('slugPreview').textContent = courseData.slug;
    }
    
    // الحقول النصية البسيطة
    const textFields = {
        'subtitle': 'subtitle',
        'description': 'description',
        'detailedDescription': 'detailedDescription',
        'introVideo': 'introVideo',
        'instructorName': 'instructorName',
        'instructorTitle': 'instructorTitle',
        'instructorBio': 'instructorBio',
        'instructorLinkedIn': 'instructorLinkedIn',
        'instructorTwitter': 'instructorTwitter',
        'instructorWebsite': 'instructorWebsite',
        'whatsappNumber': 'whatsappNumber',
        'whatsappGroupLink': 'whatsappGroupLink',
        'welcomeMessage': 'welcomeMessage',
        'certificateText': 'certificateText',
        'seoTitle': 'seoTitle',
        'seoDescription': 'seoDescription',
        'socialDescription': 'socialDescription',
        'grantFormUrl': 'grants.formUrl'
    };
    
    Object.keys(textFields).forEach(fieldId => {
        const element = document.getElementById(fieldId);
        const dataField = textFields[fieldId];
        
        if (element) {
            // Handle nested properties
            let value;
            if (dataField.includes('.')) {
                const parts = dataField.split('.');
                value = courseData[parts[0]]?.[parts[1]];
            } else {
                value = courseData[dataField];
            }
            
            if (value !== undefined) {
                element.value = value;
            }
        }
    });
    
    // الحقول الرقمية
    const numericFields = {
        'price': 'price',
        'salePrice': 'salePrice',
        'donationMin': 'donationMin',
        'donationMax': 'donationMax',
        'maxStudents': 'maxStudents',
        'minCompletion': 'minCompletion',
        'certificateThreshold': 'certificateThreshold',
        'grantSeats': 'grants.seats',
        'totalSeats': 'grants.totalSeats'
    };
    
    Object.keys(numericFields).forEach(fieldId => {
        const element = document.getElementById(fieldId);
        const dataField = numericFields[fieldId];
        
        if (element) {
            // Handle nested properties
            let value;
            if (dataField.includes('.')) {
                const parts = dataField.split('.');
                value = courseData[parts[0]]?.[parts[1]];
            } else {
                value = courseData[dataField];
            }
            
            if (value !== undefined && value !== null) {
                element.value = value;
            }
        }
    });
    
    // القوائم المنسدلة
    const selectFields = {
        'language': 'language',
        'targetAudience': 'targetAudience',
        'category': 'category',
        'level': 'level',
        'priceType': 'priceType',
        'currency': 'currency',
        'enrollmentType': 'enrollmentType',
        'accessDuration': 'accessDuration',
        'courseStructure': 'courseStructure',
        'learningType': 'learningType',
        'dripType': 'dripType',
        'supportHours': 'supportHours',
        'progressMethod': 'progressMethod',
        'expectedCompletion': 'expectedCompletion',
        'status': 'status',
        'applicationDomain': 'applicationDomain',
        'practiceDepth': 'practiceDepth',
        'courseLevel': 'courseLevel'
    };
    
    Object.keys(selectFields).forEach(fieldId => {
        const element = document.getElementById(fieldId);
        const dataField = selectFields[fieldId];
        if (element && courseData[dataField] !== undefined) {
            element.value = courseData[dataField];
        }
    });
    
    // تحديث isPublic
    if (document.getElementById('isPublic')) {
        document.getElementById('isPublic').value = courseData.isPublic ? 'true' : 'false';
    }
    
    // مربعات الاختيار
    const checkboxFields = [
        'enableWaitlist', 'autoWelcomeMessage', 'dripContent', 'enableQuizzes',
        'enableAssignments', 'enableComments', 'enableForum', 'enableLiveSupport',
        'certificate', 'showCompletionBadges', 'sendProgressEmails', 'showProgressBar',
        'showModuleProgress', 'showLearningStats', 'showAchievementBadges',
        'allowSharing', 'privateLink'
    ];
    
    checkboxFields.forEach(field => {
        const element = document.getElementById(field);
        if (element && courseData[field] !== undefined) {
            element.checked = courseData[field];
        }
    });
    
    // متطلبات الشهادة
    if (courseData.certificateRequirements) {
        Object.keys(courseData.certificateRequirements).forEach(key => {
            const element = document.getElementById(key);
            if (element) {
                element.checked = courseData.certificateRequirements[key];
            }
        });
    }
    
    // تحديث بيانات المنح
    if (courseData.grants) {
        const enableGrants = document.getElementById('enableGrants');
        if (enableGrants) {
            enableGrants.checked = courseData.grants.enabled || false;
        }
        
        if (courseData.grants.enabled) {
            const grantsSettings = document.getElementById('grantsSettings');
            if (grantsSettings) {
                grantsSettings.style.display = 'block';
            }
            
            // المقاعد
            if (courseData.grants.seats && document.getElementById('grantSeats')) {
                document.getElementById('grantSeats').value = courseData.grants.seats;
            }
            if (courseData.grants.totalSeats && document.getElementById('totalSeats')) {
                document.getElementById('totalSeats').value = courseData.grants.totalSeats;
            }
            
            // أنواع الدعم
            if (courseData.grants.supportTypes) {
                const supportTypes = ['grantDiscount', 'grantInstallments', 'grantDeferred', 'grantService'];
                supportTypes.forEach(type => {
                    const element = document.getElementById(type);
                    if (element) {
                        const key = type.replace('grant', '').toLowerCase();
                        element.checked = courseData.grants.supportTypes[key] !== false;
                    }
                });
            }
            
            // معايير التقييم
            if (courseData.grants.criteria) {
                const criteria = ['criteriaFinancial', 'criteriaMotivation', 'criteriaImpact', 'criteriaHistory'];
                criteria.forEach(criterion => {
                    const element = document.getElementById(criterion);
                    if (element) {
                        const key = criterion.replace('criteria', '').toLowerCase();
                        element.checked = courseData.grants.criteria[key] !== false;
                    }
                });
            }
            
            // رابط الاستمارة
            if (courseData.grants.formUrl && document.getElementById('grantFormUrl')) {
                document.getElementById('grantFormUrl').value = courseData.grants.formUrl;
            }
        }
    }
    
    // تحديث العروض والخصومات
    if (courseData.discounts && courseData.discounts.length > 0) {
        renderDiscounts();
    }
    
    // تحديث خصومات المجموعات
    if (courseData.groupDiscounts && courseData.groupDiscounts.length > 0) {
        renderGroupDiscounts();
    }
    
    // تحديث خطط الدفع
    if (courseData.paymentPlans && courseData.paymentPlans.length > 0) {
        renderPaymentPlans();
    }
    
    // تحديث معاينة الأسعار
    updatePricePreview();
    
    // طرق الدفع
    if (courseData.paymentMethods) {
        // Vodafone
        if (courseData.paymentMethods.vodafone) {
            const vodafoneEnabled = document.getElementById('vodafoneEnabled');
            if (vodafoneEnabled) {
                vodafoneEnabled.checked = courseData.paymentMethods.vodafone.enabled;
                togglePaymentMethod('vodafone');
            }
            const vodafoneNumber = document.getElementById('vodafoneNumber');
            if (vodafoneNumber && courseData.paymentMethods.vodafone.number) {
                vodafoneNumber.value = courseData.paymentMethods.vodafone.number;
            }
        }
        
        // InstaPay
        if (courseData.paymentMethods.instapay) {
            const instapayEnabled = document.getElementById('instapayEnabled');
            if (instapayEnabled) {
                instapayEnabled.checked = courseData.paymentMethods.instapay.enabled;
                togglePaymentMethod('instapay');
            }
            const instapayNumber = document.getElementById('instapayNumber');
            if (instapayNumber && courseData.paymentMethods.instapay.number) {
                instapayNumber.value = courseData.paymentMethods.instapay.number;
            }
        }
        
        // Bank
        if (courseData.paymentMethods.bank) {
            const bankEnabled = document.getElementById('bankEnabled');
            if (bankEnabled) {
                bankEnabled.checked = courseData.paymentMethods.bank.enabled;
                togglePaymentMethod('bank');
            }
            if (courseData.paymentMethods.bank.name && document.getElementById('bankName')) {
                document.getElementById('bankName').value = courseData.paymentMethods.bank.name;
            }
            if (courseData.paymentMethods.bank.accountNumber && document.getElementById('bankAccountNumber')) {
                document.getElementById('bankAccountNumber').value = courseData.paymentMethods.bank.accountNumber;
            }
            if (courseData.paymentMethods.bank.accountName && document.getElementById('bankAccountName')) {
                document.getElementById('bankAccountName').value = courseData.paymentMethods.bank.accountName;
            }
        }
    }
    
    // التواريخ
    const dateFields = ['enrollmentStartDate', 'enrollmentEndDate', 'scheduledPublish'];
    dateFields.forEach(field => {
        const element = document.getElementById(field);
        if (element && courseData[field]) {
            // تحويل التاريخ لصيغة datetime-local
            const date = new Date(courseData[field]);
            if (!isNaN(date)) {
                element.value = date.toISOString().slice(0, 16);
            }
        }
    });
    
    // الصور
    if (courseData.thumbnailUrl) {
        const preview = document.getElementById('thumbnailPreview');
        const image = document.getElementById('thumbnailImage');
        if (preview && image) {
            image.src = courseData.thumbnailUrl;
            preview.style.display = 'block';
        }
    }
    
    if (courseData.socialImageUrl) {
        const preview = document.getElementById('socialImagePreview');
        const image = document.getElementById('socialImage');
        if (preview && image) {
            image.src = courseData.socialImageUrl;
            preview.style.display = 'block';
        }
    }
    
    if (courseData.instructorImage || courseData.instructorImageUrl) {
        const preview = document.getElementById('instructorImagePreview');
        const image = document.getElementById('instructorImage');
        if (preview && image) {
            image.src = courseData.instructorImageUrl || courseData.instructorImage;
            preview.style.display = 'block';
        }
    }
    
    // العناصر الديناميكية
    renderObjectives();
    renderRequirements();
    renderKeywords();
    renderCoupons();
    renderPaymentPlans();
    renderModules();
    
    // تحديث الإحصائيات
    updateCurriculumStats();
    
    // تحديث حقول التسعير
    updatePricingFields();
    
    // تحديث تسمية العملة
    updateCurrencyLabel();
    
    // إظهار/إخفاء الحقول حسب الإعدادات
    if (courseData.dripContent) {
        const dripSettings = document.getElementById('dripSettings');
        if (dripSettings) {
            dripSettings.style.display = 'flex';
        }
    }
    
    if (courseData.enableLiveSupport) {
        const supportSettings = document.getElementById('supportSettings');
        if (supportSettings) {
            supportSettings.style.display = 'block';
        }
    }
    
    if (!courseData.certificate) {
        const certificateSettings = document.getElementById('certificateSettings');
        if (certificateSettings) {
            certificateSettings.style.display = 'none';
        }
    }
    
    if (!courseData.autoWelcomeMessage) {
        const welcomeMessageField = document.getElementById('welcomeMessageField');
        if (welcomeMessageField) {
            welcomeMessageField.style.display = 'none';
        }
    }
    
    console.log('تم تحميل بيانات الدورة بنجاح');
}    

        function updateProgress() {
            let completedFields = 0;
            let totalFields = 0;
            
            // Check required fields
            const requiredFields = [
                'title', 'description', 'instructorName', 'language'
            ];
            
            requiredFields.forEach(field => {
                totalFields++;
                if (courseData[field] && courseData[field].trim() !== '') {
                    completedFields++;
                }
            });
            
            // Check modules
            totalFields++;
            if (courseData.modules && courseData.modules.length > 0) {
                completedFields++;
            }
            
            // Calculate progress
            const progress = Math.round((completedFields / totalFields) * 100);
            courseData.progress = progress;
            
            // Update UI
            document.getElementById('progressBar').style.width = progress + '%';
        }
// دالة تبديل طرق الدفع
function togglePaymentMethod(method) {
    const methodContent = document.getElementById(method + 'Content');
    const methodCheckbox = document.getElementById(method + 'Enabled');
    
    if (methodContent && methodCheckbox) {
        methodContent.style.display = methodCheckbox.checked ? 'block' : 'none';
    }
}

// دوال التسعير الإضافية المفقودة
function renderPaymentPlans() {
    const container = document.getElementById('paymentPlansList');
    if (!container) return;
    
    if (!courseData.paymentPlans || courseData.paymentPlans.length === 0) {
        container.innerHTML = '<p class="text-muted">لا توجد خطط دفع حالياً</p>';
        return;
    }
    
    container.innerHTML = courseData.paymentPlans.map((plan, index) => `
        <div class="card mb-2">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5>${plan.name}</h5>
                        <p class="mb-0">
                            ${plan.installments} ${plan.installments === 1 ? 'دفعة' : 'دفعات'}
                            ${plan.frequency ? ` - ${getFrequencyText(plan.frequency)}` : ''}
                        </p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removePaymentPlan(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function removePaymentPlan(index) {
    courseData.paymentPlans.splice(index, 1);
    renderPaymentPlans();
    updatePricePreview();
}

function renderCoupons() {
    const container = document.getElementById('couponsList');
    if (!container) return;
    
    if (!courseData.coupons || courseData.coupons.length === 0) {
        container.innerHTML = '<p class="text-muted">لا توجد كوبونات حالياً</p>';
        return;
    }
    
    container.innerHTML = courseData.coupons.map((coupon, index) => `
        <div class="card mb-2">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge badge-primary">${coupon.code}</span>
                        <span class="ms-2">
                            ${coupon.type === 'percentage' ? `${coupon.value}%` : `${coupon.value} ${courseData.currency}`}
                        </span>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeCoupon(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function addCoupon() {
    const code = document.getElementById('couponCode').value.trim().toUpperCase();
    const type = document.getElementById('couponType').value;
    const value = parseFloat(document.getElementById('couponValue').value) || 0;
    
    if (!code || value === 0) {
        Swal.fire({
            icon: 'error',
            title: 'خطأ',
            text: 'يرجى إدخال كود الكوبون والقيمة'
        });
        return;
    }
    
    const coupon = { code, type, value };
    
    if (!courseData.coupons) courseData.coupons = [];
    courseData.coupons.push(coupon);
    
    // Clear inputs
    document.getElementById('couponCode').value = '';
    document.getElementById('couponValue').value = '';
    
    renderCoupons();
    updatePricePreview();
}

function removeCoupon(index) {
    courseData.coupons.splice(index, 1);
    renderCoupons();
    updatePricePreview();
}

function renderModules() {
    const container = document.getElementById('modulesContainer');
    if (!container) return;
    
    if (!courseData.modules || courseData.modules.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-book"></i>
                <h3>لم تقم بإضافة أي وحدات بعد</h3>
                <p>ابدأ ببناء منهج الدورة بإضافة الوحدات والدروس</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = courseData.modules.map((module, index) => `
        <div class="module-card" data-module-id="${module.id}">
            <div class="module-header">
                <div class="d-flex align-items-center">
                    <i class="fas fa-grip-vertical drag-handle"></i>
                    <input type="text" class="form-control ms-2" value="${module.title}"
                           onchange="updateModuleTitle('${module.id}', this.value)"
                           style="background: transparent; border: none; font-weight: 600;">
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleModule('${module.id}')">
                        <i class="fas fa-chevron-${module.isExpanded ? 'up' : 'down'}"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteModule(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="module-content" style="display: ${module.isExpanded ? 'block' : 'none'}">
                <div class="mb-3">
                    <textarea class="form-control" placeholder="وصف الوحدة (اختياري)"
                              onchange="updateModuleDescription('${module.id}', this.value)">${module.description || ''}</textarea>
                </div>
                <div class="lessons-container" id="lessons-${module.id}">
                    ${module.lessons && module.lessons.length > 0 ? renderLessons(module.lessons, module.id) : '<p class="text-muted">لا توجد دروس في هذه الوحدة</p>'}
                </div>
                <button class="btn btn-outline-primary btn-sm" onclick="showContentTypes('${module.id}')">
                    <i class="fas fa-plus"></i> إضافة محتوى
                </button>
            </div>
        </div>
    `).join('');
    
    // Initialize sortable
    if (typeof initializeSortable === 'function') {
        initializeSortable();
    }
}

function updateCurriculumStats() {
    const totalModules = courseData.modules ? courseData.modules.length : 0;
    let totalLessons = 0;
    let totalDuration = 0;
    
    if (courseData.modules) {
        courseData.modules.forEach(module => {
            if (module.lessons) {
                totalLessons += module.lessons.length;
                module.lessons.forEach(lesson => {
                    totalDuration += lesson.duration || 0;
                });
            }
        });
    }
    
    const modulesElement = document.getElementById('totalModules');
    const lessonsElement = document.getElementById('totalLessons');
    const durationElement = document.getElementById('totalDuration');
    
    if (modulesElement) modulesElement.textContent = totalModules;
    if (lessonsElement) lessonsElement.textContent = totalLessons;
    if (durationElement) durationElement.textContent = totalDuration;
    
    courseData.totalLessons = totalLessons;
    courseData.totalDuration = totalDuration;
}

function renderLessons(lessons, moduleId) {
    if (!lessons || lessons.length === 0) {
        return '<p class="text-muted">لا توجد دروس في هذه الوحدة</p>';
    }
    
    return lessons.map((lesson, index) => `
        <div class="lesson-item" data-lesson-id="${lesson.id}">
            <div class="lesson-info">
                <i class="fas fa-grip-vertical drag-handle"></i>
                <div class="lesson-type-icon">
                    <i class="fas fa-${getLessonIcon(lesson.type)}"></i>
                </div>
                <div>
                    <div class="fw-semibold">${lesson.title}</div>
                    <small class="text-muted">${lesson.duration} دقيقة</small>
                </div>
            </div>
            <div>
                <button class="btn btn-sm btn-outline-secondary" onclick="editLesson('${moduleId}', '${lesson.id}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteLesson('${moduleId}', '${lesson.id}')">
                    <i class="fas fa-trash"></i>
                </button>
                <button class="btn btn-sm ${lesson.isFreePreview ? 'btn-success' : 'btn-outline-success'}" 
                        onclick="toggleFreePreview('${moduleId}', '${lesson.id}')"
                        title="${lesson.isFreePreview ? 'إلغاء المعاينة المجانية' : 'إتاحة كمعاينة مجانية'}">
                    <i class="fas ${lesson.isFreePreview ? 'fa-eye' : 'fa-eye-slash'}"></i>
                </button>
            </div>
        </div>
    `).join('');
}
        
        // ========================================
        // FINAL ACTIONS
        // ========================================
        async function saveDraft() {
            try {
                showLoading();
                courseData.status = 'draft';
                await saveCourseData();
                hideLoading();
                
                Swal.fire({
                    icon: 'success',
                    title: 'تم الحفظ',
                    text: 'تم حفظ الدورة كمسودة بنجاح',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                hideLoading();
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء حفظ الدورة'
                });
            }
        }

        async function publishCourse() {
            // Validate required fields
            if (!validateCourse()) {
                return;
            }
            
            Swal.fire({
                title: 'نشر الدورة؟',
                text: 'هل أنت متأكد من نشر هذه الدورة؟',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'نعم، انشر',
                cancelButtonText: 'إلغاء'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        showLoading();
                        courseData.status = 'published';
                        courseData.publishedAt = firebase.firestore.FieldValue.serverTimestamp();
                        await saveCourseData();
                        hideLoading();
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'تم النشر!',
                            text: 'تم نشر الدورة بنجاح',
                            confirmButtonText: 'عرض الدورة'
                        }).then(() => {
                            window.location.href = `/courses/${courseData.slug || courseData.id}`;
                        });
                    } catch (error) {
                        hideLoading();
                        Swal.fire({
                            icon: 'error',
                            title: 'خطأ',
                            text: 'حدث خطأ أثناء نشر الدورة'
                        });
                    }
                }
            });
        }

        function validateCourse() {
            const errors = [];
            
            if (!courseData.title || courseData.title.trim() === '') {
                errors.push('عنوان الدورة مطلوب');
            }
            
            if (!courseData.description || courseData.description.trim() === '') {
                errors.push('وصف الدورة مطلوب');
            }
            
            if (!courseData.instructorName || courseData.instructorName.trim() === '') {
                errors.push('اسم المدرب مطلوب');
            }
            
            if (!courseData.modules || courseData.modules.length === 0) {
                errors.push('يجب إضافة وحدة واحدة على الأقل');
            }
            
            if (courseData.priceType === 'paid' && (!courseData.price || courseData.price <= 0)) {
                errors.push('يجب تحديد سعر الدورة');
            }
            
            if (errors.length > 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'معلومات ناقصة',
                    html: errors.join('<br>')
                });
                return false;
            }
            
            return true;
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // Add custom styles for content types popup
        const style = document.createElement('style');
        style.textContent = `
            .content-types-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 1rem;
                padding: 1rem;
            }
            
            .content-type-btn {
                background-color: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-lg);
                padding: 2rem 1rem;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.5rem;
                color: var(--text-primary);
            }
            
            .content-type-btn:hover {
                background-color: var(--primary);
                color: white;
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }
            
            .content-type-btn i {
                font-size: 2rem;
            }
            
            .content-types-popup {
                background-color: var(--bg-secondary) !important;
                color: var(--text-primary) !important;
            }
            
            .swal2-popup {
                background-color: var(--bg-secondary);
                color: var(--text-primary);
            }
            
            .swal2-title {
                color: var(--text-primary);
            }
            
            .swal2-input, .swal2-textarea {
                background-color: var(--bg-card);
                border: 1px solid var(--border-color);
                color: var(--text-primary);
            }
            
            .swal2-confirm {
                background-color: var(--primary) !important;
            }
            
            .swal2-cancel {
                background-color: var(--bg-card) !important;
                color: var(--text-primary) !important;
                border: 1px solid var(--border-color) !important;
            }
            
            .review-section {
                background-color: var(--bg-card);
                border-radius: var(--radius-lg);
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
            
            .review-section h3 {
                color: var(--primary);
                margin-bottom: 1rem;
                font-size: 1.25rem;
            }
            
            .review-content {
                color: var(--text-secondary);
                line-height: 1.8;
            }
            
            .review-content .review-item {
                margin-bottom: 0.5rem;
                padding-left: 1.5rem;
                position: relative;
            }
            
            .review-content .review-item::before {
                content: "•";
                position: absolute;
                left: 0;
                color: var(--primary);
            }
        `;
        document.head.appendChild(style);
        // 2. JavaScript Functions للتعامل مع البيانات


        // دالة إضافة عرض خصم
// دالة إضافة عرض خصم محسّنة
// متغير لمنع الضغط المتكرر
let isAddingItem = false;

// دالة إضافة عرض خصم
function addDiscountTier() {
    // منع الضغط المتكرر
    if (isAddingItem) return;
    isAddingItem = true;
    
    const discount = {
        id: 'discount_' + Date.now(),
        name: '',
        percentage: 15,
        startDate: '',
        endDate: '',
        conditions: ''
    };
    
    if (!courseData.discounts) courseData.discounts = [];
    courseData.discounts.push(discount);
    renderDiscounts();
    
    // السماح بالضغط مرة أخرى بعد ثانية
    setTimeout(() => { isAddingItem = false; }, 1000);
}

// دالة حذف الخصم
function removeDiscount(index) {
    courseData.discounts.splice(index, 1);
    renderDiscounts();
    updatePricePreview();
}

// دالة تحديث الخصم
function updateDiscount(index, field, value) {
    courseData.discounts[index][field] = field === 'percentage' ? parseInt(value) : value;
    updatePricePreview();
}

// دالة عرض الخصومات
function renderDiscounts() {
    const container = document.getElementById('discountsList');
    if (!courseData.discounts || courseData.discounts.length === 0) {
        container.innerHTML = '<p class="text-muted">لا توجد عروض خصم حالياً</p>';
        return;
    }
    
    container.innerHTML = courseData.discounts.map((discount, index) => `
        <div class="card mb-2">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <input type="text" class="form-control" placeholder="اسم العرض"
                               value="${discount.name}" onchange="updateDiscount(${index}, 'name', this.value)">
                    </div>
                    <div class="col-md-2">
                        <div class="input-group">
                            <input type="number" class="form-control" value="${discount.percentage}"
                                   onchange="updateDiscount(${index}, 'percentage', this.value)">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" value="${discount.startDate}"
                               onchange="updateDiscount(${index}, 'startDate', this.value)">
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" value="${discount.endDate}"
                               onchange="updateDiscount(${index}, 'endDate', this.value)">
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-danger" onclick="removeDiscount(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}


// 4. معاينة الأسعار الحية
// معاينة الأسعار - الجدول الاحترافي الكامل
function updatePricePreview() {
    const basePrice = parseFloat(document.getElementById('price')?.value) || 0;
    const salePrice = parseFloat(document.getElementById('salePrice')?.value) || 0;
    const currency = document.getElementById('currency').value || 'EGP';
    const priceType = document.getElementById('priceType').value;
    
    if (priceType === 'free') {
        document.getElementById('pricePreview').innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-gift fa-3x mb-3"></i>
                <h3>الدورة مجانية</h3>
            </div>
        `;
        return;
    }
    
    if (basePrice === 0) {
        document.getElementById('pricePreview').innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-info-circle fa-3x mb-3"></i>
                <p>أدخل سعر الدورة لعرض جدول الأسعار التفصيلي</p>
            </div>
        `;
        return;
    }
    
    // السعر النشط (إما السعر الأساسي أو سعر التخفيض)
    const activePrice = salePrice > 0 ? salePrice : basePrice;
    
    // جمع كل البيانات
    const discounts = courseData.discounts || [];
    const cashDiscountEnabled = document.getElementById('enableCashDiscount')?.checked;
    const cashDiscountPercent = parseInt(document.getElementById('cashDiscountPercent')?.value) || 0;
    const paymentPlans = courseData.paymentPlans || [];
    const groupDiscounts = courseData.groupDiscounts || [];
    const coupons = courseData.coupons || [];
    const grantsEnabled = document.getElementById('enableGrants')?.checked;
    const grantPlans = courseData.grantPlans || [];
    
    // بناء الجدول الرئيسي
    let html = `
        <div class="pricing-master-table">
            <h3 class="table-main-header">
                <i class="fas fa-th"></i> جدول الأسعار التفصيلي الشامل
            </h3>
    `;
    
    // الجدول الرئيسي للأسعار
    html += `
        <table class="main-pricing-table">
            <thead>
                <tr>
                    <th width="25%">الفترة / العرض</th>
                    <th width="20%">السعر الأساسي</th>
                    <th width="35%">خيارات الدفع</th>
                    <th width="20%">ملاحظات</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    // صف السعر الأساسي
    html += `
        <tr class="base-price-row">
            <td class="offer-name">
                <strong>السعر الأساسي</strong>
                ${salePrice > 0 ? `<br><small class="text-danger">قبل التخفيض: ${formatPrice(basePrice, currency)}</small>` : ''}
            </td>
            <td class="price-cell">
                <div class="main-price">${formatPrice(activePrice, currency)}</div>
            </td>
            <td class="payment-options-cell">
    `;
    
    // خيارات الدفع للسعر الأساسي
    if (cashDiscountEnabled && cashDiscountPercent > 0) {
        const cashPrice = marketingRound(activePrice * (1 - cashDiscountPercent/100));
        html += `
            <div class="payment-option cash-option">
                <span class="option-label">دفعة واحدة كاش:</span>
                <span class="option-price">${formatPrice(cashPrice, currency)}</span>
                <span class="discount-badge">خصم ${cashDiscountPercent}%</span>
            </div>
        `;
    }
    
    paymentPlans.forEach(plan => {
        if (plan.installments > 1) {
            const installmentAmount = marketingRound(activePrice / plan.installments);
            html += `
                <div class="payment-option">
                    <span class="option-label">${plan.name}:</span>
                    <span class="option-price">${plan.installments} × ${formatPrice(installmentAmount, currency)}</span>
                </div>
            `;
        }
    });
    
    if (!cashDiscountEnabled && paymentPlans.length === 0) {
        html += `<div class="no-options">لا توجد خطط دفع</div>`;
    }
    
    html += `
            </td>
            <td class="notes-cell">السعر الأساسي للدورة</td>
        </tr>
    `;
    
    // العروض الزمنية
    if (discounts.length > 0) {
        discounts.forEach((discount, index) => {
            if (!discount.name && discount.percentage === 0) return;
            
            const discountedPrice = marketingRound(activePrice * (1 - discount.percentage/100));
            const rowClass = index === 0 ? 'premium-offer' : index === 1 ? 'early-offer' : '';
            
            html += `
                <tr class="${rowClass}">
                    <td class="offer-name">
                        <strong>${discount.name || 'عرض'}</strong>
                        ${discount.percentage > 0 ? `<br><span class="discount-percent">خصم ${discount.percentage}%</span>` : ''}
                        ${discount.dateRange ? `<br><small class="date-range">${discount.dateRange}</small>` : ''}
                    </td>
                    <td class="price-cell">
                        <div class="main-price">${formatPrice(discountedPrice, currency)}</div>
                    </td>
                    <td class="payment-options-cell">
            `;
            
            // خيارات الدفع للعرض
            if (cashDiscountEnabled && cashDiscountPercent > 0) {
                const cashPrice = marketingRound(discountedPrice * (1 - cashDiscountPercent/100));
                html += `
                    <div class="payment-option cash-option">
                        <span class="option-label">دفعة واحدة كاش:</span>
                        <span class="option-price">${formatPrice(cashPrice, currency)}</span>
                        <span class="discount-badge">خصم ${cashDiscountPercent}%</span>
                    </div>
                `;
            }
            
            paymentPlans.forEach(plan => {
                if (plan.installments > 1) {
                    const installmentAmount = marketingRound(discountedPrice / plan.installments);
                    html += `
                        <div class="payment-option">
                            <span class="option-label">${plan.name}:</span>
                            <span class="option-price">${plan.installments} × ${formatPrice(installmentAmount, currency)}</span>
                        </div>
                    `;
                }
            });
            
            html += `
                    </td>
                    <td class="notes-cell">عرض محدود المدة</td>
                </tr>
            `;
        });
    }
    
    html += `
            </tbody>
        </table>
    `;
    
    // جدول خصومات المجموعات
    if (groupDiscounts.length > 0) {
        html += `
            <h4 class="section-header mt-4">
                <i class="fas fa-users"></i> عروض المجموعات
            </h4>
            <table class="secondary-table">
                <thead>
                    <tr>
                        <th>العرض</th>
                        <th>الحد الأدنى</th>
                        <th>نسبة الخصم</th>
                        <th>السعر بعد الخصم</th>
                        <th>خيارات الدفع</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        groupDiscounts.forEach(group => {
            const groupPrice = marketingRound(activePrice * (1 - group.percentage/100));
            html += `
                <tr>
                    <td>${group.name || 'عرض مجموعات'}</td>
                    <td>${group.minSize} أشخاص</td>
                    <td>${group.percentage}%</td>
                    <td class="price-cell">${formatPrice(groupPrice, currency)}</td>
                    <td>
            `;
            
            if (cashDiscountEnabled && cashDiscountPercent > 0) {
                const cashPrice = marketingRound(groupPrice * (1 - cashDiscountPercent/100));
                html += `كاش: ${formatPrice(cashPrice, currency)} | `;
            }
            
            if (paymentPlans.length > 0) {
                const plan = paymentPlans[0];
                const installmentAmount = marketingRound(groupPrice / plan.installments);
                html += `تقسيط: ${plan.installments} × ${formatPrice(installmentAmount, currency)}`;
            }
            
            html += `
                    </td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
        `;
    }
    
    // جدول الكوبونات
    if (coupons.length > 0) {
        html += `
            <h4 class="section-header mt-4">
                <i class="fas fa-ticket-alt"></i> كوبونات الخصم
            </h4>
            <table class="secondary-table">
                <thead>
                    <tr>
                        <th>كود الكوبون</th>
                        <th>نوع الخصم</th>
                        <th>قيمة الخصم</th>
                        <th>مثال على السعر النهائي</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        coupons.forEach(coupon => {
            const finalPrice = calculateCouponPrice(activePrice, coupon);
            html += `
                <tr>
                    <td class="coupon-code">${coupon.code}</td>
                    <td>${coupon.type === 'percentage' ? 'نسبة مئوية' : 'مبلغ ثابت'}</td>
                    <td>${coupon.type === 'percentage' ? coupon.value + '%' : formatPrice(coupon.value, currency)}</td>
                    <td class="price-cell">${formatPrice(marketingRound(finalPrice), currency)}</td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
        `;
    }
    
    // جدول برنامج المنح
    if (grantsEnabled && grantPlans.length > 0) {
        html += `
            <h4 class="section-header mt-4">
                <i class="fas fa-graduation-cap"></i> برنامج المنح الدراسية
            </h4>
            <table class="secondary-table grants-table">
                <thead>
                    <tr>
                        <th>خطة المنحة</th>
                        <th>نوع الدعم</th>
                        <th>السعر النهائي</th>
                        <th>خطة السداد</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        grantPlans.forEach(plan => {
            let grantPrice;
            if (plan.discountType === 'percentage') {
                grantPrice = marketingRound(activePrice * (1 - plan.percentage/100));
            } else {
                grantPrice = marketingRound(Math.max(0, activePrice - plan.fixedAmount));
            }
            
            const firstPayment = marketingRound(grantPrice * plan.firstPayment / 100);
            const remainingAmount = grantPrice - firstPayment;
            const monthlyPayment = marketingRound(remainingAmount / (plan.installments - 1));
            
            html += `
                <tr>
                    <td>${plan.name}</td>
                    <td>
                        ${plan.discountType === 'percentage' 
                            ? `خصم ${plan.percentage}%` 
                            : `خصم ${formatPrice(plan.fixedAmount, currency)}`}
                    </td>
                    <td class="price-cell">${formatPrice(grantPrice, currency)}</td>
                    <td>
                        دفعة أولى: ${formatPrice(firstPayment, currency)}<br>
                        ثم ${plan.installments - 1} أقساط × ${formatPrice(monthlyPayment, currency)}
                    </td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
        `;
    }
    
    html += `
        </div>
    `;
    
    document.getElementById('pricePreview').innerHTML = html;
}



// Event listener للمنح
window.addEventListener('load', function() {
    setTimeout(function() {
        const enableGrantsCheckbox = document.getElementById('enableGrants');
        if (enableGrantsCheckbox) {
            enableGrantsCheckbox.addEventListener('change', function() {
                const grantsSettings = document.getElementById('grantsSettings');
                if (grantsSettings) {
                    grantsSettings.style.display = this.checked ? 'block' : 'none';
                    updatePricePreview();
                }
            });
        }
    }, 1000);
});

        // ========================================
// دوال جمع البيانات Helper Functions
// ========================================

// دالة جمع الخصومات من الفورم
function collectDiscounts() {
    const discounts = [];
    document.querySelectorAll('#discountsList .card').forEach(card => {
        const inputs = card.querySelectorAll('input');
        const name = inputs[0]?.value || '';
        const percentage = parseFloat(inputs[1]?.value) || 0;
        const startDate = inputs[2]?.value || '';
        const endDate = inputs[3]?.value || '';
        
        if (name || percentage >= 0) {
            let dateRange = '';
            if (startDate && endDate) {
                dateRange = `من ${formatDate(startDate)} إلى ${formatDate(endDate)}`;
            }
            discounts.push({ name, percentage, dateRange });
        }
    });
    
    return discounts;
}

// دالة جمع خطط الدفع
function collectPaymentPlans() {
    const plans = [];
    
    // خصم الدفع الكامل
    if (document.getElementById('enableCashDiscount')?.checked) {
        const cashDiscount = parseInt(document.getElementById('cashDiscountPercent')?.value) || 0;
        if (cashDiscount > 0) {
            plans.push({
                name: 'دفعة واحدة',
                installments: 1,
                hasDiscount: true,
                discount: cashDiscount,
                frequency: 'full'
            });
        }
    }
    
    // خطط التقسيط
    if (courseData.paymentPlans) {
        courseData.paymentPlans.forEach(plan => {
            plans.push({
                name: plan.name,
                installments: plan.installments,
                hasDiscount: false,
                discount: 0,
                frequency: plan.frequency || 'monthly'
            });
        });
    }
    
    return plans;
}

// دالة جمع إعدادات المجموعات
function collectGroupSettings() {
    const groups = [];
    
    if (courseData.groupDiscounts && courseData.groupDiscounts.length > 0) {
        courseData.groupDiscounts.forEach(group => {
            groups.push({
                enabled: true,
                name: group.name || `مجموعة ${group.minSize}+ أشخاص`,
                minSize: group.minSize,
                discount: group.percentage
            });
        });
    }
    
    return groups;
}

// دالة جمع الكوبونات
function collectCoupons() {
    return courseData.coupons || [];
}

// دالة جمع خطط المنح
function collectGrantPlans() {
    return courseData.grantPlans || [];
}

// دالة حساب السعر مع الكوبون
function calculateCouponPrice(basePrice, coupon) {
    if (coupon.type === 'percentage') {
        return basePrice * (1 - coupon.value / 100);
    } else {
        return Math.max(0, basePrice - coupon.value);
    }
}

// دالة تنسيق الأقساط
function formatInstallments(totalPrice, plan, currency) {
    const installment = marketingRound(totalPrice / plan.installments);
    return `${plan.installments} × ${formatPrice(installment, currency)}`;
}

// ========================================
// التكامل مع collectFormData
// ========================================

// أضف هذا في نهاية دالة collectFormData الموجودة
function updateCollectFormDataForPricing() {
    // جمع بيانات التسعير
    courseData.priceType = document.getElementById('priceType')?.value || 'free';
    courseData.currency = document.getElementById('currency')?.value || 'EGP';
    courseData.price = parseFloat(document.getElementById('price')?.value) || 0;
    courseData.salePrice = parseFloat(document.getElementById('salePrice')?.value) || null;
    
    // خصم الدفع الكامل
    courseData.cashDiscount = {
        enabled: document.getElementById('enableCashDiscount')?.checked || false,
        percentage: parseInt(document.getElementById('cashDiscountPercent')?.value) || 0
    };
    
    // الخصومات الزمنية تم جمعها بالفعل في courseData.discounts
    // خصومات المجموعات تم جمعها بالفعل في courseData.groupDiscounts
    // خطط الدفع تم جمعها بالفعل في courseData.paymentPlans
    // الكوبونات تم جمعها بالفعل في courseData.coupons
    // خطط المنح تم جمعها بالفعل في courseData.grantPlans
}

        // ========================================
// نظام التسعير الجديد
// ========================================

// تحديث حقول التسعير
function updatePricingFields() {
    const priceType = document.getElementById('priceType').value;
    const priceField = document.getElementById('priceField');
    const salePriceField = document.getElementById('salePriceField');
    
    if (priceType === 'free') {
        priceField.style.display = 'none';
        salePriceField.style.display = 'none';
    } else {
        priceField.style.display = 'block';
        salePriceField.style.display = 'block';
    }
    
    courseData.priceType = priceType;
    updatePricePreview();
}

// تحديث تسمية العملة
function updateCurrencyLabel() {
    const currency = document.getElementById('currency').value;
    document.getElementById('currencyLabel').textContent = currency;
    courseData.currency = currency;
    updatePricePreview();
}

// خصم الدفع الكامل
function toggleCashDiscount() {
    const enabled = document.getElementById('enableCashDiscount').checked;
    document.getElementById('cashDiscountSection').style.display = enabled ? 'block' : 'none';
    updatePricePreview();
}

// إضافة عرض خصم
function addDiscountTier() {
    const discount = {
        id: 'discount_' + Date.now(),
        name: '',
        percentage: 0,
        startDate: '',
        endDate: ''
    };
    
    if (!courseData.discounts) courseData.discounts = [];
    courseData.discounts.push(discount);
    renderDiscounts();
}

function removeDiscount(index) {
    courseData.discounts.splice(index, 1);
    renderDiscounts();
    updatePricePreview();
}

function updateDiscount(index, field, value) {
    courseData.discounts[index][field] = field === 'percentage' ? parseInt(value) || 0 : value;
    updatePricePreview();
}

function renderDiscounts() {
    const container = document.getElementById('discountsList');
    if (!courseData.discounts || courseData.discounts.length === 0) {
        container.innerHTML = '<p class="text-muted">لا توجد عروض خصم حالياً</p>';
        return;
    }
    
    container.innerHTML = courseData.discounts.map((discount, index) => `
        <div class="card mb-2">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <input type="text" class="form-control" placeholder="اسم العرض"
                               value="${discount.name}" onchange="updateDiscount(${index}, 'name', this.value)">
                    </div>
                    <div class="col-md-2">
                        <div class="input-group">
                            <input type="number" class="form-control" value="${discount.percentage}"
                                   min="0" max="100" onchange="updateDiscount(${index}, 'percentage', this.value)">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" value="${discount.startDate}"
                               onchange="updateDiscount(${index}, 'startDate', this.value)">
                        <small class="text-muted">من تاريخ</small>
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" value="${discount.endDate}"
                               onchange="updateDiscount(${index}, 'endDate', this.value)">
                        <small class="text-muted">إلى تاريخ</small>
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-danger btn-sm" onclick="removeDiscount(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// خصومات المجموعات
function addGroupDiscount() {
    const groupDiscount = {
        id: 'group_' + Date.now(),
        name: '',
        minSize: 3,
        percentage: 10
    };
    
    if (!courseData.groupDiscounts) courseData.groupDiscounts = [];
    courseData.groupDiscounts.push(groupDiscount);
    renderGroupDiscounts();
}

function removeGroupDiscount(index) {
    courseData.groupDiscounts.splice(index, 1);
    renderGroupDiscounts();
    updatePricePreview();
}

function updateGroupDiscount(index, field, value) {
    const numValue = field === 'minSize' || field === 'percentage' ? parseInt(value) || 0 : value;
    courseData.groupDiscounts[index][field] = numValue;
    updatePricePreview();
}

function renderGroupDiscounts() {
    const container = document.getElementById('groupDiscountsList');
    if (!courseData.groupDiscounts || courseData.groupDiscounts.length === 0) {
        container.innerHTML = '<p class="text-muted">لا توجد عروض مجموعات حالياً</p>';
        return;
    }
    
    container.innerHTML = courseData.groupDiscounts.map((group, index) => `
        <div class="card mb-2">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <input type="text" class="form-control" placeholder="اسم عرض المجموعة"
                               value="${group.name}" onchange="updateGroupDiscount(${index}, 'name', this.value)">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">الحد الأدنى للمجموعة</label>
                        <input type="number" class="form-control" value="${group.minSize}"
                               min="2" onchange="updateGroupDiscount(${index}, 'minSize', this.value)">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">نسبة الخصم</label>
                        <div class="input-group">
                            <input type="number" class="form-control" value="${group.percentage}"
                                   min="0" max="100" onchange="updateGroupDiscount(${index}, 'percentage', this.value)">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-md-2 text-end">
                        <button class="btn btn-danger btn-sm" onclick="removeGroupDiscount(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// برنامج المنح
function toggleGrants() {
    const enabled = document.getElementById('enableGrants').checked;
    document.getElementById('grantsSection').style.display = enabled ? 'block' : 'none';
    updatePricePreview();
}

function addGrantPlan() {
    Swal.fire({
        title: 'إضافة خطة منحة',
        html: `
            <div class="form-group mb-3">
                <label>اسم الخطة</label>
                <input type="text" id="grantName" class="swal2-input" 
                       placeholder="مثال: منحة الطلاب المتفوقين">
            </div>
            
            <div class="form-group mb-3">
                <label>نوع الخصم</label>
                <select id="grantDiscountType" class="swal2-select" onchange="toggleGrantDiscountFields()">
                    <option value="percentage">نسبة مئوية</option>
                    <option value="fixed">مبلغ ثابت</option>
                </select>
            </div>
            
            <div class="form-group mb-3" id="grantPercentageField">
                <label>نسبة الخصم (%)</label>
                <input type="number" id="grantPercentage" class="swal2-input" 
                       value="50" min="0" max="100">
            </div>
            
            <div class="form-group mb-3" id="grantFixedField" style="display: none;">
                <label>مبلغ الخصم</label>
                <input type="number" id="grantFixed" class="swal2-input" 
                       placeholder="المبلغ">
            </div>
            
            <div class="form-group mb-3">
                <label>عدد الأقساط</label>
                <input type="number" id="grantInstallments" class="swal2-input" 
                       value="6" min="1" max="24">
            </div>
            
            <div class="form-group mb-3">
                <label>الدفعة الأولى (%)</label>
                <input type="number" id="grantFirstPayment" class="swal2-input" 
                       value="20" min="0" max="100">
                <small>باقي المبلغ سيوزع على الأقساط المتبقية</small>
            </div>
        `,
        confirmButtonText: 'إضافة',
        showCancelButton: true,
        cancelButtonText: 'إلغاء',
        didOpen: () => {
            window.toggleGrantDiscountFields = function() {
                const type = document.getElementById('grantDiscountType').value;
                document.getElementById('grantPercentageField').style.display = 
                    type === 'percentage' ? 'block' : 'none';
                document.getElementById('grantFixedField').style.display = 
                    type === 'fixed' ? 'block' : 'none';
            };
        },
        preConfirm: () => {
            const plan = {
                id: 'grant_' + Date.now(),
                name: document.getElementById('grantName').value,
                discountType: document.getElementById('grantDiscountType').value,
                percentage: document.getElementById('grantDiscountType').value === 'percentage' 
                    ? parseInt(document.getElementById('grantPercentage').value) : 0,
                fixedAmount: document.getElementById('grantDiscountType').value === 'fixed' 
                    ? parseInt(document.getElementById('grantFixed').value) : 0,
                installments: parseInt(document.getElementById('grantInstallments').value),
                firstPayment: parseInt(document.getElementById('grantFirstPayment').value)
            };
            
            if (!plan.name) {
                Swal.showValidationMessage('يرجى إدخال اسم الخطة');
                return false;
            }
            
            return plan;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            if (!courseData.grantPlans) courseData.grantPlans = [];
            courseData.grantPlans.push(result.value);
            renderGrantPlans();
            updatePricePreview();
        }
    });
}

function removeGrantPlan(index) {
    courseData.grantPlans.splice(index, 1);
    renderGrantPlans();
    updatePricePreview();
}

function renderGrantPlans() {
    const container = document.getElementById('grantPlansList');
    if (!courseData.grantPlans || courseData.grantPlans.length === 0) {
        container.innerHTML = '<p class="text-muted">لا توجد خطط منح حالياً</p>';
        return;
    }
    
    container.innerHTML = courseData.grantPlans.map((plan, index) => `
        <div class="card mb-2">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5>${plan.name}</h5>
                        <p class="mb-0">
                            ${plan.discountType === 'percentage' 
                                ? `خصم ${plan.percentage}%` 
                                : `خصم ${plan.fixedAmount} ${courseData.currency}`}
                            - ${plan.installments} أقساط
                            - دفعة أولى ${plan.firstPayment}%
                        </p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeGrantPlan(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

// معاينة الأسعار المحسّنة
function updatePricePreview() {
    const basePrice = parseFloat(document.getElementById('price')?.value) || 0;
    const salePrice = parseFloat(document.getElementById('salePrice')?.value) || 0;
    const currency = document.getElementById('currency').value || 'EGP';
    const priceType = document.getElementById('priceType').value;
    
    if (priceType === 'free' || basePrice === 0) {
        document.getElementById('pricePreview').innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-info-circle"></i>
                <p>${priceType === 'free' ? 'الدورة مجانية' : 'أدخل سعر الدورة لعرض الجدول'}</p>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="pricing-table-modern">
            <h4 class="table-main-title">
                <i class="fas fa-calculator"></i> جدول الأسعار الشامل
            </h4>
    `;
    
    // السعر الأساسي
    const activePrice = salePrice > 0 ? salePrice : basePrice;
    html += `
        <div class="price-section">
            <h5 class="section-title">السعر الأساسي</h5>
            <div class="price-box">
                ${salePrice > 0 ? `
                    <div class="original-price">${formatPrice(basePrice, currency)}</div>
                    <div class="sale-price">${formatPrice(salePrice, currency)}</div>
                    <div class="discount-badge">خصم ${Math.round((1 - salePrice/basePrice) * 100)}%</div>
                ` : `
                    <div class="current-price">${formatPrice(basePrice, currency)}</div>
                `}
            </div>
        </div>
    `;
    
    // العروض الزمنية
    if (courseData.discounts && courseData.discounts.length > 0) {
        const validDiscounts = courseData.discounts.filter(d => d.name && (d.percentage >= 0));
        if (validDiscounts.length > 0) {
            html += `
                <div class="price-section">
                    <h5 class="section-title">العروض الزمنية</h5>
                    <div class="offers-grid">
            `;
            
            validDiscounts.forEach(discount => {
                const discountedPrice = activePrice * (1 - discount.percentage/100);
                html += `
                    <div class="offer-card">
                        <div class="offer-header">
                            <span class="offer-name">${discount.name}</span>
                            ${discount.percentage > 0 ? `<span class="offer-percentage">${discount.percentage}%</span>` : ''}
                        </div>
                        <div class="offer-price">${formatPrice(discountedPrice, currency)}</div>
                        ${discount.startDate && discount.endDate ? `
                            <div class="offer-dates">
                                من ${formatDate(discount.startDate)} إلى ${formatDate(discount.endDate)}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        }
    }
    
    // خصم الدفع الكامل
    const cashDiscountEnabled = document.getElementById('enableCashDiscount')?.checked;
    const cashDiscountPercent = parseInt(document.getElementById('cashDiscountPercent')?.value) || 0;
    
    if (cashDiscountEnabled && cashDiscountPercent > 0) {
        const cashPrice = activePrice * (1 - cashDiscountPercent/100);
        html += `
            <div class="price-section">
                <h5 class="section-title">خصم الدفع الكامل</h5>
                <div class="cash-discount-box">
                    <div class="cash-price">${formatPrice(cashPrice, currency)}</div>
                    <div class="cash-info">عند الدفع كاش دفعة واحدة (خصم ${cashDiscountPercent}%)</div>
                </div>
            </div>
        `;
    }
    
    // خطط التقسيط
    if (courseData.paymentPlans && courseData.paymentPlans.length > 0) {
        html += `
            <div class="price-section">
                <h5 class="section-title">خطط التقسيط</h5>
                <div class="installments-grid">
        `;
        
        courseData.paymentPlans.forEach(plan => {
            const installmentAmount = activePrice / plan.installments;
            html += `
                <div class="installment-card">
                    <div class="installment-name">${plan.name}</div>
                    <div class="installment-details">
                        ${plan.installments} × ${formatPrice(installmentAmount, currency)}
                    </div>
                    ${plan.frequency ? `<div class="installment-frequency">${getFrequencyText(plan.frequency)}</div>` : ''}
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    // عروض المجموعات
    if (courseData.groupDiscounts && courseData.groupDiscounts.length > 0) {
        html += `
            <div class="price-section">
                <h5 class="section-title">عروض المجموعات</h5>
                <div class="group-offers-grid">
        `;
        
        courseData.groupDiscounts.forEach(group => {
            const groupPrice = activePrice * (1 - group.percentage/100);
            html += `
                <div class="group-offer-card">
                    <div class="group-header">
                        <span class="group-name">${group.name || `مجموعة ${group.minSize}+ أشخاص`}</span>
                        <span class="group-discount">${group.percentage}%</span>
                    </div>
                    <div class="group-price">${formatPrice(groupPrice, currency)}</div>
                    <div class="group-condition">للمجموعات من ${group.minSize} أشخاص فأكثر</div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    // الكوبونات
    if (courseData.coupons && courseData.coupons.length > 0) {
        html += `
            <div class="price-section">
                <h5 class="section-title">كوبونات الخصم</h5>
                <div class="coupons-table">
                    <table>
                        <thead>
                            <tr>
                                <th>كود الكوبون</th>
                                <th>قيمة الخصم</th>
                                <th>السعر بعد الخصم</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        courseData.coupons.forEach(coupon => {
            let priceAfterCoupon;
            if (coupon.type === 'percentage') {
                priceAfterCoupon = activePrice * (1 - coupon.value/100);
            } else {
                priceAfterCoupon = Math.max(0, activePrice - coupon.value);
            }
            
            html += `
                <tr>
                    <td class="coupon-code">${coupon.code}</td>
                    <td>${coupon.type === 'percentage' ? `${coupon.value}%` : `${formatPrice(coupon.value, currency)}`}</td>
                    <td>${formatPrice(priceAfterCoupon, currency)}</td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    // برنامج المنح
    if (document.getElementById('enableGrants')?.checked && courseData.grantPlans && courseData.grantPlans.length > 0) {
        html += `
            <div class="price-section">
                <h5 class="section-title">برنامج المنح الدراسية</h5>
                <div class="grants-grid">
        `;
        
        courseData.grantPlans.forEach(plan => {
            let grantPrice;
            if (plan.discountType === 'percentage') {
                grantPrice = activePrice * (1 - plan.percentage/100);
            } else {
                grantPrice = Math.max(0, activePrice - plan.fixedAmount);
            }
            
            const firstPayment = grantPrice * plan.firstPayment / 100;
            const remainingAmount = grantPrice - firstPayment;
            const monthlyPayment = remainingAmount / (plan.installments - 1);
            
            html += `
                <div class="grant-card">
                    <div class="grant-header">
                        <span class="grant-name">${plan.name}</span>
                    </div>
                    <div class="grant-details">
                        <div class="grant-discount">
                            ${plan.discountType === 'percentage' 
                                ? `خصم ${plan.percentage}%` 
                                : `خصم ${formatPrice(plan.fixedAmount, currency)}`}
                        </div>
                        <div class="grant-total">السعر النهائي: ${formatPrice(grantPrice, currency)}</div>
                        <div class="grant-installments">
                            دفعة أولى: ${formatPrice(firstPayment, currency)}<br>
                            ثم ${plan.installments - 1} أقساط × ${formatPrice(monthlyPayment, currency)}
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    html += `</div>`;
    
    document.getElementById('pricePreview').innerHTML = html;
}

// دوال مساعدة
function formatPrice(price, currency = 'EGP') {
    // تطبيق التقريب التسويقي
    price = marketingRound(price);
    
    const formatted = price.toLocaleString('ar-EG');
    const symbols = {
        'EGP': 'ج.م',
        'SAR': 'ر.س',
        'USD': '$',
        'EUR': '€',
        'AED': 'د.إ'
    };
    return `${formatted} ${symbols[currency] || currency}`;
}

function marketingRound(price) {
    if (price < 100) return Math.round(price);
    if (price < 1000) return Math.round(price / 10) * 10 - 1; // 299, 399, etc
    if (price < 10000) return Math.round(price / 100) * 100 - 100; // 2900, 3900, etc
    return Math.round(price / 1000) * 1000 - 100; // 9900, 19900, etc
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const options = { day: 'numeric', month: 'long', year: 'numeric' };
    return date.toLocaleDateString('ar-EG', options);
}

function getFrequencyText(frequency) {
    const texts = {
        'monthly': 'شهرياً',
        'weekly': 'أسبوعياً',
        'custom': 'مخصص'
    };
    return texts[frequency] || frequency;
}

// متغير لتتبع التغييرات
let hasUnsavedChanges = false;

// دالة لتسجيل التغييرات
function markAsChanged() {
    hasUnsavedChanges = true;
    autoSave();
}
        // إصلاح مشكلة خطط الدفع
window.addPaymentPlan = function() {
    if (typeof Swal === 'undefined') {
        alert('مكتبة SweetAlert غير محملة. تأكد من تحميل الصفحة بالكامل.');
        return;
    }
    
    Swal.fire({
        title: 'إضافة خطة دفع جديدة',
        html: `
            <div class="form-group mb-3">
                <label>اسم الخطة</label>
                <input type="text" id="planName" class="swal2-input" 
                       placeholder="مثال: دفعتين شهريتين">
            </div>
            
            <div class="form-group mb-3">
                <label>عدد الدفعات</label>
                <input type="number" id="installments" class="swal2-input" 
                       value="2" min="2" max="12">
            </div>
            
            <div class="form-group mb-3">
                <label>التكرار</label>
                <select id="frequency" class="swal2-select">
                    <option value="monthly">شهري</option>
                    <option value="weekly">أسبوعي</option>
                    <option value="custom">مخصص</option>
                </select>
            </div>
        `,
        confirmButtonText: 'إضافة',
        showCancelButton: true,
        cancelButtonText: 'إلغاء',
        confirmButtonColor: '#6366f1',
        preConfirm: () => {
            const plan = {
                id: 'plan_' + Date.now(),
                name: document.getElementById('planName').value,
                installments: parseInt(document.getElementById('installments').value),
                frequency: document.getElementById('frequency').value
            };
            
            if (!plan.name) {
                Swal.showValidationMessage('يرجى إدخال اسم الخطة');
                return false;
            }
            
            return plan;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            if (!courseData.paymentPlans) courseData.paymentPlans = [];
            courseData.paymentPlans.push(result.value);
            renderPaymentPlans();
            updatePricePreview();
        }
    });
};

// إصلاح مشكلة خطط المنح
window.addGrantPlan = function() {
    if (typeof Swal === 'undefined') {
        alert('مكتبة SweetAlert غير محملة. تأكد من تحميل الصفحة بالكامل.');
        return;
    }
    
    Swal.fire({
        title: 'إضافة خطة منحة',
        html: `
            <div class="form-group mb-3">
                <label>اسم الخطة</label>
                <input type="text" id="grantName" class="swal2-input" 
                       placeholder="مثال: منحة الطلاب المتفوقين">
            </div>
            
            <div class="form-group mb-3">
                <label>نوع الخصم</label>
                <select id="grantDiscountType" class="swal2-select" onchange="toggleGrantDiscountFields()">
                    <option value="percentage">نسبة مئوية</option>
                    <option value="fixed">مبلغ ثابت</option>
                </select>
            </div>
            
            <div class="form-group mb-3" id="grantPercentageField">
                <label>نسبة الخصم (%)</label>
                <input type="number" id="grantPercentage" class="swal2-input" 
                       value="50" min="0" max="100">
            </div>
            
            <div class="form-group mb-3" id="grantFixedField" style="display: none;">
                <label>مبلغ الخصم</label>
                <input type="number" id="grantFixed" class="swal2-input" 
                       placeholder="المبلغ">
            </div>
            
            <div class="form-group mb-3">
                <label>عدد الأقساط</label>
                <input type="number" id="grantInstallments" class="swal2-input" 
                       value="6" min="1" max="24">
            </div>
            
            <div class="form-group mb-3">
                <label>الدفعة الأولى (%)</label>
                <input type="number" id="grantFirstPayment" class="swal2-input" 
                       value="20" min="0" max="100">
                <small>باقي المبلغ سيوزع على الأقساط المتبقية</small>
            </div>
        `,
        confirmButtonText: 'إضافة',
        showCancelButton: true,
        cancelButtonText: 'إلغاء',
        confirmButtonColor: '#6366f1',
        didOpen: () => {
            window.toggleGrantDiscountFields = function() {
                const type = document.getElementById('grantDiscountType').value;
                document.getElementById('grantPercentageField').style.display = 
                    type === 'percentage' ? 'block' : 'none';
                document.getElementById('grantFixedField').style.display = 
                    type === 'fixed' ? 'block' : 'none';
            };
        },
        preConfirm: () => {
            const plan = {
                id: 'grant_' + Date.now(),
                name: document.getElementById('grantName').value,
                discountType: document.getElementById('grantDiscountType').value,
                percentage: document.getElementById('grantDiscountType').value === 'percentage' 
                    ? parseInt(document.getElementById('grantPercentage').value) : 0,
                fixedAmount: document.getElementById('grantDiscountType').value === 'fixed' 
                    ? parseInt(document.getElementById('grantFixed').value) : 0,
                installments: parseInt(document.getElementById('grantInstallments').value),
                firstPayment: parseInt(document.getElementById('grantFirstPayment').value)
            };
            
            if (!plan.name) {
                Swal.showValidationMessage('يرجى إدخال اسم الخطة');
                return false;
            }
            
            if (plan.discountType === 'percentage' && (!plan.percentage || plan.percentage === 0)) {
                Swal.showValidationMessage('يرجى إدخال نسبة الخصم');
                return false;
            }
            
            if (plan.discountType === 'fixed' && (!plan.fixedAmount || plan.fixedAmount === 0)) {
                Swal.showValidationMessage('يرجى إدخال مبلغ الخصم');
                return false;
            }
            
            return plan;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            if (!courseData.grantPlans) courseData.grantPlans = [];
            courseData.grantPlans.push(result.value);
            renderGrantPlans();
            updatePricePreview();
        }
    });
};

// تأكد من تحميل Swal عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    // انتظر ثانية للتأكد من تحميل كل المكتبات
    setTimeout(function() {
        if (typeof Swal === 'undefined') {
            console.error('SweetAlert2 لم يتم تحميله بشكل صحيح');
            // حاول تحميله مرة أخرى
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11';
            script.onload = function() {
                console.log('تم تحميل SweetAlert2 بنجاح');
            };
            document.head.appendChild(script);
        }
    }, 1000);
});

// تحذير قبل مغادرة الصفحة
window.addEventListener('beforeunload', (e) => {
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'لديك تغييرات غير محفوظة. هل تريد المغادرة؟';
    }
});

// نظام debug
const DEBUG_MODE = true;

function debugLog(...args) {
    if (DEBUG_MODE) {
        console.log('[Course Builder]', new Date().toLocaleTimeString(), ...args);
    }
}
    
    </script>
</body>
</html>
