<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منشئ الدورات الاحترافي - منظور الفؤاد</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 for better modals -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Sortable JS for drag & drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <style>
        :root {
            --primary: #f4c430;
            --primary-dark: #e6b429;
            --secondary: #2196f3;
            --success: #4caf50;
            --danger: #ff4444;
            --warning: #ff9800;
            --dark: #1a1a1a;
            --darker: #0f0f0f;
            --light: #2a2a2a;
            --lighter: #3a3a3a;
            --text: #e0e0e0;
            --text-muted: #999;
            --border: rgba(255, 255, 255, 0.1);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Kufi Arabic', sans-serif;
            background: var(--darker);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--lighter);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* Main Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .app-header {
            height: 70px;
            background: var(--dark);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 2rem;
            gap: 2rem;
            flex-shrink: 0;
        }

        .header-back {
            width: 40px;
            height: 40px;
            background: var(--lighter);
            border: none;
            border-radius: 10px;
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .header-back:hover {
            background: var(--primary);
            color: var(--dark);
            transform: translateX(3px);
        }

        .header-title {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .course-title-edit {
            background: transparent;
            border: 2px solid transparent;
            color: var(--primary);
            font-size: 1.3rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            min-width: 300px;
            transition: var(--transition);
        }

        .course-title-edit:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(244, 196, 48, 0.1);
        }

        .save-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .save-indicator.saving {
            color: var(--warning);
        }

        .save-indicator.saved {
            color: var(--success);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.7rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: inherit;
        }

        .btn-secondary {
            background: var(--lighter);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--dark);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(244, 196, 48, 0.4);
        }

        /* Main Content */
        .app-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Steps Navigation */
        .steps-nav {
            width: 250px;
            background: var(--dark);
            border-left: 1px solid var(--border);
            padding: 2rem 1.5rem;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .steps-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 1.5rem;
        }

        .step-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .step-item::before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: transparent;
            border-radius: 3px;
            transition: var(--transition);
        }

        .step-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .step-item.active {
            background: rgba(244, 196, 48, 0.1);
        }

        .step-item.active::before {
            background: var(--primary);
        }

        .step-item.completed .step-number {
            background: var(--success);
            color: white;
        }

        .step-number {
            width: 35px;
            height: 35px;
            background: var(--lighter);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .step-content {
            flex: 1;
        }

        .step-name {
            font-weight: 500;
            margin-bottom: 0.2rem;
        }

        .step-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Main Panel */
        .main-panel {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background: var(--darker);
        }

        .panel-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Step Panels */
        .step-panel {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .step-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .panel-header {
            margin-bottom: 2rem;
        }

        .panel-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .panel-subtitle {
            color: var(--text-muted);
            font-size: 1rem;
        }

        /* Form Elements */
        .form-section {
            background: var(--dark);
            padding: 2rem;
            border-radius: var(--radius);
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        .form-hint {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.3rem;
        }

        .form-control {
            width: 100%;
            padding: 0.9rem 1.2rem;
            background: var(--lighter);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
            transition: var(--transition);
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(244, 196, 48, 0.05);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        select.form-control {
            cursor: pointer;
        }

        /* Rich Text Editor */
        .editor-container {
            background: var(--lighter);
            border-radius: 8px;
            overflow: hidden;
        }

        .ql-toolbar {
            background: var(--light);
            border: none !important;
            border-bottom: 1px solid var(--border) !important;
        }

        .ql-container {
            border: none !important;
            font-family: inherit;
            font-size: 1rem;
            color: var(--text);
        }

        .ql-editor {
            min-height: 200px;
            padding: 1.5rem;
        }

        /* Image Upload */
        .image-upload {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(244, 196, 48, 0.02);
            position: relative;
            overflow: hidden;
        }

        .image-upload:hover {
            border-color: var(--primary);
            background: rgba(244, 196, 48, 0.05);
        }

        .image-upload.has-image {
            padding: 0;
            height: 250px;
        }

        .image-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition);
        }

        .image-upload:hover .upload-overlay {
            opacity: 1;
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        /* Pricing Options */
        .pricing-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .price-option {
            padding: 1.5rem;
            background: var(--lighter);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .price-option:hover {
            border-color: var(--primary);
        }

        .price-option.active {
            border-color: var(--primary);
            background: rgba(244, 196, 48, 0.1);
        }

        .price-option-icon {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .price-option-name {
            font-weight: 500;
            margin-bottom: 0.3rem;
        }

        .price-option-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Curriculum Builder */
        .curriculum-builder {
            background: var(--dark);
            border-radius: var(--radius);
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .modules-list {
            margin-bottom: 1rem;
        }

        .module-item {
            background: var(--lighter);
            border-radius: 10px;
            margin-bottom: 1rem;
            overflow: hidden;
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .module-header {
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: move;
            background: var(--light);
        }

        .module-header:hover {
            background: rgba(244, 196, 48, 0.05);
        }

        .drag-handle {
            color: var(--text-muted);
            cursor: move;
        }

        .module-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .module-number {
            width: 35px;
            height: 35px;
            background: var(--primary);
            color: var(--dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .module-title-input {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 1rem;
            font-weight: 500;
            flex: 1;
            padding: 0.3rem;
            border-radius: 6px;
            transition: var(--transition);
        }

        .module-title-input:focus {
            outline: none;
            background: var(--lighter);
            padding: 0.3rem 0.8rem;
        }

        .module-actions {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            width: 35px;
            height: 35px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 8px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: var(--lighter);
            color: var(--text);
        }

        .icon-btn.danger:hover {
            background: rgba(255, 68, 68, 0.1);
            color: var(--danger);
        }

        .module-content {
            padding: 1.5rem;
            display: none;
        }

        .module-item.expanded .module-content {
            display: block;
        }

        .module-item.expanded .fa-chevron-down {
            transform: rotate(180deg);
        }

        .lessons-list {
            margin-bottom: 1rem;
        }

        .lesson-item {
            background: var(--dark);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border);
        }

        .lesson-item:hover {
            border-color: var(--primary);
            transform: translateX(-5px);
        }

        .lesson-type-icon {
            width: 40px;
            height: 40px;
            background: rgba(244, 196, 48, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }

        .lesson-info {
            flex: 1;
        }

        .lesson-title {
            font-weight: 500;
            margin-bottom: 0.3rem;
        }

        .lesson-meta {
            font-size: 0.85rem;
            color: var(--text-muted);
            display: flex;
            gap: 1rem;
        }

        .add-content-btn {
            width: 100%;
            padding: 1rem;
            background: transparent;
            border: 2px dashed var(--primary);
            border-radius: 8px;
            color: var(--primary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 500;
            font-family: inherit;
        }

        .add-content-btn:hover {
            background: rgba(244, 196, 48, 0.1);
            border-style: solid;
        }

        /* Content Type Selector */
        .content-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
            background: var(--dark);
            border-radius: var(--radius);
        }

        .content-type-card {
            padding: 1.5rem;
            background: var(--lighter);
            border: 2px solid var(--border);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .content-type-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            background: rgba(244, 196, 48, 0.1);
        }

        .content-type-icon {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 0.8rem;
        }

        .content-type-name {
            font-weight: 500;
            margin-bottom: 0.3rem;
        }

        .content-type-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Modal Styles */
        .swal2-popup {
            background: var(--dark) !important;
            color: var(--text) !important;
            border: 1px solid var(--border) !important;
        }

        .swal2-title {
            color: var(--primary) !important;
        }

        .swal2-input,
        .swal2-textarea {
            background: var(--lighter) !important;
            color: var(--text) !important;
            border: 1px solid var(--border) !important;
        }

        .swal2-confirm {
            background: var(--primary) !important;
            color: var(--dark) !important;
        }

        .swal2-cancel {
            background: var(--lighter) !important;
            color: var(--text) !important;
        }

        /* Progress Bar */
        .progress-container {
            margin-bottom: 2rem;
        }

        .progress-bar {
            height: 8px;
            background: var(--lighter);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            width: 0%;
            transition: width 0.5s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4rem;
            color: var(--text-muted);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--lighter);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 4rem;
            color: var(--lighter);
            margin-bottom: 1rem;
        }

        .empty-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .steps-nav {
                position: fixed;
                right: -250px;
                top: 70px;
                bottom: 0;
                z-index: 1000;
                transition: right 0.3s;
            }

            .steps-nav.active {
                right: 0;
            }

            .main-panel {
                padding: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .app-header {
                padding: 0 1rem;
            }

            .course-title-edit {
                min-width: 150px;
                font-size: 1.1rem;
            }

            .header-actions {
                gap: 0.5rem;
            }

            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }

            .panel-title {
                font-size: 1.5rem;
            }

            .form-section {
                padding: 1.5rem;
            }

            .content-types {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Toggle Switch */
        .toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toggle {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--lighter);
            border-radius: 13px;
            cursor: pointer;
            transition: var(--transition);
        }

        .toggle input {
            display: none;
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: var(--text-muted);
            border-radius: 50%;
            transition: var(--transition);
        }

        .toggle input:checked + .toggle-slider {
            transform: translateX(24px);
            background: var(--primary);
        }

        .toggle input:checked ~ .toggle {
            background: rgba(244, 196, 48, 0.2);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            font-family: inherit;
            font-weight: 500;
        }

        .tab:hover {
            color: var(--text);
        }

        .tab.active {
            color: var(--primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        /* Coupon Section */
        .coupon-list {
            margin-bottom: 1rem;
        }

        .coupon-item {
            background: var(--lighter);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .coupon-code {
            font-family: monospace;
            background: var(--dark);
            padding: 0.3rem 0.8rem;
            border-radius: 6px;
            margin-left: 0.5rem;
        }

        .coupon-discount {
            color: var(--success);
            font-weight: 600;
        }

        /* Student Access */
        .access-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .access-card {
            background: var(--lighter);
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            border: 2px solid var(--border);
            transition: var(--transition);
            cursor: pointer;
        }

        .access-card:hover {
            border-color: var(--primary);
        }

        .access-card.selected {
            border-color: var(--primary);
            background: rgba(244, 196, 48, 0.1);
        }

        .access-icon {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .access-title {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .access-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <button class="header-back" onclick="goBack()" title="العودة للوحة التحكم">
                <i class="fas fa-arrow-right"></i>
            </button>
            
            <div class="header-title">
                <input type="text" 
                       class="course-title-edit" 
                       id="courseTitle"
                       placeholder="اسم الدورة..." 
                       value="دورة جديدة">
                
                <div class="save-indicator" id="saveIndicator">
                    <i class="fas fa-check-circle"></i>
                    <span>تم الحفظ</span>
                </div>
            </div>
            
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="previewCourse()">
                    <i class="fas fa-eye"></i>
                    <span>معاينة</span>
                </button>
                
                <button class="btn btn-primary" onclick="publishCourse()">
                    <i class="fas fa-rocket"></i>
                    <span>نشر الدورة</span>
                </button>
            </div>
        </header>

        <div class="app-content">
            <!-- Steps Navigation -->
            <nav class="steps-nav" id="stepsNav">
                <h3 class="steps-title">خطوات إنشاء الدورة</h3>
                
                <div class="step-item active" onclick="showStep(1)" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <div class="step-name">المعلومات الأساسية</div>
                        <div class="step-desc">العنوان والوصف</div>
                    </div>
                </div>
                
                <div class="step-item" onclick="showStep(2)" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <div class="step-name">التسعير والوصول</div>
                        <div class="step-desc">السعر والخصومات</div>
                    </div>
                </div>
                
                <div class="step-item" onclick="showStep(3)" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <div class="step-name">بناء المنهج</div>
                        <div class="step-desc">الوحدات والدروس</div>
                    </div>
                </div>
                
                <div class="step-item" onclick="showStep(4)" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <div class="step-name">إعدادات الطلاب</div>
                        <div class="step-desc">الشهادات والتقدم</div>
                    </div>
                </div>
                
                <div class="step-item" onclick="showStep(5)" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-content">
                        <div class="step-name">النشر والتسويق</div>
                        <div class="step-desc">صفحة الهبوط</div>
                    </div>
                </div>
            </nav>

            <!-- Main Panel -->
            <main class="main-panel">
                <div class="panel-container">
                    <!-- Progress -->
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressBar" style="width: 20%;"></div>
                        </div>
                        <div class="progress-text">اكتمل <span id="progressPercent">20</span>% من إعداد الدورة</div>
                    </div>

                    <!-- Step 1: Basic Info -->
                    <div class="step-panel active" id="step1">
                        <div class="panel-header">
                            <h1 class="panel-title">المعلومات الأساسية للدورة</h1>
                            <p class="panel-subtitle">أضف المعلومات الأساسية التي ستظهر للطلاب</p>
                        </div>

                        <div class="form-section">
                            <div class="form-group">
                                <label class="form-label">عنوان الدورة</label>
                                <input type="text" class="form-control" id="courseTitleMain" placeholder="مثال: رحلة اكتشاف الذات بمنظور الفؤاد">
                                <div class="form-hint">اختر عنواناً جذاباً وواضحاً يعبر عن محتوى الدورة</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">الوصف المختصر</label>
                                <textarea class="form-control" rows="3" placeholder="وصف موجز للدورة يظهر في نتائج البحث..."></textarea>
                                <div class="form-hint">150-200 حرف كحد أقصى</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">الوصف التفصيلي</label>
                                <div class="editor-container">
                                    <div id="descriptionEditor"></div>
                                </div>
                                <div class="form-hint">اشرح بالتفصيل ما ستقدمه في الدورة ولماذا يجب على الطلاب الالتحاق بها</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">صورة الدورة</label>
                                <div class="image-upload" id="courseImageUpload" onclick="uploadCourseImage()">
                                    <div class="upload-content">
                                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                        <div>اسحب الصورة هنا أو انقر للاختيار</div>
                                        <div class="form-hint">1920x1080 بكسل - JPG أو PNG</div>
                                    </div>
                                    <div class="upload-overlay">
                                        <button class="btn btn-primary">تغيير الصورة</button>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">فيديو تعريفي (اختياري)</label>
                                <input type="url" class="form-control" placeholder="رابط YouTube أو Vimeo">
                                <div class="form-hint">فيديو قصير (2-5 دقائق) يعرّف بالدورة</div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3 style="margin-bottom: 1.5rem; color: var(--primary);">
                                <i class="fas fa-bullseye"></i> الأهداف التعليمية
                            </h3>
                            
                            <div id="learningObjectives">
                                <div class="form-group">
                                    <input type="text" class="form-control" placeholder="سيتمكن الطالب من...">
                                </div>
                            </div>
                            
                            <button class="btn btn-secondary" onclick="addObjective()">
                                <i class="fas fa-plus"></i> إضافة هدف
                            </button>
                        </div>

                        <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                            <button class="btn btn-primary" onclick="saveAndNext(1)">
                                حفظ والمتابعة <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Pricing -->
                    <div class="step-panel" id="step2">
                        <div class="panel-header">
                            <h1 class="panel-title">التسعير والوصول</h1>
                            <p class="panel-subtitle">حدد كيف سيصل الطلاب لدورتك</p>
                        </div>

                        <div class="form-section">
                            <h3 style="margin-bottom: 1.5rem; color: var(--primary);">
                                <i class="fas fa-tag"></i> نوع الدورة
                            </h3>
                            
                            <div class="pricing-options">
                                <div class="price-option active" onclick="selectPriceType('free')">
                                    <i class="fas fa-gift price-option-icon"></i>
                                    <div class="price-option-name">مجانية</div>
                                    <div class="price-option-desc">متاحة للجميع</div>
                                </div>
                                
                                <div class="price-option" onclick="selectPriceType('paid')">
                                    <i class="fas fa-dollar-sign price-option-icon"></i>
                                    <div class="price-option-name">مدفوعة</div>
                                    <div class="price-option-desc">بسعر محدد</div>
                                </div>
                                
                                <div class="price-option" onclick="selectPriceType('subscription')">
                                    <i class="fas fa-sync price-option-icon"></i>
                                    <div class="price-option-name">اشتراك</div>
                                    <div class="price-option-desc">ضمن الباقة</div>
                                </div>
                            </div>

                            <div id="pricingDetails" style="display: none;">
                                <div class="form-group">
                                    <label class="form-label">السعر (ريال سعودي)</label>
                                    <input type="number" class="form-control" placeholder="0.00" min="0" step="0.01">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">سعر العرض (اختياري)</label>
                                    <input type="number" class="form-control" placeholder="0.00" min="0" step="0.01">
                                    <div class="form-hint">السعر بعد الخصم - اتركه فارغاً إذا لم يكن هناك عرض</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3 style="margin-bottom: 1.5rem; color: var(--primary);">
                                <i class="fas fa-ticket-alt"></i> كوبونات الخصم
                            </h3>
                            
                            <div class="coupon-list" id="couponList">
                                <!-- Coupons will be added here -->
                            </div>
                            
                            <button class="btn btn-secondary" onclick="addCoupon()">
                                <i class="fas fa-plus"></i> إضافة كوبون
                            </button>
                        </div>

                        <div class="form-section">
                            <h3 style="margin-bottom: 1.5rem; color: var(--primary);">
                                <i class="fas fa-users"></i> إعدادات الوصول
                            </h3>
                            
                            <div class="form-group">
                                <label class="form-label">عدد الطلاب المسموح</label>
                                <input type="number" class="form-control" placeholder="غير محدود" min="1">
                                <div class="form-hint">اتركه فارغاً لعدد غير محدود</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">تاريخ البدء</label>
                                <input type="date" class="form-control">
                            </div>

                            <div class="form-group">
                                <label class="form-label">تاريخ الانتهاء</label>
                                <input type="date" class="form-control">
                                <div class="form-hint">اتركه فارغاً للوصول الدائم</div>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: space-between; margin-top: 2rem;">
                            <button class="btn btn-secondary" onclick="showStep(1)">
                                <i class="fas fa-arrow-right"></i> السابق
                            </button>
                            <button class="btn btn-primary" onclick="saveAndNext(2)">
                                حفظ والمتابعة <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 3: Curriculum -->
                    <div class="step-panel" id="step3">
                        <div class="panel-header">
                            <h1 class="panel-title">بناء منهج الدورة</h1>
                            <p class="panel-subtitle">قسّم المحتوى إلى وحدات ودروس منظمة</p>
                        </div>

                        <div class="curriculum-builder">
                            <div class="modules-list" id="modulesList">
                                <!-- Modules will be added here -->
                            </div>
                            
                            <button class="add-content-btn" onclick="addModule()">
                                <i class="fas fa-folder-plus"></i>
                                إضافة وحدة جديدة
                            </button>
                        </div>

                        <div style="display: flex; justify-content: space-between; margin-top: 2rem;">
                            <button class="btn btn-secondary" onclick="showStep(2)">
                                <i class="fas fa-arrow-right"></i> السابق
                            </button>
                            <button class="btn btn-primary" onclick="saveAndNext(3)">
                                حفظ والمتابعة <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 4: Student Settings -->
                    <div class="step-panel" id="step4">
                        <div class="panel-header">
                            <h1 class="panel-title">إعدادات الطلاب</h1>
                            <p class="panel-subtitle">حدد كيف سيتفاعل الطلاب مع الدورة</p>
                        </div>

                        <div class="form-section">
                            <h3 style="margin-bottom: 1.5rem; color: var(--primary);">
                                <i class="fas fa-certificate"></i> الشهادات
                            </h3>
                            
                            <div class="form-group">
                                <div class="toggle-wrapper">
                                    <span>منح شهادة عند إتمام الدورة</span>
                                    <label class="toggle">
                                        <input type="checkbox" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">نسبة الإتمام المطلوبة</label>
                                <input type="number" class="form-control" value="80" min="50" max="100">
                                <div class="form-hint">النسبة المئوية المطلوبة للحصول على الشهادة</div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3 style="margin-bottom: 1.5rem; color: var(--primary);">
                                <i class="fas fa-hourglass-half"></i> إعدادات التقدم
                            </h3>
                            
                            <div class="access-grid">
                                <div class="access-card selected" onclick="selectAccessType('sequential')">
                                    <i class="fas fa-list-ol access-icon"></i>
                                    <div class="access-title">تسلسلي</div>
                                    <div class="access-desc">يجب إكمال الدروس بالترتيب</div>
                                </div>
                                
                                <div class="access-card" onclick="selectAccessType('free')">
                                    <i class="fas fa-random access-icon"></i>
                                    <div class="access-title">حر</div>
                                    <div class="access-desc">يمكن الوصول لأي درس</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3 style="margin-bottom: 1.5rem; color: var(--primary);">
                                <i class="fas fa-comments"></i> التفاعل والمناقشات
                            </h3>
                            
                            <div class="form-group">
                                <div class="toggle-wrapper">
                                    <span>السماح بالتعليقات على الدروس</span>
                                    <label class="toggle">
                                        <input type="checkbox" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="toggle-wrapper">
                                    <span>منتدى نقاش خاص بالدورة</span>
                                    <label class="toggle">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: space-between; margin-top: 2rem;">
                            <button class="btn btn-secondary" onclick="showStep(3)">
                                <i class="fas fa-arrow-right"></i> السابق
                            </button>
                            <button class="btn btn-primary" onclick="saveAndNext(4)">
                                حفظ والمتابعة <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 5: Publishing -->
                    <div class="step-panel" id="step5">
                        <div class="panel-header">
                            <h1 class="panel-title">النشر والتسويق</h1>
                            <p class="panel-subtitle">جهّز دورتك للنشر</p>
                        </div>

                        <div class="form-section">
                            <h3 style="margin-bottom: 1.5rem; color: var(--primary);">
                                <i class="fas fa-search"></i> تحسين محركات البحث
                            </h3>
                            
                            <div class="form-group">
                                <label class="form-label">العنوان في محركات البحث</label>
                                <input type="text" class="form-control" placeholder="سيتم استخدام عنوان الدورة">
                                <div class="form-hint">60 حرف كحد أقصى</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">الوصف في محركات البحث</label>
                                <textarea class="form-control" rows="2" placeholder="سيتم استخدام الوصف المختصر"></textarea>
                                <div class="form-hint">160 حرف كحد أقصى</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">الكلمات المفتاحية</label>
                                <input type="text" class="form-control" placeholder="كلمة1، كلمة2، كلمة3">
                                <div class="form-hint">افصل بين الكلمات بفاصلة</div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3 style="margin-bottom: 1.5rem; color: var(--primary);">
                                <i class="fas fa-share-alt"></i> خيارات المشاركة
                            </h3>
                            
                            <div class="form-group">
                                <div class="toggle-wrapper">
                                    <span>السماح بمشاركة الدورة على وسائل التواصل</span>
                                    <label class="toggle">
                                        <input type="checkbox" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="toggle-wrapper">
                                    <span>إظهار في صفحة الدورات العامة</span>
                                    <label class="toggle">
                                        <input type="checkbox" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-section" style="text-align: center; padding: 3rem;">
                            <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--success); margin-bottom: 1rem;"></i>
                            <h2 style="color: var(--primary); margin-bottom: 1rem;">دورتك جاهزة للنشر!</h2>
                            <p style="color: var(--text-muted); margin-bottom: 2rem;">
                                راجع جميع المعلومات قبل النشر. يمكنك دائماً تعديل الدورة لاحقاً.
                            </p>
                            
                            <div style="display: flex; gap: 1rem; justify-content: center;">
                                <button class="btn btn-secondary" onclick="saveDraft()">
                                    <i class="fas fa-save"></i> حفظ كمسودة
                                </button>
                                <button class="btn btn-primary" onclick="publishCourse()">
                                    <i class="fas fa-rocket"></i> نشر الدورة الآن
                                </button>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: space-between; margin-top: 2rem;">
                            <button class="btn btn-secondary" onclick="showStep(4)">
                                <i class="fas fa-arrow-right"></i> السابق
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="../js/firebase-config.js"></script>
    
    <script>
        // حماية الصفحة
        window.firebaseAuth.protectAdminPage();

        // Global Variables
        let courseData = {
            id: null,
            title: 'دورة جديدة',
            description: '',
            detailedDescription: '',
            objectives: [],
            thumbnail: null,
            introVideo: '',
            priceType: 'free',
            price: 0,
            salePrice: null,
            coupons: [],
            maxStudents: null,
            startDate: null,
            endDate: null,
            modules: [],
            certificate: true,
            certificateThreshold: 80,
            accessType: 'sequential',
            allowComments: true,
            hasForum: false,
            seoTitle: '',
            seoDescription: '',
            keywords: [],
            isPublic: true,
            allowSharing: true,
            status: 'draft',
            progress: 20
        };

        let currentStep = 1;
        let quillEditor = null;
        let autoSaveTimeout = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeEditor();
            loadCourseData();
            initializeSortable();
            updateProgress();
            
            // Sync title inputs
            document.getElementById('courseTitle').addEventListener('input', function(e) {
                courseData.title = e.target.value;
                document.getElementById('courseTitleMain').value = e.target.value;
                autoSave();
            });
            
            document.getElementById('courseTitleMain').addEventListener('input', function(e) {
                courseData.title = e.target.value;
                document.getElementById('courseTitle').value = e.target.value;
                autoSave();
            });
        });

        // Initialize Quill Editor
        function initializeEditor() {
            quillEditor = new Quill('#descriptionEditor', {
                theme: 'snow',
                placeholder: 'اكتب وصفاً تفصيلياً للدورة...',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'align': [] }],
                        ['link', 'image'],
                        ['clean']
                    ]
                }
            });
            
            quillEditor.on('text-change', function() {
                courseData.detailedDescription = quillEditor.root.innerHTML;
                autoSave();
            });
        }

        // Step Navigation
        function showStep(stepNumber) {
            // Update active step in nav
            document.querySelectorAll('.step-item').forEach(item => {
                item.classList.remove('active');
                if (parseInt(item.dataset.step) === stepNumber) {
                    item.classList.add('active');
                }
                if (parseInt(item.dataset.step) < stepNumber) {
                    item.classList.add('completed');
                }
            });
            
            // Show corresponding panel
            document.querySelectorAll('.step-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(`step${stepNumber}`).classList.add('active');
            
            currentStep = stepNumber;
            
            // Scroll to top
            document.querySelector('.main-panel').scrollTop = 0;
        }

        function saveAndNext(currentStepNum) {
            // Save current step data
            saveStepData(currentStepNum);
            
            // Show success
            Swal.fire({
                icon: 'success',
                title: 'تم الحفظ',
                text: 'تم حفظ البيانات بنجاح',
                timer: 1500,
                showConfirmButton: false
            });
            
            // Move to next step
            if (currentStepNum < 5) {
                showStep(currentStepNum + 1);
            }
            
            updateProgress();
        }

        function saveStepData(step) {
            switch(step) {
                case 1:
                    // Basic info is already being saved via auto-save
                    break;
                case 2:
                    // Save pricing data
                    // Already handled by event listeners
                    break;
                case 3:
                    // Save curriculum
                    // Already handled by module functions
                    break;
                case 4:
                    // Save student settings
                    // Already handled by toggles
                    break;
                case 5:
                    // Save publishing settings
                    // Already handled
                    break;
            }
            
            saveCourseData();
        }

        // Auto Save
        function autoSave() {
            clearTimeout(autoSaveTimeout);
            
            const saveIndicator = document.getElementById('saveIndicator');
            saveIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>جاري الحفظ...</span>';
            saveIndicator.classList.add('saving');
            
            autoSaveTimeout = setTimeout(() => {
                saveCourseData().then(() => {
                    saveIndicator.innerHTML = '<i class="fas fa-check-circle"></i> <span>تم الحفظ</span>';
                    saveIndicator.classList.remove('saving');
                    saveIndicator.classList.add('saved');
                    
                    setTimeout(() => {
                        saveIndicator.classList.remove('saved');
                    }, 3000);
                });
            }, 1000);
        }

        // Save to Firestore
        async function saveCourseData() {
            const db = firebase.firestore();
            
            try {
                if (courseData.id) {
                    await db.collection('courses').doc(courseData.id).update({
                        ...courseData,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    const docRef = await db.collection('courses').add({
                        ...courseData,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    courseData.id = docRef.id;
                }
            } catch (error) {
                console.error('Error saving course:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'حدث خطأ في حفظ البيانات'
                });
            }
        }

        // Load Course Data
        async function loadCourseData() {
            const urlParams = new URLSearchParams(window.location.search);
            const courseId = urlParams.get('id');
            
            if (courseId) {
                const db = firebase.firestore();
                const doc = await db.collection('courses').doc(courseId).get();
                
                if (doc.exists) {
                    courseData = { id: doc.id, ...doc.data() };
                    
                    // Update UI
                    document.getElementById('courseTitle').value = courseData.title;
                    document.getElementById('courseTitleMain').value = courseData.title;
                    
                    if (courseData.detailedDescription) {
                        quillEditor.root.innerHTML = courseData.detailedDescription;
                    }
                    
                    // Load modules
                    courseData.modules.forEach(module => {
                        renderModule(module);
                    });
                    
                    updateProgress();
                }
            }
        }

        // Learning Objectives
        function addObjective() {
            const container = document.getElementById('learningObjectives');
            const newObjective = document.createElement('div');
            newObjective.className = 'form-group';
            newObjective.innerHTML = `
                <input type="text" class="form-control" placeholder="سيتمكن الطالب من..." onchange="updateObjectives()">
            `;
            container.appendChild(newObjective);
        }

        function updateObjectives() {
            const objectives = [];
            document.querySelectorAll('#learningObjectives input').forEach(input => {
                if (input.value.trim()) {
                    objectives.push(input.value.trim());
                }
            });
            courseData.objectives = objectives;
            autoSave();
        }

        // Image Upload
        function uploadCourseImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = handleImageUpload;
            input.click();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const uploadDiv = document.getElementById('courseImageUpload');
                uploadDiv.classList.add('has-image');
                uploadDiv.innerHTML = `
                    <img src="${e.target.result}" alt="Course thumbnail">
                    <div class="upload-overlay">
                        <button class="btn btn-primary" onclick="uploadCourseImage()">تغيير الصورة</button>
                    </div>
                `;
                
                courseData.thumbnail = e.target.result;
                autoSave();
            };
            reader.readAsDataURL(file);
        }

        // Pricing
        function selectPriceType(type) {
            document.querySelectorAll('.price-option').forEach(option => {
                option.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            courseData.priceType = type;
            
            const pricingDetails = document.getElementById('pricingDetails');
            if (type === 'paid') {
                pricingDetails.style.display = 'block';
            } else {
                pricingDetails.style.display = 'none';
                courseData.price = 0;
                courseData.salePrice = null;
            }
            
            autoSave();
        }

        // Coupons
        function addCoupon() {
            Swal.fire({
                title: 'إضافة كوبون خصم',
                html: `
                    <div style="text-align: right;">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem;">كود الكوبون</label>
                            <input id="couponCode" class="swal2-input" placeholder="مثال: SAVE20" style="direction: ltr;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem;">نسبة الخصم (%)</label>
                            <input id="couponDiscount" type="number" class="swal2-input" placeholder="20" min="1" max="100">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem;">عدد مرات الاستخدام</label>
                            <input id="couponLimit" type="number" class="swal2-input" placeholder="غير محدود" min="1">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem;">تاريخ الانتهاء</label>
                            <input id="couponExpiry" type="date" class="swal2-input">
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'إضافة',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#f4c430',
                preConfirm: () => {
                    const code = document.getElementById('couponCode').value;
                    const discount = document.getElementById('couponDiscount').value;
                    
                    if (!code || !discount) {
                        Swal.showValidationMessage('يرجى إدخال الكود ونسبة الخصم');
                        return false;
                    }
                    
                    return {
                        code: code.toUpperCase(),
                        discount: parseInt(discount),
                        limit: document.getElementById('couponLimit').value || null,
                        expiry: document.getElementById('couponExpiry').value || null
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    courseData.coupons.push(result.value);
                    renderCoupons();
                    autoSave();
                }
            });
        }

        function renderCoupons() {
            const couponList = document.getElementById('couponList');
            couponList.innerHTML = courseData.coupons.map((coupon, index) => `
                <div class="coupon-item">
                    <div>
                        <span>كود:</span>
                        <span class="coupon-code">${coupon.code}</span>
                        <span class="coupon-discount">${coupon.discount}% خصم</span>
                    </div>
                    <button class="icon-btn danger" onclick="removeCoupon(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeCoupon(index) {
            courseData.coupons.splice(index, 1);
            renderCoupons();
            autoSave();
        }

        // Curriculum Builder
        function addModule() {
            const moduleId = Date.now();
            const moduleNumber = courseData.modules.length + 1;
            const module = {
                id: moduleId,
                title: `الوحدة ${moduleNumber}`,
                lessons: [],
                expanded: true
            };
            
            courseData.modules.push(module);
            renderModule(module);
            updateProgress();
            autoSave();
        }

        function renderModule(module) {
            const modulesList = document.getElementById('modulesList');
            const moduleElement = document.createElement('div');
            moduleElement.className = 'module-item' + (module.expanded ? ' expanded' : '');
            moduleElement.dataset.moduleId = module.id;
            
            moduleElement.innerHTML = `
                <div class="module-header">
                    <i class="fas fa-grip-vertical drag-handle"></i>
                    <div class="module-info">
                        <div class="module-number">${courseData.modules.indexOf(module) + 1}</div>
                        <input type="text" 
                               class="module-title-input" 
                               value="${module.title}" 
                               onchange="updateModuleTitle(${module.id}, this.value)"
                               placeholder="اسم الوحدة">
                    </div>
                    <div class="module-actions">
                        <button class="icon-btn" onclick="toggleModule(${module.id})" title="إظهار/إخفاء">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <button class="icon-btn danger" onclick="deleteModule(${module.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="module-content">
                    <div class="lessons-list" id="lessons-${module.id}">
                        ${module.lessons.map(lesson => renderLessonHTML(lesson, module.id)).join('')}
                    </div>
                    <button class="add-content-btn" onclick="showContentTypes(${module.id})">
                        <i class="fas fa-plus"></i>
                        إضافة محتوى
                    </button>
                </div>
            `;
            
            modulesList.appendChild(moduleElement);
            
            // Initialize sortable for lessons
            new Sortable(document.getElementById(`lessons-${module.id}`), {
                animation: 150,
                handle: '.lesson-item',
                ghostClass: 'dragging',
                onEnd: function() {
                    updateLessonsOrder(module.id);
                    autoSave();
                }
            });
        }

        function renderLessonHTML(lesson, moduleId) {
            const iconMap = {
                video: 'fa-video',
                text: 'fa-file-alt',
                quiz: 'fa-question-circle',
                assignment: 'fa-tasks',
                resource: 'fa-download',
                live: 'fa-broadcast-tower'
            };
            
            return `
                <div class="lesson-item" data-lesson-id="${lesson.id}" onclick="editLesson(${moduleId}, ${lesson.id})">
                    <div class="lesson-type-icon">
                        <i class="fas ${iconMap[lesson.type] || 'fa-file'}"></i>
                    </div>
                    <div class="lesson-info">
                        <div class="lesson-title">${lesson.title}</div>
                        <div class="lesson-meta">
                            <span><i class="far fa-clock"></i> ${lesson.duration || '0'} دقيقة</span>
                            <span>${getLessonTypeLabel(lesson.type)}</span>
                        </div>
                    </div>
                    <div class="module-actions" onclick="event.stopPropagation()">
                        <button class="icon-btn danger" onclick="deleteLesson(${moduleId}, ${lesson.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function getLessonTypeLabel(type) {
            const labels = {
                video: 'فيديو',
                text: 'نص',
                quiz: 'اختبار',
                assignment: 'مهمة',
                resource: 'مورد',
                live: 'جلسة حية'
            };
            return labels[type] || 'درس';
        }

        function showContentTypes(moduleId) {
            Swal.fire({
                title: 'اختر نوع المحتوى',
                html: `
                    <div class="content-types">
                        <div class="content-type-card" onclick="addLesson(${moduleId}, 'video')">
                            <i class="fas fa-video content-type-icon"></i>
                            <div class="content-type-name">فيديو</div>
                            <div class="content-type-desc">درس فيديو</div>
                        </div>
                        <div class="content-type-card" onclick="addLesson(${moduleId}, 'text')">
                            <i class="fas fa-file-alt content-type-icon"></i>
                            <div class="content-type-name">نص</div>
                            <div class="content-type-desc">محتوى مكتوب</div>
                        </div>
                        <div class="content-type-card" onclick="addLesson(${moduleId}, 'quiz')">
                            <i class="fas fa-question-circle content-type-icon"></i>
                            <div class="content-type-name">اختبار</div>
                            <div class="content-type-desc">أسئلة تفاعلية</div>
                        </div>
                        <div class="content-type-card" onclick="addLesson(${moduleId}, 'assignment')">
                            <i class="fas fa-tasks content-type-icon"></i>
                            <div class="content-type-name">مهمة</div>
                            <div class="content-type-desc">واجب عملي</div>
                        </div>
                        <div class="content-type-card" onclick="addLesson(${moduleId}, 'resource')">
                            <i class="fas fa-download content-type-icon"></i>
                            <div class="content-type-name">مورد</div>
                            <div class="content-type-desc">ملفات للتحميل</div>
                        </div>
                        <div class="content-type-card" onclick="addLesson(${moduleId}, 'live')">
                            <i class="fas fa-broadcast-tower content-type-icon"></i>
                            <div class="content-type-name">جلسة حية</div>
                            <div class="content-type-desc">بث مباشر</div>
                        </div>
                    </div>
                `,
                showConfirmButton: false,
                width: '600px'
            });
        }

        function addLesson(moduleId, type) {
            Swal.close();
            
            const lessonId = Date.now();
            const lesson = {
                id: lessonId,
                type: type,
                title: `${getLessonTypeLabel(type)} جديد`,
                content: '',
                duration: 0
            };
            
            // Show lesson editor
            showLessonEditor(moduleId, lesson, true);
        }

        function editLesson(moduleId, lessonId) {
            const module = courseData.modules.find(m => m.id === moduleId);
            const lesson = module.lessons.find(l => l.id === lessonId);
            
            if (lesson) {
                showLessonEditor(moduleId, lesson, false);
            }
        }

        function showLessonEditor(moduleId, lesson, isNew = false) {
            let editorContent = '';
            
            switch(lesson.type) {
                case 'video':
                    editorContent = `
                        <div class="form-group">
                            <label class="form-label">عنوان الدرس</label>
                            <input type="text" id="lessonTitle" class="form-control" value="${lesson.title}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">رابط الفيديو</label>
                            <input type="url" id="videoUrl" class="form-control" placeholder="YouTube, Vimeo, أو رابط مباشر" value="${lesson.videoUrl || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">مدة الفيديو (بالدقائق)</label>
                            <input type="number" id="lessonDuration" class="form-control" value="${lesson.duration || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">وصف الدرس</label>
                            <textarea id="lessonDescription" class="form-control" rows="3">${lesson.description || ''}</textarea>
                        </div>
                    `;
                    break;
                    
                case 'text':
                    editorContent = `
                        <div class="form-group">
                            <label class="form-label">عنوان الدرس</label>
                            <input type="text" id="lessonTitle" class="form-control" value="${lesson.title}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">محتوى الدرس</label>
                            <div id="lessonContentEditor" style="height: 300px; background: var(--lighter); border-radius: 8px;"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">وقت القراءة المتوقع (بالدقائق)</label>
                            <input type="number" id="lessonDuration" class="form-control" value="${lesson.duration || ''}">
                        </div>
                    `;
                    break;
                    
                case 'quiz':
                    editorContent = `
                        <div class="form-group">
                            <label class="form-label">عنوان الاختبار</label>
                            <input type="text" id="lessonTitle" class="form-control" value="${lesson.title}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">عدد المحاولات المسموحة</label>
                            <input type="number" id="quizAttempts" class="form-control" value="${lesson.attempts || 3}" min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">درجة النجاح (%)</label>
                            <input type="number" id="passingGrade" class="form-control" value="${lesson.passingGrade || 60}" min="0" max="100">
                        </div>
                        <div style="text-align: center; padding: 2rem; background: var(--lighter); border-radius: 8px;">
                            <i class="fas fa-question-circle" style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>
                            <p>محرر الأسئلة المتقدم قادم قريباً!</p>
                        </div>
                    `;
                    break;
                    
                case 'resource':
                    editorContent = `
                        <div class="form-group">
                            <label class="form-label">عنوان المورد</label>
                            <input type="text" id="lessonTitle" class="form-control" value="${lesson.title}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">الملفات</label>
                            <div class="image-upload" onclick="uploadResourceFiles()">
                                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                <div>اسحب الملفات هنا أو انقر للاختيار</div>
                                <div class="form-hint">PDF, DOC, PPT, ZIP</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">وصف المورد</label>
                            <textarea id="lessonDescription" class="form-control" rows="3">${lesson.description || ''}</textarea>
                        </div>
                    `;
                    break;
                    
                case 'assignment':
                    editorContent = `
                        <div class="form-group">
                            <label class="form-label">عنوان المهمة</label>
                            <input type="text" id="lessonTitle" class="form-control" value="${lesson.title}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">تعليمات المهمة</label>
                            <div id="lessonContentEditor" style="height: 200px; background: var(--lighter); border-radius: 8px;"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">الوقت المتوقع للإنجاز (بالدقائق)</label>
                            <input type="number" id="lessonDuration" class="form-control" value="${lesson.duration || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">نوع التسليم</label>
                            <select id="submissionType" class="form-control">
                                <option value="text">نص</option>
                                <option value="file">ملف</option>
                                <option value="link">رابط</option>
                            </select>
                        </div>
                    `;
                    break;
                    
                case 'live':
                    editorContent = `
                        <div class="form-group">
                            <label class="form-label">عنوان الجلسة</label>
                            <input type="text" id="lessonTitle" class="form-control" value="${lesson.title}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">تاريخ الجلسة</label>
                            <input type="datetime-local" id="sessionDate" class="form-control" value="${lesson.sessionDate || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">مدة الجلسة (بالدقائق)</label>
                            <input type="number" id="lessonDuration" class="form-control" value="${lesson.duration || 60}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">رابط الجلسة</label>
                            <input type="url" id="sessionLink" class="form-control" placeholder="Zoom, Google Meet, etc." value="${lesson.sessionLink || ''}">
                        </div>
                    `;
                    break;
            }
            
            Swal.fire({
                title: isNew ? 'إضافة محتوى جديد' : 'تعديل المحتوى',
                html: editorContent,
                width: '700px',
                showCancelButton: true,
                confirmButtonText: isNew ? 'إضافة' : 'حفظ',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#f4c430',
                didOpen: () => {
                    // Initialize Quill for text content
                    if (lesson.type === 'text' || lesson.type === 'assignment') {
                        const container = document.getElementById('lessonContentEditor');
                        if (container) {
                            const tempEditor = new Quill(container, {
                                theme: 'snow',
                                placeholder: 'اكتب المحتوى هنا...',
                                modules: {
                                    toolbar: [
                                        ['bold', 'italic', 'underline'],
                                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                        ['link', 'image'],
                                        ['clean']
                                    ]
                                }
                            });
                            
                            if (lesson.content) {
                                tempEditor.root.innerHTML = lesson.content;
                            }
                            
                            // Store editor reference
                            window.tempLessonEditor = tempEditor;
                        }
                    }
                },
                preConfirm: () => {
                    const title = document.getElementById('lessonTitle').value;
                    if (!title) {
                        Swal.showValidationMessage('يرجى إدخال عنوان المحتوى');
                        return false;
                    }
                    
                    const updatedLesson = {
                        ...lesson,
                        title: title,
                        duration: parseInt(document.getElementById('lessonDuration')?.value || 0)
                    };
                    
                    // Get type-specific data
                    switch(lesson.type) {
                        case 'video':
                            updatedLesson.videoUrl = document.getElementById('videoUrl').value;
                            updatedLesson.description = document.getElementById('lessonDescription').value;
                            break;
                            
                        case 'text':
                        case 'assignment':
                            if (window.tempLessonEditor) {
                                updatedLesson.content = window.tempLessonEditor.root.innerHTML;
                            }
                            if (lesson.type === 'assignment') {
                                updatedLesson.submissionType = document.getElementById('submissionType').value;
                            }
                            break;
                            
                        case 'quiz':
                            updatedLesson.attempts = parseInt(document.getElementById('quizAttempts').value);
                            updatedLesson.passingGrade = parseInt(document.getElementById('passingGrade').value);
                            break;
                            
                        case 'resource':
                            updatedLesson.description = document.getElementById('lessonDescription').value;
                            break;
                            
                        case 'live':
                            updatedLesson.sessionDate = document.getElementById('sessionDate').value;
                            updatedLesson.sessionLink = document.getElementById('sessionLink').value;
                            break;
                    }
                    
                    return updatedLesson;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const module = courseData.modules.find(m => m.id === moduleId);
                    
                    if (isNew) {
                        module.lessons.push(result.value);
                    } else {
                        const index = module.lessons.findIndex(l => l.id === lesson.id);
                        module.lessons[index] = result.value;
                    }
                    
                    // Re-render lessons
                    const lessonsContainer = document.getElementById(`lessons-${moduleId}`);
                    lessonsContainer.innerHTML = module.lessons.map(l => renderLessonHTML(l, moduleId)).join('');
                    
                    updateProgress();
                    autoSave();
                    
                    // Clean up temp editor
                    delete window.tempLessonEditor;
                }
            });
        }

        function updateModuleTitle(moduleId, title) {
            const module = courseData.modules.find(m => m.id === moduleId);
            if (module) {
                module.title = title;
                autoSave();
            }
        }

        function toggleModule(moduleId) {
            const moduleElement = document.querySelector(`[data-module-id="${moduleId}"]`);
            const module = courseData.modules.find(m => m.id === moduleId);
            
            if (module) {
                module.expanded = !module.expanded;
                moduleElement.classList.toggle('expanded');
            }
        }

        function deleteModule(moduleId) {
            Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذه الوحدة وجميع دروسها؟',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'حذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#ff4444'
            }).then((result) => {
                if (result.isConfirmed) {
                    courseData.modules = courseData.modules.filter(m => m.id !== moduleId);
                    document.querySelector(`[data-module-id="${moduleId}"]`).remove();
                    
                    // Update module numbers
                    updateModuleNumbers();
                    updateProgress();
                    autoSave();
                }
            });
        }

        function deleteLesson(moduleId, lessonId) {
            Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا المحتوى؟',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'حذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#ff4444'
            }).then((result) => {
                if (result.isConfirmed) {
                    const module = courseData.modules.find(m => m.id === moduleId);
                    if (module) {
                        module.lessons = module.lessons.filter(l => l.id !== lessonId);
                        document.querySelector(`[data-lesson-id="${lessonId}"]`).remove();
                        updateProgress();
                        autoSave();
                    }
                }
            });
        }

        function updateModuleNumbers() {
            document.querySelectorAll('.module-item').forEach((element, index) => {
                element.querySelector('.module-number').textContent = index + 1;
            });
        }

        function updateLessonsOrder(moduleId) {
            const module = courseData.modules.find(m => m.id === moduleId);
            if (!module) return;
            
            const lessonElements = document.querySelectorAll(`#lessons-${moduleId} .lesson-item`);
            const newOrder = [];
            
            lessonElements.forEach(element => {
                const lessonId = parseInt(element.dataset.lessonId);
                const lesson = module.lessons.find(l => l.id === lessonId);
                if (lesson) {
                    newOrder.push(lesson);
                }
            });
            
            module.lessons = newOrder;
        }

        // Initialize Sortable
        function initializeSortable() {
            const modulesList = document.getElementById('modulesList');
            if (modulesList) {
                new Sortable(modulesList, {
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'dragging',
                    onEnd: function() {
                        updateModulesOrder();
                        autoSave();
                    }
                });
            }
        }

        function updateModulesOrder() {
            const moduleElements = document.querySelectorAll('.module-item');
            const newOrder = [];
            
            moduleElements.forEach((element, index) => {
                const moduleId = parseInt(element.dataset.moduleId);
                const module = courseData.modules.find(m => m.id === moduleId);
                if (module) {
                    newOrder.push(module);
                }
            });
            
            courseData.modules = newOrder;
            updateModuleNumbers();
        }

        // Student Settings
        function selectAccessType(type) {
            document.querySelectorAll('.access-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            courseData.accessType = type;
            autoSave();
        }

        // Progress
        function updateProgress() {
            let completedSteps = 0;
            const totalSteps = 20;
            
            // Basic info (4 steps)
            if (courseData.title && courseData.title !== 'دورة جديدة') completedSteps++;
            if (courseData.description) completedSteps++;
            if (courseData.detailedDescription) completedSteps++;
            if (courseData.objectives.length > 0) completedSteps++;
            
            // Pricing (3 steps)
            if (courseData.priceType) completedSteps++;
            if (courseData.priceType === 'free' || courseData.price > 0) completedSteps++;
            if (courseData.coupons.length > 0) completedSteps++;
            
            // Curriculum (8 steps)
            if (courseData.modules.length > 0) completedSteps += 2;
            if (courseData.modules.length >= 3) completedSteps += 2;
            
            let totalLessons = 0;
            courseData.modules.forEach(module => {
                totalLessons += module.lessons.length;
            });
            
            if (totalLessons > 0) completedSteps += 2;
            if (totalLessons >= 5) completedSteps += 2;
            
            // Student settings (3 steps)
            if (courseData.certificate !== undefined) completedSteps++;
            if (courseData.certificateThreshold) completedSteps++;
            if (courseData.accessType) completedSteps++;
            
            // Publishing (2 steps)
            if (courseData.seoTitle || courseData.title) completedSteps++;
            if (courseData.keywords.length > 0 || courseData.seoDescription) completedSteps++;
            
            const progress = Math.round((completedSteps / totalSteps) * 100);
            courseData.progress = progress;
            
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressPercent').textContent = progress;
        }

        // Preview
        function previewCourse() {
            // Open in new tab
            const previewUrl = `/preview-course.html?id=${courseData.id || 'draft'}`;
            window.open(previewUrl, '_blank');
        }

        // Publishing
        function publishCourse() {
            if (courseData.progress < 60) {
                Swal.fire({
                    icon: 'warning',
                    title: 'الدورة غير مكتملة',
                    text: 'يجب إكمال 60% على الأقل من محتوى الدورة قبل النشر',
                    confirmButtonColor: '#f4c430'
                });
                return;
            }
            
            Swal.fire({
                title: 'نشر الدورة',
                text: 'هل أنت متأكد من نشر الدورة؟ سيتمكن الطلاب من الوصول إليها',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'نشر الآن',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#f4c430'
            }).then((result) => {
                if (result.isConfirmed) {
                    courseData.status = 'published';
                    courseData.publishedAt = new Date().toISOString();
                    
                    saveCourseData().then(() => {
                        Swal.fire({
                            icon: 'success',
                            title: 'تم النشر بنجاح!',
                            text: 'دورتك متاحة الآن للطلاب',
                            confirmButtonColor: '#f4c430'
                        }).then(() => {
                            window.location.href = './dashboard.html';
                        });
                    });
                }
            });
        }

        function saveDraft() {
            courseData.status = 'draft';
            saveCourseData().then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'تم الحفظ',
                    text: 'تم حفظ الدورة كمسودة',
                    timer: 1500,
                    showConfirmButton: false
                });
            });
        }

        // Navigation
        function goBack() {
            Swal.fire({
                title: 'هل تريد المغادرة؟',
                text: 'سيتم حفظ جميع التغييرات تلقائياً',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'مغادرة',
                cancelButtonText: 'البقاء',
                confirmButtonColor: '#f4c430'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = './dashboard.html';
                }
            });
        }

        // Upload placeholder functions
        function uploadResourceFiles() {
            Swal.fire({
                icon: 'info',
                title: 'قادم قريباً',
                text: 'ميزة رفع الملفات ستكون متاحة قريباً',
                confirmButtonColor: '#f4c430'
            });
        }

        // Mobile menu toggle
        function toggleStepsNav() {
            document.getElementById('stepsNav').classList.toggle('active');
        }

        // Add mobile menu button for small screens
        if (window.innerWidth <= 1024) {
            const mobileMenuBtn = document.createElement('button');
            mobileMenuBtn.className = 'btn btn-secondary';
            mobileMenuBtn.style.position = 'fixed';
            mobileMenuBtn.style.bottom = '20px';
            mobileMenuBtn.style.left = '20px';
            mobileMenuBtn.style.zIndex = '1001';
            mobileMenuBtn.innerHTML = '<i class="fas fa-list"></i>';
            mobileMenuBtn.onclick = toggleStepsNav;
            document.body.appendChild(mobileMenuBtn);
        }
    </script>
</body>
</html>

