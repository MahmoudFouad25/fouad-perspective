<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>احسب استثمارك - منصة فؤاد</title>
    
    <!-- Dependencies -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --gold-primary: #FFD700;
            --gold-light: #FFF3CD;
            --gold-dark: #D4AF37;
            --dark-bg: #0A1628;
            --dark-lighter: #1E3A5F;
            --dark-card: #152238;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: var(--dark-bg);
            color: white;
            padding-top: 60px;
        }
        
        /* Header بسيط */
        .page-header {
            background: linear-gradient(135deg, var(--dark-card), var(--dark-lighter));
            padding: 40px 0;
            text-align: center;
            margin-bottom: 50px;
        }
        
        .page-header h1 {
            font-size: 2.5rem;
            color: var(--gold-primary);
            font-weight: bold;
        }
        
        /* CSS الحاسبة الذكية فقط */
        .smart-calculator-section {
            padding: 80px 0;
            background: var(--dark-lighter);
        }
        
        .calculator-wrapper {
            background: var(--dark-card);
            border-radius: 30px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        /* باقي CSS الحاسبة كما هو */
        /* ... */
        
        /* Footer بسيط */
        .simple-footer {
            background: var(--dark-card);
            padding: 30px 0;
            text-align: center;
            margin-top: 100px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="page-header">
        <div class="container">
            <h1>احسب استثمارك في رحلة التعلم</h1>
            <p>اختر الخطة المناسبة لك بكل سهولة</p>
        </div>
    </div>

    <!-- الحاسبة الذكية -->
    <section class="smart-calculator-section" id="smartCalculator">
        <!-- نفس كود الحاسبة بالضبط -->
    </section>

    <!-- Footer -->
    <footer class="simple-footer">
        <div class="container">
            <p>© 2024 منصة فؤاد - جميع الحقوق محفوظة</p>
        </div>
    </footer>

    <script>
        // Firebase config
   const firebaseConfig = {
            apiKey: "AIzaSyDHg0VrivE3C9A7jvzRu7lQgudLvcD_Fxk",
            authDomain: "fouad-perspective.firebaseapp.com",
            projectId: "fouad-perspective",
            storageBucket: "fouad-perspective.appspot.com",
            messagingSenderId: "564654107574",
            appId: "1:564654107574:web:baebb660288b22f16213e6"
        };
        // معالج الأخطاء العام
// معالج أخطاء شامل
window.addEventListener('error', function(event) {
    // تجاهل أخطاء favicon
    if (event.message && event.message.includes('favicon')) {
        event.preventDefault();
        return false;
    }
    console.warn('خطأ تم معالجته:', event.error);
});
        // تحسين الأداء - Lazy Loading
document.addEventListener('DOMContentLoaded', function() {
    // تحميل الصور بشكل تدريجي
    const lazyImages = document.querySelectorAll('img[data-src]');
    const imageObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
                imageObserver.unobserve(img);
            }
        });
    });
    
    lazyImages.forEach(img => imageObserver.observe(img));
    
    // تنظيف Console
    console.clear();
    console.log('%c🎉 مرحباً بك في منصة فؤاد!', 
                'color: #FFD700; font-size: 20px; font-weight: bold;');
    console.log('%c💡 استثمر في رحلتك نحو النور', 
                'color: #22C55E; font-size: 16px;');
});

// التحقق من Firebase قبل الاستخدام
function initializeFirebaseSafely() {
    try {
        // تأكد من وجود Firebase
        if (typeof firebase === 'undefined') {
            console.log('Firebase غير محمل - استخدام البيانات الافتراضية');
            showFallbackContent();
            return false;
        }
        
        // تهيئة Firebase مع معالجة الأخطاء
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        window.db = firebase.firestore();
        
        // تعيين مهلة للاتصال
        db.enablePersistence({ synchronizeTabs: true })
            .catch(err => {
                console.log('تم تشغيل الوضع الافتراضي');
                showFallbackContent();
            });
            
        return true;
    } catch (error) {
        console.log('خطأ في Firebase - استخدام البيانات الافتراضية');
        showFallbackContent();
        return false;
    }
}
        
        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // متغيرات عامة
        let courseData = null;
        let courseId = null;
        // استرجاع اسم الدورة من التخزين المحلي
window.courseName = localStorage.getItem('currentCourseName') || 'الدورة التدريبية';

        // جلب معرف الدورة من الرابط
        function getCourseId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('course') || 'default-course';
        }
        // انتظار تحميل الصفحة بالكامل
document.addEventListener('DOMContentLoaded', function() {
    console.log('الصفحة جاهزة');
        cleanConsole();

    // تأخير بسيط للتأكد من تحميل Firebase
    setTimeout(() => {
        if (typeof db !== 'undefined') {
            loadCourseData();
        } else {
            console.error('Firebase لم يتم تحميله');
            showFallbackContent();
        }
    }, 1000);
});
        function cleanConsole() {
    // إزالة console.log غير الضرورية
    const originalLog = console.log;
    console.log = function(...args) {
        // تصفية الرسائل غير المهمة
        const message = args.join(' ');
        if (!message.includes('undefined') && 
            !message.includes('null') &&
            !message.includes('V3')) {
            originalLog.apply(console, args);
        }
    };
}
        
        // Course data loading
async function loadCourseData() {
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('course');
    
    if (!courseId) {
        console.log('معرف الدورة مفقود - استخدام البيانات الافتراضية');
        showFallbackContent();
        return;
    }
    
    try {
        // انتظار Firebase
        if (typeof db === 'undefined') {
            console.log('انتظار تحميل Firebase...');
            setTimeout(() => loadCourseData(), 500);
            return;
        }
        
        console.log('جاري جلب بيانات الدورة:', courseId);
        const courseRef = db.collection('courses').doc(courseId);
        const doc = await courseRef.get();
        
        if (!doc.exists) {
            console.log('الدورة غير موجودة - استخدام البيانات الافتراضية');
            showFallbackContent();
            return;
        }
        
        const courseData = doc.data();
        console.log('البيانات المستلمة:', courseData);
        
        // تصحيح الأسعار إذا كانت خاطئة
        if (courseData.price < 100) {
            courseData.price = courseData.price * 1000;
        }
        if (courseData.salePrice && courseData.salePrice < 100) {
            courseData.salePrice = courseData.salePrice * 1000;
        }
        
        window.currentCourseData = courseData;
        // حفظ اسم الدورة بشكل منفصل
window.courseName = courseData.title || 'الدورة التدريبية';
localStorage.setItem('currentCourseName', window.courseName);
console.log('📚 تم حفظ اسم الدورة:', window.courseName);

        console.log('بيانات الكورس من Firebase:', courseData);
console.log('الكوبونات في Firebase:', courseData.coupons);

        // تحديث كل شيء
        updatePageWithData(courseData);
        
    } catch (error) {
        console.error('خطأ في جلب البيانات:', error);
        showFallbackContent();
    }
   
}            // نفس الكود
        }
        
        // Smart Calculator object
        const smartCalculator = {
    restoreFromStorage() {
    const saved = localStorage.getItem('calculatorState');
    if (saved) {
        try {
            const state = JSON.parse(saved);
            // استعادة الحالة
            this.selectedJourney = state.journey || 'individual';
            this.selectedGroup = state.group || null;
            this.selectedGift = state.gift || 'specific';
            this.appliedCoupon = state.coupon || null;
            
            console.log('تم استعادة الحالة المحفوظة');
            return true;
        } catch (e) {
            console.error('خطأ في استعادة البيانات');
        }
    }
    return false;
},

    // دالة جديدة لاستعادة واجهة الكوبون
restoreCouponUI() {
    if (this.appliedCoupon) {
        console.log('استعادة كود الخصم:', this.appliedCoupon.code);
        
        const couponInput = document.getElementById('calcCoupon');
        const applyBtn = document.getElementById('applyCouponCalc');
        const couponSection = document.querySelector('.coupon-section');
        
        if (couponInput && applyBtn && couponSection) {
            // إظهار الكود في الحقل
            couponInput.value = this.appliedCoupon.code;
            couponInput.disabled = true;
            couponInput.style.background = '#22C55E20';
            couponInput.style.borderColor = '#22C55E';
            
            // إخفاء زر التطبيق
            applyBtn.style.display = 'none';
            
            // إضافة زر الإزالة إن لم يكن موجود
            if (!document.querySelector('.coupon-remove-btn')) {
                const removeBtn = document.createElement('button');
                removeBtn.className = 'coupon-remove-btn';
                removeBtn.innerHTML = '<i class="fas fa-times"></i> إزالة الكود';
                removeBtn.style.cssText = `
                    background: #E11D48;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 10px;
                    cursor: pointer;
                    margin-right: 10px;
                    transition: all 0.3s;
                `;
                removeBtn.onclick = () => this.removeCoupon();
                
                // إضافة الزر بجانب حقل الكود
                couponInput.parentElement.appendChild(removeBtn);
            }
            
            // إضافة رسالة نجاح
            const messageDiv = document.getElementById('calcCouponMessage');
            if (messageDiv) {
                messageDiv.innerHTML = `
                    <div style="background: rgba(34,197,94,0.1); 
                                border: 1px solid #22C55E; 
                                padding: 10px; 
                                border-radius: 8px; 
                                color: #22C55E;
                                margin-top: 10px;">
                        <i class="fas fa-check-circle"></i>
                        كود الخصم <strong>${this.appliedCoupon.code}</strong> مُفعّل
                        ${this.appliedCoupon.type === 'percentage' ? 
                          `(خصم ${this.appliedCoupon.value}%)` : 
                          `(خصم ${this.appliedCoupon.value} ج.م)`}
                    </div>
                `;
            }
        }
        
        // إعادة الحساب
        this.calculate();
    }
},

saveToStorage() {
    const state = {
        journey: this.selectedJourney,
        group: this.selectedGroup,
        gift: this.selectedGift,
        coupon: this.appliedCoupon,
        lastCalculation: this.lastCalculationState
    };
    localStorage.setItem('calculatorState', JSON.stringify(state));
},
    courseData: null,
    selectedJourney: 'individual',
    selectedGroup: null,
    selectedGift: 'specific',
    appliedCoupon: null,
    
  init() {
    console.log('تهيئة الحاسبة الذكية V3');
    
    // محاولة استعادة الحالة المحفوظة
    this.restoreFromStorage();
    
    this.bindEvents();
    this.updateFromFirebase();
    
    // استعادة كود الخصم إن وجد
    setTimeout(() => {
        this.restoreCouponUI();
    }, 1000);
    
    // حفظ الحالة عند كل تغيير
    setInterval(() => {
        this.saveToStorage();
    }, 1000);
    
    // التأكد من ظهور زر الدعم للرحلة الفردية
    setTimeout(() => {
        if (this.selectedJourney === 'individual') {
            document.getElementById('calcGrantBtn').style.display = 'block';
            document.getElementById('calcSupportMessage').style.display = 'block';
        }
    }, 500);
},
    
    bindEvents() {
        // اختيار نوع الرحلة
        document.querySelectorAll('.journey-option').forEach(option => {
            option.addEventListener('click', (e) => {
                document.querySelectorAll('.journey-option').forEach(o => o.classList.remove('active'));
                option.classList.add('active');
                this.handleJourneyChange(option.dataset.journey);
            });
        });
        
        // اختيار نوع الإهداء
        document.querySelectorAll('.gift-option-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.gift-option-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                this.handleGiftTypeChange(card.dataset.gift);
            });
        });
        
        // تغيير قيمة القسيمة
        const voucherInput = document.getElementById('voucherAmount');
        if (voucherInput) {
            voucherInput.addEventListener('input', () => this.calculate());
        }
        
        // تطبيق الكوبون
        const applyCouponBtn = document.getElementById('applyCouponCalc');
        if (applyCouponBtn) {
            applyCouponBtn.addEventListener('click', () => this.applyCoupon());
        }
        
        // زر الإجراء الرئيسي
        const bookBtn = document.getElementById('calcBookBtn');
        if (bookBtn) {
            bookBtn.addEventListener('click', () => this.handleMainAction());
        }
        
        // زر طلب الدعم
        // معالجة زر طلب الدعم
// معالجة زر طلب الدعم - نسخة Firebase
const grantBtn = document.getElementById('calcGrantBtn');
if (grantBtn) {
    grantBtn.onclick = async function() {
        const courseName = window.courseName || window.currentCourseData?.title || 'الدورة';
        const basePrice = document.getElementById('calcBase')?.innerText || 'غير محدد';
        
        Swal.fire({
            title: '🤲 طلب دعم لرحلة التعلم',
            html: `
                <div style="text-align: right; direction: rtl;">
                    <!-- معلومات الدورة -->
                    <div style="background: linear-gradient(135deg, #FFD700, #FFA500); 
                                padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #0A1628; margin: 0;">
                            <i class="fas fa-book"></i> ${courseName}
                        </h4>
                        <p style="color: #152238; margin: 5px 0;">
                            السعر الأساسي: <strong>${basePrice}</strong>
                        </p>
                    </div>
                    
                    <p style="margin-bottom: 20px; color: #64748b; font-size: 1.1rem;">
                        نؤمن أن المال لا يجب أن يكون عائقاً أمام رحلة التعلم
                    </p>
                    
                    <!-- خيارات الدعم -->
                    <div style="background: #F0FDF4; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #22C55E; margin-bottom: 15px;">
                            <i class="fas fa-heart"></i> خيارات الدعم المتاحة
                        </h4>
                        <ul style="text-align: right; list-style: none; padding: 0;">
                            <li style="margin: 10px 0; padding: 10px; background: white; border-radius: 8px;">
                                ✅ <strong>منحة جزئية:</strong> خصم يصل إلى 75%
                            </li>
                            <li style="margin: 10px 0; padding: 10px; background: white; border-radius: 8px;">
                                ✅ <strong>منحة كاملة:</strong> للحالات الأكثر احتياجاً
                            </li>
                            <li style="margin: 10px 0; padding: 10px; background: white; border-radius: 8px;">
                                ✅ <strong>تقسيط ميسر:</strong> حتى 24 شهر بدون فوائد
                            </li>
                        </ul>
                    </div>
                    
                    <!-- نموذج طلب الدعم -->
                    <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #E5E7EB;">
                        <h4 style="color: #0A1628; margin-bottom: 15px;">
                            <i class="fas fa-user"></i> بياناتك
                        </h4>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">
                                الاسم الكامل <span style="color: red;">*</span>
                            </label>
                            <input type="text" id="grantName" placeholder="أدخل اسمك الثلاثي"
                                   style="width: 100%; padding: 10px; border: 2px solid #E5E7EB; 
                                          border-radius: 8px; font-size: 1rem;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">
                                رقم الواتساب <span style="color: red;">*</span>
                            </label>
                            <input type="text" id="grantPhone" placeholder="01xxxxxxxxx"
                                   style="width: 100%; padding: 10px; border: 2px solid #E5E7EB; 
                                          border-radius: 8px; font-size: 1rem; direction: ltr;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">
                                نوع الدعم المطلوب <span style="color: red;">*</span>
                            </label>
                            <select id="grantType" 
                                    style="width: 100%; padding: 10px; border: 2px solid #E5E7EB; 
                                           border-radius: 8px; font-size: 1rem;">
                                <option value="">-- اختر نوع الدعم --</option>
                                <option value="partial">منحة جزئية (خصم 50-75%)</option>
                                <option value="full">منحة كاملة (100%)</option>
                                <option value="installment">تقسيط ميسر</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #374151;">
                                سبب طلب الدعم
                            </label>
                            <textarea id="grantReason" rows="3" 
                                      placeholder="اشرح باختصار سبب احتياجك للدعم (اختياري)"
                                      style="width: 100%; padding: 10px; border: 2px solid #E5E7EB; 
                                             border-radius: 8px; font-size: 1rem; resize: none;"></textarea>
                        </div>
                    </div>
                    
                    <div style="background: #FEF2F2; padding: 15px; border-radius: 10px; margin-top: 20px;">
                        <p style="color: #991B1B; margin: 0; text-align: center;">
                            <i class="fas fa-info-circle"></i>
                            سيتم التواصل معك خلال 24 ساعة لمناقشة أفضل خيار يناسب ظروفك
                        </p>
                    </div>
                </div>
            `,
            icon: 'info',
            width: '650px',
            showCancelButton: true,
            confirmButtonText: '📤 إرسال طلب الدعم',
            cancelButtonText: 'رجوع',
            confirmButtonColor: '#22C55E',
            cancelButtonColor: '#64748b',
            customClass: {
                popup: 'swal-rtl',
                title: 'swal-title-rtl',
                content: 'swal-content-rtl'
            },
            preConfirm: () => {
                const name = document.getElementById('grantName').value;
                const phone = document.getElementById('grantPhone').value;
                const type = document.getElementById('grantType').value;
                
                if (!name || !phone || !type) {
                    Swal.showValidationMessage('من فضلك أكمل البيانات المطلوبة');
                    return false;
                }
                
                if (!/^01[0-9]{9}$/.test(phone)) {
                    Swal.showValidationMessage('رقم الواتساب غير صحيح');
                    return false;
                }
                
                return { name, phone, type };
            }
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    // إعداد بيانات طلب الدعم
                    const supportData = {
                        // معلومات الطلب
                        requestType: 'grant_request',
                        timestamp: new Date().toISOString(),
                        status: 'pending',
                        
                        // معلومات الدورة
                        courseInfo: {
                            name: courseName,
                            originalPrice: basePrice,
                            courseId: window.currentCourseData?.courseId || 'unknown'
                        },
                        
                        // بيانات المتقدم
                        applicant: {
                            name: document.getElementById('grantName').value,
                            phone: document.getElementById('grantPhone').value,
                            grantType: document.getElementById('grantType').value,
                            reason: document.getElementById('grantReason').value || 'لم يذكر'
                        },
                        
                        // معلومات إضافية
                        journey: {
                            type: 'support',
                            text: 'طلب دعم/منحة'
                        }
                    };
                    
                    console.log('📤 إرسال طلب الدعم:', supportData);
                    
                    // حفظ في Firebase
                    const docRef = await db.collection('tempBookings').add(supportData);
                    console.log('✅ تم حفظ الطلب:', docRef.id);
                    
                    // حفظ احتياطي
                    localStorage.setItem('lastGrantRequest', JSON.stringify(supportData));
                    
                // رسالة نجاح
await Swal.fire({
    icon: 'success',
    title: 'تم إرسال طلبك بنجاح!',
    html: `
        <div style="text-align: center;">
            <div style="background: linear-gradient(135deg, #FEF2F2, #F0FDF4); 
                        padding: 20px; border-radius: 15px; margin: 20px 0;">
                <p style="color: #065F46; font-size: 1.1rem; margin: 10px 0;">
                    <strong>رقم الطلب:</strong> 
                    <span style="color: #22C55E; font-size: 1.2rem;">
                        #${docRef.id.slice(-6).toUpperCase()}
                    </span>
                </p>
                <p style="color: #374151; margin: 10px 0;">
                    سيتم التواصل معك خلال 24 ساعة لمناقشة أفضل خيار يناسب ظروفك
                </p>
            </div>
            
            <div style="background: #F3E8FF; padding: 15px; border-radius: 10px; 
                        margin: 20px 0;">
                <p style="color: #581C87; margin: 0;">
                    <i class="fas fa-heart"></i>
                    نؤمن أن المال لا يجب أن يكون عائقاً أمام رحلة التعلم
                </p>
            </div>
            
            <p style="color: #64748b; margin-top: 20px;">
                ماذا تريد أن تفعل الآن؟
            </p>
        </div>
    `,
    showCancelButton: true,
    confirmButtonText: '🔙 العودة للدورة',
    cancelButtonText: '📚 تصفح دورات أخرى',
    confirmButtonColor: '#22C55E',
    cancelButtonColor: '#9333EA',
    width: '650px',
    allowOutsideClick: false
}).then((result) => {
    if (result.isConfirmed) {
        const courseName = window.courseName || 'الدورة';
        const courseUrl = `course-discover.html?course=${courseName}`;
        window.location.href = courseUrl;
    } else if (result.dismiss === Swal.DismissReason.cancel) {
        window.location.href = 'master.html';
    }
});
                    
                } catch (error) {
                    console.error('❌ خطأ:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'خطأ!',
                        text: 'حدث خطأ في إرسال الطلب. حاول مرة أخرى.',
                        confirmButtonColor: '#E11D48'
                    });
                }
            }
        });
    };
}
},
    
    updateFromFirebase() {
    this.courseData = window.currentCourseData || {
        price: 10000,
        salePrice: 8000,
        currency: 'EGP',
        cashDiscount: { enabled: true, percentage: 15 },
        paymentPlans: [
            { name: '3 شهور', installments: 3, firstPaymentPercent: 40 },
            { name: '6 شهور', installments: 6, firstPaymentPercent: 30 }
        ],
        groupDiscounts: [
            { name: 'الصحاب', minSize: 3, percentage: 30 }
        ],
        discounts: [],
        coupons: []
    };
    
    this.coupons = this.courseData.coupons || [];
    console.log('الكوبونات المحملة من Firebase:', this.coupons);
    
    this.updateGroupOptions();
    this.updatePaymentOptions();
    this.updateActiveOffer();
    this.calculate();
},
    
    handleJourneyChange(journey) {
    this.selectedJourney = journey;
        // تنظيف عناصر القسيمة إذا كنا خارجين منها
    if (this.selectedJourney !== 'gift' || this.selectedGift !== 'voucher') {
        // إظهار العناصر المخفية
        document.getElementById('calcBase').parentElement.style.display = 'flex';
        const paymentSection = document.querySelector('.payment-selection');
        if (paymentSection) paymentSection.style.display = 'block';
        const couponSection = document.querySelector('.coupon-section');
        if (couponSection) couponSection.style.display = 'block';
        
        // إزالة رسالة الشكر إن وجدت
        const thankYouMessage = document.getElementById('voucherThankYou');
        if (thankYouMessage) thankYouMessage.remove();
        
        // إعادة تسمية الإجمالي
        document.getElementById('calcTotalLabel').textContent = 'إجمالي الاستثمار:';
    }
    // تحديث مؤشر التقدم
    document.getElementById('currentStep').textContent = '2';
    document.getElementById('step1').style.background = '#22C55E';
    document.getElementById('step2').style.background = '#FFD700';
    
    
    // إخفاء كل الأقسام أولاً
    document.getElementById('calcGroupArea').style.display = 'none';
    document.getElementById('calcGiftArea').style.display = 'none';
    document.getElementById('calcGrantBtn').style.display = 'none';
    document.getElementById('calcSupportMessage').style.display = 'none';
    
    // تحديث زر الإجراء الرئيسي
    const bookBtn = document.getElementById('calcBookBtn');
    bookBtn.className = 'btn-primary-action';
    
    // عرض القسم المناسب وتحديث الزر
    if (journey === 'group') {
        document.getElementById('calcGroupArea').style.display = 'block';
        bookBtn.innerHTML = '<i class="fas fa-users"></i> احجز للمجموعة';
    } else if (journey === 'gift') {
        document.getElementById('calcGiftArea').style.display = 'block';
        bookBtn.className = 'btn-primary-action btn-gift-action';
        bookBtn.innerHTML = '<i class="fas fa-gift"></i> أكمل الإهداء';
        // عرض تفاصيل الإهداء الافتراضية
        this.handleGiftTypeChange('specific');
    } else if (journey === 'individual') {
        // رحلة فردية - عرض زر الدعم مباشرة
        setTimeout(() => {
            document.getElementById('calcGrantBtn').style.display = 'block';
            document.getElementById('calcSupportMessage').style.display = 'block';
        }, 100);
        bookBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> احجز مقعدك';
    }
    
    this.calculate();
},
    
    handleGiftTypeChange(giftType) {
    this.selectedGift = giftType;
    
    // تنظيف عام أولاً
    this.cleanupVoucherElements();
    
    // إخفاء كل التفاصيل
    document.getElementById('giftSpecificDetails').style.display = 'none';
    document.getElementById('giftAnonymousDetails').style.display = 'none';
    document.getElementById('giftVoucherDetails').style.display = 'none';
    
    const bookBtn = document.getElementById('calcBookBtn');
    const activeOfferSection = document.getElementById('calcActiveOffer');
    const paymentSection = document.querySelector('.payment-selection');
    const couponSection = document.querySelector('.coupon-section');
    const scenarioButtons = document.querySelector('.action-buttons').previousElementSibling;
    
    // عرض التفاصيل المناسبة حسب النوع
    if (giftType === 'specific') {
        // هدية لشخص محدد
        document.getElementById('giftSpecificDetails').style.display = 'block';
        
        // إظهار كل العناصر العادية
        if (paymentSection) paymentSection.style.display = 'block';
        if (couponSection) couponSection.style.display = 'block';
        if (scenarioButtons) scenarioButtons.style.display = 'flex';
        if (activeOfferSection && this.getActiveTimeOffer()) {
            activeOfferSection.style.display = 'block';
        }
        
        bookBtn.innerHTML = '<i class="fas fa-gift"></i> أكمل إهداء الرحلة';
        
        // إعادة حساب السعر العادي
        this.calculate();
        
    } else if (giftType === 'anonymous') {
        // هدية مجهولة
        document.getElementById('giftAnonymousDetails').style.display = 'block';
        
        // إظهار كل العناصر العادية
        if (paymentSection) paymentSection.style.display = 'block';
        if (couponSection) couponSection.style.display = 'block';
        if (scenarioButtons) scenarioButtons.style.display = 'flex';
        if (activeOfferSection && this.getActiveTimeOffer()) {
            activeOfferSection.style.display = 'block';
        }
        
        bookBtn.innerHTML = '<i class="fas fa-heart"></i> ساهم بهدية مجهولة';
        
        // إعادة حساب السعر العادي
        this.calculate();
        
    } else if (giftType === 'voucher') {
        // قسيمة دعم - حالة خاصة
        document.getElementById('giftVoucherDetails').style.display = 'block';
        
        // إخفاء كل العناصر غير المناسبة
        if (activeOfferSection) activeOfferSection.style.display = 'none';
        if (paymentSection) paymentSection.style.display = 'none';
        if (couponSection) couponSection.style.display = 'none';
        if (scenarioButtons) scenarioButtons.style.display = 'none';
        
        bookBtn.className = 'btn-primary-action btn-voucher-action';
        bookBtn.innerHTML = '<i class="fas fa-hand-holding-heart"></i> ادعم المجتمع';
        
        // حساب خاص للقسيمة
        this.calculate();
    }
},

// دالة جديدة للتنظيف
cleanupVoucherElements() {
    // إظهار العناصر المخفية
    const calcBase = document.getElementById('calcBase');
    if (calcBase && calcBase.parentElement) {
        calcBase.parentElement.style.display = 'flex';
    }
    
    // إظهار صفوف الخصومات
    document.getElementById('calcTimeDiscountRow').style.display = '';
    document.getElementById('calcGroupDiscountRow').style.display = '';
    document.getElementById('calcCashDiscountRow').style.display = '';
    document.getElementById('calcCouponDiscountRow').style.display = '';
    document.getElementById('calcInstallmentDetails').style.display = '';
    document.getElementById('calcSavings').style.display = '';
    
    // إظهار الخط الفاصل
    const hrElement = document.querySelector('.price-breakdown hr');
    if (hrElement) hrElement.style.display = '';
    
    // إزالة رسالة الشكر إن وجدت
    const thankYouMessage = document.getElementById('voucherThankYou');
    if (thankYouMessage) thankYouMessage.remove();
    
    // إعادة تسمية الإجمالي
    const totalLabel = document.getElementById('calcTotalLabel');
    if (totalLabel) {
        totalLabel.innerHTML = 'إجمالي الاستثمار:';
    }
    
    // إعادة تنسيق المجموع
    const totalElement = document.getElementById('calcTotal');
    if (totalElement) {
        totalElement.style.fontSize = '';
        totalElement.style.color = '';
    }
},
    
    updateGroupOptions() {
        const container = document.querySelector('.group-cards');
        if (!container || !this.courseData.groupDiscounts) return;
        
        let html = '';
        this.courseData.groupDiscounts.forEach((group, index) => {
            html += `
                <div class="group-card" data-group="${index}">
                    <i class="fas fa-users"></i>
                    <h5>${group.name}</h5>
                    <div class="discount">${group.percentage}%</div>
                    <div class="size">${group.minSize}+ أشخاص</div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        container.querySelectorAll('.group-card').forEach(card => {
            card.addEventListener('click', () => {
                container.querySelectorAll('.group-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                this.selectedGroup = parseInt(card.dataset.group);
                this.calculate();
            });
        });
        
        // اختيار الأول افتراضياً
        if (container.querySelector('.group-card')) {
            container.querySelector('.group-card').click();
        }
    },
    
    updatePaymentOptions() {
        const container = document.getElementById('calcPaymentCards');
        if (!container) return;
        
        let html = '';
        
        // الدفع النقدي
        if (this.courseData.cashDiscount?.enabled) {
            html += `
                <div class="payment-card active" data-payment="cash">
                    <i class="fas fa-money-bill-wave"></i>
                    <h6>دفعة واحدة</h6>
                    <small>خصم ${this.courseData.cashDiscount.percentage}%</small>
                </div>
            `;
        } else {
            html += `
                <div class="payment-card active" data-payment="full">
                    <i class="fas fa-credit-card"></i>
                    <h6>دفعة واحدة</h6>
                </div>
            `;
        }
        
        // خطط الأقساط
        if (this.courseData.paymentPlans?.length > 0) {
            this.courseData.paymentPlans.forEach((plan, index) => {
                html += `
                    <div class="payment-card" data-payment="plan_${index}">
                        <i class="fas fa-calendar-alt"></i>
                        <h6>${plan.name}</h6>
                        <small>بدون فوائد</small>
                    </div>
                `;
            });
        }
        
        container.innerHTML = html;
        
        container.querySelectorAll('.payment-card').forEach(card => {
            card.addEventListener('click', () => {
                container.querySelectorAll('.payment-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                this.calculate();
            });
        });
    },
    
    updateActiveOffer() {
        const section = document.getElementById('calcActiveOffer');
        const activeOffer = this.getActiveTimeOffer();
        
        if (activeOffer) {
            section.style.display = 'block';
            document.getElementById('activeOfferName').textContent = activeOffer.name;
            document.getElementById('activeOfferDiscount').textContent = `خصم ${activeOffer.percentage}%`;
        } else {
            section.style.display = 'none';
        }
    },
    
    getActiveTimeOffer() {
        if (!this.courseData.discounts) return null;
        
        const now = new Date();
        return this.courseData.discounts.find(d => {
            if (!d.startDate || !d.endDate) return false;
            const start = new Date(d.startDate);
            const end = new Date(d.endDate);
            return now >= start && now <= end && d.percentage > 0;
        });
    },
    
   calculate() {
    if (!this.courseData) return;
        // تعريف المتغيرات في البداية
    let basePrice = this.courseData.price || 10000;
    let currentPrice = basePrice;
    let finalPrice = basePrice;  // أضف هذا السطر
    let discounts = [];

    const paymentCard = document.querySelector('.payment-card.active');
    const paymentMethod = paymentCard?.dataset.payment || 'full';
    
    
   // حالة القسيمة المفتوحة - معالجة خاصة
if (this.selectedJourney === 'gift' && this.selectedGift === 'voucher') {
    const voucherAmount = parseInt(document.getElementById('voucherAmount')?.value) || 0;
    
    // إخفاء كل عناصر التسعير العادية
    document.getElementById('calcBase').parentElement.style.display = 'none';
    document.getElementById('calcTimeDiscountRow').style.display = 'none';
    document.getElementById('calcGroupDiscountRow').style.display = 'none';
    document.getElementById('calcCashDiscountRow').style.display = 'none';
    document.getElementById('calcCouponDiscountRow').style.display = 'none';
    document.getElementById('calcInstallmentDetails').style.display = 'none';
    document.getElementById('calcSavings').style.display = 'none';
    
    // إخفاء الخط الفاصل
    const hrElement = document.querySelector('.price-breakdown hr');
    if (hrElement) hrElement.style.display = 'none';
    
    // تحديث العنوان والقيمة
    document.getElementById('calcTotalLabel').innerHTML = 
        '<i class="fas fa-heart" style="color: #E11D48;"></i> قيمة دعمك الكريم:';
    
    if (voucherAmount >= 50) {
        document.getElementById('calcTotal').innerHTML = `
            <span style="font-size: 2.5rem; color: #FFD700;">
                ${voucherAmount.toLocaleString('ar-EG')}
            </span>
            <span style="font-size: 1.2rem; color: #FFD700;"> ج.م</span>
        `;
        
        // عرض رسالة شكر في منطقة التفاصيل
        const breakdownDiv = document.querySelector('.price-breakdown');
        if (!document.getElementById('voucherThankYou')) {
            const thankYouMessage = document.createElement('div');
            thankYouMessage.id = 'voucherThankYou';
            thankYouMessage.innerHTML = `
                <div style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(20,184,166,0.1)); 
                            padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center;">
                    <i class="fas fa-hands-helping" style="font-size: 2rem; color: #22C55E; margin-bottom: 10px;"></i>
                    <h4 style="color: #FFD700; margin: 10px 0;">شكراً لك من القلب!</h4>
                    <p style="color: #e2e8f0; margin: 10px 0;">
                        مساهمتك ستغير حياة إنسان وتفتح له أبواب المعرفة
                    </p>
                    <p style="color: #94a3b8; font-size: 0.9rem;">
                        سنرسل لك تقريراً دورياً عن أثر مساهمتك الكريمة
                    </p>
                </div>
            `;
            breakdownDiv.appendChild(thankYouMessage);
        }
    } else {
        document.getElementById('calcTotal').innerHTML = `
            <span style="color: #E11D48;">الحد الأدنى 50 ج.م</span>
        `;
        // إزالة رسالة الشكر إن وجدت
        const thankYouMessage = document.getElementById('voucherThankYou');
        if (thankYouMessage) thankYouMessage.remove();
    }
    
    return; // توقف هنا للقسيمة
}
    
    // إظهار العناصر العادية للحالات الأخرى
    document.getElementById('calcBase').parentElement.style.display = 'flex';
    const paymentSection = document.querySelector('.payment-selection');
    const couponSection = document.querySelector('.coupon-section');
    if (paymentSection) paymentSection.style.display = 'block';
    if (couponSection) couponSection.style.display = 'block';
    
    // حالة الإهداء العادي - نفس حسابات الفردي
    if (this.selectedJourney === 'gift' && this.selectedGift !== 'voucher') {
        document.getElementById('calcTotalLabel').textContent = 'قيمة الهدية:';
        
        // نطبق نفس العروض والخصومات
        const activeOffer = this.getActiveTimeOffer();
        if (activeOffer) {
            const discount = basePrice * (activeOffer.percentage / 100);
            currentPrice -= discount;
            discounts.push({ type: 'time', amount: discount, name: activeOffer.name });
        } else if (this.courseData.salePrice && this.courseData.salePrice < basePrice) {
            const discount = basePrice - this.courseData.salePrice;
            currentPrice = this.courseData.salePrice;
            discounts.push({ type: 'sale', amount: discount, name: 'تخفيض' });
        }
        
        // خصم الدفع النقدي ينطبق على الهدايا أيضاً
        if (paymentMethod === 'cash' && this.courseData.cashDiscount?.enabled) {
            const discount = currentPrice * (this.courseData.cashDiscount.percentage / 100);
            currentPrice -= discount;
            discounts.push({ type: 'cash', amount: discount, name: 'دفع كامل' });
        }
    } 
    // الرحلات العادية (فردية أو جماعية)
    else {
        document.getElementById('calcTotalLabel').textContent = 'إجمالي الاستثمار:';
        
        // العروض الزمنية
        const activeOffer = this.getActiveTimeOffer();
        if (activeOffer) {
            const discount = basePrice * (activeOffer.percentage / 100);
            currentPrice -= discount;
            discounts.push({ type: 'time', amount: discount, name: activeOffer.name });
        } else if (this.courseData.salePrice && this.courseData.salePrice < basePrice) {
            const discount = basePrice - this.courseData.salePrice;
            currentPrice = this.courseData.salePrice;
            discounts.push({ type: 'sale', amount: discount, name: 'تخفيض' });
        }
        
        // خصم المجموعة
        if (this.selectedJourney === 'group' && this.selectedGroup !== null) {
            const group = this.courseData.groupDiscounts[this.selectedGroup];
            if (group) {
                const discount = currentPrice * (group.percentage / 100);
                currentPrice -= discount;
                discounts.push({ type: 'group', amount: discount, name: group.name });
            }
        }
        
        // خصم الدفع النقدي
        if (paymentMethod === 'cash' && this.courseData.cashDiscount?.enabled) {
            const discount = currentPrice * (this.courseData.cashDiscount.percentage / 100);
            currentPrice -= discount;
            discounts.push({ type: 'cash', amount: discount, name: 'دفع كامل' });
        }
    }
    
    // كود الخصم (يعمل مع كل الأنواع ما عدا القسيمة المفتوحة)
    if (this.appliedCoupon && !(this.selectedJourney === 'gift' && this.selectedGift === 'voucher')) {
        let discount = 0;
        if (this.appliedCoupon.type === 'percentage') {
            discount = currentPrice * (this.appliedCoupon.value / 100);
        } else {
            discount = Math.min(this.appliedCoupon.value, currentPrice);
        }
        currentPrice -= discount;
        discounts.push({ type: 'coupon', amount: discount, name: this.appliedCoupon.code });
    }
    
    this.updateDisplay(basePrice, currentPrice, discounts, paymentMethod);
       // في نهاية دالة calculate، بعد this.updateDisplay
this.lastCalculationState = {
    basePrice: basePrice,
    finalPrice: finalPrice,
    discounts: discounts,
    paymentMethod: paymentMethod,
    timestamp: new Date().toISOString()
};

},
    
    updateDisplay(basePrice, finalPrice, discounts, paymentMethod) {
        // تقريب
        basePrice = Math.round(basePrice / 10) * 10;
        finalPrice = Math.round(finalPrice / 10) * 10;
        
        // السعر الأساسي
        document.getElementById('calcBase').textContent = `${basePrice.toLocaleString('ar-EG')} ج.م`;
        
        // إخفاء كل الخصومات
        document.getElementById('calcTimeDiscountRow').style.display = 'none';
        document.getElementById('calcGroupDiscountRow').style.display = 'none';
        document.getElementById('calcCashDiscountRow').style.display = 'none';
        document.getElementById('calcCouponDiscountRow').style.display = 'none';
        
        // عرض الخصومات النشطة
        discounts.forEach(discount => {
            const amount = Math.round(discount.amount / 10) * 10;
            
            if (discount.type === 'time' || discount.type === 'sale') {
                document.getElementById('calcTimeDiscountRow').style.display = 'flex';
                document.getElementById('calcTimeDiscountLabel').textContent = 
                    discount.type === 'time' ? `خصم ${discount.name}:` : 'خصم:';
                document.getElementById('calcTimeDiscount').textContent = `-${amount.toLocaleString('ar-EG')} ج.م`;
            }
            if (discount.type === 'group') {
                document.getElementById('calcGroupDiscountRow').style.display = 'flex';
                document.getElementById('calcGroupDiscount').textContent = `-${amount.toLocaleString('ar-EG')} ج.م`;
            }
            if (discount.type === 'cash') {
                document.getElementById('calcCashDiscountRow').style.display = 'flex';
                document.getElementById('calcCashDiscount').textContent = `-${amount.toLocaleString('ar-EG')} ج.م`;
            }
            if (discount.type === 'coupon') {
                document.getElementById('calcCouponDiscountRow').style.display = 'flex';
                document.getElementById('calcCouponDiscount').textContent = `-${amount.toLocaleString('ar-EG')} ج.م`;
            }
        });
        
        // الإجمالي
        document.getElementById('calcTotal').textContent = `${finalPrice.toLocaleString('ar-EG')} ج.م`;
        
        // الأقساط (لا تظهر للقسيمة المفتوحة)
        const installmentDetails = document.getElementById('calcInstallmentDetails');
        if (paymentMethod.startsWith('plan_') && 
            !(this.selectedJourney === 'gift' && this.selectedGift === 'voucher')) {
            const planIndex = parseInt(paymentMethod.split('_')[1]);
            const plan = this.courseData.paymentPlans[planIndex];
            
            if (plan) {
                const installmentText = this.calculateInstallments(finalPrice, plan);
                document.getElementById('calcInstallmentPlan').innerHTML = installmentText;
                installmentDetails.style.display = 'block';
            }
        } else {
            installmentDetails.style.display = 'none';
        }
        
        // التوفير (لا يظهر للقسيمة المفتوحة)
        const savings = basePrice - finalPrice;
        if (savings > 0 && !(this.selectedJourney === 'gift' && this.selectedGift === 'voucher')) {
            document.getElementById('calcSavings').style.display = 'block';
            document.getElementById('calcSavingsAmount').textContent = savings.toLocaleString('ar-EG');
        } else {
            document.getElementById('calcSavings').style.display = 'none';
        }
            
    },
    
    calculateInstallments(total, plan) {
        const installments = plan.installments || 3;
        const firstPercent = plan.firstPaymentPercent || 0;
        
        total = Math.round(total / 10) * 10;
        
        if (firstPercent > 0) {
            const firstPayment = Math.round(total * firstPercent / 100 / 10) * 10;
            const remaining = total - firstPayment;
            const monthlyAmount = Math.round(remaining / (installments - 1) / 10) * 10;
            
            return `دفعة أولى: ${firstPayment.toLocaleString('ar-EG')} ج.م + ${installments - 1} أقساط × ${monthlyAmount.toLocaleString('ar-EG')} ج.م`;
        } else {
            const monthlyAmount = Math.round(total / installments / 10) * 10;
            return `${installments} أقساط × ${monthlyAmount.toLocaleString('ar-EG')} ج.م شهرياً`;
        }
    },
    
    applyCoupon() {
    const couponInput = document.getElementById('calcCoupon');
    const couponCode = couponInput.value.trim().toUpperCase();
    
    if (!couponCode) {
        Swal.fire({
            icon: 'warning',
            title: 'كود فارغ',
            text: 'الرجاء إدخال كود الخصم',
            confirmButtonColor: '#FFD700'
        });
        return;
    }
    
    // البحث عن الكوبون
    const validCoupon = this.coupons.find(c => c.code === couponCode);
    
    if (!validCoupon) {
        Swal.fire({
            icon: 'error',
            title: 'كود غير صحيح',
            text: 'هذا الكود غير موجود أو منتهي الصلاحية',
            confirmButtonColor: '#E11D48'
        });
        return;
    }
    
    // التحقق من الاستخدام
    if (validCoupon.maxUses && validCoupon.used >= validCoupon.maxUses) {
        Swal.fire({
            icon: 'error',
            title: 'كود مستخدم',
            text: 'تم استخدام هذا الكود العدد الأقصى من المرات',
            confirmButtonColor: '#E11D48'
        });
        return;
    }
    
    // تطبيق الكوبون
    this.appliedCoupon = validCoupon;
    
    // تحديث الواجهة
    couponInput.disabled = true;
    document.getElementById('applyCouponCalc').style.display = 'none';
    
    // إضافة زر إزالة
    const couponSection = document.querySelector('.coupon-section');
    if (!document.querySelector('.coupon-remove-btn')) {
        const removeBtn = document.createElement('button');
        removeBtn.className = 'coupon-remove-btn';
        removeBtn.innerHTML = '<i class="fas fa-times"></i> إزالة الكود';
        removeBtn.onclick = () => this.removeCoupon();
        couponSection.appendChild(removeBtn);
    }
    
    // رسالة نجاح
    Swal.fire({
        icon: 'success',
        title: 'تم التطبيق!',
        text: `كود ${couponCode} تم تطبيقه بنجاح`,
        confirmButtonColor: '#22C55E',
        timer: 2000
    });

        // إضافة رسالة في واجهة المستخدم
const messageDiv = document.getElementById('calcCouponMessage');
if (messageDiv) {
    messageDiv.innerHTML = `
        <div style="background: rgba(34,197,94,0.1); 
                    border: 1px solid #22C55E; 
                    padding: 10px; 
                    border-radius: 8px; 
                    color: #22C55E;
                    margin-top: 10px;">
            <i class="fas fa-check-circle"></i>
            كود الخصم <strong>${couponCode}</strong> مُفعّل
            ${validCoupon.type === 'percentage' ? 
              `(خصم ${validCoupon.value}%)` : 
              `(خصم ${validCoupon.value} ج.م)`}
        </div>
    `;
}

// تغيير لون الحقل للأخضر
couponInput.style.background = '#22C55E20';
couponInput.style.borderColor = '#22C55E';

// حفظ الحالة
this.saveToStorage();
    
    // إعادة حساب
    this.calculate();
},

removeCoupon() {
    this.appliedCoupon = null;
    
    const couponInput = document.getElementById('calcCoupon');
    const applyBtn = document.getElementById('applyCouponCalc');
    const messageDiv = document.getElementById('calcCouponMessage');
    
    // إعادة تفعيل الحقل
    if (couponInput) {
        couponInput.value = '';
        couponInput.disabled = false;
        couponInput.style.background = '';
        couponInput.style.borderColor = '';
    }
    
    // إظهار زر التطبيق
    if (applyBtn) {
        applyBtn.style.display = 'inline-block';
    }
    
    // إزالة زر الحذف
    const removeBtn = document.querySelector('.coupon-remove-btn');
    if (removeBtn) {
        removeBtn.remove();
    }
    
    // إزالة الرسالة
    if (messageDiv) {
        messageDiv.innerHTML = '';
    }
    
    // حفظ الحالة الجديدة
    this.saveToStorage();
    
    // إعادة الحساب
    this.calculate();
    
    // رسالة تأكيد
    Swal.fire({
        icon: 'info',
        title: 'تم إزالة كود الخصم',
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 2000,
        timerProgressBar: true
    });
},

    // أضف هذه الدالة الجديدة
getDisplayedValues() {
    const result = {
        basePrice: 0,
        finalPrice: 0,
        discounts: [],
        paymentMethod: '',
        installmentDetails: null,
        coupon: null,
        totalSavings: 0
    };
    
    // قراءة السعر الأساسي
    const basePriceEl = document.getElementById('calcBase');
    if (basePriceEl) {
        const text = basePriceEl.textContent || '';
        const numbers = text.match(/[\d,]+/g);
        if (numbers) {
            result.basePrice = parseInt(numbers[0].replace(/,/g, '')) || 0;
        }
    }
    
    // قراءة السعر النهائي
    const finalPriceEl = document.getElementById('calcTotal');
    if (finalPriceEl) {
        const text = finalPriceEl.textContent || '';
        const numbers = text.match(/[\d,]+/g);
        if (numbers) {
            result.finalPrice = parseInt(numbers[0].replace(/,/g, '')) || 0;
        }
    }
    
    // قراءة الخصومات المرئية
    const discountTypes = [
        {id: 'calcTimeDiscountRow', valueId: 'calcTimeDiscount', labelId: 'calcTimeDiscountLabel', type: 'time'},
        {id: 'calcGroupDiscountRow', valueId: 'calcGroupDiscount', type: 'group'},
        {id: 'calcCashDiscountRow', valueId: 'calcCashDiscount', type: 'cash'},
        {id: 'calcCouponDiscountRow', valueId: 'calcCouponDiscount', type: 'coupon'}
    ];
    
    discountTypes.forEach(item => {
        const row = document.getElementById(item.id);
        if (row && row.style.display !== 'none') {
            const valueEl = document.getElementById(item.valueId);
            if (valueEl) {
                const text = valueEl.textContent || '';
                const numbers = text.match(/[\d,]+/g);
                if (numbers) {
                    const amount = parseInt(numbers[0].replace(/,/g, '')) || 0;
                    if (amount > 0) {
                        let label = item.type;
                        if (item.labelId) {
                            const labelEl = document.getElementById(item.labelId);
                            if (labelEl) {
                                label = labelEl.textContent.replace(':', '').trim();
                            }
                        }
                        
                        result.discounts.push({
                            type: item.type,
                            label: label,
                            amount: amount,
                            percentage: this.getDiscountPercentage(item.type)
                        });
                    }
                }
            }
        }
    });
    
    // طريقة الدفع
    const activePaymentCard = document.querySelector('.payment-card.active');
    if (activePaymentCard) {
        result.paymentMethod = activePaymentCard.dataset.payment || '';
        
        // معلومات الأقساط
        const installmentEl = document.getElementById('calcInstallmentPlan');
        if (installmentEl && document.getElementById('calcInstallmentDetails').style.display !== 'none') {
            result.installmentDetails = installmentEl.innerHTML || '';
        }
    }
    
    // الكوبون
    if (this.appliedCoupon) {
        result.coupon = {
            code: this.appliedCoupon.code,
            type: this.appliedCoupon.type,
            value: this.appliedCoupon.value
        };
    }
    
    // حساب التوفير
    result.totalSavings = result.basePrice - result.finalPrice;
    
    return result;
},

    getDiscountPercentage(type) {
    switch(type) {
        case 'time':
            const activeOffer = this.getActiveTimeOffer();
            return activeOffer?.percentage || 0;
        case 'group':
            if (this.selectedGroup !== null) {
                return this.courseData.groupDiscounts[this.selectedGroup]?.percentage || 0;
            }
            return 0;
        case 'cash':
            return this.courseData.cashDiscount?.percentage || 0;
        case 'coupon':
            if (this.appliedCoupon) {
                if (this.appliedCoupon.type === 'percentage') {
                    return this.appliedCoupon.value;
                }
            }
            return 0;
        default:
            return 0;
    }
},

getDisplayedDiscounts() {
    const discounts = [];
    
    // خصم العرض الزمني
    if (document.getElementById('calcTimeDiscountRow').style.display !== 'none') {
        const amount = parseInt(document.getElementById('calcTimeDiscount').textContent.replace(/[^\d]/g, '')) || 0;
        const label = document.getElementById('calcTimeDiscountLabel').textContent;
        discounts.push({
            type: 'عرض زمني',
            name: label.replace(':', ''),
            amount: amount
        });
    }
    
    // خصم المجموعة
    if (document.getElementById('calcGroupDiscountRow').style.display !== 'none') {
        const amount = parseInt(document.getElementById('calcGroupDiscount').textContent.replace(/[^\d]/g, '')) || 0;
        discounts.push({
            type: 'خصم مجموعة',
            name: 'خصم المجموعة',
            amount: amount
        });
    }
    
    // خصم النقدي
    if (document.getElementById('calcCashDiscountRow').style.display !== 'none') {
        const amount = parseInt(document.getElementById('calcCashDiscount').textContent.replace(/[^\d]/g, '')) || 0;
        discounts.push({
            type: 'خصم نقدي',
            name: 'دفع كامل',
            amount: amount
        });
    }
    
    // كود الخصم
    if (document.getElementById('calcCouponDiscountRow').style.display !== 'none') {
        const amount = parseInt(document.getElementById('calcCouponDiscount').textContent.replace(/[^\d]/g, '')) || 0;
        discounts.push({
            type: 'كود خصم',
            name: this.appliedCoupon?.code || 'كوبون',
            amount: amount
        });
    }
    
    return discounts;
},

getDisplayedInstallments() {
    const installmentDetails = document.getElementById('calcInstallmentDetails');
    if (installmentDetails.style.display === 'none') return null;
    
    const text = document.getElementById('calcInstallmentPlan').innerHTML;
    return {
        planText: text,
        isActive: true
    };
},

    
    
// دالة محسنة لحفظ البيانات
saveCalculationState() {
    const state = {
        journey: this.selectedJourney,
        group: this.selectedGroup,
        gift: this.selectedGift,
        paymentMethod: this.getSelectedPaymentMethod(),
        coupon: this.appliedCoupon,
        
        // البيانات المعروضة
        displayedValues: this.getDisplayedValues(),
        
        // البيانات الأصلية
        courseData: {
            title: this.courseData?.title || 'الدورة',
            price: this.courseData?.price || 10000,
            salePrice: this.courseData?.salePrice,
            cashDiscount: this.courseData?.cashDiscount,
            paymentPlans: this.courseData?.paymentPlans,
            groupDiscounts: this.courseData?.groupDiscounts
        },
        
        // الطابع الزمني
        timestamp: new Date().toISOString()
    };
    
    // حفظ في عدة أماكن
    const stateString = JSON.stringify(state);
    localStorage.setItem('calculatorState', stateString);
    sessionStorage.setItem('calculatorState', stateString);
    
    return state;
},

// دالة محسنة للحصول على طريقة الدفع
getSelectedPaymentMethod() {
    const activeCard = document.querySelector('.payment-card.active');
    if (!activeCard) return 'full';
    
    const method = activeCard.dataset.payment;
    const methodName = activeCard.querySelector('h6')?.textContent || '';
    
    return {
        code: method,
        name: methodName,
        isInstallment: method.startsWith('plan_')
    };
},

    // ميزة حفظ ومقارنة السيناريوهات
saveScenario() {
    const scenarioName = prompt('أدخل اسم للسيناريو (مثال: عرض رمضان - 3 أشخاص):');
    if (!scenarioName) return;
    
    const scenario = {
        name: scenarioName,
        date: new Date().toLocaleDateString('ar-EG'),
        journey: this.selectedJourney,
        basePrice: document.getElementById('calcBase')?.innerText,
        finalPrice: document.getElementById('calcTotal')?.innerText,
        discounts: this.getDisplayedDiscounts(),
        paymentMethod: document.querySelector('.payment-card.active')?.querySelector('h6')?.innerText
    };
    
    // حفظ في localStorage
    const savedScenarios = JSON.parse(localStorage.getItem('savedScenarios') || '[]');
    savedScenarios.push(scenario);
    localStorage.setItem('savedScenarios', JSON.stringify(savedScenarios));
    
    Swal.fire({
        icon: 'success',
        title: 'تم الحفظ!',
        text: `تم حفظ السيناريو "${scenarioName}" بنجاح`,
        confirmButtonColor: '#22C55E'
    });
},

showSavedScenarios() {
    const savedScenarios = JSON.parse(localStorage.getItem('savedScenarios') || '[]');
    
    if (savedScenarios.length === 0) {
        Swal.fire({
            icon: 'info',
            title: 'لا توجد سيناريوهات محفوظة',
            text: 'احسب عرض واحفظه للمقارنة لاحقاً',
            confirmButtonColor: '#3B82F6'
        });
        return;
    }
    
    let html = '<div style="text-align: right; max-height: 400px; overflow-y: auto;">';
    savedScenarios.forEach((scenario, index) => {
        html += `
            <div style="background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 10px; border-right: 4px solid #FFD700;">
                <h4 style="color: #0A1628; margin-bottom: 10px;">${scenario.name}</h4>
                <p><strong>التاريخ:</strong> ${scenario.date}</p>
                <p><strong>السعر النهائي:</strong> <span style="color: #22C55E; font-size: 1.2em;">${scenario.finalPrice}</span></p>
                <p><strong>الدفع:</strong> ${scenario.paymentMethod || 'غير محدد'}</p>
                <button onclick="smartCalculator.deleteScenario(${index})" 
                        style="background: #E11D48; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;">
                    حذف
                </button>
            </div>
        `;
    });
    html += '</div>';
    
    Swal.fire({
        title: 'السيناريوهات المحفوظة',
        html: html,
        width: '600px',
        confirmButtonText: 'إغلاق',
        confirmButtonColor: '#3B82F6'
    });
},

deleteScenario(index) {
    const savedScenarios = JSON.parse(localStorage.getItem('savedScenarios') || '[]');
    savedScenarios.splice(index, 1);
    localStorage.setItem('savedScenarios', JSON.stringify(savedScenarios));
    Swal.close();
    setTimeout(() => this.showSavedScenarios(), 100);
},
    
handleMainAction() {
    console.log('🎯 بدء عملية الحجز');
    
    // حالة خاصة للقسيمة
    if (this.selectedJourney === 'gift' && this.selectedGift === 'voucher') {
        this.handleVoucherDonation();
        return;
    }
    // حالة الإهداء لشخص محدد
if (this.selectedJourney === 'gift' && this.selectedGift === 'specific') {
    // نفس طريقة الحجز العادي - عرض الصندوق الأول
    if (typeof window.showAllData === 'function') {
        window.showAllData();
    }
    return;
}

// حالة الإهداء لشخص مستحق (مجهول)
if (this.selectedJourney === 'gift' && this.selectedGift === 'anonymous') {
    // نفس طريقة الحجز العادي - عرض الصندوق الأول
    if (typeof window.showAllData === 'function') {
        window.showAllData();
    }
    return;
}
    
    // الحالات العادية - عرض الصندوق الأصلي أولاً
    const finalPrice = document.getElementById('calcTotal')?.innerText;
    if (!finalPrice || finalPrice === '0 ج.م' || finalPrice === '٠ ج.م') {
        Swal.fire({
            icon: 'warning',
            title: 'تنبيه',
            text: 'برجاء اختيار الخيارات وحساب السعر أولاً'
        });
        return;
    }
    
    // استدعاء دالة عرض البيانات الأصلية
    if (typeof window.showAllData === 'function') {
        window.showAllData();
    } else {
        console.error('❌ دالة showAllData غير موجودة');
    }
},
    
    handleIndividualBooking() {
    const finalPrice = document.getElementById('calcTotal')?.innerText || '0';
    const paymentMethod = document.querySelector('.payment-card.active h6')?.innerText || '';
    
    Swal.fire({
        title: '📋 تأكيد حجزك الفردي',
        html: `
            <div style="text-align: right; direction: rtl;">
                <!-- عرض التفاصيل -->
                <div style="background: linear-gradient(135deg, #FFD700, #FFA500); 
                            padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #0A1628;">رحلة فردية</h4>
                    <p style="color: #152238;">السعر النهائي: <strong>${finalPrice}</strong></p>
                    <p style="color: #152238;">طريقة الدفع: ${paymentMethod}</p>
                </div>
                
                <!-- نموذج البيانات -->
                <div style="background: white; padding: 20px; border-radius: 10px;">
                    <h4 style="color: #0A1628; margin-bottom: 15px;">
                        <i class="fas fa-user"></i> بياناتك الشخصية
                    </h4>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #374151;">
                            الاسم الكامل <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="individualName" placeholder="أدخل اسمك الثلاثي"
                               style="width: 100%; padding: 10px; border: 2px solid #E5E7EB; 
                                      border-radius: 8px; font-size: 1rem;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #374151;">
                            رقم الواتساب <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="individualPhone" placeholder="01xxxxxxxxx"
                               style="width: 100%; padding: 10px; border: 2px solid #E5E7EB; 
                                      border-radius: 8px; font-size: 1rem; direction: ltr;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #374151;">
                            البريد الإلكتروني
                        </label>
                        <input type="email" id="individualEmail" placeholder="example@email.com"
                               style="width: 100%; padding: 10px; border: 2px solid #E5E7EB; 
                                      border-radius: 8px; font-size: 1rem; direction: ltr;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #374151;">
                            ملاحظات (اختياري)
                        </label>
                        <textarea id="individualNotes" rows="2" 
                                  placeholder="أي ملاحظات أو طلبات خاصة"
                                  style="width: 100%; padding: 10px; border: 2px solid #E5E7EB; 
                                         border-radius: 8px; font-size: 1rem;"></textarea>
                    </div>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '✅ تأكيد الحجز',
        cancelButtonText: 'رجوع',
        confirmButtonColor: '#22C55E',
        width: '650px',
        preConfirm: () => {
            const name = document.getElementById('individualName').value;
            const phone = document.getElementById('individualPhone').value;
            
            if (!name || !phone) {
                Swal.showValidationMessage('من فضلك أكمل البيانات المطلوبة');
                return false;
            }
            
            if (!/^01[0-9]{9}$/.test(phone)) {
                Swal.showValidationMessage('رقم الواتساب غير صحيح');
                return false;
            }
            
            return { name, phone };
        }
    }).then(async (result) => {
        if (result.isConfirmed) {
            // جمع كل البيانات
            const bookingData = {
                type: 'individual_booking',
                timestamp: new Date().toISOString(),
                journey: 'فردي',
                
                // البيانات الشخصية
                customer: {
                    name: document.getElementById('individualName').value,
                    phone: document.getElementById('individualPhone').value,
                    email: document.getElementById('individualEmail').value || '',
                    notes: document.getElementById('individualNotes').value || ''
                },
                
                // بيانات السعر
                pricing: this.getDisplayedValues(),
                
                // طريقة الدفع
                payment: this.getSelectedPaymentMethod()
            };
            
            try {
                // حفظ في Firebase
                const docRef = await db.collection('tempBookings').add(bookingData);
                console.log('✅ تم حفظ الحجز الفردي:', docRef.id);
                
                // رسالة نجاح
                await Swal.fire({
                    icon: 'success',
                    title: 'تم الحجز بنجاح!',
                    text: 'جاري توجيهك لإتمام الدفع...',
                    timer: 2000
                });
                
                // الانتقال للصفحة التالية
                window.location.href = `booking-page.html?bookingId=${docRef.id}`;
                
            } catch (error) {
                console.error('❌ خطأ:', error);
                Swal.fire('خطأ!', 'حدث خطأ في الحفظ', 'error');
            }
        }
    });
},
handleGroupBooking() {
    const selectedGroup = document.querySelector('.group-card.active h5')?.innerText || '';
    const groupDiscount = document.querySelector('.group-card.active .discount')?.innerText || '';
    const finalPrice = document.getElementById('calcTotal')?.innerText || '0';
    
    Swal.fire({
        title: '👥 تأكيد حجز المجموعة',
        html: `
            <div style="text-align: right; direction: rtl;">
                <!-- عرض التفاصيل -->
                <div style="background: linear-gradient(135deg, #9333EA, #EC4899); 
                            padding: 15px; border-radius: 10px; margin-bottom: 20px; color: white;">
                    <h4>حجز جماعي - ${selectedGroup}</h4>
                    <p>الخصم: ${groupDiscount}</p>
                    <p>السعر للفرد: <strong>${finalPrice}</strong></p>
                </div>
                
                <!-- نموذج البيانات -->
                <div style="background: white; padding: 20px; border-radius: 10px;">
                    <h4 style="color: #9333EA; margin-bottom: 15px;">
                        <i class="fas fa-users"></i> بيانات المجموعة
                    </h4>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #374151;">
                            اسم المسؤول <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="groupLeaderName" placeholder="اسم قائد المجموعة"
                               style="width: 100%; padding: 10px; border: 2px solid #9333EA; 
                                      border-radius: 8px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #374151;">
                            رقم واتساب المسؤول <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="groupLeaderPhone" placeholder="01xxxxxxxxx"
                               style="width: 100%; padding: 10px; border: 2px solid #9333EA; 
                                      border-radius: 8px; direction: ltr;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #374151;">
                            عدد الأفراد <span style="color: red;">*</span>
                        </label>
                        <input type="number" id="groupSize" min="3" placeholder="3 أشخاص على الأقل"
                               style="width: 100%; padding: 10px; border: 2px solid #9333EA; 
                                      border-radius: 8px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #374151;">
                            أسماء أفراد المجموعة
                        </label>
                        <textarea id="groupMembers" rows="3" 
                                  placeholder="أدخل أسماء الأفراد (كل اسم في سطر)"
                                  style="width: 100%; padding: 10px; border: 2px solid #9333EA; 
                                         border-radius: 8px;"></textarea>
                    </div>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '✅ تأكيد حجز المجموعة',
        cancelButtonText: 'رجوع',
        confirmButtonColor: '#9333EA',
        width: '650px',
        preConfirm: () => {
            const name = document.getElementById('groupLeaderName').value;
            const phone = document.getElementById('groupLeaderPhone').value;
            const size = document.getElementById('groupSize').value;
            
            if (!name || !phone || !size) {
                Swal.showValidationMessage('من فضلك أكمل البيانات المطلوبة');
                return false;
            }
            
            if (size < 3) {
                Swal.showValidationMessage('العدد يجب أن يكون 3 أشخاص على الأقل');
                return false;
            }
            
            return { name, phone, size };
        }
    }).then(async (result) => {
        if (result.isConfirmed) {
            // جمع البيانات
            const bookingData = {
                type: 'group_booking',
                timestamp: new Date().toISOString(),
                journey: 'جماعي',
                
                // بيانات المجموعة
                group: {
                    name: selectedGroup,
                    leaderName: document.getElementById('groupLeaderName').value,
                    leaderPhone: document.getElementById('groupLeaderPhone').value,
                    size: document.getElementById('groupSize').value,
                    members: document.getElementById('groupMembers').value || '',
                    discount: groupDiscount
                },
                
                // بيانات السعر
                pricing: this.getDisplayedValues()
            };
            
            try {
                // حفظ في Firebase
                const docRef = await db.collection('tempBookings').add(bookingData);
                console.log('✅ تم حفظ حجز المجموعة:', docRef.id);
                
                await Swal.fire({
                    icon: 'success',
                    title: 'تم حجز المجموعة!',
                    timer: 2000
                });
                
                window.location.href = `booking-page.html?bookingId=${docRef.id}`;
                
            } catch (error) {
                console.error('❌ خطأ:', error);
                Swal.fire('خطأ!', 'حدث خطأ في الحفظ', 'error');
            }
        }
    });
},
// دالة جديدة خاصة بالقسيمة
handleVoucherDonation() {
    const amount = parseInt(document.getElementById('voucherAmount')?.value) || 0;
    
    if (amount < 50) {
        Swal.fire({
            icon: 'warning',
            title: 'تنبيه',
            text: 'الحد الأدنى للمساهمة 50 ج.م',
            confirmButtonColor: '#FFD700'
        });
        return;
    }
    
    // الحصول على اسم الدورة بشكل صحيح
    let courseName = 'الدورة';
    if (window.courseName) {
        courseName = window.courseName;
    } else if (window.currentCourseData && window.currentCourseData.title) {
        courseName = window.currentCourseData.title;
    } else {
        // محاولة أخيرة من العنوان
        const titleElement = document.querySelector('.hero-title');
        if (titleElement && titleElement.textContent && titleElement.textContent !== 'استثمر في رحلتك نحو نور الحياة الطيبة') {
            courseName = titleElement.textContent;
        }
    }
    
    // نافذة تأكيد محسنة
    Swal.fire({
        title: '💝 تأكيد قسيمة الدعم',
        html: `
            <div style="text-align: right; direction: rtl;">
                <!-- معلومات الدورة -->
                <div style="background: linear-gradient(135deg, #9333EA, #EC4899); 
                            padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: white; margin: 0;">
                        <i class="fas fa-book"></i> ${courseName}
                    </h4>
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(20,184,166,0.1)); 
                            padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <i class="fas fa-hands-helping" 
                           style="font-size: 3rem; color: #22C55E;"></i>
                    </div>
                    
                    <h3 style="color: #065F46; margin-bottom: 20px; text-align: center;">
                        شكراً لقلبك الطيب
                    </h3>
                    
                    <div style="background: white; padding: 20px; border-radius: 10px; 
                                border-right: 4px solid #FFD700;">
                        <p style="margin: 10px 0; font-size: 1.2rem; text-align: center;">
                            <strong>قيمة دعمك الكريم:</strong>
                        </p>
                        <p style="text-align: center; margin: 15px 0;">
                            <span style="color: #22C55E; font-size: 2.5rem; font-weight: bold;">
                                ${amount.toLocaleString('ar-EG')}
                            </span>
                            <span style="font-size: 1.5rem; color: #FFD700;"> ج.م</span>
                        </p>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <label style="color: #065F46; font-weight: bold;">
                            <i class="fas fa-user"></i> اسمك الكريم:
                        </label>
                        <input type="text" id="voucherDonorName" placeholder="يمكنك تركه فارغاً للتبرع بدون اسم"
                               style="width: 100%; padding: 12px; border: 2px solid #22C55E; 
                                      border-radius: 8px; margin-top: 8px; font-size: 1rem;">
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <label style="color: #065F46; font-weight: bold;">
                            <i class="fas fa-phone"></i> رقم الواتساب (اختياري):
                        </label>
                        <input type="text" id="voucherDonorPhone" placeholder="01xxxxxxxxx"
                               style="width: 100%; padding: 12px; border: 2px solid #22C55E; 
                                      border-radius: 8px; margin-top: 8px; font-size: 1rem; 
                                      direction: ltr; text-align: left;">
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <label style="color: #065F46; font-weight: bold;">
                            <i class="fas fa-envelope"></i> رسالة (اختياري):
                        </label>
                        <textarea id="voucherDonorMessage" rows="3" 
                                  placeholder="رسالتك للمستفيد من دعمك..."
                                  style="width: 100%; padding: 12px; border: 2px solid #22C55E; 
                                         border-radius: 8px; margin-top: 8px; font-size: 1rem;"></textarea>
                    </div>
                </div>
                
                <div style="background: #FEF2F2; padding: 15px; border-radius: 10px; 
                            border-right: 3px solid #E11D48;">
                    <p style="color: #991B1B; margin: 0; text-align: center;">
                        <i class="fas fa-info-circle"></i>
                        بالضغط على "تأكيد المساهمة" سيتم توجيهك لصفحة الدفع
                    </p>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '✨ تأكيد المساهمة',
        cancelButtonText: 'رجوع',
        confirmButtonColor: '#22C55E',
        cancelButtonColor: '#6b7280',
        width: '600px',
        customClass: {
            popup: 'swal-rtl'
        },
        // مهم جداً - منع الصندوق من الظهور في الخلفية
        backdrop: true,
        allowOutsideClick: false,
        allowEscapeKey: true,
        allowEnterKey: true
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                // جمع البيانات
                const voucherData = {
                    type: 'voucher_donation',
                    timestamp: new Date().toISOString(),
                    status: 'pending',
                    
                    // معلومات الدورة
                    courseInfo: {
                        name: courseName,
                        courseId: window.currentCourseData?.courseId || 'unknown'
                    },
                    
                    // معلومات التبرع
                    donation: {
                        amount: amount,
                        currency: 'EGP'
                    },
                    
                    // معلومات المتبرع
                    donor: {
                        name: document.getElementById('voucherDonorName')?.value || 'محسن كريم',
                        phone: document.getElementById('voucherDonorPhone')?.value || '',
                        message: document.getElementById('voucherDonorMessage')?.value || ''
                    }
                };
                
                console.log('💝 حفظ قسيمة الدعم:', voucherData);
                
                // حفظ في Firebase
                const docRef = await db.collection('tempBookings').add(voucherData);
                console.log('✅ تم الحفظ:', docRef.id);
                
                // حفظ احتياطي
                localStorage.setItem('lastVoucher', JSON.stringify(voucherData));
                
               // رسالة النجاح النهائية للتبرع
await Swal.fire({
    icon: 'success',
    title: '🌟 أنت نجم مضيء!',
    html: `
        <div style="text-align: center;">
            <div style="background: linear-gradient(135deg, #D1FAE5, #F3E8FF); 
                        padding: 25px; border-radius: 15px; margin: 20px 0;">
                <h3 style="color: #065F46; margin-bottom: 15px;">
                    شكراً لقلبك الطيب
                </h3>
                <p style="color: #374151; font-size: 1.1rem; margin: 10px 0;">
                    مساهمتك ستغير حياة إنسان وتفتح له أبواب المعرفة
                </p>
                <div style="background: white; padding: 15px; border-radius: 10px; 
                            margin: 15px 0; border-right: 4px solid #FFD700;">
                    <p style="margin: 0;">
                        <strong>رقم المساهمة:</strong>
                        <span style="color: #22C55E; font-size: 1.2rem;">
                            #${docRef.id.slice(-8).toUpperCase()}
                        </span>
                    </p>
                </div>
                <p style="color: #64748b; margin: 10px 0;">
                    سنرسل لك تقريراً دورياً عن أثر مساهمتك الكريمة
                </p>
            </div>
            
            <p style="color: #64748b; margin-top: 20px;">
                ماذا تريد أن تفعل الآن؟
            </p>
        </div>
    `,
    showCancelButton: true,
    confirmButtonText: '🔙 العودة للدورة',
    cancelButtonText: '📚 استكشف دورات أخرى',
    confirmButtonColor: '#22C55E',
    cancelButtonColor: '#9333EA',
    width: '650px',
    allowOutsideClick: false
}).then((result) => {
    if (result.isConfirmed) {
        // العودة لصفحة الدورة
        const courseName = window.courseName || 'الدورة';
        const courseUrl = `course-discover.html?course=${courseName}`;
        window.location.href = courseUrl;
    } else if (result.dismiss === Swal.DismissReason.cancel) {
        // صفحة الدورات
        window.location.href = 'master.html';
    }
});
                
            } catch (error) {
                console.error('❌ خطأ:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ!',
                    text: 'حدث خطأ في حفظ البيانات. حاول مرة أخرى.',
                    confirmButtonColor: '#E11D48'
                });
            }
        }
        // إذا ضغط رجوع - لا نفعل شيء والصندوق سيختفي تلقائياً
    });
},


// دالة احتياطية
proceedWithOldMethod() {
    const currentState = this.saveCalculationState();
    const bookingPackage = {
        version: '2.0',
        source: 'calculator',
        data: currentState
    };
    
    localStorage.setItem('bookingPackage', JSON.stringify(bookingPackage));
    
    Swal.fire({
        icon: 'success',
        title: 'تم حفظ البيانات',
        text: 'جاري الانتقال...',
        timer: 2000
    });
    
    setTimeout(() => {
        window.location.href = 'booking-page.html';
    }, 2000);
},

// دالة لإنشاء checksum للتحقق من سلامة البيانات
generateChecksum(data) {
    const str = JSON.stringify(data);
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return Math.abs(hash).toString(16);
},
    
getAdditionalInfo() {
    const info = {};
    
    if (this.selectedJourney === 'group' && this.selectedGroup !== null) {
        const group = this.courseData.groupDiscounts[this.selectedGroup];
        info.group = {
            name: group?.name,
            size: group?.minSize,
            discount: group?.percentage
        };
    }
    
    if (this.selectedJourney === 'gift') {
        info.gift = {
            type: this.selectedGift,
            recipientName: document.getElementById('giftRecipientName')?.value || '',
            gifterName: document.getElementById('gifterName')?.value || '',
            message: document.getElementById('giftMessage')?.value || '',
            voucherAmount: parseInt(document.getElementById('voucherAmount')?.value) || 0
        };
    }
    
    // معلومات العرض النشط
    const activeOffer = this.getActiveTimeOffer();
    if (activeOffer) {
        info.activeOffer = {
            name: activeOffer.name,
            percentage: activeOffer.percentage,
            endDate: activeOffer.endDate
        };
    }
    
    return info;
},

validateDataBeforeSending() {
    const data = this.getDisplayedValues();
    
    // التحقق من وجود السعر النهائي
    if (!data.finalPrice || data.finalPrice <= 0) {
        console.error('السعر النهائي غير صحيح');
        return false;
    }
    
    // التحقق من طريقة الدفع
    if (!data.paymentMethod) {
        console.error('لم يتم اختيار طريقة الدفع');
        return false;
    }
    
    // طباعة البيانات للتأكد
    console.log('البيانات المرسلة:', data);
    
    return true;
},
    
    getGroupData() {
    if (this.selectedGroup === null) return null;
    const group = this.courseData.groupDiscounts[this.selectedGroup];
    return {
        name: group.name,
        minSize: group.minSize,
        percentage: group.percentage
    };
},

getGiftData() {
    const data = {
        type: this.selectedGift
    };
    
    if (this.selectedGift === 'voucher') {
        data.voucherAmount = parseInt(document.getElementById('voucherAmount')?.value) || 0;
    } else if (this.selectedGift === 'specific') {
        data.recipientName = document.getElementById('giftRecipientName')?.value || '';
    }
    
    return data;
},
    
    handleGiftAction(total) {
        const giftType = this.selectedGift;
        
        if (giftType === 'specific') {
            this.handleSpecificGift(total);
        } else if (giftType === 'anonymous') {
            this.handleAnonymousGift(total);
        } else if (giftType === 'voucher') {
            this.handleVoucherGift();
        }
    },
    
    handleSpecificGift(total) {
        const recipientName = document.getElementById('giftRecipientName').value;
        const gifterName = document.getElementById('gifterName').value || 'مجهول';
        const revealName = document.getElementById('revealGifterName').checked;
        const message = document.getElementById('giftMessage').value;
        
        if (!recipientName) {
            Swal.fire({
                title: 'تنبيه',
                text: 'الرجاء إدخال اسم المستفيد من الهدية',
                icon: 'warning',
                background: '#152238',
                color: '#fff'
            });
            return;
        }
        
        Swal.fire({
            title: 'تأكيد الإهداء',
            html: `
                <div style="text-align: right;">
                    <p><strong>نوع الهدية:</strong> رحلة كاملة</p>
                    <p><strong>المستفيد:</strong> ${recipientName}</p>
                    <p><strong>من:</strong> ${revealName ? gifterName : 'مُهدي كريم'}</p>
                    <p><strong>القيمة:</strong> ${total}</p>
                    ${message ? `<p><strong>رسالة:</strong> ${message}</p>` : ''}
                    <hr>
                    <p>سيتم إرسال بطاقة هدية إلكترونية للمستفيد</p>
                </div>
            `,
            icon: 'gift',
            showCancelButton: true,
            confirmButtonText: 'تأكيد الإهداء',
            cancelButtonText: 'إلغاء',
            confirmButtonColor: '#EC4899',
            background: '#152238',
            color: '#fff'
        }).then((result) => {
            if (result.isConfirmed) {
                // معالجة الإهداء
                console.log('معالجة الإهداء...');
                
                Swal.fire({
                    title: 'تم الإهداء بنجاح!',
                    html: `
                        <p>سيتم إرسال بطاقة الهدية إلى ${recipientName}</p>
                        <p>شكراً لك على هذه اللفتة الكريمة</p>
                    `,
                    icon: 'success',
                    background: '#152238',
                    color: '#fff'
                });
            }
        });
    },
    
    handleAnonymousGift(total) {
        const gifterName = document.getElementById('gifterName').value || 'محسن كريم';
        const message = document.getElementById('giftMessage').value;
        
        Swal.fire({
            title: 'هدية مجهولة',
            html: `
                <div style="text-align: right;">
                    <p><strong>نوع الهدية:</strong> رحلة كاملة لمحتاج</p>
                    <p><strong>القيمة:</strong> ${total}</p>
                    <p><strong>المُهدي:</strong> ${gifterName}</p>
                    ${message ? `<p><strong>رسالتك:</strong> ${message}</p>` : ''}
                    <hr>
                    <p>سنختار أحد المحتاجين من مجتمعنا وسنرسل لك تقرير عن المستفيد</p>
                </div>
            `,
            icon: 'heart',
            showCancelButton: true,
            confirmButtonText: 'تأكيد المساهمة',
            cancelButtonText: 'إلغاء',
            confirmButtonColor: '#22C55E',
            background: '#152238',
            color: '#fff'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'شكراً لك!',
                    html: `
                        <p>مساهمتك ستغير حياة شخص ما</p>
                        <p>سنرسل لك تقرير عن المستفيد قريباً</p>
                    `,
                    icon: 'success',
                    background: '#152238',
                    color: '#fff'
                });
            }
        });
    },
    
    handleVoucherGift() {
    const amount = parseInt(document.getElementById('voucherAmount').value) || 0;
    const gifterName = document.getElementById('gifterName')?.value || 'محسن كريم';
    const message = document.getElementById('giftMessage')?.value || '';
    
    if (!amount || amount < 50) {
        Swal.fire({
            title: 'تنبيه',
            text: 'الحد الأدنى للمساهمة 50 ج.م',
            icon: 'warning',
            confirmButtonColor: '#FFD700'
        });
        return;
    }
    
    // نافذة تأكيد مختلفة للقسيمة
    Swal.fire({
        title: '💝 تأكيد قسيمة الدعم',
        html: `
            <div style="text-align: right; direction: rtl;">
                <div style="background: linear-gradient(135deg, #D1FAE5, #DBEAFE); 
                            padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                    <h3 style="color: #065F46; margin-bottom: 15px;">
                        <i class="fas fa-hand-holding-heart"></i> بياناتك الكريمة
                    </h3>
                    
                    <div style="margin: 15px 0;">
                        <label style="color: #065F46; font-weight: bold;">اسمك الكريم:</label>
                        <input type="text" id="confirmGifterName" value="${gifterName}" 
                               style="width: 100%; padding: 10px; border: 2px solid #22C55E; 
                                      border-radius: 8px; margin-top: 5px; font-size: 1rem;">
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label style="color: #065F46; font-weight: bold;">رقم الواتساب (اختياري):</label>
                        <input type="text" id="confirmPhone" placeholder="01xxxxxxxxx" 
                               style="width: 100%; padding: 10px; border: 2px solid #22C55E; 
                                      border-radius: 8px; margin-top: 5px; font-size: 1rem; direction: ltr;">
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label style="color: #065F46; font-weight: bold;">رسالتك (اختياري):</label>
                        <textarea id="confirmMessage" rows="3" 
                                  style="width: 100%; padding: 10px; border: 2px solid #22C55E; 
                                         border-radius: 8px; margin-top: 5px; font-size: 1rem;">${message}</textarea>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 10px; 
                                border-right: 4px solid #FFD700;">
                        <p style="margin: 0; font-size: 1.1rem;">
                            <strong>قيمة دعمك:</strong> 
                            <span style="color: #22C55E; font-size: 1.5rem; font-weight: bold;">
                                ${amount.toLocaleString('ar-EG')} ج.م
                            </span>
                        </p>
                    </div>
                </div>
                
                <div style="background: #FEF2F2; padding: 15px; border-radius: 10px; 
                            border-right: 3px solid #E11D48;">
                    <p style="color: #991B1B; margin: 0;">
                        <i class="fas fa-info-circle"></i>
                        بالضغط على "تأكيد المساهمة" سيتم توجيهك لصفحة إتمام الدفع
                    </p>
                </div>
            </div>
        `,
        icon: 'heart',
        showCancelButton: true,
        confirmButtonText: '✨ تأكيد المساهمة',
        cancelButtonText: 'رجوع',
        confirmButtonColor: '#22C55E',
        cancelButtonColor: '#6b7280',
        width: '600px',
        customClass: {
            popup: 'swal-rtl'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            // جمع البيانات النهائية
            const finalData = {
                type: 'voucher_donation',
                amount: amount,
                gifterName: document.getElementById('confirmGifterName').value,
                phone: document.getElementById('confirmPhone').value,
                message: document.getElementById('confirmMessage').value,
                timestamp: new Date().toISOString()
            };
            
            // حفظ البيانات
            localStorage.setItem('voucherData', JSON.stringify(finalData));
            
            // رسالة نجاح
            Swal.fire({
                title: '🌟 أنت نجم مضيء!',
                html: `
                    <p style="font-size: 1.2em;">شكراً لك من القلب</p>
                    <p>جاري توجيهك لإتمام المساهمة...</p>
                `,
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            }).then(() => {
                // الانتقال لصفحة الدفع
                window.location.href = `booking-page.html?type=voucher&amount=${amount}`;
            });
        }
    });
},
    
    handleGrantRequest() {
    Swal.fire({
        title: '🤲 هل تحتاج دعم إضافي؟',
        html: `
            <div style="text-align: right;">
                <p style="margin-bottom: 20px;">نحن هنا لمساعدتك! يمكننا توفير:</p>
                <ul style="text-align: right; margin: 20px 0; line-height: 2;">
                    <li>💰 <strong>منحة جزئية:</strong> خصم 50-75%</li>
                    <li>📅 <strong>تقسيط مريح:</strong> يصل لـ 24 شهر</li>
                    <li>🎁 <strong>منحة كاملة:</strong> 100% مجاناً</li>
                </ul>
                <p style="background: rgba(34, 197, 94, 0.1); padding: 15px; border-radius: 10px; margin: 20px 0;">
                    <strong>💚 لا نجعل المال عائقاً لرحلة التعلم</strong><br>
                    سنتواصل معك خلال 24 ساعة لمناقشة الخيارات المناسبة
                </p>
            </div>
        `,
        icon: 'heart',
        showCancelButton: true,
        confirmButtonText: '📝 تقدم للحصول على دعم',
        cancelButtonText: 'إلغاء',
        confirmButtonColor: '#22C55E',
        cancelButtonColor: '#6b7280',
        background: '#152238',
        color: '#fff'
    }).then((result) => {
        if (result.isConfirmed) {
            // إعداد بيانات طلب المنحة
            const grantData = {
                type: 'grant',
                courseId: this.courseData?.courseId || 'default',
                courseName: this.courseData?.title || 'الدورة المختارة',
                originalPrice: this.courseData?.price || 0,
                currentCalculation: this.getDisplayedValues(),
                requestSource: 'calculator_page'
            };
            
            // الانتقال لصفحة طلب المنحة
            const params = new URLSearchParams();
            params.append('data', encodeURIComponent(JSON.stringify(grantData)));
            window.location.href = `booking-page.html?${params.toString()}`;
        }
    });
},
    cleanupOldCode() {
    // إزالة المراجع القديمة
    const oldElements = [
        'V3-end-placeholder',
        'undefined-elements',
        'test-button-old'
    ];
    
    oldElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.remove();
            console.log(`تم إزالة العنصر القديم: ${id}`);
        }
    });
},
    // دالة حفظ مباشر في Firebase
saveToFirebase: async function() {
    console.log('💾 حفظ في Firebase...');
    
    const bookingData = {
        // معلومات الرحلة
        journeyType: this.selectedJourney,
        journeyText: document.querySelector('.journey-option.active span')?.innerText || '',
        
        // الأسعار
        basePrice: parseInt(document.getElementById('calcBase')?.innerText?.replace(/[^\d]/g, '')) || 0,
        finalPrice: parseInt(document.getElementById('calcTotal')?.innerText?.replace(/[^\d]/g, '')) || 0,
        
        // طريقة الدفع
        paymentMethod: document.querySelector('.payment-card.active')?.dataset.payment || '',
        paymentText: document.querySelector('.payment-card.active h6')?.innerText || '',
        
        // معلومات إضافية
        timestamp: new Date().toISOString(),
        status: 'pending',
        source: 'calculator'
    };
    
    // للمجموعات
    if (this.selectedJourney === 'group' && this.selectedGroup !== null) {
        const group = this.courseData.groupDiscounts[this.selectedGroup];
        bookingData.groupInfo = {
            name: group.name,
            size: group.minSize,
            discount: group.percentage
        };
    }
    
    // للإهداء
    if (this.selectedJourney === 'gift') {
        bookingData.giftType = this.selectedGift;
        if (this.selectedGift === 'voucher') {
            bookingData.voucherAmount = parseInt(document.getElementById('voucherAmount')?.value) || 0;
        }
    }
    
    // للكوبون
    if (this.appliedCoupon) {
        bookingData.coupon = {
            code: this.appliedCoupon.code,
            type: this.appliedCoupon.type,
            value: this.appliedCoupon.value
        };
    }
    
    try {
        const docRef = await db.collection('tempBookings').add(bookingData);
        console.log('✅ تم الحفظ:', docRef.id);
        
        // الانتقال مباشرة
        window.location.href = `booking-page.html?bookingId=${docRef.id}`;
        
    } catch (error) {
        console.error('❌ خطأ:', error);
        alert('حدث خطأ في الحفظ. حاول مرة أخرى.');
    }
},
};
        
        
        // Data collection functions
        window.collectCompleteData = function() {
            
    console.log('🔍 جمع كل البيانات التفصيلية...');
    
    const fullData = {
        // معلومات الوقت
        timestamp: new Date().toISOString(),
        // اسم الدورة
        courseName: getCurrentCourseName(),
        courseId: new URLSearchParams(window.location.search).get('course') || 'unknown',
        // 1. الأسعار الكاملة
        pricing: {
            basePrice: document.getElementById('calcBase')?.innerText || '0',
            basePriceNumber: parseInt(document.getElementById('calcBase')?.innerText?.replace(/[^\d]/g, '')) || 0,
            finalPrice: document.getElementById('calcTotal')?.innerText || '0',
            finalPriceNumber: parseInt(document.getElementById('calcTotal')?.innerText?.replace(/[^\d]/g, '')) || 0,
        },

               
        // 2. كل الخصومات بالتفصيل
        discounts: [],
        
        // 3. العرض الزمني النشط
        activeOffer: null,
        
        // 4. طريقة الدفع الكاملة
        payment: {
            method: null,
            code: null,
            installmentDetails: null,
            installmentHTML: null
        },
        
        // 5. نوع الرحلة
        journey: {
            type: null,
            text: null,
            groupName: null,
            groupSize: null,
            groupDiscount: null
        },
        
        // 6. كود الخصم
        coupon: {
            code: null,
            applied: false,
            discount: null
        }
    };
    
    // جمع الخصومات بالتفصيل
    if (document.getElementById('calcTimeDiscountRow').style.display !== 'none') {
        const timeDiscountLabel = document.getElementById('calcTimeDiscountLabel')?.innerText || '';
        const timeDiscountValue = document.getElementById('calcTimeDiscount')?.innerText || '';
        
        fullData.discounts.push({
            type: 'time',
            label: timeDiscountLabel,
            value: timeDiscountValue,
            amount: parseInt(timeDiscountValue.replace(/[^\d]/g, '')) || 0
        });
        
        // استخراج معلومات العرض الزمني
        const activeOfferEl = document.getElementById('activeOfferName');
        const activeDiscountEl = document.getElementById('activeOfferDiscount');
        if (activeOfferEl) {
            fullData.activeOffer = {
                name: activeOfferEl.innerText,
                discount: activeDiscountEl?.innerText || '',
                // محاولة الحصول على تاريخ الانتهاء
                endDate: window.currentCourseData?.discounts?.find(d => d.name === activeOfferEl.innerText)?.endDate || null
            };
        }
    }
    
    if (document.getElementById('calcGroupDiscountRow').style.display !== 'none') {
        const groupValue = document.getElementById('calcGroupDiscount')?.innerText || '';
        fullData.discounts.push({
            type: 'group',
            label: 'خصم المجموعة',
            value: groupValue,
            amount: parseInt(groupValue.replace(/[^\d]/g, '')) || 0
        });
        
        // جمع معلومات المجموعة
        const activeGroupCard = document.querySelector('.group-card.active');
        if (activeGroupCard) {
            fullData.journey.groupName = activeGroupCard.querySelector('h5')?.innerText || '';
            fullData.journey.groupSize = activeGroupCard.querySelector('.size')?.innerText || '';
            fullData.journey.groupDiscount = activeGroupCard.querySelector('.discount')?.innerText || '';
        }
    }
    
    if (document.getElementById('calcCashDiscountRow').style.display !== 'none') {
        const cashValue = document.getElementById('calcCashDiscount')?.innerText || '';
        fullData.discounts.push({
            type: 'cash',
            label: 'خصم الدفع الكامل',
            value: cashValue,
            amount: parseInt(cashValue.replace(/[^\d]/g, '')) || 0
        });
    }
    
    if (document.getElementById('calcCouponDiscountRow').style.display !== 'none') {
        const couponValue = document.getElementById('calcCouponDiscount')?.innerText || '';
        const couponCode = document.getElementById('calcCoupon')?.value || '';
        
        fullData.discounts.push({
            type: 'coupon',
            label: `كود الخصم (${couponCode})`,
            value: couponValue,
            amount: parseInt(couponValue.replace(/[^\d]/g, '')) || 0
        });
        
        fullData.coupon = {
            code: couponCode,
            applied: true,
            discount: couponValue
        };
    }
    
    // جمع طريقة الدفع بالتفصيل
    const activePayment = document.querySelector('.payment-card.active');
    if (activePayment) {
        fullData.payment.method = activePayment.querySelector('h6')?.innerText || '';
        fullData.payment.code = activePayment.dataset.payment || '';
        
        // جمع تفاصيل الأقساط
        const installmentSection = document.getElementById('calcInstallmentDetails');
        if (installmentSection && installmentSection.style.display !== 'none') {
            const installmentPlan = document.getElementById('calcInstallmentPlan');
            fullData.payment.installmentDetails = installmentPlan?.innerText || '';
            fullData.payment.installmentHTML = installmentPlan?.innerHTML || '';
        }
    }
    
    // جمع نوع الرحلة
    const activeJourney = document.querySelector('.journey-option.active');
    if (activeJourney) {
        fullData.journey.type = activeJourney.dataset.journey || '';
        fullData.journey.text = activeJourney.querySelector('span')?.innerText || '';
    }
    
   // حساب إجمالي التوفير بطريقة صحيحة
// أولاً: نحصل على الأرقام الصحيحة
// حساب إجمالي التوفير - النسخة الصحيحة
let baseNumber = 0;
let finalNumber = 0;

// دالة لتحويل الأرقام العربية للإنجليزية
function convertArabicNumbers(str) {
    const arabicNumbers = ['٠','١','٢','٣','٤','٥','٦','٧','٨','٩'];
    const englishNumbers = ['0','1','2','3','4','5','6','7','8','9'];
    
    let result = str;
    for (let i = 0; i < arabicNumbers.length; i++) {
        result = result.replace(new RegExp(arabicNumbers[i], 'g'), englishNumbers[i]);
    }
    return result;
}

// استخراج السعر الأساسي
const baseText = document.getElementById('calcBase')?.innerText || '0';
const baseTextEnglish = convertArabicNumbers(baseText);
const baseNumbers = baseTextEnglish.replace(/[^\d]/g, '');
baseNumber = parseInt(baseNumbers) || 0;

// استخراج السعر النهائي
const finalText = document.getElementById('calcTotal')?.innerText || '0';
const finalTextEnglish = convertArabicNumbers(finalText);
const finalNumbers = finalTextEnglish.replace(/[^\d]/g, '');
finalNumber = parseInt(finalNumbers) || 0;

// حساب التوفير
fullData.totalSavings = baseNumber - finalNumber;
fullData.totalSavingsText = fullData.totalSavings > 0 ? 
    fullData.totalSavings.toLocaleString('ar-EG') + ' ج.م' : 
    '0 ج.م';

// تحديث الأرقام في البيانات
fullData.pricing.basePriceNumber = baseNumber;
fullData.pricing.finalPriceNumber = finalNumber;

console.log('💰 حساب التوفير الصحيح:', {
    'النص الأساسي': baseText,
    'النص النهائي': finalText,
    'الرقم الأساسي': baseNumber,
    'الرقم النهائي': finalNumber,
    'التوفير': fullData.totalSavings
});
    return fullData;
};
        
        
       window.showAllData = function() {
        // تأكد من وجود الصندوق أولاً
    if (!document.getElementById('dataDisplayBox')) {
        createDataDisplay();
    }

        const data = collectCompleteData();
    
    // الآن احصل على العناصر
    const displayBox = document.getElementById('dataDisplayBox');
    const content = document.getElementById('dataContent');
    
    // تحقق من وجود العناصر
    if (!displayBox || !content) {
        console.error('❌ الصندوق أو المحتوى غير موجود');
        // أنشئ الصندوق وحاول مرة أخرى
        createDataDisplay();
        setTimeout(() => showAllData(), 100);
        return;
    }
    
    
    // HTML محسّن بدون أخطاء
    let htmlContent = '';

        // قسم اسم الدورة - جديد
    htmlContent += `
        <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #FFD700, #FFA500); border-radius: 10px;">
            <h3 style="color: #0A1628; margin: 0;">
                <i class="fas fa-book"></i> الدورة المختارة
            </h3>
            <p style="color: #152238; margin: 10px 0 0 0; font-size: 1.3rem; font-weight: bold;">
                ${data.courseName || getCurrentCourseName()}
            </p>
        </div>
    `;
    

// قسم الأسعار
    htmlContent += `
        <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px;">
            <h3 style="color: #FFD700;">💰 الأسعار:</h3>
            <p><strong>السعر الأساسي:</strong> ${data.pricing.basePrice}</p>
            <p><strong>السعر النهائي:</strong> <span style="color: #22C55E; font-size: 1.2em;">${data.pricing.finalPrice}</span></p>
            <p><strong>إجمالي التوفير:</strong> <span style="color: #E11D48;">${data.totalSavingsText || (data.totalSavings + ' ج.م')}</span></p>
        </div>
    `;
    
    // قسم العرض الزمني
    if (data.activeOffer) {
        htmlContent += `
            <div style="margin-bottom: 20px; padding: 15px; background: #FFF3CD; border-radius: 10px;">
                <h3 style="color: #F97316;">⏰ العرض الزمني النشط:</h3>
                <p><strong>اسم العرض:</strong> ${data.activeOffer.name}</p>
                <p><strong>نسبة الخصم:</strong> ${data.activeOffer.discount}</p>
                ${data.activeOffer.endDate ? '<p><strong>ينتهي في:</strong> ' + new Date(data.activeOffer.endDate).toLocaleDateString('ar-EG') + '</p>' : ''}
            </div>
        `;
    }
    
    // قسم الخصومات
    htmlContent += `
        <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px;">
            <h3 style="color: #22C55E;">🎁 الخصومات المفعلة (${data.discounts.length}):</h3>
    `;
    
    if (data.discounts.length > 0) {
        data.discounts.forEach(d => {
            htmlContent += `
                <div style="border-right: 3px solid #22C55E; padding-right: 10px; margin: 10px 0;">
                    <p><strong>${d.label}:</strong> ${d.value}</p>
                </div>
            `;
        });
    } else {
        htmlContent += '<p>لا توجد خصومات مفعلة</p>';
    }
    htmlContent += '</div>';
    
    // قسم طريقة الدفع
    htmlContent += `
        <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px;">
            <h3 style="color: #3B82F6;">💳 طريقة الدفع:</h3>
            <p><strong>الطريقة:</strong> ${data.payment.method || 'غير محدد'}</p>
    `;
    
    if (data.payment.installmentDetails) {
        htmlContent += `
            <div style="background: #E0F2FE; padding: 10px; border-radius: 5px; margin-top: 10px;">
                <strong>تفاصيل الأقساط:</strong><br>
                ${data.payment.installmentHTML}
            </div>
        `;
    }
    htmlContent += '</div>';
    
    // قسم نوع الرحلة
    htmlContent += `
        <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px;">
            <h3 style="color: #9333EA;">🚀 نوع الرحلة:</h3>
            <p><strong>النوع:</strong> ${data.journey.text || 'غير محدد'}</p>
    `;
    
    if (data.journey.groupName) {
        htmlContent += `
            <div style="background: #F3E8FF; padding: 10px; border-radius: 5px; margin-top: 10px;">
                <p><strong>اسم المجموعة:</strong> ${data.journey.groupName}</p>
                <p><strong>حجم المجموعة:</strong> ${data.journey.groupSize}</p>
                <p><strong>نسبة الخصم:</strong> ${data.journey.groupDiscount}</p>
            </div>
        `;
    }
    htmlContent += '</div>';
    
    // قسم كود الخصم
    if (data.coupon.code) {
        htmlContent += `
            <div style="margin-bottom: 20px; padding: 15px; background: #FEF2F2; border-radius: 10px;">
                <h3 style="color: #EC4899;">🎟️ كود الخصم:</h3>
                <p><strong>الكود:</strong> <code style="background: #333; color: #FFD700; padding: 5px 10px; border-radius: 5px;">${data.coupon.code}</code></p>
                <p><strong>قيمة الخصم:</strong> ${data.coupon.discount}</p>
            </div>
        `;
    }
    
    // الملخص النهائي
    htmlContent += `
        <div style="background: #D1FAE5; padding: 15px; border-radius: 10px; margin-top: 20px;">
            <h4>✅ كل البيانات جاهزة للنقل</h4>
            <p style="margin: 10px 0;">عدد العناصر المجمعة: <strong>${data.discounts.length + 3}</strong> عنصر</p>
        </div>
    `;
    
    // وضع المحتوى في الصندوق
    content.innerHTML = htmlContent;
    
    // عرض الصندوق
    displayBox.style.display = 'block';
    
    // حفظ البيانات
    window.fullBookingData = data;
    localStorage.setItem('fullBookingData', JSON.stringify(data));
    
    console.log('✅ كل البيانات التفصيلية:', data);
    
    return data;
};

        
        window.proceedToBooking = async function(event) {
    console.log('🚀 بدء حفظ البيانات في Firebase...');
    
    // جمع البيانات المجمعة
    const data = window.fullBookingData || collectCompleteData();
    
    if (!data) {
        alert('⚠️ لا توجد بيانات للنقل');
        return;
    }
    
    // حفظ مرجع للزر
    const proceedBtn = event?.target;
    if (proceedBtn) {
        proceedBtn.disabled = true;
        proceedBtn.textContent = 'جاري المعالجة...';
    }
    
    // إخفاء الصندوق الأول مباشرة
    const dataDisplayBox = document.getElementById('dataDisplayBox');
    if (dataDisplayBox) {
        dataDisplayBox.style.display = 'none';
    }
    
    // تأخير بسيط لضمان إغلاق الصندوق الأول
    setTimeout(() => {
        // تحديد نوع الرحلة
        const journeyType = smartCalculator.selectedJourney;
        
        // بناءً على نوع الرحلة، اطلب البيانات الشخصية
        if (journeyType === 'individual') {
            // حجز فردي - اطلب البيانات
            showIndividualDataForm(data, proceedBtn);
        } else if (journeyType === 'group') {
            // حجز جماعي - اطلب بيانات المجموعة
            showGroupDataForm(data, proceedBtn);
        } else if (journeyType === 'gift') {
            // إهداء - اطلب بيانات الإهداء
            showGiftDataForm(data, proceedBtn);
        } else {
            // حفظ مباشر للحالات الأخرى
            saveToFirebaseDirectly(data, proceedBtn);
        }
    }, 300); // تأخير 300 ميللي ثانية
};


// 4. التهيئة عند التحميل
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        createDataDisplay();
        console.log('✅ النظام جاهز');
    }, 1000);
});

window.proceedToBooking = function() {
    const data = window.fullBookingData;
    if (!data) {
        alert('لا توجد بيانات للنقل');
        return;
    }
    
    console.log('🚀 نقل البيانات...');
    localStorage.setItem('finalBookingData', JSON.stringify(data));
    
    // أغلق الصندوق
    document.getElementById('dataDisplayBox').style.display = 'none';
    
    // انتقل للصفحة
    setTimeout(() => {
        window.location.href = 'booking-page.html';
    }, 1000);
};
            // نفس الكود
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadCourseData();
            setTimeout(() => {
                smartCalculator.init();
            }, 1000);
        });

// دالة للإهداء
function showGiftDataForm(existingData, proceedBtn) {
    // تحديد نوع الإهداء
    const giftType = smartCalculator.selectedGift;
    
    if (giftType === 'specific') {
        // إهداء لشخص محدد
        showSpecificGiftForm(existingData, proceedBtn);
    } else if (giftType === 'anonymous') {
        // إهداء لشخص مستحق
        showAnonymousGiftForm(existingData, proceedBtn);
    } else {
        // حالة أخرى - حفظ مباشر
        saveToFirebaseDirectly(existingData, proceedBtn);
    }
}
        // دالة إهداء لشخص محدد
function showSpecificGiftForm(existingData, proceedBtn) {
    const courseName = existingData.courseName || getCurrentCourseName();
    const finalPrice = existingData.pricing?.finalPrice || '0';
    
    Swal.fire({
        title: '🎁 إهداء الرحلة لشخص تعرفه',
        html: `
            <div style="text-align: right; direction: rtl;">
                <!-- معلومات الدورة -->
                <div style="background: linear-gradient(135deg, #EC4899, #F97316); 
                            padding: 15px; border-radius: 10px; margin-bottom: 20px; color: white;">
                    <h4 style="margin: 0;">
                        <i class="fas fa-gift"></i> ${courseName}
                    </h4>
                    <p style="margin: 5px 0;">قيمة الهدية: <strong>${finalPrice}</strong></p>
                </div>
                
                <!-- بيانات المُهدي -->
                <div style="background: #FFF5F5; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <h4 style="color: #EC4899; margin-bottom: 15px;">
                        <i class="fas fa-user"></i> بياناتك (المُهدي)
                    </h4>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #374151;">
                            اسمك الكامل <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="gifterName" placeholder="اسمك الثلاثي"
                               style="width: 100%; padding: 8px; border: 2px solid #EC4899; 
                                      border-radius: 8px;">
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #374151;">
                            رقم واتسابك <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="gifterPhone" placeholder="01xxxxxxxxx"
                               style="width: 100%; padding: 8px; border: 2px solid #EC4899; 
                                      border-radius: 8px; direction: ltr;">
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #374151;">
                            <input type="checkbox" id="revealName" checked>
                            إظهار اسمي للمُهدى إليه
                        </label>
                    </div>
                </div>
                
                <!-- بيانات المُهدى إليه -->
                <div style="background: #F0FDF4; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <h4 style="color: #22C55E; margin-bottom: 15px;">
                        <i class="fas fa-user-check"></i> بيانات المُهدى إليه
                    </h4>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #374151;">
                            اسم المُهدى إليه <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="recipientName" placeholder="الاسم الثلاثي"
                               style="width: 100%; padding: 8px; border: 2px solid #22C55E; 
                                      border-radius: 8px;">
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #374151;">
                            رقم واتساب المُهدى إليه <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="recipientPhone" placeholder="01xxxxxxxxx"
                               style="width: 100%; padding: 8px; border: 2px solid #22C55E; 
                                      border-radius: 8px; direction: ltr;">
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #374151;">
                            بريده الإلكتروني (اختياري)
                        </label>
                        <input type="email" id="recipientEmail" placeholder="example@email.com"
                               style="width: 100%; padding: 8px; border: 2px solid #22C55E; 
                                      border-radius: 8px; direction: ltr;">
                    </div>
                </div>
                
                <!-- رسالة الإهداء -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #374151;">
                        <i class="fas fa-envelope"></i> رسالة إهداء (اختياري)
                    </label>
                    <textarea id="giftMessage" rows="3" 
                              placeholder="رسالتك للمُهدى إليه..."
                              style="width: 100%; padding: 8px; border: 2px solid #FFD700; 
                                     border-radius: 8px;"></textarea>
                </div>
                
                <div style="background: #FEF2F2; padding: 10px; border-radius: 8px;">
                    <p style="color: #991B1B; margin: 0; font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i>
                        سيتم إرسال بطاقة هدية إلكترونية للمُهدى إليه عبر الواتساب
                    </p>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '✅ تأكيد الإهداء',
        cancelButtonText: 'رجوع',
        confirmButtonColor: '#EC4899',
        width: '700px',
        allowOutsideClick: false,
        allowEscapeKey: false,
        preConfirm: () => {
            const gifterName = document.getElementById('gifterName').value;
            const gifterPhone = document.getElementById('gifterPhone').value;
            const recipientName = document.getElementById('recipientName').value;
            const recipientPhone = document.getElementById('recipientPhone').value;
            
            if (!gifterName || !gifterPhone || !recipientName || !recipientPhone) {
                Swal.showValidationMessage('من فضلك أكمل البيانات المطلوبة');
                return false;
            }
            
            if (!/^01[0-9]{9}$/.test(gifterPhone) || !/^01[0-9]{9}$/.test(recipientPhone)) {
                Swal.showValidationMessage('تأكد من صحة أرقام الواتساب');
                return false;
            }
            
            return true;
        }
    }).then(async (result) => {
        if (result.isConfirmed) {
            // دمج بيانات الإهداء
            existingData.giftInfo = {
                type: 'specific',
                gifter: {
                    name: document.getElementById('gifterName').value,
                    phone: document.getElementById('gifterPhone').value,
                    revealName: document.getElementById('revealName').checked
                },
                recipient: {
                    name: document.getElementById('recipientName').value,
                    phone: document.getElementById('recipientPhone').value,
                    email: document.getElementById('recipientEmail').value || ''
                },
                message: document.getElementById('giftMessage').value || '',
                courseName: courseName
            };
            
            // التأكد من وجود اسم الدورة
            if (!existingData.courseName) {
                existingData.courseName = courseName;
            }
            
            // حفظ في Firebase
            await saveToFirebaseDirectly(existingData, proceedBtn);
        } else {
            // إعادة إظهار الصندوق الأول
            const dataDisplayBox = document.getElementById('dataDisplayBox');
            if (dataDisplayBox) {
                dataDisplayBox.style.display = 'block';
            }
            
            if (proceedBtn) {
                proceedBtn.disabled = false;
                proceedBtn.textContent = '✅ نقل البيانات والمتابعة';
            }
        }
    });
}
        // دالة إهداء لشخص مستحق (مجهول)
function showAnonymousGiftForm(existingData, proceedBtn) {
    const courseName = existingData.courseName || getCurrentCourseName();
    const finalPrice = existingData.pricing?.finalPrice || '0';
    
    Swal.fire({
        title: '💝 إهداء لشخص يستحق',
        html: `
            <div style="text-align: right; direction: rtl;">
                <!-- معلومات الدورة -->
                <div style="background: linear-gradient(135deg, #22C55E, #14B8A6); 
                            padding: 15px; border-radius: 10px; margin-bottom: 20px; color: white;">
                    <h4 style="margin: 0;">
                        <i class="fas fa-heart"></i> ${courseName}
                    </h4>
                    <p style="margin: 5px 0;">قيمة الهدية: <strong>${finalPrice}</strong></p>
                </div>
                
                <!-- رسالة شكر -->
                <div style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(20,184,166,0.1)); 
                            padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                    <i class="fas fa-hands-helping" style="font-size: 3rem; color: #22C55E; margin-bottom: 10px;"></i>
                    <h3 style="color: #065F46; margin-bottom: 10px;">أنت تصنع الفرق!</h3>
                    <p style="color: #047857; margin: 0;">
                        سنختار أحد المحتاجين من مجتمعنا وسنرسل لك تقرير عن المستفيد
                    </p>
                </div>
                
                <!-- بيانات المُهدي -->
                <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #22C55E;">
                    <h4 style="color: #065F46; margin-bottom: 15px;">
                        <i class="fas fa-user-heart"></i> بياناتك الكريمة
                    </h4>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 5px; color: #374151;">
                            اسمك الكامل <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="anonymousGifterName" placeholder="اسمك الثلاثي"
                               style="width: 100%; padding: 10px; border: 2px solid #22C55E; 
                                      border-radius: 8px;">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 5px; color: #374151;">
                            رقم واتسابك <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="anonymousGifterPhone" placeholder="01xxxxxxxxx"
                               style="width: 100%; padding: 10px; border: 2px solid #22C55E; 
                                      border-radius: 8px; direction: ltr;">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 5px; color: #374151;">
                            بريدك الإلكتروني
                        </label>
                        <input type="email" id="anonymousGifterEmail" placeholder="example@email.com"
                               style="width: 100%; padding: 10px; border: 2px solid #22C55E; 
                                      border-radius: 8px; direction: ltr;">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 5px; color: #374151;">
                            <i class="fas fa-comment-dots"></i> رسالة للمستفيد (اختياري)
                        </label>
                        <textarea id="anonymousMessage" rows="3" 
                                  placeholder="رسالتك التحفيزية للمستفيد..."
                                  style="width: 100%; padding: 10px; border: 2px solid #22C55E; 
                                         border-radius: 8px;"></textarea>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="color: #065F46;">
                            <input type="checkbox" id="anonymousOption" checked>
                            <strong>أريد أن تبقى هديتي مجهولة للمستفيد</strong>
                        </label>
                    </div>
                </div>
                
                <div style="background: #F0FDF4; padding: 15px; border-radius: 10px; margin-top: 15px;">
                    <p style="color: #065F46; margin: 0; text-align: center;">
                        <i class="fas fa-certificate"></i>
                        <strong>ستحصل على شهادة شكر وتقرير عن المستفيد</strong>
                    </p>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '✅ تأكيد المساهمة الكريمة',
        cancelButtonText: 'رجوع',
        confirmButtonColor: '#22C55E',
        width: '650px',
        allowOutsideClick: false,
        allowEscapeKey: false,
        preConfirm: () => {
            const name = document.getElementById('anonymousGifterName').value;
            const phone = document.getElementById('anonymousGifterPhone').value;
            
            if (!name || !phone) {
                Swal.showValidationMessage('من فضلك أكمل البيانات المطلوبة');
                return false;
            }
            
            if (!/^01[0-9]{9}$/.test(phone)) {
                Swal.showValidationMessage('رقم الواتساب غير صحيح');
                return false;
            }
            
            return true;
        }
    }).then(async (result) => {
        if (result.isConfirmed) {
            // دمج بيانات الإهداء المجهول
            existingData.giftInfo = {
                type: 'anonymous',
                gifter: {
                    name: document.getElementById('anonymousGifterName').value,
                    phone: document.getElementById('anonymousGifterPhone').value,
                    email: document.getElementById('anonymousGifterEmail').value || '',
                    remainAnonymous: document.getElementById('anonymousOption').checked
                },
                message: document.getElementById('anonymousMessage').value || '',
                courseName: courseName,
                recipientStatus: 'سيتم اختياره من المحتاجين'
            };
            
            // التأكد من وجود اسم الدورة
            if (!existingData.courseName) {
                existingData.courseName = courseName;
            }
            
            // حفظ في Firebase
            await saveToFirebaseDirectly(existingData, proceedBtn);
        } else {
            // إعادة إظهار الصندوق الأول
            const dataDisplayBox = document.getElementById('dataDisplayBox');
            if (dataDisplayBox) {
                dataDisplayBox.style.display = 'block';
            }
            
            if (proceedBtn) {
                proceedBtn.disabled = false;
                proceedBtn.textContent = '✅ نقل البيانات والمتابعة';
            }
        }
    });
}

        // دالة الحفظ النهائي في Firebase
async function saveToFirebaseDirectly(data, proceedBtn) {
    // إظهار رسالة انتظار
    Swal.fire({
        title: 'جاري الحفظ...',
        html: 'يرجى الانتظار قليلاً',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    try {
        // إضافة معلومات إضافية
        data.bookingId = 'BK_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        data.timestamp = new Date().toISOString();
        data.status = 'pending';
        
        console.log('📦 البيانات المرسلة:', data);
        
        // حفظ في Firebase
        const docRef = await db.collection('tempBookings').add(data);
        console.log('✅ تم الحفظ بنجاح، المعرف:', docRef.id);
        
        // رسالة النجاح النهائية مع الخيارات
await Swal.fire({
    icon: 'success',
    title: '🎉 تم حجز مقعدك بنجاح!',
    html: `
        <div style="text-align: center;">
            <div style="background: linear-gradient(135deg, #D1FAE5, #DBEAFE); 
                        padding: 20px; border-radius: 15px; margin: 20px 0;">
                <p style="color: #065F46; font-size: 1.2rem; margin: 10px 0;">
                    <strong>رقم الحجز:</strong> 
                    <span style="color: #22C55E; font-size: 1.3rem;">
                        #${docRef.id.slice(-8).toUpperCase()}
                    </span>
                </p>
                <p style="color: #374151; margin: 10px 0;">
                    تم حفظ كافة بياناتك وسيتم التواصل معك قريباً
                </p>
            </div>
            
            <div style="background: #FEF2F2; padding: 15px; border-radius: 10px; 
                        margin: 20px 0; border-right: 3px solid #E11D48;">
                <p style="color: #991B1B; margin: 0;">
                    <i class="fas fa-info-circle"></i>
                    احتفظ برقم الحجز للمتابعة
                </p>
            </div>
            
            <p style="color: #64748b; margin-top: 20px;">
                ماذا تريد أن تفعل الآن؟
            </p>
        </div>
    `,
    showCancelButton: true,
    confirmButtonText: '🔙 العودة لصفحة الدورة',
    cancelButtonText: '📚 تصفح دورات أخرى',
    confirmButtonColor: '#3B82F6',
    cancelButtonColor: '#9333EA',
    width: '600px',
    allowOutsideClick: false,
    allowEscapeKey: false
}).then((result) => {
    if (result.isConfirmed) {
        // العودة لصفحة الدورة
        const courseName = window.courseName || 'الدورة';
        const courseUrl = `course-discover.html?course=${courseName}`;
        window.location.href = courseUrl;
    } else if (result.dismiss === Swal.DismissReason.cancel) {
        // الذهاب لصفحة الدورات
        window.location.href = 'master.html';
    }
});
        
    } catch (error) {
        console.error('❌ خطأ في الحفظ:', error);
        
        // إظهار رسالة الخطأ
        Swal.fire({
            icon: 'error',
            title: 'خطأ!',
            text: 'حدث خطأ في حفظ البيانات. حاول مرة أخرى.',
            confirmButtonColor: '#E11D48'
        });
        
        // إعادة إظهار الصندوق الأول
        const dataDisplayBox = document.getElementById('dataDisplayBox');
        if (dataDisplayBox) {
            dataDisplayBox.style.display = 'block';
        }
        
        // إعادة تفعيل الزر
        if (proceedBtn) {
            proceedBtn.disabled = false;
            proceedBtn.textContent = '✅ نقل البيانات والمتابعة';
        }
    }
}

        
        // دالة جمع بيانات الحجز الفردي
// دالة جمع بيانات الحجز الفردي
function showIndividualDataForm(existingData, proceedBtn) {
    Swal.fire({
        title: '📋 أكمل بياناتك الشخصية',
        html: `
            <div style="text-align: right; direction: rtl;">
                <div style="background: #F0FDF4; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="color: #065F46; margin: 0;">
                        <i class="fas fa-check-circle"></i>
                        تم حفظ تفاصيل حجزك، نحتاج فقط بياناتك الشخصية
                    </p>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #374151;">
                        الاسم الكامل <span style="color: red;">*</span>
                    </label>
                    <input type="text" id="customerName" placeholder="أدخل اسمك الثلاثي"
                           style="width: 100%; padding: 10px; border: 2px solid #22C55E; 
                                  border-radius: 8px; font-size: 1rem;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #374151;">
                        رقم الواتساب <span style="color: red;">*</span>
                    </label>
                    <input type="text" id="customerPhone" placeholder="01xxxxxxxxx"
                           style="width: 100%; padding: 10px; border: 2px solid #22C55E; 
                                  border-radius: 8px; font-size: 1rem; direction: ltr;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #374151;">
                        البريد الإلكتروني
                    </label>
                    <input type="email" id="customerEmail" placeholder="example@email.com"
                           style="width: 100%; padding: 10px; border: 2px solid #22C55E; 
                                  border-radius: 8px; font-size: 1rem; direction: ltr;">
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '✅ تأكيد وحفظ',
        cancelButtonText: 'رجوع',
        confirmButtonColor: '#22C55E',
        width: '600px',
        allowOutsideClick: false,
        allowEscapeKey: false,
        preConfirm: () => {
            const name = document.getElementById('customerName').value;
            const phone = document.getElementById('customerPhone').value;
            
            if (!name || !phone) {
                Swal.showValidationMessage('من فضلك أكمل البيانات المطلوبة');
                return false;
            }
            
            if (!/^01[0-9]{9}$/.test(phone)) {
                Swal.showValidationMessage('رقم الواتساب غير صحيح');
                return false;
            }
            
            return { name, phone };
        }
    }).then(async (result) => {
        if (result.isConfirmed) {
            // دمج البيانات الشخصية مع البيانات الموجودة
            existingData.customer = {
                name: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                email: document.getElementById('customerEmail').value || ''
            };

                        // التأكد من وجود اسم الدورة
            if (!existingData.courseName) {
                existingData.courseName = getCurrentCourseName();
            }

            // حفظ في Firebase
            await saveToFirebaseDirectly(existingData, proceedBtn);
        } else {
            // المستخدم ضغط رجوع - إعادة إظهار الصندوق الأول
            const dataDisplayBox = document.getElementById('dataDisplayBox');
            if (dataDisplayBox) {
                dataDisplayBox.style.display = 'block';
            }
            
            // إعادة تفعيل الزر
            if (proceedBtn) {
                proceedBtn.disabled = false;
                proceedBtn.textContent = '✅ نقل البيانات والمتابعة';
            }
        }
    });
}

// دالة جمع بيانات المجموعة
// دالة جمع بيانات المجموعة
function showGroupDataForm(existingData, proceedBtn) {
    Swal.fire({
        title: '👥 بيانات المجموعة',
        html: `
            <div style="text-align: right; direction: rtl;">
                <div style="background: #F3E8FF; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="color: #581C87; margin: 0;">
                        <i class="fas fa-users"></i>
                        تم حفظ تفاصيل الحجز الجماعي
                    </p>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #374151;">
                        اسم قائد المجموعة <span style="color: red;">*</span>
                    </label>
                    <input type="text" id="groupLeader" placeholder="الاسم الثلاثي"
                           style="width: 100%; padding: 10px; border: 2px solid #9333EA; 
                                  border-radius: 8px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #374151;">
                        رقم واتساب القائد <span style="color: red;">*</span>
                    </label>
                    <input type="text" id="groupPhone" placeholder="01xxxxxxxxx"
                           style="width: 100%; padding: 10px; border: 2px solid #9333EA; 
                                  border-radius: 8px; direction: ltr;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #374151;">
                        عدد الأفراد <span style="color: red;">*</span>
                    </label>
                    <input type="number" id="groupCount" min="3" value="3"
                           style="width: 100%; padding: 10px; border: 2px solid #9333EA; 
                                  border-radius: 8px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #374151;">
                        أسماء الأفراد (اختياري)
                    </label>
                    <textarea id="groupNames" rows="3" 
                              placeholder="اسم كل فرد في سطر"
                              style="width: 100%; padding: 10px; border: 2px solid #9333EA; 
                                     border-radius: 8px;"></textarea>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '✅ تأكيد حجز المجموعة',
        cancelButtonText: 'رجوع',
        confirmButtonColor: '#9333EA',
        width: '600px',
        allowOutsideClick: false,
        allowEscapeKey: false,
        preConfirm: () => {
            const leader = document.getElementById('groupLeader').value;
            const phone = document.getElementById('groupPhone').value;
            const count = document.getElementById('groupCount').value;
            
            if (!leader || !phone || !count) {
                Swal.showValidationMessage('من فضلك أكمل البيانات المطلوبة');
                return false;
            }
            
            if (!/^01[0-9]{9}$/.test(phone)) {
                Swal.showValidationMessage('رقم الواتساب غير صحيح');
                return false;
            }
            
            if (count < 3) {
                Swal.showValidationMessage('العدد يجب أن يكون 3 أشخاص على الأقل');
                return false;
            }
            
            return true;
        }
    }).then(async (result) => {
        if (result.isConfirmed) {
            // دمج بيانات المجموعة
            existingData.groupInfo = {
                leaderName: document.getElementById('groupLeader').value,
                leaderPhone: document.getElementById('groupPhone').value,
                count: document.getElementById('groupCount').value,
                members: document.getElementById('groupNames').value || ''
            };
                        // التأكد من وجود اسم الدورة
            if (!existingData.courseName) {
                existingData.courseName = getCurrentCourseName();
            }

            // حفظ في Firebase
            await saveToFirebaseDirectly(existingData, proceedBtn);
        } else {
            // المستخدم ضغط رجوع - إعادة إظهار الصندوق الأول
            const dataDisplayBox = document.getElementById('dataDisplayBox');
            if (dataDisplayBox) {
                dataDisplayBox.style.display = 'block';
            }
            
            // إعادة تفعيل الزر
            if (proceedBtn) {
                proceedBtn.disabled = false;
                proceedBtn.textContent = '✅ نقل البيانات والمتابعة';
            }
        }
    });
}
        function getCurrentCourseName() {
    // محاولة 1: من المتغير العام
    if (window.courseName) {
        return window.courseName;
    }
    
    // محاولة 2: من بيانات الدورة
    if (window.currentCourseData && window.currentCourseData.title) {
        return window.currentCourseData.title;
    }
    
    // محاولة 3: من Firebase مباشرة
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('course');
    if (courseId && window.db) {
        // سنحاول جلبها لاحقاً
        console.log('جاري جلب اسم الدورة...');
    }
    
    // القيمة الافتراضية
    return 'الدورة التدريبية';
}
        
    </script>
</body>
</html>
