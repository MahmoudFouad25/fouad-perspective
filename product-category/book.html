<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الحجز المتكامل</title>
    
    <!-- الخطوط -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- الأيقونات -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- SweetAlert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --gold-primary: #FFD700;
            --dark-bg: #0A1628;
            --dark-card: #152238;
            --success: #22C55E;
            --danger: #E11D48;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: var(--dark-bg);
            color: white;
            padding: 20px;
        }
        
        .booking-form-container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--dark-card);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .form-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .form-header h2 {
            color: var(--gold-primary);
            margin-bottom: 10px;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 215, 0, 0.05);
            border-radius: 15px;
        }
        
        .form-section h4 {
            color: var(--gold-primary);
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.2);
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            color: #94a3b8;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-control, .form-select {
            background: var(--dark-bg);
            color: white;
            border: 2px solid rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            padding: 12px;
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            background: var(--dark-bg);
            color: white;
            border-color: var(--gold-primary);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        
        .price-summary {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
        }
        
        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .price-row.total {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--gold-primary);
            border-top: 2px solid rgba(255, 215, 0, 0.3);
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .btn-submit {
            width: 100%;
            background: linear-gradient(135deg, var(--gold-primary), #D4AF37);
            color: var(--dark-bg);
            border: none;
            border-radius: 50px;
            padding: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-submit:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
        }
        
        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading-spinner.active {
            display: block;
        }
        
        .success-message {
            display: none;
            background: rgba(34, 197, 94, 0.1);
            border: 2px solid var(--success);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }
        
        .success-message.active {
            display: block;
        }
        
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .payment-option {
            background: var(--dark-bg);
            border: 2px solid rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .payment-option:hover {
            border-color: var(--gold-primary);
            transform: translateY(-3px);
        }
        
        .payment-option.selected {
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--gold-primary);
        }
        
        .payment-option input[type="radio"] {
            display: none;
        }
        
        .payment-option i {
            font-size: 2rem;
            color: var(--gold-primary);
            margin-bottom: 10px;
            display: block;
        }
    </style>
</head>
<body>
    <div class="booking-form-container">
        <div class="form-header">
            <h2><i class="fas fa-shopping-cart"></i> إتمام الحجز</h2>
            <p>املأ البيانات التالية لإتمام حجزك في الرحلة</p>
        </div>
        
        <form id="bookingForm">
            <!-- بيانات الدورة -->
            <div class="form-section">
                <h4><i class="fas fa-graduation-cap"></i> بيانات الرحلة</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">اسم الدورة</label>
                            <input type="text" class="form-control" id="courseName" readonly>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">نوع الحجز</label>
                            <input type="text" class="form-control" id="bookingType" readonly>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- البيانات الشخصية -->
            <div class="form-section">
                <h4><i class="fas fa-user"></i> البيانات الشخصية</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">الاسم الكامل *</label>
                            <input type="text" class="form-control" id="fullName" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">البريد الإلكتروني *</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">رقم الهاتف *</label>
                            <input type="tel" class="form-control" id="phone" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">المحافظة *</label>
                            <select class="form-select" id="governorate" required>
                                <option value="">اختر المحافظة</option>
                                <option value="cairo">القاهرة</option>
                                <option value="giza">الجيزة</option>
                                <option value="alexandria">الإسكندرية</option>
                                <option value="ismailia">الإسماعيلية</option>
                                <!-- أضف باقي المحافظات -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- طريقة الدفع -->
            <div class="form-section">
                <h4><i class="fas fa-credit-card"></i> طريقة الدفع</h4>
                <div class="payment-methods" id="paymentMethods">
                    <label class="payment-option">
                        <input type="radio" name="paymentMethod" value="cash" required>
                        <i class="fas fa-money-bill-wave"></i>
                        <div>دفع نقدي</div>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="paymentMethod" value="installments3" required>
                        <i class="fas fa-calendar-alt"></i>
                        <div>3 أقساط</div>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="paymentMethod" value="installments6" required>
                        <i class="fas fa-calendar-check"></i>
                        <div>6 أقساط</div>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="paymentMethod" value="vodafone" required>
                        <i class="fas fa-mobile-alt"></i>
                        <div>فودافون كاش</div>
                    </label>
                </div>
            </div>
            
            <!-- ملخص السعر -->
            <div class="price-summary">
                <h4 style="color: var(--gold-primary); margin-bottom: 20px;">
                    <i class="fas fa-receipt"></i> ملخص الطلب
                </h4>
                <div class="price-row">
                    <span>السعر الأساسي:</span>
                    <span id="basePrice">0 ج.م</span>
                </div>
                <div class="price-row" id="discountRow" style="display:none;">
                    <span>الخصم:</span>
                    <span id="discount" style="color: var(--success);">-0 ج.م</span>
                </div>
                <div class="price-row total">
                    <span>الإجمالي:</span>
                    <span id="totalPrice">0 ج.م</span>
                </div>
            </div>
            
            <!-- رسالة إضافية -->
            <div class="form-section">
                <h4><i class="fas fa-comment"></i> ملاحظات (اختياري)</h4>
                <textarea class="form-control" id="notes" rows="3" 
                    placeholder="أي ملاحظات أو استفسارات..."></textarea>
            </div>
            
            <!-- الموافقة على الشروط -->
            <div class="form-check mb-4">
                <input type="checkbox" class="form-check-input" id="terms" required>
                <label class="form-check-label" for="terms">
                    أوافق على الشروط والأحكام وسياسة الخصوصية
                </label>
            </div>
            
            <!-- زر الإرسال -->
            <button type="submit" class="btn-submit" id="submitBtn">
                <i class="fas fa-check-circle"></i> تأكيد الحجز
            </button>
            
            <!-- مؤشر التحميل -->
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">جاري المعالجة...</span>
                </div>
                <p class="mt-2">جاري معالجة طلبك...</p>
            </div>
            
            <!-- رسالة النجاح -->
            <div class="success-message" id="successMessage">
                <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--success);"></i>
                <h3 class="mt-3">تم الحجز بنجاح!</h3>
                <p>سيتم التواصل معك خلال 24 ساعة لتأكيد الحجز</p>
                <p>رقم الحجز: <strong id="bookingNumber"></strong></p>
            </div>
        </form>
    </div>
    
    <script>
        // ==================== الإعدادات الأساسية ====================
        
        // إعدادات Firebase (استخدم نفس الإعدادات الموجودة)
        const firebaseConfig = {
            apiKey: "AIzaSyDHg0VrivE3C9A7jvzRu7lQgudLvcD_Fxk",
            authDomain: "fouad-perspective.firebaseapp.com",
            projectId: "fouad-perspective",
            storageBucket: "fouad-perspective.appspot.com",
            messagingSenderId: "564654107574",
            appId: "1:564654107574:web:baebb660288b22f16213e6"
        };
        
        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // إعدادات EmailJS
        emailjs.init("YOUR_PUBLIC_KEY"); // ضع المفتاح العام هنا
        
        // إعدادات Google Sheets
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbyEnBu0CJ4kdzHPRvL9ff8JK8ioebrSw4ztuvNgGb0FHATTzrPVXmZRoWOYR2GA3fp3qA/exec'; // ضع رابط Web App هنا
        
        // ==================== المتغيرات العامة ====================
        let bookingData = {
            courseId: '',
            courseName: '',
            bookingType: '',
            basePrice: 0,
            discount: 0,
            totalPrice: 0,
            paymentMethod: '',
            userData: {}
        };
        
        // ==================== الدوال الأساسية ====================
        
        // جلب معلومات الدورة من URL
        function getBookingInfo() {
            const urlParams = new URLSearchParams(window.location.search);
            
            bookingData.courseId = urlParams.get('course') || 'default';
            bookingData.courseName = urlParams.get('name') || 'الدورة التدريبية';
            bookingData.bookingType = urlParams.get('type') || 'individual';
            bookingData.basePrice = parseInt(urlParams.get('price')) || 1000;
            bookingData.discount = parseInt(urlParams.get('discount')) || 0;
            bookingData.totalPrice = bookingData.basePrice - bookingData.discount;
            
            // تحديث الواجهة
            updateUI();
        }
        
        // تحديث الواجهة
        function updateUI() {
            document.getElementById('courseName').value = bookingData.courseName;
            document.getElementById('bookingType').value = getBookingTypeText(bookingData.bookingType);
            document.getElementById('basePrice').textContent = `${bookingData.basePrice.toLocaleString('ar-EG')} ج.م`;
            
            if (bookingData.discount > 0) {
                document.getElementById('discountRow').style.display = 'flex';
                document.getElementById('discount').textContent = `-${bookingData.discount.toLocaleString('ar-EG')} ج.م`;
            }
            
            document.getElementById('totalPrice').textContent = `${bookingData.totalPrice.toLocaleString('ar-EG')} ج.م`;
        }
        
        // الحصول على نص نوع الحجز
        function getBookingTypeText(type) {
            const types = {
                'individual': 'رحلة فردية',
                'group': 'رحلة جماعية',
                'gift': 'إهداء الرحلة',
                'support': 'رحلة بالدعم'
            };
            return types[type] || 'رحلة فردية';
        }
        
        // ==================== معالجة النموذج ====================
        
        // معالجة اختيار طريقة الدفع
        document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.querySelectorAll('.payment-option').forEach(option => {
                    option.classList.remove('selected');
                });
                this.parentElement.classList.add('selected');
                bookingData.paymentMethod = this.value;
            });
        });
        
        // معالجة إرسال النموذج
        document.getElementById('bookingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // جمع البيانات
            bookingData.userData = {
                fullName: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                governorate: document.getElementById('governorate').value,
                notes: document.getElementById('notes').value,
                termsAccepted: document.getElementById('terms').checked
            };
            
            // التحقق من البيانات
            if (!validateForm()) {
                return;
            }
            
            // بدء المعالجة
            showLoading(true);
            
            try {
                // 1. حفظ في Firebase
                const bookingId = await saveToFirebase();
                
                // 2. حفظ في Google Sheets
                await saveToGoogleSheets(bookingId);
                
                // 3. إرسال إيميل التأكيد
                await sendConfirmationEmail(bookingId);
                
                // عرض رسالة النجاح
                showSuccess(bookingId);
                
            } catch (error) {
                console.error('خطأ في معالجة الحجز:', error);
                showError('حدث خطأ أثناء معالجة طلبك. الرجاء المحاولة مرة أخرى.');
            } finally {
                showLoading(false);
            }
        });
        
        // ==================== دوال الحفظ ====================
        
        // 1. حفظ في Firebase
        async function saveToFirebase() {
            const bookingId = 'BOOK' + Date.now();
            
            const bookingRecord = {
                bookingId: bookingId,
                courseId: bookingData.courseId,
                courseName: bookingData.courseName,
                bookingType: bookingData.bookingType,
                pricing: {
                    basePrice: bookingData.basePrice,
                    discount: bookingData.discount,
                    totalPrice: bookingData.totalPrice
                },
                paymentMethod: bookingData.paymentMethod,
                customer: bookingData.userData,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // حفظ في مجموعة bookings
            await db.collection('bookings').doc(bookingId).set(bookingRecord);
            
            // تحديث إحصائيات الدورة
            await db.collection('courses').doc(bookingData.courseId).update({
                totalBookings: firebase.firestore.FieldValue.increment(1),
                lastBookingAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            return bookingId;
        }
        
        // 2. حفظ في Google Sheets
        async function saveToGoogleSheets(bookingId) {
            const data = {
                bookingId: bookingId,
                timestamp: new Date().toLocaleString('ar-EG'),
                courseName: bookingData.courseName,
                bookingType: getBookingTypeText(bookingData.bookingType),
                fullName: bookingData.userData.fullName,
                email: bookingData.userData.email,
                phone: bookingData.userData.phone,
                governorate: bookingData.userData.governorate,
                paymentMethod: bookingData.paymentMethod,
                basePrice: bookingData.basePrice,
                discount: bookingData.discount,
                totalPrice: bookingData.totalPrice,
                notes: bookingData.userData.notes || 'لا يوجد',
                status: 'جديد'
            };
            
            // إرسال للـ Google Sheets Web App
            if (GOOGLE_SHEETS_URL && GOOGLE_SHEETS_URL !== 'YOUR_WEB_APP_URL') {
                const response = await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
            }
        }
        
        // 3. إرسال إيميل التأكيد
        async function sendConfirmationEmail(bookingId) {
            // قالب الإيميل للعميل
            const templateParams = {
                to_name: bookingData.userData.fullName,
                to_email: bookingData.userData.email,
                booking_id: bookingId,
                course_name: bookingData.courseName,
                total_price: bookingData.totalPrice,
                payment_method: bookingData.paymentMethod
            };
            
            // إرسال للعميل (يحتاج تكوين EmailJS)
            if (typeof emailjs !== 'undefined' && emailjs.send) {
                // emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', templateParams);
            }
            
            // إرسال نسخة للإدارة
            const adminParams = {
                ...templateParams,
                admin_email: 'admin@example.com',
                phone: bookingData.userData.phone,
                governorate: bookingData.userData.governorate,
                notes: bookingData.userData.notes
            };
            
            // emailjs.send('YOUR_SERVICE_ID', 'YOUR_ADMIN_TEMPLATE_ID', adminParams);
        }
        
        // ==================== دوال مساعدة ====================
        
        // التحقق من صحة البيانات
        function validateForm() {
            // التحقق من الإيميل
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(bookingData.userData.email)) {
                showError('الرجاء إدخال بريد إلكتروني صحيح');
                return false;
            }
            
            // التحقق من رقم الهاتف
            const phoneRegex = /^01[0-2,5]\d{8}$/;
            if (!phoneRegex.test(bookingData.userData.phone)) {
                showError('الرجاء إدخال رقم هاتف مصري صحيح');
                return false;
            }
            
            // التحقق من طريقة الدفع
            if (!bookingData.paymentMethod) {
                showError('الرجاء اختيار طريقة الدفع');
                return false;
            }
            
            // التحقق من الموافقة على الشروط
            if (!bookingData.userData.termsAccepted) {
                showError('الرجاء الموافقة على الشروط والأحكام');
                return false;
            }
            
            return true;
        }
        
        // عرض التحميل
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            const submitBtn = document.getElementById('submitBtn');
            
            if (show) {
                spinner.classList.add('active');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري المعالجة...';
            } else {
                spinner.classList.remove('active');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> تأكيد الحجز';
            }
        }
        
        // عرض رسالة النجاح
        function showSuccess(bookingId) {
            document.getElementById('bookingNumber').textContent = bookingId;
            document.getElementById('successMessage').classList.add('active');
            document.getElementById('bookingForm').style.display = 'none';
            
            // إظهار رسالة SweetAlert
            Swal.fire({
                title: 'تم الحجز بنجاح!',
                html: `
                    <p>رقم الحجز: <strong>${bookingId}</strong></p>
                    <p>سيتم التواصل معك خلال 24 ساعة</p>
                    <p>تم إرسال تفاصيل الحجز إلى بريدك الإلكتروني</p>
                `,
                icon: 'success',
                confirmButtonText: 'حسناً',
                confirmButtonColor: '#FFD700',
                background: '#152238',
                color: '#fff'
            }).then(() => {
                // إعادة توجيه للصفحة الرئيسية بعد 3 ثواني
                setTimeout(() => {
                    window.location.href = '/';
                }, 3000);
            });
        }
        
        // عرض رسالة خطأ
        function showError(message) {
            Swal.fire({
                title: 'خطأ',
                text: message,
                icon: 'error',
                confirmButtonText: 'حسناً',
                confirmButtonColor: '#E11D48',
                background: '#152238',
                color: '#fff'
            });
        }
        
        // ==================== تهيئة الصفحة ====================
        
        document.addEventListener('DOMContentLoaded', function() {
            // جلب معلومات الحجز من URL
            getBookingInfo();
            
            // تعيين التاريخ والوقت الحالي
            const now = new Date();
            console.log('تم تحميل صفحة الحجز في:', now.toLocaleString('ar-EG'));
        });
        
        // ==================== معالج أحداث إضافية ====================
        
        // حفظ تلقائي للبيانات المدخلة (في localStorage)
        function autoSaveForm() {
            const formData = {
                fullName: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                governorate: document.getElementById('governorate').value,
                notes: document.getElementById('notes').value
            };
            
            localStorage.setItem('bookingFormData', JSON.stringify(formData));
        }
        
        // استرجاع البيانات المحفوظة
        function loadSavedForm() {
            const savedData = localStorage.getItem('bookingFormData');
            if (savedData) {
                const formData = JSON.parse(savedData);
                document.getElementById('fullName').value = formData.fullName || '';
                document.getElementById('email').value = formData.email || '';
                document.getElementById('phone').value = formData.phone || '';
                document.getElementById('governorate').value = formData.governorate || '';
                document.getElementById('notes').value = formData.notes || '';
            }
        }
        
        // تفعيل الحفظ التلقائي
        document.querySelectorAll('input, select, textarea').forEach(element => {
            element.addEventListener('input', autoSaveForm);
        });
        
        // تحميل البيانات المحفوظة عند فتح الصفحة
        loadSavedForm();
    </script>
</body>
</html>
